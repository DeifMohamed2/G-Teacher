<%- include('./partials/admin-header', { title, user, theme, currentPage: 'orders', pageCSS: 'orders' }) %>

<!-- Admin Layout -->
<div class="admin-layout">

  <!-- Sidebar -->
  <%- include('./partials/admin-sidebar', { currentPage: 'orders' }) %>

  <!-- Main Content -->
  <main class="admin-main">

    <!-- Top Bar -->
    <%- include('./partials/admin-topbar', { 
        breadcrumb: 'Orders Management',
        breadcrumbSubtitle: 'Manage customer orders and transactions',
        showSearch: false
    }) %>

    <!-- Content Area -->
    <div class="admin-content">
      <div class="admin-orders-container">
        <!-- Orders Header -->
        <div class="admin-orders-header d-flex align-items-center justify-content-between mb-4">
          <div>
            <h1 class="mb-0">Orders Management</h1>
            <p class="text-muted">Track and manage all customer orders and transactions</p>
          </div>
          <div class="admin-header-actions">
            <button onclick="exportOrdersToExcel()" class="btn btn-success" style="padding: 12px 24px; border-radius: 12px; font-weight: 600; font-size: 14px; display: inline-flex; align-items: center; gap: 8px; transition: all 0.3s ease;">
              <i class="fas fa-file-excel"></i>
              Export to Excel
            </button>
          </div>
        </div>

        <!-- Analytics Cards -->
        <div class="row g-4 mb-4 orders-kpi">
          <div class="col-12 col-lg-3">
            <div class="card shadow-sm h-100">
              <div class="card-body">
                <div class="d-flex align-items-center">
                  <i class="fas fa-receipt fa-2x me-3"></i>
                  <div>
                    <div class="text-muted small">Total Orders</div>
                    <div class="fs-4 fw-bold"><%= analytics.totalOrders %></div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-12 col-lg-3">
            <div class="card shadow-sm h-100">
              <div class="card-body">
                <div class="d-flex align-items-center">
                   <i class="fas fa-coins fa-2x me-3"></i>
                  <div>
                    <div class="text-muted small">Total </div>
                    <div class="fs-4 fw-bold"><%= analytics.totalRevenue.toFixed(2) %> <span class="text-muted"><%= analytics.currency || '' %></span></div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-12 col-lg-3">
            <div class="card shadow-sm h-100">
              <div class="card-body">
                <div class="d-flex align-items-center">
                  <i class="fas fa-check-circle fa-2x me-3"></i>
                  <div>
                    <div class="text-muted small">Completed Revenue</div>
                    <div class="fs-4 fw-bold"><%= analytics.completedRevenue.toFixed(2) %></div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-12 col-lg-3">
            <div class="card shadow-sm h-100">
              <div class="card-body">
                <div class="d-flex align-items-center">
                  <i class="fas fa-undo fa-2x me-3"></i>
                  <div>
                    <div class="text-muted small">Refunded</div>
                    <div class="fs-4 fw-bold"><%= analytics.refundedAmount.toFixed(2) %></div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Sales Analytics Chart -->
        <div class="card shadow-sm mb-4 admin-card">
          <div class="card-header" style="background: linear-gradient(135deg, var(--admin-primary), #dc2626); border-bottom: none;">
            <h5 class="mb-0" style="color: #ffffff; font-weight: 700; display: flex; align-items: center; gap: 12px;">
              <i class="fas fa-chart-line"></i> Sales Analytics
            </h5>
          </div>
          <div class="card-body" style="padding: 24px;">
            <div style="position: relative; height: 300px;">
              <canvas id="ordersSalesChart"></canvas>
            </div>
          </div>
        </div>

        <!-- Filters -->
        <div class="card shadow-sm mb-4 orders-filter-card">
          <div class="card-header" style="background: linear-gradient(135deg, var(--admin-primary), #dc2626); border-bottom: none;">
            <h5 class="mb-0" style="color: #ffffff; font-weight: 700; display: flex; align-items: center; gap: 12px;">
              <i class="fas fa-filter"></i> Filter Orders
            </h5>
          </div>
          <div class="card-body" style="padding: 24px;">
            <form class="row g-3" method="get">
              <div class="col-12 col-md-3">
                <label class="form-label" style="color: var(--admin-text-light); font-weight: 600; font-size: 14px; margin-bottom: 8px;">Search</label>
                <div class="input-group">
                  <span class="input-group-text" style="background: var(--admin-primary); border: 2px solid var(--admin-primary); color: white; border-radius: 12px 0 0 12px;">
                    <i class="fas fa-search"></i>
                  </span>
                  <input type="text" class="form-control" name="search" placeholder="Order #, email, name, phone, username" value="<%= (currentFilters.search||'') %>" style="border: 2px solid var(--admin-border-light); border-radius: 0 12px 12px 0; padding: 12px 16px; font-size: 14px; transition: all 0.3s ease; background: var(--admin-card-light); color: var(--admin-text-light);">
                </div>
              </div>
              <div class="col-6 col-md-2">
                <label class="form-label" style="color: var(--admin-text-light); font-weight: 600; font-size: 14px; margin-bottom: 8px;">Order Status</label>
                <select class="form-select" name="status" style="border: 2px solid var(--admin-border-light); border-radius: 12px; padding: 12px 16px; font-size: 14px; transition: all 0.3s ease; background: var(--admin-card-light); color: var(--admin-text-light);">
                  <option value="all">All Statuses</option>
                  <%- ['pending','processing','completed','failed','cancelled','refunded'].map(s=>`<option value="${s}" ${currentFilters.status===s?'selected':''}>${s.charAt(0).toUpperCase() + s.slice(1)}</option>`).join('') %>
                </select>
              </div>
              <div class="col-6 col-md-2">
                <label class="form-label" style="color: var(--admin-text-light); font-weight: 600; font-size: 14px; margin-bottom: 8px;">Payment Status</label>
                <select class="form-select" name="paymentStatus" style="border: 2px solid var(--admin-border-light); border-radius: 12px; padding: 12px 16px; font-size: 14px; transition: all 0.3s ease; background: var(--admin-card-light); color: var(--admin-text-light);">
                  <option value="all">All Statuses</option>
                  <%- ['pending','processing','completed','failed','cancelled','refunded'].map(s=>`<option value="${s}" ${currentFilters.paymentStatus===s?'selected':''}>${s.charAt(0).toUpperCase() + s.slice(1)}</option>`).join('') %>
                </select>
              </div>
              <div class="col-6 col-md-2">
                <label class="form-label" style="color: var(--admin-text-light); font-weight: 600; font-size: 14px; margin-bottom: 8px;">Payment Method</label>
                <select class="form-select" name="paymentMethod" style="border: 2px solid var(--admin-border-light); border-radius: 12px; padding: 12px 16px; font-size: 14px; transition: all 0.3s ease; background: var(--admin-card-light); color: var(--admin-text-light);">
                  <option value="all">All Methods</option>
                  <%- ['credit_card','paypal','stripe','bank_transfer'].map(s=>`<option value="${s}" ${currentFilters.paymentMethod===s?'selected':''}>${s.replace('_', ' ').toUpperCase()}</option>`).join('') %>
                </select>
              </div>
              <div class="col-6 col-md-2">
                <label class="form-label" style="color: var(--admin-text-light); font-weight: 600; font-size: 14px; margin-bottom: 8px;">Date From</label>
                <input type="date" class="form-control" name="dateFrom" value="<%= currentFilters.dateFrom||'' %>" style="border: 2px solid var(--admin-border-light); border-radius: 12px; padding: 12px 16px; font-size: 14px; transition: all 0.3s ease; background: var(--admin-card-light); color: var(--admin-text-light);">
              </div>
              <div class="col-6 col-md-2">
                <label class="form-label" style="color: var(--admin-text-light); font-weight: 600; font-size: 14px; margin-bottom: 8px;">Date To</label>
                <input type="date" class="form-control" name="dateTo" value="<%= currentFilters.dateTo||'' %>" style="border: 2px solid var(--admin-border-light); border-radius: 12px; padding: 12px 16px; font-size: 14px; transition: all 0.3s ease; background: var(--admin-card-light); color: var(--admin-text-light);">
              </div>
              <div class="col-12 d-flex justify-content-end gap-2 mt-4">
                <a href="/admin/orders" class="btn btn-outline-secondary" style="padding: 12px 24px; border-radius: 12px; font-weight: 600; font-size: 14px; transition: all 0.3s ease; border: 2px solid var(--admin-border-light); color: var(--admin-text-light);">
                  <i class="fas fa-times me-1"></i> Clear
                </a>
                <button class="btn btn-primary" type="submit" style="padding: 12px 24px; border-radius: 12px; font-weight: 600; font-size: 14px; transition: all 0.3s ease; background: var(--admin-primary); border-color: var(--admin-primary);">
                  <i class="fas fa-filter me-1"></i> Apply Filters
                </button>
              </div>
            </form>
          </div>
        </div>

        <!-- Orders Table -->
        <div class="card shadow-sm orders-table">
          <div class="card-header" style="background: linear-gradient(135deg, var(--admin-primary), #dc2626); border-bottom: none; padding: 20px 24px;">
            <div class="d-flex justify-content-between align-items-center">
              <h5 class="mb-0" style="color: #ffffff; font-weight: 700; display: flex; align-items: center; gap: 12px;">
                <i class="fas fa-list"></i> Order List
              </h5>
              <div class="badge" style="background: rgba(255, 255, 255, 0.2); color: white; border: 1px solid rgba(255, 255, 255, 0.3); padding: 8px 16px; border-radius: 20px; font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">
                <%= pagination.totalOrders %> Total Orders
              </div>
            </div>
          </div>
          <div class="table-responsive">
            <table class="table table-hover align-middle mb-0" style="background: transparent; border: none; margin: 0;">
              <thead>
                <tr>
                  <th style="background: transparent; color: var(--admin-text-light); padding: 20px 24px; text-align: left; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; font-size: 12px; border-bottom: 2px solid var(--admin-border-light); position: sticky; top: 0; z-index: 10;">Order #</th>
                  <th style="background: transparent; color: var(--admin-text-light); padding: 20px 24px; text-align: left; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; font-size: 12px; border-bottom: 2px solid var(--admin-border-light); position: sticky; top: 0; z-index: 10;">Customer</th>
                  <th style="background: transparent; color: var(--admin-text-light); padding: 20px 24px; text-align: left; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; font-size: 12px; border-bottom: 2px solid var(--admin-border-light); position: sticky; top: 0; z-index: 10;">Items</th>
                  <th style="background: transparent; color: var(--admin-text-light); padding: 20px 24px; text-align: left; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; font-size: 12px; border-bottom: 2px solid var(--admin-border-light); position: sticky; top: 0; z-index: 10;">Total</th>
                  <th style="background: transparent; color: var(--admin-text-light); padding: 20px 24px; text-align: left; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; font-size: 12px; border-bottom: 2px solid var(--admin-border-light); position: sticky; top: 0; z-index: 10;">Status</th>
                  <th style="background: transparent; color: var(--admin-text-light); padding: 20px 24px; text-align: left; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; font-size: 12px; border-bottom: 2px solid var(--admin-border-light); position: sticky; top: 0; z-index: 10;">Payment</th>
                  <th style="background: transparent; color: var(--admin-text-light); padding: 20px 24px; text-align: left; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; font-size: 12px; border-bottom: 2px solid var(--admin-border-light); position: sticky; top: 0; z-index: 10;">Date</th>
                  <th class="text-end" style="background: transparent; color: var(--admin-text-light); padding: 20px 24px; text-align: left; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; font-size: 12px; border-bottom: 2px solid var(--admin-border-light); position: sticky; top: 0; z-index: 10;">Actions</th>
                </tr>
              </thead>
              <tbody>
                <% if (!orders || orders.length === 0) { %>
                <tr>
                  <td colspan="8" class="text-center py-5" style="padding: 20px 24px; border-bottom: 1px solid var(--admin-border-light); vertical-align: middle; color: var(--admin-text-light);">
                    <div class="orders-empty-state">
                      <div class="orders-empty-icon">
                        <i class="fas fa-shopping-cart"></i>
                      </div>
                      <div class="orders-empty-title">No Orders Found</div>
                      <div class="orders-empty-description">No orders match your current filters.</div>
                    </div>
                  </td>
                </tr>
                <% } %>
                <% (orders||[]).forEach(o => { %>
                <tr style="transition: all 0.3s ease;">
                  <td style="padding: 20px 24px; border-bottom: 1px solid var(--admin-border-light); vertical-align: middle; color: var(--admin-text-light);">
                    <a href="/admin/orders/<%= o.orderNumber %>" class="order-number-link">
                      #<%= o.orderNumber %>
                    </a>
                    <div class="text-muted small" style="margin-top: 4px;">
                      <span class="badge" style="background: rgba(107, 114, 128, 0.1); color: #6b7280; border: 1px solid rgba(107, 114, 128, 0.2); padding: 4px 8px; border-radius: 12px; font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">
                        <%= o.paymentMethod.replace('_', ' ') %>
                      </span>
                    </div>
                  </td>
                  <td style="padding: 20px 24px; border-bottom: 1px solid var(--admin-border-light); vertical-align: middle; color: var(--admin-text-light);">
                    <div class="order-customer-info">
                      <div class="fw-semibold" style="color: var(--admin-text-light); font-weight: 600; font-size: 14px;">
                        <%= (o.user?.firstName||'') %> <%= (o.user?.lastName||'') %>
                      </div>
                      <div class="text-muted small" style="color: #64748b; font-size: 12px; display: flex; align-items: center; gap: 4px;">
                        <i class="fas fa-envelope"></i> <%= o.billingAddress?.email %>
                      </div>
                      <% if (o.user?.parentNumber) { %>
                      <div class="text-muted small" style="color: #64748b; font-size: 12px; display: flex; align-items: center; gap: 4px;">
                        <i class="fas fa-phone"></i> <%= o.user.parentCountryCode %> <%= o.user.parentNumber %>
                      </div>
                      <% } %>
                    </div>
                  </td>
                  <td style="padding: 20px 24px; border-bottom: 1px solid var(--admin-border-light); vertical-align: middle; color: var(--admin-text-light);">
                    <% 
                      const itemsCount = o.items ? o.items.length : 0;
                      const booksCount = o.bookOrders ? o.bookOrders.length : 0;
                      const totalItemsCount = itemsCount + booksCount;
                      const itemTitles = [];
                      if (o.items && o.items.length > 0) {
                        itemTitles.push(...o.items.map(i => i.title));
                      }
                      if (o.bookOrders && o.bookOrders.length > 0) {
                        itemTitles.push(...o.bookOrders.map(b => b.bookName || 'Book'));
                      }
                    %>
                    <div class="text-muted small" style="color: #64748b; font-size: 12px; display: flex; align-items: center; gap: 4px;">
                      <i class="fas fa-shopping-cart"></i> <%= totalItemsCount %> item(s)
                    </div>
                    <div class="order-item-preview" style="color: var(--admin-text-light); font-size: 13px; font-weight: 500; margin-top: 4px; max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                      <%= itemTitles.slice(0,2).join(', ') %><%= itemTitles.length>2?' â€¦':'' %>
                    </div>
                  </td>
                  <td class="fw-bold" style="padding: 20px 24px; border-bottom: 1px solid var(--admin-border-light); vertical-align: middle; color: var(--admin-primary); font-weight: 700; font-size: 16px;">
                    <%= o.currency || '' %> <%= o.total.toFixed(2) %>
                  </td>
                  <td style="padding: 20px 24px; border-bottom: 1px solid var(--admin-border-light); vertical-align: middle; width: 120px;">
                    <div class="d-flex flex-column gap-1">
                      <span class="status-badge status-<%= o.status %>" style="display: inline-block; width: fit-content;">
                        <%= o.status.charAt(0).toUpperCase() + o.status.slice(1) %>
                      </span>
                    </div>
                  </td>
                  <td style="padding: 20px 24px; border-bottom: 1px solid var(--admin-border-light); vertical-align: middle; width: 120px;">
                    <div class="d-flex flex-column gap-1">
                      <span class="status-badge status-<%= o.paymentMethod %>" style="display: inline-block; width: fit-content;">
                        <%= o.paymentMethod.charAt(0).toUpperCase() + o.paymentMethod.slice(1) %>
                      </span>
                    </div>
                  </td>
                  <td style="padding: 20px 24px; border-bottom: 1px solid var(--admin-border-light); vertical-align: middle; color: var(--admin-text-light);">
                    <div class="text-muted small" style="color: #64748b; font-size: 12px; display: flex; align-items: center; gap: 4px;">
                      <i class="far fa-calendar-alt"></i> <%= new Date(o.createdAt).toLocaleDateString() %>
                    </div>
                    <div class="text-muted small" style="color: #64748b; font-size: 12px; display: flex; align-items: center; gap: 4px;">
                      <i class="far fa-clock"></i> <%= new Date(o.createdAt).toLocaleTimeString() %>
                    </div>
                  </td>
                  <td style="padding: 20px 24px; border-bottom: 1px solid var(--admin-border-light); vertical-align: middle;">
                    <div class="d-flex justify-content-end gap-2">
                      <a class="btn btn-sm btn-outline-primary order-action-button" href="/admin/orders/<%= o.orderNumber %>" title="View Order Details">
                        <i class="fas fa-eye"></i>
                      </a>
                      <% if (o.status === 'failed' && o.paymentStatus === 'failed') { %>
                      <button class="btn btn-sm order-action-button-complete" 
                              onclick="openCompletePaymentModal('<%= o.orderNumber %>', '<%= o._id %>')" 
                              title="Complete Failed Payment & Enroll Student"
                      >
                        <i class="fas fa-magic"></i>
                        <span>Fix Payment</span>
                      </button>
                      <% } %>
                      <% if (o.status !== 'refunded' && o.paymentStatus === 'completed') { %>
                      <a class="btn btn-sm btn-outline-danger order-action-button" href="/admin/orders/<%= o.orderNumber %>" title="Process Refund" onclick="return confirm('Navigate to order details to process refund?')">
                        <i class="fas fa-undo"></i>
                      </a>
                      <% } %>
                    </div>
                  </td>
                </tr>
                <% }) %>
              </tbody>
            </table>
          </div>
          <div class="card-footer order-pagination" style="background: var(--admin-card-light); border: 2px solid var(--admin-border-light); border-radius: 16px; padding: 20px 24px; margin-top: 24px; box-shadow: var(--admin-shadow);">
            <div class="d-flex justify-content-between align-items-center">
              <div class="text-muted" style="color: #64748b; font-size: 14px; font-weight: 500;">
                Showing <span class="fw-semibold" style="color: var(--admin-primary); font-weight: 700;"><%= orders?.length || 0 %></span> orders -
                Page <span class="fw-semibold" style="color: var(--admin-primary); font-weight: 700;"><%= pagination.currentPage %></span> of
                <span class="fw-semibold" style="color: var(--admin-primary); font-weight: 700;"><%= pagination.totalPages %></span>
                (<span class="fw-semibold" style="color: var(--admin-primary); font-weight: 700;"><%= pagination.totalOrders %></span> total)
              </div>
              <div class="d-flex gap-1">
                <a class="btn btn-sm <%= pagination.hasPrev?'btn-primary':'btn-outline-secondary disabled' %>" href="?page=1<%= currentFilters.queryString ? '&' + currentFilters.queryString : '' %>" style="padding: 8px 12px; border: 2px solid var(--admin-border-light); background: var(--admin-card-light); color: var(--admin-text-light); border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; text-decoration: none; display: inline-flex; align-items: center; justify-content: center; min-width: 40px; height: 40px;">
                  <i class="fas fa-angle-double-left"></i>
                </a>
                <a class="btn btn-sm <%= pagination.hasPrev?'btn-outline-primary':'btn-outline-secondary disabled' %>" href="?page=<%= pagination.currentPage-1 %><%= currentFilters.queryString ? '&' + currentFilters.queryString : '' %>" style="padding: 8px 12px; border: 2px solid var(--admin-border-light); background: var(--admin-card-light); color: var(--admin-text-light); border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; text-decoration: none; display: inline-flex; align-items: center; justify-content: center; min-width: 40px; height: 40px;">
                  <i class="fas fa-angle-left"></i> Prev
                </a>
                <a class="btn btn-sm <%= pagination.hasNext?'btn-outline-primary':'btn-outline-secondary disabled' %>" href="?page=<%= pagination.currentPage+1 %><%= currentFilters.queryString ? '&' + currentFilters.queryString : '' %>" style="padding: 8px 12px; border: 2px solid var(--admin-border-light); background: var(--admin-card-light); color: var(--admin-text-light); border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; text-decoration: none; display: inline-flex; align-items: center; justify-content: center; min-width: 40px; height: 40px;">
                  Next <i class="fas fa-angle-right"></i>
                </a>
                <a class="btn btn-sm <%= pagination.hasNext?'btn-primary':'btn-outline-secondary disabled' %>" href="?page=<%= pagination.totalPages %><%= currentFilters.queryString ? '&' + currentFilters.queryString : '' %>" style="padding: 8px 12px; border: 2px solid var(--admin-border-light); background: var(--admin-card-light); color: var(--admin-text-light); border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; text-decoration: none; display: inline-flex; align-items: center; justify-content: center; min-width: 40px; height: 40px;">
                  <i class="fas fa-angle-double-right"></i>
                </a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>
</div>

<!-- Complete Failed Payment Modal -->
<div class="modal fade" id="completePaymentModal" tabindex="-1" aria-labelledby="completePaymentModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content" style="border-radius: 16px; border: none; box-shadow: 0 10px 40px rgba(0,0,0,0.2);">
      <div class="modal-header" style="background: linear-gradient(135deg, #10b981, #059669); border-radius: 16px 16px 0 0; border: none; padding: 24px;">
        <h5 class="modal-title" id="completePaymentModalLabel" style="color: white; font-weight: 700; font-size: 20px; display: flex; align-items: center; gap: 12px;">
          <i class="fas fa-check-circle" style="font-size: 24px;"></i>
          Complete Failed Payment
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" style="padding: 32px;">
        <div id="completePaymentModalContent">
          <!-- Confirmation Content -->
          <div id="completePaymentConfirmContent">
            <div class="mb-4" style="text-align: center;">
              <div style="width: 80px; height: 80px; margin: 0 auto 20px; background: linear-gradient(135deg, #10b981, #059669); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                <i class="fas fa-exclamation-triangle" style="font-size: 40px; color: white;"></i>
              </div>
              <h4 style="font-weight: 700; color: var(--admin-text-light); margin-bottom: 12px;">Confirm Payment Completion</h4>
              <p style="color: #64748b; font-size: 15px; margin-bottom: 0;">Order: <strong id="modalOrderNumber" style="color: var(--admin-primary);">#</strong></p>
            </div>
            <div style="background: #f8f9fa; border-radius: 12px; padding: 20px; margin-bottom: 24px;">
              <p style="font-weight: 600; color: var(--admin-text-light); margin-bottom: 16px; font-size: 15px;">This action will:</p>
              <ul style="list-style: none; padding: 0; margin: 0;">
                <li style="padding: 8px 0; color: #64748b; font-size: 14px; display: flex; align-items: start; gap: 10px;">
                  <i class="fas fa-check-circle" style="color: #10b981; margin-top: 4px;"></i>
                  <span>Mark payment as <strong>completed</strong></span>
                </li>
                <li style="padding: 8px 0; color: #64748b; font-size: 14px; display: flex; align-items: start; gap: 10px;">
                  <i class="fas fa-check-circle" style="color: #10b981; margin-top: 4px;"></i>
                  <span>Enroll student in courses/bundles</span>
                </li>
                <li style="padding: 8px 0; color: #64748b; font-size: 14px; display: flex; align-items: start; gap: 10px;">
                  <i class="fas fa-check-circle" style="color: #10b981; margin-top: 4px;"></i>
                  <span>Process book orders (if any)</span>
                </li>
                <li style="padding: 8px 0; color: #64748b; font-size: 14px; display: flex; align-items: start; gap: 10px;">
                  <i class="fas fa-exclamation-triangle" style="color: #f59e0b; margin-top: 4px;"></i>
                  <span><strong>This action cannot be undone</strong></span>
                </li>
              </ul>
            </div>
            <div class="d-flex gap-2 justify-content-end">
              <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal" style="padding: 12px 24px; border-radius: 12px; font-weight: 600;">
                <i class="fas fa-times me-2"></i>Cancel
              </button>
              <button type="button" class="btn btn-success" id="confirmCompletePaymentBtn" style="padding: 12px 24px; border-radius: 12px; font-weight: 600; background: linear-gradient(135deg, #10b981, #059669); border: none;">
                <i class="fas fa-check-circle me-2"></i>Complete Payment
              </button>
            </div>
          </div>
          <!-- Processing Content -->
          <div id="completePaymentProcessingContent" style="display: none; text-align: center;">
            <div class="mb-4">
              <div style="width: 80px; height: 80px; margin: 0 auto 20px; background: linear-gradient(135deg, #10b981, #059669); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                <i class="fas fa-spinner fa-spin" style="font-size: 40px; color: white;"></i>
              </div>
              <h4 style="font-weight: 700; color: var(--admin-text-light); margin-bottom: 12px;">Processing Payment...</h4>
              <p style="color: #64748b; font-size: 15px;">Please wait while we complete the payment and enroll the student.</p>
            </div>
          </div>
          <!-- Success Content -->
          <div id="completePaymentSuccessContent" style="display: none; text-align: center;">
            <div class="mb-4">
              <div style="width: 80px; height: 80px; margin: 0 auto 20px; background: linear-gradient(135deg, #10b981, #059669); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                <i class="fas fa-check-circle" style="font-size: 40px; color: white;"></i>
              </div>
              <h4 style="font-weight: 700; color: #10b981; margin-bottom: 12px;">Payment Completed Successfully!</h4>
              <p style="color: #64748b; font-size: 15px;">Order has been marked as completed and the student has been enrolled.</p>
            </div>
            <button type="button" class="btn btn-success" onclick="window.location.reload()" style="padding: 12px 24px; border-radius: 12px; font-weight: 600; background: linear-gradient(135deg, #10b981, #059669); border: none;">
              <i class="fas fa-check me-2"></i>OK
            </button>
          </div>
          <!-- Error Content -->
          <div id="completePaymentErrorContent" style="display: none; text-align: center;">
            <div class="mb-4">
              <div style="width: 80px; height: 80px; margin: 0 auto 20px; background: linear-gradient(135deg, #ef4444, #dc2626); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                <i class="fas fa-times-circle" style="font-size: 40px; color: white;"></i>
              </div>
              <h4 style="font-weight: 700; color: #ef4444; margin-bottom: 12px;">Error Completing Payment</h4>
              <p id="completePaymentErrorMessage" style="color: #64748b; font-size: 15px;"></p>
            </div>
            <button type="button" class="btn btn-danger" data-bs-dismiss="modal" style="padding: 12px 24px; border-radius: 12px; font-weight: 600;">
              <i class="fas fa-times me-2"></i>Close
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Include Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- Orders Page JS -->
<script>
  let currentOrderNumber = '';
  let currentOrderId = '';
  let currentButton = null;

  // Complete Failed Payment Function
  function openCompletePaymentModal(orderNumber, orderId) {
    currentOrderNumber = orderNumber;
    currentOrderId = orderId;
    currentButton = event.target.closest('button');
    
    // Set order number in modal
    document.getElementById('modalOrderNumber').textContent = `#${orderNumber}`;
    
    // Reset modal content to confirmation
    document.getElementById('completePaymentConfirmContent').style.display = 'block';
    document.getElementById('completePaymentProcessingContent').style.display = 'none';
    document.getElementById('completePaymentSuccessContent').style.display = 'none';
    document.getElementById('completePaymentErrorContent').style.display = 'none';
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('completePaymentModal'));
    modal.show();
  }

  // Handle confirm button click
  document.getElementById('confirmCompletePaymentBtn').addEventListener('click', async function() {
    // Hide confirmation, show processing
    document.getElementById('completePaymentConfirmContent').style.display = 'none';
    document.getElementById('completePaymentProcessingContent').style.display = 'block';
    
    // Disable close button during processing
    const modalElement = document.getElementById('completePaymentModal');
    const closeButtons = modalElement.querySelectorAll('[data-bs-dismiss="modal"]');
    closeButtons.forEach(btn => btn.style.display = 'none');

    const originalHTML = currentButton.innerHTML;
    currentButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
    currentButton.disabled = true;

    try {
      const response = await fetch(`/admin/orders/${currentOrderNumber}/complete-failed`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ orderId: currentOrderId }),
      });

      const data = await response.json();

      if (data.success) {
        // Show success content
        document.getElementById('completePaymentProcessingContent').style.display = 'none';
        document.getElementById('completePaymentSuccessContent').style.display = 'block';
        
        // Auto-reload after 2 seconds
        setTimeout(() => {
          window.location.reload();
        }, 2000);
      } else {
        throw new Error(data.message || 'Failed to complete payment');
      }
    } catch (error) {
      console.error('Error completing failed payment:', error);
      
      // Show error content
      document.getElementById('completePaymentProcessingContent').style.display = 'none';
      document.getElementById('completePaymentErrorContent').style.display = 'block';
      document.getElementById('completePaymentErrorMessage').textContent = error.message || 'Failed to complete payment. Please try again.';
      
      // Re-enable close button
      closeButtons.forEach(btn => btn.style.display = 'block');
      
      // Reset button
      currentButton.innerHTML = originalHTML;
      currentButton.disabled = false;
    }
  });

  // Excel Export Function
  function exportOrdersToExcel() {
    // Show loading state
    const btn = event.target.closest('button');
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Exporting...';
    btn.disabled = true;

    // Get current filters
    const urlParams = new URLSearchParams(window.location.search);
    const queryString = urlParams.toString();

    // Create export URL with current filters
    const exportUrl = `/admin/orders/export?${queryString}`;

    // Trigger download
    window.location.href = exportUrl;

    // Reset button after a delay
    setTimeout(() => {
      btn.innerHTML = originalText;
      btn.disabled = false;
    }, 2000);
  }

  // Get real data from server
  const monthlyData = <%- JSON.stringify(analytics.monthlySalesData || { labels: [], revenue: [], orderCount: [] }) %>;

  document.addEventListener('DOMContentLoaded', function() {
    // Sales Analytics Chart
    const chartElement = document.getElementById('ordersSalesChart');
    if (!chartElement) {
      console.error('Chart canvas element not found');
      return;
    }

    const ctx = chartElement.getContext('2d');
    if (!ctx) {
      console.error('Could not get 2d context from canvas');
      return;
    }

    try {
      const salesChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: monthlyData.labels || ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
          datasets: [{
              label: 'Revenue (EGP)',
              data: monthlyData.revenue || [],
              borderColor: '#B80101',
              backgroundColor: 'rgba(184, 1, 1, 0.1)',
              tension: 0.4,
              fill: true
            },
            {
              label: 'Orders',
              data: monthlyData.orderCount || [],
              borderColor: '#0d6efd',
              borderDash: [5, 5],
              backgroundColor: 'transparent',
              tension: 0.4,
              fill: false,
              yAxisID: 'y1'
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: {
            mode: 'index',
            intersect: false,
          },
          plugins: {
            legend: {
              position: 'top',
              labels: {
                usePointStyle: true,
                padding: 15
              }
            },
            tooltip: {
              backgroundColor: 'rgba(0, 0, 0, 0.8)',
              titleColor: '#ffffff',
              bodyColor: '#ffffff',
              borderColor: '#B80101',
              borderWidth: 2,
              cornerRadius: 8,
              displayColors: true,
              padding: 12,
              callbacks: {
                label: function(context) {
                  let label = context.dataset.label || '';
                  if (label) {
                    label += ': ';
                  }
                  if (context.parsed.y !== null) {
                    if (context.dataset.label === 'Revenue') {
                      label += context.parsed.y.toFixed(2) + ' EGP';
                    } else {
                      label += context.parsed.y;
                    }
                  }
                  return label;
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: 'Revenue (EGP)'
              },
              ticks: {
                callback: function(value, index, values) {
                  return value.toFixed(0);
                }
              }
            },
            y1: {
              beginAtZero: true,
              position: 'right',
              title: {
                display: true,
                text: 'Number of Orders'
              },
              grid: {
                drawOnChartArea: false
              }
            }
          }
        }
      });
      
      console.log('Sales chart initialized successfully');
    } catch (error) {
      console.error('Error initializing sales chart:', error);
    }
  });
</script>

<!-- Include custom CSS -->
<link rel="stylesheet" href="/css/admin-orders.css">

<%- include('partials/admin-footer') %>