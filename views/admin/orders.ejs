<%- include('./partials/admin-header', { title, user, theme, currentPage: 'orders', pageCSS: 'orders' }) %>

<!-- Admin Layout -->
<div class="admin-layout">

  <!-- Sidebar -->
  <%- include('./partials/admin-sidebar', { currentPage: 'orders' }) %>

  <!-- Main Content -->
  <main class="admin-main">

    <!-- Top Bar -->
    <%- include('./partials/admin-topbar', { 
        breadcrumb: 'Orders Management',
        breadcrumbSubtitle: 'Manage customer orders and transactions',
        showSearch: false
    }) %>

    <!-- Content Area -->
    <div class="admin-content">
      <div class="admin-orders-container">
        <!-- Orders Header -->
        <div class="admin-orders-header d-flex align-items-center justify-content-between mb-4">
          <div>
            <h1 class="mb-0">Orders Management</h1>
            <p class="text-muted">Track and manage all customer orders and transactions</p>
          </div>
          <div class="admin-header-actions">
            <button onclick="exportOrdersToExcel()" class="btn btn-success" style="padding: 12px 24px; border-radius: 12px; font-weight: 600; font-size: 14px; display: inline-flex; align-items: center; gap: 8px; transition: all 0.3s ease;">
              <i class="fas fa-file-excel"></i>
              Export to Excel
            </button>
          </div>
        </div>

        <!-- Analytics Cards -->
        <div class="row g-4 mb-4 orders-kpi">
          <!-- Row 1: Revenue Cards -->
          <div class="col-12 col-md-6 col-lg-3">
            <div class="card shadow-sm h-100" style="border-radius: 16px; border: 1px solid rgba(16, 185, 129, 0.2); overflow: hidden;">
              <div class="card-body" style="padding: 20px;">
                <div class="d-flex align-items-center">
                  <div style="width: 56px; height: 56px; border-radius: 14px; background: linear-gradient(135deg, #10b981, #059669); display: flex; align-items: center; justify-content: center; margin-right: 16px;">
                    <i class="fas fa-coins" style="font-size: 24px; color: white;"></i>
                  </div>
                  <div class="flex-grow-1">
                    <div style="font-size: 11px; color: #64748b; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">Total Revenue</div>
                    <div style="font-size: 24px; font-weight: 700; color: #10b981;">AED <%= analytics.totalRevenue.toFixed(2) %></div>
                    <div style="font-size: 11px; color: #94a3b8; margin-top: 2px;"><%= analytics.totalOrders %> orders</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-12 col-md-6 col-lg-3">
            <div class="card shadow-sm h-100" style="border-radius: 16px; border: 1px solid rgba(34, 197, 94, 0.2); overflow: hidden;">
              <div class="card-body" style="padding: 20px;">
                <div class="d-flex align-items-center">
                  <div style="width: 56px; height: 56px; border-radius: 14px; background: linear-gradient(135deg, #22c55e, #16a34a); display: flex; align-items: center; justify-content: center; margin-right: 16px;">
                    <i class="fas fa-check-circle" style="font-size: 24px; color: white;"></i>
                  </div>
                  <div class="flex-grow-1">
                    <div style="font-size: 11px; color: #64748b; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">Completed Revenue</div>
                    <div style="font-size: 24px; font-weight: 700; color: #22c55e;">AED <%= analytics.completedRevenue.toFixed(2) %></div>
                    <div style="font-size: 11px; color: #94a3b8; margin-top: 2px;"><%= analytics.completed || 0 %> completed</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-12 col-md-6 col-lg-3">
            <div class="card shadow-sm h-100" style="border-radius: 16px; border: 1px solid rgba(239, 68, 68, 0.2); overflow: hidden;">
              <div class="card-body" style="padding: 20px;">
                <div class="d-flex align-items-center">
                  <div style="width: 56px; height: 56px; border-radius: 14px; background: linear-gradient(135deg, #ef4444, #dc2626); display: flex; align-items: center; justify-content: center; margin-right: 16px;">
                    <i class="fas fa-undo" style="font-size: 24px; color: white;"></i>
                  </div>
                  <div class="flex-grow-1">
                    <div style="font-size: 11px; color: #64748b; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">Refunded</div>
                    <div style="font-size: 24px; font-weight: 700; color: #ef4444;">AED <%= analytics.refundedAmount.toFixed(2) %></div>
                    <div style="font-size: 11px; color: #94a3b8; margin-top: 2px;"><%= analytics.refunded || 0 %> refunds</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-12 col-md-6 col-lg-3">
            <div class="card shadow-sm h-100" style="border-radius: 16px; border: 1px solid rgba(139, 92, 246, 0.2); overflow: hidden;">
              <div class="card-body" style="padding: 20px;">
                <div class="d-flex align-items-center">
                  <div style="width: 56px; height: 56px; border-radius: 14px; background: linear-gradient(135deg, #8b5cf6, #7c3aed); display: flex; align-items: center; justify-content: center; margin-right: 16px;">
                    <i class="fas fa-calculator" style="font-size: 24px; color: white;"></i>
                  </div>
                  <div class="flex-grow-1">
                    <div style="font-size: 11px; color: #64748b; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">Avg Order Value</div>
                    <div style="font-size: 24px; font-weight: 700; color: #8b5cf6;">AED <%= analytics.averageOrderValue.toFixed(2) %></div>
                    <div style="font-size: 11px; color: #94a3b8; margin-top: 2px;">per order</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Commission Analytics Cards -->
        <div class="row g-4 mb-4">
          <div class="col-12">
            <div class="card shadow-sm" style="border-radius: 16px; border: 1px solid rgba(58, 146, 189, 0.15); overflow: hidden;">
              <div class="card-header" style="background: linear-gradient(135deg, #3a92bd, #0c5374); border-bottom: none; padding: 16px 24px;">
                <h6 class="mb-0" style="color: white; font-weight: 700; display: flex; align-items: center; gap: 10px;">
                  <i class="fas fa-percentage"></i> Commission Breakdown
                </h6>
              </div>
              <div class="card-body" style="padding: 20px 24px;">
                <div class="row g-4">
                  <div class="col-12 col-md-4">
                    <div style="background: linear-gradient(135deg, rgba(58, 146, 189, 0.08), rgba(58, 146, 189, 0.02)); border-radius: 12px; padding: 20px; border: 1px solid rgba(58, 146, 189, 0.15); height: 100%;">
                      <div class="d-flex align-items-center gap-3">
                        <div style="width: 48px; height: 48px; border-radius: 12px; background: linear-gradient(135deg, #3a92bd, #0c5374); display: flex; align-items: center; justify-content: center;">
                          <i class="fas fa-percentage" style="color: white; font-size: 20px;"></i>
                        </div>
                        <div>
                          <div style="font-size: 11px; color: #64748b; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">G-Teacher Commission</div>
                          <div style="font-size: 26px; font-weight: 700; color: #3a92bd;">AED <%= (analytics.totalGTeacherCommission || 0).toLocaleString() %></div>
                          <div style="font-size: 11px; color: #94a3b8;">Platform earnings</div>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="col-12 col-md-4">
                    <div style="background: linear-gradient(135deg, rgba(245, 158, 11, 0.08), rgba(245, 158, 11, 0.02)); border-radius: 12px; padding: 20px; border: 1px solid rgba(245, 158, 11, 0.15); height: 100%;">
                      <div class="d-flex align-items-center gap-3">
                        <div style="width: 48px; height: 48px; border-radius: 12px; background: linear-gradient(135deg, #f59e0b, #d97706); display: flex; align-items: center; justify-content: center;">
                          <i class="fas fa-hand-holding-usd" style="color: white; font-size: 20px;"></i>
                        </div>
                        <div>
                          <div style="font-size: 11px; color: #64748b; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Teacher Net Payout</div>
                          <div style="font-size: 26px; font-weight: 700; color: #f59e0b;">AED <%= (analytics.totalTeacherNet || 0).toLocaleString() %></div>
                          <div style="font-size: 11px; color: #94a3b8;">To be paid to teachers</div>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="col-12 col-md-4">
                    <div style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.08), rgba(16, 185, 129, 0.02)); border-radius: 12px; padding: 20px; border: 1px solid rgba(16, 185, 129, 0.15); height: 100%;">
                      <div class="d-flex align-items-center gap-3">
                        <div style="width: 48px; height: 48px; border-radius: 12px; background: linear-gradient(135deg, #10b981, #059669); display: flex; align-items: center; justify-content: center;">
                          <i class="fas fa-chart-pie" style="color: white; font-size: 20px;"></i>
                        </div>
                        <div>
                          <div style="font-size: 11px; color: #64748b; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Commission Rate</div>
                          <% 
                            const totalRev = analytics.totalGTeacherCommission + analytics.totalTeacherNet || 0;
                            const commissionRate = totalRev > 0 ? ((analytics.totalGTeacherCommission / totalRev) * 100).toFixed(1) : 0;
                          %>
                          <div style="font-size: 26px; font-weight: 700; color: #10b981;"><%= commissionRate %>%</div>
                          <div style="font-size: 11px; color: #94a3b8;">Average platform rate</div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Sales Analytics Chart -->
        <div class="card shadow-sm mb-4 admin-card">
          <div class="card-header" style="background: linear-gradient(135deg, #3a92bd, #0c5374); border-bottom: none;">
            <h5 class="mb-0" style="color: #ffffff; font-weight: 700; display: flex; align-items: center; gap: 12px;">
              <i class="fas fa-chart-line"></i> Sales Analytics
            </h5>
          </div>
          <div class="card-body" style="padding: 24px;">
            <div style="position: relative; height: 300px;">
              <canvas id="ordersSalesChart"></canvas>
            </div>
          </div>
        </div>

        <!-- Advanced Filters (Exam Period, Teacher, Course, Invoices/Type, etc.) -->
        <div class="orders-filters-panel">
          <div class="orders-filters-header">
            <div class="orders-filters-title-wrap">
              <span class="orders-filters-icon"><i class="fas fa-sliders-h"></i></span>
              <div>
                <h2 class="orders-filters-title">Advanced Filters</h2>
                <p class="orders-filters-desc">By exam period, teacher, course, invoice type, promo & date</p>
              </div>
            </div>
            <button type="button" class="orders-filters-toggle" id="ordersFiltersToggle" aria-expanded="true" aria-controls="ordersFiltersBody">
              <i class="fas fa-chevron-up"></i>
              <span>Toggle</span>
            </button>
          </div>
          <form method="get" class="orders-filters-form" id="ordersFiltersForm">
            <input type="hidden" name="curriculumType" id="curriculumTypeInput" value="<%= (currentFilters.curriculumType || 'all') %>">
            <input type="hidden" name="examPeriod" id="examPeriodInput" value="<%= (currentFilters.examPeriod || 'all') %>">
            <div class="orders-filters-body" id="ordersFiltersBody">
              <!-- Quick Type chips: All | Invoiced | Pending | Failed | Refunded -->
              <div class="orders-filter-step">
                <h4 class="orders-filter-step-title"><i class="fas fa-file-invoice-dollar"></i> By type</h4>
                <div class="orders-type-chips">
                  <button type="button" class="orders-type-chip <%= (!currentFilters.status || currentFilters.status==='all') ? 'active' : '' %>" data-status="all">All</button>
                  <button type="button" class="orders-type-chip <%= (currentFilters.status==='completed') ? 'active' : '' %>" data-status="completed"><i class="fas fa-receipt"></i> Invoiced</button>
                  <button type="button" class="orders-type-chip <%= (currentFilters.status==='pending') ? 'active' : '' %>" data-status="pending">Pending</button>
                  <button type="button" class="orders-type-chip <%= (currentFilters.status==='failed') ? 'active' : '' %>" data-status="failed">Failed</button>
                  <button type="button" class="orders-type-chip <%= (currentFilters.status==='refunded') ? 'active' : '' %>" data-status="refunded">Refunded</button>
                </div>
              </div>
              <!-- Curriculum Type pills -->
              <div class="orders-filter-step">
                <h4 class="orders-filter-step-title"><i class="fas fa-graduation-cap"></i> Curriculum type</h4>
                <div class="orders-curriculum-pills">
                  <button type="button" class="orders-curriculum-pill <%= (!currentFilters.curriculumType || currentFilters.curriculumType==='all') ? 'active' : '' %>" data-curriculum="all">All</button>
                  <button type="button" class="orders-curriculum-pill <%= (currentFilters.curriculumType==='IGCSE') ? 'active' : '' %>" data-curriculum="IGCSE"><i class="fas fa-graduation-cap"></i> IGCSE</button>
                  <button type="button" class="orders-curriculum-pill <%= (currentFilters.curriculumType==='American') ? 'active' : '' %>" data-curriculum="American"><i class="fas fa-flag-usa"></i> American</button>
                </div>
              </div>
              <!-- Exam period pills (like courses) -->
              <div class="orders-filter-step">
                <h4 class="orders-filter-step-title"><i class="fas fa-calendar-alt"></i> Exam period</h4>
                <div class="orders-exam-pills">
                  <button type="button" class="orders-exam-pill <%= (!currentFilters.examPeriod || currentFilters.examPeriod==='all') ? 'active' : '' %>" data-exam-period="all">All</button>
                  <% (examPeriods || []).forEach(function(p) { %>
                  <button type="button" class="orders-exam-pill <%= (currentFilters.examPeriod==p._id || currentFilters.examPeriod==p._id.toString()) ? 'active' : '' %>" data-exam-period="<%= p._id %>" data-curriculum="<%= p.curriculumType || 'IGCSE' %>"><%= p.displayName || p.name %></button>
                  <% }); %>
                </div>
              </div>
              <!-- Search -->
              <div class="orders-filters-row orders-filters-search-row">
                <div class="orders-filter-item orders-filter-search">
                  <label class="orders-filter-label" for="ordersSearch">Search</label>
                  <div class="orders-search-wrap">
                    <i class="fas fa-search orders-search-icon"></i>
                    <input type="text" id="ordersSearch" name="search" class="orders-search-input" placeholder="Order #, email, name, phone" value="<%= (currentFilters.search || '') %>" autocomplete="off">
                  </div>
                </div>
              </div>
              <!-- Row: Status, Payment Status, Payment Method, Teacher, Course, Has Promo -->
              <div class="orders-filters-row orders-filters-dropdowns">
                <div class="orders-filter-item">
                  <label class="orders-filter-label" for="ordersStatus">Order status</label>
                  <select id="ordersStatus" name="status" class="orders-filter-select">
                    <option value="all">All</option>
                    <%- ['pending','processing','completed','failed','cancelled','refunded'].map(s=>`<option value="${s}" ${(currentFilters.status===s)?'selected':''}>${s.charAt(0).toUpperCase()+s.slice(1)}</option>`).join('') %>
                  </select>
                </div>
                <div class="orders-filter-item">
                  <label class="orders-filter-label" for="ordersPaymentStatus">Payment status</label>
                  <select id="ordersPaymentStatus" name="paymentStatus" class="orders-filter-select">
                    <option value="all">All</option>
                    <%- ['pending','processing','completed','failed','cancelled','refunded'].map(s=>`<option value="${s}" ${(currentFilters.paymentStatus===s)?'selected':''}>${s.charAt(0).toUpperCase()+s.slice(1)}</option>`).join('') %>
                  </select>
                </div>
                <div class="orders-filter-item">
                  <label class="orders-filter-label" for="ordersPaymentMethod">Payment method</label>
                  <select id="ordersPaymentMethod" name="paymentMethod" class="orders-filter-select">
                    <option value="all">All</option>
                    <%- ['credit_card','paypal','stripe','bank_transfer','paymob'].map(s=>`<option value="${s}" ${(currentFilters.paymentMethod===s)?'selected':''}>${(s||'').replace('_',' ').toUpperCase()}</option>`).join('') %>
                  </select>
                </div>
                <div class="orders-filter-item">
                  <label class="orders-filter-label" for="ordersTeacher">Teacher</label>
                  <select id="ordersTeacher" name="teacher" class="orders-filter-select">
                    <option value="all">All teachers</option>
                    <% (teachers || []).forEach(function(t) { %>
                    <option value="<%= t._id %>" <%= (currentFilters.teacher==t._id || (currentFilters.teacher&&currentFilters.teacher.toString())==(t._id&&t._id.toString()))?'selected':'' %>><%= t.firstName %> <%= t.lastName %><% if (t.teacherCode) { %> (<%= t.teacherCode %>)<% } %></option>
                    <% }); %>
                  </select>
                </div>
                <div class="orders-filter-item">
                  <label class="orders-filter-label" for="ordersCourse">Course</label>
                  <select id="ordersCourse" name="course" class="orders-filter-select">
                    <option value="all">All courses</option>
                    <% (courses || []).forEach(function(c) { %>
                    <option value="<%= c._id %>" <%= (currentFilters.course==c._id || (currentFilters.course&&currentFilters.course.toString())==(c._id&&c._id.toString()))?'selected':'' %>><%= (c.courseCode||'') %> – <%= (c.title||'').slice(0,50) %><%= (c.title&&c.title.length>50)?'…':'' %></option>
                    <% }); %>
                  </select>
                </div>
                <div class="orders-filter-item">
                  <label class="orders-filter-label" for="ordersHasPromo">Promo</label>
                  <select id="ordersHasPromo" name="hasPromo" class="orders-filter-select">
                    <option value="all">All</option>
                    <option value="yes" <%= (currentFilters.hasPromo==='yes')?'selected':'' %>>With promo</option>
                    <option value="no" <%= (currentFilters.hasPromo==='no')?'selected':'' %>>No promo</option>
                  </select>
                </div>
              </div>
              <!-- Row: Sort, Date From, Date To -->
              <div class="orders-filters-row orders-filters-dates">
                <div class="orders-filter-item">
                  <label class="orders-filter-label" for="ordersSort">Sort</label>
                  <select id="ordersSort" name="sort" class="orders-filter-select">
                    <option value="newest" <%= ((currentFilters.sort||'newest')==='newest')?'selected':'' %>>Newest first</option>
                    <option value="oldest" <%= (currentFilters.sort==='oldest')?'selected':'' %>>Oldest first</option>
                    <option value="total_high" <%= (currentFilters.sort==='total_high')?'selected':'' %>>Total: High–Low</option>
                    <option value="total_low" <%= (currentFilters.sort==='total_low')?'selected':'' %>>Total: Low–High</option>
                  </select>
                </div>
                <div class="orders-filter-item orders-filter-date">
                  <label class="orders-filter-label" for="ordersDateFrom">From <span class="orders-filter-hint">(dd/mm/yyyy)</span></label>
                  <input type="date" id="ordersDateFrom" name="dateFrom" class="orders-filter-date-input" value="<%= currentFilters.dateFrom || '' %>">
                </div>
                <div class="orders-filter-item orders-filter-date">
                  <label class="orders-filter-label" for="ordersDateTo">To <span class="orders-filter-hint">(dd/mm/yyyy)</span></label>
                  <input type="date" id="ordersDateTo" name="dateTo" class="orders-filter-date-input" value="<%= currentFilters.dateTo || '' %>">
                </div>
              </div>
              <% 
                var _act = [currentFilters.status, currentFilters.paymentStatus, currentFilters.paymentMethod, currentFilters.teacher, currentFilters.examPeriod, currentFilters.course, currentFilters.hasPromo].filter(function(x){ return x && x !== 'all'; }).length;
                if (currentFilters.search) _act++;
                if (currentFilters.dateFrom) _act++;
                if (currentFilters.dateTo) _act++;
              %>
              <% if (_act > 0) { %>
              <div class="orders-active-filters">
                <span class="orders-active-count"><i class="fas fa-filter"></i> <strong><%= _act %></strong> active</span>
                <a href="/admin/orders" class="orders-clear-all">Clear all</a>
              </div>
              <% } %>
              <div class="orders-filters-actions">
                <a href="/admin/orders" class="orders-filter-btn orders-filter-btn-clear"><i class="fas fa-times"></i> Clear</a>
                <button type="submit" class="orders-filter-btn orders-filter-btn-apply"><i class="fas fa-filter"></i> Apply</button>
              </div>
            </div>
          </form>
        </div>

        <!-- Orders Table -->
        <div class="card shadow-sm orders-table">
          <div class="card-header" style="background: linear-gradient(135deg, #3a92bd, #0c5374); border-bottom: none; padding: 20px 24px;">
            <div class="d-flex justify-content-between align-items-center">
              <h5 class="mb-0" style="color: #ffffff; font-weight: 700; display: flex; align-items: center; gap: 12px;">
                <i class="fas fa-list"></i> Order List
              </h5>
              <div class="badge" style="background: rgba(255, 255, 255, 0.2); color: white; border: 1px solid rgba(255, 255, 255, 0.3); padding: 8px 16px; border-radius: 20px; font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">
                <%= pagination.totalOrders %> Total Orders
              </div>
            </div>
          </div>
          <div class="table-responsive orders-table-wrap">
            <table class="table table-hover align-middle mb-0 orders-table-grid">
              <thead>
                <tr>
                  <th class="orders-th orders-th-order">Order #</th>
                  <th class="orders-th orders-th-customer">Customer</th>
                  <th class="orders-th orders-th-items">Items</th>
                  <th class="orders-th orders-th-teacher">Teacher</th>
                  <th class="orders-th orders-th-total">Total</th>
                  <th class="orders-th orders-th-fee">G-Teacher Fee</th>
                  <th class="orders-th orders-th-net">Teacher Net</th>
                  <th class="orders-th orders-th-status">Status</th>
                  <th class="orders-th orders-th-date">Date</th>
                  <th class="orders-th orders-th-actions text-end">Actions</th>
                </tr>
              </thead>
              <tbody>
                <% if (!orders || orders.length === 0) { %>
                <tr>
                  <td colspan="10" class="orders-empty-cell">
                    <div class="orders-empty-state">
                      <div class="orders-empty-icon"><i class="fas fa-shopping-cart"></i></div>
                      <div class="orders-empty-title">No Orders Found</div>
                      <div class="orders-empty-description">No orders match your current filters.</div>
                    </div>
                  </td>
                </tr>
                <% } %>
                <% (orders||[]).forEach(o => { 
                  const orderGTeacherCommission = o.totalGTeacherCommission || (o.items || []).reduce((sum, item) => sum + (item.gTeacherCommission || 0), 0);
                  const orderTeacherNet = o.totalTeacherNet || (o.items || []).reduce((sum, item) => sum + (item.teacherNet || 0), 0);
                  const itemTitles = (o.items && o.items.length > 0) ? o.items.map(i => i.title) : [];
                  // Teacher: from items.teacher first, else from items.item.teacher (course) for older orders
                  const teacherNames = (o.items || [])
                    .map(i => {
                      const t = (i.teacher && (i.teacher.firstName || i.teacher.lastName))
                        ? i.teacher
                        : (i.item?.teacher && (i.item.teacher.firstName || i.item.teacher.lastName))
                          ? i.item.teacher
                          : null;
                      return t ? [t.firstName, t.lastName].filter(Boolean).join(' ').trim() : null;
                    })
                    .filter(Boolean);
                  const teacherDisplay = teacherNames.length ? [...new Set(teacherNames)].join(', ') : '—';
                %>
                <tr class="orders-row">
                  <td class="orders-td orders-td-order">
                    <a href="/admin/orders/<%= o.orderNumber %>" class="order-number-link">#<%= o.orderNumber %></a>
                    <span class="order-payment-badge"><%= (o.paymentMethod || '').replace(/_/g, ' ') %></span>
                  </td>
                  <td class="orders-td orders-td-customer">
                    <div class="order-customer-name"><%= (o.user?.firstName||'') %> <%= (o.user?.lastName||'') %></div>
                    <div class="order-customer-email"><i class="fas fa-envelope"></i> <%= o.billingAddress?.email %></div>
                  </td>
                  <td class="orders-td orders-td-items">
                    <div class="order-items-count"><i class="fas fa-box"></i> <%= itemTitles.length %> item(s)</div>
                    <div class="order-items-preview"><%= itemTitles.slice(0,2).join(', ') %><%= itemTitles.length>2?' …':'' %></div>
                  </td>
                  <td class="orders-td orders-td-teacher">
                    <div class="order-teacher-name"><i class="fas fa-chalkboard-teacher"></i> <%= teacherDisplay %></div>
                  </td>
                  <td class="orders-td orders-td-total"><span class="order-amount order-amount-total">AED <%= (o.total||0).toFixed(2) %></span></td>
                  <td class="orders-td orders-td-fee"><span class="order-amount order-amount-fee">AED <%= orderGTeacherCommission.toFixed(2) %></span></td>
                  <td class="orders-td orders-td-net"><span class="order-amount order-amount-net">AED <%= orderTeacherNet.toFixed(2) %></span></td>
                  <td class="orders-td orders-td-status"><span class="status-badge status-<%= o.status %>"><%= (o.status||'').charAt(0).toUpperCase() + (o.status||'').slice(1) %></span></td>
                  <td class="orders-td orders-td-date">
                    <div class="order-date-line"><i class="far fa-calendar-alt"></i> <%= new Date(o.createdAt).toLocaleDateString() %></div>
                    <div class="order-time-line"><i class="far fa-clock"></i> <%= new Date(o.createdAt).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) %></div>
                  </td>
                  <td class="orders-td orders-td-actions">
                    <div class="orders-row-actions">
                      <a class="order-action-btn order-action-view" href="/admin/orders/<%= o.orderNumber %>" title="View Order Details"><i class="fas fa-eye"></i></a>
                      <% if (o.status === 'completed') { %>
                      <a class="order-action-btn order-action-refund" href="/admin/orders/<%= o.orderNumber %>#refund" title="Refund"><i class="fas fa-undo"></i></a>
                      <% } %>
                      <% if (o.status === 'failed' && o.paymentStatus === 'failed') { %>
                      <button type="button" class="order-action-btn order-action-complete" onclick="openCompletePaymentModal('<%= o.orderNumber %>', '<%= o._id %>')" title="Complete Failed Payment & Enroll Student"><i class="fas fa-magic"></i></button>
                      <% } %>
                    </div>
                  </td>
                </tr>
                <% }) %>
              </tbody>
            </table>
          </div>
          <div class="card-footer order-pagination" style="background: var(--admin-card-light); border: 2px solid var(--admin-border-light); border-radius: 16px; padding: 20px 24px; margin-top: 24px; box-shadow: var(--admin-shadow);">
            <div class="d-flex justify-content-between align-items-center">
              <div class="text-muted" style="color: #64748b; font-size: 14px; font-weight: 500;">
                Showing <span class="fw-semibold" style="color: var(--admin-primary); font-weight: 700;"><%= orders?.length || 0 %></span> orders -
                Page <span class="fw-semibold" style="color: var(--admin-primary); font-weight: 700;"><%= pagination.currentPage %></span> of
                <span class="fw-semibold" style="color: var(--admin-primary); font-weight: 700;"><%= pagination.totalPages %></span>
                (<span class="fw-semibold" style="color: var(--admin-primary); font-weight: 700;"><%= pagination.totalOrders %></span> total)
              </div>
              <div class="d-flex gap-1">
                <a class="btn btn-sm <%= pagination.hasPrev?'btn-primary':'btn-outline-secondary disabled' %>" href="?page=1<%= currentFilters.queryString ? '&' + currentFilters.queryString : '' %>" style="padding: 8px 12px; border: 2px solid var(--admin-border-light); background: var(--admin-card-light); color: var(--admin-text-light); border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; text-decoration: none; display: inline-flex; align-items: center; justify-content: center; min-width: 40px; height: 40px;">
                  <i class="fas fa-angle-double-left"></i>
                </a>
                <a class="btn btn-sm <%= pagination.hasPrev?'btn-outline-primary':'btn-outline-secondary disabled' %>" href="?page=<%= pagination.currentPage-1 %><%= currentFilters.queryString ? '&' + currentFilters.queryString : '' %>" style="padding: 8px 12px; border: 2px solid var(--admin-border-light); background: var(--admin-card-light); color: var(--admin-text-light); border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; text-decoration: none; display: inline-flex; align-items: center; justify-content: center; min-width: 40px; height: 40px;">
                  <i class="fas fa-angle-left"></i> Prev
                </a>
                <a class="btn btn-sm <%= pagination.hasNext?'btn-outline-primary':'btn-outline-secondary disabled' %>" href="?page=<%= pagination.currentPage+1 %><%= currentFilters.queryString ? '&' + currentFilters.queryString : '' %>" style="padding: 8px 12px; border: 2px solid var(--admin-border-light); background: var(--admin-card-light); color: var(--admin-text-light); border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; text-decoration: none; display: inline-flex; align-items: center; justify-content: center; min-width: 40px; height: 40px;">
                  Next <i class="fas fa-angle-right"></i>
                </a>
                <a class="btn btn-sm <%= pagination.hasNext?'btn-primary':'btn-outline-secondary disabled' %>" href="?page=<%= pagination.totalPages %><%= currentFilters.queryString ? '&' + currentFilters.queryString : '' %>" style="padding: 8px 12px; border: 2px solid var(--admin-border-light); background: var(--admin-card-light); color: var(--admin-text-light); border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; text-decoration: none; display: inline-flex; align-items: center; justify-content: center; min-width: 40px; height: 40px;">
                  <i class="fas fa-angle-double-right"></i>
                </a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>
</div>

<!-- Complete Failed Payment Modal -->
<div class="modal fade" id="completePaymentModal" tabindex="-1" aria-labelledby="completePaymentModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content" style="border-radius: 16px; border: none; box-shadow: 0 10px 40px rgba(0,0,0,0.2);">
      <div class="modal-header" style="background: linear-gradient(135deg, #10b981, #059669); border-radius: 16px 16px 0 0; border: none; padding: 24px;">
        <h5 class="modal-title" id="completePaymentModalLabel" style="color: white; font-weight: 700; font-size: 20px; display: flex; align-items: center; gap: 12px;">
          <i class="fas fa-check-circle" style="font-size: 24px;"></i>
          Complete Failed Payment
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" style="padding: 32px;">
        <div id="completePaymentModalContent">
          <!-- Confirmation Content -->
          <div id="completePaymentConfirmContent">
            <div class="mb-4" style="text-align: center;">
              <div style="width: 80px; height: 80px; margin: 0 auto 20px; background: linear-gradient(135deg, #10b981, #059669); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                <i class="fas fa-exclamation-triangle" style="font-size: 40px; color: white;"></i>
              </div>
              <h4 style="font-weight: 700; color: var(--admin-text-light); margin-bottom: 12px;">Confirm Payment Completion</h4>
              <p style="color: #64748b; font-size: 15px; margin-bottom: 0;">Order: <strong id="modalOrderNumber" style="color: var(--admin-primary);">#</strong></p>
            </div>
            <div style="background: #f8f9fa; border-radius: 12px; padding: 20px; margin-bottom: 24px;">
              <p style="font-weight: 600; color: var(--admin-text-light); margin-bottom: 16px; font-size: 15px;">This action will:</p>
              <ul style="list-style: none; padding: 0; margin: 0;">
                <li style="padding: 8px 0; color: #64748b; font-size: 14px; display: flex; align-items: start; gap: 10px;">
                  <i class="fas fa-check-circle" style="color: #10b981; margin-top: 4px;"></i>
                  <span>Mark payment as <strong>completed</strong></span>
                </li>
                <li style="padding: 8px 0; color: #64748b; font-size: 14px; display: flex; align-items: start; gap: 10px;">
                  <i class="fas fa-check-circle" style="color: #10b981; margin-top: 4px;"></i>
                  <span>Enroll student in courses</span>
                </li>
                <li style="padding: 8px 0; color: #64748b; font-size: 14px; display: flex; align-items: start; gap: 10px;">
                  <i class="fas fa-exclamation-triangle" style="color: #f59e0b; margin-top: 4px;"></i>
                  <span><strong>This action cannot be undone</strong></span>
                </li>
              </ul>
            </div>
            <div class="d-flex gap-2 justify-content-end">
              <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal" style="padding: 12px 24px; border-radius: 12px; font-weight: 600;">
                <i class="fas fa-times me-2"></i>Cancel
              </button>
              <button type="button" class="btn btn-success" id="confirmCompletePaymentBtn" style="padding: 12px 24px; border-radius: 12px; font-weight: 600; background: linear-gradient(135deg, #10b981, #059669); border: none;">
                <i class="fas fa-check-circle me-2"></i>Complete Payment
              </button>
            </div>
          </div>
          <!-- Processing Content -->
          <div id="completePaymentProcessingContent" style="display: none; text-align: center;">
            <div class="mb-4">
              <div style="width: 80px; height: 80px; margin: 0 auto 20px; background: linear-gradient(135deg, #10b981, #059669); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                <i class="fas fa-spinner fa-spin" style="font-size: 40px; color: white;"></i>
              </div>
              <h4 style="font-weight: 700; color: var(--admin-text-light); margin-bottom: 12px;">Processing Payment...</h4>
              <p style="color: #64748b; font-size: 15px;">Please wait while we complete the payment and enroll the student.</p>
            </div>
          </div>
          <!-- Success Content -->
          <div id="completePaymentSuccessContent" style="display: none; text-align: center;">
            <div class="mb-4">
              <div style="width: 80px; height: 80px; margin: 0 auto 20px; background: linear-gradient(135deg, #10b981, #059669); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                <i class="fas fa-check-circle" style="font-size: 40px; color: white;"></i>
              </div>
              <h4 style="font-weight: 700; color: #10b981; margin-bottom: 12px;">Payment Completed Successfully!</h4>
              <p style="color: #64748b; font-size: 15px;">Order has been marked as completed and the student has been enrolled.</p>
            </div>
            <button type="button" class="btn btn-success" onclick="window.location.reload()" style="padding: 12px 24px; border-radius: 12px; font-weight: 600; background: linear-gradient(135deg, #10b981, #059669); border: none;">
              <i class="fas fa-check me-2"></i>OK
            </button>
          </div>
          <!-- Error Content -->
          <div id="completePaymentErrorContent" style="display: none; text-align: center;">
            <div class="mb-4">
              <div style="width: 80px; height: 80px; margin: 0 auto 20px; background: linear-gradient(135deg, #3a92bd, #0c5374); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                <i class="fas fa-times-circle" style="font-size: 40px; color: white;"></i>
              </div>
              <h4 style="font-weight: 700; color: #ef4444; margin-bottom: 12px;">Error Completing Payment</h4>
              <p id="completePaymentErrorMessage" style="color: #64748b; font-size: 15px;"></p>
            </div>
            <button type="button" class="btn btn-danger" data-bs-dismiss="modal" style="padding: 12px 24px; border-radius: 12px; font-weight: 600;">
              <i class="fas fa-times me-2"></i>Close
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Include Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- Orders Page JS -->
<script>
  let currentOrderNumber = '';
  let currentOrderId = '';
  let currentButton = null;

  // Complete Failed Payment Function
  function openCompletePaymentModal(orderNumber, orderId) {
    currentOrderNumber = orderNumber;
    currentOrderId = orderId;
    currentButton = event.target.closest('button');
    
    // Set order number in modal
    document.getElementById('modalOrderNumber').textContent = `#${orderNumber}`;
    
    // Reset modal content to confirmation
    document.getElementById('completePaymentConfirmContent').style.display = 'block';
    document.getElementById('completePaymentProcessingContent').style.display = 'none';
    document.getElementById('completePaymentSuccessContent').style.display = 'none';
    document.getElementById('completePaymentErrorContent').style.display = 'none';
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('completePaymentModal'));
    modal.show();
  }

  // Handle confirm button click
  document.getElementById('confirmCompletePaymentBtn').addEventListener('click', async function() {
    // Hide confirmation, show processing
    document.getElementById('completePaymentConfirmContent').style.display = 'none';
    document.getElementById('completePaymentProcessingContent').style.display = 'block';
    
    // Disable close button during processing
    const modalElement = document.getElementById('completePaymentModal');
    const closeButtons = modalElement.querySelectorAll('[data-bs-dismiss="modal"]');
    closeButtons.forEach(btn => btn.style.display = 'none');

    const originalHTML = currentButton.innerHTML;
    currentButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
    currentButton.disabled = true;

    try {
      const response = await fetch(`/admin/orders/${currentOrderNumber}/complete-failed`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ orderId: currentOrderId }),
      });

      const data = await response.json();

      if (data.success) {
        // Show success content
        document.getElementById('completePaymentProcessingContent').style.display = 'none';
        document.getElementById('completePaymentSuccessContent').style.display = 'block';
        
        // Auto-reload after 2 seconds
        setTimeout(() => {
          window.location.reload();
        }, 2000);
      } else {
        throw new Error(data.message || 'Failed to complete payment');
      }
    } catch (error) {
      console.error('Error completing failed payment:', error);
      
      // Show error content
      document.getElementById('completePaymentProcessingContent').style.display = 'none';
      document.getElementById('completePaymentErrorContent').style.display = 'block';
      document.getElementById('completePaymentErrorMessage').textContent = error.message || 'Failed to complete payment. Please try again.';
      
      // Re-enable close button
      closeButtons.forEach(btn => btn.style.display = 'block');
      
      // Reset button
      currentButton.innerHTML = originalHTML;
      currentButton.disabled = false;
    }
  });

  // Excel Export Function
  function exportOrdersToExcel() {
    // Show loading state
    const btn = event.target.closest('button');
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Exporting...';
    btn.disabled = true;

    // Get current filters
    const urlParams = new URLSearchParams(window.location.search);
    const queryString = urlParams.toString();

    // Create export URL with current filters
    const exportUrl = `/admin/orders/export?${queryString}`;

    // Trigger download
    window.location.href = exportUrl;

    // Reset button after a delay
    setTimeout(() => {
      btn.innerHTML = originalText;
      btn.disabled = false;
    }, 2000);
  }

  // Get real data from server
  const monthlyData = <%- JSON.stringify(analytics.monthlySalesData || { labels: [], revenue: [], orderCount: [] }) %>;

  document.addEventListener('DOMContentLoaded', function() {
    // Filters toggle (form gets is-collapsed; .orders-filters-body is hidden via CSS)
    (function(){
      var t = document.getElementById('ordersFiltersToggle');
      var f = document.getElementById('ordersFiltersForm');
      if (t && f) {
        t.addEventListener('click', function() {
          var c = f.classList.toggle('is-collapsed');
          t.setAttribute('aria-expanded', c ? 'false' : 'true');
          var i = t.querySelector('i');
          if (i) i.className = c ? 'fas fa-chevron-down' : 'fas fa-chevron-up';
        });
      }
    })();

    // Type chips: set status and submit
    document.querySelectorAll('.orders-type-chip').forEach(function(btn) {
      btn.addEventListener('click', function() {
        var s = document.getElementById('ordersStatus');
        if (s) { s.value = this.getAttribute('data-status') || 'all'; }
        var form = document.getElementById('ordersFiltersForm');
        if (form && form.tagName === 'FORM') form.submit();
      });
    });
    
    // Curriculum type pills: set hidden, filter exam periods, and submit
    document.querySelectorAll('.orders-curriculum-pill').forEach(function(btn) {
      btn.addEventListener('click', function() {
        var selectedCurriculum = this.getAttribute('data-curriculum') || 'all';
        var h = document.getElementById('curriculumTypeInput');
        if (h) h.value = selectedCurriculum;
        
        // Reset exam period to 'all' when curriculum changes
        var examPeriodInput = document.getElementById('examPeriodInput');
        if (examPeriodInput) examPeriodInput.value = 'all';
        
        // Filter exam period pills based on curriculum selection
        document.querySelectorAll('.orders-exam-pill').forEach(function(pill) {
          var pillCurriculum = pill.getAttribute('data-curriculum');
          if (selectedCurriculum === 'all' || !pillCurriculum || pillCurriculum === selectedCurriculum) {
            pill.style.display = '';
          } else {
            pill.style.display = 'none';
            pill.classList.remove('active');
          }
        });
        
        // Make sure "All" is always visible
        var allPill = document.querySelector('.orders-exam-pill[data-exam-period="all"]');
        if (allPill) {
          allPill.style.display = '';
          allPill.classList.add('active');
        }
        
        // Update active state for curriculum pills
        document.querySelectorAll('.orders-curriculum-pill').forEach(function(p) {
          p.classList.remove('active');
        });
        this.classList.add('active');
        
        var form = document.getElementById('ordersFiltersForm');
        if (form && form.tagName === 'FORM') form.submit();
      });
    });
    
    // Exam period pills: set hidden and submit
    document.querySelectorAll('.orders-exam-pill').forEach(function(btn) {
      btn.addEventListener('click', function() {
        var h = document.getElementById('examPeriodInput');
        if (h) h.value = this.getAttribute('data-exam-period') || 'all';
        var form = document.getElementById('ordersFiltersForm');
        if (form && form.tagName === 'FORM') form.submit();
      });
    });

    // Sales Analytics Chart
    const chartElement = document.getElementById('ordersSalesChart');
    if (!chartElement) {
      console.error('Chart canvas element not found');
      return;
    }

    const ctx = chartElement.getContext('2d');
    if (!ctx) {
      console.error('Could not get 2d context from canvas');
      return;
    }

    try {
      const salesChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: monthlyData.labels || ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
          datasets: [{
              label: 'Revenue (AED)',
              data: monthlyData.revenue || [],
              borderColor: '#3a92bd',
              backgroundColor: 'rgba(58, 146, 189, 0.1)',
              tension: 0.4,
              fill: true
            },
            {
              label: 'Orders',
              data: monthlyData.orderCount || [],
              borderColor: '#0d6efd',
              borderDash: [5, 5],
              backgroundColor: 'transparent',
              tension: 0.4,
              fill: false,
              yAxisID: 'y1'
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: {
            mode: 'index',
            intersect: false,
          },
          plugins: {
            legend: {
              position: 'top',
              labels: {
                usePointStyle: true,
                padding: 15
              }
            },
            tooltip: {
              backgroundColor: 'rgba(0, 0, 0, 0.8)',
              titleColor: '#ffffff',
              bodyColor: '#ffffff',
              borderColor: '#3a92bd',
              borderWidth: 2,
              cornerRadius: 8,
              displayColors: true,
              padding: 12,
              callbacks: {
                label: function(context) {
                  let label = context.dataset.label || '';
                  if (label) {
                    label += ': ';
                  }
                  if (context.parsed.y !== null) {
                    if (context.dataset.label === 'Revenue') {
                      label += context.parsed.y.toFixed(2) + ' AED';
                    } else {
                      label += context.parsed.y;
                    }
                  }
                  return label;
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: 'Revenue (AED)'
              },
              ticks: {
                callback: function(value, index, values) {
                  return value.toFixed(0);
                }
              }
            },
            y1: {
              beginAtZero: true,
              position: 'right',
              title: {
                display: true,
                text: 'Number of Orders'
              },
              grid: {
                drawOnChartArea: false
              }
            }
          }
        }
      });
      
      console.log('Sales chart initialized successfully');
    } catch (error) {
      console.error('Error initializing sales chart:', error);
    }
  });
</script>

<!-- Include custom CSS -->
<link rel="stylesheet" href="/css/admin-orders.css">

<%- include('partials/admin-footer') %>