<%- include('partials/admin-header', { title: 'Brilliant Students Management', theme: 'admin', pageCSS: 'brilliant-students' }) %>

<!-- Admin Layout -->
<div class="admin-layout">

  <!-- Sidebar -->
  <%- include('./partials/admin-sidebar', { currentPage: 'brilliant-students' }) %>

  <!-- Main Content -->
  <main class="admin-main">

    <!-- Top Bar -->
    <%- include('./partials/admin-topbar', { 
        breadcrumb: 'Brilliant Students',
        breadcrumbSubtitle: 'Manage Outstanding Student Achievements',
        showSearch: false
    }) %>

    <!-- Content Area -->
    <div class="admin-content">

      <!-- Brilliant Students Management Page -->
      <div class="brilliant-students-container">
        <!-- Header Section -->
        <div class="brilliant-students-header">
          <div class="brilliant-students-title">
            <i class="fas fa-trophy"></i>
            <div>
              <h1>Brilliant Students</h1>
              <p>Manage outstanding student achievements and testimonials</p>
            </div>
          </div>
          <div class="brilliant-students-actions">
            <button class="btn-export" onclick="exportStudents()">
              <i class="fas fa-file-excel"></i>
              Export Excel Report
            </button>
            <button class="btn-add-student" onclick="showAddStudentModal()">
              <i class="fas fa-plus"></i>
              Add Student
            </button>
          </div>
        </div>

        <!-- Statistics Cards -->
        <div class="brilliant-students-stats">
          <div class="stat-card">
            <div class="stat-card-icon">
              <i class="fas fa-users"></i>
            </div>
            <div class="stat-card-number"><%= pagination.totalStudents %></div>
            <div class="stat-card-label">Total Students</div>
          </div>

          <% if (stats.EST) { %>
          <div class="stat-card">
            <div class="stat-card-icon">
              <i class="fas fa-graduation-cap"></i>
            </div>
            <div class="stat-card-number"><%= stats.EST.count %></div>
            <div class="stat-card-label">EST Students</div>
          </div>
          <% } %>

          <% if (stats.DSAT) { %>
          <div class="stat-card">
            <div class="stat-card-icon">
              <i class="fas fa-laptop"></i>
            </div>
            <div class="stat-card-number"><%= stats.DSAT.count %></div>
            <div class="stat-card-label">DSAT Students</div>
          </div>
          <% } %>

          <% if (stats.ACT) { %>
          <div class="stat-card">
            <div class="stat-card-icon">
              <i class="fas fa-award"></i>
            </div>
            <div class="stat-card-number"><%= stats.ACT.count %></div>
            <div class="stat-card-label">ACT Students</div>
          </div>
          <% } %>
        </div>

        <!-- Filters Section -->
        <div class="brilliant-students-filters">
          <form method="GET" action="/admin/brilliant-students" class="filters-form">
            <div class="filters-row">
              <div class="filter-group">
                <label class="filter-label">Test Type</label>
                <select name="testType" class="filter-control">
                  <option value="all" <%= filters.testType === 'all' ? 'selected' : '' %>>All Test Types</option>
                  <option value="EST" <%= filters.testType === 'EST' ? 'selected' : '' %>>EST</option>
                  <option value="DSAT" <%= filters.testType === 'DSAT' ? 'selected' : '' %>>DSAT</option>
                  <option value="ACT" <%= filters.testType === 'ACT' ? 'selected' : '' %>>ACT</option>
                </select>
              </div>

              <div class="filter-group">
                <label class="filter-label">Status</label>
                <select name="isActive" class="filter-control">
                  <option value="">All Status</option>
                  <option value="true" <%= filters.isActive === 'true' ? 'selected' : '' %>>Active</option>
                  <option value="false" <%= filters.isActive === 'false' ? 'selected' : '' %>>Inactive</option>
                </select>
              </div>

              <div class="filter-group">
                <label class="filter-label">Search</label>
                <input type="text" name="search" class="filter-control" placeholder="Search by name..." value="<%= filters.search %>">
              </div>
            </div>

            <div class="filter-actions">
              <button type="submit" class="btn-filter primary">
                <i class="fas fa-search"></i>
                Apply Filters
              </button>
              <a href="/admin/brilliant-students" class="btn-filter">
                <i class="fas fa-times"></i>
                Clear Filters
              </a>
            </div>
          </form>
        </div>

        <!-- Students Grid -->
        <div class="brilliant-students-grid" id="studentsGrid">
          <% if (students && students.length > 0) { %>
          <% students.forEach(student => { %>
          <div class="student-card draggable" data-id="<%= student._id %>">
            <div class="student-card-header">
              <div class="student-card-actions">
                <button class="student-card-action" onclick="editStudent('<%= student._id %>')" title="Edit">
                  <i class="fas fa-edit"></i>
                </button>
                <button class="student-card-action" onclick="deleteStudent('<%= student._id %>')" title="Delete">
                  <i class="fas fa-trash"></i>
                </button>
              </div>

              <div class="student-card-photo">
                <img src="<%= student.image || '/images/photoPlaceholder.jpg' %>" alt="<%= student.name %>" onerror="this.src='/images/photoPlaceholder.jpg';">
              </div>

              <div class="student-card-name"><%= student.name %></div>
              <div class="student-card-test-type"><%= student.testTypeDisplayName %></div>
            </div>

            <div class="student-card-body">
              <div class="student-card-score">
                <div>
                  <div class="student-score-value"><%= student.score %></div>
                  <div class="student-score-max">/ <%= student.maxScore %></div>
                </div>
                <div class="student-percentage"><%= student.percentage %>%</div>
              </div>

              <div class="score-progress">
                <div class="score-progress-fill" data-width="<%= student.percentage %>"></div>
              </div>

              <div class="student-card-details">
                <div class="student-detail-item">
                  <i class="fas fa-graduation-cap"></i>
                  <span><%= student.testTypeDisplayName %></span>
                </div>
              </div>
            </div>

            <div class="student-card-footer">
              <div class="student-status <%= student.isActive ? 'active' : 'inactive' %>">
                <i class="fas fa-circle"></i>
                <%= student.isActive ? 'Active' : 'Inactive' %>
              </div>
              <div class="student-display-order">Order: <%= student.displayOrder %></div>
            </div>
          </div>
          <% }); %>
          <% } else { %>
          <div class="no-students-message">
            <div class="no-students-icon">
              <i class="fas fa-user-graduate"></i>
            </div>
            <h3>No Brilliant Students Found</h3>
            <p>Start by adding some outstanding students to showcase their achievements.</p>
            <button class="btn-add-student" onclick="showAddStudentModal()">
              <i class="fas fa-plus"></i>
              Add First Student
            </button>
          </div>
          <% } %>
        </div>

        <!-- Pagination -->
        <% if (pagination.totalPages > 1) { %>
        <div class="brilliant-students-pagination">
          <% 
            // Build query parameters for pagination links
            const queryParts = [];
            if (filters.testType && filters.testType !== 'all') {
              queryParts.push('testType=' + encodeURIComponent(filters.testType));
            }
            if (filters.isActive) {
              queryParts.push('isActive=' + encodeURIComponent(filters.isActive));
            }
            if (filters.search) {
              queryParts.push('search=' + encodeURIComponent(filters.search));
            }
            const queryString = queryParts.length > 0 ? queryParts.join('&') : '';
            const paginationPrefix = queryString ? '?' + queryString + '&' : '?';
          %>
          <% if (pagination.hasPrev) { %>
          <a href="<%= paginationPrefix %>page=<%= pagination.prevPage %>" class="admin-pagination-btn">
            <i class="fas fa-chevron-left"></i>
            Previous
          </a>
          <% } %>

          <% for (let i = 1; i <= pagination.totalPages; i++) { %>
          <% if (i === pagination.currentPage) { %>
          <span class="admin-pagination-btn active"><%= i %></span>
          <% } else { %>
          <a href="<%= paginationPrefix %>page=<%= i %>" class="admin-pagination-btn"><%= i %></a>
          <% } %>
          <% } %>

          <% if (pagination.hasNext) { %>
          <a href="<%= paginationPrefix %>page=<%= pagination.nextPage %>" class="admin-pagination-btn">
            Next
            <i class="fas fa-chevron-right"></i>
          </a>
          <% } %>
        </div>
        <% } %>
      </div>

      <!-- Add/Edit Student Modal (Bootstrap) -->
      <div class="modal fade" id="studentModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="modalTitle">Add Brilliant Student</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <form id="studentForm">
              <div class="modal-body">
                <div class="form-grid">
                  <div class="form-group">
                    <label class="form-label">Student Name <span class="required">*</span></label>
                    <input type="text" name="name" class="form-control" required>
                  </div>

                  <div class="form-group">
                    <label class="form-label">Test Type <span class="required">*</span></label>
                    <select name="testType" id="testTypeSelect" class="form-control" required>
                      <option value="">Select Test Type</option>
                      <option value="EST">EST (0-800)</option>
                      <option value="DSAT">DSAT (0-800)</option>
                      <option value="ACT">ACT (0-36)</option>
                    </select>
                  </div>

                  <div class="form-group">
                    <label class="form-label">Score <span class="required">*</span></label>
                    <input type="number" name="score" class="form-control" required min="0">
                    <div class="form-help" id="scoreHelp">Enter the student's test score</div>
                  </div>

                  <div class="form-group">
                    <label class="form-label">Max Score <span class="required">*</span></label>
                    <input type="number" name="maxScore" id="maxScoreInput" class="form-control" required readonly>
                    <div class="form-help">Auto-filled based on test type selection</div>
                  </div>

                  <div class="form-group">
                    <label class="form-label">Fallback Initials <span class="required">*</span></label>
                    <input type="text" name="fallbackInitials" class="form-control" required maxlength="5" placeholder="e.g., JH">
                    <div class="form-help">Used when image is not available</div>
                  </div>

                  <div class="form-group">
                    <label class="form-label">Student Photo</label>
                    <input type="text" name="image" id="studentImageUrl" class="form-control" placeholder="Enter image URL or upload below">
                    <div class="form-help">Optional: URL to student's photo or upload using the section below</div>
                  </div>

                  <!-- Image Upload Section -->
                  <div class="form-group">
                    <label class="form-label">
                      <i class="fas fa-cloud-upload-alt me-2"></i>
                      Upload Student Photo
                    </label>
                    <div class="upload-section">
                      <input type="file" id="studentImageFile" class="upload-input" accept="image/*">
                      <label for="studentImageFile" class="upload-label">
                        <i class="fas fa-cloud-upload-alt"></i>
                        Choose Photo
                      </label>
                      <div id="studentImagePreview" class="upload-preview">
                        <div class="preview-overlay">
                          <i class="fas fa-cloud-upload-alt"></i>
                          <p>Click or drag to upload photo</p>
                          <small>JPEG, PNG, JPG, WebP (max 10MB)</small>
                        </div>
                      </div>
                      <div id="studentImageProgress" class="upload-progress" style="display: none;"></div>
                    </div>
                  </div>

                  <div class="form-group">
                    <label class="form-label">Display Order</label>
                    <input type="number" name="displayOrder" class="form-control" min="0" value="0">
                    <div class="form-help">Lower numbers appear first</div>
                  </div>

                  <div class="form-group">
                    <label class="form-label">Status</label>
                    <select name="isActive" class="form-control">
                      <option value="true">Active</option>
                      <option value="false">Inactive</option>
                    </select>
                  </div>
                </div>
              </div>

              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" class="btn btn-primary" id="submitButton">
                  <span class="button-text">Save Student</span>
                  <span class="button-loading" style="display: none;">
                    <i class="fas fa-spinner fa-spin"></i> Saving...
                  </span>
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>

      <!-- Local Upload Script -->
      <script src="/js/local-upload.js"></script>
      
      <!-- CropperJS CSS and JS -->
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
      <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>

      <!-- Image Crop Modal -->
      <div id="cropModal" class="crop-modal" style="display: none; position: fixed; z-index: 10000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.8); backdrop-filter: blur(4px);">
        <div class="crop-modal-content" style="background: #fff; border-radius: 12px; padding: 24px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.3); margin: auto; margin-top: 5vh;">
          <div class="crop-modal-header" style="margin-bottom: 20px; text-align: center; border-bottom: 2px solid #e5e7eb; padding-bottom: 16px;">
            <h3 class="crop-modal-title" style="font-size: 1.5rem; font-weight: 700; color: #1f2937; margin: 0 0 8px 0; display: flex; align-items: center; justify-content: center; gap: 8px;">
              <i class="fas fa-crop-alt" style="color: #B80101;"></i>
              Crop Your Photo
            </h3>
            <p class="crop-modal-subtitle" style="color: #6b7280; font-size: 0.875rem; margin: 0;">Adjust the crop area to select the perfect photo</p>
          </div>
          
          <div class="crop-container" style="width: 100%; max-height: 400px; background: #f3f4f6; border-radius: 8px; overflow: hidden; margin-bottom: 20px; border: 2px solid #e5e7eb;">
            <img id="cropImage" src="" alt="Image to crop" style="max-width: 100%; display: block;">
          </div>

          <div class="crop-controls" style="display: flex; flex-wrap: wrap; gap: 12px; margin-bottom: 20px; padding: 16px; background: #f9fafb; border-radius: 8px; border: 1px solid #e5e7eb;">
            <button type="button" class="crop-control-btn" onclick="rotateCropImage(-90)" style="flex: 1; min-width: 100px; padding: 8px 16px; border: 2px solid #e5e7eb; background: #fff; color: #1f2937; border-radius: 6px; cursor: pointer; transition: all 0.3s ease; font-size: 0.875rem; font-weight: 500; display: flex; align-items: center; justify-content: center; gap: 6px;">
              <i class="fas fa-undo"></i>
              Rotate Left
            </button>
            <button type="button" class="crop-control-btn" onclick="rotateCropImage(90)" style="flex: 1; min-width: 100px; padding: 8px 16px; border: 2px solid #e5e7eb; background: #fff; color: #1f2937; border-radius: 6px; cursor: pointer; transition: all 0.3s ease; font-size: 0.875rem; font-weight: 500; display: flex; align-items: center; justify-content: center; gap: 6px;">
              <i class="fas fa-redo"></i>
              Rotate Right
            </button>
            <button type="button" class="crop-control-btn" onclick="flipCropImage('horizontal')" style="flex: 1; min-width: 100px; padding: 8px 16px; border: 2px solid #e5e7eb; background: #fff; color: #1f2937; border-radius: 6px; cursor: pointer; transition: all 0.3s ease; font-size: 0.875rem; font-weight: 500; display: flex; align-items: center; justify-content: center; gap: 6px;">
              <i class="fas fa-arrows-alt-h"></i>
              Flip H
            </button>
            <button type="button" class="crop-control-btn" onclick="flipCropImage('vertical')" style="flex: 1; min-width: 100px; padding: 8px 16px; border: 2px solid #e5e7eb; background: #fff; color: #1f2937; border-radius: 6px; cursor: pointer; transition: all 0.3s ease; font-size: 0.875rem; font-weight: 500; display: flex; align-items: center; justify-content: center; gap: 6px;">
              <i class="fas fa-arrows-alt-v"></i>
              Flip V
            </button>
            <button type="button" class="crop-control-btn" onclick="resetCropImage()" style="flex: 1; min-width: 100px; padding: 8px 16px; border: 2px solid #e5e7eb; background: #fff; color: #1f2937; border-radius: 6px; cursor: pointer; transition: all 0.3s ease; font-size: 0.875rem; font-weight: 500; display: flex; align-items: center; justify-content: center; gap: 6px;">
              <i class="fas fa-sync-alt"></i>
              Reset
            </button>
          </div>
          
          <div class="crop-modal-footer" style="display: flex; gap: 12px; justify-content: flex-end;">
            <button type="button" class="btn btn-outline" onclick="closeCropModal()" style="padding: 10px 20px; border-radius: 6px; font-weight: 500; font-size: 0.875rem; transition: all 0.3s ease; cursor: pointer; border: 2px solid #e5e7eb; background: transparent; color: #1f2937;">
              <i class="fas fa-times"></i>
              Cancel
            </button>
            <button type="button" class="btn btn-primary" onclick="cropAndUploadStudentImage()" style="padding: 10px 20px; border-radius: 6px; font-weight: 500; font-size: 0.875rem; transition: all 0.3s ease; cursor: pointer; border: none; background: #B80101; color: white;">
              <i class="fas fa-check"></i>
              Crop & Upload
            </button>
          </div>
        </div>
      </div>

      <script>
        // Global variables
        let isEditMode = false;
        let currentStudentId = null;
        let cropper = null;
        let currentImageFile = null;
        let currentImagePreview = null;
        let currentImageProgress = null;
        let currentImageUrlInput = null;

        // Initialize local upload functionality
        document.addEventListener('DOMContentLoaded', function() {
          // Initialize local upload functionality and Bootstrap modal instance
          const modalEl = document.getElementById('studentModal');
          if (modalEl && typeof bootstrap !== 'undefined' && bootstrap.Modal) {
            // Make instance globally accessible for other functions
            window.studentModalInstance = bootstrap.Modal.getOrCreateInstance(modalEl);
            console.log('studentModal initialized');
          } else if (!modalEl) {
            console.warn('studentModal element not found');
          } else {
            console.warn('Bootstrap Modal API not available');
          }

          // Initialize image upload for student photos (using local upload)
          setupStudentImageUpload();
        });

        // Setup student image upload functionality
        function setupStudentImageUpload() {
          const imageFileInput = document.getElementById('studentImageFile');
          const imagePreview = document.getElementById('studentImagePreview');
          const imageProgress = document.getElementById('studentImageProgress');
          const imageUrlInput = document.getElementById('studentImageUrl');

          if (!imageFileInput || !imagePreview || !imageProgress || !imageUrlInput) {
            console.error('Student image upload elements not found');
            return;
          }

          // Handle file selection
          imageFileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
              handleStudentImageSelection(file, imagePreview, imageProgress, imageUrlInput);
            }
          });

          // Handle drag and drop
          imagePreview.addEventListener('dragover', (e) => {
            e.preventDefault();
            imagePreview.classList.add('drag-over');
          });

          imagePreview.addEventListener('dragleave', (e) => {
            e.preventDefault();
            imagePreview.classList.remove('drag-over');
          });

          imagePreview.addEventListener('drop', (e) => {
            e.preventDefault();
            imagePreview.classList.remove('drag-over');
            const file = e.dataTransfer.files[0];
            if (file) {
              imageFileInput.files = e.dataTransfer.files;
              handleStudentImageSelection(file, imagePreview, imageProgress, imageUrlInput);
            }
          });
        }

        // Handle student image selection and upload
        function handleStudentImageSelection(file, preview, progress, urlInput) {
          // Validate file
          if (!validateStudentImageFile(file)) {
            return;
          }

          // Store references for later use
          currentImageFile = file;
          currentImagePreview = preview;
          currentImageProgress = progress;
          currentImageUrlInput = urlInput;

          // Read the file and show in crop modal
          const reader = new FileReader();
          reader.onload = function(e) {
            const cropImage = document.getElementById('cropImage');
            cropImage.src = e.target.result;
            
            // Show crop modal
            showCropModal();
          };
          reader.readAsDataURL(file);
        }

        // Validate student image file
        function validateStudentImageFile(file) {
          const maxFileSize = 10 * 1024 * 1024; // 10MB
          const allowedTypes = ['image/jpeg', 'image/png', 'image/jpg', 'image/webp'];

          // Check file size
          if (file.size > maxFileSize) {
            showNotification('File size must be less than 10MB', 'error');
            return false;
          }

          // Check file type
          if (!allowedTypes.includes(file.type)) {
            showNotification('Only JPEG, PNG, JPG, and WebP images are allowed', 'error');
            return false;
          }

          return true;
        }

        // Show student image preview
        function showStudentImagePreview(file, preview) {
          const reader = new FileReader();
          reader.onload = (e) => {
            preview.innerHTML = `
      <img src="${e.target.result}" alt="Preview" class="preview-image">
      <div class="preview-overlay">
        <i class="fas fa-cloud-upload-alt"></i>
        <p>Uploading...</p>
        <small>${file.name}</small>
      </div>
    `;
          };
          reader.readAsDataURL(file);
        }

        // Show student image upload progress
        function showStudentImageProgress(progress, percent) {
          progress.style.display = 'block';
          progress.innerHTML = `
    <div class="progress-container">
      <div class="progress-bar">
        <div class="progress-fill" style="width: ${percent}%"></div>
      </div>
      <div class="progress-text">${percent}%</div>
    </div>
  `;
        }

        // Show crop modal
        function showCropModal() {
          const modal = document.getElementById('cropModal');
          modal.style.display = 'flex';
          document.body.style.overflow = 'hidden';

          // Initialize cropper
          const cropImage = document.getElementById('cropImage');
          if (cropper) {
            cropper.destroy();
          }
          
          cropper = new Cropper(cropImage, {
            aspectRatio: 1, // Square crop
            viewMode: 2,
            dragMode: 'move',
            autoCropArea: 0.8,
            restore: false,
            guides: true,
            center: true,
            highlight: false,
            cropBoxMovable: true,
            cropBoxResizable: true,
            toggleDragModeOnDblclick: false,
            responsive: true,
            background: false,
            modal: true,
            minContainerWidth: 200,
            minContainerHeight: 200,
            minCropBoxWidth: 100,
            minCropBoxHeight: 100,
          });
        }

        // Close crop modal
        function closeCropModal() {
          const modal = document.getElementById('cropModal');
          modal.style.display = 'none';
          document.body.style.overflow = 'auto';
          
          // Destroy cropper instance
          if (cropper) {
            cropper.destroy();
            cropper = null;
          }
          
          // Reset file input
          const fileInput = document.getElementById('studentImageFile');
          if (fileInput) {
            fileInput.value = '';
          }
          
          currentImageFile = null;
          currentImagePreview = null;
          currentImageProgress = null;
          currentImageUrlInput = null;
        }

        // Rotate crop image
        function rotateCropImage(degree) {
          if (cropper) {
            cropper.rotate(degree);
          }
        }

        // Flip crop image
        function flipCropImage(direction) {
          if (cropper) {
            if (direction === 'horizontal') {
              cropper.scaleX(-cropper.getData().scaleX || -1);
            } else if (direction === 'vertical') {
              cropper.scaleY(-cropper.getData().scaleY || -1);
            }
          }
        }

        // Reset crop image
        function resetCropImage() {
          if (cropper) {
            cropper.reset();
          }
        }

        // Crop and upload student image
        async function cropAndUploadStudentImage() {
          if (!cropper) {
            showNotification('No image to crop', 'error');
            return;
          }

          // Show loading state
          const uploadBtn = document.querySelector('.crop-modal-footer .btn-primary');
          const originalContent = uploadBtn.innerHTML;
          uploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uploading...';
          uploadBtn.disabled = true;

          try {
            // Get cropped canvas
            const canvas = cropper.getCroppedCanvas({
              width: 400,
              height: 400,
              imageSmoothingEnabled: true,
              imageSmoothingQuality: 'high',
            });

            // Convert canvas to blob
            canvas.toBlob(async (blob) => {
              if (!blob) {
                throw new Error('Failed to create image blob');
              }

              // Show progress bar
              if (currentImageProgress) {
                showStudentImageProgress(currentImageProgress, 0);
              }

              // Validate file size (max 5MB)
              if (blob.size > 5 * 1024 * 1024) {
                const fileSizeMB = (blob.size / (1024 * 1024)).toFixed(2);
                showNotification(`Image size (${fileSizeMB}MB) exceeds maximum allowed size of 5MB. Please choose a smaller image.`, 'error');
                uploadBtn.innerHTML = originalContent;
                uploadBtn.disabled = false;
                return;
              }

              // Create form data for local upload
              const formData = new FormData();
              formData.append('image', blob, currentImageFile.name);
              formData.append('uploadType', 'brilliant-students');

              const xhr = new XMLHttpRequest();

              // Upload progress
              xhr.upload.addEventListener('progress', (e) => {
                if (e.lengthComputable && currentImageProgress) {
                  const percent = Math.round((e.loaded / e.total) * 100);
                  showStudentImageProgress(currentImageProgress, percent);
                }
              });

              // Upload complete
              xhr.addEventListener('load', () => {
                if (xhr.status === 200) {
                  try {
                    const response = JSON.parse(xhr.responseText);
                    if (response.success && response.url) {
                      if (currentImagePreview && currentImageProgress && currentImageUrlInput) {
                        showStudentImageSuccess(currentImagePreview, currentImageProgress, response.url, currentImageUrlInput);
                      }
                      closeCropModal();
                    } else {
                      throw new Error(response.message || 'Upload failed');
                    }
                  } catch (e) {
                    showNotification('Invalid response from server. Please try again.', 'error');
                    if (currentImagePreview && currentImageProgress) {
                      resetStudentImageUpload(currentImagePreview, currentImageProgress);
                    }
                  }
                } else {
                  try {
                    const error = JSON.parse(xhr.responseText);
                    showNotification(error.message || `Upload failed with status ${xhr.status}`, 'error');
                  } catch (e) {
                    showNotification(`Upload failed with status ${xhr.status}. Please try again.`, 'error');
                  }
                  if (currentImagePreview && currentImageProgress) {
                    resetStudentImageUpload(currentImagePreview, currentImageProgress);
                  }
                }
                uploadBtn.innerHTML = originalContent;
                uploadBtn.disabled = false;
              });

              // Upload error
              xhr.addEventListener('error', () => {
                showNotification('Upload failed. Please check your connection and try again.', 'error');
                if (currentImagePreview && currentImageProgress) {
                  resetStudentImageUpload(currentImagePreview, currentImageProgress);
                }
                uploadBtn.innerHTML = originalContent;
                uploadBtn.disabled = false;
              });

              // Start upload
              xhr.open('POST', '/api/upload/image', true);
              xhr.send(formData);
            }, 'image/jpeg', 0.9);
          } catch (error) {
            console.error('Error cropping image:', error);
            showNotification(error.message || 'Error cropping image', 'error');
            uploadBtn.innerHTML = originalContent;
            uploadBtn.disabled = false;
          }
        }

        // Close modal when clicking outside
        document.getElementById('cropModal')?.addEventListener('click', function(e) {
          if (e.target === this) {
            closeCropModal();
          }
        });

        // Show student image upload success
        function showStudentImageSuccess(preview, progress, url, urlInput) {
          preview.innerHTML = `
    <img src="${url}" alt="Uploaded Image" class="preview-image">
    <div class="preview-overlay" style="opacity: 1; background: rgba(40, 167, 69, 0.9);">
      <i class="fas fa-check-circle" style="color: white;"></i>
      <p>Upload Successful!</p>
      <small>Image saved to server</small>
    </div>
  `;

          // Set the URL input value
          urlInput.value = url;
          urlInput.style.backgroundColor = '#d4edda';
          urlInput.style.border = '1px solid #c3e6cb';

          progress.style.display = 'none';
          showNotification('Image uploaded successfully!', 'success');
        }

        // Reset student image upload
        function resetStudentImageUpload(preview, progress) {
          preview.innerHTML = `
    <div class="preview-overlay">
      <i class="fas fa-cloud-upload-alt"></i>
      <p>Click or drag to upload photo</p>
      <small>JPEG, PNG, JPG, WebP (max 10MB)</small>
    </div>
  `;
          progress.style.display = 'none';
        }

        // Show add student modal
        function showAddStudentModal() {
          isEditMode = false;
          currentStudentId = null;
          document.getElementById('modalTitle').textContent = 'Add Brilliant Student';
          document.getElementById('studentForm').reset();

          // Reset image upload section
          const imagePreview = document.getElementById('studentImagePreview');
          const imageProgress = document.getElementById('studentImageProgress');
          const imageUrlInput = document.getElementById('studentImageUrl');

          if (imagePreview) {
            imagePreview.innerHTML = `
      <div class="preview-overlay">
        <i class="fas fa-cloud-upload-alt"></i>
        <p>Click or drag to upload photo</p>
        <small>JPEG, PNG, JPG, WebP (max 10MB)</small>
      </div>
    `;
          }

          if (imageProgress) {
            imageProgress.style.display = 'none';
          }

          if (imageUrlInput) {
            imageUrlInput.style.backgroundColor = '';
            imageUrlInput.style.border = '';
          }

          // Lazy-init Bootstrap modal instance if bootstrap is now available
          if (!window.studentModalInstance && typeof bootstrap !== 'undefined' && bootstrap.Modal) {
            window.studentModalInstance = bootstrap.Modal.getOrCreateInstance(document.getElementById('studentModal'));
            console.log('studentModal instance created lazily');
          }

          // Use Bootstrap modal API to show
          if (window.studentModalInstance && typeof window.studentModalInstance.show === 'function') {
            window.studentModalInstance.show();
            console.log('Bootstrap modal shown');
          } else {
            // Fallback to direct element manipulation if Bootstrap not available
            const modal = document.getElementById('studentModal');
            if (modal) {
              modal.style.display = 'flex';
              modal.classList.add('show');
              console.log('Fallback modal shown');
            }
          }

          // Ensure the updateScoreLimits function works when modal is shown
          setTimeout(() => {
            console.log('Modal shown, calling updateScoreLimits');
            updateScoreLimits();
          }, 100);
        }

        // Show edit student modal
        async function editStudent(studentId) {
          try {
            const response = await fetch(`/admin/brilliant-students/${studentId}`);
            const student = await response.json();

            if (student.success) {
              isEditMode = true;
              currentStudentId = studentId;

              // Populate form with student data
              document.getElementById('modalTitle').textContent = 'Edit Brilliant Student';

              // Fill form fields
              document.querySelector('input[name="name"]').value = student.data.name;
              document.querySelector('input[name="score"]').value = student.data.score;
              document.querySelector('input[name="maxScore"]').value = student.data.maxScore;
              document.querySelector('input[name="fallbackInitials"]').value = student.data.fallbackInitials;
              document.querySelector('input[name="image"]').value = student.data.image || '';
              document.querySelector('input[name="displayOrder"]').value = student.data.displayOrder;
              document.querySelector('select[name="isActive"]').value = student.data.isActive;

              // Handle image preview for edit mode
              if (student.data.image) {
                const imagePreview = document.getElementById('studentImagePreview');
                imagePreview.innerHTML = `
          <img src="${student.data.image}" alt="Current Image" class="preview-image">
          <div class="preview-overlay" style="opacity: 0.7;">
            <i class="fas fa-edit"></i>
            <p>Current Image</p>
            <small>Click to upload new image</small>
          </div>
        `;
              }

              // Lazy-init bootstrap modal if needed
              if (!window.studentModalInstance && typeof bootstrap !== 'undefined' && bootstrap.Modal) {
                window.studentModalInstance = bootstrap.Modal.getOrCreateInstance(document.getElementById('studentModal'));
                console.log('studentModal instance created lazily for edit');
              }

              // Show using Bootstrap modal instance
              if (window.studentModalInstance && typeof window.studentModalInstance.show === 'function') {
                window.studentModalInstance.show();
                console.log('Bootstrap modal shown for edit');
              } else {
                const modal = document.getElementById('studentModal');
                if (modal) {
                  modal.style.display = 'flex';
                  modal.classList.add('show');
                  console.log('Fallback modal shown for edit');
                }
              }

              // Set test type and update score limits after modal is shown
              setTimeout(() => {
                // Set test type using ID selector for reliability (after modal is shown)
                const testTypeSelect = document.getElementById('testTypeSelect');
                if (testTypeSelect && student.data.testType) {
                  testTypeSelect.value = student.data.testType;
                  console.log('Test type set to:', student.data.testType);
                }
                
                // Update score limits based on the selected test type
                console.log('Modal shown, calling updateScoreLimits for edit');
                updateScoreLimits();
              }, 100);
            } else {
              showNotification('Failed to load student data', 'error');
            }
          } catch (error) {
            console.error('Error loading student data:', error);
            showNotification('Failed to load student data', 'error');
          }
        }

        // Hide student modal
        function hideStudentModal() {
          if (window.studentModalInstance && typeof window.studentModalInstance.hide === 'function') {
            window.studentModalInstance.hide();
            console.log('Bootstrap modal hidden');
            return;
          }

          const modal = document.getElementById('studentModal');
          if (modal) {
            modal.classList.remove('show');
            modal.style.display = 'none';
            console.log('Fallback modal hidden');
          }
        }

        // Update score limits based on test type
        function updateScoreLimits() {
          console.log('updateScoreLimits called');

          const testTypeSelect = document.getElementById('testTypeSelect');
          const scoreInput = document.querySelector('input[name="score"]');
          const maxScoreInput = document.getElementById('maxScoreInput');
          const scoreHelp = document.getElementById('scoreHelp');

          if (!testTypeSelect || !scoreInput || !maxScoreInput) {
            console.error('Required elements not found');
            return;
          }

          const testType = testTypeSelect.value;
          console.log('Test type selected:', testType);

          // Clear previous values
          scoreInput.max = '';
          maxScoreInput.value = '';

          switch (testType) {
            case 'EST':
              scoreInput.max = 800;
              maxScoreInput.value = 800;
              if (scoreHelp) scoreHelp.textContent = 'EST scores range from 0-800';
              console.log('Set EST limits - maxScore: 800');
              break;
            case 'DSAT':
              scoreInput.max = 800;
              maxScoreInput.value = 800;
              if (scoreHelp) scoreHelp.textContent = 'DSAT scores range from 0-800';
              console.log('Set DSAT limits - maxScore: 800');
              break;
            case 'ACT':
              scoreInput.max = 36;
              maxScoreInput.value = 36;
              if (scoreHelp) scoreHelp.textContent = 'ACT scores range from 0-36';
              console.log('Set ACT limits - maxScore: 36');
              break;
            default:
              if (scoreHelp) scoreHelp.textContent = 'Select a test type first';
              console.log('Reset limits - no test type selected');
          }

          // Force visual update
          maxScoreInput.style.backgroundColor = maxScoreInput.value ? 'rgba(184, 1, 1, 0.05)' : '';
        }

        // Handle form submission
        async function handleFormSubmit(event) {
          event.preventDefault();

          const form = document.getElementById('studentForm');
          const formData = new FormData(form);
          const submitButton = document.getElementById('submitButton');
          const buttonText = submitButton.querySelector('.button-text');
          const buttonLoading = submitButton.querySelector('.button-loading');

          // Show loading state
          submitButton.disabled = true;
          buttonText.style.display = 'none';
          buttonLoading.style.display = 'inline-block';

          try {
            // Prepare data object
            const data = {
              name: formData.get('name'),
              testType: formData.get('testType'),
              score: formData.get('score'),
              maxScore: formData.get('maxScore'),
              fallbackInitials: formData.get('fallbackInitials'),
              image: formData.get('image'),
              displayOrder: formData.get('displayOrder'),
              isActive: formData.get('isActive')
            };

            console.log('Submitting data:', data);

            let url, method;
            if (isEditMode && currentStudentId) {
              url = `/admin/brilliant-students/${currentStudentId}`;
              method = 'PUT';
            } else {
              url = '/admin/brilliant-students';
              method = 'POST';
            }

            const response = await fetch(url, {
              method: method,
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify(data)
            });

            const result = await response.json();

            if (result.success) {
              showNotification(result.message, 'success');
              hideStudentModal();
              // Reload the page to show the new/updated student
              setTimeout(() => location.reload(), 1000);
            } else {
              showNotification(result.message, 'error');
              console.error('Server error:', result);
            }
          } catch (error) {
            console.error('Error submitting form:', error);
            showNotification('Failed to save student. Please try again.', 'error');
          } finally {
            // Reset button state
            submitButton.disabled = false;
            buttonText.style.display = 'inline-block';
            buttonLoading.style.display = 'none';
          }
        }

        // Add form submission event listener
        document.addEventListener('DOMContentLoaded', function() {
          const form = document.getElementById('studentForm');
          if (form) {
            form.addEventListener('submit', handleFormSubmit);
          }

          // Set progress bar widths from data attributes
          const progressBars = document.querySelectorAll('.score-progress-fill[data-width]');
          progressBars.forEach(bar => {
            const width = bar.getAttribute('data-width');
            bar.style.width = width + '%';
          });

          // Set fallback visibility from data attributes
          const fallbacks = document.querySelectorAll('.fallback[data-visible]');
          fallbacks.forEach(fallback => {
            const visible = fallback.getAttribute('data-visible') === 'true';
            fallback.style.display = visible ? 'flex' : 'none';
          });

          // Add event listener for test type changes - use event delegation
          document.addEventListener('change', function(e) {
            if (e.target.id === 'testTypeSelect') {
              console.log('Test type changed via event delegation:', e.target.value);
              updateScoreLimits();
            }
          });
        });


        // Delete student
        function deleteStudent(studentId) {
          if (confirm('Are you sure you want to delete this student? This action cannot be undone.')) {
            fetch(`/admin/brilliant-students/${studentId}`, {
                method: 'DELETE',
                headers: {
                  'Content-Type': 'application/json',
                }
              })
              .then(response => response.json())
              .then(data => {
                if (data.success) {
                  showNotification(data.message, 'success');
                  setTimeout(() => location.reload(), 1000);
                } else {
                  showNotification(data.message, 'error');
                }
              })
              .catch(error => {
                console.error('Error:', error);
                showNotification('Failed to delete student', 'error');
              });
          }
        }

        // Export students data
        function exportStudents() {
          try {
            const currentUrl = new URL(window.location.href);
            const exportUrl = new URL('/admin/brilliant-students/export', window.location.origin);
            
            // Copy search parameters
            currentUrl.searchParams.forEach((value, key) => {
              exportUrl.searchParams.set(key, value);
            });
            
            // Ensure Excel format
            exportUrl.searchParams.set('format', 'excel');

            // Show loading state
            const exportBtn = document.querySelector('.btn-export');
            if (exportBtn) {
              const originalText = exportBtn.innerHTML;
              exportBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Exporting...';
              exportBtn.disabled = true;

              // Reset button after a delay
              setTimeout(() => {
                exportBtn.innerHTML = originalText;
                exportBtn.disabled = false;
              }, 3000);
            }

            // Create a temporary link to trigger download
            const link = document.createElement('a');
            link.href = exportUrl.toString();
            link.download = `brilliant-students-report-${new Date().toISOString().split('T')[0]}.xlsx`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
          } catch (error) {
            console.error('Error exporting brilliant students:', error);
            // Reset button on error
            const exportBtn = document.querySelector('.btn-export');
            if (exportBtn) {
              exportBtn.innerHTML = '<i class="fas fa-file-excel"></i> Export Excel Report';
              exportBtn.disabled = false;
            }
          }
        }

        // Show notification
        function showNotification(message, type) {
          const notification = document.createElement('div');
          notification.className = `notification ${type === 'success' ? 'success-message' : 'error-message'}`;
          notification.textContent = message;

          document.body.appendChild(notification);

          setTimeout(() => {
            notification.classList.add('show');
          }, 100);

          setTimeout(() => {
            notification.classList.remove('show');
            setTimeout(() => notification.remove(), 300);
          }, 3000);
        }

        // Close modal on escape key using Bootstrap instance
        document.addEventListener('keydown', function(e) {
          if (e.key === 'Escape') {
            if (window.studentModalInstance && typeof window.studentModalInstance.hide === 'function') {
              window.studentModalInstance.hide();
            } else {
              hideStudentModal();
            }
          }
        });

        // Drag and drop functionality
        let draggedElement = null;
        let draggedIndex = null;

        document.addEventListener('DOMContentLoaded', function() {
          const grid = document.getElementById('studentsGrid');

          if (grid) {
            const draggableCards = grid.querySelectorAll('.draggable');
            
            draggableCards.forEach((card, index) => {
              // Make cards draggable
              card.setAttribute('draggable', 'true');
              
              card.addEventListener('dragstart', function(e) {
                draggedElement = card;
                draggedIndex = index;
                card.classList.add('dragging');
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('text/html', card.innerHTML);
              });

              card.addEventListener('dragend', function(e) {
                card.classList.remove('dragging');
                // Remove all drag-over classes
                grid.querySelectorAll('.drag-over').forEach(el => {
                  el.classList.remove('drag-over');
                });
              });

              card.addEventListener('dragover', function(e) {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
                
                if (draggedElement !== card) {
                  card.classList.add('drag-over');
                }
              });

              card.addEventListener('dragleave', function(e) {
                card.classList.remove('drag-over');
              });

              card.addEventListener('drop', function(e) {
                e.preventDefault();
                e.stopPropagation();
                
                card.classList.remove('drag-over');
                
                if (draggedElement !== card) {
                  // Get all cards
                  const allCards = Array.from(grid.querySelectorAll('.draggable'));
                  const draggedIdx = allCards.indexOf(draggedElement);
                  const targetIdx = allCards.indexOf(card);
                  
                  // Reorder in DOM
                  if (draggedIdx < targetIdx) {
                    card.parentNode.insertBefore(draggedElement, card.nextSibling);
                  } else {
                    card.parentNode.insertBefore(draggedElement, card);
                  }
                  
                  // Save new order to backend
                  saveStudentsOrder();
                }
              });
            });
          }
        });

        // Save students order to backend
        async function saveStudentsOrder() {
          try {
            const grid = document.getElementById('studentsGrid');
            const cards = grid.querySelectorAll('.draggable');
            
            const studentsOrder = Array.from(cards).map((card, index) => ({
              id: card.getAttribute('data-id'),
              order: index
            }));

            const response = await fetch('/admin/brilliant-students/reorder', {
              method: 'PUT',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({ students: studentsOrder })
            });

            const result = await response.json();

            if (result.success) {
              showNotification('Students reordered successfully!', 'success');
            } else {
              showNotification('Failed to save order. Please refresh the page.', 'error');
            }
          } catch (error) {
            console.error('Error saving students order:', error);
            showNotification('Failed to save order. Please try again.', 'error');
          }
        }
      </script>

    </div> <!-- admin-content -->
  </main> <!-- admin-main -->
</div> <!-- admin-layout -->

<%- include('partials/admin-footer') %>