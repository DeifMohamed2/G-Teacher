<%- include('./partials/admin-header', { pageCSS: 'courses' }) %>

<!-- MathLive for professional math input -->
<script src="https://unpkg.com/mathlive"></script>

<!-- SweetAlert2 for beautiful modals -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<!-- Admin Layout -->
<div class="admin-layout">

  <!-- Sidebar -->
  <%- include('./partials/admin-sidebar', { currentPage: 'courses' }) %>

  <!-- Main Content -->
  <main class="admin-main">

    <!-- Top Bar -->
    <%- include('./partials/admin-topbar', { 
        breadcrumb: `Courses / ${course.title}`,
        breadcrumbSubtitle: 'Manage Course Content and Topics',
        showSearch: false
    }) %>

    <!-- Content Area -->
    <div class="admin-content">
      <div class="admin-dashboard admin-fade-in">

        <!-- Course Header -->
        <div class="course-header-card">
          <div class="course-header-content">
            <div class="course-header-top">
              <div class="course-badges">
                <span class="course-level-badge"><%= course.level %></span>
                <span class="course-code-badge"><%= course.courseCode %></span>
                <% if (course.bundle) { %>
                <span class="bundle-badge">
                  <i class="fas fa-box"></i>
                  <%= course.bundle.bundleCode %>
                </span>
                <% } %>
              </div>
              <div class="course-header-actions">
                <button class="btn btn-outline-success btn-sm" onclick="editCourse('<%= course.courseCode %>')">
                  <i class="fas fa-edit"></i>
                  Edit Course
                </button>
                <button class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addTopicModal">
                  <i class="fas fa-plus"></i>
                  Add Topic
                </button>
                <button class="btn btn-outline-secondary btn-sm" onclick="toggleReorderMode()">
                  <i class="fas fa-sort"></i>
                  Reorder
                </button>
                <button class="btn btn-outline-info btn-sm" onclick="toggleAllTopics()">
                  <i class="fas fa-eye-slash"></i>
                  Toggle All
                </button>

              </div>
            </div>

            <div class="course-title-section">
              <h1 class="course-title"><%= course.title %></h1>
              <p class="course-description"><%= course.description %></p>
            </div>

            <div class="course-stats-grid">
              <div class="stat-card">
                <div class="stat-icon">
                  <i class="fas fa-layer-group"></i>
                </div>
                <div class="stat-content">
                  <div class="stat-number"><%= stats.totalTopics %></div>
                  <div class="stat-label">Topics</div>
                </div>
              </div>
              <div class="stat-card">
                <div class="stat-icon">
                  <i class="fas fa-clock"></i>
                </div>
                <div class="stat-content">
                  <div class="stat-number"><%= stats.estimatedDuration %></div>
                  <div class="stat-label">Hours</div>
                </div>
              </div>
              <div class="stat-card">
                <div class="stat-icon">
                  <i class="fas fa-users"></i>
                </div>
                <div class="stat-content">
                  <div class="stat-number"><%= stats.enrolledStudents %></div>
                  <div class="stat-label">Students</div>
                </div>
              </div>
              <div class="stat-card">
                <div class="stat-icon">
                  <i class="fas fa-file-alt"></i>
                </div>
                <div class="stat-content">
                  <div class="stat-number"><%= stats.totalContentItems %></div>
                  <div class="stat-label">Content Items</div>
                </div>
              </div>
              <div class="stat-card">
                <div class="stat-icon">
                  <i class="fas fa-eye"></i>
                </div>
                <div class="stat-content">
                  <div class="stat-number"><%= stats.publishedTopics %></div>
                  <div class="stat-label">Published</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Topics Section -->
        <div class="topics-section">
          <div class="section-header">
            <div class="section-title">
              <h3><i class="fas fa-list-ul"></i> Course Topics</h3>
              <span class="topic-count"><%= course.topics ? course.topics.length : 0 %> topics</span>
            </div>
          </div>

          <div class="topics-container" id="topicsContainer">
            <% if (course.topics && course.topics.length > 0) { %>
            <% course.topics.forEach((topic, index) => { %>
            <div class="topic-card" data-topic-id="<%= topic._id %>" data-order="<%= topic.order || index + 1 %>">
              <!-- Status Badge - Top Right -->
              <div class="topic-status-container">
                <span class="status-badge <%= topic.isPublished ? 'published' : 'draft' %>">
                  <i class="fas fa-<%= topic.isPublished ? 'eye' : 'eye-slash' %>"></i>
                  <%= topic.isPublished ? 'Published' : 'Draft' %>
                </span>
              </div>

              <div class="topic-card-header">
                <div class="topic-number"><%= String(index + 1).padStart(2, '0') %></div>
                <div class="topic-info">
                  <h4 class="topic-title"><%= topic.title %></h4>
                  <p class="topic-description"><%= topic.description %></p>
                  <div class="topic-meta">
                    <span class="meta-item">
                      <i class="fas fa-clock"></i>
                      <%= topic.estimatedTime ? Math.round(topic.estimatedTime / 60 * 10) / 10 : 0 %>h
                    </span>
                    <span class="meta-item">
                      <i class="fas fa-file-alt"></i>
                      <%= topic.content ? topic.content.length : 0 %> items
                    </span>
                    <span class="meta-item">
                      <i class="fas fa-signal"></i>
                      <span class="difficulty-badge difficulty-<%= topic.difficulty || 'beginner' %>">
                        <%= (topic.difficulty || 'beginner').charAt(0).toUpperCase() + (topic.difficulty || 'beginner').slice(1) %>
                      </span>
                    </span>
                  </div>
                </div>
                <div class="topic-actions">
                  <button class="action-btn" onclick="viewTopicDetails('<%= topic._id %>')" title="View Details">
                    <i class="fas fa-chart-line"></i>
                  </button>
                  <button class="action-btn visibility-toggle <%= topic.isPublished ? 'published' : 'draft' %>" onclick="toggleTopicVisibility('<%= topic._id %>', '<%= topic.isPublished %>')" title="<%= topic.isPublished ? 'Hide Topic' : 'Publish Topic' %>" data-topic-id="<%= topic._id %>">
                    <i class="fas fa-<%= topic.isPublished ? 'eye' : 'eye-slash' %>"></i>
                    <span class="btn-text"><%= topic.isPublished ? 'Hide' : 'Show' %></span>
                  </button>
                  <button class="action-btn" onclick="manageTopicContent('<%= topic._id %>')" title="Add Content">
                    <i class="fas fa-plus"></i>
                  </button>
                  <button class="action-btn" onclick="editTopic('<%= topic._id %>')" title="Edit Topic">
                    <i class="fas fa-edit"></i>
                  </button>
                  <button class="action-btn" onclick="duplicateTopic('<%= topic._id %>', '<%= course.courseCode %>')" title="Duplicate Topic">
                    <i class="fas fa-copy"></i>
                  </button>
                  <button class="action-btn danger" onclick="deleteTopic('<%= topic._id %>')" title="Delete Topic">
                    <i class="fas fa-trash"></i>
                  </button>
                </div>
              </div>

              <div class="topic-content-section" style="display: none;">
                <% if (topic.content && topic.content.length > 0) { %>
                <div class="content-items-header">
                  <button class="btn btn-sm btn-outline-secondary content-reorder-btn" onclick="toggleContentReorder('<%= topic._id %>')" title="Reorder Content">
                    <i class="fas fa-sort"></i>
                    Reorder Content
                  </button>
                </div>
                <div class="content-items" data-topic-id="<%= topic._id %>">
                  <% topic.content.forEach(contentItem => { %>
                  <div class="content-item" data-content-id="<%= contentItem._id %>" data-content-type="<%= contentItem.type %>" data-order="<%= contentItem.order || 0 %>">
                    <div class="content-drag-handle" title="Drag to reorder">
                      <i class="fas fa-grip-vertical"></i>
                    </div>
                    <div class="content-icon <%= contentItem.type %>">
                      <i class="fas fa-<%= getContentIcon(contentItem.type) %>"></i>
                    </div>
                    <div class="content-details">
                      <h6 class="content-title"><%= contentItem.title %></h6>
                      <div class="content-meta">
                        <span class="content-type"><%= contentItem.type.charAt(0).toUpperCase() + contentItem.type.slice(1) %></span>
                        <% if (contentItem.type === 'zoom' && contentItem.zoomMeeting) { %>
                        <span class="zoom-meeting-id">Meeting ID: <%= contentItem.zoomMeeting.meetingId %></span>
                        <span class="zoom-meeting-time">
                          <i class="fas fa-calendar-alt"></i>
                          <%= new Date(contentItem.zoomMeeting.scheduledStartTime).toLocaleDateString() %>
                          <%= new Date(contentItem.zoomMeeting.scheduledStartTime).toLocaleTimeString() %>
                        </span>
                        <% } else if (contentItem.duration) { %>
                        <span class="content-duration"><%= contentItem.duration %> min</span>
                        <% } %>
                      </div>
                      <% if (contentItem.description) { %>
                      <p class="content-description"><%= contentItem.description %></p>
                      <% } %>
                    </div>
                    <div class="content-actions">
                      <!-- Zoom Meeting Controls (Admin Only) -->
                      <% if (contentItem.type === 'zoom' && contentItem.zoomMeeting) { %>
                      <div class="zoom-meeting-controls mb-2">
                        <small class="text-muted d-block mb-1">ðŸ”’ Admin Controls Only</small>
                        <% if (contentItem.zoomMeeting.status === 'scheduled') { %>
                        <button class="btn btn-sm btn-success me-2" onclick="event.stopPropagation(); startZoomMeeting('<%= contentItem.zoomMeeting._id %>')" title="Start Meeting for Students">
                          <i class="fas fa-play"></i>
                          Start Meeting
                        </button>
                        <small class="text-muted">Meeting is locked until started</small>
                        <% } else if (contentItem.zoomMeeting.status === 'active') { %>
                        <a href="<%= contentItem.zoomMeeting.startUrl %>" target="_blank" class="btn btn-sm btn-primary me-2" title="Join as Host (External Zoom)">
                          <i class="fas fa-user-crown"></i>
                          Join as Host
                        </a>
                        <button class="btn btn-sm btn-warning me-2" onclick="event.stopPropagation(); endZoomMeeting('<%= contentItem.zoomMeeting._id %>')" title="End Meeting for All Participants">
                          <i class="fas fa-stop"></i>
                          End Meeting
                        </button>
                        <span class="badge bg-success">
                          <i class="fas fa-circle"></i>
                          Live - Students Can Join
                        </span>
                        <% } else if (contentItem.zoomMeeting.status === 'ended') { %>
                        <span class="badge bg-secondary">
                          <i class="fas fa-check"></i>
                          Meeting Ended
                        </span>
                        <% if (contentItem.zoomMeeting.recordingUrl) { %>
                        <button class="btn btn-sm btn-outline-warning ms-2" onclick="event.stopPropagation(); addRecordingUrl('<%= contentItem.zoomMeeting._id %>', '<%= contentItem.zoomMeeting.recordingUrl %>')" title="Edit Recording Link">
                          <i class="fas fa-edit"></i>
                          Edit Recording
                        </button>
                        <% } else { %>
                        <button class="btn btn-sm btn-outline-primary ms-2" onclick="event.stopPropagation(); addRecordingUrl('<%= contentItem.zoomMeeting._id %>')" title="Add Recording Link">
                          <i class="fas fa-video"></i>
                          Add Recording
                        </button>
                        <% } %>
                        <% } %>
                      </div>
                      <% } %>

                      <!-- Regular Content Actions -->
                      <div class="content-regular-actions">
                        <button class="btn btn-sm btn-outline-info" onclick="viewContentDetails('<%= topic._id %>', '<%= contentItem._id %>')" title="View Details">
                          <i class="fas fa-chart-line"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-success" onclick="shareContentLink('<%= course.courseCode %>', '<%= topic._id %>', '<%= contentItem._id %>', '<%= contentItem.title %>')" title="Share Content">
                          <i class="fas fa-share-alt"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-primary" onclick="editContent('<%= topic._id %>', '<%= contentItem._id %>')">
                          <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteContent('<%= topic._id %>', '<%= contentItem._id %>')">
                          <i class="fas fa-trash"></i>
                        </button>
                      </div>
                    </div>
                  </div>
                  <% }); %>
                </div>
                <% } else { %>
                <div class="empty-content">
                  <div class="empty-icon">
                    <i class="fas fa-plus-circle"></i>
                  </div>
                  <p>No content added yet</p>
                  <button class="btn btn-primary btn-sm" onclick="manageTopicContent('<%= topic._id %>')">
                    <i class="fas fa-plus"></i>
                    Add Content
                  </button>
                </div>
                <% } %>
              </div>
            </div>
            <% }); %>
            <% } else { %>
            <div class="empty-state">
              <div class="empty-icon">
                <i class="fas fa-book"></i>
              </div>
              <h4>No topics created yet</h4>
              <p>Create your first topic to start building course content</p>
              <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addTopicModal">
                <i class="fas fa-plus"></i>
                Create First Topic
              </button>
            </div>
            <% } %>
          </div>
        </div>

      </div>
    </div>

  </main>
</div>

<!-- Add Topic Modal -->
<div class="modal fade" id="addTopicModal" tabindex="-1" aria-labelledby="addTopicModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content admin-modal-content admin-modal-wide">
      <div class="modal-header admin-modal-header">
        <h5 class="modal-title" id="addTopicModalLabel">
          <i class="fas fa-plus-circle me-2"></i>
          Add New Topic
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <form id="addTopicForm" method="POST" action="/admin/courses/<%= courseCode %>/topics/create">
        <div class="modal-body admin-modal-body">
          <div class="row">
            <div class="col-md-8">
              <div class="admin-form-section">
                <h6 class="admin-form-section-title">
                  <i class="fas fa-info-circle me-2"></i>
                  Topic Information
                </h6>

                <div class="admin-form-group">
                  <label for="topicTitle" class="admin-form-label">
                    <i class="fas fa-heading me-2"></i>
                    Topic Title
                  </label>
                  <input type="text" class="admin-form-control" id="topicTitle" name="title" minlength="3" maxlength="100" required>
                  <small class="admin-form-text">Title must be between 3 and 100 characters</small>
                  <div class="invalid-feedback" id="topicTitleError"></div>
                </div>

                <div class="admin-form-group">
                  <label for="topicDescription" class="admin-form-label">
                    <i class="fas fa-align-left me-2"></i>
                    Topic Description
                  </label>
                  <textarea class="admin-form-control" id="topicDescription" name="description" rows="3" maxlength="500"></textarea>
                  <small class="admin-form-text">Description is optional (max 500 characters)</small>
                  <div class="invalid-feedback" id="topicDescriptionError"></div>
                </div>
              </div>
            </div>

            <div class="col-md-4">
              <div class="admin-form-section">
                <h6 class="admin-form-section-title">
                  <i class="fas fa-cog me-2"></i>
                  Topic Settings
                </h6>

                <div class="admin-form-group">
                  <label for="estimatedTime" class="admin-form-label">
                    <i class="fas fa-clock me-2"></i>
                    Estimated Time (minutes)
                  </label>
                  <input type="number" class="admin-form-control" id="estimatedTime" name="estimatedTime" min="1">
                </div>

                <div class="admin-form-group">
                  <label for="difficulty" class="admin-form-label">
                    <i class="fas fa-signal me-2"></i>
                    Difficulty Level
                  </label>
                  <select class="admin-form-control" id="difficulty" name="difficulty">
                    <option value="beginner">Beginner</option>
                    <option value="intermediate">Intermediate</option>
                    <option value="advanced">Advanced</option>
                  </select>
                </div>

                <div class="admin-form-group">
                  <label for="unlockConditions" class="admin-form-label">
                    <i class="fas fa-lock me-2"></i>
                    Unlock Conditions
                  </label>
                  <select class="admin-form-control" id="unlockConditions" name="unlockConditions">
                    <option value="immediate">Immediate Access</option>
                    <option value="previous_completed">Previous Topics Completed</option>
                    <option value="quiz_passed">Quiz Passed</option>
                  </select>
                </div>

                <div class="admin-form-group">
                  <div class="admin-form-check">
                    <input type="checkbox" class="admin-form-check-input" id="isPublished" name="isPublished">
                    <label class="admin-form-check-label" for="isPublished">
                      Publish immediately
                    </label>
                  </div>
                </div>
              </div>
            </div>
          </div>


          <!-- Tags Section -->
          <div class="row mt-3">
            <div class="col-12">
              <div class="admin-form-section">
                <h6 class="admin-form-section-title">
                  <i class="fas fa-tags me-2"></i>
                  Tags
                </h6>

                <div class="admin-form-group">
                  <label for="tags" class="admin-form-label">
                    <i class="fas fa-hashtag me-2"></i>
                    Topic Tags
                  </label>
                  <input type="text" class="admin-form-control" id="tags" name="tags" placeholder="Enter tags separated by commas">
                  <small class="admin-form-text">Example: mathematics, algebra, equations</small>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="modal-footer admin-modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary admin-btn-primary">
            <i class="fas fa-plus me-2"></i>
            Create Topic
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Add Content Modal -->
<div class="modal fade" id="addContentModal" tabindex="-1" aria-labelledby="addContentModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content admin-modal-content admin-modal-wide">
      <div class="modal-header admin-modal-header">
        <h5 class="modal-title" id="addContentModalLabel">
          <i class="fas fa-plus-circle me-2"></i>
          Add Content to Topic
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <form id="addContentForm" method="POST" action="">
        <div class="modal-body admin-modal-body">
          <div class="row">
            <div class="col-md-8">
              <div class="admin-form-section">
                <h6 class="admin-form-section-title">
                  <i class="fas fa-info-circle me-2"></i>
                  Content Information
                </h6>

                <div class="admin-form-group">
                  <label for="contentType" class="admin-form-label">
                    <i class="fas fa-file me-2"></i>
                    Content Type
                  </label>
                  <select class="admin-form-control" id="contentType" name="type" required>
                    <option value="">Select Type</option>
                    <option value="video">Video</option>
                    <option value="pdf">PDF Document</option>
                    <option value="homework">Homework</option>
                    <option value="quiz">Quiz</option>
                    <option value="zoom">Zoom Live Session</option>
                    <option value="link">External Link</option>
                  </select>
                </div>

                <div class="admin-form-group">
                  <label for="contentTitle" class="admin-form-label">
                    <i class="fas fa-heading me-2"></i>
                    Content Title
                  </label>
                  <input type="text" class="admin-form-control" id="contentTitle" name="title" required>
                </div>

                <div class="admin-form-group">
                  <label for="contentDescription" class="admin-form-label">
                    <i class="fas fa-align-left me-2"></i>
                    Description
                  </label>
                  <textarea class="admin-form-control" id="contentDescription" name="description" rows="2"></textarea>
                </div>

                <div class="admin-form-group" id="contentUrlSection">
                  <label for="contentUrl" class="admin-form-label">
                    <i class="fas fa-link me-2"></i>
                    Content URL/File
                  </label>
                  <input type="text" class="admin-form-control" id="contentUrl" name="content" required>
                  <small class="admin-form-text">Enter URL or upload file using the upload section below</small>
                  <div class="invalid-feedback" id="contentUrlError"></div>
                </div>

                <!-- File Upload Section -->
                <div class="admin-form-group" id="fileUploadSection" style="display: none;">
                  <label class="admin-form-label">
                    <i class="fas fa-cloud-upload-alt me-2"></i>
                    Upload File
                  </label>
                  <div class="upload-section">
                    <input type="file" id="contentFile" class="upload-input" accept=".pdf,application/pdf">
                    <label for="contentFile" class="upload-label">
                      <i class="fas fa-file-pdf"></i>
                      Choose PDF File
                    </label>
                    <div id="contentFilePreview" class="upload-preview">
                      <div class="preview-overlay">
                        <i class="fas fa-file-pdf"></i>
                        <p>Click or drag to upload PDF</p>
                        <small>PDF files only (max 50MB)</small>
                      </div>
                    </div>
                    <div id="contentFileProgress" class="progress-container" style="display: none;"></div>
                  </div>
                  <input type="hidden" name="uploadedFileUrl" id="uploadedFileUrl">
                </div>
              </div>
            </div>

            <div class="col-md-4">
              <div class="admin-form-section">
                <h6 class="admin-form-section-title">
                  <i class="fas fa-cog me-2"></i>
                  Content Settings
                </h6>

                <div class="admin-form-group">
                  <label for="contentDuration" class="admin-form-label">
                    <i class="fas fa-clock me-2"></i>
                    Duration (minutes)
                  </label>
                  <input type="number" class="admin-form-control" id="contentDuration" name="duration" min="0">
                </div>

                <div class="admin-form-group">
                  <label for="contentDifficulty" class="admin-form-label">
                    <i class="fas fa-signal me-2"></i>
                    Difficulty Level
                  </label>
                  <select class="admin-form-control" id="contentDifficulty" name="difficulty">
                    <option value="beginner">Beginner</option>
                    <option value="intermediate">Intermediate</option>
                    <option value="advanced">Advanced</option>
                  </select>
                </div>

                <!-- Video Watch Limit Section (Only for Video Content) -->
                <div class="admin-form-group" id="videoWatchLimitSection" style="display: none;">
                  <label for="maxWatchCount" class="admin-form-label">
                    <i class="fas fa-eye me-2"></i>
                    Max Watch Count
                  </label>
                  <input type="number" class="admin-form-control" id="maxWatchCount" name="maxWatchCount" min="-1" placeholder="Enter number or -1 for unlimited">
                  <small class="admin-form-text">Number of times students can complete watching this video (enter -1 for unlimited, or leave empty for unlimited)</small>
                </div>
              </div>
            </div>
          </div>

          <!-- Content Prerequisites Section -->
          <div class="row mt-4">
            <div class="col-12">
              <div class="admin-form-section">
                <h6 class="admin-form-section-title">
                  <i class="fas fa-link me-2"></i>
                  Content Prerequisites
                </h6>

                <div class="admin-form-group">
                  <label for="contentPrerequisites" class="admin-form-label">
                    <i class="fas fa-list-check me-2"></i>
                    Required Previous Content
                  </label>
                  <select class="admin-form-control" id="contentPrerequisites" name="prerequisites">
                    <option value="">No prerequisite (start immediately)</option>
                    <% if (allContentItems && allContentItems.length > 0) { %>
                    <% allContentItems.forEach((contentItem, index) => { %>
                    <option value="<%= contentItem._id %>" <%= index === allContentItems.length - 1 ? 'selected' : '' %>>
                      Topic <%= contentItem.topicOrder %>: <%= contentItem.topicTitle %> - <%= contentItem.title %> (<%= contentItem.type %>)
                    </option>
                    <% }); %>
                    <% } else { %>
                    <option disabled>No content items available yet</option>
                    <% } %>
                  </select>
                  <small class="admin-form-text">Select one content item that must be completed first (defaults to last added content)</small>
                </div>
              </div>
            </div>
          </div>

          <!-- Quiz Content Section -->
          <div class="row mt-4" id="quizContentSection" style="display: none;">
            <div class="col-12">
              <div class="admin-form-section">
                <h6 class="admin-form-section-title">
                  <i class="fas fa-clipboard-question me-2"></i>
                  Quiz Configuration
                </h6>

                <!-- Quiz Progress Steps -->
                <div class="quiz-progress-steps mb-2">
                  <div class="d-flex justify-content-between align-items-center">
                    <div class="quiz-step active" data-step="1">
                      <span class="step-number">1</span>
                      <span class="quiz-step-label">Bank</span>
                    </div>
                    <div class="progress-line"></div>
                    <div class="quiz-step" data-step="2">
                      <span class="step-number">2</span>
                      <span class="quiz-step-label">Questions</span>
                    </div>
                    <div class="progress-line"></div>
                    <div class="quiz-step" data-step="3">
                      <span class="step-number">3</span>
                      <span class="quiz-step-label">Settings</span>
                    </div>
                    <div class="progress-line"></div>
                    <div class="quiz-step" data-step="4">
                      <span class="step-number">4</span>
                      <span class="quiz-step-label">Preview</span>
                    </div>
                  </div>
                </div>

                <!-- Step 1: Question Bank Selection -->
                <div class="quiz-step-content" id="quizStep1">
                  <div class="admin-form-group">
                    <label class="admin-form-label">
                      <i class="fas fa-database me-2"></i>
                      Select Question Banks * <span id="quizSelectedBanksCount" class="text-muted">(0 selected)</span>
                    </label>
                    <div class="bank-cards-grid" id="quizQuestionBanksGrid">
                      <!-- Question banks will be loaded here -->
                    </div>
                    <div id="noQuizQuestionBanksMessage" class="text-center py-4" style="display: none;">
                      <i class="fas fa-database fa-2x text-muted mb-2"></i>
                      <p class="text-muted mb-0">No Question Banks Available</p>
                      <small class="text-muted">Create question banks first to add quiz content.</small>
                    </div>
                  </div>
                </div>

                <!-- Step 2: Question Selection -->
                <div class="quiz-step-content" id="quizStep2" style="display: none;">
                  <!-- Bank Filter Section -->
                  <div class="question-bank-filter-section">
                    <div class="filter-section-header">
                      <i class="fas fa-database"></i>
                      <span>Filter by Question Bank</span>
                    </div>
                    <div class="bank-filter-buttons" id="quizBankFilterButtons">
                      <button type="button" class="bank-filter-btn active" data-bank-id="all" onclick="filterQuizByBank('all')">
                        <i class="fas fa-th"></i>
                        All Banks
                      </button>
                      <!-- Bank filter buttons will be dynamically added here -->
                    </div>
                  </div>

                  <!-- Question Filters Section -->
                  <div class="question-filters-section">
                    <div class="filters-row">
                      <div class="filter-item">
                        <label class="filter-label">
                          <i class="fas fa-signal"></i>
                          Difficulty
                        </label>
                        <select class="filter-select" id="quizDifficultyFilter" onchange="filterQuizQuestions()">
                          <option value="">All Difficulties</option>
                          <option value="easy">Easy</option>
                          <option value="medium">Medium</option>
                          <option value="hard">Hard</option>
                        </select>
                      </div>

                      <div class="filter-item">
                        <label class="filter-label">
                          <i class="fas fa-tag"></i>
                          Type
                        </label>
                        <select class="filter-select" id="quizTypeFilter" onchange="filterQuizQuestions()">
                          <option value="">All Types</option>
                          <option value="MCQ">Multiple Choice</option>
                          <option value="True/False">True/False</option>
                          <option value="Written">Written</option>
                        </select>
                      </div>

                      <div class="filter-item">
                        <label class="filter-label">
                          <i class="fas fa-tags"></i>
                          Tags
                        </label>
                        <select class="filter-select" id="quizTagsFilter" onchange="filterQuizQuestions()">
                          <option value="">All Tags</option>
                          <!-- Tags will be populated dynamically -->
                        </select>
                      </div>

                      <div class="filter-item filter-search">
                        <label class="filter-label">
                          <i class="fas fa-search"></i>
                          Search
                        </label>
                        <input type="text" class="filter-search-input" id="quizSearchFilter" placeholder="Search questions..." onkeyup="filterQuizQuestions()">
                      </div>
                    </div>
                  </div>

                  <!-- Quick Selection Tools -->
                  <div class="quick-selection-tools">
                    <div class="selection-tools-left">
                      <input type="text" class="range-input" id="quizRangeInput" placeholder="Range: 1-5, 8, 10-12">
                      <button type="button" class="tool-btn" onclick="selectQuizRange()">
                        <i class="fas fa-list-ol"></i>
                        Select Range
                      </button>
                    </div>
                    <div class="selection-tools-right">
                      <button type="button" class="tool-btn" onclick="selectAllQuizQuestions()">
                        <i class="fas fa-check-double"></i>
                        Select All
                      </button>
                      <button type="button" class="tool-btn" onclick="clearQuizSelection()">
                        <i class="fas fa-times"></i>
                        Clear
                      </button>
                      <button type="button" class="tool-btn" onclick="selectEvenQuizQuestions()">
                        <i class="fas fa-sort-numeric-down"></i>
                        Even
                      </button>
                      <button type="button" class="tool-btn" onclick="selectOddQuizQuestions()">
                        <i class="fas fa-sort-numeric-up"></i>
                        Odd
                      </button>
                      <button type="button" class="tool-btn" onclick="selectRandomQuizQuestions()">
                        <i class="fas fa-random"></i>
                        Random 30%
                      </button>
                    </div>
                  </div>

                  <!-- Questions List Container -->
                  <div class="questions-list-container">
                    <div class="questions-list" id="quizQuestionsGrid">
                      <!-- Questions will be loaded here -->
                    </div>
                    <div id="noQuizQuestionsMessage" class="no-questions-message">
                      <i class="fas fa-question-circle"></i>
                      <p>No Questions Loaded</p>
                      <small>Please select question banks in Step 1 to load questions.</small>
                    </div>
                  </div>

                  <!-- Selection Summary -->
                  <div class="selection-summary-container">
                    <div class="selection-summary" id="quizSelectionSummary">
                      <div class="summary-item">
                        <span class="summary-label">Selected Questions:</span>
                        <span class="summary-value" id="quizSelectedCount">0</span>
                      </div>
                      <div class="summary-item">
                        <span class="summary-label">Total Points:</span>
                        <span class="summary-value" id="quizTotalPoints">0</span>
                      </div>
                      <div class="summary-item">
                        <span class="summary-label">Difficulty Distribution:</span>
                        <div class="difficulty-distribution" id="quizDifficultyDistribution">
                          <div class="difficulty-item">
                            <span class="badge bg-success">Easy: <span id="quizEasyCount">0</span></span>
                          </div>
                          <div class="difficulty-item">
                            <span class="badge bg-warning">Medium: <span id="quizMediumCount">0</span></span>
                          </div>
                          <div class="difficulty-item">
                            <span class="badge bg-danger">Hard: <span id="quizHardCount">0</span></span>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Step 3: Quiz Settings -->
                <div class="quiz-step-content" id="quizStep3" style="display: none;">
                  <div class="row">
                    <div class="col-md-6">
                      <div class="admin-form-group">
                        <label for="quizDuration" class="admin-form-label">
                          <i class="fas fa-clock me-2"></i>
                          Duration (minutes)
                        </label>
                        <input type="number" class="admin-form-control" id="quizDuration" name="quizDuration" value="30" min="1" max="300">
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="admin-form-group">
                        <label for="quizPassingScore" class="admin-form-label">
                          <i class="fas fa-percentage me-2"></i>
                          Passing Score (%)
                        </label>
                        <input type="number" class="admin-form-control" id="quizPassingScore" name="quizPassingScore" value="50" min="0" max="100">
                      </div>
                    </div>
                  </div>
                  <div class="row">
                    <div class="col-md-6">
                      <div class="admin-form-group">
                        <label for="quizMaxAttempts" class="admin-form-label">
                          <i class="fas fa-redo me-2"></i>
                          Max Attempts
                        </label>
                        <input type="number" class="admin-form-control" id="quizMaxAttempts" name="quizMaxAttempts" value="3" min="1" max="10">
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="admin-form-group">
                        <label class="admin-form-label">
                          <i class="fas fa-toggle-on me-2"></i>
                          Quiz Options
                        </label>
                        <div class="admin-form-check">
                          <input class="admin-form-check-input" type="checkbox" id="quizShuffleQuestions" name="quizShuffleQuestions">
                          <label class="admin-form-check-label" for="quizShuffleQuestions">Shuffle Questions</label>
                        </div>
                        <div class="admin-form-check">
                          <input class="admin-form-check-input" type="checkbox" id="quizShuffleOptions" name="quizShuffleOptions">
                          <label class="admin-form-check-label" for="quizShuffleOptions">Shuffle Options</label>
                        </div>
                        <div class="admin-form-check">
                          <input class="admin-form-check-input" type="checkbox" id="quizShowCorrectAnswers" name="quizShowCorrectAnswers" checked>
                          <label class="admin-form-check-label" for="quizShowCorrectAnswers">Show Correct Answers</label>
                        </div>
                        <div class="admin-form-check">
                          <input class="admin-form-check-input" type="checkbox" id="quizShowResults" name="quizShowResults" checked>
                          <label class="admin-form-check-label" for="quizShowResults">Show Results</label>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="admin-form-group">
                    <label for="quizInstructions" class="admin-form-label">
                      <i class="fas fa-info-circle me-2"></i>
                      Instructions
                    </label>
                    <textarea class="admin-form-control" id="quizInstructions" name="quizInstructions" rows="3" placeholder="Enter quiz instructions for students..."></textarea>
                  </div>
                </div>

                <!-- Step 4: Quiz Preview -->
                <div class="quiz-step-content" id="quizStep4" style="display: none;">
                  <div class="preview-header mb-3">
                    <h5 class="mb-2"><i class="fas fa-eye me-2"></i>Question Preview</h5>
                    <p class="text-muted mb-0">Review how questions will appear to students before submitting.</p>
                  </div>
                  
                  <!-- Preview Slider Container -->
                  <div class="preview-slider-container">
                    <div class="preview-navigation-top">
                      <button type="button" class="preview-nav-btn" onclick="prevQuizPreviewQuestion()" id="quizPreviewPrevBtn">
                        <i class="fas fa-chevron-left"></i>
                      </button>
                      <div class="preview-counter">
                        <span id="quizPreviewCurrentNum">1</span> of <span id="quizPreviewTotalNum">0</span>
                      </div>
                      <button type="button" class="preview-nav-btn" onclick="nextQuizPreviewQuestion()" id="quizPreviewNextBtn">
                        <i class="fas fa-chevron-right"></i>
                      </button>
                    </div>
                    
                    <div class="preview-question-card" id="quizPreviewQuestionCard">
                      <!-- Question content will be rendered here -->
                      <div class="preview-empty-state">
                        <i class="fas fa-clipboard-list fa-3x text-muted mb-3"></i>
                        <p class="text-muted">No questions selected. Go back to Step 2 to select questions.</p>
                      </div>
                    </div>
                    
                    <!-- Preview Dots Navigation -->
                    <div class="preview-dots-container" id="quizPreviewDots">
                      <!-- Dots will be rendered here -->
                    </div>
                  </div>
                </div>

                <!-- Quiz Navigation -->
                <div class="quiz-navigation mt-4">
                  <div class="d-flex justify-content-between">
                    <button type="button" class="btn btn-outline-secondary" id="quizPrevBtn" onclick="prevQuizStep()" disabled>
                      <i class="fas fa-arrow-left me-1"></i> Previous
                    </button>
                    <div class="quiz-step-indicator">
                      Step <span id="quizCurrentStepNumber">1</span> of 4
                    </div>
                    <button type="button" class="btn btn-primary" id="quizNextBtn" onclick="nextQuizStep()">
                      Next <i class="fas fa-arrow-right ms-1"></i>
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Homework Content Section -->
          <div class="row mt-4" id="homeworkContentSection" style="display: none;">
            <div class="col-12">
              <div class="admin-form-section">
                <h6 class="admin-form-section-title">
                  <i class="fas fa-tasks me-2"></i>
                  Homework Configuration
                </h6>

                <!-- Homework Progress Steps -->
                <div class="homework-progress-steps mb-2">
                  <div class="d-flex justify-content-between align-items-center">
                    <div class="homework-step active" data-step="1">
                      <span class="step-number">1</span>
                      <span class="homework-step-label">Bank</span>
                    </div>
                    <div class="progress-line"></div>
                    <div class="homework-step" data-step="2">
                      <span class="step-number">2</span>
                      <span class="homework-step-label">Questions</span>
                    </div>
                    <div class="progress-line"></div>
                    <div class="homework-step" data-step="3">
                      <span class="step-number">3</span>
                      <span class="homework-step-label">Settings</span>
                    </div>
                    <div class="progress-line"></div>
                    <div class="homework-step" data-step="4">
                      <span class="step-number">4</span>
                      <span class="homework-step-label">Preview</span>
                    </div>
                  </div>
                </div>

                <!-- Step 1: Question Bank Selection -->
                <div class="homework-step-content" id="homeworkStep1">
                  <div class="admin-form-group">
                    <label class="admin-form-label">
                      <i class="fas fa-database me-2"></i>
                      Select Question Banks * <span id="homeworkSelectedBanksCount" class="text-muted">(0 selected)</span>
                    </label>
                    <div class="bank-cards-grid" id="homeworkQuestionBanksGrid">
                      <!-- Question banks will be loaded here -->
                    </div>
                    <div id="noHomeworkQuestionBanksMessage" class="text-center py-4" style="display: none;">
                      <i class="fas fa-database fa-2x text-muted mb-2"></i>
                      <p class="text-muted mb-0">No Question Banks Available</p>
                      <small class="text-muted">Create question banks first to add homework content.</small>
                    </div>
                  </div>
                </div>

                <!-- Step 2: Question Selection -->
                <div class="homework-step-content" id="homeworkStep2" style="display: none;">
                  <!-- Bank Filter Section -->
                  <div class="question-bank-filter-section">
                    <div class="filter-section-header">
                      <i class="fas fa-database"></i>
                      <span>Filter by Question Bank</span>
                    </div>
                    <div class="bank-filter-buttons" id="homeworkBankFilterButtons">
                      <button type="button" class="bank-filter-btn active" data-bank-id="all" onclick="filterHomeworkByBank('all')">
                        <i class="fas fa-th"></i>
                        All Banks
                      </button>
                      <!-- Bank filter buttons will be dynamically added here -->
                    </div>
                  </div>

                  <!-- Question Filters Section -->
                  <div class="question-filters-section">
                    <div class="filters-row">
                      <div class="filter-item">
                        <label class="filter-label">
                          <i class="fas fa-signal"></i>
                          Difficulty
                        </label>
                        <select class="filter-select" id="homeworkDifficultyFilter" onchange="filterHomeworkQuestions()">
                          <option value="">All Difficulties</option>
                          <option value="easy">Easy</option>
                          <option value="medium">Medium</option>
                          <option value="hard">Hard</option>
                        </select>
                      </div>

                      <div class="filter-item">
                        <label class="filter-label">
                          <i class="fas fa-tag"></i>
                          Type
                        </label>
                        <select class="filter-select" id="homeworkTypeFilter" onchange="filterHomeworkQuestions()">
                          <option value="">All Types</option>
                          <option value="MCQ">Multiple Choice</option>
                          <option value="True/False">True/False</option>
                          <option value="Written">Written</option>
                        </select>
                      </div>

                      <div class="filter-item">
                        <label class="filter-label">
                          <i class="fas fa-tags"></i>
                          Tags
                        </label>
                        <select class="filter-select" id="homeworkTagsFilter" onchange="filterHomeworkQuestions()">
                          <option value="">All Tags</option>
                          <!-- Tags will be populated dynamically -->
                        </select>
                      </div>

                      <div class="filter-item filter-search">
                        <label class="filter-label">
                          <i class="fas fa-search"></i>
                          Search
                        </label>
                        <input type="text" class="filter-search-input" id="homeworkSearchFilter" placeholder="Search questions..." onkeyup="filterHomeworkQuestions()">
                      </div>
                    </div>
                  </div>

                  <!-- Quick Selection Tools -->
                  <div class="quick-selection-tools">
                    <div class="selection-tools-left">
                      <input type="text" class="range-input" id="homeworkRangeInput" placeholder="Range: 1-5, 8, 10-12">
                      <button type="button" class="tool-btn" onclick="selectHomeworkRange()">
                        <i class="fas fa-list-ol"></i>
                        Select Range
                      </button>
                    </div>
                    <div class="selection-tools-right">
                      <button type="button" class="tool-btn" onclick="selectAllHomeworkQuestions()">
                        <i class="fas fa-check-double"></i>
                        Select All
                      </button>
                      <button type="button" class="tool-btn" onclick="clearHomeworkSelection()">
                        <i class="fas fa-times"></i>
                        Clear
                      </button>
                      <button type="button" class="tool-btn" onclick="selectEvenHomeworkQuestions()">
                        <i class="fas fa-sort-numeric-down"></i>
                        Even
                      </button>
                      <button type="button" class="tool-btn" onclick="selectOddHomeworkQuestions()">
                        <i class="fas fa-sort-numeric-up"></i>
                        Odd
                      </button>
                      <button type="button" class="tool-btn" onclick="selectRandomHomeworkQuestions()">
                        <i class="fas fa-random"></i>
                        Random 30%
                      </button>
                    </div>
                  </div>

                  <!-- Questions List Container -->
                  <div class="questions-list-container">
                    <div class="questions-list" id="homeworkQuestionsGrid">
                      <!-- Questions will be loaded here -->
                    </div>
                    <div id="noHomeworkQuestionsMessage" class="no-questions-message">
                      <i class="fas fa-question-circle"></i>
                      <p>No Questions Loaded</p>
                      <small>Please select question banks in Step 1 to load questions.</small>
                    </div>
                  </div>

                  <!-- Selection Summary -->
                  <div class="selection-summary-container">
                    <div class="selection-summary" id="homeworkSelectionSummary">
                      <div class="summary-item">
                        <span class="summary-label">Selected Questions:</span>
                        <span class="summary-value" id="homeworkSelectedCount">0</span>
                      </div>
                      <div class="summary-item">
                        <span class="summary-label">Total Points:</span>
                        <span class="summary-value" id="homeworkTotalPoints">0</span>
                      </div>
                      <div class="summary-item">
                        <span class="summary-label">Difficulty Distribution:</span>
                        <div class="difficulty-distribution" id="homeworkDifficultyDistribution">
                          <div class="difficulty-item">
                            <span class="badge bg-success">Easy: <span id="homeworkEasyCount">0</span></span>
                          </div>
                          <div class="difficulty-item">
                            <span class="badge bg-warning">Medium: <span id="homeworkMediumCount">0</span></span>
                          </div>
                          <div class="difficulty-item">
                            <span class="badge bg-danger">Hard: <span id="homeworkHardCount">0</span></span>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Step 3: Homework Settings -->
                <div class="homework-step-content" id="homeworkStep3" style="display: none;">
                  <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    Homework has no time limit and uses pass/fail grading only.
                  </div>
                  <div class="row">
                    <div class="col-md-6">
                      <div class="admin-form-group">
                        <label for="homeworkPassingScore" class="admin-form-label">
                          <i class="fas fa-percentage me-2"></i>
                          Passing Score (%)
                        </label>
                        <input type="number" class="admin-form-control" id="homeworkPassingScore" name="homeworkPassingScore" value="0" min="0" max="100">
                        <small class="admin-form-text">Set to 0% to allow students to pass by simply submitting (no minimum score required)</small>
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="admin-form-group">
                        <label for="homeworkMaxAttempts" class="admin-form-label">
                          <i class="fas fa-redo me-2"></i>
                          Max Attempts
                        </label>
                        <input type="number" class="admin-form-control" id="homeworkMaxAttempts" name="homeworkMaxAttempts" value="1" min="1" max="5">
                      </div>
                    </div>
                  </div>
                  <div class="admin-form-group">
                    <label class="admin-form-label">
                      <i class="fas fa-toggle-on me-2"></i>
                      Homework Options
                    </label>
                    <div class="admin-form-check">
                      <input class="admin-form-check-input" type="checkbox" id="homeworkShuffleQuestions" name="homeworkShuffleQuestions">
                      <label class="admin-form-check-label" for="homeworkShuffleQuestions">Shuffle Questions</label>
                    </div>
                    <div class="admin-form-check">
                      <input class="admin-form-check-input" type="checkbox" id="homeworkShuffleOptions" name="homeworkShuffleOptions">
                      <label class="admin-form-check-label" for="homeworkShuffleOptions">Shuffle Options</label>
                    </div>
                    <div class="admin-form-check">
                      <input class="admin-form-check-input" type="checkbox" id="homeworkShowCorrectAnswers" name="homeworkShowCorrectAnswers">
                      <label class="admin-form-check-label" for="homeworkShowCorrectAnswers">Show Correct Answers After Submission</label>
                    </div>
                  </div>
                  <div class="admin-form-group">
                    <label for="homeworkInstructions" class="admin-form-label">
                      <i class="fas fa-info-circle me-2"></i>
                      Instructions
                    </label>
                    <textarea class="admin-form-control" id="homeworkInstructions" name="homeworkInstructions" rows="3" placeholder="Enter homework instructions for students..."></textarea>
                  </div>
                </div>

                <!-- Step 4: Homework Preview -->
                <div class="homework-step-content" id="homeworkStep4" style="display: none;">
                  <div class="preview-header mb-3">
                    <h5 class="mb-2"><i class="fas fa-eye me-2"></i>Question Preview</h5>
                    <p class="text-muted mb-0">Review how questions will appear to students before submitting.</p>
                  </div>
                  
                  <!-- Preview Slider Container -->
                  <div class="preview-slider-container">
                    <div class="preview-navigation-top">
                      <button type="button" class="preview-nav-btn" onclick="prevHomeworkPreviewQuestion()" id="homeworkPreviewPrevBtn">
                        <i class="fas fa-chevron-left"></i>
                      </button>
                      <div class="preview-counter">
                        <span id="homeworkPreviewCurrentNum">1</span> of <span id="homeworkPreviewTotalNum">0</span>
                      </div>
                      <button type="button" class="preview-nav-btn" onclick="nextHomeworkPreviewQuestion()" id="homeworkPreviewNextBtn">
                        <i class="fas fa-chevron-right"></i>
                      </button>
                    </div>
                    
                    <div class="preview-question-card" id="homeworkPreviewQuestionCard">
                      <!-- Question content will be rendered here -->
                      <div class="preview-empty-state">
                        <i class="fas fa-clipboard-list fa-3x text-muted mb-3"></i>
                        <p class="text-muted">No questions selected. Go back to Step 2 to select questions.</p>
                      </div>
                    </div>
                    
                    <!-- Preview Dots Navigation -->
                    <div class="preview-dots-container" id="homeworkPreviewDots">
                      <!-- Dots will be rendered here -->
                    </div>
                  </div>
                </div>

                <!-- Homework Navigation -->
                <div class="homework-navigation mt-4">
                  <div class="d-flex justify-content-between">
                    <button type="button" class="btn btn-outline-secondary" id="homeworkPrevBtn" onclick="prevHomeworkStep()" disabled>
                      <i class="fas fa-arrow-left me-1"></i> Previous
                    </button>
                    <div class="homework-step-indicator">
                      Step <span id="homeworkCurrentStepNumber">1</span> of 4
                    </div>
                    <button type="button" class="btn btn-success" id="homeworkNextBtn" onclick="nextHomeworkStep()">
                      Next <i class="fas fa-arrow-right ms-1"></i>
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Content Tags Section -->
          <div class="row mt-3">
            <div class="col-12">
              <div class="admin-form-section">
                <h6 class="admin-form-section-title">
                  <i class="fas fa-tags me-2"></i>
                  Content Tags
                </h6>

                <div class="admin-form-group">
                  <label for="contentTags" class="admin-form-label">
                    <i class="fas fa-hashtag me-2"></i>
                    Content Tags
                  </label>
                  <input type="text" class="admin-form-control" id="contentTags" name="tags" placeholder="Enter tags separated by commas">
                  <small class="admin-form-text">Example: video, tutorial, introduction</small>
                </div>
              </div>
            </div>
          </div>

          <!-- Zoom Meeting Content Section -->
          <div class="row mt-4" id="zoomContentSection" style="display: none;">
            <div class="col-12">
              <div class="zoom-config-header mb-4">
                <h5 class="mb-2" style="color: #2d3748; font-weight: 600; display: flex; align-items: center;">
                  <i class="fas fa-video me-2" style="color: #2d5aa0;"></i>
                  Zoom Live Session Configuration
                </h5>
                <div class="alert alert-info mb-0" style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); border: 1px solid #90caf9; border-radius: 8px; padding: 12px 16px;">
                  <i class="fas fa-info-circle me-2" style="color: #1976d2;"></i>
                  <small style="color: #1565c0; font-weight: 500;">Schedule a live Zoom session. The meeting will be locked until you start it from the admin panel.</small>
                </div>
              </div>

              <!-- Meeting Basic Info -->
              <div class="row g-3 mb-3">
                <div class="col-md-6">
                  <div class="mb-3">
                    <label for="zoomMeetingName" class="admin-form-label" style="font-weight: 500; color: #4a5568; margin-bottom: 8px;">
                      <i class="fas fa-signature me-2" style="color: #2d5aa0;"></i>
                      Meeting Name
                    </label>
                    <input type="text" class="admin-form-control" id="zoomMeetingName" name="zoomMeetingName" placeholder="e.g., Week 1 Live Q&A Session" style="border-radius: 8px; border: 1px solid #e2e8f0; padding: 10px 14px; transition: all 0.3s ease;">
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="mb-3">
                    <label for="zoomMeetingTopic" class="admin-form-label" style="font-weight: 500; color: #4a5568; margin-bottom: 8px;">
                      <i class="fas fa-comment-dots me-2" style="color: #2d5aa0;"></i>
                      Meeting Topic
                    </label>
                    <input type="text" class="admin-form-control" id="zoomMeetingTopic" name="zoomMeetingTopic" placeholder="What will be discussed?" style="border-radius: 8px; border: 1px solid #e2e8f0; padding: 10px 14px; transition: all 0.3s ease;">
                  </div>
                </div>
              </div>

              <!-- Scheduling -->
              <div class="row g-3 mb-3">
                <div class="col-md-6">
                  <div class="mb-3">
                    <label for="zoomScheduledTime" class="admin-form-label" style="font-weight: 500; color: #4a5568; margin-bottom: 8px;">
                      <i class="far fa-calendar-alt me-2" style="color: #2d5aa0;"></i>
                      Scheduled Start Time
                    </label>
                    <input type="datetime-local" class="admin-form-control" id="zoomScheduledTime" name="scheduledStartTime" style="border-radius: 8px; border: 1px solid #e2e8f0; padding: 10px 14px; transition: all 0.3s ease;">
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="mb-3">
                    <label for="zoomDuration" class="admin-form-label" style="font-weight: 500; color: #4a5568; margin-bottom: 8px;">
                      <i class="far fa-clock me-2" style="color: #2d5aa0;"></i>
                      Duration (minutes)
                    </label>
                    <input type="number" class="admin-form-control" id="zoomDuration" name="duration" value="60" min="15" max="300" style="border-radius: 8px; border: 1px solid #e2e8f0; padding: 10px 14px; transition: all 0.3s ease;">
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="mb-3">
                    <label for="zoomTimezone" class="admin-form-label" style="font-weight: 500; color: #4a5568; margin-bottom: 8px;">
                      <i class="fas fa-globe me-2" style="color: #2d5aa0;"></i>
                      Timezone
                    </label>
                    <select class="admin-form-control" id="zoomTimezone" name="timezone" style="border-radius: 8px; border: 1px solid #e2e8f0; padding: 10px 14px; transition: all 0.3s ease;">
                      <option value="UTC">UTC</option>
                      <option value="Africa/Cairo" selected>Cairo (EET)</option>
                      <option value="America/New_York">New York (EST)</option>
                      <option value="Europe/London">London (GMT)</option>
                    </select>
                  </div>
                </div>
              </div>

              <!-- Meeting Password -->
              <div class="row mb-3">
                <div class="col-md-6">
                  <div class="mb-3">
                    <label for="zoomPassword" class="admin-form-label" style="font-weight: 500; color: #4a5568; margin-bottom: 8px;">
                      <i class="fas fa-lock me-2" style="color: #2d5aa0;"></i>
                      Meeting Password (Optional)
                    </label>
                    <input type="text" class="admin-form-control" id="zoomPassword" name="password" placeholder="Leave empty for no password" style="border-radius: 8px; border: 1px solid #e2e8f0; padding: 10px 14px; transition: all 0.3s ease;">
                  </div>
                </div>
              </div>

              <!-- Meeting Settings - Compact Design -->
              <div class="zoom-settings-card" style="background: #f8f9fa; border-radius: 10px; padding: 12px; border: 1px solid #e2e8f0; margin-top: 16px;">
                <div class="d-flex align-items-center mb-2" style="border-bottom: 1.5px solid #e2e8f0; padding-bottom: 8px;">
                  <i class="fas fa-cog me-2" style="color: #2d5aa0; font-size: 13px;"></i>
                  <h6 class="mb-0" style="color: #2d3748; font-weight: 600; font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px;">
                    Meeting Settings
                  </h6>
                </div>
                <div class="zoom-settings-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 8px;">
                  <div class="zoom-setting-item" style="display: flex; align-items: center; padding: 8px; background: white; border-radius: 6px; border: 1px solid #e2e8f0; transition: all 0.2s ease; gap: 10px;">
                    <i class="fas fa-door-open" style="color: #718096; font-size: 10px; flex-shrink: 0;"></i>
                    <input class="form-check-input" type="checkbox" id="zoomJoinBeforeHost" name="joinBeforeHost" checked style="cursor: pointer; width: 36px; height: 18px; margin: 0; flex-shrink: 0;">
                    <label class="form-check-label" for="zoomJoinBeforeHost" style="font-size: 12px; color: #4a5568; font-weight: 500; cursor: pointer; margin: 0; line-height: 1.3; flex: 1; text-align: right;">
                      Allow join before host
                    </label>
                  </div>
                  <div class="zoom-setting-item" style="display: flex; align-items: center; padding: 8px; background: white; border-radius: 6px; border: 1px solid #e2e8f0; transition: all 0.2s ease; gap: 10px;">
                    <i class="fas fa-hourglass-half" style="color: #718096; font-size: 10px; flex-shrink: 0;"></i>
                    <input class="form-check-input" type="checkbox" id="zoomWaitingRoom" name="waitingRoom" style="cursor: pointer; width: 36px; height: 18px; margin: 0; flex-shrink: 0;">
                    <label class="form-check-label" for="zoomWaitingRoom" style="font-size: 12px; color: #4a5568; font-weight: 500; cursor: pointer; margin: 0; line-height: 1.3; flex: 1; text-align: right;">
                      Enable waiting room
                    </label>
                  </div>
                  <div class="zoom-setting-item" style="display: flex; align-items: center; padding: 8px; background: white; border-radius: 6px; border: 1px solid #e2e8f0; transition: all 0.2s ease; gap: 10px;">
                    <i class="fas fa-video" style="color: #718096; font-size: 10px; flex-shrink: 0;"></i>
                    <input class="form-check-input" type="checkbox" id="zoomHostVideo" name="hostVideo" checked style="cursor: pointer; width: 36px; height: 18px; margin: 0; flex-shrink: 0;">
                    <label class="form-check-label" for="zoomHostVideo" style="font-size: 12px; color: #4a5568; font-weight: 500; cursor: pointer; margin: 0; line-height: 1.3; flex: 1; text-align: right;">
                      Host video on
                    </label>
                  </div>
                  <div class="zoom-setting-item" style="display: flex; align-items: center; padding: 8px; background: white; border-radius: 6px; border: 1px solid #e2e8f0; transition: all 0.2s ease; gap: 10px;">
                    <i class="fas fa-users" style="color: #718096; font-size: 10px; flex-shrink: 0;"></i>
                    <input class="form-check-input" type="checkbox" id="zoomParticipantVideo" name="participantVideo" checked style="cursor: pointer; width: 36px; height: 18px; margin: 0; flex-shrink: 0;">
                    <label class="form-check-label" for="zoomParticipantVideo" style="font-size: 12px; color: #4a5568; font-weight: 500; cursor: pointer; margin: 0; line-height: 1.3; flex: 1; text-align: right;">
                      Participant video on
                    </label>
                  </div>
                  <div class="zoom-setting-item" style="display: flex; align-items: center; padding: 8px; background: white; border-radius: 6px; border: 1px solid #e2e8f0; transition: all 0.2s ease; gap: 10px;">
                    <i class="fas fa-microphone-slash" style="color: #718096; font-size: 10px; flex-shrink: 0;"></i>
                    <input class="form-check-input" type="checkbox" id="zoomMuteUponEntry" name="muteUponEntry" style="cursor: pointer; width: 36px; height: 18px; margin: 0; flex-shrink: 0;">
                    <label class="form-check-label" for="zoomMuteUponEntry" style="font-size: 12px; color: #4a5568; font-weight: 500; cursor: pointer; margin: 0; line-height: 1.3; flex: 1; text-align: right;">
                      Mute participants on entry
                    </label>
                  </div>
                  <div class="zoom-setting-item" style="display: flex; align-items: center; padding: 8px; background: white; border-radius: 6px; border: 1px solid #e2e8f0; transition: all 0.2s ease; gap: 10px;">
                    <i class="fas fa-record-vinyl" style="color: #718096; font-size: 10px; flex-shrink: 0;"></i>
                    <input class="form-check-input" type="checkbox" id="zoomEnableRecording" name="enableRecording" style="cursor: pointer; width: 36px; height: 18px; margin: 0; flex-shrink: 0;">
                    <label class="form-check-label" for="zoomEnableRecording" style="font-size: 12px; color: #4a5568; font-weight: 500; cursor: pointer; margin: 0; line-height: 1.3; flex: 1; text-align: right;">
                      Enable cloud recording
                    </label>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="modal-footer admin-modal-footer" style="display: flex; justify-content: flex-end; align-items: center; gap: 0.75rem;">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" style="min-width: 120px; padding: 0.75rem 1.5rem; font-weight: 500; border-radius: 8px; transition: all 0.3s ease;">
            <i class="fas fa-times me-2"></i>
            Cancel
          </button>
          <button type="submit" class="btn btn-primary admin-btn-primary" id="addContentSubmitBtn" style="min-width: 150px; padding: 0.75rem 1.75rem; font-weight: 600; border-radius: 8px; box-shadow: 0 4px 12px rgba(184, 1, 1, 0.3); transition: all 0.3s ease;">
            <i class="fas fa-plus me-2" id="addContentBtnIcon"></i>
            <span id="addContentBtnText">Add Content</span>
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Edit Content Modal -->
<div class="modal fade" id="editContentModal" tabindex="-1" aria-labelledby="editContentModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content admin-modal-content admin-modal-wide">
      <div class="modal-header admin-modal-header">
        <h5 class="modal-title" id="editContentModalLabel">
          <i class="fas fa-edit me-2"></i>
          Edit Content
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <form id="editContentForm" method="POST" action="">
        <div class="modal-body admin-modal-body">
          <div class="row">
            <div class="col-md-8">
              <div class="admin-form-section">
                <h6 class="admin-form-section-title">
                  <i class="fas fa-info-circle me-2"></i>
                  Content Information
                </h6>

                <div class="admin-form-group">
                  <label for="editContentType" class="admin-form-label">
                    <i class="fas fa-file me-2"></i>
                    Content Type
                  </label>
                  <select class="admin-form-control" id="editContentType" name="type" required>
                    <option value="">Select Type</option>
                    <option value="video">Video</option>
                    <option value="pdf">PDF Document</option>
                    <option value="homework">Homework</option>
                    <option value="quiz">Quiz</option>
                    <option value="zoom">Zoom Live Session</option>
                    <option value="link">External Link</option>
                  </select>
                </div>

                <div class="admin-form-group">
                  <label for="editContentTitle" class="admin-form-label">
                    <i class="fas fa-heading me-2"></i>
                    Content Title
                  </label>
                  <input type="text" class="admin-form-control" id="editContentTitle" name="title" required>
                </div>

                <div class="admin-form-group">
                  <label for="editContentDescription" class="admin-form-label">
                    <i class="fas fa-align-left me-2"></i>
                    Description
                  </label>
                  <textarea class="admin-form-control" id="editContentDescription" name="description" rows="2"></textarea>
                </div>

                <div class="admin-form-group" id="editContentUrlSection">
                  <label for="editContentUrl" class="admin-form-label">
                    <i class="fas fa-link me-2"></i>
                    Content URL/File
                  </label>
                  <input type="text" class="admin-form-control" id="editContentUrl" name="content" required>
                  <small class="admin-form-text">Enter URL or upload file using the upload section below</small>
                  <div class="invalid-feedback" id="editContentUrlError"></div>
                </div>

                <!-- File Upload Section -->
                <div class="admin-form-group" id="editFileUploadSection" style="display: none;">
                  <label class="admin-form-label">
                    <i class="fas fa-cloud-upload-alt me-2"></i>
                    Upload New File
                  </label>
                  <div class="upload-section">
                    <input type="file" id="editContentFile" class="upload-input" accept=".pdf,application/pdf">
                    <label for="editContentFile" class="upload-label">
                      <i class="fas fa-file-pdf"></i>
                      Choose PDF File
                    </label>
                    <div id="editContentFilePreview" class="upload-preview">
                      <div class="preview-overlay">
                        <i class="fas fa-file-pdf"></i>
                        <p>Click or drag to upload PDF</p>
                        <small id="editCurrentFileText">PDF files only (max 50MB)</small>
                      </div>
                    </div>
                    <div id="editContentFileProgress" class="progress-container" style="display: none;"></div>
                  </div>
                  <input type="hidden" name="uploadedFileUrl" id="editUploadedFileUrl">
                </div>
              </div>
            </div>

            <div class="col-md-4">
              <div class="admin-form-section">
                <h6 class="admin-form-section-title">
                  <i class="fas fa-cog me-2"></i>
                  Content Settings
                </h6>

                <div class="admin-form-group">
                  <label for="editContentDuration" class="admin-form-label">
                    <i class="fas fa-clock me-2"></i>
                    Duration (minutes)
                  </label>
                  <input type="number" class="admin-form-control" id="editContentDuration" name="duration" min="0">
                </div>

                <div class="admin-form-group">
                  <label for="editContentOrder" class="admin-form-label">
                    <i class="fas fa-sort-numeric-up me-2"></i>
                    Order
                  </label>
                  <input type="number" class="admin-form-control" id="editContentOrder" name="order" min="1">
                </div>

                <div class="admin-form-group">
                  <label for="editContentDifficulty" class="admin-form-label">
                    <i class="fas fa-signal me-2"></i>
                    Difficulty Level
                  </label>
                  <select class="admin-form-control" id="editContentDifficulty" name="difficulty">
                    <option value="beginner">Beginner</option>
                    <option value="intermediate">Intermediate</option>
                    <option value="advanced">Advanced</option>
                  </select>
                </div>

                <!-- Video Watch Limit Section (Only for Video Content) -->
                <div class="admin-form-group" id="editVideoWatchLimitSection" style="display: none;">
                  <label for="editMaxWatchCount" class="admin-form-label">
                    <i class="fas fa-eye me-2"></i>
                    Max Watch Count
                  </label>
                  <input type="number" class="admin-form-control" id="editMaxWatchCount" name="maxWatchCount" min="-1" placeholder="Enter number or -1 for unlimited">
                  <small class="admin-form-text">Number of times students can complete watching this video (enter -1 for unlimited, or leave empty to keep current value)</small>
                </div>

                <div class="admin-form-group">
                  <div class="admin-form-check">
                    <input type="checkbox" class="admin-form-check-input" id="editIsRequired" name="isRequired" checked>
                    <label class="admin-form-check-label" for="editIsRequired">
                      Required content
                    </label>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Content Prerequisites Section -->
          <div class="row mt-4">
            <div class="col-12">
              <div class="admin-form-section">
                <h6 class="admin-form-section-title">
                  <i class="fas fa-link me-2"></i>
                  Content Prerequisites
                </h6>

                <div class="admin-form-group">
                  <label for="editContentPrerequisites" class="admin-form-label">
                    <i class="fas fa-list-check me-2"></i>
                    Required Previous Content
                  </label>
                  <select class="admin-form-control" id="editContentPrerequisites" name="prerequisites">
                    <option value="">No prerequisite (start immediately)</option>
                    <% if (allContentItems && allContentItems.length > 0) { %>
                    <% allContentItems.forEach((contentItem, index) => { %>
                    <option value="<%= contentItem._id %>">
                      Topic <%= contentItem.topicOrder %>: <%= contentItem.topicTitle %> - <%= contentItem.title %> (<%= contentItem.type %>)
                    </option>
                    <% }); %>
                    <% } else { %>
                    <option disabled>No content items available yet</option>
                    <% } %>
                  </select>
                  <small class="admin-form-text">Select one content item that must be completed first</small>
                </div>
              </div>
            </div>
          </div>

          <!-- Quiz Content Section - Full Editing with Multiple Banks -->
          <div class="row mt-4" id="editQuizContentSection" style="display: none;">
            <div class="col-12">
              <div class="admin-form-section">
                <h6 class="admin-form-section-title">
                  <i class="fas fa-clipboard-question me-2"></i>
                  Quiz Configuration
                </h6>

                <!-- Quiz Progress Steps -->
                <div class="quiz-progress-steps mb-2">
                  <div class="d-flex justify-content-between align-items-center">
                    <div class="quiz-step active" data-step="1">
                      <span class="step-number">1</span>
                      <span class="quiz-step-label">Bank</span>
                    </div>
                    <div class="progress-line"></div>
                    <div class="quiz-step" data-step="2">
                      <span class="step-number">2</span>
                      <span class="quiz-step-label">Questions</span>
                    </div>
                    <div class="progress-line"></div>
                    <div class="quiz-step" data-step="3">
                      <span class="step-number">3</span>
                      <span class="quiz-step-label">Settings</span>
                    </div>
                  </div>
                </div>

                <!-- Step 1: Question Bank Selection -->
                <div class="quiz-step-content" id="editQuizStep1">
                  <div class="admin-form-group">
                    <label class="admin-form-label">
                      <i class="fas fa-database me-2"></i>
                      Select Question Banks * <span id="editQuizSelectedBanksCount" class="text-muted">(0 selected)</span>
                    </label>
                    <div class="bank-cards-grid" id="editQuizQuestionBanksGrid">
                      <!-- Question banks will be loaded here -->
                    </div>
                    <div id="editNoQuizQuestionBanksMessage" class="text-center py-4" style="display: none;">
                      <i class="fas fa-database fa-2x text-muted mb-2"></i>
                      <p class="text-muted mb-0">No Question Banks Available</p>
                      <small class="text-muted">Create question banks first to add quiz content.</small>
                    </div>
                  </div>
                </div>

                <!-- Step 2: Question Selection -->
                <div class="quiz-step-content" id="editQuizStep2" style="display: none;">
                  <!-- Bank Filter Section -->
                  <div class="question-bank-filter-section">
                    <div class="filter-section-header">
                      <i class="fas fa-database"></i>
                      <span>Filter by Question Bank</span>
                    </div>
                    <div class="bank-filter-buttons" id="editQuizBankFilterButtons">
                      <button type="button" class="bank-filter-btn active" data-bank-id="all" onclick="filterEditQuizByBank('all')">
                        <i class="fas fa-th"></i>
                        All Banks
                      </button>
                      <!-- Bank filter buttons will be dynamically added here -->
                    </div>
                  </div>

                  <!-- Question Filters Section -->
                  <div class="question-filters-section">
                    <div class="filters-row">
                      <div class="filter-item">
                        <label class="filter-label">
                          <i class="fas fa-signal"></i>
                          Difficulty
                        </label>
                        <select class="filter-select" id="editQuizDifficultyFilter" onchange="filterEditQuizQuestions()">
                          <option value="">All Difficulties</option>
                          <option value="easy">Easy</option>
                          <option value="medium">Medium</option>
                          <option value="hard">Hard</option>
                        </select>
                      </div>

                      <div class="filter-item">
                        <label class="filter-label">
                          <i class="fas fa-tag"></i>
                          Type
                        </label>
                        <select class="filter-select" id="editQuizTypeFilter" onchange="filterEditQuizQuestions()">
                          <option value="">All Types</option>
                          <option value="MCQ">Multiple Choice</option>
                          <option value="True/False">True/False</option>
                          <option value="Written">Written</option>
                        </select>
                      </div>

                      <div class="filter-item">
                        <label class="filter-label">
                          <i class="fas fa-tags"></i>
                          Tags
                        </label>
                        <select class="filter-select" id="editQuizTagsFilter" onchange="filterEditQuizQuestions()">
                          <option value="">All Tags</option>
                          <!-- Tags will be populated dynamically -->
                        </select>
                      </div>

                      <div class="filter-item filter-search">
                        <label class="filter-label">
                          <i class="fas fa-search"></i>
                          Search
                        </label>
                        <input type="text" class="filter-search-input" id="editQuizSearchFilter" placeholder="Search questions..." onkeyup="filterEditQuizQuestions()">
                      </div>
                    </div>
                  </div>

                  <!-- Quick Selection Tools -->
                  <div class="quick-selection-tools">
                    <div class="selection-tools-left">
                      <input type="text" class="range-input" id="editQuizRangeInput" placeholder="Range: 1-5, 8, 10-12">
                      <button type="button" class="tool-btn" onclick="selectEditQuizRange()">
                        <i class="fas fa-list-ol"></i>
                        Select Range
                      </button>
                    </div>
                    <div class="selection-tools-right">
                      <button type="button" class="tool-btn" onclick="selectAllEditQuizQuestions()">
                        <i class="fas fa-check-double"></i>
                        Select All
                      </button>
                      <button type="button" class="tool-btn" onclick="clearEditQuizSelection()">
                        <i class="fas fa-times"></i>
                        Clear
                      </button>
                      <button type="button" class="tool-btn" onclick="selectEvenEditQuizQuestions()">
                        <i class="fas fa-sort-numeric-down"></i>
                        Even
                      </button>
                      <button type="button" class="tool-btn" onclick="selectOddEditQuizQuestions()">
                        <i class="fas fa-sort-numeric-up"></i>
                        Odd
                      </button>
                      <button type="button" class="tool-btn" onclick="selectRandomEditQuizQuestions()">
                        <i class="fas fa-random"></i>
                        Random 30%
                      </button>
                    </div>
                  </div>

                  <!-- Questions List Container -->
                  <div class="questions-list-container">
                    <div class="questions-list" id="editQuizQuestionsGrid">
                      <!-- Questions will be loaded here -->
                    </div>
                    <div id="editNoQuizQuestionsMessage" class="no-questions-message">
                      <i class="fas fa-question-circle"></i>
                      <p>No Questions Loaded</p>
                      <small>Please select question banks in Step 1 to load questions.</small>
                    </div>
                  </div>

                  <!-- Selection Summary -->
                  <div class="selection-summary-container">
                    <div class="selection-summary" id="editQuizSelectionSummary">
                      <div class="summary-item">
                        <span class="summary-label">Selected Questions:</span>
                        <span class="summary-value" id="editQuizSelectedCount">0</span>
                      </div>
                      <div class="summary-item">
                        <span class="summary-label">Total Points:</span>
                        <span class="summary-value" id="editQuizTotalPoints">0</span>
                      </div>
                      <div class="summary-item">
                        <span class="summary-label">Difficulty Distribution:</span>
                        <div class="difficulty-distribution" id="editQuizDifficultyDistribution">
                          <div class="difficulty-item">
                            <span class="badge bg-success">Easy: <span id="editQuizEasyCount">0</span></span>
                          </div>
                          <div class="difficulty-item">
                            <span class="badge bg-warning">Medium: <span id="editQuizMediumCount">0</span></span>
                          </div>
                          <div class="difficulty-item">
                            <span class="badge bg-danger">Hard: <span id="editQuizHardCount">0</span></span>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Step 3: Quiz Settings -->
                <div class="quiz-step-content" id="editQuizStep3" style="display: none;">
                  <div class="row">
                    <div class="col-md-6">
                      <div class="admin-form-group">
                        <label for="editQuizDuration" class="admin-form-label">
                          <i class="fas fa-clock me-2"></i>
                          Duration (minutes)
                        </label>
                        <input type="number" class="admin-form-control" id="editQuizDuration" name="quizDuration" value="30" min="1" max="300">
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="admin-form-group">
                        <label for="editQuizPassingScore" class="admin-form-label">
                          <i class="fas fa-percentage me-2"></i>
                          Passing Score (%)
                        </label>
                        <input type="number" class="admin-form-control" id="editQuizPassingScore" name="quizPassingScore" value="50" min="0" max="100">
                      </div>
                    </div>
                  </div>
                  <div class="row">
                    <div class="col-md-6">
                      <div class="admin-form-group">
                        <label for="editQuizMaxAttempts" class="admin-form-label">
                          <i class="fas fa-redo me-2"></i>
                          Max Attempts
                        </label>
                        <input type="number" class="admin-form-control" id="editQuizMaxAttempts" name="quizMaxAttempts" value="3" min="1" max="10">
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="admin-form-group">
                        <label class="admin-form-label">
                          <i class="fas fa-toggle-on me-2"></i>
                          Quiz Options
                        </label>
                        <div class="admin-form-check">
                          <input class="admin-form-check-input" type="checkbox" id="editQuizShuffleQuestions" name="quizShuffleQuestions">
                          <label class="admin-form-check-label" for="editQuizShuffleQuestions">Shuffle Questions</label>
                        </div>
                        <div class="admin-form-check">
                          <input class="admin-form-check-input" type="checkbox" id="editQuizShuffleOptions" name="quizShuffleOptions">
                          <label class="admin-form-check-label" for="editQuizShuffleOptions">Shuffle Options</label>
                        </div>
                        <div class="admin-form-check">
                          <input class="admin-form-check-input" type="checkbox" id="editQuizShowCorrectAnswers" name="quizShowCorrectAnswers" checked>
                          <label class="admin-form-check-label" for="editQuizShowCorrectAnswers">Show Correct Answers</label>
                        </div>
                        <div class="admin-form-check">
                          <input class="admin-form-check-input" type="checkbox" id="editQuizShowResults" name="quizShowResults" checked>
                          <label class="admin-form-check-label" for="editQuizShowResults">Show Results</label>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="admin-form-group">
                    <label for="editQuizInstructions" class="admin-form-label">
                      <i class="fas fa-info-circle me-2"></i>
                      Instructions
                    </label>
                    <textarea class="admin-form-control" id="editQuizInstructions" name="quizInstructions" rows="3" placeholder="Enter quiz instructions for students..."></textarea>
                  </div>
                </div>

                <!-- Quiz Navigation -->
                <div class="quiz-navigation mt-4">
                  <div class="d-flex justify-content-between">
                    <button type="button" class="btn btn-outline-secondary" id="editQuizPrevBtn" onclick="prevEditQuizStep()" disabled>
                      <i class="fas fa-arrow-left me-1"></i> Previous
                    </button>
                    <div class="quiz-step-indicator">
                      Step <span id="editQuizCurrentStepNumber">1</span> of 3
                    </div>
                    <button type="button" class="btn btn-primary" id="editQuizNextBtn" onclick="nextEditQuizStep()">
                      Next <i class="fas fa-arrow-right ms-1"></i>
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Homework Content Section - Full Editing with Multiple Banks -->
          <div class="row mt-4" id="editHomeworkContentSection" style="display: none;">
            <div class="col-12">
              <div class="admin-form-section">
                <h6 class="admin-form-section-title">
                  <i class="fas fa-tasks me-2"></i>
                  Homework Configuration
                </h6>

                <!-- Homework Progress Steps -->
                <div class="homework-progress-steps mb-2">
                  <div class="d-flex justify-content-between align-items-center">
                    <div class="homework-step active" data-step="1">
                      <span class="step-number">1</span>
                      <span class="homework-step-label">Bank</span>
                    </div>
                    <div class="progress-line"></div>
                    <div class="homework-step" data-step="2">
                      <span class="step-number">2</span>
                      <span class="homework-step-label">Questions</span>
                    </div>
                    <div class="progress-line"></div>
                    <div class="homework-step" data-step="3">
                      <span class="step-number">3</span>
                      <span class="homework-step-label">Settings</span>
                    </div>
                  </div>
                </div>

                <!-- Step 1: Question Bank Selection -->
                <div class="homework-step-content" id="editHomeworkStep1">
                  <div class="admin-form-group">
                    <label class="admin-form-label">
                      <i class="fas fa-database me-2"></i>
                      Select Question Banks * <span id="editHomeworkSelectedBanksCount" class="text-muted">(0 selected)</span>
                    </label>
                    <div class="bank-cards-grid" id="editHomeworkQuestionBanksGrid">
                      <!-- Question banks will be loaded here -->
                    </div>
                    <div id="editNoHomeworkQuestionBanksMessage" class="text-center py-4" style="display: none;">
                      <i class="fas fa-database fa-2x text-muted mb-2"></i>
                      <p class="text-muted mb-0">No Question Banks Available</p>
                      <small class="text-muted">Create question banks first to add homework content.</small>
                    </div>
                  </div>
                </div>

                <!-- Step 2: Question Selection -->
                <div class="homework-step-content" id="editHomeworkStep2" style="display: none;">
                  <!-- Bank Filter Section -->
                  <div class="question-bank-filter-section">
                    <div class="filter-section-header">
                      <i class="fas fa-database"></i>
                      <span>Filter by Question Bank</span>
                    </div>
                    <div class="bank-filter-buttons" id="editHomeworkBankFilterButtons">
                      <button type="button" class="bank-filter-btn active" data-bank-id="all" onclick="filterEditHomeworkByBank('all')">
                        <i class="fas fa-th"></i>
                        All Banks
                      </button>
                      <!-- Bank filter buttons will be dynamically added here -->
                    </div>
                  </div>

                  <!-- Question Filters Section -->
                  <div class="question-filters-section">
                    <div class="filters-row">
                      <div class="filter-item">
                        <label class="filter-label">
                          <i class="fas fa-signal"></i>
                          Difficulty
                        </label>
                        <select class="filter-select" id="editHomeworkDifficultyFilter" onchange="filterEditHomeworkQuestions()">
                          <option value="">All Difficulties</option>
                          <option value="easy">Easy</option>
                          <option value="medium">Medium</option>
                          <option value="hard">Hard</option>
                        </select>
                      </div>

                      <div class="filter-item">
                        <label class="filter-label">
                          <i class="fas fa-tag"></i>
                          Type
                        </label>
                        <select class="filter-select" id="editHomeworkTypeFilter" onchange="filterEditHomeworkQuestions()">
                          <option value="">All Types</option>
                          <option value="MCQ">Multiple Choice</option>
                          <option value="True/False">True/False</option>
                          <option value="Written">Written</option>
                        </select>
                      </div>

                      <div class="filter-item">
                        <label class="filter-label">
                          <i class="fas fa-tags"></i>
                          Tags
                        </label>
                        <select class="filter-select" id="editHomeworkTagsFilter" onchange="filterEditHomeworkQuestions()">
                          <option value="">All Tags</option>
                          <!-- Tags will be populated dynamically -->
                        </select>
                      </div>

                      <div class="filter-item filter-search">
                        <label class="filter-label">
                          <i class="fas fa-search"></i>
                          Search
                        </label>
                        <input type="text" class="filter-search-input" id="editHomeworkSearchFilter" placeholder="Search questions..." onkeyup="filterEditHomeworkQuestions()">
                      </div>
                    </div>
                  </div>

                  <!-- Quick Selection Tools -->
                  <div class="quick-selection-tools">
                    <div class="selection-tools-left">
                      <input type="text" class="range-input" id="editHomeworkRangeInput" placeholder="Range: 1-5, 8, 10-12">
                      <button type="button" class="tool-btn" onclick="selectEditHomeworkRange()">
                        <i class="fas fa-list-ol"></i>
                        Select Range
                      </button>
                    </div>
                    <div class="selection-tools-right">
                      <button type="button" class="tool-btn" onclick="selectAllEditHomeworkQuestions()">
                        <i class="fas fa-check-double"></i>
                        Select All
                      </button>
                      <button type="button" class="tool-btn" onclick="clearEditHomeworkSelection()">
                        <i class="fas fa-times"></i>
                        Clear
                      </button>
                      <button type="button" class="tool-btn" onclick="selectEvenEditHomeworkQuestions()">
                        <i class="fas fa-sort-numeric-down"></i>
                        Even
                      </button>
                      <button type="button" class="tool-btn" onclick="selectOddEditHomeworkQuestions()">
                        <i class="fas fa-sort-numeric-up"></i>
                        Odd
                      </button>
                      <button type="button" class="tool-btn" onclick="selectRandomEditHomeworkQuestions()">
                        <i class="fas fa-random"></i>
                        Random 30%
                      </button>
                    </div>
                  </div>

                  <!-- Questions List Container -->
                  <div class="questions-list-container">
                    <div class="questions-list" id="editHomeworkQuestionsGrid">
                      <!-- Questions will be loaded here -->
                    </div>
                    <div id="editNoHomeworkQuestionsMessage" class="no-questions-message">
                      <i class="fas fa-question-circle"></i>
                      <p>No Questions Loaded</p>
                      <small>Please select question banks in Step 1 to load questions.</small>
                    </div>
                  </div>

                  <!-- Selection Summary -->
                  <div class="selection-summary-container">
                    <div class="selection-summary" id="editHomeworkSelectionSummary">
                      <div class="summary-item">
                        <span class="summary-label">Selected Questions:</span>
                        <span class="summary-value" id="editHomeworkSelectedCount">0</span>
                      </div>
                      <div class="summary-item">
                        <span class="summary-label">Total Points:</span>
                        <span class="summary-value" id="editHomeworkTotalPoints">0</span>
                      </div>
                      <div class="summary-item">
                        <span class="summary-label">Difficulty Distribution:</span>
                        <div class="difficulty-distribution" id="editHomeworkDifficultyDistribution">
                          <div class="difficulty-item">
                            <span class="badge bg-success">Easy: <span id="editHomeworkEasyCount">0</span></span>
                          </div>
                          <div class="difficulty-item">
                            <span class="badge bg-warning">Medium: <span id="editHomeworkMediumCount">0</span></span>
                          </div>
                          <div class="difficulty-item">
                            <span class="badge bg-danger">Hard: <span id="editHomeworkHardCount">0</span></span>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Step 3: Homework Settings -->
                <div class="homework-step-content" id="editHomeworkStep3" style="display: none;">
                  <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    Homework has no time limit and uses pass/fail grading only.
                  </div>
                  <div class="row">
                    <div class="col-md-6">
                      <div class="admin-form-group">
                        <label for="editHomeworkPassingScore" class="admin-form-label">
                          <i class="fas fa-percentage me-2"></i>
                          Passing Score (%)
                        </label>
                        <input type="number" class="admin-form-control" id="editHomeworkPassingScore" name="homeworkPassingScore" value="0" min="0" max="100">
                        <small class="admin-form-text">Set to 0% to allow students to pass by simply submitting (no minimum score required)</small>
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="admin-form-group">
                        <label for="editHomeworkMaxAttempts" class="admin-form-label">
                          <i class="fas fa-redo me-2"></i>
                          Max Attempts
                        </label>
                        <input type="number" class="admin-form-control" id="editHomeworkMaxAttempts" name="homeworkMaxAttempts" value="1" min="1" max="5">
                      </div>
                    </div>
                  </div>
                  <div class="admin-form-group">
                    <label class="admin-form-label">
                      <i class="fas fa-toggle-on me-2"></i>
                      Homework Options
                    </label>
                    <div class="admin-form-check">
                      <input class="admin-form-check-input" type="checkbox" id="editHomeworkShuffleQuestions" name="homeworkShuffleQuestions">
                      <label class="admin-form-check-label" for="editHomeworkShuffleQuestions">Shuffle Questions</label>
                    </div>
                    <div class="admin-form-check">
                      <input class="admin-form-check-input" type="checkbox" id="editHomeworkShuffleOptions" name="homeworkShuffleOptions">
                      <label class="admin-form-check-label" for="editHomeworkShuffleOptions">Shuffle Options</label>
                    </div>
                    <div class="admin-form-check">
                      <input class="admin-form-check-input" type="checkbox" id="editHomeworkShowCorrectAnswers" name="homeworkShowCorrectAnswers">
                      <label class="admin-form-check-label" for="editHomeworkShowCorrectAnswers">Show Correct Answers After Submission</label>
                    </div>
                  </div>
                  <div class="admin-form-group">
                    <label for="editHomeworkInstructions" class="admin-form-label">
                      <i class="fas fa-info-circle me-2"></i>
                      Instructions
                    </label>
                    <textarea class="admin-form-control" id="editHomeworkInstructions" name="homeworkInstructions" rows="3" placeholder="Enter homework instructions for students..."></textarea>
                  </div>
                </div>

                <!-- Homework Navigation -->
                <div class="homework-navigation mt-4">
                  <div class="d-flex justify-content-between">
                    <button type="button" class="btn btn-outline-secondary" id="editHomeworkPrevBtn" onclick="prevEditHomeworkStep()" disabled>
                      <i class="fas fa-arrow-left me-1"></i> Previous
                    </button>
                    <div class="homework-step-indicator">
                      Step <span id="editHomeworkCurrentStepNumber">1</span> of 3
                    </div>
                    <button type="button" class="btn btn-success" id="editHomeworkNextBtn" onclick="nextEditHomeworkStep()">
                      Next <i class="fas fa-arrow-right ms-1"></i>
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Content Tags Section -->
          <div class="row mt-3">
            <div class="col-12">
              <div class="admin-form-section">
                <h6 class="admin-form-section-title">
                  <i class="fas fa-tags me-2"></i>
                  Content Tags
                </h6>

                <div class="admin-form-group">
                  <label for="editContentTags" class="admin-form-label">
                    <i class="fas fa-hashtag me-2"></i>
                    Content Tags
                  </label>
                  <input type="text" class="admin-form-control" id="editContentTags" name="tags" placeholder="Enter tags separated by commas">
                  <small class="admin-form-text">Example: video, tutorial, introduction</small>
                </div>
              </div>
            </div>
          </div>

          <!-- Zoom Meeting Content Section -->
          <div class="row mt-4" id="editZoomContentSection" style="display: none;">
            <div class="col-12">
              <div class="zoom-config-header mb-4">
                <h5 class="mb-2" style="color: #2d3748; font-weight: 600; display: flex; align-items: center;">
                  <i class="fas fa-video me-2" style="color: #2d5aa0;"></i>
                  Zoom Live Session Configuration
                </h5>
                <div class="alert alert-info mb-0" style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); border: 1px solid #90caf9; border-radius: 8px; padding: 12px 16px;">
                  <i class="fas fa-info-circle me-2" style="color: #1976d2;"></i>
                  <small style="color: #1565c0; font-weight: 500;">Edit the live Zoom session. The meeting will be locked until you start it from the admin panel.</small>
                </div>
              </div>

              <!-- Meeting Basic Info -->
              <div class="row g-3 mb-3">
                <div class="col-md-6">
                  <div class="mb-3">
                    <label for="editZoomMeetingName" class="admin-form-label" style="font-weight: 500; color: #4a5568; margin-bottom: 8px;">
                      <i class="fas fa-signature me-2" style="color: #2d5aa0;"></i>
                      Meeting Name
                    </label>
                    <input type="text" class="admin-form-control" id="editZoomMeetingName" name="zoomMeetingName" placeholder="e.g., Week 1 Live Q&A Session" style="border-radius: 8px; border: 1px solid #e2e8f0; padding: 10px 14px; transition: all 0.3s ease;">
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="mb-3">
                    <label for="editZoomMeetingTopic" class="admin-form-label" style="font-weight: 500; color: #4a5568; margin-bottom: 8px;">
                      <i class="fas fa-comment-dots me-2" style="color: #2d5aa0;"></i>
                      Meeting Topic
                    </label>
                    <input type="text" class="admin-form-control" id="editZoomMeetingTopic" name="zoomMeetingTopic" placeholder="What will be discussed?" style="border-radius: 8px; border: 1px solid #e2e8f0; padding: 10px 14px; transition: all 0.3s ease;">
                  </div>
                </div>
              </div>

              <!-- Scheduling -->
              <div class="row g-3 mb-3">
                <div class="col-md-6">
                  <div class="mb-3">
                    <label for="editZoomScheduledTime" class="admin-form-label" style="font-weight: 500; color: #4a5568; margin-bottom: 8px;">
                      <i class="far fa-calendar-alt me-2" style="color: #2d5aa0;"></i>
                      Scheduled Start Time
                    </label>
                    <input type="datetime-local" class="admin-form-control" id="editZoomScheduledTime" name="scheduledStartTime" style="border-radius: 8px; border: 1px solid #e2e8f0; padding: 10px 14px; transition: all 0.3s ease;">
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="mb-3">
                    <label for="editZoomDuration" class="admin-form-label" style="font-weight: 500; color: #4a5568; margin-bottom: 8px;">
                      <i class="far fa-clock me-2" style="color: #2d5aa0;"></i>
                      Duration (minutes)
                    </label>
                    <input type="number" class="admin-form-control" id="editZoomDuration" name="duration" value="60" min="15" max="300" style="border-radius: 8px; border: 1px solid #e2e8f0; padding: 10px 14px; transition: all 0.3s ease;">
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="mb-3">
                    <label for="editZoomTimezone" class="admin-form-label" style="font-weight: 500; color: #4a5568; margin-bottom: 8px;">
                      <i class="fas fa-globe me-2" style="color: #2d5aa0;"></i>
                      Timezone
                    </label>
                    <select class="admin-form-control" id="editZoomTimezone" name="timezone" style="border-radius: 8px; border: 1px solid #e2e8f0; padding: 10px 14px; transition: all 0.3s ease;">
                      <option value="UTC">UTC</option>
                      <option value="Africa/Cairo" selected>Cairo (EET)</option>
                      <option value="America/New_York">New York (EST)</option>
                      <option value="Europe/London">London (GMT)</option>
                    </select>
                  </div>
                </div>
              </div>

              <!-- Meeting Password -->
              <div class="row mb-3">
                <div class="col-md-6">
                  <div class="mb-3">
                    <label for="editZoomPassword" class="admin-form-label" style="font-weight: 500; color: #4a5568; margin-bottom: 8px;">
                      <i class="fas fa-lock me-2" style="color: #2d5aa0;"></i>
                      Meeting Password (Optional)
                    </label>
                    <input type="text" class="admin-form-control" id="editZoomPassword" name="password" placeholder="Leave empty for no password" style="border-radius: 8px; border: 1px solid #e2e8f0; padding: 10px 14px; transition: all 0.3s ease;">
                  </div>
                </div>
              </div>

              <!-- Meeting Settings - Compact Design -->
              <div class="zoom-settings-card" style="background: #f8f9fa; border-radius: 10px; padding: 12px; border: 1px solid #e2e8f0; margin-top: 16px;">
                <div class="d-flex align-items-center mb-2" style="border-bottom: 1.5px solid #e2e8f0; padding-bottom: 8px;">
                  <i class="fas fa-cog me-2" style="color: #2d5aa0; font-size: 13px;"></i>
                  <h6 class="mb-0" style="color: #2d3748; font-weight: 600; font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px;">
                    Meeting Settings
                  </h6>
                </div>
                <div class="zoom-settings-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 8px;">
                  <div class="zoom-setting-item" style="display: flex; align-items: center; padding: 8px; background: white; border-radius: 6px; border: 1px solid #e2e8f0; transition: all 0.2s ease; gap: 10px;">
                    <i class="fas fa-door-open" style="color: #718096; font-size: 10px; flex-shrink: 0;"></i>
                    <input class="form-check-input" type="checkbox" id="editZoomJoinBeforeHost" name="joinBeforeHost" checked style="cursor: pointer; width: 36px; height: 18px; margin: 0; flex-shrink: 0;">
                    <label class="form-check-label" for="editZoomJoinBeforeHost" style="font-size: 12px; color: #4a5568; font-weight: 500; cursor: pointer; margin: 0; line-height: 1.3; flex: 1; text-align: right;">
                      Allow join before host
                    </label>
                  </div>
                  <div class="zoom-setting-item" style="display: flex; align-items: center; padding: 8px; background: white; border-radius: 6px; border: 1px solid #e2e8f0; transition: all 0.2s ease; gap: 10px;">
                    <i class="fas fa-hourglass-half" style="color: #718096; font-size: 10px; flex-shrink: 0;"></i>
                    <input class="form-check-input" type="checkbox" id="editZoomWaitingRoom" name="waitingRoom" style="cursor: pointer; width: 36px; height: 18px; margin: 0; flex-shrink: 0;">
                    <label class="form-check-label" for="editZoomWaitingRoom" style="font-size: 12px; color: #4a5568; font-weight: 500; cursor: pointer; margin: 0; line-height: 1.3; flex: 1; text-align: right;">
                      Enable waiting room
                    </label>
                  </div>
                  <div class="zoom-setting-item" style="display: flex; align-items: center; padding: 8px; background: white; border-radius: 6px; border: 1px solid #e2e8f0; transition: all 0.2s ease; gap: 10px;">
                    <i class="fas fa-video" style="color: #718096; font-size: 10px; flex-shrink: 0;"></i>
                    <input class="form-check-input" type="checkbox" id="editZoomHostVideo" name="hostVideo" checked style="cursor: pointer; width: 36px; height: 18px; margin: 0; flex-shrink: 0;">
                    <label class="form-check-label" for="editZoomHostVideo" style="font-size: 12px; color: #4a5568; font-weight: 500; cursor: pointer; margin: 0; line-height: 1.3; flex: 1; text-align: right;">
                      Host video on
                    </label>
                  </div>
                  <div class="zoom-setting-item" style="display: flex; align-items: center; padding: 8px; background: white; border-radius: 6px; border: 1px solid #e2e8f0; transition: all 0.2s ease; gap: 10px;">
                    <i class="fas fa-users" style="color: #718096; font-size: 10px; flex-shrink: 0;"></i>
                    <input class="form-check-input" type="checkbox" id="editZoomParticipantVideo" name="participantVideo" checked style="cursor: pointer; width: 36px; height: 18px; margin: 0; flex-shrink: 0;">
                    <label class="form-check-label" for="editZoomParticipantVideo" style="font-size: 12px; color: #4a5568; font-weight: 500; cursor: pointer; margin: 0; line-height: 1.3; flex: 1; text-align: right;">
                      Participant video on
                    </label>
                  </div>
                  <div class="zoom-setting-item" style="display: flex; align-items: center; padding: 8px; background: white; border-radius: 6px; border: 1px solid #e2e8f0; transition: all 0.2s ease; gap: 10px;">
                    <i class="fas fa-microphone-slash" style="color: #718096; font-size: 10px; flex-shrink: 0;"></i>
                    <input class="form-check-input" type="checkbox" id="editZoomMuteUponEntry" name="muteUponEntry" style="cursor: pointer; width: 36px; height: 18px; margin: 0; flex-shrink: 0;">
                    <label class="form-check-label" for="editZoomMuteUponEntry" style="font-size: 12px; color: #4a5568; font-weight: 500; cursor: pointer; margin: 0; line-height: 1.3; flex: 1; text-align: right;">
                      Mute participants on entry
                    </label>
                  </div>
                  <div class="zoom-setting-item" style="display: flex; align-items: center; padding: 8px; background: white; border-radius: 6px; border: 1px solid #e2e8f0; transition: all 0.2s ease; gap: 10px;">
                    <i class="fas fa-record-vinyl" style="color: #718096; font-size: 10px; flex-shrink: 0;"></i>
                    <input class="form-check-input" type="checkbox" id="editZoomEnableRecording" name="enableRecording" style="cursor: pointer; width: 36px; height: 18px; margin: 0; flex-shrink: 0;">
                    <label class="form-check-label" for="editZoomEnableRecording" style="font-size: 12px; color: #4a5568; font-weight: 500; cursor: pointer; margin: 0; line-height: 1.3; flex: 1; text-align: right;">
                      Enable cloud recording
                    </label>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="modal-footer admin-modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary admin-btn-primary" id="editContentSubmitBtn">
            <i class="fas fa-save me-2" id="editContentBtnIcon"></i>
            <span id="editContentBtnText">Update Content</span>
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Question Preview Modal -->
<div class="modal fade" id="questionPreviewModal" tabindex="-1" aria-labelledby="questionPreviewModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="questionPreviewModalLabel">
          <i class="fas fa-eye me-2"></i>
          Question Preview
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="questionPreviewBody">
        <!-- Question preview content will be loaded here -->
      </div>
    </div>
  </div>
</div>

<!-- Edit Course Modal -->
<div class="modal fade" id="editCourseModal" tabindex="-1" aria-labelledby="editCourseModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content admin-modal-content admin-modal-wide">
      <div class="modal-header admin-modal-header">
        <h5 class="modal-title" id="editCourseModalLabel">
          <i class="fas fa-edit me-2"></i>
          Edit Course
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <form id="editCourseForm" method="POST" action="">
        <div class="modal-body admin-modal-body">
          <!-- Course Thumbnail Upload Section -->
          <div class="admin-form-section">
            <h6 class="admin-form-section-title">
              <i class="fas fa-image me-2"></i>
              Course Thumbnail
            </h6>
            <div class="upload-section">
              <input type="file" id="editCourseThumbnail" class="upload-input" accept="image/*">
              <label for="editCourseThumbnail" class="upload-label">
                <i class="fas fa-cloud-upload-alt"></i>
                Choose New Thumbnail Image
              </label>
              <div id="editCourseThumbnailPreview" class="upload-preview">
                <div class="preview-overlay">
                  <i class="fas fa-cloud-upload-alt"></i>
                  <p>Click or drag to upload</p>
                  <small>JPEG, PNG, JPG, WebP (max 10MB)</small>
                </div>
              </div>
              <div id="editCourseThumbnailProgress" class="progress-container" style="display: none;"></div>
            </div>
            <input type="hidden" name="thumbnail" id="editCourseThumbnailUrl">
            <div class="current-thumbnail mt-2" id="currentThumbnailSection" style="display: none;">
              <small class="text-muted">
                <i class="fas fa-info-circle me-1"></i>
                Current thumbnail: <span id="currentThumbnailUrl"></span>
              </small>
            </div>
          </div>

          <!-- Course Details Section -->
          <div class="row">
            <div class="col-md-8">
              <div class="admin-form-section">
                <h6 class="admin-form-section-title">
                  <i class="fas fa-info-circle me-2"></i>
                  Course Information
                </h6>

                <div class="admin-form-group">
                  <label for="editCourseTitle" class="admin-form-label">
                    <i class="fas fa-heading me-2"></i>
                    Course Title
                  </label>
                  <input type="text" class="admin-form-control" id="editCourseTitle" name="title" minlength="3" maxlength="100" required>
                  <small class="admin-form-text">Title must be between 3 and 100 characters</small>
                  <div class="invalid-feedback" id="editCourseTitleError"></div>
                </div>

                <div class="admin-form-group">
                  <label for="editCourseDescription" class="admin-form-label">
                    <i class="fas fa-align-left me-2"></i>
                    Course Description (Optional)
                  </label>
                  <textarea class="admin-form-control" id="editCourseDescription" name="description" rows="4" maxlength="500"></textarea>
                  <small class="admin-form-text">Description is optional (max 500 characters)</small>
                  <div class="invalid-feedback" id="editCourseDescriptionError"></div>
                </div>

                <div class="admin-form-group">
                  <label for="editShortDescription" class="admin-form-label">
                    <i class="fas fa-text-width me-2"></i>
                    Short Description (Optional)
                  </label>
                  <input type="text" class="admin-form-control" id="editShortDescription" name="shortDescription" maxlength="150">
                  <small class="admin-form-text">Short description is optional (max 150 characters)</small>
                  <div class="invalid-feedback" id="editShortDescriptionError"></div>
                </div>
              </div>
            </div>

            <div class="col-md-4">
              <div class="admin-form-section">
                <h6 class="admin-form-section-title">
                  <i class="fas fa-cog me-2"></i>
                  Course Settings
                </h6>

                <div class="admin-form-group">
                  <label for="editCourseBundle" class="admin-form-label">
                    <i class="fas fa-box me-2"></i>
                    Select Bundle
                  </label>
                  <select class="admin-form-control" id="editCourseBundle" name="bundleId" required>
                    <option value="">Select Bundle</option>
                    <!-- Bundles will be loaded dynamically -->
                  </select>
                  <small class="admin-form-text">Course will be moved to the selected bundle</small>
                </div>

                <div class="admin-form-group">
                  <label for="editCourseLevel" class="admin-form-label">
                    <i class="fas fa-layer-group me-2"></i>
                    Course Level
                  </label>
                  <select class="admin-form-control" id="editCourseLevel" name="level" required>
                    <option value="">Select Level</option>
                    <option value="Beginner">Beginner</option>
                    <option value="Intermediate">Intermediate</option>
                    <option value="Advanced">Advanced</option>
                  </select>
                </div>

                <div class="admin-form-group">
                  <label for="editCourseCategory" class="admin-form-label">
                    <i class="fas fa-tags me-2"></i>
                    Category
                  </label>
                  <input type="text" class="admin-form-control" id="editCourseCategory" name="category" placeholder="e.g., Core, Elective, Supplementary" required>
                  <div class="invalid-feedback" id="editCourseCategoryError"></div>
                </div>

                <div class="admin-form-group">
                  <label for="editCourseDuration" class="admin-form-label">
                    <i class="fas fa-clock me-2"></i>
                    Duration (hours)
                  </label>
                  <input type="number" class="admin-form-control" id="editCourseDuration" name="duration" min="1" required>
                  <small class="admin-form-text">Duration must be at least 1 hour</small>
                  <div class="invalid-feedback" id="editCourseDurationError"></div>
                </div>

                <div class="admin-form-group">
                  <label for="editCoursePrice" class="admin-form-label">
                    <i class="fas fa-coins me-2"></i>
                    Price (EGP)
                  </label>
                  <input type="number" class="admin-form-control" id="editCoursePrice" name="price" min="0" step="0.01" required>
                  <small class="admin-form-text">Individual course price</small>
                  <div class="invalid-feedback" id="editCoursePriceError"></div>
                </div>

                <div class="admin-form-group">
                  <label for="editCourseDiscountPrice" class="admin-form-label">
                    <i class="fas fa-percentage me-2"></i>
                    Discount Percentage (%)
                  </label>
                  <input type="number" class="admin-form-control" id="editCourseDiscountPrice" name="discountPrice" min="0" max="100" step="1" value="0">
                  <small class="admin-form-text">Optional: Set a discount percentage (0-100)</small>
                  <div class="invalid-feedback" id="editCourseDiscountPriceError"></div>
                </div>
              </div>
            </div>
          </div>

          <!-- Course Status Section -->
          <div class="row mt-4">
            <div class="col-12">
              <div class="admin-form-section">
                <h6 class="admin-form-section-title">
                  <i class="fas fa-toggle-on me-2"></i>
                  Course Status & Publishing
                </h6>

                <div class="row">
                  <div class="col-md-6">
                    <div class="admin-form-group">
                      <label for="editCourseStatus" class="admin-form-label">
                        <i class="fas fa-flag me-2"></i>
                        Course Status
                      </label>
                      <select class="admin-form-control" id="editCourseStatus" name="status" required>
                        <option value="draft">Draft</option>
                        <option value="published">Published</option>
                        <option value="archived">Archived</option>
                      </select>
                      <small class="admin-form-text">Published courses are visible to students</small>
                    </div>
                  </div>

                  <div class="col-md-6">
                    <div class="admin-form-group">
                      <div class="admin-form-check">
                        <input type="checkbox" class="admin-form-check-input" id="editCourseFeatured" name="isFeatured">
                        <label class="admin-form-check-label" for="editCourseFeatured">
                          <i class="fas fa-star me-2"></i>
                          Featured Course
                        </label>
                      </div>
                      <small class="admin-form-text">Featured courses appear prominently on the homepage</small>
                    </div>
                  </div>
                </div>

                <!-- Sequential Requirement Section -->
                <div class="row mt-3">
                  <div class="col-12">
                    <div class="admin-form-group">
                      <div class="admin-form-check mb-3">
                        <input type="checkbox" class="admin-form-check-input" id="editCourseRequiresSequential" name="requiresSequential">
                        <label class="admin-form-check-label" for="editCourseRequiresSequential">
                          <i class="fas fa-list-ol me-2"></i>
                          Require Sequential Completion
                        </label>
                      </div>
                      <small class="admin-form-text">When enabled, students must complete previous courses in the bundle before accessing this course. When disabled, students can access this course without completing prerequisites.</small>
                    </div>
                  </div>
                </div>

                <!-- Fully Booked Section -->
                <div class="row mt-3">
                  <div class="col-12">
                    <div class="admin-form-group">
                      <div class="admin-form-check mb-3">
                        <input type="checkbox" class="admin-form-check-input" id="editCourseIsFullyBooked" name="isFullyBooked">
                        <label class="admin-form-check-label" for="editCourseIsFullyBooked">
                          <i class="fas fa-ban me-2"></i>
                          Fully Booked / Close Enrollment
                        </label>
                      </div>
                      <small class="admin-form-text">When enabled, this course will be marked as fully booked and students cannot enroll</small>
                    </div>
                  </div>
                </div>

                <div class="row" id="fullyBookedMessageRow" style="display: none;">
                  <div class="col-12">
                    <div class="admin-form-group">
                      <label for="editCourseFullyBookedMessage" class="admin-form-label">
                        <i class="fas fa-comment me-2"></i>
                        Fully Booked Message
                      </label>
                      <select class="admin-form-control" id="editCourseFullyBookedMessage" name="fullyBookedMessage">
                        <option value="FULLY BOOKED">FULLY BOOKED</option>
                        <option value="Out of Stock">Out of Stock</option>
                        <option value="Enrollment Closed">Enrollment Closed</option>
                        <option value="Registration Closed">Registration Closed</option>
                        <option value="Sold Out">Sold Out</option>
                        <option value="Not Available">Not Available</option>
                        <option value="other">Other (Custom Message)</option>
                      </select>
                      <small class="admin-form-text">Choose a message to display when course is fully booked</small>
                      <div class="invalid-feedback" id="editCourseFullyBookedMessageError"></div>
                    </div>
                    <div class="admin-form-group" id="customMessageRow" style="display: none;">
                      <label for="editCourseCustomFullyBookedMessage" class="admin-form-label">
                        <i class="fas fa-edit me-2"></i>
                        Custom Message
                      </label>
                      <input type="text" class="admin-form-control" id="editCourseCustomFullyBookedMessage" name="customFullyBookedMessage" maxlength="100" placeholder="Enter your custom message">
                      <small class="admin-form-text">Enter a custom message (max 100 characters)</small>
                      <div class="invalid-feedback" id="editCourseCustomFullyBookedMessageError"></div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Course Tags Section -->
          <div class="row mt-3">
            <div class="col-12">
              <div class="admin-form-section">
                <h6 class="admin-form-section-title">
                  <i class="fas fa-tags me-2"></i>
                  Course Tags
                </h6>

                <div class="admin-form-group">
                  <label for="editCourseTags" class="admin-form-label">
                    <i class="fas fa-hashtag me-2"></i>
                    Course Tags
                  </label>
                  <input type="text" class="admin-form-control" id="editCourseTags" name="tags" placeholder="Enter tags separated by commas">
                  <small class="admin-form-text">Example: mathematics, algebra, grade-10, core</small>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="modal-footer admin-modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-success admin-btn-primary">
            <i class="fas fa-save me-2"></i>
            Update Course
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<% 
// Helper function to get content icons
function getContentIcon(type) {
  const icons = {
    'video': 'play',
    'pdf': 'file-pdf',
    'homework': 'tasks',
    'quiz': 'question-circle',
    'zoom': 'video',
    'link': 'external-link-alt'
  };
  return icons[type] || 'file';
}
%>

<%- include('./partials/admin-footer') %>

<!-- Local Upload Script (for images only) -->
<script src="/js/local-upload.js"></script>

<script>
  // Course content management functions
  let currentTopicId = null;
  let reorderMode = false;

  function manageTopicContent(topicId) {
    currentTopicId = topicId;
    const form = document.getElementById('addContentForm');
    form.action = `/admin/courses/<%= courseCode %>/topics/${topicId}/content/create`;

    // Reset form
    form.reset();
    document.getElementById('fileUploadSection').style.display = 'none';
    document.getElementById('uploadedFileUrl').value = '';

    // Reset quiz and homework steps
    resetQuizSteps();
    resetHomeworkSteps();

    // Hide all content type sections
    document.getElementById('quizContentSection').style.display = 'none';
    document.getElementById('homeworkContentSection').style.display = 'none';
    document.getElementById('zoomContentSection').style.display = 'none';

    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('addContentModal'));
    modal.show();
  }

  function editTopic(topicId) {
    // Find the topic data and populate edit modal
    const topicCard = document.querySelector(`[data-topic-id="${topicId}"]`);
    if (!topicCard) return;

    const title = topicCard.querySelector('.topic-title').textContent;
    const description = topicCard.querySelector('.topic-description').textContent;

    // Extract additional data from the topic card
    const estimatedTimeText = topicCard.querySelector('.meta-item i.fa-clock')?.parentElement?.textContent?.trim();
    const estimatedTime = estimatedTimeText ? parseFloat(estimatedTimeText.replace('h', '')) * 60 : 0; // Convert hours to minutes

    const difficultyBadge = topicCard.querySelector('.difficulty-badge');
    const difficulty = difficultyBadge ? difficultyBadge.textContent.toLowerCase() : 'beginner';

    const statusBadge = topicCard.querySelector('.status-badge');
    const isPublished = statusBadge ? statusBadge.classList.contains('published') : false;

    const order = topicCard.getAttribute('data-order') || 1;

    // Create and show edit modal with all data
    showEditTopicModal(topicId, {
      title,
      description,
      estimatedTime,
      difficulty,
      isPublished,
      order
    });
  }

  function showEditTopicModal(topicId, topicData) {
    // Helper function to escape template literal special characters
    const escapeTemplate = (text) => {
      if (!text) return '';
      return String(text)
        .replace(/\\/g, '\\\\')  // Escape backslashes
        .replace(/`/g, '\\`')    // Escape backticks
        .replace(/\${/g, '\\${')  // Escape template expressions
        .replace(/\n/g, '\\n')    // Preserve newlines
        .replace(/\r/g, '\\r');   // Preserve carriage returns
    };

    // Escape all text fields to prevent template literal issues
    const safeTitle = escapeTemplate(topicData.title || '');
    const safeDescription = escapeTemplate(topicData.description || '');
    
    const modalHtml = `
    <div class="modal fade" id="editTopicModal" tabindex="-1">
      <div class="modal-dialog modal-xl">
        <div class="modal-content edit-topic-modal">
          <div class="modal-header edit-topic-header">
            <div class="header-content">
              <div class="header-icon">
                <i class="fas fa-edit"></i>
              </div>
              <div class="header-text">
                <h5 class="modal-title">Edit Topic</h5>
                <p class="modal-subtitle">Update topic information and settings</p>
              </div>
            </div>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
          </div>
          <form id="editTopicForm">
            <div class="modal-body edit-topic-body">
              <!-- Basic Information Section -->
              <div class="form-section">
                <div class="section-header">
                  <div class="section-icon">
                    <i class="fas fa-info-circle"></i>
                  </div>
                  <h6 class="section-title">Basic Information</h6>
                </div>
                <div class="section-content">
                  <div class="row">
                    <div class="col-lg-8">
                      <div class="form-group">
                        <label class="form-label">
                          <i class="fas fa-heading"></i>
                          <span>Topic Title</span>
                        </label>
                        <input type="text" class="form-control form-control-lg" name="title" value="${safeTitle}" required minlength="3" maxlength="100" placeholder="Enter topic title">
                        <div class="form-hint">Title must be between 3-100 characters</div>
                      </div>
                    </div>
                    <div class="col-lg-4">
                      <div class="form-group">
                        <label class="form-label">
                          <i class="fas fa-sort-numeric-up"></i>
                          <span>Order</span>
                        </label>
                        <input type="number" class="form-control form-control-lg" name="order" value="${topicData.order}" min="1" placeholder="1">
                      </div>
                    </div>
                  </div>
                  
                  <div class="form-group">
                    <label class="form-label">
                      <i class="fas fa-align-left"></i>
                      <span>Description</span>
                    </label>
                    <textarea class="form-control form-control-lg" name="description" rows="4" maxlength="500" placeholder="Enter detailed topic description">${safeDescription}</textarea>
                    <div class="form-hint">Description is optional (max 500 characters, minimum 10 if provided)</div>
                  </div>
                </div>
              </div>

              <!-- Settings Section -->
              <div class="form-section">
                <div class="section-header">
                  <div class="section-icon">
                    <i class="fas fa-cog"></i>
                  </div>
                  <h6 class="section-title">Topic Settings</h6>
                </div>
                <div class="section-content">
                  <div class="row">
                    <div class="col-lg-6">
                      <div class="form-group">
                        <label class="form-label">
                          <i class="fas fa-clock"></i>
                          <span>Estimated Time (minutes)</span>
                        </label>
                        <input type="number" class="form-control form-control-lg" name="estimatedTime" value="${topicData.estimatedTime}" min="0" step="5" placeholder="0">
                        <div class="form-hint">Enter time in minutes</div>
                      </div>
                    </div>
                    <div class="col-lg-6">
                      <div class="form-group">
                        <label class="form-label">
                          <i class="fas fa-signal"></i>
                          <span>Difficulty Level</span>
                        </label>
                        <select class="form-select form-select-lg" name="difficulty">
                          <option value="beginner" ${topicData.difficulty === 'beginner' ? 'selected' : ''}>ðŸŸ¢ Beginner</option>
                          <option value="intermediate" ${topicData.difficulty === 'intermediate' ? 'selected' : ''}>ðŸŸ¡ Intermediate</option>
                          <option value="advanced" ${topicData.difficulty === 'advanced' ? 'selected' : ''}>ðŸ”´ Advanced</option>
                        </select>
                      </div>
                    </div>
                  </div>
                  
                  <div class="row">
                    <div class="col-lg-6">
                      <div class="form-group">
                        <label class="form-label">
                          <i class="fas fa-unlock"></i>
                          <span>Unlock Conditions</span>
                        </label>
                        <select class="form-select form-select-lg" name="unlockConditions">
                          <option value="immediate">âš¡ Immediate</option>
                          <option value="previous_completed">âœ… Previous Topic Completed</option>
                          <option value="quiz_passed">ðŸ“ Quiz Passed</option>
                        </select>
                      </div>
                    </div>
                    <div class="col-lg-6">
                      <div class="form-group">
                        <label class="form-label">
                          <i class="fas fa-tags"></i>
                          <span>Tags</span>
                        </label>
                        <input type="text" class="form-control form-control-lg" name="tags" placeholder="Enter tags separated by commas">
                        <div class="form-hint">Separate multiple tags with commas</div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Status Section -->
              <div class="form-section">
                <div class="section-header">
                  <div class="section-icon">
                    <i class="fas fa-eye"></i>
                  </div>
                  <h6 class="section-title">Publishing Status</h6>
                </div>
                <div class="section-content">
                  <div class="publish-toggle">
                    <div class="toggle-content">
                      <div class="toggle-icon">
                        <i class="fas fa-${topicData.isPublished ? 'eye' : 'eye-slash'}"></i>
                      </div>
                      <div class="toggle-text">
                        <h6>Publish Topic</h6>
                        <p>Published topics are visible to students</p>
                      </div>
                    </div>
                    <div class="form-check form-switch">
                      <input class="form-check-input" type="checkbox" name="isPublished" id="isPublished" ${topicData.isPublished ? 'checked' : ''}>
                      <label class="form-check-label" for="isPublished"></label>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="modal-footer edit-topic-footer">
              <button type="button" class="btn btn-cancel" data-bs-dismiss="modal">
                <i class="fas fa-times"></i>
                <span>Cancel</span>
              </button>
              <button type="submit" class="btn btn-save">
                <i class="fas fa-save"></i>
                <span>Update Topic</span>
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  `;

    // Remove existing modal if any
    const existingModal = document.getElementById('editTopicModal');
    if (existingModal) existingModal.remove();

    // Add modal to body
    document.body.insertAdjacentHTML('beforeend', modalHtml);

    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('editTopicModal'));
    modal.show();

    // Handle form submission
    document.getElementById('editTopicForm').addEventListener('submit', function(e) {
      e.preventDefault();

      // Clear previous validation errors
      clearValidationErrors();

      // Get submit button reference early
      const submitBtn = this.querySelector('button[type="submit"]');
      const originalText = submitBtn.innerHTML;

      const formData = new FormData(this);
      const data = Object.fromEntries(formData.entries());

      // Convert checkbox to boolean
      data.isPublished = data.isPublished === 'on';

      // Handle description - trim and validate
      if (data.description) {
        data.description = data.description.trim();
        // If description is provided but less than 10 characters, show error
        if (data.description.length > 0 && data.description.length < 10) {
          showNotification('Description must be at least 10 characters long if provided', 'error');
          submitBtn.disabled = false;
          submitBtn.innerHTML = originalText;
          return;
        }
        // If trimmed description is empty, remove it from data
        if (data.description.length === 0) {
          delete data.description;
        }
      } else {
        // If description is empty, remove it from data so backend doesn't validate it
        delete data.description;
      }

      // Convert tags string to array
      if (data.tags) {
        data.tags = data.tags.split(',').map(tag => tag.trim()).filter(tag => tag);
      }

      // Show loading state
      submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Updating...';
      submitBtn.disabled = true;

      // Validate topicId
      if (!topicId || topicId === 'undefined' || topicId === 'null') {
        showNotification('Error: Invalid topic ID', 'error');
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
        return;
      }

      // Log the data being sent for debugging (remove in production)
      console.log('Updating topic:', topicId, 'Data:', data);

      fetch(`/admin/courses/<%= courseCode %>/topics/${topicId}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json'
          },
          body: JSON.stringify(data)
        })
        .then(async response => {
          // Check if response is ok before parsing JSON
          if (!response.ok) {
            let errorMessage = `Server error: ${response.status}`;
            try {
              const errData = await response.json();
              errorMessage = errData.message || errorMessage;
              // If there are validation errors, show them
              if (errData.errors) {
                showValidationErrors(errData.errors);
                return; // Don't throw, let the user see the validation errors
              }
            } catch (e) {
              // Response is not JSON, use status text
              errorMessage = response.statusText || errorMessage;
            }
            throw new Error(errorMessage);
          }
          return response.json();
        })
        .then(data => {
          if (data && data.success) {
            modal.hide();
            showNotification('Topic updated successfully!', 'success');

            // Update the topic card in the UI without reloading
            updateTopicCard(topicId, data.topic);
          } else {
            // Handle validation errors
            if (data && data.errors) {
              showValidationErrors(data.errors);
            } else {
              showNotification('Error: ' + (data?.message || 'Failed to update topic'), 'error');
            }
          }
        })
        .catch(error => {
          console.error('Error updating topic:', error);
          showNotification('Error updating topic: ' + (error.message || 'Unknown error occurred'), 'error');
        })
        .finally(() => {
          // Restore button state
          submitBtn.innerHTML = originalText;
          submitBtn.disabled = false;
        });
    });

    // Helper functions for validation error handling
    function clearValidationErrors() {
      const form = document.getElementById('editTopicForm');
      const errorElements = form.querySelectorAll('.is-invalid, .invalid-feedback');
      errorElements.forEach(el => {
        el.classList.remove('is-invalid');
        if (el.classList.contains('invalid-feedback')) {
          el.remove();
        }
      });
    }

    function showValidationErrors(errors) {
      Object.keys(errors).forEach(fieldName => {
        const field = document.querySelector(`[name="${fieldName}"]`);
        if (field) {
          field.classList.add('is-invalid');

          // Add error message
          const errorDiv = document.createElement('div');
          errorDiv.className = 'invalid-feedback';
          errorDiv.textContent = errors[fieldName];
          field.parentNode.appendChild(errorDiv);
        }
      });
    }
  }

  function duplicateTopic(topicId, courseCode) {
    if (!confirm(`Are you sure you want to duplicate this topic? This will create a new topic with all content. The new topic will be set to draft status.`)) {
      return;
    }

    // Show loading state
    const duplicateButton = event ? event.target.closest('button') : null;
    const originalHTML = duplicateButton ? duplicateButton.innerHTML : '';
    if (duplicateButton) {
      duplicateButton.disabled = true;
      duplicateButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    }

    fetch(`/admin/courses/${courseCode}/topics/${topicId}/duplicate`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          // Show success message
          Swal.fire({
            icon: 'success',
            title: 'Success!',
            text: data.message || 'Topic duplicated successfully!',
            timer: 2000,
            showConfirmButton: false
          });
          // Reload the page to show the new topic
          setTimeout(() => {
            location.reload();
          }, 1500);
        } else {
          Swal.fire({
            icon: 'error',
            title: 'Error',
            text: data.message || 'Error duplicating topic'
          });
          if (duplicateButton) {
            duplicateButton.disabled = false;
            duplicateButton.innerHTML = originalHTML;
          }
        }
      })
      .catch(error => {
        console.error('Error:', error);
        Swal.fire({
          icon: 'error',
          title: 'Error',
          text: 'Error duplicating topic'
        });
        if (duplicateButton) {
          duplicateButton.disabled = false;
          duplicateButton.innerHTML = originalHTML;
        }
      });
  }

  function deleteTopic(topicId) {
    // Create a beautiful confirmation modal instead of browser confirm
    const confirmModalHtml = `
    <div class="modal fade" id="deleteConfirmModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header bg-danger text-white">
            <h5 class="modal-title">
              <i class="fas fa-exclamation-triangle me-2"></i>Confirm Deletion
            </h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="text-center">
              <div class="mb-3">
                <i class="fas fa-trash-alt text-danger" style="font-size: 48px;"></i>
              </div>
              <h6 class="mb-3">Are you sure you want to delete this topic?</h6>
              <p class="text-muted mb-0">This action cannot be undone. All content within this topic will also be deleted.</p>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
              <i class="fas fa-times me-1"></i>Cancel
            </button>
            <button type="button" class="btn btn-danger" id="confirmDeleteBtn">
              <i class="fas fa-trash me-1"></i>Delete Topic
            </button>
          </div>
        </div>
      </div>
    </div>
  `;

    // Remove existing modal if any
    const existingModal = document.getElementById('deleteConfirmModal');
    if (existingModal) existingModal.remove();

    // Add modal to body
    document.body.insertAdjacentHTML('beforeend', confirmModalHtml);

    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
    modal.show();

    // Handle delete confirmation
    document.getElementById('confirmDeleteBtn').addEventListener('click', async function() {
      // Show loading state
      const deleteBtn = this;
      const originalText = deleteBtn.innerHTML;
      deleteBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Deleting...';
      deleteBtn.disabled = true;

      try {
        const response = await fetch(`/admin/courses/<%= courseCode %>/topics/${topicId}`, {
          method: 'DELETE',
          headers: {
            'Content-Type': 'application/json',
          }
        });

        const data = await response.json();

        if (data.success) {
          modal.hide();
          showNotification('Topic deleted successfully!', 'success');

          // Remove the topic card from UI with animation
          const topicCard = document.querySelector(`[data-topic-id="${topicId}"]`);
          if (topicCard) {
            topicCard.style.transition = 'all 0.3s ease';
            topicCard.style.transform = 'scale(0.8)';
            topicCard.style.opacity = '0';
            setTimeout(() => {
              topicCard.remove();
              // Update topic numbers
              updateTopicNumbers();
            }, 300);
          }
        } else {
          throw new Error(data.message || 'Failed to delete topic');
        }
      } catch (error) {
        console.error('Error:', error);
        showNotification('Error deleting topic: ' + error.message, 'error');
        // Restore button state
        deleteBtn.innerHTML = originalText;
        deleteBtn.disabled = false;
      }
    });

    // Clean up modal when hidden
    document.getElementById('deleteConfirmModal').addEventListener('hidden.bs.modal', function() {
      this.remove();
    });
  }

  // Helper function to update topic numbers after deletion
  function updateTopicNumbers() {
    const topicCards = document.querySelectorAll('.topic-card');
    topicCards.forEach((card, index) => {
      const numberElement = card.querySelector('.topic-number');
      if (numberElement) {
        numberElement.textContent = String(index + 1).padStart(2, '0');
      }
    });
  }

  function toggleTopicVisibility(topicId, isPublished) {
    const newStatus = !(isPublished === 'true' || isPublished === true);

    // Find the visibility toggle button
    const button = document.querySelector(`[data-topic-id="${topicId}"].visibility-toggle`);
    if (!button) return;

    // Store original state
    const originalContent = button.innerHTML;
    const originalClasses = button.className;

    // Show loading state with animation
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i><span class="btn-text">Updating...</span>';
    button.disabled = true;
    button.classList.add('loading');

    fetch(`/admin/courses/<%= courseCode %>/topics/${topicId}/visibility`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          isPublished: newStatus
        })
      })
      .then(response => {
        if (response.ok) {
          return response.json();
        } else {
          throw new Error('Failed to update visibility');
        }
      })
      .then(data => {
        if (data.success) {
          // Update button classes and content
          button.classList.remove('loading', newStatus ? 'draft' : 'published');
          button.classList.add(newStatus ? 'published' : 'draft');

          // Update button content
          const icon = newStatus ? 'eye' : 'eye-slash';
          const text = newStatus ? 'Hide' : 'Show';
          button.innerHTML = `<i class="fas fa-${icon}"></i><span class="btn-text">${text}</span>`;

          // Update onclick attribute with new state
          button.setAttribute('onclick', `toggleTopicVisibility('${topicId}', ${newStatus})`);
          button.setAttribute('title', newStatus ? 'Hide Topic' : 'Publish Topic');

          // Update the status badge
          const statusBadge = document.querySelector(`[data-topic-id="${topicId}"] .status-badge`);
          if (statusBadge) {
            statusBadge.className = `status-badge ${newStatus ? 'published' : 'draft'}`;
            statusBadge.innerHTML = `<i class="fas fa-${newStatus ? 'eye' : 'eye-slash'}"></i> ${newStatus ? 'Published' : 'Draft'}`;
          }

          // Add success animation
          button.classList.add('success-animation');
          setTimeout(() => {
            button.classList.remove('success-animation');
          }, 600);

          // Show success message
          showNotification(`Topic ${newStatus ? 'published' : 'hidden'} successfully!`, 'success');
        } else {
          throw new Error(data.message || 'Failed to update visibility');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        showNotification('Error updating topic visibility', 'error');

        // Add error animation
        button.classList.add('error-animation');
        setTimeout(() => {
          button.classList.remove('error-animation');
        }, 600);

        // Restore original button state
        button.innerHTML = originalContent;
        button.className = originalClasses;
      })
      .finally(() => {
        button.disabled = false;
        button.classList.remove('loading');
      });
  }

  function viewTopicDetails(topicId) {
    // Redirect to topic details page
    window.location.href = `/admin/courses/<%= courseCode %>/topics/${topicId}/details`;
  }

  function editContent(topicId, contentId) {
    // Find the content item and gather all data
    const contentItem = document.querySelector(`[data-content-id="${contentId}"]`);
    if (!contentItem) return;

    // Extract basic content data
    const title = contentItem.querySelector('.content-title') ? contentItem.querySelector('.content-title').textContent : '';
    const type = contentItem.querySelector('.content-type') ? contentItem.querySelector('.content-type').textContent.toLowerCase() : '';
    const description = contentItem.querySelector('.content-description') ? contentItem.querySelector('.content-description').textContent : '';
    const duration = contentItem.querySelector('.content-duration') ? parseInt(contentItem.querySelector('.content-duration').textContent) : 0;

    // Try to extract content URL from various possible locations
    let content = '';
    const contentUrlElement = contentItem.querySelector('.content-url');
    if (contentUrlElement) {
      content = contentUrlElement.textContent || contentUrlElement.href || '';
    }

    // Create content data object with all available information
    const contentData = {
      title: title,
      type: type,
      description: description,
      content: content,
      duration: duration,
      order: 1, // Default order, will be updated from server
      difficulty: 'beginner', // Default difficulty
      isRequired: true, // Default to required
      tags: '', // Default empty tags
      prerequisites: '', // Default no prerequisites
      // Quiz specific fields
      quizDuration: 30,
      quizPassingScore: 50,
      quizMaxAttempts: 3,
      quizShuffleQuestions: false,
      quizShuffleOptions: false,
      quizShowCorrectAnswers: true,
      quizShowResults: true,
      quizInstructions: '',
      // Homework specific fields
      homeworkPassingScore: 0,
      homeworkMaxAttempts: 1,
      homeworkShuffleQuestions: false,
      homeworkShuffleOptions: false,
      homeworkShowCorrectAnswers: false,
      homeworkInstructions: '',
      // Zoom specific fields
      zoomMeetingName: '',
      zoomMeetingTopic: '',
      scheduledStartTime: '',
      timezone: 'Africa/Cairo',
      password: '',
      joinBeforeHost: true,
      waitingRoom: false,
      hostVideo: true,
      participantVideo: true,
      muteUponEntry: false,
      enableRecording: false
    };

    // Fetch detailed content data from server
    fetch(`/admin/courses/<%= courseCode %>/topics/${topicId}/content/${contentId}/edit-details`)
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          // Merge server data with defaults
          Object.assign(contentData, data.content);
        }
        // Show edit modal with complete data
        showEditContentModal(topicId, contentId, contentData);
      })
      .catch(error => {
        console.error('Error fetching content details:', error);
        // Show modal with basic data if server request fails
        showEditContentModal(topicId, contentId, contentData);
      });
  }

  // Show Edit Content Modal and populate with existing data
  function showEditContentModal(topicId, contentId, contentData) {
    // Populate basic fields
    document.getElementById('editContentType').value = contentData.type || '';
    document.getElementById('editContentTitle').value = contentData.title || '';
    document.getElementById('editContentDescription').value = contentData.description || '';
    document.getElementById('editContentUrl').value = contentData.content || '';
    // Preserve duration value - only set if it exists and is a number, otherwise leave empty
    const durationInput = document.getElementById('editContentDuration');
    if (contentData.duration !== undefined && contentData.duration !== null && contentData.duration !== '') {
      durationInput.value = contentData.duration;
    } else {
      durationInput.value = ''; // Leave empty if not set
    }
    document.getElementById('editContentOrder').value = contentData.order || 1;
    document.getElementById('editContentDifficulty').value = contentData.difficulty || 'beginner';
    document.getElementById('editIsRequired').checked = contentData.isRequired !== false;
    document.getElementById('editContentTags').value = Array.isArray(contentData.tags) ? contentData.tags.join(', ') : (contentData.tags || '');

    // Show/hide and populate video watch limit section
    const editVideoWatchLimitSection = document.getElementById('editVideoWatchLimitSection');
    const editMaxWatchCountInput = document.getElementById('editMaxWatchCount');
    if (contentData.type === 'video') {
      if (editVideoWatchLimitSection) {
        editVideoWatchLimitSection.style.display = 'block';
      }
      if (editMaxWatchCountInput) {
        // Show current maxWatchCount value, or empty if null/unlimited
        // If maxWatchCount is null/undefined, leave empty (user can enter -1 or leave empty)
        if (contentData.maxWatchCount !== null && contentData.maxWatchCount !== undefined) {
          editMaxWatchCountInput.value = contentData.maxWatchCount;
        } else {
          editMaxWatchCountInput.value = '';
        }
      }
    } else {
      if (editVideoWatchLimitSection) {
        editVideoWatchLimitSection.style.display = 'none';
      }
      if (editMaxWatchCountInput) {
        editMaxWatchCountInput.value = '';
      }
    }

    // Make Content Type READ-ONLY by making it look disabled but keep it enabled for form submission
    const typeSelect = document.getElementById('editContentType');
    typeSelect.style.pointerEvents = 'none';
    typeSelect.style.backgroundColor = '#e9ecef';
    typeSelect.style.cursor = 'not-allowed';

    // Remove current content item from prerequisites dropdown to prevent self-reference
    const prerequisitesSelect = document.getElementById('editContentPrerequisites');
    if (prerequisitesSelect && contentId) {
      // Convert contentId to string for comparison
      const currentContentIdStr = String(contentId);

      // Find and remove the option that matches the current content ID
      let wasRemoved = false;
      Array.from(prerequisitesSelect.options).forEach(option => {
        if (String(option.value) === currentContentIdStr) {
          option.remove();
          wasRemoved = true;
          console.log('Edit Content - Removed current content from prerequisites:', currentContentIdStr);
        }
      });

      // If the current content was removed and it was set as prerequisite, clear it
      if (wasRemoved && contentData.prerequisites) {
        let prerequisiteId = '';

        // Handle prerequisites - can be array, single value, or object with _id
        if (Array.isArray(contentData.prerequisites)) {
          if (contentData.prerequisites.length > 0) {
            prerequisiteId = contentData.prerequisites[0];
          }
        } else if (typeof contentData.prerequisites === 'object' && contentData.prerequisites._id) {
          prerequisiteId = contentData.prerequisites._id;
        } else {
          prerequisiteId = contentData.prerequisites;
        }

        // Convert to string for comparison
        if (prerequisiteId && typeof prerequisiteId === 'object' && prerequisiteId.toString) {
          prerequisiteId = prerequisiteId.toString();
        } else {
          prerequisiteId = String(prerequisiteId || '');
        }

        // If the prerequisite matches the current content ID, clear it
        if (prerequisiteId === currentContentIdStr) {
          console.warn('Edit Content - Current content was set as its own prerequisite. Clearing prerequisite.');
          contentData.prerequisites = null; // Clear it so it won't be set
        }
      }
    }

    // Set prerequisites - handle MongoDB ObjectId conversion
    if (prerequisitesSelect && contentData.prerequisites) {
      let prerequisiteId = '';

      // Handle prerequisites - can be array, single value, or object with _id
      if (Array.isArray(contentData.prerequisites)) {
        // If it's an array, get the first one
        if (contentData.prerequisites.length > 0) {
          prerequisiteId = contentData.prerequisites[0];
        }
      } else if (typeof contentData.prerequisites === 'object' && contentData.prerequisites._id) {
        // If it's an object with _id property
        prerequisiteId = contentData.prerequisites._id;
      } else {
        // It's a single value
        prerequisiteId = contentData.prerequisites;
      }

      // Convert to string for matching with select option values
      // Handle MongoDB ObjectId objects
      if (prerequisiteId && typeof prerequisiteId === 'object' && prerequisiteId.toString) {
        prerequisiteId = prerequisiteId.toString();
      } else {
        prerequisiteId = String(prerequisiteId || '');
      }

      // Use setTimeout to ensure select options are loaded before setting value
      setTimeout(() => {
        // Check if the option exists in the select
        const optionExists = Array.from(prerequisitesSelect.options).some(
          option => String(option.value) === prerequisiteId
        );

        if (prerequisiteId && optionExists) {
          prerequisitesSelect.value = prerequisiteId;
          console.log('Edit Content - Prerequisite set successfully:', prerequisiteId);
        } else if (prerequisiteId) {
          // Option doesn't exist, log for debugging
          console.warn('Edit Content - Prerequisite ID not found in options:', prerequisiteId);
          console.log('Edit Content - Available options:', Array.from(prerequisitesSelect.options).map(opt => opt.value));
          prerequisitesSelect.value = ''; // Set to empty if not found
        } else {
          prerequisitesSelect.value = '';
        }
      }, 100);

      // Make prerequisites look disabled but keep enabled for submission
      prerequisitesSelect.style.pointerEvents = 'none';
      prerequisitesSelect.style.backgroundColor = '#e9ecef';
      prerequisitesSelect.style.cursor = 'not-allowed';
    }

    // Update current file text if available
    const currentFileText = document.getElementById('editCurrentFileText');
    if (currentFileText && contentData.content) {
      currentFileText.textContent = `Current: ${contentData.content.substring(contentData.content.lastIndexOf('/') + 1)}`;
    }

    // Populate Quiz fields if quiz type
    if (contentData.type === 'quiz' && contentData.quizSettings) {
      document.getElementById('editQuizDuration').value = contentData.quizSettings.duration || 30;
      document.getElementById('editQuizPassingScore').value = contentData.quizSettings.passingScore !== undefined ? contentData.quizSettings.passingScore : 50;
      document.getElementById('editQuizMaxAttempts').value = contentData.quizSettings.maxAttempts || 3;
      document.getElementById('editQuizShuffleQuestions').checked = contentData.quizSettings.shuffleQuestions || false;
      document.getElementById('editQuizShuffleOptions').checked = contentData.quizSettings.shuffleOptions || false;
      document.getElementById('editQuizShowCorrectAnswers').checked = contentData.quizSettings.showCorrectAnswers !== false;
      document.getElementById('editQuizShowResults').checked = contentData.quizSettings.showResults !== false;
      document.getElementById('editQuizInstructions').value = contentData.quizSettings.instructions || '';
    }

    // Populate Homework fields if homework type
    if (contentData.type === 'homework' && contentData.homeworkSettings) {
      document.getElementById('editHomeworkPassingScore').value = contentData.homeworkSettings.passingScore !== undefined ? contentData.homeworkSettings.passingScore : 0;
      document.getElementById('editHomeworkMaxAttempts').value = contentData.homeworkSettings.maxAttempts || 1;
      document.getElementById('editHomeworkShuffleQuestions').checked = contentData.homeworkSettings.shuffleQuestions || false;
      document.getElementById('editHomeworkShuffleOptions').checked = contentData.homeworkSettings.shuffleOptions || false;
      document.getElementById('editHomeworkShowCorrectAnswers').checked = contentData.homeworkSettings.showCorrectAnswers || false;
      document.getElementById('editHomeworkInstructions').value = contentData.homeworkSettings.instructions || '';
    }

    // Populate Zoom fields if zoom type
    if (contentData.type === 'zoom' && contentData.zoomMeeting) {
      document.getElementById('editZoomMeetingName').value = contentData.zoomMeeting.meetingName || contentData.title || '';
      document.getElementById('editZoomMeetingTopic').value = contentData.zoomMeeting.meetingTopic || '';

      // Format datetime for datetime-local input
      if (contentData.zoomMeeting.scheduledStartTime) {
        const dateTime = new Date(contentData.zoomMeeting.scheduledStartTime);
        const formattedDateTime = dateTime.toISOString().slice(0, 16);
        document.getElementById('editZoomScheduledTime').value = formattedDateTime;
      }

      document.getElementById('editZoomDuration').value = contentData.zoomMeeting.duration || 60;
      document.getElementById('editZoomTimezone').value = contentData.zoomMeeting.timezone || 'Africa/Cairo';
      document.getElementById('editZoomPassword').value = contentData.zoomMeeting.password || '';

      // Meeting settings - Fixed to properly access settings object
      if (contentData.zoomMeeting.settings) {
        document.getElementById('editZoomJoinBeforeHost').checked = contentData.zoomMeeting.settings.joinBeforeHost !== false;
        document.getElementById('editZoomWaitingRoom').checked = contentData.zoomMeeting.settings.waitingRoom || false;
        document.getElementById('editZoomHostVideo').checked = contentData.zoomMeeting.settings.hostVideo !== false;
        document.getElementById('editZoomParticipantVideo').checked = contentData.zoomMeeting.settings.participantVideo !== false;
        document.getElementById('editZoomMuteUponEntry').checked = contentData.zoomMeeting.settings.muteUponEntry || false;
        document.getElementById('editZoomEnableRecording').checked = contentData.zoomMeeting.settings.recording || false;
      }
    }

    // Show the modal
    const modal = new bootstrap.Modal(document.getElementById('editContentModal'));
    modal.show();

    // Initialize edit modal functionality
    initializeEditContentModal(topicId, contentId, contentData, modal);
  }

  function initializeEditContentModal(topicId, contentId, contentData, modal) {
    // Store data globally for edit functions
    window.editContentData = {
      topicId,
      contentId,
      contentData,
      modal
    };

    // Handle content type change
    const contentTypeSelect = document.getElementById('editContentType');
    if (contentTypeSelect) {
      contentTypeSelect.addEventListener('change', function() {
        handleEditContentTypeChange(this.value);
      });

      // Initialize content type sections
      handleEditContentTypeChange(contentData.type);
    }

    // Setup file upload for edit modal
    setupEditFileUpload();

    // Handle form submission
    const form = document.getElementById('editContentForm');
    if (form) {
      form.removeEventListener('submit', handleEditFormSubmit); // Remove old listener if exists
      form.addEventListener('submit', handleEditFormSubmit);
    }

    // Initialize quiz/homework functionality if needed
    if (contentData.type === 'quiz') {
      initializeEditQuizFunctionality(contentData);
    } else if (contentData.type === 'homework') {
      initializeEditHomeworkFunctionality(contentData);
    }
  }

  // Form submit handler
  function handleEditFormSubmit(e) {
    e.preventDefault();
    const {
      topicId,
      contentId,
      modal
    } = window.editContentData;
    handleEditContentSubmission(topicId, contentId, modal);
  }

  function handleEditContentTypeChange(type) {
    // Hide all content type specific sections
    document.getElementById('editContentUrlSection').style.display = 'none';
    document.getElementById('editFileUploadSection').style.display = 'none';
    document.getElementById('editQuizContentSection').style.display = 'none';
    document.getElementById('editHomeworkContentSection').style.display = 'none';
    document.getElementById('editZoomContentSection').style.display = 'none';

    // Get the content URL input
    const contentUrlInput = document.getElementById('editContentUrl');

    // Show relevant sections based on content type
    if (type === 'video' || type === 'pdf' || type === 'link') {
      document.getElementById('editContentUrlSection').style.display = 'block';
      if (contentUrlInput) {
        contentUrlInput.required = true; // Make required for these types
      }
      if (type === 'pdf') {
        document.getElementById('editFileUploadSection').style.display = 'block';
      }
    } else if (type === 'quiz') {
      document.getElementById('editQuizContentSection').style.display = 'block';
      if (contentUrlInput) {
        contentUrlInput.required = false; // Not required for quiz
      }
    } else if (type === 'homework') {
      document.getElementById('editHomeworkContentSection').style.display = 'block';
      if (contentUrlInput) {
        contentUrlInput.required = false; // Not required for homework
      }
    } else if (type === 'zoom') {
      document.getElementById('editZoomContentSection').style.display = 'block';
      if (contentUrlInput) {
        contentUrlInput.required = false; // Not required for zoom
      }
    }

    // Update submit button text and icon
    const btnIcon = document.getElementById('editContentBtnIcon');
    const btnText = document.getElementById('editContentBtnText');
    if (btnIcon && btnText) {
      if (type === 'quiz') {
        btnIcon.className = 'fas fa-clipboard-question me-2';
        btnText.textContent = 'Update Quiz';
      } else if (type === 'homework') {
        btnIcon.className = 'fas fa-tasks me-2';
        btnText.textContent = 'Update Homework';
      } else {
        btnIcon.className = 'fas fa-save me-2';
        btnText.textContent = 'Update Content';
      }
    }
  }

  function setupEditFileUpload() {
    const fileInput = document.getElementById('editContentFile');
    const preview = document.getElementById('editContentFilePreview');
    const progressContainer = document.getElementById('editContentFileProgress');
    const uploadedUrlInput = document.getElementById('editUploadedFileUrl');
    const contentUrlInput = document.getElementById('editContentUrl');

    if (fileInput && preview) {
      fileInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
          uploadEditFile(file, progressContainer, uploadedUrlInput, contentUrlInput, preview);
        }
      });
    }
  }

  function uploadEditFile(file, progressContainer, uploadedUrlInput, contentUrlInput, preview) {
    // Validate file type
    if (file.type !== 'application/pdf' && !file.name.toLowerCase().endsWith('.pdf')) {
      showNotification('Only PDF files are allowed', 'error');
      return;
    }

    // Validate file size (50MB limit)
    const maxSize = 50 * 1024 * 1024; // 50MB
    if (file.size > maxSize) {
      showNotification('File size must be less than 50MB', 'error');
      return;
    }

    // Show file info in preview
    if (preview) {
      preview.innerHTML = `
        <div class="file-info">
          <i class="fas fa-file-pdf" style="font-size: 3rem; color: #dc2626;"></i>
          <div class="file-details">
            <strong>${file.name}</strong>
            <small>${(file.size / 1024 / 1024).toFixed(2)} MB</small>
          </div>
        </div>
      `;
    }

    // Show progress
    if (progressContainer) {
      progressContainer.style.display = 'block';
      progressContainer.innerHTML = `
        <div class="progress">
          <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
        </div>
        <small class="d-block mt-2 text-center">Uploading PDF...</small>
      `;
    }

    // Create FormData
    const formData = new FormData();
    formData.append('pdf', file);

    // Upload PDF
    fetch('/admin/upload/pdf', {
      method: 'POST',
      body: formData
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        // Update hidden input and URL input
        if (uploadedUrlInput) {
          uploadedUrlInput.value = data.fileUrl;
        }
        if (contentUrlInput) {
          contentUrlInput.value = data.fileUrl;
        }

        // Show success
        if (progressContainer) {
          progressContainer.innerHTML = `
            <div class="alert alert-success">
              <i class="fas fa-check-circle"></i>
              PDF uploaded successfully!
            </div>
          `;
        }

        if (preview) {
          preview.innerHTML = `
            <div class="file-info">
              <i class="fas fa-file-pdf" style="font-size: 3rem; color: #10b981;"></i>
              <div class="file-details">
                <strong>${data.fileName}</strong>
                <small class="text-success">Uploaded successfully</small>
              </div>
            </div>
          `;
        }

        showNotification('PDF uploaded successfully!', 'success');

        // Hide progress after 3 seconds
        setTimeout(() => {
          if (progressContainer) {
            progressContainer.style.display = 'none';
          }
        }, 3000);
      } else {
        throw new Error(data.message || 'Upload failed');
      }
    })
    .catch(error => {
      console.error('Upload error:', error);
      showNotification('Error uploading PDF: ' + error.message, 'error');
      
      if (progressContainer) {
        progressContainer.innerHTML = `
          <div class="alert alert-danger">
            <i class="fas fa-exclamation-circle"></i>
            Upload failed: ${error.message}
          </div>
        `;
      }

      if (preview) {
        preview.innerHTML = `
          <div class="preview-overlay">
            <i class="fas fa-cloud-upload-alt"></i>
            <p>Click or drag to upload new file</p>
            <small>PDF files only</small>
          </div>
        `;
      }
    });
  }

  // Handle edit content submission - Updated to support all content types properly
  async function handleEditContentSubmission(topicId, contentId, modal) {
    const contentType = document.getElementById('editContentType').value;

    // Handle quiz content with AJAX
    if (contentType === 'quiz') {
      await submitEditQuizContent(topicId, contentId, modal);
      return;
    }

    // Handle homework content with AJAX
    if (contentType === 'homework') {
      await submitEditHomeworkContent(topicId, contentId, modal);
      return;
    }

    // Handle other content types with regular form submission
    const form = document.getElementById('editContentForm');
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());
    
    // Handle duration - only include if it has a value
    const durationValue = document.getElementById('editContentDuration')?.value;
    if (durationValue && durationValue.trim() !== '') {
      data.duration = parseInt(durationValue) || 0;
    } else {
      // Remove duration from data if empty, so backend keeps existing value
      delete data.duration;
    }

    // Handle maxWatchCount for video content - only include if explicitly changed
    if (data.type === 'video') {
      const maxWatchCountValue = document.getElementById('editMaxWatchCount')?.value;
      if (maxWatchCountValue !== undefined && maxWatchCountValue !== null && maxWatchCountValue.trim() !== '') {
        const parsedValue = parseInt(maxWatchCountValue);
        if (!isNaN(parsedValue)) {
          // If -1, send -1 to backend (will be converted to null for unlimited)
          data.maxWatchCount = parsedValue;
        } else {
          // Invalid value, remove from data to keep existing value
          delete data.maxWatchCount;
        }
      } else {
        // Empty field - remove from data to keep existing value (don't change it)
        delete data.maxWatchCount;
      }
    }

    // For zoom, set content to type name
    if (data.type === 'zoom') {
      data.content = 'zoom';
    }

    // Show loading state
    const submitBtn = document.getElementById('editContentSubmitBtn');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Updating...';
    submitBtn.disabled = true;

    try {
      const response = await fetch(`/admin/courses/<%= courseCode %>/topics/${topicId}/content/${contentId}`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
      });

      const result = await response.json();

      if (result.success) {
        modal.hide();
        showNotification('Content updated successfully!', 'success');
        setTimeout(() => {
          location.reload();
        }, 1000);
      } else {
        throw new Error(result.message || 'Failed to update content');
      }
    } catch (error) {
      console.error('Error:', error);
      showNotification('Error updating content: ' + error.message, 'error');
      submitBtn.innerHTML = originalText;
      submitBtn.disabled = false;
    }
  }

  // Submit Edit Quiz Content with multiple banks support
  async function submitEditQuizContent(topicId, contentId, modal) {
    try {
      const courseCode = '<%= course.courseCode %>';

      // Get current selections - use edit quiz variables
      const selectedBankIds = selectedEditQuizQuestionBankIds.length > 0 ? selectedEditQuizQuestionBankIds : (window.editContentData?.contentData?.questionBanks?.map(b => b._id) || []);
      const selectedQuestions = selectedEditQuizQuestions.length > 0 ? selectedEditQuizQuestions : (window.editContentData?.contentData?.selectedQuestions?.map(sq => ({
        question: sq.question?._id || sq.question,
        sourceBank: sq.sourceBank || selectedBankIds[0],
        points: sq.points || 1,
        order: sq.order || 1
      })) || []);

      // If no new selections, keep existing (don't require validation)
      const title = document.getElementById('editContentTitle').value.trim();
      if (!title) {
        showNotification('Please enter a title', 'error');
        return;
      }

      const prerequisitesValue = document.getElementById('editContentPrerequisites')?.value || '';

      const formData = {
        type: 'quiz',
        title: title,
        description: document.getElementById('editContentDescription').value.trim(),
        content: 'quiz',
        questionBanks: selectedBankIds.length > 0 ? selectedBankIds : undefined, // Only send if changed
        selectedQuestions: selectedQuestions.length > 0 ? selectedQuestions : undefined, // Only send if changed
        quizDuration: parseInt(document.getElementById('editQuizDuration')?.value) || 30,
        quizPassingScore: (() => {
          const value = document.getElementById('editQuizPassingScore')?.value;
          return value !== null && value !== undefined && value !== '' ? parseInt(value) : 50;
        })(),
        quizMaxAttempts: parseInt(document.getElementById('editQuizMaxAttempts')?.value) || 3,
        quizShuffleQuestions: document.getElementById('editQuizShuffleQuestions')?.checked || false,
        quizShuffleOptions: document.getElementById('editQuizShuffleOptions')?.checked || false,
        quizShowCorrectAnswers: document.getElementById('editQuizShowCorrectAnswers')?.checked || false,
        quizShowResults: document.getElementById('editQuizShowResults')?.checked || false,
        quizInstructions: document.getElementById('editQuizInstructions')?.value.trim() || '',
        difficulty: document.getElementById('editContentDifficulty')?.value || 'beginner',
        tags: document.getElementById('editContentTags')?.value.split(',').map(t => t.trim()).filter(t => t) || [],
        prerequisites: prerequisitesValue || null,
        isRequired: document.getElementById('editIsRequired')?.checked || true,
        order: parseInt(document.getElementById('editContentOrder')?.value) || 1,
      };

      // Show loading
      showNotification('Updating quiz content...', 'info');
      const submitBtn = document.getElementById('editContentSubmitBtn');
      const originalText = submitBtn.innerHTML;
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Updating...';

      const response = await fetch(`/admin/courses/${courseCode}/topics/${topicId}/content/${contentId}`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(formData),
      });

      const data = await response.json();

      if (data.success) {
        showNotification('Quiz content updated successfully!', 'success');
        modal.hide();
        setTimeout(() => {
          location.reload();
        }, 1500);
      } else {
        showNotification(data.message || 'Failed to update quiz content', 'error');
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
      }
    } catch (error) {
      console.error('Error updating quiz content:', error);
      showNotification('Error updating quiz content: ' + error.message, 'error');
      const submitBtn = document.getElementById('editContentSubmitBtn');
      submitBtn.disabled = false;
      submitBtn.innerHTML = '<i class="fas fa-save me-2"></i>Update Content';
    }
  }

  // Submit Edit Homework Content with multiple banks support
  async function submitEditHomeworkContent(topicId, contentId, modal) {
    try {
      const courseCode = '<%= course.courseCode %>';

      // Get current selections - use edit homework variables
      const selectedBankIds = selectedEditHomeworkQuestionBankIds.length > 0 ? selectedEditHomeworkQuestionBankIds : (window.editContentData?.contentData?.questionBanks?.map(b => b._id) || []);
      const selectedQuestions = selectedEditHomeworkQuestions.length > 0 ? selectedEditHomeworkQuestions : (window.editContentData?.contentData?.selectedQuestions?.map(sq => ({
        question: sq.question?._id || sq.question,
        sourceBank: sq.sourceBank || selectedBankIds[0],
        points: sq.points || 1,
        order: sq.order || 1
      })) || []);

      // If no new selections, keep existing (don't require validation)
      const title = document.getElementById('editContentTitle').value.trim();
      if (!title) {
        showNotification('Please enter a title', 'error');
        return;
      }

      const prerequisitesValue = document.getElementById('editContentPrerequisites')?.value || '';

      const formData = {
        type: 'homework',
        title: title,
        description: document.getElementById('editContentDescription').value.trim(),
        content: 'homework',
        questionBanks: selectedBankIds.length > 0 ? selectedBankIds : undefined, // Only send if changed
        selectedQuestions: selectedQuestions.length > 0 ? selectedQuestions : undefined, // Only send if changed
        homeworkPassingScore: (() => {
          const value = document.getElementById('editHomeworkPassingScore')?.value;
          return value !== null && value !== undefined && value !== '' ? parseInt(value) : 0;
        })(),
        homeworkMaxAttempts: parseInt(document.getElementById('editHomeworkMaxAttempts')?.value) || 1,
        homeworkShuffleQuestions: document.getElementById('editHomeworkShuffleQuestions')?.checked || false,
        homeworkShuffleOptions: document.getElementById('editHomeworkShuffleOptions')?.checked || false,
        homeworkShowCorrectAnswers: document.getElementById('editHomeworkShowCorrectAnswers')?.checked || false,
        homeworkInstructions: document.getElementById('editHomeworkInstructions')?.value.trim() || '',
        difficulty: document.getElementById('editContentDifficulty')?.value || 'beginner',
        tags: document.getElementById('editContentTags')?.value.split(',').map(t => t.trim()).filter(t => t) || [],
        prerequisites: prerequisitesValue || null,
        isRequired: document.getElementById('editIsRequired')?.checked || true,
        order: parseInt(document.getElementById('editContentOrder')?.value) || 1,
      };

      // Show loading
      showNotification('Updating homework content...', 'info');
      const submitBtn = document.getElementById('editContentSubmitBtn');
      const originalText = submitBtn.innerHTML;
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Updating...';

      const response = await fetch(`/admin/courses/${courseCode}/topics/${topicId}/content/${contentId}`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(formData),
      });

      const data = await response.json();

      if (data.success) {
        showNotification('Homework content updated successfully!', 'success');
        modal.hide();
        setTimeout(() => {
          location.reload();
        }, 1500);
      } else {
        showNotification(data.message || 'Failed to update homework content', 'error');
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
      }
    } catch (error) {
      console.error('Error updating homework content:', error);
      showNotification('Error updating homework content: ' + error.message, 'error');
      const submitBtn = document.getElementById('editContentSubmitBtn');
      submitBtn.disabled = false;
      submitBtn.innerHTML = '<i class="fas fa-save me-2"></i>Update Content';
    }
  }

  // Edit Quiz and Homework Variables
  let currentEditQuizStep = 1;
  let currentEditHomeworkStep = 1;
  let selectedEditQuizQuestionBankIds = [];
  let selectedEditHomeworkQuestionBankIds = [];
  let editQuizQuestions = [];
  let editHomeworkQuestions = [];
  let selectedEditQuizQuestions = [];
  let selectedEditHomeworkQuestions = [];
  let editQuizBankInfoMap = {};
  let editHomeworkBankInfoMap = {};
  window.currentEditQuizBankFilter = 'all';
  window.currentEditHomeworkBankFilter = 'all';

  // Initialize Edit Quiz Functionality with full editing support
  function initializeEditQuizFunctionality(contentData) {
    // Initialize edit quiz variables
    currentEditQuizStep = 1;
    selectedEditQuizQuestionBankIds = [];
    editQuizQuestions = [];
    selectedEditQuizQuestions = [];
    editQuizBankInfoMap = {};
    window.currentEditQuizBankFilter = 'all';

    // Get existing question banks - convert IDs to strings for proper comparison
    if (contentData.questionBanks && contentData.questionBanks.length > 0) {
      selectedEditQuizQuestionBankIds = contentData.questionBanks.map(b => String(b._id));
    } else if (contentData.questionBank) {
      selectedEditQuizQuestionBankIds = [String(contentData.questionBank._id)];
    }

    console.log('Edit Quiz - Selected Bank IDs:', selectedEditQuizQuestionBankIds);

    // Get existing selected questions - convert IDs to strings
    if (contentData.selectedQuestions && contentData.selectedQuestions.length > 0) {
      selectedEditQuizQuestions = contentData.selectedQuestions.map(sq => ({
        question: String(sq.question?._id || sq.question),
        sourceBank: String(sq.sourceBank || selectedEditQuizQuestionBankIds[0] || ''),
        points: sq.points || 1,
        order: sq.order || 1
      }));
      console.log('Edit Quiz - Selected Questions:', selectedEditQuizQuestions);
    }

    // Load question banks and initialize
    loadEditQuizQuestionBanks(contentData).then(() => {
      // After banks are loaded, automatically load questions if banks exist
      if (selectedEditQuizQuestionBankIds.length > 0) {
        setTimeout(() => {
          loadEditQuizQuestions();
        }, 500); // Small delay to ensure UI is updated
      }
    });

    // Update step display
    updateEditQuizStepDisplay();
  }

  // Initialize Edit Homework Functionality with full editing support
  function initializeEditHomeworkFunctionality(contentData) {
    // Initialize edit homework variables
    currentEditHomeworkStep = 1;
    selectedEditHomeworkQuestionBankIds = [];
    editHomeworkQuestions = [];
    selectedEditHomeworkQuestions = [];
    editHomeworkBankInfoMap = {};
    window.currentEditHomeworkBankFilter = 'all';

    // Get existing question banks - convert IDs to strings for proper comparison
    if (contentData.questionBanks && contentData.questionBanks.length > 0) {
      selectedEditHomeworkQuestionBankIds = contentData.questionBanks.map(b => String(b._id));
    } else if (contentData.questionBank) {
      selectedEditHomeworkQuestionBankIds = [String(contentData.questionBank._id)];
    }

    console.log('Edit Homework - Selected Bank IDs:', selectedEditHomeworkQuestionBankIds);

    // Get existing selected questions - convert IDs to strings
    if (contentData.selectedQuestions && contentData.selectedQuestions.length > 0) {
      selectedEditHomeworkQuestions = contentData.selectedQuestions.map(sq => ({
        question: String(sq.question?._id || sq.question),
        sourceBank: String(sq.sourceBank || selectedEditHomeworkQuestionBankIds[0] || ''),
        points: sq.points || 1,
        order: sq.order || 1
      }));
      console.log('Edit Homework - Selected Questions:', selectedEditHomeworkQuestions);
    }

    // Load question banks and initialize
    loadEditHomeworkQuestionBanks(contentData).then(() => {
      // After banks are loaded, automatically load questions if banks exist
      if (selectedEditHomeworkQuestionBankIds.length > 0) {
        setTimeout(() => {
          loadEditHomeworkQuestions();
        }, 500); // Small delay to ensure UI is updated
      }
    });

    // Update step display
    updateEditHomeworkStepDisplay();
  }

  // Load Edit Quiz Question Banks with multiple selection support
  async function loadEditQuizQuestionBanks(contentData) {
    try {
      // Get topicId from editContentData
      const topicId = window.editContentData?.topicId;
      if (!topicId) {
        console.error('Topic ID not found in editContentData');
        return;
      }

      const response = await fetch(`/admin/courses/<%= courseCode %>/topics/${topicId}/question-banks`);
      const data = await response.json();

      if (data.success && data.questionBanks) {
        const grid = document.getElementById('editQuizQuestionBanksGrid');
        const noBanksMsg = document.getElementById('editNoQuizQuestionBanksMessage');

        if (grid && data.questionBanks.length > 0) {
          grid.innerHTML = data.questionBanks.map(bank => {
            // Convert both IDs to strings for comparison
            const bankIdStr = String(bank._id);
            const isSelected = selectedEditQuizQuestionBankIds.includes(bankIdStr);
            console.log(`Bank ${bank.name} (${bankIdStr}): isSelected = ${isSelected}`, selectedEditQuizQuestionBankIds);
            return `
              <div class="bank-card-enhanced ${isSelected ? 'selected' : ''}" 
                   data-bank-id="${bankIdStr}" 
                   data-questions="${bank.totalQuestions || 0}" 
                   onclick="toggleEditQuizBankSelection('${bankIdStr}')">
                <div class="bank-card-enhanced-content">
                  <div class="bank-card-checkbox">
                    <input type="checkbox" ${isSelected ? 'checked' : ''} onchange="toggleEditQuizBankSelection('${bankIdStr}')">
                  </div>
                  <div class="bank-card-body">
                    <h6>${bank.name}</h6>
                    <span class="bank-code">${bank.bankCode}</span>
                  <p class="bank-description">${bank.description || 'No description'}</p>
                  <div class="bank-stats">
                      <span class="badge bg-primary">${bank.totalQuestions || 0} questions</span>
                  </div>
                </div>
              </div>
              </div>
            `;
          }).join('');

          updateEditQuizSelectedBanksCount();
          if (noBanksMsg) noBanksMsg.style.display = 'none';
        } else {
          if (noBanksMsg) noBanksMsg.style.display = 'block';
        }
      } else {
        if (noBanksMsg) noBanksMsg.style.display = 'block';
      }
    } catch (error) {
      console.error('Error loading question banks:', error);
      const noBanksMsg = document.getElementById('editNoQuizQuestionBanksMessage');
      if (noBanksMsg) noBanksMsg.style.display = 'block';
    }
  }

  // Toggle Edit Quiz Bank Selection
  function toggleEditQuizBankSelection(bankId) {
    const bankIdStr = String(bankId);
    const index = selectedEditQuizQuestionBankIds.indexOf(bankIdStr);
    if (index > -1) {
      selectedEditQuizQuestionBankIds.splice(index, 1);
    } else {
      selectedEditQuizQuestionBankIds.push(bankIdStr);
    }

    // Update UI
    const bankCard = document.querySelector(`#editQuizQuestionBanksGrid [data-bank-id="${bankIdStr}"]`);
    if (bankCard) {
      bankCard.classList.toggle('selected');
      const checkbox = bankCard.querySelector('input[type="checkbox"]');
      if (checkbox) checkbox.checked = !checkbox.checked;
    }

    updateEditQuizSelectedBanksCount();

    // Automatically load questions when banks are selected
    if (selectedEditQuizQuestionBankIds.length > 0) {
      loadEditQuizQuestions();
    } else {
      // Clear questions if no banks selected
      editQuizQuestions = [];
      displayEditQuizQuestions({});
    }
  }

  // Update Edit Quiz Selected Banks Count
  function updateEditQuizSelectedBanksCount() {
    const countElement = document.getElementById('editQuizSelectedBanksCount');
    if (countElement) {
      countElement.textContent = `(${selectedEditQuizQuestionBankIds.length} selected)`;
    }
  }

  // Load Edit Homework Question Banks with multiple selection support
  async function loadEditHomeworkQuestionBanks(contentData) {
    try {
      // Get topicId from editContentData
      const topicId = window.editContentData?.topicId;
      if (!topicId) {
        console.error('Topic ID not found in editContentData');
        return;
      }

      const response = await fetch(`/admin/courses/<%= courseCode %>/topics/${topicId}/question-banks`);
      const data = await response.json();

      if (data.success && data.questionBanks) {
        const grid = document.getElementById('editHomeworkQuestionBanksGrid');
        const noBanksMsg = document.getElementById('editNoHomeworkQuestionBanksMessage');

        if (grid && data.questionBanks.length > 0) {
          grid.innerHTML = data.questionBanks.map(bank => {
            // Convert both IDs to strings for comparison
            const bankIdStr = String(bank._id);
            const isSelected = selectedEditHomeworkQuestionBankIds.includes(bankIdStr);
            console.log(`Bank ${bank.name} (${bankIdStr}): isSelected = ${isSelected}`, selectedEditHomeworkQuestionBankIds);
            return `
              <div class="bank-card-enhanced ${isSelected ? 'selected' : ''}" 
                   data-bank-id="${bankIdStr}" 
                   data-questions="${bank.totalQuestions || 0}" 
                   onclick="toggleEditHomeworkBankSelection('${bankIdStr}')">
                <div class="bank-card-enhanced-content">
                  <div class="bank-card-checkbox">
                    <input type="checkbox" ${isSelected ? 'checked' : ''} onchange="toggleEditHomeworkBankSelection('${bankIdStr}')">
                  </div>
                  <div class="bank-card-body">
                    <h6>${bank.name}</h6>
                    <span class="bank-code">${bank.bankCode}</span>
                  <p class="bank-description">${bank.description || 'No description'}</p>
                  <div class="bank-stats">
                      <span class="badge bg-primary">${bank.totalQuestions || 0} questions</span>
                  </div>
                </div>
              </div>
              </div>
            `;
          }).join('');

          updateEditHomeworkSelectedBanksCount();
          if (noBanksMsg) noBanksMsg.style.display = 'none';
        } else {
          if (noBanksMsg) noBanksMsg.style.display = 'block';
        }
      } else {
        if (noBanksMsg) noBanksMsg.style.display = 'block';
      }
    } catch (error) {
      console.error('Error loading question banks:', error);
      const noBanksMsg = document.getElementById('editNoHomeworkQuestionBanksMessage');
      if (noBanksMsg) noBanksMsg.style.display = 'block';
    }
  }

  // Toggle Edit Homework Bank Selection
  function toggleEditHomeworkBankSelection(bankId) {
    const bankIdStr = String(bankId);
    const index = selectedEditHomeworkQuestionBankIds.indexOf(bankIdStr);
    if (index > -1) {
      selectedEditHomeworkQuestionBankIds.splice(index, 1);
    } else {
      selectedEditHomeworkQuestionBankIds.push(bankIdStr);
    }

    // Update UI
    const bankCard = document.querySelector(`#editHomeworkQuestionBanksGrid [data-bank-id="${bankIdStr}"]`);
    if (bankCard) {
      bankCard.classList.toggle('selected');
      const checkbox = bankCard.querySelector('input[type="checkbox"]');
      if (checkbox) checkbox.checked = !checkbox.checked;
    }

    updateEditHomeworkSelectedBanksCount();

    // Automatically load questions when banks are selected
    if (selectedEditHomeworkQuestionBankIds.length > 0) {
      loadEditHomeworkQuestions();
    } else {
      // Clear questions if no banks selected
      editHomeworkQuestions = [];
      displayEditHomeworkQuestions({});
    }
  }

  // Update Edit Homework Selected Banks Count
  function updateEditHomeworkSelectedBanksCount() {
    const countElement = document.getElementById('editHomeworkSelectedBanksCount');
    if (countElement) {
      countElement.textContent = `(${selectedEditHomeworkQuestionBankIds.length} selected)`;
    }
  }

  // Edit Quiz Step Navigation Functions
  function nextEditQuizStep() {
    if (currentEditQuizStep < 3) {
      currentEditQuizStep++;
      updateEditQuizStepDisplay();
    }
  }

  function prevEditQuizStep() {
    if (currentEditQuizStep > 1) {
      currentEditQuizStep--;
      updateEditQuizStepDisplay();
    }
  }

  function updateEditQuizStepDisplay() {
    // Update step indicators
    document.querySelectorAll('#editQuizContentSection .quiz-step').forEach((step, index) => {
      if (index + 1 <= currentEditQuizStep) {
        step.classList.add('active');
      } else {
        step.classList.remove('active');
      }
    });

    // Update step content visibility
    document.querySelectorAll('#editQuizContentSection .quiz-step-content').forEach((content, index) => {
      content.style.display = index + 1 === currentEditQuizStep ? 'block' : 'none';
    });

    // Update navigation buttons
    const prevBtn = document.getElementById('editQuizPrevBtn');
    const nextBtn = document.getElementById('editQuizNextBtn');
    const stepNumber = document.getElementById('editQuizCurrentStepNumber');

    if (prevBtn) prevBtn.disabled = currentEditQuizStep === 1;
    if (nextBtn) nextBtn.disabled = currentEditQuizStep === 3;
    if (stepNumber) stepNumber.textContent = currentEditQuizStep;
  }

  // Edit Homework Step Navigation Functions
  function nextEditHomeworkStep() {
    if (currentEditHomeworkStep < 3) {
      currentEditHomeworkStep++;
      updateEditHomeworkStepDisplay();
    }
  }

  function prevEditHomeworkStep() {
    if (currentEditHomeworkStep > 1) {
      currentEditHomeworkStep--;
      updateEditHomeworkStepDisplay();
    }
  }

  function updateEditHomeworkStepDisplay() {
    // Update step indicators
    document.querySelectorAll('#editHomeworkContentSection .homework-step').forEach((step, index) => {
      if (index + 1 <= currentEditHomeworkStep) {
        step.classList.add('active');
      } else {
        step.classList.remove('active');
      }
    });

    // Update step content visibility
    document.querySelectorAll('#editHomeworkContentSection .homework-step-content').forEach((content, index) => {
      content.style.display = index + 1 === currentEditHomeworkStep ? 'block' : 'none';
    });

    // Update navigation buttons
    const prevBtn = document.getElementById('editHomeworkPrevBtn');
    const nextBtn = document.getElementById('editHomeworkNextBtn');
    const stepNumber = document.getElementById('editHomeworkCurrentStepNumber');

    if (prevBtn) prevBtn.disabled = currentEditHomeworkStep === 1;
    if (nextBtn) nextBtn.disabled = currentEditHomeworkStep === 3;
    if (stepNumber) stepNumber.textContent = currentEditHomeworkStep;
  }

  // Load Edit Quiz Questions from Multiple Banks
  async function loadEditQuizQuestions() {
    if (selectedEditQuizQuestionBankIds.length === 0) {
      editQuizQuestions = [];
      displayEditQuizQuestions({});
      return;
    }

    try {
      // Show loading state
      const questionsGrid = document.getElementById('editQuizQuestionsGrid');
      if (questionsGrid) {
        questionsGrid.innerHTML = '<div class="text-center py-4"><i class="fas fa-spinner fa-spin fa-2x"></i><p class="mt-2">Loading questions...</p></div>';
      }

      // Get topicId from editContentData
      const topicId = window.editContentData?.topicId;
      if (!topicId) {
        showNotification('Topic ID not found', 'error');
        return;
      }

      const response = await fetch(`/admin/courses/<%= courseCode %>/topics/${topicId}/question-banks/multiple/questions`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          bankIds: selectedEditQuizQuestionBankIds
        })
      });

      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }

      const contentType = response.headers.get('content-type');
      if (!contentType || !contentType.includes('application/json')) {
        const text = await response.text();
        console.error('Edit Quiz - Non-JSON response:', text);
        throw new Error('Server returned non-JSON response');
      }

      const result = await response.json();
      console.log('Edit Quiz - Questions API Response:', result);

      if (result.success && result.questionsByBank) {
        editQuizQuestions = [];
        editQuizBankInfoMap = {};

        // Handle the nested structure: { bankId: { bankInfo: {...}, questions: [...] } }
        Object.entries(result.questionsByBank).forEach(([bankId, bankData]) => {
          // Handle both nested structure { bankInfo: {...}, questions: [...] } and flat structure { questions: [...] }
          let bankInfo = {};
          let questions = [];

          if (bankData.bankInfo) {
            // Nested structure
            bankInfo = bankData.bankInfo || {};
            questions = bankData.questions || [];
          } else if (Array.isArray(bankData)) {
            // Flat structure - just array of questions
            questions = bankData;
            // Try to get bank info from the bank card or use bankId
            const bankCard = document.querySelector(`#editQuizQuestionBanksGrid [data-bank-id="${bankId}"]`);
            if (bankCard) {
              bankInfo = {
                name: bankCard.querySelector('h6')?.textContent || 'Unknown Bank',
                bankCode: bankCard.querySelector('.bank-code')?.textContent || bankId
              };
            }
          }

          editQuizBankInfoMap[bankId] = {
            name: bankInfo.name || 'Unknown Bank',
            code: bankInfo.bankCode || bankId
          };

          questions.forEach(q => {
            if (q && q._id) {
              editQuizQuestions.push({
                ...q,
                _id: q._id,
                sourceBank: bankId
              });
            }
          });
        });

        console.log('Edit Quiz - Processed Questions:', editQuizQuestions.length);
        console.log('Edit Quiz - Loaded Questions:', editQuizQuestions.length);
        console.log('Edit Quiz - Selected Questions:', selectedEditQuizQuestions.length);

        // Ensure questions are in the array before displaying
        if (editQuizQuestions.length === 0) {
          console.warn('Edit Quiz - No questions were added to the array!');
          showNotification('No questions found in selected banks', 'warning');
          const questionsGrid = document.getElementById('editQuizQuestionsGrid');
          if (questionsGrid) {
            questionsGrid.innerHTML = '';
          }
          const noQuestionsMsg = document.getElementById('editNoQuizQuestionsMessage');
          if (noQuestionsMsg) noQuestionsMsg.style.display = 'block';
          return;
        }

        // Create a flat structure for display (for compatibility)
        const flatQuestionsByBank = {};
        Object.entries(result.questionsByBank).forEach(([bankId, bankData]) => {
          const questions = bankData.questions || (Array.isArray(bankData) ? bankData : []);
          flatQuestionsByBank[bankId] = questions;
        });

        // Display questions - use the populated editQuizQuestions array directly
        console.log('Edit Quiz - About to display questions. Array length:', editQuizQuestions.length);
        displayEditQuizQuestions(flatQuestionsByBank);

        // Immediately verify and update UI
        const questionsGrid = document.getElementById('editQuizQuestionsGrid');
        const noQuestionsMsg = document.getElementById('editNoQuizQuestionsMessage');

        // Force hide loading and no questions message
        if (questionsGrid) {
          // Remove any loading spinner
          const loadingDiv = questionsGrid.querySelector('.fa-spinner');
          if (loadingDiv) {
            loadingDiv.closest('div').remove();
          }
        }

        if (noQuestionsMsg) {
          noQuestionsMsg.style.display = 'none';
        }

        // Verify questions were displayed and update UI
        setTimeout(() => {
          const displayedQuestions = questionsGrid ? questionsGrid.querySelectorAll('.question-item').length : 0;
          console.log('Edit Quiz - Questions displayed in UI:', displayedQuestions);

          if (displayedQuestions === 0 && editQuizQuestions.length > 0) {
            console.error('Edit Quiz - Questions not displayed! Forcing display...');
            // Force display again
            displayEditQuizQuestions(flatQuestionsByBank);
          }

          updateEditQuizSelectionSummary();

          // If we're on step 1 and questions loaded, automatically move to step 2
          if (currentEditQuizStep === 1 && editQuizQuestions.length > 0) {
            currentEditQuizStep = 2;
            updateEditQuizStepDisplay();
          }
        }, 200);

        showNotification(`Loaded ${editQuizQuestions.length} questions from ${selectedEditQuizQuestionBankIds.length} bank(s)`, 'success');
      } else {
        console.error('Edit Quiz - Failed to load questions:', result);
        showNotification(result.message || 'Failed to load questions', 'error');
        editQuizQuestions = [];
        displayEditQuizQuestions({});
        updateEditQuizSelectionSummary();
      }
    } catch (error) {
      console.error('Error loading questions:', error);
      showNotification('An error occurred while loading questions', 'error');
      editQuizQuestions = [];
      displayEditQuizQuestions({});
    }
  }

  // Load Edit Homework Questions from Multiple Banks
  async function loadEditHomeworkQuestions() {
    if (selectedEditHomeworkQuestionBankIds.length === 0) {
      editHomeworkQuestions = [];
      displayEditHomeworkQuestions({});
      return;
    }

    try {
      // Show loading state
      const questionsGrid = document.getElementById('editHomeworkQuestionsGrid');
      if (questionsGrid) {
        questionsGrid.innerHTML = '<div class="text-center py-4"><i class="fas fa-spinner fa-spin fa-2x"></i><p class="mt-2">Loading questions...</p></div>';
      }

      // Get topicId from editContentData
      const topicId = window.editContentData?.topicId;
      if (!topicId) {
        showNotification('Topic ID not found', 'error');
        return;
      }

      const response = await fetch(`/admin/courses/<%= courseCode %>/topics/${topicId}/question-banks/multiple/questions`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          bankIds: selectedEditHomeworkQuestionBankIds
        })
      });

      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }

      const contentType = response.headers.get('content-type');
      if (!contentType || !contentType.includes('application/json')) {
        const text = await response.text();
        console.error('Edit Homework - Non-JSON response:', text);
        throw new Error('Server returned non-JSON response');
      }

      const result = await response.json();
      console.log('Edit Homework - Questions API Response:', result);

      if (result.success && result.questionsByBank) {
        editHomeworkQuestions = [];
        editHomeworkBankInfoMap = {};

        // Handle the nested structure: { bankId: { bankInfo: {...}, questions: [...] } }
        Object.entries(result.questionsByBank).forEach(([bankId, bankData]) => {
          // Handle both nested structure { bankInfo: {...}, questions: [...] } and flat structure { questions: [...] }
          let bankInfo = {};
          let questions = [];

          if (bankData.bankInfo) {
            // Nested structure
            bankInfo = bankData.bankInfo || {};
            questions = bankData.questions || [];
          } else if (Array.isArray(bankData)) {
            // Flat structure - just array of questions
            questions = bankData;
            // Try to get bank info from the bank card or use bankId
            const bankCard = document.querySelector(`#editHomeworkQuestionBanksGrid [data-bank-id="${bankId}"]`);
            if (bankCard) {
              bankInfo = {
                name: bankCard.querySelector('h6')?.textContent || 'Unknown Bank',
                bankCode: bankCard.querySelector('.bank-code')?.textContent || bankId
              };
            }
          }

          editHomeworkBankInfoMap[bankId] = {
            name: bankInfo.name || 'Unknown Bank',
            code: bankInfo.bankCode || bankId
          };

          questions.forEach(q => {
            if (q && q._id) {
              editHomeworkQuestions.push({
                ...q,
                _id: q._id,
                sourceBank: bankId
              });
            }
          });
        });

        console.log('Edit Homework - Processed Questions:', editHomeworkQuestions.length);
        console.log('Edit Homework - Loaded Questions:', editHomeworkQuestions.length);
        console.log('Edit Homework - Selected Questions:', selectedEditHomeworkQuestions.length);

        // Ensure questions are in the array before displaying
        if (editHomeworkQuestions.length === 0) {
          console.warn('Edit Homework - No questions were added to the array!');
          showNotification('No questions found in selected banks', 'warning');
          const questionsGrid = document.getElementById('editHomeworkQuestionsGrid');
          if (questionsGrid) {
            questionsGrid.innerHTML = '';
          }
          const noQuestionsMsg = document.getElementById('editNoHomeworkQuestionsMessage');
          if (noQuestionsMsg) noQuestionsMsg.style.display = 'block';
          return;
        }

        // Create a flat structure for display (for compatibility)
        const flatQuestionsByBank = {};
        Object.entries(result.questionsByBank).forEach(([bankId, bankData]) => {
          const questions = bankData.questions || (Array.isArray(bankData) ? bankData : []);
          flatQuestionsByBank[bankId] = questions;
        });

        // Display questions - use the populated editHomeworkQuestions array directly
        console.log('Edit Homework - About to display questions. Array length:', editHomeworkQuestions.length);
        console.log('Edit Homework - Questions array before display:', editHomeworkQuestions.slice(0, 3));

        // Call display function - it will use editHomeworkQuestions array
        displayEditHomeworkQuestions(flatQuestionsByBank);

        // Immediately verify and update UI
        const questionsGrid = document.getElementById('editHomeworkQuestionsGrid');
        const noQuestionsMsg = document.getElementById('editNoHomeworkQuestionsMessage');

        // Force hide loading and no questions message
        if (questionsGrid) {
          // Remove any loading spinner
          const loadingDiv = questionsGrid.querySelector('.fa-spinner');
          if (loadingDiv) {
            loadingDiv.closest('div').remove();
          }
        }

        if (noQuestionsMsg) {
          noQuestionsMsg.style.display = 'none';
        }

        // Verify questions were displayed and update UI
        setTimeout(() => {
          const displayedQuestions = questionsGrid ? questionsGrid.querySelectorAll('.question-item').length : 0;
          console.log('Edit Homework - Questions displayed in UI:', displayedQuestions);

          if (displayedQuestions === 0 && editHomeworkQuestions.length > 0) {
            console.error('Edit Homework - Questions not displayed! Forcing display...');
            // Force display again
            displayEditHomeworkQuestions(flatQuestionsByBank);
          }

          updateEditHomeworkSelectionSummary();

          // If we're on step 1 and questions loaded, automatically move to step 2
          if (currentEditHomeworkStep === 1 && editHomeworkQuestions.length > 0) {
            currentEditHomeworkStep = 2;
            updateEditHomeworkStepDisplay();
          }
        }, 200);

        showNotification(`Loaded ${editHomeworkQuestions.length} questions from ${selectedEditHomeworkQuestionBankIds.length} bank(s)`, 'success');
      } else {
        console.error('Edit Homework - Failed to load questions:', result);
        showNotification(result.message || 'Failed to load questions', 'error');
        editHomeworkQuestions = [];
        displayEditHomeworkQuestions({});
        updateEditHomeworkSelectionSummary();
      }
    } catch (error) {
      console.error('Error loading questions:', error);
      showNotification('An error occurred while loading questions', 'error');
      editHomeworkQuestions = [];
      displayEditHomeworkQuestions({});
    }
  }

  // Display Edit Quiz Questions
  function displayEditQuizQuestions(questionsByBank) {
    const questionsGrid = document.getElementById('editQuizQuestionsGrid');
    const noQuestionsMsg = document.getElementById('editNoQuizQuestionsMessage');

    if (!questionsGrid) {
      console.error('Edit Quiz Questions Grid not found');
      return;
    }

    // Ensure arrays are initialized
    if (!editQuizQuestions || !Array.isArray(editQuizQuestions)) {
      editQuizQuestions = [];
    }
    if (!selectedEditQuizQuestions || !Array.isArray(selectedEditQuizQuestions)) {
      selectedEditQuizQuestions = [];
    }

    if (editQuizQuestions.length === 0) {
      questionsGrid.innerHTML = '';
      if (noQuestionsMsg) noQuestionsMsg.style.display = 'block';
      updateEditQuizSelectionSummary();
      return;
    }

    // Hide loading state and no questions message
    if (noQuestionsMsg) {
      noQuestionsMsg.style.display = 'none';
    }

    // Clear any loading spinner or existing content
    questionsGrid.innerHTML = '';

    // Get selected question IDs for marking - handle both object and string formats
    const selectedQuestionIds = selectedEditQuizQuestions.map(sq => {
      if (!sq) return null;
      // Handle both { question: "id" } and { question: { _id: "id" } } formats
      if (typeof sq.question === 'string') {
        return sq.question;
      } else if (sq.question && sq.question._id) {
        return String(sq.question._id);
      } else if (sq.question) {
        return String(sq.question);
      }
      return null;
    }).filter(id => id !== null);

    console.log('Edit Quiz - Displaying questions. Total:', editQuizQuestions.length, 'Selected IDs:', selectedQuestionIds.length);
    console.log('Edit Quiz - First few questions:', editQuizQuestions.slice(0, 3));

    // Render questions using the same structure as create modal
    let questionHTML = '';
    editQuizQuestions.forEach((question, index) => {
      const questionIdStr = String(question._id);
      const isSelected = selectedQuestionIds.includes(questionIdStr);
      const bankInfo = editQuizBankInfoMap[question.sourceBank] || {
        name: 'Unknown Bank',
        code: ''
      };
      const difficultyClass = (question.difficulty || 'medium').toLowerCase();

      const questionTags = question.tags || [];
      const tagsJson = JSON.stringify(questionTags);
      
      questionHTML += `
        <div class="question-item ${difficultyClass} ${isSelected ? 'selected' : ''}" 
             onclick="toggleEditQuizQuestionSelection('${questionIdStr}')" 
             data-question-index="${index}"
             data-bank-id="${question.sourceBank}"
             data-question-id="${questionIdStr}"
             data-tags='${tagsJson}'>
          <div class="question-item-top">
            <div class="question-item-number">${index + 1}</div>
            <button type="button" class="question-preview-btn" onclick="event.stopPropagation(); previewEditQuizQuestion(${index})" title="Preview Question">
              <i class="fas fa-eye"></i>
            </button>
          </div>
          <div class="question-item-content">
            <div class="question-item-header">
              <div class="question-item-bank">
                <i class="fas fa-database"></i>
                <span>${bankInfo.name || bankInfo.code || 'Unknown Bank'}</span>
              </div>
            </div>
            <div class="question-item-footer">
              <span class="question-badge type-badge">${question.questionType || question.type || 'MCQ'}</span>
            </div>
          </div>
          <div class="question-check-indicator">
            <i class="fas fa-check-circle"></i>
          </div>
        </div>
      `;
    });

    // Set the HTML
    questionsGrid.innerHTML = questionHTML;

    console.log('Edit Quiz - Questions HTML generated. Length:', questionHTML.length);
    console.log('Edit Quiz - Questions in DOM:', questionsGrid.querySelectorAll('.question-item').length);

    // Ensure no questions message is hidden
    if (noQuestionsMsg) {
      noQuestionsMsg.style.display = 'none';
    }

    // Update bank filter buttons
    updateEditQuizBankFilterButtons();
    
    // Populate tags filter
    populateTagsFilter('editQuizTagsFilter', editQuizQuestions);

    // Update selection summary after displaying questions
    updateEditQuizSelectionSummary();

    // Force a reflow to ensure UI updates
    questionsGrid.offsetHeight;
  }

  // Display Edit Homework Questions
  function displayEditHomeworkQuestions(questionsByBank) {
    const questionsGrid = document.getElementById('editHomeworkQuestionsGrid');
    const noQuestionsMsg = document.getElementById('editNoHomeworkQuestionsMessage');

    if (!questionsGrid) {
      console.error('Edit Homework Questions Grid not found');
      return;
    }

    // Ensure arrays are initialized
    if (!editHomeworkQuestions || !Array.isArray(editHomeworkQuestions)) {
      editHomeworkQuestions = [];
    }
    if (!selectedEditHomeworkQuestions || !Array.isArray(selectedEditHomeworkQuestions)) {
      selectedEditHomeworkQuestions = [];
    }

    console.log('Edit Homework - Display function called. Questions array length:', editHomeworkQuestions.length);
    console.log('Edit Homework - Questions array:', editHomeworkQuestions);

    if (editHomeworkQuestions.length === 0) {
      console.warn('Edit Homework - No questions in array, showing empty message');
      questionsGrid.innerHTML = '';
      if (noQuestionsMsg) noQuestionsMsg.style.display = 'block';
      updateEditHomeworkSelectionSummary();
      return;
    }

    // Hide loading state and no questions message
    if (noQuestionsMsg) {
      noQuestionsMsg.style.display = 'none';
    }

    // Clear any loading spinner or existing content
    questionsGrid.innerHTML = '';

    // Get selected question IDs for marking - handle both object and string formats
    const selectedQuestionIds = selectedEditHomeworkQuestions.map(sq => {
      if (!sq) return null;
      // Handle both { question: "id" } and { question: { _id: "id" } } formats
      if (typeof sq.question === 'string') {
        return sq.question;
      } else if (sq.question && sq.question._id) {
        return String(sq.question._id);
      } else if (sq.question) {
        return String(sq.question);
      }
      return null;
    }).filter(id => id !== null);

    console.log('Edit Homework - Displaying questions. Total:', editHomeworkQuestions.length, 'Selected IDs:', selectedQuestionIds.length);
    console.log('Edit Homework - First few questions:', editHomeworkQuestions.slice(0, 3));

    // Render questions using the same structure as create modal
    let questionHTML = '';
    editHomeworkQuestions.forEach((question, index) => {
      const questionIdStr = String(question._id);
      const isSelected = selectedQuestionIds.includes(questionIdStr);
      const bankInfo = editHomeworkBankInfoMap[question.sourceBank] || {
        name: 'Unknown Bank',
        code: ''
      };
      const difficultyClass = (question.difficulty || 'medium').toLowerCase();

      const questionTags = question.tags || [];
      const tagsJson = JSON.stringify(questionTags);
      
      questionHTML += `
        <div class="question-item ${difficultyClass} ${isSelected ? 'selected' : ''}" 
             onclick="toggleEditHomeworkQuestionSelection('${questionIdStr}')" 
             data-question-index="${index}"
             data-bank-id="${question.sourceBank}"
             data-question-id="${questionIdStr}"
             data-tags='${tagsJson}'>
          <div class="question-item-top">
            <div class="question-item-number">${index + 1}</div>
            <button type="button" class="question-preview-btn" onclick="event.stopPropagation(); previewEditHomeworkQuestion(${index})" title="Preview Question">
              <i class="fas fa-eye"></i>
            </button>
          </div>
          <div class="question-item-content">
            <div class="question-item-header">
              <div class="question-item-bank">
                <i class="fas fa-database"></i>
                <span>${bankInfo.name || bankInfo.code || 'Unknown Bank'}</span>
              </div>
            </div>
            <div class="question-item-footer">
              <span class="question-badge type-badge">${question.questionType || question.type || 'MCQ'}</span>
            </div>
          </div>
          <div class="question-check-indicator">
            <i class="fas fa-check-circle"></i>
          </div>
        </div>
      `;
    });

    // Set the HTML
    questionsGrid.innerHTML = questionHTML;

    console.log('Edit Homework - Questions HTML generated. Length:', questionHTML.length);
    console.log('Edit Homework - Questions in DOM:', questionsGrid.querySelectorAll('.question-item').length);

    // Ensure no questions message is hidden
    if (noQuestionsMsg) {
      noQuestionsMsg.style.display = 'none';
    }

    // Update bank filter buttons
    updateEditHomeworkBankFilterButtons();
    
    // Populate tags filter
    populateTagsFilter('editHomeworkTagsFilter', editHomeworkQuestions);

    // Update selection summary after displaying questions
    updateEditHomeworkSelectionSummary();

    // Force a reflow to ensure UI updates
    questionsGrid.offsetHeight;
  }

  // Update Edit Quiz Selection Summary
  function updateEditQuizSelectionSummary() {
    try {
      // Check if selectedEditQuizQuestions is defined and is an array
      if (!selectedEditQuizQuestions || !Array.isArray(selectedEditQuizQuestions)) {
        selectedEditQuizQuestions = [];
      }

      // Use the length directly for count - this is the actual number of selected questions
      const count = selectedEditQuizQuestions.length;

      // For points and difficulty, try to find questions in editQuizQuestions, but use stored values as fallback
      let totalPoints = 0;
      let easyCount = 0;
      let mediumCount = 0;
      let hardCount = 0;

      // Check if editQuizQuestions is defined and is an array
      if (editQuizQuestions && Array.isArray(editQuizQuestions) && editQuizQuestions.length > 0) {
        const selectedQuestionIds = selectedEditQuizQuestions.map(sq => {
          if (!sq || !sq.question) return null;
          return String(sq.question);
        }).filter(id => id !== null);

        const selectedQuestions = editQuizQuestions.filter(q => {
          if (!q || !q._id) return false;
          return selectedQuestionIds.includes(String(q._id));
        });

        // Calculate from matched questions
        totalPoints = selectedQuestions.reduce((sum, q) => sum + (q.points || 1), 0);
        easyCount = selectedQuestions.filter(q => {
          const diff = (q.difficulty || '').toLowerCase();
          return diff === 'easy';
        }).length;
        mediumCount = selectedQuestions.filter(q => {
          const diff = (q.difficulty || '').toLowerCase();
          return diff === 'medium';
        }).length;
        hardCount = selectedQuestions.filter(q => {
          const diff = (q.difficulty || '').toLowerCase();
          return diff === 'hard';
        }).length;
      } else {
        // Fallback: use stored values from selectedEditQuizQuestions
        totalPoints = selectedEditQuizQuestions.reduce((sum, sq) => sum + (sq.points || 1), 0);
        // For difficulty, we'd need to store it in selectedEditQuizQuestions, but for now just use 0
      }

      const countElement = document.getElementById('editQuizSelectedCount');
      const pointsElement = document.getElementById('editQuizTotalPoints');
      const easyElement = document.getElementById('editQuizEasyCount');
      const mediumElement = document.getElementById('editQuizMediumCount');
      const hardElement = document.getElementById('editQuizHardCount');

      if (countElement) countElement.textContent = count;
      if (pointsElement) pointsElement.textContent = totalPoints;
      if (easyElement) easyElement.textContent = easyCount;
      if (mediumElement) mediumElement.textContent = mediumCount;
      if (hardElement) hardElement.textContent = hardCount;
    } catch (error) {
      console.error('Error updating edit quiz selection summary:', error);
      console.error('Error stack:', error.stack);
      // Set defaults on error
      const countElement = document.getElementById('editQuizSelectedCount');
      const pointsElement = document.getElementById('editQuizTotalPoints');
      if (countElement) countElement.textContent = '0';
      if (pointsElement) pointsElement.textContent = '0';
    }
  }

  // Update Edit Homework Selection Summary
  function updateEditHomeworkSelectionSummary() {
    try {
      // Check if selectedEditHomeworkQuestions is defined and is an array
      if (!selectedEditHomeworkQuestions || !Array.isArray(selectedEditHomeworkQuestions)) {
        selectedEditHomeworkQuestions = [];
      }

      // Use the length directly for count - this is the actual number of selected questions
      const count = selectedEditHomeworkQuestions.length;

      // For points and difficulty, try to find questions in editHomeworkQuestions, but use stored values as fallback
      let totalPoints = 0;
      let easyCount = 0;
      let mediumCount = 0;
      let hardCount = 0;

      // Check if editHomeworkQuestions is defined and is an array
      if (editHomeworkQuestions && Array.isArray(editHomeworkQuestions)) {
        const selectedQuestionIds = selectedEditHomeworkQuestions.map(sq => {
          if (!sq || !sq.question) return null;
          return String(sq.question);
        }).filter(id => id !== null);

        const selectedQuestions = editHomeworkQuestions.filter(q => {
          if (!q || !q._id) return false;
          return selectedQuestionIds.includes(String(q._id));
        });

        // Calculate from matched questions
        totalPoints = selectedQuestions.reduce((sum, q) => sum + (q.points || 1), 0);
        easyCount = selectedQuestions.filter(q => {
          const diff = (q.difficulty || '').toLowerCase();
          return diff === 'easy';
        }).length;
        mediumCount = selectedQuestions.filter(q => {
          const diff = (q.difficulty || '').toLowerCase();
          return diff === 'medium';
        }).length;
        hardCount = selectedQuestions.filter(q => {
          const diff = (q.difficulty || '').toLowerCase();
          return diff === 'hard';
        }).length;
      } else {
        // Fallback: use stored values from selectedEditHomeworkQuestions
        totalPoints = selectedEditHomeworkQuestions.reduce((sum, sq) => sum + (sq.points || 1), 0);
        // For difficulty, we'd need to store it in selectedEditHomeworkQuestions, but for now just use 0
      }

      const countElement = document.getElementById('editHomeworkSelectedCount');
      const pointsElement = document.getElementById('editHomeworkTotalPoints');
      const easyElement = document.getElementById('editHomeworkEasyCount');
      const mediumElement = document.getElementById('editHomeworkMediumCount');
      const hardElement = document.getElementById('editHomeworkHardCount');

      if (countElement) countElement.textContent = count;
      if (pointsElement) pointsElement.textContent = totalPoints;
      if (easyElement) easyElement.textContent = easyCount;
      if (mediumElement) mediumElement.textContent = mediumCount;
      if (hardElement) hardElement.textContent = hardCount;
    } catch (error) {
      console.error('Error updating edit homework selection summary:', error);
      // Set defaults on error
      const countElement = document.getElementById('editHomeworkSelectedCount');
      const pointsElement = document.getElementById('editHomeworkTotalPoints');
      if (countElement) countElement.textContent = '0';
      if (pointsElement) pointsElement.textContent = '0';
    }
  }

  // Toggle Edit Quiz Question Selection
  function toggleEditQuizQuestionSelection(questionId) {
    // Ensure selectedEditQuizQuestions is initialized
    if (!selectedEditQuizQuestions || !Array.isArray(selectedEditQuizQuestions)) {
      selectedEditQuizQuestions = [];
    }

    const questionIdStr = String(questionId);
    const existingIndex = selectedEditQuizQuestions.findIndex(sq => String(sq.question) === questionIdStr);

    if (existingIndex > -1) {
      selectedEditQuizQuestions.splice(existingIndex, 1);
    } else {
      const question = editQuizQuestions.find(q => String(q._id) === questionIdStr);
      if (question) {
        selectedEditQuizQuestions.push({
          question: questionIdStr,
          sourceBank: question.sourceBank,
          points: question.points || 1,
          order: selectedEditQuizQuestions.length + 1
        });
      }
    }

    // Update UI - use selected class on question-item
    const questionElement = document.querySelector(`#editQuizQuestionsGrid [data-question-id="${questionIdStr}"]`);
    if (questionElement) {
      if (existingIndex > -1) {
        questionElement.classList.remove('selected');
      } else {
        questionElement.classList.add('selected');
      }
    }

    // Force update the summary immediately
    updateEditQuizSelectionSummary();
  }

  // Toggle Edit Homework Question Selection
  function toggleEditHomeworkQuestionSelection(questionId) {
    const questionIdStr = String(questionId);
    const existingIndex = selectedEditHomeworkQuestions.findIndex(sq => String(sq.question) === questionIdStr);

    if (existingIndex > -1) {
      selectedEditHomeworkQuestions.splice(existingIndex, 1);
    } else {
      const question = editHomeworkQuestions.find(q => String(q._id) === questionIdStr);
      if (question) {
        selectedEditHomeworkQuestions.push({
          question: questionIdStr,
          sourceBank: question.sourceBank,
          points: question.points || 1,
          order: selectedEditHomeworkQuestions.length + 1
        });
      }
    }

    // Update UI - use selected class on question-item
    const questionElement = document.querySelector(`#editHomeworkQuestionsGrid [data-question-id="${questionIdStr}"]`);
    if (questionElement) {
      if (existingIndex > -1) {
        questionElement.classList.remove('selected');
      } else {
        questionElement.classList.add('selected');
      }
    }

    updateEditHomeworkSelectionSummary();
  }

  // Update Edit Quiz Bank Filter Buttons
  function updateEditQuizBankFilterButtons() {
    const filterButtons = document.getElementById('editQuizBankFilterButtons');
    if (!filterButtons) return;

    const buttons = `
      <button type="button" class="bank-filter-btn ${window.currentEditQuizBankFilter === 'all' ? 'active' : ''}" 
              data-bank-id="all" onclick="filterEditQuizByBank('all')">
        <i class="fas fa-th"></i>
        All Banks
      </button>
      ${selectedEditQuizQuestionBankIds.map(bankId => {
        const bankInfo = editQuizBankInfoMap[bankId] || { name: 'Bank', code: bankId };
        return `<button type="button" class="bank-filter-btn ${window.currentEditQuizBankFilter === bankId ? 'active' : ''}" data-bank-id="${bankId}" onclick="filterEditQuizByBank('${bankId}')">
        <i class="fas fa-database"></i>
        ${bankInfo.code || bankInfo.name}
      </button>`;
      }).join('')}
    `;
    filterButtons.innerHTML = buttons;
  }

  // Update Edit Homework Bank Filter Buttons
  function updateEditHomeworkBankFilterButtons() {
    const filterButtons = document.getElementById('editHomeworkBankFilterButtons');
    if (!filterButtons) return;

    const buttons = `
      <button type="button" class="bank-filter-btn ${window.currentEditHomeworkBankFilter === 'all' ? 'active' : ''}" 
              data-bank-id="all" onclick="filterEditHomeworkByBank('all')">
        <i class="fas fa-th"></i>
        All Banks
      </button>
      ${selectedEditHomeworkQuestionBankIds.map(bankId => {
        const bankInfo = editHomeworkBankInfoMap[bankId] || { name: 'Bank', code: bankId };
        return `<button type="button" class="bank-filter-btn ${window.currentEditHomeworkBankFilter === bankId ? 'active' : ''}" data-bank-id="${bankId}" onclick="filterEditHomeworkByBank('${bankId}')">
        <i class="fas fa-database"></i>
        ${bankInfo.code || bankInfo.name}
      </button>`;
      }).join('')}
    `;
    filterButtons.innerHTML = buttons;
  }

  // Filter Edit Quiz Questions by Bank
  function filterEditQuizByBank(bankId) {
    window.currentEditQuizBankFilter = bankId;
    updateEditQuizBankFilterButtons();
    filterEditQuizQuestions();
  }

  // Filter Edit Homework Questions by Bank
  function filterEditHomeworkByBank(bankId) {
    window.currentEditHomeworkBankFilter = bankId;
    updateEditHomeworkBankFilterButtons();
    filterEditHomeworkQuestions();
  }

  // Filter Edit Quiz Questions
  function filterEditQuizQuestions() {
    const difficultyFilter = document.getElementById('editQuizDifficultyFilter')?.value || '';
    const typeFilter = document.getElementById('editQuizTypeFilter')?.value || '';
    const tagsFilter = document.getElementById('editQuizTagsFilter')?.value || '';
    const searchFilter = document.getElementById('editQuizSearchFilter')?.value.toLowerCase() || '';
    const bankFilter = window.currentEditQuizBankFilter || 'all';

    document.querySelectorAll('#editQuizQuestionsGrid .question-item').forEach(item => {
      const difficulty = (item.className.match(/\b(easy|medium|hard)\b/) || [''])[0] || '';
      const typeElement = item.querySelector('.type-badge');
      const type = typeElement ? typeElement.textContent.trim() : '';
      const bankId = item.dataset.bankId || '';
      const questionText = item.textContent.toLowerCase();
      const questionTags = item.dataset.tags ? JSON.parse(item.dataset.tags) : [];

      const matchesDifficulty = !difficultyFilter || difficulty === difficultyFilter.toLowerCase();
      const matchesType = !typeFilter || type === typeFilter;
      const matchesBank = bankFilter === 'all' || bankId === bankFilter;
      const matchesTags = !tagsFilter || questionTags.some(tag => tag && tag.toString().toLowerCase() === tagsFilter.toLowerCase());
      const matchesSearch = !searchFilter || questionText.includes(searchFilter);

      item.style.display = (matchesDifficulty && matchesType && matchesBank && matchesTags && matchesSearch) ? 'block' : 'none';
    });
  }

  // Filter Edit Homework Questions
  function filterEditHomeworkQuestions() {
    const difficultyFilter = document.getElementById('editHomeworkDifficultyFilter')?.value || '';
    const typeFilter = document.getElementById('editHomeworkTypeFilter')?.value || '';
    const tagsFilter = document.getElementById('editHomeworkTagsFilter')?.value || '';
    const searchFilter = document.getElementById('editHomeworkSearchFilter')?.value.toLowerCase() || '';
    const bankFilter = window.currentEditHomeworkBankFilter || 'all';

    document.querySelectorAll('#editHomeworkQuestionsGrid .question-item').forEach(item => {
      const difficulty = (item.className.match(/\b(easy|medium|hard)\b/) || [''])[0] || '';
      const typeElement = item.querySelector('.type-badge');
      const type = typeElement ? typeElement.textContent.trim() : '';
      const bankId = item.dataset.bankId || '';
      const questionText = item.textContent.toLowerCase();
      const questionTags = item.dataset.tags ? JSON.parse(item.dataset.tags) : [];

      const matchesDifficulty = !difficultyFilter || difficulty === difficultyFilter.toLowerCase();
      const matchesType = !typeFilter || type === typeFilter;
      const matchesBank = bankFilter === 'all' || bankId === bankFilter;
      const matchesTags = !tagsFilter || questionTags.some(tag => tag && tag.toString().toLowerCase() === tagsFilter.toLowerCase());
      const matchesSearch = !searchFilter || questionText.includes(searchFilter);

      item.style.display = (matchesDifficulty && matchesType && matchesBank && matchesTags && matchesSearch) ? 'block' : 'none';
    });
  }

  // Populate Tags Filter Dropdown
  function populateTagsFilter(filterId, questionsArray) {
    const filterSelect = document.getElementById(filterId);
    if (!filterSelect || !questionsArray || !Array.isArray(questionsArray)) return;

    // Extract all unique tags from questions
    const allTags = new Set();
    questionsArray.forEach(question => {
      if (question.tags && Array.isArray(question.tags)) {
        question.tags.forEach(tag => {
          if (tag && tag.toString().trim()) {
            allTags.add(tag.toString().trim());
          }
        });
      }
    });

    // Sort tags alphabetically
    const sortedTags = Array.from(allTags).sort();

    // Get current selected value
    const currentValue = filterSelect.value;

    // Clear existing options except "All Tags"
    filterSelect.innerHTML = '<option value="">All Tags</option>';

    // Add tag options
    sortedTags.forEach(tag => {
      const option = document.createElement('option');
      option.value = tag;
      option.textContent = tag;
      filterSelect.appendChild(option);
    });

    // Restore previous selection if it still exists
    if (currentValue && sortedTags.includes(currentValue)) {
      filterSelect.value = currentValue;
    }
  }

  // Edit Quiz Question Selection Tools
  function selectAllEditQuizQuestions() {
    document.querySelectorAll('#editQuizQuestionsGrid .question-item:not([style*="display: none"])').forEach(item => {
      const questionId = item.dataset.questionId;
      if (questionId && !selectedEditQuizQuestions.find(sq => String(sq.question) === questionId)) {
        toggleEditQuizQuestionSelection(questionId);
      }
    });
  }

  function clearEditQuizSelection() {
    selectedEditQuizQuestions = [];
    document.querySelectorAll('#editQuizQuestionsGrid .question-item').forEach(item => {
      item.classList.remove('selected');
    });
    updateEditQuizSelectionSummary();
  }

  function selectEvenEditQuizQuestions() {
    document.querySelectorAll('#editQuizQuestionsGrid .question-item:not([style*="display: none"])').forEach((item, index) => {
      if (index % 2 === 1) {
        const questionId = item.dataset.questionId;
        if (questionId && !selectedEditQuizQuestions.find(sq => String(sq.question) === questionId)) {
          toggleEditQuizQuestionSelection(questionId);
        }
      }
    });
  }

  function selectOddEditQuizQuestions() {
    document.querySelectorAll('#editQuizQuestionsGrid .question-item:not([style*="display: none"])').forEach((item, index) => {
      if (index % 2 === 0) {
        const questionId = item.dataset.questionId;
        if (questionId && !selectedEditQuizQuestions.find(sq => String(sq.question) === questionId)) {
          toggleEditQuizQuestionSelection(questionId);
        }
      }
    });
  }

  function selectRandomEditQuizQuestions() {
    const visibleQuestions = Array.from(document.querySelectorAll('#editQuizQuestionsGrid .question-item:not([style*="display: none"])'));
    const randomCount = Math.ceil(visibleQuestions.length * 0.3);
    const shuffled = visibleQuestions.sort(() => 0.5 - Math.random());
    shuffled.slice(0, randomCount).forEach(item => {
      const questionId = item.dataset.questionId;
      if (questionId && !selectedEditQuizQuestions.find(sq => String(sq.question) === questionId)) {
        toggleEditQuizQuestionSelection(questionId);
      }
    });
  }

  function selectEditQuizRange() {
    const rangeInput = document.getElementById('editQuizRangeInput');
    if (!rangeInput) return;

    const rangeText = rangeInput.value.trim();
    if (!rangeText) return;

    const ranges = rangeText.split(',').map(r => r.trim());
    const visibleQuestions = Array.from(document.querySelectorAll('#editQuizQuestionsGrid .question-item:not([style*="display: none"])'));

    ranges.forEach(range => {
      if (range.includes('-')) {
        const [start, end] = range.split('-').map(n => parseInt(n.trim()) - 1);
        if (!isNaN(start) && !isNaN(end)) {
          for (let i = Math.max(0, start); i <= Math.min(visibleQuestions.length - 1, end); i++) {
            const questionId = visibleQuestions[i]?.dataset.questionId;
            if (questionId && !selectedEditQuizQuestions.find(sq => String(sq.question) === questionId)) {
              toggleEditQuizQuestionSelection(questionId);
            }
          }
        }
      } else {
        const index = parseInt(range.trim()) - 1;
        if (!isNaN(index) && index >= 0 && index < visibleQuestions.length) {
          const questionId = visibleQuestions[index]?.dataset.questionId;
          if (questionId && !selectedEditQuizQuestions.find(sq => String(sq.question) === questionId)) {
            toggleEditQuizQuestionSelection(questionId);
          }
        }
      }
    });

    rangeInput.value = '';
  }

  // Edit Homework Question Selection Tools
  function selectAllEditHomeworkQuestions() {
    document.querySelectorAll('#editHomeworkQuestionsGrid .question-item:not([style*="display: none"])').forEach(item => {
      const questionId = item.dataset.questionId;
      if (questionId && !selectedEditHomeworkQuestions.find(sq => String(sq.question) === questionId)) {
        toggleEditHomeworkQuestionSelection(questionId);
      }
    });
  }

  function clearEditHomeworkSelection() {
    selectedEditHomeworkQuestions = [];
    document.querySelectorAll('#editHomeworkQuestionsGrid .question-item').forEach(item => {
      item.classList.remove('selected');
    });
    updateEditHomeworkSelectionSummary();
  }

  function selectEvenEditHomeworkQuestions() {
    document.querySelectorAll('#editHomeworkQuestionsGrid .question-item:not([style*="display: none"])').forEach((item, index) => {
      if (index % 2 === 1) {
        const questionId = item.dataset.questionId;
        if (questionId && !selectedEditHomeworkQuestions.find(sq => String(sq.question) === questionId)) {
          toggleEditHomeworkQuestionSelection(questionId);
        }
      }
    });
  }

  function selectOddEditHomeworkQuestions() {
    document.querySelectorAll('#editHomeworkQuestionsGrid .question-item:not([style*="display: none"])').forEach((item, index) => {
      if (index % 2 === 0) {
        const questionId = item.dataset.questionId;
        if (questionId && !selectedEditHomeworkQuestions.find(sq => String(sq.question) === questionId)) {
          toggleEditHomeworkQuestionSelection(questionId);
        }
      }
    });
  }

  function selectRandomEditHomeworkQuestions() {
    const visibleQuestions = Array.from(document.querySelectorAll('#editHomeworkQuestionsGrid .question-item:not([style*="display: none"])'));
    const randomCount = Math.ceil(visibleQuestions.length * 0.3);
    const shuffled = visibleQuestions.sort(() => 0.5 - Math.random());
    shuffled.slice(0, randomCount).forEach(item => {
      const questionId = item.dataset.questionId;
      if (questionId && !selectedEditHomeworkQuestions.find(sq => String(sq.question) === questionId)) {
        toggleEditHomeworkQuestionSelection(questionId);
      }
    });
  }

  function selectEditHomeworkRange() {
    const rangeInput = document.getElementById('editHomeworkRangeInput');
    if (!rangeInput) return;

    const rangeText = rangeInput.value.trim();
    if (!rangeText) return;

    const ranges = rangeText.split(',').map(r => r.trim());
    const visibleQuestions = Array.from(document.querySelectorAll('#editHomeworkQuestionsGrid .question-item:not([style*="display: none"])'));

    ranges.forEach(range => {
      if (range.includes('-')) {
        const [start, end] = range.split('-').map(n => parseInt(n.trim()) - 1);
        if (!isNaN(start) && !isNaN(end)) {
          for (let i = Math.max(0, start); i <= Math.min(visibleQuestions.length - 1, end); i++) {
            const questionId = visibleQuestions[i]?.dataset.questionId;
            if (questionId && !selectedEditHomeworkQuestions.find(sq => String(sq.question) === questionId)) {
              toggleEditHomeworkQuestionSelection(questionId);
            }
          }
        }
      } else {
        const index = parseInt(range.trim()) - 1;
        if (!isNaN(index) && index >= 0 && index < visibleQuestions.length) {
          const questionId = visibleQuestions[index]?.dataset.questionId;
          if (questionId && !selectedEditHomeworkQuestions.find(sq => String(sq.question) === questionId)) {
            toggleEditHomeworkQuestionSelection(questionId);
          }
        }
      }
    });

    rangeInput.value = '';
  }

  // Edit Quiz Question Bank Selection
  function selectEditQuizQuestionBank(bankId) {
    window.editQuizSelectedBankId = bankId;

    // Update UI to show selected bank
    document.querySelectorAll('#editQuizQuestionBanksGrid .question-bank-card').forEach(card => {
      card.classList.remove('selected');
    });
    event.target.closest('.question-bank-card').classList.add('selected');

    // Load questions from selected bank
    loadEditQuizQuestionsFromBank(bankId);

    // Move to next step
    nextEditQuizStep();
  }

  // Edit Homework Question Bank Selection
  function selectEditHomeworkQuestionBank(bankId) {
    window.editHomeworkSelectedBankId = bankId;

    // Update UI to show selected bank
    document.querySelectorAll('#editHomeworkQuestionBanksGrid .question-bank-card').forEach(card => {
      card.classList.remove('selected');
    });
    event.target.closest('.question-bank-card').classList.add('selected');

    // Load questions from selected bank
    loadEditHomeworkQuestionsFromBank(bankId);

    // Move to next step
    nextEditHomeworkStep();
  }

  // Load questions for edit quiz
  function loadEditQuizQuestionsFromBank(bankId) {
    return fetch(`/admin/question-banks/${bankId}/questions`)
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          window.editQuizAvailableQuestions = data.questions; // Store for reference
          displayEditQuizQuestions(data.questions);
        }
      })
      .catch(error => {
        console.error('Error loading questions:', error);
      });
  }

  // Load questions for edit homework
  function loadEditHomeworkQuestionsFromBank(bankId) {
    return fetch(`/admin/question-banks/${bankId}/questions`)
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          window.editHomeworkAvailableQuestions = data.questions; // Store for reference
          displayEditHomeworkQuestions(data.questions);
        }
      })
      .catch(error => {
        console.error('Error loading questions:', error);
      });
  }

  // OLD FUNCTION REMOVED - Using the new displayEditQuizQuestions function above

  // OLD FUNCTION REMOVED - Using the new displayEditHomeworkQuestions function above

  // Toggle question selection for edit quiz
  function toggleEditQuizQuestion(index) {
    const questionElement = document.querySelector(`#editQuizQuestionsGrid .question-circle:nth-child(${index + 1})`);
    if (!questionElement) return;

    if (questionElement.classList.contains('selected')) {
      questionElement.classList.remove('selected');
      window.editQuizSelectedQuestions = window.editQuizSelectedQuestions.filter(id => id !== questionElement.dataset.questionId);
    } else {
      questionElement.classList.add('selected');
      window.editQuizSelectedQuestions.push(questionElement.dataset.questionId);
    }

    updateEditQuizSelectionSummary();
  }

  // OLD FUNCTION REMOVED - Using toggleEditHomeworkQuestionSelection(questionId) instead

  // OLD FUNCTION REMOVED - Using the comprehensive updateEditQuizSelectionSummary function above (defined earlier)

  // OLD FUNCTION REMOVED - Using the comprehensive updateEditHomeworkSelectionSummary function above

  // Edit Quiz Question Selection Tools
  function selectAllEditQuizQuestions() {
    document.querySelectorAll('#editQuizQuestionsGrid .question-circle').forEach(circle => {
      circle.classList.add('selected');
      if (!window.editQuizSelectedQuestions.includes(circle.dataset.questionId)) {
        window.editQuizSelectedQuestions.push(circle.dataset.questionId);
      }
    });
    updateEditQuizSelectionSummary();
  }

  function clearEditQuizSelection() {
    document.querySelectorAll('#editQuizQuestionsGrid .question-circle').forEach(circle => {
      circle.classList.remove('selected');
    });
    window.editQuizSelectedQuestions = [];
    updateEditQuizSelectionSummary();
  }

  function selectEvenEditQuizQuestions() {
    document.querySelectorAll('#editQuizQuestionsGrid .question-circle').forEach((circle, index) => {
      if ((index + 1) % 2 === 0) {
        circle.classList.add('selected');
        if (!window.editQuizSelectedQuestions.includes(circle.dataset.questionId)) {
          window.editQuizSelectedQuestions.push(circle.dataset.questionId);
        }
      }
    });
    updateEditQuizSelectionSummary();
  }

  function selectOddEditQuizQuestions() {
    document.querySelectorAll('#editQuizQuestionsGrid .question-circle').forEach((circle, index) => {
      if ((index + 1) % 2 === 1) {
        circle.classList.add('selected');
        if (!window.editQuizSelectedQuestions.includes(circle.dataset.questionId)) {
          window.editQuizSelectedQuestions.push(circle.dataset.questionId);
        }
      }
    });
    updateEditQuizSelectionSummary();
  }

  function selectRandomEditQuizQuestions() {
    const circles = Array.from(document.querySelectorAll('#editQuizQuestionsGrid .question-circle'));
    const randomCount = Math.ceil(circles.length * 0.3);
    const randomIndices = [...Array(circles.length).keys()].sort(() => 0.5 - Math.random()).slice(0, randomCount);

    circles.forEach((circle, index) => {
      if (randomIndices.includes(index)) {
        circle.classList.add('selected');
        if (!window.editQuizSelectedQuestions.includes(circle.dataset.questionId)) {
          window.editQuizSelectedQuestions.push(circle.dataset.questionId);
        }
      }
    });
    updateEditQuizSelectionSummary();
  }

  function selectEditQuizRange() {
    const rangeInput = document.getElementById('editQuizRangeInput');
    const range = rangeInput.value;

    if (!range) return;

    // Parse range (e.g., "1-5, 8, 10-12")
    const parts = range.split(',');
    const indices = new Set();

    parts.forEach(part => {
      part = part.trim();
      if (part.includes('-')) {
        const [start, end] = part.split('-').map(n => parseInt(n.trim()) - 1);
        for (let i = start; i <= end; i++) {
          indices.add(i);
        }
      } else {
        indices.add(parseInt(part.trim()) - 1);
      }
    });

    document.querySelectorAll('#editQuizQuestionsGrid .question-circle').forEach((circle, index) => {
      if (indices.has(index)) {
        circle.classList.add('selected');
        if (!window.editQuizSelectedQuestions.includes(circle.dataset.questionId)) {
          window.editQuizSelectedQuestions.push(circle.dataset.questionId);
        }
      }
    });
    updateEditQuizSelectionSummary();
  }

  // Edit Homework Question Selection Tools
  function selectAllEditHomeworkQuestions() {
    document.querySelectorAll('#editHomeworkQuestionsGrid .question-circle').forEach(circle => {
      circle.classList.add('selected');
      if (!window.editHomeworkSelectedQuestions.includes(circle.dataset.questionId)) {
        window.editHomeworkSelectedQuestions.push(circle.dataset.questionId);
      }
    });
    updateEditHomeworkSelectionSummary();
  }

  function clearEditHomeworkSelection() {
    document.querySelectorAll('#editHomeworkQuestionsGrid .question-circle').forEach(circle => {
      circle.classList.remove('selected');
    });
    window.editHomeworkSelectedQuestions = [];
    updateEditHomeworkSelectionSummary();
  }

  function selectEvenEditHomeworkQuestions() {
    document.querySelectorAll('#editHomeworkQuestionsGrid .question-circle').forEach((circle, index) => {
      if ((index + 1) % 2 === 0) {
        circle.classList.add('selected');
        if (!window.editHomeworkSelectedQuestions.includes(circle.dataset.questionId)) {
          window.editHomeworkSelectedQuestions.push(circle.dataset.questionId);
        }
      }
    });
    updateEditHomeworkSelectionSummary();
  }

  function selectOddEditHomeworkQuestions() {
    document.querySelectorAll('#editHomeworkQuestionsGrid .question-circle').forEach((circle, index) => {
      if ((index + 1) % 2 === 1) {
        circle.classList.add('selected');
        if (!window.editHomeworkSelectedQuestions.includes(circle.dataset.questionId)) {
          window.editHomeworkSelectedQuestions.push(circle.dataset.questionId);
        }
      }
    });
    updateEditHomeworkSelectionSummary();
  }

  function selectRandomEditHomeworkQuestions() {
    const circles = Array.from(document.querySelectorAll('#editHomeworkQuestionsGrid .question-circle'));
    const randomCount = Math.ceil(circles.length * 0.3);
    const randomIndices = [...Array(circles.length).keys()].sort(() => 0.5 - Math.random()).slice(0, randomCount);

    circles.forEach((circle, index) => {
      if (randomIndices.includes(index)) {
        circle.classList.add('selected');
        if (!window.editHomeworkSelectedQuestions.includes(circle.dataset.questionId)) {
          window.editHomeworkSelectedQuestions.push(circle.dataset.questionId);
        }
      }
    });
    updateEditHomeworkSelectionSummary();
  }

  function selectEditHomeworkRange() {
    const rangeInput = document.getElementById('editHomeworkRangeInput');
    const range = rangeInput.value;

    if (!range) return;

    // Parse range (e.g., "1-5, 8, 10-12")
    const parts = range.split(',');
    const indices = new Set();

    parts.forEach(part => {
      part = part.trim();
      if (part.includes('-')) {
        const [start, end] = part.split('-').map(n => parseInt(n.trim()) - 1);
        for (let i = start; i <= end; i++) {
          indices.add(i);
        }
      } else {
        indices.add(parseInt(part.trim()) - 1);
      }
    });

    document.querySelectorAll('#editHomeworkQuestionsGrid .question-circle').forEach((circle, index) => {
      if (indices.has(index)) {
        circle.classList.add('selected');
        if (!window.editHomeworkSelectedQuestions.includes(circle.dataset.questionId)) {
          window.editHomeworkSelectedQuestions.push(circle.dataset.questionId);
        }
      }
    });
    updateEditHomeworkSelectionSummary();
  }

  async function deleteContent(topicId, contentId) {
    if (confirm('Are you sure you want to delete this content item?')) {
      try {
        const response = await fetch(`/admin/courses/<%= courseCode %>/topics/${topicId}/content/${contentId}`, {
          method: 'DELETE',
          headers: {
            'Content-Type': 'application/json',
          }
        });

        const data = await response.json();

        if (data.success) {
          showNotification('Content deleted successfully!', 'success');

          // Remove the content item from UI with animation
          const contentItem = document.querySelector(`[data-content-id="${contentId}"]`);
          if (contentItem) {
            contentItem.style.transition = 'all 0.3s ease';
            contentItem.style.transform = 'scale(0.8)';
            contentItem.style.opacity = '0';
            setTimeout(() => {
              contentItem.remove();
            }, 300);
          }
        } else {
          throw new Error(data.message || 'Failed to delete content');
        }
      } catch (error) {
        console.error('Error:', error);
        showNotification('Error deleting content: ' + error.message, 'error');
      }
    }
  }

  // Function to view content details
  function viewContentDetails(topicId, contentId) {
    window.location.href = `/admin/courses/<%= courseCode %>/topics/${topicId}/content/${contentId}/details`;
  }

  function toggleReorderMode() {
    reorderMode = !reorderMode;
    const topicsContainer = document.getElementById('topicsContainer');

    if (reorderMode) {
      topicsContainer.classList.add('reorder-mode');
      // Add drag handles and make topics draggable
      const topicCards = topicsContainer.querySelectorAll('.topic-card');
      topicCards.forEach((card, index) => {
        card.draggable = true;
        card.classList.add('draggable');
        card.addEventListener('dragstart', handleDragStart);
        card.addEventListener('dragover', handleDragOver);
        card.addEventListener('drop', handleDrop);
        card.addEventListener('dragend', handleDragEnd);
      });
    } else {
      topicsContainer.classList.remove('reorder-mode');
      const topicCards = topicsContainer.querySelectorAll('.topic-card');
      topicCards.forEach(card => {
        card.draggable = false;
        card.classList.remove('draggable');
        card.removeEventListener('dragstart', handleDragStart);
        card.removeEventListener('dragover', handleDragOver);
        card.removeEventListener('drop', handleDrop);
        card.removeEventListener('dragend', handleDragEnd);
      });
    }
  }

  let draggedElement = null;

  function handleDragStart(e) {
    draggedElement = this;
    this.classList.add('dragging');
    e.dataTransfer.effectAllowed = 'move';
    e.dataTransfer.setData('text/html', this.outerHTML);
  }

  function handleDragOver(e) {
    if (e.preventDefault) {
      e.preventDefault();
    }
    e.dataTransfer.dropEffect = 'move';
    return false;
  }

  function handleDrop(e) {
    if (e.stopPropagation) {
      e.stopPropagation();
    }

    if (draggedElement !== this) {
      const topicsContainer = document.getElementById('topicsContainer');
      const topics = Array.from(topicsContainer.querySelectorAll('.topic-card'));
      const draggedIndex = topics.indexOf(draggedElement);
      const targetIndex = topics.indexOf(this);

      if (draggedIndex < targetIndex) {
        topicsContainer.insertBefore(draggedElement, this.nextSibling);
      } else {
        topicsContainer.insertBefore(draggedElement, this);
      }

      // Update order in database
      updateTopicOrder();
    }

    return false;
  }

  function handleDragEnd(e) {
    const topicCards = document.querySelectorAll('.topic-card');
    topicCards.forEach(card => {
      card.classList.remove('dragging');
    });
    draggedElement = null;
  }

  function updateTopicOrder() {
    const topicCards = document.querySelectorAll('.topic-card');
    const orderUpdates = [];

    topicCards.forEach((card, index) => {
      const topicId = card.dataset.topicId;
      orderUpdates.push({
        topicId: topicId,
        order: index + 1
      });
    });

    // Send order updates to server
    fetch(`/admin/courses/<%= courseCode %>/topics/reorder`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          orderUpdates
        })
      })
      .then(response => {
        if (response.ok) {
          console.log('Topic order updated successfully');
        } else {
          console.error('Error updating topic order');
        }
      })
      .catch(error => {
        console.error('Error:', error);
      });
  }

  // ==================== CONTENT REORDERING FUNCTIONS ====================

  let contentReorderModes = {}; // Track reorder mode for each topic

  function toggleContentReorder(topicId) {
    // Prevent event from bubbling to parent topic card
    if (event) {
      event.stopPropagation();
    }

    const contentItems = document.querySelector(`.content-items[data-topic-id="${topicId}"]`);
    const reorderBtn = event.target.closest('.content-reorder-btn');

    if (!contentItems) return;

    // Toggle reorder mode for this topic
    contentReorderModes[topicId] = !contentReorderModes[topicId];

    if (contentReorderModes[topicId]) {
      // Enable reorder mode
      contentItems.classList.add('reorder-mode');
      reorderBtn.classList.add('active');
      reorderBtn.innerHTML = '<i class="fas fa-check"></i> Save Order';

      // Make content items draggable
      const items = contentItems.querySelectorAll('.content-item');
      items.forEach(item => {
        item.draggable = true;
        item.classList.add('draggable');
        item.addEventListener('dragstart', handleContentDragStart);
        item.addEventListener('dragover', handleContentDragOver);
        item.addEventListener('drop', handleContentDrop);
        item.addEventListener('dragend', handleContentDragEnd);
      });
    } else {
      // Disable reorder mode and save
      contentItems.classList.remove('reorder-mode');
      reorderBtn.classList.remove('active');
      reorderBtn.innerHTML = '<i class="fas fa-sort"></i> Reorder Content';

      // Remove draggable
      const items = contentItems.querySelectorAll('.content-item');
      items.forEach(item => {
        item.draggable = false;
        item.classList.remove('draggable');
        item.removeEventListener('dragstart', handleContentDragStart);
        item.removeEventListener('dragover', handleContentDragOver);
        item.removeEventListener('drop', handleContentDrop);
        item.removeEventListener('dragend', handleContentDragEnd);
      });

      // Save the new order
      updateContentOrder(topicId);
    }
  }

  let draggedContentElement = null;

  function handleContentDragStart(e) {
    draggedContentElement = this;
    this.classList.add('dragging');
    e.dataTransfer.effectAllowed = 'move';
    e.dataTransfer.setData('text/html', this.outerHTML);
  }

  function handleContentDragOver(e) {
    if (e.preventDefault) {
      e.preventDefault();
    }
    e.dataTransfer.dropEffect = 'move';

    // Add visual feedback
    const contentItem = e.target.closest('.content-item');
    if (contentItem && contentItem !== draggedContentElement) {
      contentItem.classList.add('drag-over');
    }

    return false;
  }

  function handleContentDrop(e) {
    if (e.stopPropagation) {
      e.stopPropagation();
    }

    // Remove drag-over class from all items
    document.querySelectorAll('.content-item').forEach(item => {
      item.classList.remove('drag-over');
    });

    const dropTarget = e.target.closest('.content-item');

    if (draggedContentElement !== dropTarget && dropTarget) {
      const contentItems = dropTarget.parentElement;
      const items = Array.from(contentItems.querySelectorAll('.content-item'));
      const draggedIndex = items.indexOf(draggedContentElement);
      const targetIndex = items.indexOf(dropTarget);

      if (draggedIndex < targetIndex) {
        contentItems.insertBefore(draggedContentElement, dropTarget.nextSibling);
      } else {
        contentItems.insertBefore(draggedContentElement, dropTarget);
      }
    }

    return false;
  }

  function handleContentDragEnd(e) {
    document.querySelectorAll('.content-item').forEach(item => {
      item.classList.remove('dragging', 'drag-over');
    });
    draggedContentElement = null;
  }

  function updateContentOrder(topicId) {
    const contentItems = document.querySelector(`.content-items[data-topic-id="${topicId}"]`);
    if (!contentItems) return;

    const items = contentItems.querySelectorAll('.content-item');
    const orderUpdates = [];

    items.forEach((item, index) => {
      const contentId = item.dataset.contentId;
      orderUpdates.push({
        contentId: contentId,
        order: index + 1
      });
    });

    // Send order updates to server
    fetch(`/admin/courses/<%= courseCode %>/topics/${topicId}/content/reorder`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          orderUpdates
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          showNotification('Content order updated successfully!', 'success');
        } else {
          showNotification('Error updating content order', 'error');
          console.error('Error updating content order:', data.message);
        }
      })
      .catch(error => {
        console.error('Error:', error);
        showNotification('Error updating content order', 'error');
      });
  }

  function toggleAllTopics() {
    const topicCards = document.querySelectorAll('.topic-card');
    const firstCard = topicCards[0];

    if (!firstCard) return;

    const firstContentSection = firstCard.querySelector('.topic-content-section');
    const shouldShow = firstContentSection.style.display === 'none';

    topicCards.forEach(card => {
      const contentSection = card.querySelector('.topic-content-section');
      contentSection.style.display = shouldShow ? 'block' : 'none';
    });
  }

  function previewCourse() {
    // Open course preview in new tab
    window.open(`/admin/courses/<%= courseCode %>/preview`, '_blank');
  }

  // Helper function to get content icons
  function getContentIcon(type) {
    const icons = {
      'video': 'play',
      'pdf': 'file-pdf',
      'homework': 'tasks',
      'quiz': 'question-circle',
      'zoom': 'video',
      'link': 'external-link-alt'
    };
    return icons[type] || 'file';
  }

  // Initialize page
  document.addEventListener('DOMContentLoaded', function() {
    // Load available bundles for edit modal
    loadAvailableBundlesForEdit();

    // Setup content type change handler
    const contentTypeSelect = document.getElementById('contentType');
    const fileUploadSection = document.getElementById('fileUploadSection');
    const contentUrlSection = document.getElementById('contentUrlSection');
    const contentUrlInput = document.getElementById('contentUrl');

    if (contentTypeSelect) {
      contentTypeSelect.addEventListener('change', function() {
        const type = this.value;

        // Show/hide Video Watch Limit section
        const videoWatchLimitSection = document.getElementById('videoWatchLimitSection');
        if (videoWatchLimitSection) {
          videoWatchLimitSection.style.display = type === 'video' ? 'block' : 'none';
        }

        // Show/hide Quiz content section
        const quizContentSection = document.getElementById('quizContentSection');
        if (quizContentSection) {
          if (type === 'quiz') {
            quizContentSection.style.display = 'block';
            resetQuizSteps();
          } else {
            quizContentSection.style.display = 'none';
          }
        }

        // Show/hide Homework content section
        const homeworkContentSection = document.getElementById('homeworkContentSection');
        if (homeworkContentSection) {
          if (type === 'homework') {
            homeworkContentSection.style.display = 'block';
            resetHomeworkSteps();
          } else {
            homeworkContentSection.style.display = 'none';
          }
        }

        // Show/hide Zoom content section
        const zoomContentSection = document.getElementById('zoomContentSection');
        if (zoomContentSection) {
          if (type === 'zoom') {
            zoomContentSection.style.display = 'block';
          } else {
            zoomContentSection.style.display = 'none';
          }
        }

        // Update submit button text and icon based on content type
        const submitBtn = document.getElementById('addContentSubmitBtn');
        const btnIcon = document.getElementById('addContentBtnIcon');
        const btnText = document.getElementById('addContentBtnText');

        if (submitBtn && btnIcon && btnText) {
          if (type === 'zoom') {
            btnIcon.className = 'fas fa-video me-2';
            btnText.textContent = 'Create Zoom Meeting';
          } else if (type === 'quiz') {
            btnIcon.className = 'fas fa-question-circle me-2';
            btnText.textContent = 'Create Quiz';
          } else if (type === 'homework') {
            btnIcon.className = 'fas fa-tasks me-2';
            btnText.textContent = 'Create Homework';
          } else {
            btnIcon.className = 'fas fa-plus me-2';
            btnText.textContent = 'Add Content';
          }
        }

        // Hide Content URL/File section for Quiz, Homework, and Zoom
        if (type === 'quiz' || type === 'homework' || type === 'zoom') {
          contentUrlSection.style.display = 'none';
          contentUrlInput.required = false;
          fileUploadSection.style.display = 'none';
        } else {
          contentUrlSection.style.display = 'block';
          contentUrlInput.required = true;

          const needsFileUpload = ['pdf'].includes(type);

          if (needsFileUpload) {
            fileUploadSection.style.display = 'block';
            contentUrlInput.placeholder = 'Or enter URL manually';
            contentUrlInput.required = false;
          } else {
            fileUploadSection.style.display = 'none';
            contentUrlInput.placeholder = 'Enter URL';
            contentUrlInput.required = true;
          }
        }
      });
    }

    // Setup file upload for content
    const contentFileInput = document.getElementById('contentFile');
    if (contentFileInput) {
      contentFileInput.addEventListener('change', function() {
        if (this.files && this.files[0]) {
          uploadContentFile(this.files[0]);
        }
      });
    }

    // Add click handlers for topic cards
    const topicCards = document.querySelectorAll('.topic-card');
    topicCards.forEach(card => {
      card.addEventListener('click', function(e) {
        // Don't toggle if clicking on topic actions, reorder button, content items header, content actions, or zoom meeting controls
        if (!e.target.closest('.topic-actions') &&
          !e.target.closest('.content-items-header') &&
          !e.target.closest('.content-reorder-btn') &&
          !e.target.closest('.content-actions') &&
          !e.target.closest('.zoom-meeting-controls') &&
          !e.target.closest('.content-regular-actions') &&
          !reorderMode) {
          // Toggle topic content visibility
          const contentSection = this.querySelector('.topic-content-section');
          if (contentSection) {
            const isVisible = contentSection.style.display !== 'none';
            contentSection.style.display = isVisible ? 'none' : 'block';
          }
        }
      });
    });
  });

  // Simple PDF Upload Function
  function uploadContentFile(file) {
    // Validate file type
    if (file.type !== 'application/pdf' && !file.name.toLowerCase().endsWith('.pdf')) {
      showNotification('Only PDF files are allowed', 'error');
      return;
    }

    // Validate file size (50MB limit)
    const maxSize = 50 * 1024 * 1024; // 50MB
    if (file.size > maxSize) {
      showNotification('File size must be less than 50MB', 'error');
      return;
    }

    const progressContainer = document.getElementById('contentFileProgress');
    const preview = document.getElementById('contentFilePreview');
    const uploadedUrlInput = document.getElementById('uploadedFileUrl');
    const contentUrlInput = document.getElementById('contentUrl');

    // Show file info in preview
    if (preview) {
      preview.innerHTML = `
        <div class="file-info">
          <i class="fas fa-file-pdf" style="font-size: 3rem; color: #dc2626;"></i>
          <div class="file-details">
            <strong>${file.name}</strong>
            <small>${(file.size / 1024 / 1024).toFixed(2)} MB</small>
          </div>
        </div>
      `;
    }

    // Show progress
    if (progressContainer) {
      progressContainer.style.display = 'block';
      progressContainer.innerHTML = `
        <div class="progress">
          <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
        </div>
        <small class="d-block mt-2 text-center">Uploading PDF...</small>
      `;
    }

    // Create FormData
    const formData = new FormData();
    formData.append('pdf', file);

    // Upload PDF
    fetch('/admin/upload/pdf', {
      method: 'POST',
      body: formData
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        // Update hidden input and URL input
        if (uploadedUrlInput) {
          uploadedUrlInput.value = data.fileUrl;
        }
        if (contentUrlInput) {
          contentUrlInput.value = data.fileUrl;
        }

        // Show success
        if (progressContainer) {
          progressContainer.innerHTML = `
            <div class="alert alert-success">
              <i class="fas fa-check-circle"></i>
              PDF uploaded successfully!
            </div>
          `;
        }

        if (preview) {
          preview.innerHTML = `
            <div class="file-info">
              <i class="fas fa-file-pdf" style="font-size: 3rem; color: #10b981;"></i>
              <div class="file-details">
                <strong>${data.fileName}</strong>
                <small class="text-success">Uploaded successfully</small>
              </div>
            </div>
          `;
        }

        showNotification('PDF uploaded successfully!', 'success');

        // Hide progress after 3 seconds
        setTimeout(() => {
          if (progressContainer) {
            progressContainer.style.display = 'none';
          }
        }, 3000);
      } else {
        throw new Error(data.message || 'Upload failed');
      }
    })
    .catch(error => {
      console.error('Upload error:', error);
      showNotification('Error uploading PDF: ' + error.message, 'error');
      
      if (progressContainer) {
        progressContainer.innerHTML = `
          <div class="alert alert-danger">
            <i class="fas fa-exclamation-circle"></i>
            Upload failed: ${error.message}
          </div>
        `;
      }

      if (preview) {
        preview.innerHTML = `
          <div class="preview-overlay">
            <i class="fas fa-cloud-upload-alt"></i>
            <p>Click or drag to upload</p>
            <small>PDF files only</small>
          </div>
        `;
      }
    });
  }

  // Update topic card in UI
  function updateTopicCard(topicId, topicData) {
    const topicCard = document.querySelector(`[data-topic-id="${topicId}"]`);
    if (!topicCard) return;

    // Update title
    const titleElement = topicCard.querySelector('.topic-title');
    if (titleElement) {
      titleElement.textContent = topicData.title;
    }

    // Update description
    const descriptionElement = topicCard.querySelector('.topic-description');
    if (descriptionElement) {
      descriptionElement.textContent = topicData.description;
    }

    // Update estimated time
    const timeElement = topicCard.querySelector('.meta-item i.fa-clock').parentElement;
    if (timeElement && topicData.estimatedTime) {
      const hours = Math.round(topicData.estimatedTime / 60 * 10) / 10;
      timeElement.innerHTML = `<i class="fas fa-clock"></i> ${hours}h`;
    }

    // Update status badge
    const statusBadge = topicCard.querySelector('.status-badge');
    if (statusBadge) {
      statusBadge.className = `status-badge ${topicData.isPublished ? 'published' : 'draft'}`;
      statusBadge.innerHTML = `<i class="fas fa-${topicData.isPublished ? 'eye' : 'eye-slash'}"></i> ${topicData.isPublished ? 'Published' : 'Draft'}`;
    }

    // Update difficulty badge
    const difficultyBadge = topicCard.querySelector('.difficulty-badge');
    if (difficultyBadge && topicData.difficulty) {
      difficultyBadge.className = `difficulty-badge difficulty-${topicData.difficulty}`;
      difficultyBadge.textContent = topicData.difficulty.charAt(0).toUpperCase() + topicData.difficulty.slice(1);
    }

    // Update order
    if (topicData.order) {
      topicCard.setAttribute('data-order', topicData.order);
    }

    // Update visibility button
    const visibilityBtn = topicCard.querySelector('.visibility-toggle');
    if (visibilityBtn) {
      const icon = visibilityBtn.querySelector('i');
      const textSpan = visibilityBtn.querySelector('.btn-text');

      // Update classes
      visibilityBtn.classList.remove('published', 'draft');
      visibilityBtn.classList.add(topicData.isPublished ? 'published' : 'draft');

      // Update content
      const iconClass = topicData.isPublished ? 'eye' : 'eye-slash';
      const buttonText = topicData.isPublished ? 'Hide' : 'Show';

      icon.className = `fas fa-${iconClass}`;
      if (textSpan) {
        textSpan.textContent = buttonText;
      }

      // Update attributes
      visibilityBtn.setAttribute('onclick', `toggleTopicVisibility('${topicId}', ${topicData.isPublished})`);
      visibilityBtn.setAttribute('title', topicData.isPublished ? 'Hide Topic' : 'Publish Topic');
    }
  }


  // Enhanced manageTopicContent function
  function manageTopicContent(topicId) {
    currentTopicId = topicId;
    const form = document.getElementById('addContentForm');
    form.action = `/admin/courses/<%= courseCode %>/topics/${topicId}/content/create`;

    // Reset form
    form.reset();
    document.getElementById('fileUploadSection').style.display = 'none';
    document.getElementById('uploadedFileUrl').value = '';

    // Reset quiz and homework steps
    resetQuizSteps();
    resetHomeworkSteps();

    // Hide all content type sections
    document.getElementById('quizContentSection').style.display = 'none';
    document.getElementById('homeworkContentSection').style.display = 'none';
    document.getElementById('zoomContentSection').style.display = 'none';

    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('addContentModal'));
    modal.show();
  }



  // ==================== EDIT COURSE FUNCTIONALITY ====================

  // Load available bundles for edit modal
  function loadAvailableBundlesForEdit() {
    fetch('/admin/api/bundles')
      .then(response => response.json())
      .then(bundles => {
        const bundleSelect = document.getElementById('editCourseBundle');
        if (bundleSelect) {
          bundleSelect.innerHTML = '<option value="">Select Bundle</option>';

          bundles.forEach(bundle => {
            const option = document.createElement('option');
            option.value = bundle._id;
            option.textContent = `${bundle.title} (${bundle.bundleCode})`;
            bundleSelect.appendChild(option);
          });
        }
      })
      .catch(error => {
        console.error('Error loading bundles for edit:', error);
      });
  }

  // Edit Course Function
  function editCourse(courseCode) {
    console.log('Editing course:', courseCode);

    // Fetch course data
    fetch(`/admin/courses/${courseCode}/data`)
      .then(response => {
        console.log('Response status:', response.status);
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
      })
      .then(data => {
        console.log('Course data loaded:', data);
        if (data.success) {
          populateEditForm(data.course);
          showEditModal();
        } else {
          showNotification('Failed to load course data', 'error');
        }
      })
      .catch(error => {
        console.error('Error loading course:', error);
        showNotification('Error loading course data: ' + error.message, 'error');
      });
  }

  // Setup fully booked checkbox toggle and message dropdown
  document.addEventListener('DOMContentLoaded', function() {
    const fullyBookedCheckbox = document.getElementById('editCourseIsFullyBooked');
    const fullyBookedMessageRow = document.getElementById('fullyBookedMessageRow');
    const fullyBookedMessageSelect = document.getElementById('editCourseFullyBookedMessage');
    const customMessageRow = document.getElementById('customMessageRow');
    const customMessageInput = document.getElementById('editCourseCustomFullyBookedMessage');
    
    if (fullyBookedCheckbox && fullyBookedMessageRow) {
      fullyBookedCheckbox.addEventListener('change', function() {
        fullyBookedMessageRow.style.display = this.checked ? 'block' : 'none';
      });
    }

    // Handle dropdown change for "Other" option
    if (fullyBookedMessageSelect && customMessageRow) {
      fullyBookedMessageSelect.addEventListener('change', function() {
        if (this.value === 'other') {
          customMessageRow.style.display = 'block';
          if (customMessageInput) {
            customMessageInput.required = true;
          }
        } else {
          customMessageRow.style.display = 'none';
          if (customMessageInput) {
            customMessageInput.required = false;
            customMessageInput.value = '';
          }
        }
      });
    }
  });

  // Populate edit form with course data
  function populateEditForm(course) {
    // Basic information
    document.getElementById('editCourseTitle').value = course.title || '';
    document.getElementById('editCourseDescription').value = course.description || '';
    document.getElementById('editShortDescription').value = course.shortDescription || '';

    // Settings
    document.getElementById('editCourseLevel').value = course.level || '';
    document.getElementById('editCourseCategory').value = course.category || '';
    document.getElementById('editCourseDuration').value = course.duration || '';
    document.getElementById('editCoursePrice').value = course.price || '';
    document.getElementById('editCourseDiscountPrice').value = course.discountPrice || 0;

    // Status and featured
    document.getElementById('editCourseStatus').value = course.status || 'draft';
    document.getElementById('editCourseFeatured').checked = course.isFeatured || false;

    // Sequential requirement
    document.getElementById('editCourseRequiresSequential').checked = course.requiresSequential !== undefined ? course.requiresSequential : true;

    // Fully booked
    const isFullyBooked = course.isFullyBooked || false;
    document.getElementById('editCourseIsFullyBooked').checked = isFullyBooked;
    
    // Show/hide message field based on checkbox
    const fullyBookedMessageRow = document.getElementById('fullyBookedMessageRow');
    const fullyBookedMessageSelect = document.getElementById('editCourseFullyBookedMessage');
    const customMessageRow = document.getElementById('customMessageRow');
    const customMessageInput = document.getElementById('editCourseCustomFullyBookedMessage');
    
    if (fullyBookedMessageRow) {
      fullyBookedMessageRow.style.display = isFullyBooked ? 'block' : 'none';
    }

    // Set message value - check if it's a predefined option or custom
    const messageValue = course.fullyBookedMessage || 'FULLY BOOKED';
    const predefinedOptions = ['FULLY BOOKED', 'Out of Stock', 'Enrollment Closed', 'Registration Closed', 'Sold Out', 'Not Available'];
    
    if (fullyBookedMessageSelect) {
      if (predefinedOptions.includes(messageValue)) {
        fullyBookedMessageSelect.value = messageValue;
        if (customMessageRow) customMessageRow.style.display = 'none';
        if (customMessageInput) {
          customMessageInput.value = '';
          customMessageInput.required = false;
        }
      } else {
        fullyBookedMessageSelect.value = 'other';
        if (customMessageRow) customMessageRow.style.display = 'block';
        if (customMessageInput) {
          customMessageInput.value = messageValue;
          customMessageInput.required = true;
        }
      }
    }

    // Tags
    document.getElementById('editCourseTags').value = course.tags ? course.tags.join(', ') : '';

    // Bundle selection
    const bundleSelect = document.getElementById('editCourseBundle');
    if (course.bundle && course.bundle._id) {
      bundleSelect.value = course.bundle._id;
    }

    // Thumbnail
    if (course.thumbnail) {
      document.getElementById('editCourseThumbnailUrl').value = course.thumbnail;
      document.getElementById('currentThumbnailUrl').textContent = course.thumbnail;
      document.getElementById('currentThumbnailSection').style.display = 'block';
    }

    // Set form action - use the main update endpoint
    document.getElementById('editCourseForm').action = `/admin/courses/${course.courseCode}`;
  }

  // Show edit modal
  function showEditModal() {
    const modal = new bootstrap.Modal(document.getElementById('editCourseModal'));
    modal.show();

    // Setup form validation and submission
    setupEditFormValidation();
  }

  // Setup edit form validation
  function setupEditFormValidation() {
    const form = document.getElementById('editCourseForm');
    const inputs = form.querySelectorAll('input, textarea, select');

    // Add real-time validation
    inputs.forEach(input => {
      input.addEventListener('input', function() {
        validateEditField(this);
      });

      input.addEventListener('blur', function() {
        validateEditField(this);
      });
    });

    // Handle form submission
    form.addEventListener('submit', function(e) {
      e.preventDefault();

      let isValid = true;
      inputs.forEach(input => {
        if (!validateEditField(input)) {
          isValid = false;
        }
      });

      if (isValid) {
        submitEditForm();
      } else {
        showNotification('Please fix the validation errors before submitting.', 'error');
      }
    });
  }

  // Validate edit form field
  function validateEditField(field) {
    const value = field.value.trim();
    const fieldName = field.name;
    let isValid = true;
    let errorMessage = '';

    // Clear previous error
    field.classList.remove('is-invalid');
    const errorElement = document.getElementById('edit' + fieldName.charAt(0).toUpperCase() + fieldName.slice(1) + 'Error');
    if (errorElement) {
      errorElement.textContent = '';
    }

    // Required field validation
    if (field.hasAttribute('required') && !value) {
      isValid = false;
      errorMessage = `${getEditFieldLabel(fieldName)} is required.`;
    }

    // Length validation
    if (value && field.hasAttribute('minlength')) {
      const minLength = parseInt(field.getAttribute('minlength'));
      if (value.length < minLength) {
        isValid = false;
        errorMessage = `${getEditFieldLabel(fieldName)} must be at least ${minLength} characters.`;
      }
    }

    if (value && field.hasAttribute('maxlength')) {
      const maxLength = parseInt(field.getAttribute('maxlength'));
      if (value.length > maxLength) {
        isValid = false;
        errorMessage = `${getEditFieldLabel(fieldName)} must not exceed ${maxLength} characters.`;
      }
    }

    // Number validation
    if (field.type === 'number' && value) {
      const numValue = parseFloat(value);
      if (field.hasAttribute('min') && numValue < parseFloat(field.getAttribute('min'))) {
        isValid = false;
        errorMessage = `${getEditFieldLabel(fieldName)} must be at least ${field.getAttribute('min')}.`;
      }
      if (field.hasAttribute('max') && numValue > parseFloat(field.getAttribute('max'))) {
        isValid = false;
        errorMessage = `${getEditFieldLabel(fieldName)} must not exceed ${field.getAttribute('max')}.`;
      }
    }

    // Bundle selection validation
    if (fieldName === 'bundleId' && !value) {
      isValid = false;
      errorMessage = 'Please select a bundle for this course.';
    }

    // Show error if validation failed
    if (!isValid) {
      field.classList.add('is-invalid');
      if (errorElement) {
        errorElement.textContent = errorMessage;
      }
    }

    return isValid;
  }

  // Get field label for edit form
  function getEditFieldLabel(fieldName) {
    const labels = {
      'title': 'Title',
      'description': 'Description',
      'shortDescription': 'Short Description',
      'bundleId': 'Bundle',
      'level': 'Level',
      'category': 'Category',
      'duration': 'Duration',
      'price': 'Price',
      'discountPrice': 'Discount Percentage',
      'status': 'Status'
    };
    return labels[fieldName] || fieldName;
  }

  // Submit edit form
  function submitEditForm() {
    const form = document.getElementById('editCourseForm');
    const formData = new FormData(form);
    const submitBtn = form.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;

    // Show loading state
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Updating...';
    submitBtn.disabled = true;

    // Convert FormData to JSON
    const data = {};
    for (let [key, value] of formData.entries()) {
      if (key === 'tags') {
        data[key] = value.split(',').map(tag => tag.trim()).filter(tag => tag);
      } else if (key !== 'isFeatured') {
        data[key] = value;
      }
    }

    // Add checkbox values
    data.isFeatured = document.getElementById('editCourseFeatured').checked;
    data.isFullyBooked = document.getElementById('editCourseIsFullyBooked').checked;
    data.requiresSequential = document.getElementById('editCourseRequiresSequential').checked;
    
    // Handle fully booked message - use custom if "other" is selected, otherwise use dropdown value
    const fullyBookedMessageSelect = document.getElementById('editCourseFullyBookedMessage');
    const customMessageInput = document.getElementById('editCourseCustomFullyBookedMessage');
    if (fullyBookedMessageSelect && fullyBookedMessageSelect.value === 'other' && customMessageInput) {
      data.fullyBookedMessage = customMessageInput.value.trim() || 'FULLY BOOKED';
    } else if (fullyBookedMessageSelect) {
      data.fullyBookedMessage = fullyBookedMessageSelect.value || 'FULLY BOOKED';
    } else {
      data.fullyBookedMessage = 'FULLY BOOKED';
    }

    // Debug logging
    console.log('Sending update data:', data);
    console.log('Bundle ID being sent:', data.bundleId);

    fetch(form.action, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
      })
      .then(response => {
        console.log('Response status:', response.status);
        console.log('Response headers:', response.headers);

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        // Check if response is JSON
        const contentType = response.headers.get('content-type');
        if (contentType && contentType.includes('application/json')) {
          return response.json();
        } else {
          throw new Error('Response is not JSON');
        }
      })
      .then(data => {
        console.log('Update response:', data);
        if (data.success) {
          showNotification('Course updated successfully!', 'success');

          // Close modal
          const modal = bootstrap.Modal.getInstance(document.getElementById('editCourseModal'));
          modal.hide();

          // Reload page to show updated course info
          setTimeout(() => {
            window.location.reload();
          }, 1500);
        } else {
          showNotification(data.message || 'Failed to update course', 'error');
        }
      })
      .catch(error => {
        console.error('Error updating course:', error);
        showNotification(`Error updating course: ${error.message}`, 'error');
      })
      .finally(() => {
        // Restore button state
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
      });
  }

  // Setup thumbnail upload for edit modal using Local Upload
  function setupEditThumbnailUpload() {
    const thumbnailInput = document.getElementById('editCourseThumbnail');
    const preview = document.getElementById('editCourseThumbnailPreview');
    const progress = document.getElementById('editCourseThumbnailProgress');
    const urlInput = document.getElementById('editCourseThumbnailUrl');

    if (!thumbnailInput || !preview || !progress || !urlInput) {
      console.error('Edit thumbnail upload elements not found');
      return;
    }

    // Local upload configuration
    const UPLOAD_ENDPOINT = '/api/upload/image';
    const maxFileSize = 5 * 1024 * 1024; // 5MB
    const allowedTypes = ['image/jpeg', 'image/png', 'image/jpg', 'image/webp', 'image/gif'];

    // Handle file selection
    thumbnailInput.addEventListener('change', function() {
      const file = this.files[0];
      if (file) {
        uploadEditThumbnailToLocal(file);
      }
    });

    // Handle drag and drop
    preview.addEventListener('dragover', (e) => {
      e.preventDefault();
      preview.classList.add('drag-over');
    });

    preview.addEventListener('dragleave', (e) => {
      e.preventDefault();
      preview.classList.remove('drag-over');
    });

      preview.addEventListener('drop', (e) => {
      e.preventDefault();
      preview.classList.remove('drag-over');
      const file = e.dataTransfer.files[0];
      if (file) {
        thumbnailInput.files = e.dataTransfer.files;
        uploadEditThumbnailToLocal(file);
      }
    });

    // Upload function
    function uploadEditThumbnailToLocal(file) {
      // Validate file
      if (!validateEditFile(file)) {
        return;
      }

      // Show preview
      showEditPreview(file, preview);

      // Show progress
      showEditProgress(progress, 0);

      // Upload to local server
      const formData = new FormData();
      formData.append('image', file);
      formData.append('uploadType', 'course-thumbnails');

      const xhr = new XMLHttpRequest();

      // Upload progress
      xhr.upload.addEventListener('progress', (e) => {
        if (e.lengthComputable) {
          const percent = Math.round((e.loaded / e.total) * 100);
          showEditProgress(progress, percent);
        }
      });

      // Upload complete
      xhr.addEventListener('load', () => {
        if (xhr.status === 200) {
          try {
            const response = JSON.parse(xhr.responseText);
            if (response.success && response.url) {
              urlInput.value = response.url;
              showEditSuccess(preview, progress, response.url);
            } else {
              showEditError(preview, progress, response.message || 'Upload failed. Please try again.');
            }
          } catch (e) {
            showEditError(preview, progress, 'Invalid response from server. Please try again.');
          }
        } else {
          try {
            const response = JSON.parse(xhr.responseText);
            showEditError(preview, progress, response.message || `Upload failed with status ${xhr.status}. Please try again.`);
          } catch (e) {
            showEditError(preview, progress, `Upload failed with status ${xhr.status}. Please try again.`);
          }
        }
      });

      // Upload error
      xhr.addEventListener('error', () => {
        showEditError(preview, progress, 'Upload failed. Please check your connection.');
      });

      // Start upload
      xhr.open('POST', UPLOAD_ENDPOINT, true);
      xhr.send(formData);
    }

    // Helper functions
    function validateEditFile(file) {
      if (file.size > maxFileSize) {
        const fileSizeMB = (file.size / (1024 * 1024)).toFixed(2);
        const maxSizeMB = maxFileSize / (1024 * 1024);
        showEditError(preview, progress, `File size (${fileSizeMB}MB) exceeds maximum allowed size of ${maxSizeMB}MB. Please choose a smaller image.`);
        return false;
      }

      if (!allowedTypes.includes(file.type)) {
        showEditError(preview, progress, 'Only images (JPEG, PNG, JPG, WebP, GIF) are allowed. Maximum size is 5MB.');
        return false;
      }

      return true;
    }

    function showEditPreview(file, preview) {
      const reader = new FileReader();
      reader.onload = (e) => {
        preview.innerHTML = `
        <img src="${e.target.result}" alt="Preview" class="preview-image">
        <div class="preview-overlay">
          <i class="fas fa-cloud-upload-alt"></i>
          <p>Uploading...</p>
          <small>${file.name}</small>
        </div>
      `;
      };
      reader.readAsDataURL(file);
    }

    function showEditProgress(progress, percent) {
      progress.style.display = 'block';
      progress.innerHTML = `
      <div class="progress-container">
        <div class="progress-bar">
          <div class="progress-fill" style="width: ${percent}%"></div>
        </div>
        <div class="progress-text">${percent}%</div>
      </div>
    `;
    }

    function showEditSuccess(preview, progress, url) {
      preview.innerHTML = `
      <img src="${url}" alt="Uploaded Image" class="preview-image">
      <div class="preview-overlay" style="opacity: 1; background: rgba(40, 167, 69, 0.9);">
        <i class="fas fa-check-circle" style="color: white;"></i>
        <p>Upload Successful!</p>
        <small>Image saved to server</small>
      </div>
    `;
      progress.style.display = 'none';
    }

    function showEditError(preview, progress, message) {
      preview.innerHTML = `
      <div class="preview-error">
        <i class="fas fa-exclamation-circle text-danger"></i>
        <p>Upload Error</p>
        <small>${message}</small>
      </div>
    `;
      progress.style.display = 'none';
    }
  }

  // Initialize edit functionality when page loads
  document.addEventListener('DOMContentLoaded', function() {
    setupEditThumbnailUpload();
  });

  // Notification function
  function showNotification(message, type = 'info') {
    // Remove existing notifications
    const existingNotifications = document.querySelectorAll('.notification');
    existingNotifications.forEach(notification => notification.remove());

    // Create notification element
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    notification.innerHTML = `
    <div class="notification-content">
      <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
      <span>${message}</span>
      <button class="notification-close" onclick="this.parentElement.parentElement.remove()">
        <i class="fas fa-times"></i>
      </button>
    </div>
  `;

    // Add to page
    document.body.appendChild(notification);

    // Auto remove after 5 seconds
    setTimeout(() => {
      if (notification.parentElement) {
        notification.remove();
      }
    }, 5000);
  }

  // Add form submission handler for Add Content Modal
  document.addEventListener('DOMContentLoaded', function() {
    const addContentForm = document.getElementById('addContentForm');
    if (addContentForm) {
      addContentForm.addEventListener('submit', function(e) {
        // Check content type
        const contentType = document.getElementById('contentType').value;

        // Handle zoom content separately
        if (contentType === 'zoom') {
          e.preventDefault();
          submitZoomMeeting();
          return false;
        }

        // Handle quiz content separately with AJAX
        if (contentType === 'quiz') {
          e.preventDefault();
          submitQuizContent();
          return false;
        }

        // Handle homework content separately with AJAX
        if (contentType === 'homework') {
          e.preventDefault();
          submitHomeworkContent();
          return false;
        }
      });
    }
  });

  // Quiz and Homework Management Functions
  let currentQuizStep = 1;
  let currentHomeworkStep = 1;
  let selectedQuizQuestionBankIds = [];
  let selectedHomeworkQuestionBankIds = [];
  let quizQuestions = [];
  let homeworkQuestions = [];
  let selectedQuizQuestions = [];
  let selectedHomeworkQuestions = [];
  let quizBankInfoMap = {};
  let homeworkBankInfoMap = {};
  window.currentQuizBankFilter = 'all';
  window.currentHomeworkBankFilter = 'all';

  // Quiz Functions
  function resetQuizSteps() {
    currentQuizStep = 1;
    selectedQuizQuestionBankIds = [];
    quizQuestions = [];
    selectedQuizQuestions = [];
    quizBankInfoMap = {};
    window.currentQuizBankFilter = 'all';
    updateQuizStepDisplay();
    loadQuizQuestionBanks();
  }

  function updateQuizStepDisplay() {
    // Update step indicators
    document.querySelectorAll('.quiz-step').forEach((step, index) => {
      step.classList.remove('active', 'completed');
      if (index + 1 === currentQuizStep) {
        step.classList.add('active');
      } else if (index + 1 < currentQuizStep) {
        step.classList.add('completed');
      }
    });

    // Update step content visibility
    document.querySelectorAll('.quiz-step-content').forEach((content, index) => {
      content.style.display = index + 1 === currentQuizStep ? 'block' : 'none';
    });

    // Update navigation buttons
    const prevBtn = document.getElementById('quizPrevBtn');
    const nextBtn = document.getElementById('quizNextBtn');
    const stepIndicator = document.getElementById('quizCurrentStepNumber');

    if (prevBtn) prevBtn.disabled = currentQuizStep === 1;
    if (nextBtn) {
      if (currentQuizStep === 4) {
        nextBtn.style.display = 'none';
      } else {
        nextBtn.style.display = 'inline-block';
      }
    }
    if (stepIndicator) stepIndicator.textContent = currentQuizStep;
  }

  function nextQuizStep() {
    if (currentQuizStep === 1) {
      // Validate that at least one bank is selected
      if (selectedQuizQuestionBankIds.length === 0) {
        showNotification('Please select at least one question bank', 'error');
        return;
      }
      // Load questions from selected banks
      loadQuizQuestions();
    }
    
    if (currentQuizStep === 3) {
      // Moving to Step 4 (Preview) - render the preview
      renderQuizPreview();
    }

    if (currentQuizStep < 4) {
      currentQuizStep++;
      updateQuizStepDisplay();
    }
  }

  function prevQuizStep() {
    if (currentQuizStep > 1) {
      currentQuizStep--;
      updateQuizStepDisplay();
    }
  }

  function loadQuizQuestionBanks() {
    fetch(`/admin/courses/<%= courseCode %>/topics/${currentTopicId}/question-banks`)
      .then(response => response.json())
      .then(data => {
        const grid = document.getElementById('quizQuestionBanksGrid');
        const noBanksMessage = document.getElementById('noQuizQuestionBanksMessage');

        if (data.success && data.questionBanks && data.questionBanks.length > 0) {
          grid.innerHTML = data.questionBanks.map(bank => `
            <div class="bank-card-enhanced" 
                 data-bank-id="${bank._id}" 
                 data-questions="${bank.totalQuestions || 0}" 
                 data-title="${bank.name}" 
                 data-code="${bank.bankCode || ''}" 
                 data-description="${bank.description || ''}" 
                 onclick="toggleQuizBankSelection('${bank._id}')">
              <div class="bank-card-enhanced-content">
                <div class="bank-card-enhanced-header">
                  <div class="bank-card-enhanced-icon">
                    <i class="fas fa-database"></i>
                  </div>
                  <div class="bank-card-enhanced-title-section">
                    <h5 class="bank-card-enhanced-title">${bank.name}</h5>
                    <span class="bank-card-enhanced-code">${bank.bankCode || ''}</span>
                  </div>
                </div>
                <p class="bank-card-enhanced-description">${bank.description || 'No description available'}</p>
                <div class="bank-card-enhanced-footer">
                  <div class="bank-card-enhanced-questions">
                    <i class="fas fa-question-circle"></i>
                    <span>${bank.totalQuestions || 0} questions</span>
                  </div>
                  <div class="bank-card-enhanced-select-indicator">
                    <i class="fas fa-check-circle"></i>
                    <span>Select</span>
                  </div>
                </div>
              </div>
              <input type="checkbox" id="quiz_bank_${bank._id}" value="${bank._id}" style="display: none;">
            </div>
          `).join('');
          noBanksMessage.style.display = 'none';
        } else {
          grid.innerHTML = '';
          noBanksMessage.style.display = 'block';
        }
      })
      .catch(error => {
        console.error('Error loading question banks:', error);
        showNotification('Error loading question banks', 'error');
      });
  }

  function toggleQuizBankSelection(bankId) {
    const bankCard = document.querySelector(`#quizQuestionBanksGrid [data-bank-id="${bankId}"]`);
    const checkbox = bankCard.querySelector('input[type="checkbox"]');
    const isCurrentlySelected = selectedQuizQuestionBankIds.includes(bankId);

    if (isCurrentlySelected) {
      // Remove bank from selection
      const index = selectedQuizQuestionBankIds.indexOf(bankId);
      if (index > -1) {
        selectedQuizQuestionBankIds.splice(index, 1);
        bankCard.classList.remove('selected');
        checkbox.checked = false;

        // Remove questions from this bank
        selectedQuizQuestions = selectedQuizQuestions.filter(sq => sq.sourceBank !== bankId);
        quizQuestions = quizQuestions.filter(q => q.sourceBank !== bankId);
      }
    } else {
      // Add bank to selection
      selectedQuizQuestionBankIds.push(bankId);
      bankCard.classList.add('selected');
      checkbox.checked = true;
    }

    updateQuizBanksCount();

    // Reload questions if banks changed
    if (selectedQuizQuestionBankIds.length > 0) {
      loadQuizQuestions();
    } else {
      document.getElementById('quizQuestionsGrid').innerHTML = '';
      document.getElementById('noQuizQuestionsMessage').style.display = 'flex';
    }
  }

  function updateQuizBanksCount() {
    const count = selectedQuizQuestionBankIds.length;
    const countElement = document.getElementById('quizSelectedBanksCount');
    if (countElement) countElement.textContent = `(${count} selected)`;
  }

  function loadQuizQuestions() {
    if (selectedQuizQuestionBankIds.length === 0) {
      showNotification('No banks selected', 'error');
      return;
    }

    fetch('/admin/quizzes/api/banks/multiple/questions', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          bankIds: selectedQuizQuestionBankIds
        })
      })
      .then(response => response.json())
      .then(result => {
        if (result.success && result.questions) {
          quizQuestions = [];
          quizBankInfoMap = {};

          // Flatten and add sourceBank to each question
          Object.entries(result.questions).forEach(([bankId, questions]) => {
            if (Array.isArray(questions)) {
              const bankCard = document.querySelector(`#quizQuestionBanksGrid [data-bank-id="${bankId}"]`);
              const bankName = bankCard ? bankCard.dataset.title : 'Unknown Bank';
              const bankCode = bankCard ? bankCard.dataset.code : '';

              quizBankInfoMap[bankId] = {
                name: bankName,
                code: bankCode
              };

              questions.forEach(q => {
                quizQuestions.push({
                  ...q,
                  sourceBank: bankId
                });
              });
            }
          });

          displayQuizQuestions(result.questions);
          showNotification(`Loaded ${quizQuestions.length} questions from ${selectedQuizQuestionBankIds.length} bank(s)`, 'success');
        } else {
          showNotification(result.message || 'Failed to load questions', 'error');
        }
      })
      .catch(error => {
        console.error('Error loading questions:', error);
        showNotification('An error occurred while loading questions', 'error');
      });
  }

  function displayQuizQuestions(questionsByBank) {
    const grid = document.getElementById('quizQuestionsGrid');
    const noQuestionsMessage = document.getElementById('noQuizQuestionsMessage');

    if (!questionsByBank || typeof questionsByBank !== 'object' || Object.keys(questionsByBank).length === 0) {
      grid.innerHTML = '';
      noQuestionsMessage.style.display = 'flex';
      return;
    }

    noQuestionsMessage.style.display = 'none';

    // Reset all questions array
    quizQuestions = [];

    // Flatten all questions and store bank info
    let questionHTML = '';
    let globalIndex = 0;

    Object.entries(questionsByBank).forEach(([bankId, questions]) => {
      const bankCard = document.querySelector(`#quizQuestionBanksGrid [data-bank-id="${bankId}"]`);
      const bankName = bankCard ? bankCard.dataset.title : 'Unknown Bank';

      // Store bank info
      if (!quizBankInfoMap[bankId]) {
        quizBankInfoMap[bankId] = {
          name: bankName,
          code: bankCard ? bankCard.dataset.code : ''
        };
      }

      // Add questions to quizQuestions array
      questions.forEach((question) => {
        quizQuestions.push({
          ...question,
          sourceBank: bankId
        });

        const difficultyClass = question.difficulty || 'medium';
        const questionTags = question.tags || [];
        const tagsJson = JSON.stringify(questionTags);

        questionHTML += `
          <div class="question-item ${difficultyClass}" 
               onclick="toggleQuizQuestion(${globalIndex})" 
               data-question-index="${globalIndex}"
               data-bank-id="${bankId}"
               data-question-id="${question._id}"
               data-tags='${tagsJson}'>
            <div class="question-item-top">
              <div class="question-item-number">${globalIndex + 1}</div>
              <button type="button" class="question-preview-btn" onclick="event.stopPropagation(); previewQuizQuestion(${globalIndex})" title="Preview Question">
                <i class="fas fa-eye"></i>
              </button>
            </div>
            <div class="question-item-content">
              <div class="question-item-header">
                <div class="question-item-bank">
                  <i class="fas fa-database"></i>
                  <span>${bankName}</span>
                </div>
              </div>
              <div class="question-item-footer">
                <span class="question-badge type-badge">${question.questionType || 'MCQ'}</span>
              </div>
            </div>
            <div class="question-check-indicator">
              <i class="fas fa-check-circle"></i>
            </div>
          </div>
        `;
        globalIndex++;
      });
    });

    grid.innerHTML = questionHTML;

    // Update bank filter buttons
    updateQuizBankFilterButtons();

    // Reset bank filter to 'all' when questions are loaded
    window.currentQuizBankFilter = 'all';
    const allBanksBtn = document.querySelector('#quizBankFilterButtons .bank-filter-btn[data-bank-id="all"]');
    if (allBanksBtn) {
      document.querySelectorAll('#quizBankFilterButtons .bank-filter-btn').forEach(btn => btn.classList.remove('active'));
      allBanksBtn.classList.add('active');
    }

    // Restore visual state of selected questions
    restoreQuizQuestionSelection();
    updateQuizSelectionSummary();
    
    // Populate tags filter
    populateTagsFilter('quizTagsFilter', quizQuestions);
  }

  // Update Quiz Bank Filter Buttons
  function updateQuizBankFilterButtons() {
    const bankFilterButtons = document.getElementById('quizBankFilterButtons');
    if (!bankFilterButtons) return;

    // Get the "All Banks" button HTML first
    const allBanksBtn = bankFilterButtons.querySelector('[data-bank-id="all"]');
    let buttonsHTML = '';

    if (allBanksBtn) {
      buttonsHTML = allBanksBtn.outerHTML;
    } else {
      buttonsHTML = `
        <button type="button" class="bank-filter-btn active" data-bank-id="all" onclick="filterQuizByBank('all')">
          <i class="fas fa-th"></i>
          All Banks
        </button>
      `;
    }

    // Add individual bank buttons
    Object.entries(quizBankInfoMap).forEach(([bankId, bankInfo]) => {
      buttonsHTML += `
        <button type="button" class="bank-filter-btn" data-bank-id="${bankId}" onclick="filterQuizByBank('${bankId}')">
          <i class="fas fa-database"></i>
          ${bankInfo.name}
        </button>
      `;
    });

    bankFilterButtons.innerHTML = buttonsHTML;
  }

  // Filter Quiz by Bank
  function filterQuizByBank(bankId) {
    // Update active button
    document.querySelectorAll('#quizBankFilterButtons .bank-filter-btn').forEach(btn => {
      btn.classList.remove('active');
    });
    const activeBtn = document.querySelector(`#quizBankFilterButtons .bank-filter-btn[data-bank-id="${bankId}"]`);
    if (activeBtn) {
      activeBtn.classList.add('active');
    }

    // Store current bank filter
    window.currentQuizBankFilter = bankId;

    // Filter questions
    const questionItems = document.querySelectorAll('#quizQuestionsGrid .question-item');
    questionItems.forEach(item => {
      if (bankId === 'all') {
        item.style.display = '';
      } else {
        const itemBankId = item.dataset.bankId;
        item.style.display = itemBankId === bankId ? '' : 'none';
      }
    });

    // Also apply other active filters
    filterQuizQuestions();
  }

  // Filter Quiz Questions
  function filterQuizQuestions() {
    const difficultyFilter = document.getElementById('quizDifficultyFilter')?.value || '';
    const typeFilter = document.getElementById('quizTypeFilter')?.value || '';
    const tagsFilter = document.getElementById('quizTagsFilter')?.value || '';
    const searchFilter = document.getElementById('quizSearchFilter')?.value.toLowerCase() || '';
    const activeBankFilter = window.currentQuizBankFilter || document.querySelector('#quizBankFilterButtons .bank-filter-btn.active')?.dataset.bankId || 'all';

    // Filter question items
    const questionElements = document.querySelectorAll('#quizQuestionsGrid .question-item');

    questionElements.forEach(element => {
      const questionIndex = parseInt(element.dataset.questionIndex);
      const question = quizQuestions[questionIndex];

      if (!question) return;

      let show = true;

      // Check bank filter first
      if (activeBankFilter !== 'all' && element.dataset.bankId !== activeBankFilter) {
        show = false;
      }

      // Check difficulty filter
      if (show && difficultyFilter && question.difficulty && question.difficulty.toLowerCase() !== difficultyFilter.toLowerCase()) {
        show = false;
      }

      // Check type filter
      if (show && typeFilter && question.questionType !== typeFilter) {
        show = false;
      }

      // Check tags filter
      if (show && tagsFilter) {
        const questionTags = question.tags || [];
        const hasTag = questionTags.some(tag => 
          tag && tag.toString().toLowerCase() === tagsFilter.toLowerCase()
        );
        if (!hasTag) {
          show = false;
        }
      }

      // Check search filter
      if (show && searchFilter && question.questionText && !question.questionText.toLowerCase().includes(searchFilter)) {
        show = false;
      }

      // Show/hide the element
      element.style.display = show ? '' : 'none';
    });
  }

  function restoreQuizQuestionSelection() {
    // Clear all selections first
    document.querySelectorAll('#quizQuestionsGrid .question-item').forEach(item => {
      item.classList.remove('selected');
    });

    // Restore selections based on selectedQuizQuestions array
    selectedQuizQuestions.forEach(selection => {
      const questionIndex = quizQuestions.findIndex(q => {
        const qId = q._id?.toString() || q._id;
        const sId = selection.question?.toString() || selection.question;
        return qId === sId;
      });
      if (questionIndex !== -1) {
        const questionElement = document.querySelector(`#quizQuestionsGrid [data-question-index="${questionIndex}"]`);
        if (questionElement) {
          questionElement.classList.add('selected');
        }
      }
    });
  }

  function toggleQuizQuestion(index) {
    const questionElement = document.querySelector(`#quizQuestionsGrid [data-question-index="${index}"]`);
    const question = quizQuestions[index];
    const questionId = question._id;
    const sourceBank = question.sourceBank;
    const existingIndex = selectedQuizQuestions.findIndex(sq => {
      const qId = sq.question?.toString() || sq.question;
      const currentId = questionId?.toString() || questionId;
      return qId === currentId;
    });

    if (existingIndex > -1) {
      // Remove from selection
      selectedQuizQuestions.splice(existingIndex, 1);
      questionElement.classList.remove('selected');
    } else {
      // Add to selection with sourceBank
      selectedQuizQuestions.push({
        question: questionId,
        sourceBank: sourceBank,
        order: selectedQuizQuestions.length + 1,
        points: question.points || 1
      });
      questionElement.classList.add('selected');
    }

    updateQuizSelectionSummary();
  }

  function selectAllQuizQuestions() {
    // Only select visible questions
    const visibleQuestions = Array.from(document.querySelectorAll('#quizQuestionsGrid .question-item'))
      .filter(item => item.style.display !== 'none')
      .map(item => {
        const index = parseInt(item.dataset.questionIndex);
        return quizQuestions[index];
      })
      .filter(q => q);

    selectedQuizQuestions = visibleQuestions.map(question => ({
      question: question._id,
      sourceBank: question.sourceBank,
      order: selectedQuizQuestions.length + 1,
      points: question.points || 1
    }));

    document.querySelectorAll('#quizQuestionsGrid .question-item').forEach((item) => {
      if (item.style.display !== 'none') {
        item.classList.add('selected');
      }
    });

    updateQuizSelectionSummary();
    showNotification(`Selected ${visibleQuestions.length} visible questions`, 'success');
  }

  function clearQuizSelection() {
    selectedQuizQuestions = [];
    document.querySelectorAll('#quizQuestionsGrid .question-item').forEach(item => {
      item.classList.remove('selected');
    });
    updateQuizSelectionSummary();
    showNotification('Cleared all selections', 'info');
  }

  function selectEvenQuizQuestions() {
    clearQuizSelection();
    let selectedCount = 0;

    for (let i = 1; i < quizQuestions.length; i += 2) {
      const question = quizQuestions[i];
      selectedQuizQuestions.push({
        question: question._id,
        sourceBank: question.sourceBank,
        order: selectedQuizQuestions.length + 1,
        points: question.points || 1
      });
      document.querySelector(`#quizQuestionsGrid [data-question-index="${i}"]`).classList.add('selected');
      selectedCount++;
    }

    updateQuizSelectionSummary();
    showNotification(`Selected ${selectedCount} even-numbered questions`, 'success');
  }

  function selectOddQuizQuestions() {
    clearQuizSelection();
    let selectedCount = 0;

    for (let i = 0; i < quizQuestions.length; i += 2) {
      const question = quizQuestions[i];
      selectedQuizQuestions.push({
        question: question._id,
        sourceBank: question.sourceBank,
        order: selectedQuizQuestions.length + 1,
        points: question.points || 1
      });
      document.querySelector(`#quizQuestionsGrid [data-question-index="${i}"]`).classList.add('selected');
      selectedCount++;
    }

    updateQuizSelectionSummary();
    showNotification(`Selected ${selectedCount} odd-numbered questions`, 'success');
  }

  function selectRandomQuizQuestions() {
    clearQuizSelection();
    const count = Math.ceil(quizQuestions.length * 0.3);
    const randomIndices = [];

    while (randomIndices.length < count) {
      const randomIndex = Math.floor(Math.random() * quizQuestions.length);
      if (!randomIndices.includes(randomIndex)) {
        randomIndices.push(randomIndex);
      }
    }

    randomIndices.forEach(index => {
      const question = quizQuestions[index];
      selectedQuizQuestions.push({
        question: question._id,
        sourceBank: question.sourceBank,
        order: selectedQuizQuestions.length + 1,
        points: question.points || 1
      });
      document.querySelector(`#quizQuestionsGrid [data-question-index="${index}"]`).classList.add('selected');
    });

    updateQuizSelectionSummary();
    showNotification(`Randomly selected ${count} questions`, 'success');
  }

  function selectQuizRange() {
    const rangeInput = document.getElementById('quizRangeInput').value.trim();
    if (!rangeInput) {
      showNotification('Please enter a range (e.g., 1-5, 3, 7-10)', 'error');
      return;
    }

    clearQuizSelection();

    const ranges = rangeInput.split(',');
    let selectedCount = 0;

    ranges.forEach(rangeStr => {
      const trimmed = rangeStr.trim();
      if (trimmed.includes('-')) {
        // Range (e.g., "1-5")
        const [start, end] = trimmed.split('-').map(n => parseInt(n.trim()) - 1);
        for (let i = start; i <= end && i < quizQuestions.length; i++) {
          if (i >= 0) {
            const question = quizQuestions[i];
            selectedQuizQuestions.push({
              question: question._id,
              sourceBank: question.sourceBank,
              order: selectedQuizQuestions.length + 1,
              points: question.points || 1
            });
            const questionElement = document.querySelector(`#quizQuestionsGrid [data-question-index="${i}"]`);
            if (questionElement) questionElement.classList.add('selected');
            selectedCount++;
          }
        }
      } else {
        // Single number (e.g., "3")
        const index = parseInt(trimmed) - 1;
        if (index >= 0 && index < quizQuestions.length) {
          const question = quizQuestions[index];
          selectedQuizQuestions.push({
            question: question._id,
            sourceBank: question.sourceBank,
            order: selectedQuizQuestions.length + 1,
            points: question.points || 1
          });
          document.querySelector(`#quizQuestionsGrid [data-question-index="${index}"]`).classList.add('selected');
          selectedCount++;
        }
      }
    });

    updateQuizSelectionSummary();

    if (selectedCount > 0) {
      showNotification(`Selected ${selectedCount} questions from range`, 'success');
    } else {
      showNotification('No valid questions found in the specified range', 'warning');
    }

    // Clear the input
    document.getElementById('quizRangeInput').value = '';
  }

  function updateQuizQuestionsCount() {
    const countElement = document.getElementById('quizQuestionsCount');
    if (countElement) {
      countElement.textContent = `(${quizQuestions.length} questions)`;
    }
  }

  function updateQuizSelectionSummary() {
    const selectedCount = document.getElementById('quizSelectedCount');
    const totalPoints = document.getElementById('quizTotalPoints');
    const easyCount = document.getElementById('quizEasyCount');
    const mediumCount = document.getElementById('quizMediumCount');
    const hardCount = document.getElementById('quizHardCount');

    if (selectedCount) selectedCount.textContent = selectedQuizQuestions.length;

    let points = 0;
    let easy = 0,
      medium = 0,
      hard = 0;

    selectedQuizQuestions.forEach(selection => {
      const question = quizQuestions.find(q => {
        const qId = q._id?.toString() || q._id;
        const sId = selection.question?.toString() || selection.question;
        return qId === sId;
      });
      if (question) {
        points += question.points || 1;

        const difficulty = question.difficulty || 'medium';
        if (difficulty.toLowerCase() === 'easy') easy++;
        else if (difficulty.toLowerCase() === 'hard') hard++;
        else medium++;
      }
    });

    if (totalPoints) totalPoints.textContent = points;
    if (easyCount) easyCount.textContent = easy;
    if (mediumCount) mediumCount.textContent = medium;
    if (hardCount) hardCount.textContent = hard;
  }

  function previewQuizQuestion(index) {
    const question = quizQuestions[index];
    if (!question) return;

    showQuestionPreview(question, `Quiz Question ${index + 1}`);
  }

  function previewHomeworkQuestion(index) {
    const question = homeworkQuestions[index];
    if (!question) return;

    showQuestionPreview(question, `Homework Question ${index + 1}`);
  }

  // Preview functions for edit quiz/homework
  function previewEditQuizQuestion(index) {
    const question = editQuizQuestions[index];
    if (!question) return;

    showQuestionPreview(question, `Edit Quiz Question ${index + 1}`);
  }

  function previewEditHomeworkQuestion(index) {
    const question = editHomeworkQuestions[index];
    if (!question) return;

    showQuestionPreview(question, `Edit Homework Question ${index + 1}`);
  }

  function showQuestionPreview(question, title) {
    const modalBody = document.getElementById('questionPreviewBody');
    if (!modalBody) return;

    // Create question preview content
    let previewContent = `
    <div class="question-preview">
      <div class="question-header">
        <div class="question-title">
          ${question.questionText && question.questionText.includes('\\') ? 
            `<math-field readonly 
              style="width: 100%; min-height: 40px; font-size: 16px; border: none; background: transparent; padding: 8px;"
              class="preview-math-field">
              ${question.questionText}
            </math-field>` : 
            (question.questionText || 'Question text not available')}
        </div>
        ${question.questionImage && question.questionImage.trim() !== '' ? `<div class="question-image-container"><img src="${question.questionImage}" alt="Question Image" class="question-image" /></div>` : ''}
        <div class="question-meta">
          <span class="badge bg-${question.difficulty === 'easy' ? 'success' : question.difficulty === 'hard' ? 'danger' : 'warning'}">
            ${(question.difficulty || 'medium').toUpperCase()}
          </span>
          <span class="badge bg-info">${question.points || 1} Points</span>
          <span class="badge bg-secondary">${question.questionType || 'MCQ'}</span>
        </div>
      </div>
      <div class="question-content">
  `;

    // Handle different question types
    if (question.questionType === 'Written') {
      // For written questions, show correct answers with mandatory/optional status
      const correctAnswers = question.correctAnswers || [];
      if (correctAnswers.length > 0) {
        previewContent += `
        <div class="question-answers">
          <h6><i class="fas fa-edit me-2"></i>Correct Answers:</h6>
          <div class="answers-list">
      `;

        correctAnswers.forEach((answer, index) => {
          // Handle both old string format and new object format
          let answerText = '';
          let isMandatory = true;

          if (typeof answer === 'string') {
            answerText = answer;
          } else if (typeof answer === 'object' && answer.text) {
            answerText = answer.text;
            isMandatory = answer.isMandatory !== false; // Default to true if not specified
          }

          // Check if answer contains LaTeX
          let answerTextHtml = '';
          if (answerText && answerText.includes('\\')) {
            // Render math for answer text
            answerTextHtml = `
            <math-field readonly 
              style="width: 100%; min-height: 30px; font-size: 14px; border: none; background: transparent; padding: 4px;"
              class="preview-math-field answer-math-field">
              ${answerText}
            </math-field>
          `;
          } else {
            answerTextHtml = answerText;
          }

          const mandatoryClass = isMandatory ? 'mandatory' : 'optional';
          const mandatoryIcon = isMandatory ? 'fas fa-lock' : 'fas fa-unlock';
          const mandatoryText = isMandatory ? 'Mandatory' : 'Optional';

          previewContent += `
          <div class="answer-item ${mandatoryClass}">
            <span class="answer-label">${String.fromCharCode(65 + index)}</span>
            <div class="answer-text">${answerTextHtml}</div>
            <div class="answer-status">
              <i class="${mandatoryIcon}"></i>
              <span>${mandatoryText}</span>
            </div>
          </div>
        `;
        });

        previewContent += `
          </div>
        </div>
      `;
      } else {
        previewContent += `
        <div class="question-answers">
          <h6><i class="fas fa-edit me-2"></i>Correct Answers:</h6>
          <div class="no-answers">
            <i class="fas fa-exclamation-triangle text-warning"></i>
            <span>No correct answers defined</span>
          </div>
        </div>
      `;
      }
    } else if (question.options && question.options.length > 0) {
      // For MCQ and True/False questions, show options
      previewContent += `
      <div class="question-options">
        <h6><i class="fas fa-list me-2"></i>Answer Options:</h6>
        <div class="options-list">
    `;

      question.options.forEach((option, index) => {
        // Check if this option is correct
        const isCorrect = option && typeof option === 'object' && option.isCorrect === true;

        // Get option text and image
        const optionText = typeof option === 'string' ? option : (option.text || option.option || option);
        const optionImage = option && typeof option === 'object' && option.image && option.image.trim() !== '' ? option.image : null;

        // Check if option text contains LaTeX
        let optionTextHtml = '';
        if (optionText && optionText.includes('\\')) {
          optionTextHtml = `
          <math-field readonly 
            style="width: 100%; min-height: 25px; font-size: 14px; border: none; background: transparent; padding: 2px;"
            class="preview-math-field option-math-field">
            ${optionText}
          </math-field>
        `;
        } else {
          optionTextHtml = optionText;
        }

        previewContent += `
        <div class="option-item ${isCorrect ? 'correct' : ''}">
          <div class="option-letter">${String.fromCharCode(65 + index)}</div>
          <div class="option-content">
            <div class="option-text">${optionTextHtml}</div>
            ${optionImage ? `<div class="option-image-container"><img src="${optionImage}" alt="Option Image" class="option-image" /></div>` : ''}
          </div>
          ${isCorrect ? '<div class="correct-indicator"><i class="fas fa-check-circle"></i> âœ“ Correct Answer</div>' : ''}
        </div>
      `;
      });

      previewContent += `
        </div>
      </div>
    `;
    }

    // Add explanation if available
    if (question.explanation || question.explanationImage) {
      let explanationHtml = '';
      if (question.explanation && question.explanation.includes('\\')) {
        explanationHtml = `
        <math-field readonly 
          style="width: 100%; min-height: 30px; font-size: 14px; border: none; background: transparent; padding: 4px;"
          class="preview-math-field explanation-math-field">
          ${question.explanation}
        </math-field>
      `;
      } else {
        explanationHtml = question.explanation || '';
      }

      previewContent += `
      <div class="question-explanation">
        <h6><i class="fas fa-lightbulb me-2"></i>Explanation:</h6>
        <div class="explanation-content">${explanationHtml}</div>
        ${question.explanationImage && question.explanationImage.trim() !== '' ? `<div class="explanation-image-container"><img src="${question.explanationImage}" alt="Explanation Image" class="explanation-image" /></div>` : ''}
      </div>
    `;
    }

    previewContent += `
      </div>
    </div>
  `;

    modalBody.innerHTML = previewContent;

    // Show the modal
    const modal = new bootstrap.Modal(document.getElementById('questionPreviewModal'));
    modal.show();
  }

  // Homework Functions
  function resetHomeworkSteps() {
    currentHomeworkStep = 1;
    selectedHomeworkQuestionBankIds = [];
    homeworkQuestions = [];
    selectedHomeworkQuestions = [];
    homeworkBankInfoMap = {};
    window.currentHomeworkBankFilter = 'all';
    updateHomeworkStepDisplay();
    loadHomeworkQuestionBanks();
  }

  function updateHomeworkStepDisplay() {
    // Update step indicators
    document.querySelectorAll('.homework-step').forEach((step, index) => {
      step.classList.remove('active', 'completed');
      if (index + 1 === currentHomeworkStep) {
        step.classList.add('active');
      } else if (index + 1 < currentHomeworkStep) {
        step.classList.add('completed');
      }
    });

    // Update step content visibility
    document.querySelectorAll('.homework-step-content').forEach((content, index) => {
      content.style.display = index + 1 === currentHomeworkStep ? 'block' : 'none';
    });

    // Update navigation buttons
    const prevBtn = document.getElementById('homeworkPrevBtn');
    const nextBtn = document.getElementById('homeworkNextBtn');
    const stepIndicator = document.getElementById('homeworkCurrentStepNumber');

    if (prevBtn) prevBtn.disabled = currentHomeworkStep === 1;
    if (nextBtn) {
      if (currentHomeworkStep === 4) {
        nextBtn.style.display = 'none';
      } else {
        nextBtn.style.display = 'inline-block';
      }
    }
    if (stepIndicator) stepIndicator.textContent = currentHomeworkStep;
  }

  function nextHomeworkStep() {
    if (currentHomeworkStep === 1) {
      // Validate that at least one bank is selected
      if (selectedHomeworkQuestionBankIds.length === 0) {
        showNotification('Please select at least one question bank', 'error');
        return;
      }
      // Load questions from selected banks
      loadHomeworkQuestions();
    }
    
    if (currentHomeworkStep === 3) {
      // Moving to Step 4 (Preview) - render the preview
      renderHomeworkPreview();
    }

    if (currentHomeworkStep < 4) {
      currentHomeworkStep++;
      updateHomeworkStepDisplay();
    }
  }

  function prevHomeworkStep() {
    if (currentHomeworkStep > 1) {
      currentHomeworkStep--;
      updateHomeworkStepDisplay();
    }
  }

  // ============================================
  // Preview Functions for Quiz and Homework
  // ============================================
  
  // Quiz Preview State
  let currentQuizPreviewIndex = 0;
  
  // Homework Preview State
  let currentHomeworkPreviewIndex = 0;
  
  function renderQuizPreview() {
    const questions = selectedQuizQuestions;
    const cardContainer = document.getElementById('quizPreviewQuestionCard');
    const dotsContainer = document.getElementById('quizPreviewDots');
    const totalNumEl = document.getElementById('quizPreviewTotalNum');
    const currentNumEl = document.getElementById('quizPreviewCurrentNum');
    
    if (!questions || questions.length === 0) {
      cardContainer.innerHTML = `
        <div class="preview-empty-state">
          <i class="fas fa-clipboard-list fa-3x text-muted mb-3"></i>
          <p class="text-muted">No questions selected. Go back to Step 2 to select questions.</p>
        </div>
      `;
      dotsContainer.innerHTML = '';
      totalNumEl.textContent = '0';
      currentNumEl.textContent = '0';
      return;
    }
    
    currentQuizPreviewIndex = 0;
    totalNumEl.textContent = questions.length;
    
    // Render dots
    dotsContainer.innerHTML = questions.map((_, index) => 
      `<span class="preview-dot ${index === 0 ? 'active' : ''}" onclick="goToQuizPreviewQuestion(${index})"></span>`
    ).join('');
    
    renderQuizPreviewQuestion(0);
  }
  
  function renderQuizPreviewQuestion(index) {
    const selectedQuestions = selectedQuizQuestions;
    if (!selectedQuestions || index < 0 || index >= selectedQuestions.length) return;
    
    currentQuizPreviewIndex = index;
    const selectedItem = selectedQuestions[index];
    
    // Look up the full question data from quizQuestions array
    const questionId = selectedItem.question?.toString() || selectedItem.question;
    const fullQuestion = quizQuestions.find(q => {
      const qId = q._id?.toString() || q._id;
      return qId === questionId;
    });
    
    // Merge selected item data (like points) with full question data
    const question = fullQuestion ? { ...fullQuestion, points: selectedItem.points || fullQuestion.points || 1 } : selectedItem;
    
    const cardContainer = document.getElementById('quizPreviewQuestionCard');
    const currentNumEl = document.getElementById('quizPreviewCurrentNum');
    const dotsContainer = document.getElementById('quizPreviewDots');
    
    currentNumEl.textContent = index + 1;
    
    // Update dots
    dotsContainer.querySelectorAll('.preview-dot').forEach((dot, i) => {
      dot.classList.toggle('active', i === index);
    });
    
    // Render question card
    cardContainer.innerHTML = renderPreviewQuestionCard(question, index + 1);
  }
  
  function renderPreviewQuestionCard(question, number) {
    const difficulty = (question.difficulty || 'Medium').toLowerCase();
    const points = question.points || 1;
    
    let optionsHtml = '';
    
    if (question.questionType === 'MCQ' && question.options && question.options.length > 0) {
      optionsHtml = question.options.map((opt, i) => {
        const isCorrect = opt.isCorrect;
        const optionLetter = String.fromCharCode(65 + i);
        const optionText = parseMathExpressionsPreview(opt.text || '');
        return `
          <div class="preview-option ${isCorrect ? 'correct' : ''}">
            <span class="preview-option-letter">${optionLetter}</span>
            <span class="preview-option-text">${optionText}</span>
            ${isCorrect ? '<i class="fas fa-check-circle preview-correct-icon"></i>' : ''}
          </div>
        `;
      }).join('');
    } else if (question.questionType === 'True/False') {
      const correctAnswer = question.correctAnswer === true || question.correctAnswer === 'true' || question.correctAnswer === 'True';
      optionsHtml = `
        <div class="preview-option ${correctAnswer ? 'correct' : ''}">
          <span class="preview-option-letter">A</span>
          <span class="preview-option-text">True</span>
          ${correctAnswer ? '<i class="fas fa-check-circle preview-correct-icon"></i>' : ''}
        </div>
        <div class="preview-option ${!correctAnswer ? 'correct' : ''}">
          <span class="preview-option-letter">B</span>
          <span class="preview-option-text">False</span>
          ${!correctAnswer ? '<i class="fas fa-check-circle preview-correct-icon"></i>' : ''}
        </div>
      `;
    } else if (question.questionType === 'Written') {
      const correctAnswers = question.correctAnswers || [];
      let answersHtml = '';
      
      if (correctAnswers.length > 0) {
        answersHtml = correctAnswers.map((answer, index) => {
          let answerText = '';
          let isMandatory = true;
          
          if (typeof answer === 'string') {
            answerText = answer;
          } else if (typeof answer === 'object' && answer.text) {
            answerText = answer.text;
            isMandatory = answer.isMandatory !== false;
          }
          
          const parsedAnswerText = parseMathExpressionsPreview(answerText);
          const letter = String.fromCharCode(65 + index);
          const statusClass = isMandatory ? 'mandatory' : 'optional';
          const statusIcon = isMandatory ? 'fas fa-lock' : 'fas fa-unlock';
          const statusText = isMandatory ? 'Mandatory' : 'Optional';
          
          return `
            <div class="preview-written-answer ${statusClass}">
              <span class="preview-answer-letter">${letter}</span>
              <span class="preview-answer-text">${parsedAnswerText}</span>
              <span class="preview-answer-status">
                <i class="${statusIcon}"></i> ${statusText}
              </span>
            </div>
          `;
        }).join('');
      }
      
      optionsHtml = `
        <div class="preview-written-indicator">
          <i class="fas fa-pen-fancy me-2"></i>
          <span>Written Answer Required</span>
        </div>
        ${answersHtml ? `
          <div class="preview-correct-answers">
            <div class="preview-answers-title"><i class="fas fa-check-circle me-2"></i>Correct Answers:</div>
            ${answersHtml}
          </div>
        ` : ''}
      `;
    }
    
    const questionText = parseMathExpressionsPreview(question.questionText || question.question || '');
    
    const imageHtml = question.imageUrl || question.questionImage ? `
      <div class="preview-question-image">
        <img src="${question.imageUrl || question.questionImage}" alt="Question image">
      </div>
    ` : '';
    
    return `
      <div class="preview-question-header-modern">
        <div class="preview-header-left">
          <span class="preview-question-badge">Q${number}</span>
          <h3 class="preview-question-title-text">Question Preview</h3>
        </div>
        <div class="preview-header-right">
          <span class="preview-difficulty-badge ${difficulty}">
            <i class="fas fa-${difficulty === 'easy' ? 'check-circle' : difficulty === 'medium' ? 'exclamation-circle' : 'times-circle'} me-1"></i>
            ${difficulty.charAt(0).toUpperCase() + difficulty.slice(1)}
          </span>
          <span class="preview-points-badge">
            <i class="fas fa-medal me-1"></i>
            ${points} pts
          </span>
        </div>
      </div>
      <div class="preview-question-container">
        <div class="preview-question-text-box">
          <div class="preview-question-label">
            <i class="fas fa-question-circle me-2"></i>Question:
          </div>
          <div class="preview-question-text-content">${questionText}</div>
        </div>
        ${imageHtml}
        <div class="preview-options-wrapper">
          <div class="preview-options-title">Answer Options:</div>
          <div class="preview-options-grid">
            ${optionsHtml}
          </div>
        </div>
      </div>
    `;
  }
  
  // Parse math expressions and render with math-field elements
  function parseMathExpressionsPreview(text) {
    if (!text) return '';
    
    // Check if the text contains LaTeX markers even without $ delimiters
    const hasLaTeXMarkers = /[\\^_{}]/.test(text) || /[Î±-Ï‰Î‘-Î©Ï€âˆžâˆ«âˆ‘âˆâˆšâ‰¤â‰¥â‰ â‰ˆ]/.test(text);
    const hasDelimiters = text.includes('$');

    // If no $ delimiters but has LaTeX markers, treat the whole block as math
    if (!hasDelimiters && hasLaTeXMarkers) {
      const mathId = `preview-math-full-${Date.now()}`;
      return `<math-field id="${mathId}" readonly style="display: inline-block; min-height: 24px; font-size: 16px; border: none; background: transparent; padding: 2px 4px; vertical-align: middle;" class="preview-math-field">${escapeHtmlPreview(text)}</math-field>`;
    }

    // Regular expression to match $...$ patterns (non-greedy)
    const mathPattern = /\$([^$]+)\$/g;
    const parts = [];
    let lastIndex = 0;
    let match;
    let mathIndex = 0;
    
    while ((match = mathPattern.exec(text)) !== null) {
      // Add text before the math expression
      if (match.index > lastIndex) {
        parts.push({
          type: 'text',
          content: text.substring(lastIndex, match.index)
        });
      }
      
      // Add the math expression
      parts.push({
        type: 'math',
        content: match[1], // Content inside $...$
        index: mathIndex++
      });
      
      lastIndex = match.index + match[0].length;
    }
    
    // Add remaining text after the last math expression
    if (lastIndex < text.length) {
      parts.push({
        type: 'text',
        content: text.substring(lastIndex)
      });
    }
    
    // If no math expressions found, return escaped text
    if (parts.length === 0) {
      return escapeHtmlPreview(text);
    }
    
    // Build HTML with MathLive fields for math expressions
    let html = '';
    parts.forEach(part => {
      if (part.type === 'text') {
        html += escapeHtmlPreview(part.content);
      } else {
        // Create a unique ID for each math field
        const mathId = `preview-math-${Date.now()}-${part.index}`;
        html += `<math-field id="${mathId}" readonly style="display: inline-block; min-height: 24px; font-size: 16px; border: none; background: transparent; padding: 2px 4px; vertical-align: middle;" class="preview-math-field">${escapeHtmlPreview(part.content)}</math-field>`;
      }
    });
    
    return html;
  }
  
  // Escape HTML to prevent XSS
  function escapeHtmlPreview(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }
  
  function prevQuizPreviewQuestion() {
    if (currentQuizPreviewIndex > 0) {
      renderQuizPreviewQuestion(currentQuizPreviewIndex - 1);
    }
  }
  
  function nextQuizPreviewQuestion() {
    if (currentQuizPreviewIndex < selectedQuizQuestions.length - 1) {
      renderQuizPreviewQuestion(currentQuizPreviewIndex + 1);
    }
  }
  
  function goToQuizPreviewQuestion(index) {
    renderQuizPreviewQuestion(index);
  }
  
  // Homework Preview Functions
  function renderHomeworkPreview() {
    const questions = selectedHomeworkQuestions;
    const cardContainer = document.getElementById('homeworkPreviewQuestionCard');
    const dotsContainer = document.getElementById('homeworkPreviewDots');
    const totalNumEl = document.getElementById('homeworkPreviewTotalNum');
    const currentNumEl = document.getElementById('homeworkPreviewCurrentNum');
    
    if (!questions || questions.length === 0) {
      cardContainer.innerHTML = `
        <div class="preview-empty-state">
          <i class="fas fa-clipboard-list fa-3x text-muted mb-3"></i>
          <p class="text-muted">No questions selected. Go back to Step 2 to select questions.</p>
        </div>
      `;
      dotsContainer.innerHTML = '';
      totalNumEl.textContent = '0';
      currentNumEl.textContent = '0';
      return;
    }
    
    currentHomeworkPreviewIndex = 0;
    totalNumEl.textContent = questions.length;
    
    // Render dots
    dotsContainer.innerHTML = questions.map((_, index) => 
      `<span class="preview-dot ${index === 0 ? 'active' : ''}" onclick="goToHomeworkPreviewQuestion(${index})"></span>`
    ).join('');
    
    renderHomeworkPreviewQuestion(0);
  }
  
  function renderHomeworkPreviewQuestion(index) {
    const selectedQuestions = selectedHomeworkQuestions;
    if (!selectedQuestions || index < 0 || index >= selectedQuestions.length) return;
    
    currentHomeworkPreviewIndex = index;
    const selectedItem = selectedQuestions[index];
    
    // Look up the full question data from homeworkQuestions array
    const questionId = selectedItem.question?.toString() || selectedItem.question;
    const fullQuestion = homeworkQuestions.find(q => {
      const qId = q._id?.toString() || q._id;
      return qId === questionId;
    });
    
    // Merge selected item data (like points) with full question data
    const question = fullQuestion ? { ...fullQuestion, points: selectedItem.points || fullQuestion.points || 1 } : selectedItem;
    
    const cardContainer = document.getElementById('homeworkPreviewQuestionCard');
    const currentNumEl = document.getElementById('homeworkPreviewCurrentNum');
    const dotsContainer = document.getElementById('homeworkPreviewDots');
    
    currentNumEl.textContent = index + 1;
    
    // Update dots
    dotsContainer.querySelectorAll('.preview-dot').forEach((dot, i) => {
      dot.classList.toggle('active', i === index);
    });
    
    // Render question card (reuse the same render function)
    cardContainer.innerHTML = renderPreviewQuestionCard(question, index + 1);
  }
  
  function prevHomeworkPreviewQuestion() {
    if (currentHomeworkPreviewIndex > 0) {
      renderHomeworkPreviewQuestion(currentHomeworkPreviewIndex - 1);
    }
  }
  
  function nextHomeworkPreviewQuestion() {
    if (currentHomeworkPreviewIndex < selectedHomeworkQuestions.length - 1) {
      renderHomeworkPreviewQuestion(currentHomeworkPreviewIndex + 1);
    }
  }
  
  function goToHomeworkPreviewQuestion(index) {
    renderHomeworkPreviewQuestion(index);
  }

  function loadHomeworkQuestionBanks() {
    fetch(`/admin/courses/<%= courseCode %>/topics/${currentTopicId}/question-banks`)
      .then(response => response.json())
      .then(data => {
        const grid = document.getElementById('homeworkQuestionBanksGrid');
        const noBanksMessage = document.getElementById('noHomeworkQuestionBanksMessage');

        if (data.success && data.questionBanks && data.questionBanks.length > 0) {
          grid.innerHTML = data.questionBanks.map(bank => `
            <div class="bank-card-enhanced" 
                 data-bank-id="${bank._id}" 
                 data-questions="${bank.totalQuestions || 0}" 
                 data-title="${bank.name}" 
                 data-code="${bank.bankCode || ''}" 
                 data-description="${bank.description || ''}" 
                 onclick="toggleHomeworkBankSelection('${bank._id}')">
              <div class="bank-card-enhanced-content">
                <div class="bank-card-enhanced-header">
                  <div class="bank-card-enhanced-icon">
                    <i class="fas fa-database"></i>
                  </div>
                  <div class="bank-card-enhanced-title-section">
                    <h5 class="bank-card-enhanced-title">${bank.name}</h5>
                    <span class="bank-card-enhanced-code">${bank.bankCode || ''}</span>
                  </div>
                </div>
                <p class="bank-card-enhanced-description">${bank.description || 'No description available'}</p>
                <div class="bank-card-enhanced-footer">
                  <div class="bank-card-enhanced-questions">
                    <i class="fas fa-question-circle"></i>
                    <span>${bank.totalQuestions || 0} questions</span>
                  </div>
                  <div class="bank-card-enhanced-select-indicator">
                    <i class="fas fa-check-circle"></i>
                    <span>Select</span>
                  </div>
                </div>
              </div>
              <input type="checkbox" id="homework_bank_${bank._id}" value="${bank._id}" style="display: none;">
            </div>
          `).join('');
          noBanksMessage.style.display = 'none';
        } else {
          grid.innerHTML = '';
          noBanksMessage.style.display = 'block';
        }
      })
      .catch(error => {
        console.error('Error loading question banks:', error);
        showNotification('Error loading question banks', 'error');
      });
  }

  function toggleHomeworkBankSelection(bankId) {
    const bankCard = document.querySelector(`#homeworkQuestionBanksGrid [data-bank-id="${bankId}"]`);
    const checkbox = bankCard.querySelector('input[type="checkbox"]');
    const isCurrentlySelected = selectedHomeworkQuestionBankIds.includes(bankId);

    if (isCurrentlySelected) {
      // Remove bank from selection
      const index = selectedHomeworkQuestionBankIds.indexOf(bankId);
      if (index > -1) {
        selectedHomeworkQuestionBankIds.splice(index, 1);
        bankCard.classList.remove('selected');
        checkbox.checked = false;

        // Remove questions from this bank
        selectedHomeworkQuestions = selectedHomeworkQuestions.filter(sq => sq.sourceBank !== bankId);
        homeworkQuestions = homeworkQuestions.filter(q => q.sourceBank !== bankId);
      }
    } else {
      // Add bank to selection
      selectedHomeworkQuestionBankIds.push(bankId);
      bankCard.classList.add('selected');
      checkbox.checked = true;
    }

    updateHomeworkBanksCount();

    // Reload questions if banks changed
    if (selectedHomeworkQuestionBankIds.length > 0) {
      loadHomeworkQuestions();
    } else {
      document.getElementById('homeworkQuestionsGrid').innerHTML = '';
      document.getElementById('noHomeworkQuestionsMessage').style.display = 'flex';
    }
  }

  function updateHomeworkBanksCount() {
    const count = selectedHomeworkQuestionBankIds.length;
    const countElement = document.getElementById('homeworkSelectedBanksCount');
    if (countElement) countElement.textContent = `(${count} selected)`;
  }

  function loadHomeworkQuestions() {
    if (selectedHomeworkQuestionBankIds.length === 0) {
      showNotification('No banks selected', 'error');
      return;
    }

    fetch('/admin/quizzes/api/banks/multiple/questions', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          bankIds: selectedHomeworkQuestionBankIds
        })
      })
      .then(response => response.json())
      .then(result => {
        if (result.success && result.questions) {
          homeworkQuestions = [];
          homeworkBankInfoMap = {};

          // Flatten and add sourceBank to each question
          Object.entries(result.questions).forEach(([bankId, questions]) => {
            if (Array.isArray(questions)) {
              const bankCard = document.querySelector(`#homeworkQuestionBanksGrid [data-bank-id="${bankId}"]`);
              const bankName = bankCard ? bankCard.dataset.title : 'Unknown Bank';
              const bankCode = bankCard ? bankCard.dataset.code : '';

              homeworkBankInfoMap[bankId] = {
                name: bankName,
                code: bankCode
              };

              questions.forEach(q => {
                homeworkQuestions.push({
                  ...q,
                  sourceBank: bankId
                });
              });
            }
          });

          displayHomeworkQuestions(result.questions);
          showNotification(`Loaded ${homeworkQuestions.length} questions from ${selectedHomeworkQuestionBankIds.length} bank(s)`, 'success');
        } else {
          showNotification(result.message || 'Failed to load questions', 'error');
        }
      })
      .catch(error => {
        console.error('Error loading questions:', error);
        showNotification('An error occurred while loading questions', 'error');
      });
  }

  function displayHomeworkQuestions(questionsByBank) {
    const grid = document.getElementById('homeworkQuestionsGrid');
    const noQuestionsMessage = document.getElementById('noHomeworkQuestionsMessage');

    if (!questionsByBank || typeof questionsByBank !== 'object' || Object.keys(questionsByBank).length === 0) {
      grid.innerHTML = '';
      noQuestionsMessage.style.display = 'flex';
      return;
    }

    noQuestionsMessage.style.display = 'none';

    // Reset all questions array
    homeworkQuestions = [];

    // Flatten all questions and store bank info
    let questionHTML = '';
    let globalIndex = 0;

    Object.entries(questionsByBank).forEach(([bankId, questions]) => {
      const bankCard = document.querySelector(`#homeworkQuestionBanksGrid [data-bank-id="${bankId}"]`);
      const bankName = bankCard ? bankCard.dataset.title : 'Unknown Bank';

      // Store bank info
      if (!homeworkBankInfoMap[bankId]) {
        homeworkBankInfoMap[bankId] = {
          name: bankName,
          code: bankCard ? bankCard.dataset.code : ''
        };
      }

      // Add questions to homeworkQuestions array
      questions.forEach((question) => {
        homeworkQuestions.push({
          ...question,
          sourceBank: bankId
        });

        const difficultyClass = question.difficulty || 'medium';
        const questionTags = question.tags || [];
        const tagsJson = JSON.stringify(questionTags);

        questionHTML += `
          <div class="question-item ${difficultyClass}" 
               onclick="toggleHomeworkQuestion(${globalIndex})" 
               data-question-index="${globalIndex}"
               data-bank-id="${bankId}"
               data-question-id="${question._id}"
               data-tags='${tagsJson}'>
            <div class="question-item-top">
              <div class="question-item-number">${globalIndex + 1}</div>
              <button type="button" class="question-preview-btn" onclick="event.stopPropagation(); previewHomeworkQuestion(${globalIndex})" title="Preview Question">
                <i class="fas fa-eye"></i>
              </button>
            </div>
            <div class="question-item-content">
              <div class="question-item-header">
                <div class="question-item-bank">
                  <i class="fas fa-database"></i>
                  <span>${bankName}</span>
                </div>
              </div>
              <div class="question-item-footer">
                <span class="question-badge type-badge">${question.questionType || 'MCQ'}</span>
              </div>
            </div>
            <div class="question-check-indicator">
              <i class="fas fa-check-circle"></i>
            </div>
          </div>
        `;
        globalIndex++;
      });
    });

    grid.innerHTML = questionHTML;

    // Update bank filter buttons
    updateHomeworkBankFilterButtons();

    // Reset bank filter to 'all' when questions are loaded
    window.currentHomeworkBankFilter = 'all';
    const allBanksBtn = document.querySelector('#homeworkBankFilterButtons .bank-filter-btn[data-bank-id="all"]');
    if (allBanksBtn) {
      document.querySelectorAll('#homeworkBankFilterButtons .bank-filter-btn').forEach(btn => btn.classList.remove('active'));
      allBanksBtn.classList.add('active');
    }

    // Restore visual state of selected questions
    restoreHomeworkQuestionSelection();
    updateHomeworkSelectionSummary();
    
    // Populate tags filter
    populateTagsFilter('homeworkTagsFilter', homeworkQuestions);
  }

  // Update Homework Bank Filter Buttons
  function updateHomeworkBankFilterButtons() {
    const bankFilterButtons = document.getElementById('homeworkBankFilterButtons');
    if (!bankFilterButtons) return;

    // Get the "All Banks" button HTML first
    const allBanksBtn = bankFilterButtons.querySelector('[data-bank-id="all"]');
    let buttonsHTML = '';

    if (allBanksBtn) {
      buttonsHTML = allBanksBtn.outerHTML;
    } else {
      buttonsHTML = `
        <button type="button" class="bank-filter-btn active" data-bank-id="all" onclick="filterHomeworkByBank('all')">
          <i class="fas fa-th"></i>
          All Banks
        </button>
      `;
    }

    // Add individual bank buttons
    Object.entries(homeworkBankInfoMap).forEach(([bankId, bankInfo]) => {
      buttonsHTML += `
        <button type="button" class="bank-filter-btn" data-bank-id="${bankId}" onclick="filterHomeworkByBank('${bankId}')">
          <i class="fas fa-database"></i>
          ${bankInfo.name}
        </button>
      `;
    });

    bankFilterButtons.innerHTML = buttonsHTML;
  }

  // Filter Homework by Bank
  function filterHomeworkByBank(bankId) {
    // Update active button
    document.querySelectorAll('#homeworkBankFilterButtons .bank-filter-btn').forEach(btn => {
      btn.classList.remove('active');
    });
    const activeBtn = document.querySelector(`#homeworkBankFilterButtons .bank-filter-btn[data-bank-id="${bankId}"]`);
    if (activeBtn) {
      activeBtn.classList.add('active');
    }

    // Store current bank filter
    window.currentHomeworkBankFilter = bankId;

    // Filter questions
    const questionItems = document.querySelectorAll('#homeworkQuestionsGrid .question-item');
    questionItems.forEach(item => {
      if (bankId === 'all') {
        item.style.display = '';
      } else {
        const itemBankId = item.dataset.bankId;
        item.style.display = itemBankId === bankId ? '' : 'none';
      }
    });

    // Also apply other active filters
    filterHomeworkQuestions();
  }

  // Filter Homework Questions
  function filterHomeworkQuestions() {
    const difficultyFilter = document.getElementById('homeworkDifficultyFilter')?.value || '';
    const typeFilter = document.getElementById('homeworkTypeFilter')?.value || '';
    const tagsFilter = document.getElementById('homeworkTagsFilter')?.value || '';
    const searchFilter = document.getElementById('homeworkSearchFilter')?.value.toLowerCase() || '';
    const activeBankFilter = window.currentHomeworkBankFilter || document.querySelector('#homeworkBankFilterButtons .bank-filter-btn.active')?.dataset.bankId || 'all';

    // Filter question items
    const questionElements = document.querySelectorAll('#homeworkQuestionsGrid .question-item');

    questionElements.forEach(element => {
      const questionIndex = parseInt(element.dataset.questionIndex);
      const question = homeworkQuestions[questionIndex];

      if (!question) return;

      let show = true;

      // Check bank filter first
      if (activeBankFilter !== 'all' && element.dataset.bankId !== activeBankFilter) {
        show = false;
      }

      // Check difficulty filter
      if (show && difficultyFilter && question.difficulty && question.difficulty.toLowerCase() !== difficultyFilter.toLowerCase()) {
        show = false;
      }

      // Check type filter
      if (show && typeFilter && question.questionType !== typeFilter) {
        show = false;
      }

      // Check tags filter
      if (show && tagsFilter) {
        const questionTags = question.tags || [];
        const hasTag = questionTags.some(tag => 
          tag && tag.toString().toLowerCase() === tagsFilter.toLowerCase()
        );
        if (!hasTag) {
          show = false;
        }
      }

      // Check search filter
      if (show && searchFilter && question.questionText && !question.questionText.toLowerCase().includes(searchFilter)) {
        show = false;
      }

      // Show/hide the element
      element.style.display = show ? '' : 'none';
    });
  }

  function restoreHomeworkQuestionSelection() {
    // Clear all selections first
    document.querySelectorAll('#homeworkQuestionsGrid .question-item').forEach(item => {
      item.classList.remove('selected');
    });

    // Restore selections based on selectedHomeworkQuestions array
    selectedHomeworkQuestions.forEach(selection => {
      const questionIndex = homeworkQuestions.findIndex(q => {
        const qId = q._id?.toString() || q._id;
        const sId = selection.question?.toString() || selection.question;
        return qId === sId;
      });
      if (questionIndex !== -1) {
        const questionElement = document.querySelector(`#homeworkQuestionsGrid [data-question-index="${questionIndex}"]`);
        if (questionElement) {
          questionElement.classList.add('selected');
        }
      }
    });
  }

  function toggleHomeworkQuestion(index) {
    const questionElement = document.querySelector(`#homeworkQuestionsGrid [data-question-index="${index}"]`);
    const question = homeworkQuestions[index];
    const questionId = question._id;
    const sourceBank = question.sourceBank;
    const existingIndex = selectedHomeworkQuestions.findIndex(sq => {
      const qId = sq.question?.toString() || sq.question;
      const currentId = questionId?.toString() || questionId;
      return qId === currentId;
    });

    if (existingIndex > -1) {
      // Remove from selection
      selectedHomeworkQuestions.splice(existingIndex, 1);
      questionElement.classList.remove('selected');
    } else {
      // Add to selection with sourceBank
      selectedHomeworkQuestions.push({
        question: questionId,
        sourceBank: sourceBank,
        order: selectedHomeworkQuestions.length + 1,
        points: question.points || 1
      });
      questionElement.classList.add('selected');
    }

    updateHomeworkSelectionSummary();
  }

  function selectAllHomeworkQuestions() {
    // Only select visible questions
    const visibleQuestions = Array.from(document.querySelectorAll('#homeworkQuestionsGrid .question-item'))
      .filter(item => item.style.display !== 'none')
      .map(item => {
        const index = parseInt(item.dataset.questionIndex);
        return homeworkQuestions[index];
      })
      .filter(q => q);

    selectedHomeworkQuestions = visibleQuestions.map(question => ({
      question: question._id,
      sourceBank: question.sourceBank,
      order: selectedHomeworkQuestions.length + 1,
      points: question.points || 1
    }));

    document.querySelectorAll('#homeworkQuestionsGrid .question-item').forEach((item) => {
      if (item.style.display !== 'none') {
        item.classList.add('selected');
      }
    });

    updateHomeworkSelectionSummary();
    showNotification(`Selected ${visibleQuestions.length} visible questions`, 'success');
  }

  function clearHomeworkSelection() {
    selectedHomeworkQuestions = [];
    document.querySelectorAll('#homeworkQuestionsGrid .question-item').forEach(item => {
      item.classList.remove('selected');
    });
    updateHomeworkSelectionSummary();
    showNotification('Cleared all selections', 'info');
  }

  function selectEvenHomeworkQuestions() {
    clearHomeworkSelection();
    let selectedCount = 0;

    for (let i = 1; i < homeworkQuestions.length; i += 2) {
      const question = homeworkQuestions[i];
      selectedHomeworkQuestions.push({
        question: question._id,
        sourceBank: question.sourceBank,
        order: selectedHomeworkQuestions.length + 1,
        points: question.points || 1
      });
      document.querySelector(`#homeworkQuestionsGrid [data-question-index="${i}"]`).classList.add('selected');
      selectedCount++;
    }

    updateHomeworkSelectionSummary();
    showNotification(`Selected ${selectedCount} even-numbered questions`, 'success');
  }

  function selectOddHomeworkQuestions() {
    clearHomeworkSelection();
    let selectedCount = 0;

    for (let i = 0; i < homeworkQuestions.length; i += 2) {
      const question = homeworkQuestions[i];
      selectedHomeworkQuestions.push({
        question: question._id,
        sourceBank: question.sourceBank,
        order: selectedHomeworkQuestions.length + 1,
        points: question.points || 1
      });
      document.querySelector(`#homeworkQuestionsGrid [data-question-index="${i}"]`).classList.add('selected');
      selectedCount++;
    }

    updateHomeworkSelectionSummary();
    showNotification(`Selected ${selectedCount} odd-numbered questions`, 'success');
  }

  function selectRandomHomeworkQuestions() {
    clearHomeworkSelection();
    const count = Math.ceil(homeworkQuestions.length * 0.3);
    const randomIndices = [];

    while (randomIndices.length < count) {
      const randomIndex = Math.floor(Math.random() * homeworkQuestions.length);
      if (!randomIndices.includes(randomIndex)) {
        randomIndices.push(randomIndex);
      }
    }

    randomIndices.forEach(index => {
      const question = homeworkQuestions[index];
      selectedHomeworkQuestions.push({
        question: question._id,
        sourceBank: question.sourceBank,
        order: selectedHomeworkQuestions.length + 1,
        points: question.points || 1
      });
      document.querySelector(`#homeworkQuestionsGrid [data-question-index="${index}"]`).classList.add('selected');
    });

    updateHomeworkSelectionSummary();
    showNotification(`Randomly selected ${count} questions`, 'success');
  }

  function selectHomeworkRange() {
    const rangeInput = document.getElementById('homeworkRangeInput').value.trim();
    if (!rangeInput) {
      showNotification('Please enter a range (e.g., 1-5, 3, 7-10)', 'error');
      return;
    }

    clearHomeworkSelection();

    const ranges = rangeInput.split(',');
    let selectedCount = 0;

    ranges.forEach(rangeStr => {
      const trimmed = rangeStr.trim();
      if (trimmed.includes('-')) {
        // Range (e.g., "1-5")
        const [start, end] = trimmed.split('-').map(n => parseInt(n.trim()) - 1);
        for (let i = start; i <= end && i < homeworkQuestions.length; i++) {
          if (i >= 0) {
            const question = homeworkQuestions[i];
            selectedHomeworkQuestions.push({
              question: question._id,
              sourceBank: question.sourceBank,
              order: selectedHomeworkQuestions.length + 1,
              points: question.points || 1
            });
            const questionElement = document.querySelector(`#homeworkQuestionsGrid [data-question-index="${i}"]`);
            if (questionElement) questionElement.classList.add('selected');
            selectedCount++;
          }
        }
      } else {
        // Single number (e.g., "3")
        const index = parseInt(trimmed) - 1;
        if (index >= 0 && index < homeworkQuestions.length) {
          const question = homeworkQuestions[index];
          selectedHomeworkQuestions.push({
            question: question._id,
            sourceBank: question.sourceBank,
            order: selectedHomeworkQuestions.length + 1,
            points: question.points || 1
          });
          document.querySelector(`#homeworkQuestionsGrid [data-question-index="${index}"]`).classList.add('selected');
          selectedCount++;
        }
      }
    });

    updateHomeworkSelectionSummary();

    if (selectedCount > 0) {
      showNotification(`Selected ${selectedCount} questions from range`, 'success');
    } else {
      showNotification('No valid questions found in the specified range', 'warning');
    }

    // Clear the input
    document.getElementById('homeworkRangeInput').value = '';
  }

  function updateHomeworkQuestionsCount() {
    const countElement = document.getElementById('homeworkQuestionsCount');
    if (countElement) {
      countElement.textContent = `(${homeworkQuestions.length} questions)`;
    }
  }

  function updateHomeworkSelectionSummary() {
    const selectedCount = document.getElementById('homeworkSelectedCount');
    const totalPoints = document.getElementById('homeworkTotalPoints');
    const easyCount = document.getElementById('homeworkEasyCount');
    const mediumCount = document.getElementById('homeworkMediumCount');
    const hardCount = document.getElementById('homeworkHardCount');

    if (selectedCount) selectedCount.textContent = selectedHomeworkQuestions.length;

    let points = 0;
    let easy = 0,
      medium = 0,
      hard = 0;

    selectedHomeworkQuestions.forEach(selection => {
      const question = homeworkQuestions.find(q => {
        const qId = q._id?.toString() || q._id;
        const sId = selection.question?.toString() || selection.question;
        return qId === sId;
      });
      if (question) {
        points += question.points || 1;

        const difficulty = question.difficulty || 'medium';
        if (difficulty.toLowerCase() === 'easy') easy++;
        else if (difficulty.toLowerCase() === 'hard') hard++;
        else medium++;
      }
    });

    if (totalPoints) totalPoints.textContent = points;
    if (easyCount) easyCount.textContent = easy;
    if (mediumCount) mediumCount.textContent = medium;
    if (hardCount) hardCount.textContent = hard;
  }

  // Submit Quiz Content
  async function submitQuizContent() {
    try {
      const courseCode = '<%= course.courseCode %>';
      const topicId = currentTopicId;

      if (!topicId) {
        showNotification('Please select a topic first', 'error');
        return;
      }

      // Validation
      if (selectedQuizQuestionBankIds.length === 0 || selectedQuizQuestions.length === 0) {
        showNotification('Please select at least one question bank and at least one question', 'error');
        return;
      }

      const title = document.getElementById('contentTitle').value.trim();
      if (!title) {
        showNotification('Please enter a title', 'error');
        return;
      }

      const prerequisitesValue = document.getElementById('contentPrerequisites')?.value || '';

      const formData = {
        title: title,
        description: document.getElementById('contentDescription').value.trim(),
        questionBanks: selectedQuizQuestionBankIds,
        selectedQuestions: selectedQuizQuestions,
        duration: parseInt(document.getElementById('quizDuration')?.value) || 30,
        passingScore: (() => {
          const value = document.getElementById('quizPassingScore')?.value;
          return value !== null && value !== undefined && value !== '' ? parseInt(value) : 50;
        })(),
        maxAttempts: parseInt(document.getElementById('quizMaxAttempts')?.value) || 3,
        shuffleQuestions: document.getElementById('quizShuffleQuestions')?.checked || false,
        shuffleOptions: document.getElementById('quizShuffleOptions')?.checked || false,
        showCorrectAnswers: document.getElementById('quizShowCorrectAnswers')?.checked || false,
        showResults: document.getElementById('quizShowResults')?.checked || false,
        instructions: document.getElementById('quizInstructions')?.value.trim() || '',
        difficulty: document.getElementById('contentDifficulty')?.value || 'beginner',
        tags: document.getElementById('contentTags')?.value.split(',').map(t => t.trim()).filter(t => t) || [],
        prerequisites: prerequisitesValue || null,
        isRequired: true,
      };

      // Show loading
      showNotification('Creating quiz content...', 'info');
      const submitBtn = document.getElementById('addContentSubmitBtn');
      const originalText = submitBtn.innerHTML;
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Creating...';

      const response = await fetch(`/admin/courses/${courseCode}/topics/${topicId}/content/quiz`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(formData),
      });

      const data = await response.json();

      if (data.success) {
        showNotification('Quiz content created successfully!', 'success');

        // Close modal and refresh
        const modal = bootstrap.Modal.getInstance(document.getElementById('addContentModal'));
        if (modal) {
          modal.hide();
        }

        // Reset form
        document.getElementById('addContentForm').reset();
        resetQuizSteps();

        // Reload page to show new content
        setTimeout(() => {
          location.reload();
        }, 1500);
      } else {
        showNotification(data.message || 'Failed to create quiz content', 'error');
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
      }
    } catch (error) {
      console.error('Error creating quiz content:', error);
      showNotification('Error creating quiz content: ' + error.message, 'error');
      const submitBtn = document.getElementById('addContentSubmitBtn');
      submitBtn.disabled = false;
      submitBtn.innerHTML = '<i class="fas fa-plus me-2"></i>Add Content';
    }
  }

  // Submit Homework Content
  async function submitHomeworkContent() {
    try {
      const courseCode = '<%= course.courseCode %>';
      const topicId = currentTopicId;

      if (!topicId) {
        showNotification('Please select a topic first', 'error');
        return;
      }

      // Validation
      if (selectedHomeworkQuestionBankIds.length === 0 || selectedHomeworkQuestions.length === 0) {
        showNotification('Please select at least one question bank and at least one question', 'error');
        return;
      }

      const title = document.getElementById('contentTitle').value.trim();
      if (!title) {
        showNotification('Please enter a title', 'error');
        return;
      }

      const prerequisitesValue = document.getElementById('contentPrerequisites')?.value || '';

      const formData = {
        title: title,
        description: document.getElementById('contentDescription').value.trim(),
        questionBanks: selectedHomeworkQuestionBankIds,
        selectedQuestions: selectedHomeworkQuestions,
        passingScore: (() => {
          const value = document.getElementById('homeworkPassingScore')?.value;
          return value !== null && value !== undefined && value !== '' ? parseInt(value) : 60;
        })(),
        maxAttempts: parseInt(document.getElementById('homeworkMaxAttempts')?.value) || 1,
        shuffleQuestions: document.getElementById('homeworkShuffleQuestions')?.checked || false,
        shuffleOptions: document.getElementById('homeworkShuffleOptions')?.checked || false,
        showCorrectAnswers: document.getElementById('homeworkShowCorrectAnswers')?.checked || false,
        instructions: document.getElementById('homeworkInstructions')?.value.trim() || '',
        difficulty: document.getElementById('contentDifficulty')?.value || 'beginner',
        tags: document.getElementById('contentTags')?.value.split(',').map(t => t.trim()).filter(t => t) || [],
        prerequisites: prerequisitesValue || null,
        isRequired: true,
      };

      // Show loading
      showNotification('Creating homework content...', 'info');
      const submitBtn = document.getElementById('addContentSubmitBtn');
      const originalText = submitBtn.innerHTML;
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Creating...';

      const response = await fetch(`/admin/courses/${courseCode}/topics/${topicId}/content/homework`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(formData),
      });

      const data = await response.json();

      if (data.success) {
        showNotification('Homework content created successfully!', 'success');

        // Close modal and refresh
        const modal = bootstrap.Modal.getInstance(document.getElementById('addContentModal'));
        if (modal) {
          modal.hide();
        }

        // Reset form
        document.getElementById('addContentForm').reset();
        resetHomeworkSteps();

        // Reload page to show new content
        setTimeout(() => {
          location.reload();
        }, 1500);
      } else {
        showNotification(data.message || 'Failed to create homework content', 'error');
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
      }
    } catch (error) {
      console.error('Error creating homework content:', error);
      showNotification('Error creating homework content: ' + error.message, 'error');
      const submitBtn = document.getElementById('addContentSubmitBtn');
      submitBtn.disabled = false;
      submitBtn.innerHTML = '<i class="fas fa-plus me-2"></i>Add Content';
    }
  }

  // ==================== ZOOM MEETING FUNCTIONS ====================

  // Reset Zoom form
  function resetZoomForm() {
    document.getElementById('zoomMeetingName').value = '';
    document.getElementById('zoomMeetingTopic').value = '';
    document.getElementById('zoomScheduledTime').value = '';
    document.getElementById('zoomDuration').value = '60';
    document.getElementById('zoomTimezone').value = 'Africa/Cairo';
    document.getElementById('zoomPassword').value = '';
    document.getElementById('zoomJoinBeforeHost').checked = true;
    document.getElementById('zoomWaitingRoom').checked = false;
    document.getElementById('zoomMuteUponEntry').checked = false;
    document.getElementById('zoomHostVideo').checked = true;
    document.getElementById('zoomParticipantVideo').checked = true;
    document.getElementById('zoomEnableRecording').checked = false;
  }

  // Submit Zoom meeting
  async function submitZoomMeeting() {
    try {
      const courseCode = '<%= course.courseCode %>';
      const topicId = currentTopicId;

      if (!topicId) {
        showNotification('Please select a topic first', 'error');
        return;
      }

      const formData = {
        meetingName: document.getElementById('zoomMeetingName').value,
        meetingTopic: document.getElementById('zoomMeetingTopic').value || document.getElementById('zoomMeetingName').value,
        scheduledStartTime: document.getElementById('zoomScheduledTime').value,
        duration: document.getElementById('zoomDuration').value,
        timezone: document.getElementById('zoomTimezone').value,
        password: document.getElementById('zoomPassword').value,
        joinBeforeHost: document.getElementById('zoomJoinBeforeHost').checked,
        waitingRoom: document.getElementById('zoomWaitingRoom').checked,
        muteUponEntry: document.getElementById('zoomMuteUponEntry').checked,
        hostVideo: document.getElementById('zoomHostVideo').checked,
        participantVideo: document.getElementById('zoomParticipantVideo').checked,
        enableRecording: document.getElementById('zoomEnableRecording').checked,
      };

      // Validation
      if (!formData.meetingName) {
        showNotification('Please enter a meeting name', 'error');
        return;
      }

      if (!formData.scheduledStartTime) {
        showNotification('Please select a scheduled start time', 'error');
        return;
      }

      // Check if scheduled time is in the future
      const scheduledDate = new Date(formData.scheduledStartTime);
      const now = new Date();
      if (scheduledDate < now) {
        showNotification('Scheduled time must be in the future', 'error');
        return;
      }

      // Show loading
      showNotification('Creating Zoom meeting...', 'info');

      const response = await fetch(`/zoom/admin/courses/${courseCode}/topics/${topicId}/zoom/create`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(formData),
      });

      const data = await response.json();

      if (data.success) {
        showNotification('Zoom meeting created successfully!', 'success');

        // Close modal and refresh
        const modal = bootstrap.Modal.getInstance(document.getElementById('addContentModal'));
        if (modal) {
          modal.hide();
        }

        // Reset form
        resetZoomForm();

        // Reload page to show new content
        setTimeout(() => {
          location.reload();
        }, 1500);
      } else {
        showNotification(data.message || 'Failed to create Zoom meeting', 'error');
      }
    } catch (error) {
      console.error('Error creating Zoom meeting:', error);
      showNotification('Error creating Zoom meeting: ' + error.message, 'error');
    }
  }

  // ==================== ZOOM MEETING CONTROLS ====================

  // Start Zoom meeting
  async function startZoomMeeting(meetingId) {
    try {
      showNotification('Starting Zoom meeting...', 'info');

      const response = await fetch(`/zoom/admin/zoom/${meetingId}/start`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        }
      });

      const result = await response.json();

      if (result.success) {
        showNotification('Zoom meeting started successfully! Students can now join.', 'success');

        // Reload the page to update the UI
        setTimeout(() => {
          location.reload();
        }, 1500);
      } else {
        showNotification(result.message || 'Failed to start meeting', 'error');
      }
    } catch (error) {
      console.error('Error starting Zoom meeting:', error);
      showNotification('Failed to start meeting. Please try again.', 'error');
    }
  }

  // End Zoom meeting
  async function endZoomMeeting(meetingId) {
    // Show SweetAlert2 modal with recording URL input (optional)
    const {
      value: formValues,
      isConfirmed
    } = await Swal.fire({
      title: 'âš ï¸ End Zoom Meeting',
      html: `
        <div style="text-align: left;">
          <p style="margin-bottom: 15px;"><strong>This will end the meeting for ALL participants!</strong></p>
          <p style="margin-bottom: 20px; color: #666;">You can add the recording link now or later. Students will see a "Waiting for Recording" status until you add it.</p>
          
          <label for="recordingUrl" style="display: block; margin-bottom: 8px; font-weight: 500;">
            <i class="fas fa-video"></i> Add Recording Link (Optional - Can add later):
          </label>
          <input 
            id="recordingUrl" 
            type="url" 
            class="swal2-input" 
            placeholder="Leave empty to add later"
            style="width: 90%; margin: 0 auto;"
          >
          <small style="display: block; margin-top: 8px; color: #666;">
            You can add the recording link later from the meeting details. Supports: YouTube, Vimeo, Google Drive, or direct video links
          </small>
        </div>
      `,
      icon: 'warning',
      showCancelButton: true,
      confirmButtonColor: '#dc2626',
      cancelButtonColor: '#6b7280',
      confirmButtonText: 'End Meeting',
      cancelButtonText: 'Cancel',
      focusConfirm: false,
      preConfirm: () => {
        return {
          recordingUrl: document.getElementById('recordingUrl').value
        }
      }
    });

    if (!isConfirmed) {
      return;
    }

    try {
      showNotification('Ending Zoom meeting for all participants...', 'info');

      const requestBody = {};
      if (formValues.recordingUrl && formValues.recordingUrl.trim()) {
        requestBody.recordingUrl = formValues.recordingUrl.trim();
      }

      const response = await fetch(`/zoom/admin/zoom/${meetingId}/end`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(requestBody)
      });

      const result = await response.json();

      if (result.success) {
        const message = formValues.recordingUrl ?
          'âœ… Zoom meeting ended successfully and recording URL saved!' :
          'âœ… Zoom meeting ended successfully. You can add the recording link later from the meeting details.';

        showNotification(message, 'success');

        // Reload the page to update the UI
        setTimeout(() => {
          location.reload();
        }, 1500);
      } else {
        showNotification(result.message || 'Failed to end meeting', 'error');
      }
    } catch (error) {
      console.error('Error ending Zoom meeting:', error);
      showNotification('Failed to end meeting. Please try again.', 'error');
    }
  }

  // Helper function to extract URL from iframe embed code (enhanced)
  function extractUrlFromIframe(input) {
    const trimmedInput = input.trim();
    
    // Check if input looks like HTML/iframe code
    if (trimmedInput.includes('<iframe') || trimmedInput.includes('</iframe>') || trimmedInput.includes('<div')) {
      // Extract src attribute from iframe
      const srcMatch = trimmedInput.match(/src=["']([^"']+)["']/i);
      if (srcMatch && srcMatch[1]) {
        return srcMatch[1];
      }
    }
    
    // If not iframe code, return as is (it's already a URL)
    return trimmedInput;
  }

  // Helper function to check if input is embed code
  function isEmbedCode(input) {
    const trimmed = input.trim();
    return trimmed.includes('<iframe') || trimmed.includes('</iframe>') || (trimmed.includes('<div') && trimmed.includes('iframe'));
  }

  // Helper function to create video preview HTML
  function createVideoPreview(url, isEmbedCode) {
    if (!url) return '';
    
    // Check if it's a YouTube URL
    const youtubeRegex = /(?:youtube\.com\/embed\/|youtu\.be\/|youtube\.com\/watch\?v=)([a-zA-Z0-9_-]{11})/;
    const youtubeMatch = url.match(youtubeRegex);
    
    if (youtubeMatch && youtubeMatch[1]) {
      // YouTube video
      const videoId = youtubeMatch[1];
      return `
        <div style="position: relative; padding-top: 56.25%; background: #000; border-radius: 8px; overflow: hidden; margin-top: 12px;">
          <iframe 
            src="https://www.youtube.com/embed/${videoId}" 
            style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: 0;"
            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
            allowfullscreen>
          </iframe>
        </div>
      `;
    } else if (url.includes('iframe.mediadelivery.net') || url.includes('mediadelivery.net')) {
      // Bunny CDN or similar - use direct iframe
      return `
        <div style="position: relative; padding-top: 56.25%; background: #000; border-radius: 8px; overflow: hidden; margin-top: 12px;">
          <iframe 
            src="${url}" 
            style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: 0;"
            allow="accelerometer; gyroscope; autoplay; encrypted-media; picture-in-picture"
            allowfullscreen>
          </iframe>
        </div>
      `;
    } else {
      // Generic video URL - try to embed
      return `
        <div style="position: relative; padding-top: 56.25%; background: #000; border-radius: 8px; overflow: hidden; margin-top: 12px;">
          <iframe 
            src="${url}" 
            style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: 0;"
            allow="accelerometer; gyroscope; autoplay; encrypted-media; picture-in-picture"
            allowfullscreen>
          </iframe>
        </div>
      `;
    }
  }

  // Add or edit recording URL to ended meeting
  async function addRecordingUrl(meetingId, currentUrl = null) {
    const isEditing = !!currentUrl;
    
    // Determine if current URL is embed code
    const currentIsEmbed = currentUrl ? isEmbedCode(currentUrl) : false;
    const currentDisplayUrl = currentUrl ? (currentIsEmbed ? extractUrlFromIframe(currentUrl) : currentUrl) : '';
    
    const { value: formValues, isConfirmed } = await Swal.fire({
      title: isEditing ? 'âœï¸ Edit Recording Link' : 'ðŸ“¹ Add Recording Link',
      html: `
        <div style="text-align: left;">
          <p style="margin-bottom: 20px; color: #666;">${isEditing ? 'Edit the recording link for this meeting.' : 'Add the recording link for this meeting. Students will be able to watch it once added.'}</p>
          
          <label for="recordingUrl" style="display: block; margin-bottom: 8px; font-weight: 500;">
            <i class="fas fa-video"></i> Recording Link or Embed Code:
          </label>
          <textarea 
            id="recordingUrl" 
            class="swal2-textarea" 
            placeholder="Paste video URL or iframe embed code here..."
            style="width: 100%; min-height: 100px; font-family: monospace; font-size: 12px; margin-bottom: 12px;"
            required
          >${currentUrl || ''}</textarea>
          
          <small style="display: block; margin-bottom: 12px; color: #666;">
            âœ… You can paste either:<br>
            â€¢ Direct video URL (e.g., https://iframe.mediadelivery.net/...)<br>
            â€¢ Full iframe embed code (we'll extract the URL automatically)
          </small>
          
          <!-- Video Preview Container -->
          <div id="videoPreviewContainer" style="margin-top: 15px; display: none;">
            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
              <i class="fas fa-play-circle" style="color: #10b981;"></i>
              <strong style="color: #10b981;">Video Preview:</strong>
            </div>
            <div id="videoPreviewContent" style="border: 2px solid #10b981; border-radius: 8px; overflow: hidden; background: #f9fafb;">
              <!-- Video preview will be inserted here -->
            </div>
            <div id="urlPreview" style="margin-top: 8px; padding: 8px; background: #f0fdf4; border-radius: 4px;">
              <small style="color: #16a34a;">
                <strong>âœ“ Detected URL:</strong> <span id="detectedUrl"></span>
              </small>
            </div>
          </div>
        </div>
      `,
      width: '800px',
      icon: isEditing ? 'info' : 'info',
      showCancelButton: true,
      confirmButtonColor: '#10b981',
      cancelButtonColor: '#6b7280',
      confirmButtonText: isEditing ? 'Update Recording Link' : 'Save Recording Link',
      cancelButtonText: 'Cancel',
      focusConfirm: false,
      didOpen: () => {
        const textarea = document.getElementById('recordingUrl');
        const previewContainer = document.getElementById('videoPreviewContainer');
        const previewContent = document.getElementById('videoPreviewContent');
        const detectedUrl = document.getElementById('detectedUrl');
        
        // Show preview for current URL if editing
        if (currentUrl && currentDisplayUrl) {
          const previewHtml = createVideoPreview(currentDisplayUrl, currentIsEmbed);
          if (previewHtml) {
            previewContent.innerHTML = previewHtml;
            detectedUrl.textContent = currentDisplayUrl.length > 80 ? currentDisplayUrl.substring(0, 80) + '...' : currentDisplayUrl;
            previewContainer.style.display = 'block';
          }
        }
        
        // Show preview when user types/pastes
        textarea.addEventListener('input', () => {
          const input = textarea.value.trim();
          if (input) {
            const isEmbed = isEmbedCode(input);
            const extractedUrl = extractUrlFromIframe(input);
            
            if (extractedUrl) {
              // Show video preview
              const previewHtml = createVideoPreview(extractedUrl, isEmbed);
              if (previewHtml) {
                previewContent.innerHTML = previewHtml;
                detectedUrl.textContent = extractedUrl.length > 80 ? extractedUrl.substring(0, 80) + '...' : extractedUrl;
                previewContainer.style.display = 'block';
              } else {
                previewContainer.style.display = 'none';
              }
            } else {
              previewContainer.style.display = 'none';
            }
          } else {
            previewContainer.style.display = 'none';
          }
        });
      },
      preConfirm: () => {
        const input = document.getElementById('recordingUrl').value.trim();
        if (!input) {
          Swal.showValidationMessage('Please enter a recording URL or embed code');
          return false;
        }
        
        // Check if it's embed code - if so, store the full embed code
        const isEmbed = isEmbedCode(input);
        let finalUrl = input;
        
        if (isEmbed) {
          // Store the full embed code
          finalUrl = input;
        } else {
          // It's a direct URL - validate it
          try {
            new URL(input);
            finalUrl = input;
          } catch (e) {
            Swal.showValidationMessage('Invalid URL format. Please check the link.');
            return false;
          }
        }
        
        return { recordingUrl: finalUrl };
      }
    });

    if (!isConfirmed) {
      return;
    }

    try {
      showNotification(isEditing ? 'Updating recording link...' : 'Adding recording link...', 'info');

      const response = await fetch(`/zoom/admin/zoom/${meetingId}/add-recording`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(formValues)
      });

      const result = await response.json();

      if (result.success) {
        showNotification(isEditing ? 'âœ… Recording link updated successfully!' : 'âœ… Recording link added successfully! Students can now watch the recording.', 'success');
        setTimeout(() => {
          location.reload();
        }, 1500);
      } else {
        showNotification(result.message || (isEditing ? 'Failed to update recording link' : 'Failed to add recording link'), 'error');
      }
    } catch (error) {
      console.error('Error ' + (isEditing ? 'updating' : 'adding') + ' recording link:', error);
      showNotification('Failed to ' + (isEditing ? 'update' : 'add') + ' recording link. Please try again.', 'error');
    }
  }

  // ==========================================
  // SHARE FUNCTIONALITY
  // ==========================================
  
  /**
   * Get the base URL for sharing (production or development)
   */
  function getShareBaseUrl() {
    // In production, use elkably.com
    if (window.location.hostname !== 'localhost' && window.location.hostname !== '127.0.0.1') {
      return 'https://elkably.com';
    }
    // In development, use current origin
    return window.location.origin;
  }
  
  /**
   * Share a topic link with students
   */
  function shareTopicLink(courseCode, topicId, topicTitle) {
    const baseUrl = getShareBaseUrl();
    // Course content page with topic parameter to auto-expand that topic
    const courseId = '<%= course._id %>';
    const shareUrl = `${baseUrl}/student/course/${courseId}/content?topic=${topicId}`;
    
    showShareModal({
      title: topicTitle,
      type: 'Topic',
      url: shareUrl,
      description: 'Share this topic with your students. They can access it directly using this link.'
    });
  }

  /**
   * Share a content item link with students
   */
  function shareContentLink(courseCode, topicId, contentId, contentTitle) {
    const baseUrl = getShareBaseUrl();
    // Direct link to specific content item
    const shareUrl = `${baseUrl}/student/content/${contentId}`;
    
    showShareModal({
      title: contentTitle,
      type: 'Content',
      url: shareUrl,
      description: 'Share this content with your students. They can access it directly using this link.'
    });
  }

  /**
   * Display the share modal with the shareable link
   */
  function showShareModal(data) {
    const { title, type, url, description } = data;
    
    Swal.fire({
      title: `<i class="fas fa-share-alt"></i> Share ${type}`,
      html: `
        <div class="share-modal-content">
          <div class="share-item-info">
            <div class="share-item-icon">
              <i class="fas fa-${type === 'Topic' ? 'layer-group' : 'file-alt'}"></i>
            </div>
            <div class="share-item-details">
              <h4 class="share-item-title">${title}</h4>
              <p class="share-item-description">${description}</p>
            </div>
          </div>
          
          <div class="share-link-container">
            <label class="share-link-label">
              <i class="fas fa-link"></i> Shareable Link
            </label>
            <div class="share-link-input-wrapper">
              <input 
                type="text" 
                class="share-link-input" 
                id="shareUrlInput" 
                value="${url}" 
                readonly
              />
              <button class="share-copy-btn" onclick="copyShareLink()">
                <i class="fas fa-copy"></i>
                <span>Copy</span>
              </button>
            </div>
          </div>

          <div class="share-actions">
            <button class="share-action-btn whatsapp" onclick="shareViaWhatsApp('${url}', '${title}')">
              <i class="fab fa-whatsapp"></i>
              WhatsApp
            </button>
            <button class="share-action-btn email" onclick="shareViaEmail('${url}', '${title}')">
              <i class="fas fa-envelope"></i>
              Email
            </button>
            <button class="share-action-btn telegram" onclick="shareViaTelegram('${url}', '${title}')">
              <i class="fab fa-telegram"></i>
              Telegram
            </button>
          </div>

          <div class="share-qr-section">
            <button class="share-qr-btn" onclick="generateQRCode('${url}')">
              <i class="fas fa-qrcode"></i>
              Generate QR Code
            </button>
          </div>
        </div>
      `,
      showConfirmButton: false,
      showCloseButton: true,
      width: '600px',
      customClass: {
        popup: 'share-modal-popup',
        closeButton: 'share-modal-close'
      },
      didOpen: () => {
        // Auto-select the URL for easy copying
        const input = document.getElementById('shareUrlInput');
        if (input) {
          input.select();
        }
      }
    });
  }

  /**
   * Copy share link to clipboard
   */
  function copyShareLink() {
    const input = document.getElementById('shareUrlInput');
    if (!input) return;

    input.select();
    input.setSelectionRange(0, 99999); // For mobile devices

    try {
      document.execCommand('copy');
      
      // Update button to show success
      const btn = document.querySelector('.share-copy-btn');
      if (btn) {
        const originalHTML = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-check"></i><span>Copied!</span>';
        btn.classList.add('copied');
        
        setTimeout(() => {
          btn.innerHTML = originalHTML;
          btn.classList.remove('copied');
        }, 2000);
      }

      showNotification('âœ… Link copied to clipboard!', 'success');
    } catch (err) {
      showNotification('âŒ Failed to copy link', 'error');
    }
  }

  /**
   * Share via WhatsApp
   */
  function shareViaWhatsApp(url, title) {
    const message = encodeURIComponent(`Check out this: ${title}\n${url}`);
    window.open(`https://wa.me/?text=${message}`, '_blank');
  }

  /**
   * Share via Email
   */
  function shareViaEmail(url, title) {
    const subject = encodeURIComponent(`Check out: ${title}`);
    const body = encodeURIComponent(`I wanted to share this with you:\n\n${title}\n\n${url}`);
    window.location.href = `mailto:?subject=${subject}&body=${body}`;
  }

  /**
   * Share via Telegram
   */
  function shareViaTelegram(url, title) {
    const text = encodeURIComponent(`${title}\n${url}`);
    window.open(`https://t.me/share/url?url=${encodeURIComponent(url)}&text=${encodeURIComponent(title)}`, '_blank');
  }

  /**
   * Generate QR Code for the share link
   */
  function generateQRCode(url) {
    Swal.fire({
      title: '<i class="fas fa-qrcode"></i> QR Code',
      html: `
        <div class="qr-code-container">
          <p class="qr-code-description">Scan this QR code to access the link</p>
          <div id="qrcode" class="qr-code-display"></div>
          <p class="qr-code-url">${url}</p>
          <button class="qr-download-btn" onclick="downloadQRCode('${url}')" style="margin-top: 1rem;">
            <i class="fas fa-download"></i>
            Download QR Code
          </button>
        </div>
      `,
      showConfirmButton: true,
      confirmButtonText: 'Close',
      width: '500px',
      customClass: {
        popup: 'qr-modal-popup'
      },
      didOpen: () => {
        // Generate QR code using a simple API
        const qrContainer = document.getElementById('qrcode');
        if (qrContainer) {
          const qrSize = 250;
          const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=${qrSize}x${qrSize}&data=${encodeURIComponent(url)}`;
          qrContainer.innerHTML = `<img id="qrCodeImage" src="${qrUrl}" alt="QR Code" style="max-width: 100%; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);" />`;
        }
      }
    });
  }

  /**
   * Download QR Code as image
   */
  async function downloadQRCode(url) {
    try {
      const qrSize = 500; // Higher resolution for download
      const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=${qrSize}x${qrSize}&data=${encodeURIComponent(url)}`;
      
      // Fetch the QR code image
      const response = await fetch(qrUrl);
      const blob = await response.blob();
      
      // Create a blob URL and trigger download
      const blobUrl = window.URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = blobUrl;
      link.download = `qr-code-${Date.now()}.png`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      // Clean up the blob URL
      window.URL.revokeObjectURL(blobUrl);
      
      showNotification('âœ… QR Code downloaded successfully!', 'success');
    } catch (error) {
      console.error('Error downloading QR code:', error);
      showNotification('âŒ Failed to download QR code', 'error');
    }
  }

</script>

<!-- Custom Styles for Zoom Meeting Controls -->
<style>
  .zoom-meeting-controls {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 8px;
    margin-bottom: 8px;
    padding: 8px;
    background: rgba(139, 92, 246, 0.1);
    border-radius: 6px;
    border-left: 3px solid #8b5cf6;
  }

  .content-regular-actions {
    display: flex;
    gap: 4px;
    align-items: center;
  }

  .zoom-meeting-controls .btn {
    font-size: 12px;
    padding: 4px 8px;
    border-radius: 4px;
    white-space: nowrap;
  }

  .zoom-meeting-controls .badge {
    font-size: 11px;
    padding: 4px 8px;
    border-radius: 12px;
    animation: pulse 2s infinite;
  }

  .zoom-meeting-controls .badge.bg-success {
    background: linear-gradient(45deg, #10b981, #059669) !important;
  }

  @keyframes pulse {
    0% {
      box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7);
    }

    70% {
      box-shadow: 0 0 0 10px rgba(16, 185, 129, 0);
    }

    100% {
      box-shadow: 0 0 0 0 rgba(16, 185, 129, 0);
    }
  }

  .content-item[data-content-type="zoom"] .content-icon {
    background: linear-gradient(45deg, #8b5cf6, #7c3aed);
  }

  .content-item[data-content-type="zoom"] .content-details {
    border-left: 3px solid #8b5cf6;
    padding-left: 12px;
  }

  .zoom-meeting-id,
  .zoom-meeting-time {
    font-size: 11px !important;
    color: #6b7280 !important;
    font-family: monospace;
  }

  .zoom-meeting-time i {
    margin-right: 4px;
  }

  /* Dark theme support */
  .dark-theme .zoom-meeting-controls {
    background: rgba(139, 92, 246, 0.2);
    border-left-color: #a855f7;
  }

  .dark-theme .zoom-meeting-id,
  .dark-theme .zoom-meeting-time {
    color: #9ca3af !important;
  }

  /* Enhanced Visibility Toggle Button Styles */
  .visibility-toggle {
    position: relative;
    overflow: hidden;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    min-width: 90px;
    justify-content: space-between;
    padding: 8px 12px;
    gap: 6px;
  }

  .visibility-toggle .btn-text {
    font-size: 12px;
    font-weight: 600;
    transition: all 0.3s ease;
  }

  /* Published State (Green) */
  .visibility-toggle.published {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    border-color: #10b981;
    color: white;
    box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
  }

  .visibility-toggle.published:hover {
    background: linear-gradient(135deg, #059669 0%, #047857 100%);
    border-color: #059669;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
  }

  /* Draft State (Orange) */
  .visibility-toggle.draft {
    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    border-color: #f59e0b;
    color: white;
    box-shadow: 0 2px 8px rgba(245, 158, 11, 0.3);
  }

  .visibility-toggle.draft:hover {
    background: linear-gradient(135deg, #d97706 0%, #b45309 100%);
    border-color: #d97706;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(245, 158, 11, 0.4);
  }

  /* Loading State */
  .visibility-toggle.loading {
    background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
    border-color: #6b7280;
    color: white;
    cursor: not-allowed;
    transform: scale(0.98);
  }

  .visibility-toggle.loading .btn-text {
    opacity: 0.8;
  }

  /* Success Animation */
  .visibility-toggle.success-animation {
    animation: successPulse 0.6s ease-in-out;
  }

  @keyframes successPulse {
    0% {
      transform: scale(1);
    }

    50% {
      transform: scale(1.05);
      box-shadow: 0 0 20px rgba(16, 185, 129, 0.6);
    }

    100% {
      transform: scale(1);
    }
  }

  /* Error Animation */
  .visibility-toggle.error-animation {
    animation: errorShake 0.6s ease-in-out;
  }

  @keyframes errorShake {

    0%,
    100% {
      transform: translateX(0);
    }

    25% {
      transform: translateX(-4px);
    }

    75% {
      transform: translateX(4px);
    }
  }

  /* Dark Theme Support */
  .dark-theme .visibility-toggle.published {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    border-color: #10b981;
  }

  .dark-theme .visibility-toggle.draft {
    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    border-color: #f59e0b;
  }

  .dark-theme .visibility-toggle.loading {
    background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
    border-color: #6b7280;
  }

  /* Responsive Design */
  @media (max-width: 768px) {
    .visibility-toggle {
      min-width: 80px;
      padding: 6px 10px;
    }

    .visibility-toggle .btn-text {
      font-size: 11px;
    }
  }

  /* Icon Animation */
  .visibility-toggle i {
    transition: transform 0.3s ease;
  }

  .visibility-toggle:hover i {
    transform: scale(1.1);
  }

  .visibility-toggle.loading i {
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    from {
      transform: rotate(0deg);
    }

    to {
      transform: rotate(360deg);
    }
  }

  /* ==================== CONTENT REORDERING STYLES ==================== */

  .content-items-header {
    display: flex;
    justify-content: flex-end;
    padding: 10px 15px;
    background: #f8f9fa;
    border-radius: 8px 8px 0 0;
    margin-bottom: 10px;
  }

  .content-reorder-btn {
    transition: all 0.3s ease;
  }

  .content-reorder-btn.active {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    color: white;
    border-color: #10b981;
  }

  .content-reorder-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
  }

  .content-drag-handle {
    display: none;
    cursor: grab;
    padding: 10px;
    color: #6b7280;
    transition: all 0.3s ease;
  }

  .content-drag-handle:hover {
    color: #3b82f6;
  }

  .content-drag-handle:active {
    cursor: grabbing;
  }

  .content-items.reorder-mode .content-drag-handle {
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .content-items.reorder-mode .content-item {
    cursor: move;
    transition: all 0.3s ease;
    border: 2px dashed transparent;
  }

  .content-items.reorder-mode .content-item:hover {
    border-color: #3b82f6;
    background: #eff6ff;
  }

  .content-item.draggable {
    opacity: 1;
  }

  .content-item.dragging {
    opacity: 0.5;
    transform: scale(0.95);
    box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
  }

  .content-item.drag-over {
    border-color: #10b981 !important;
    background: #d1fae5 !important;
    transform: scale(1.02);
  }

  /* Adjust content item layout for drag handle */
  .content-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 15px;
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    margin-bottom: 10px;
    transition: all 0.3s ease;
  }

  .content-item:hover {
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
  }

  .content-icon {
    flex-shrink: 0;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 8px;
    font-size: 18px;
    color: white;
  }

  .content-icon.video {
    background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
  }

  .content-icon.pdf {
    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
  }

  .content-icon.quiz {
    background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
  }

  .content-icon.homework {
    background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
  }

  .content-icon.link {
    background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
  }

  .content-details {
    flex: 1;
    min-width: 0;
  }

  .content-title {
    font-size: 14px;
    font-weight: 600;
    color: #111827;
    margin: 0 0 5px 0;
  }

  .content-meta {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    font-size: 12px;
    color: #6b7280;
  }

  .content-description {
    font-size: 12px;
    color: #6b7280;
    margin: 5px 0 0 0;
  }

  .content-actions {
    flex-shrink: 0;
    display: flex;
    flex-direction: column;
    gap: 5px;
  }

  /* Dark theme support */
  .dark-theme .content-items-header {
    background: #1f2937;
  }

  .dark-theme .content-item {
    background: #1f2937;
    border-color: #374151;
  }

  .dark-theme .content-item:hover {
    background: #111827;
  }

  .dark-theme .content-items.reorder-mode .content-item:hover {
    border-color: #3b82f6;
    background: #1e3a8a;
  }

  .dark-theme .content-item.drag-over {
    background: #064e3b !important;
  }

  .dark-theme .content-title {
    color: #f9fafb;
  }

  .dark-theme .content-meta,
  .dark-theme .content-description {
    color: #9ca3af;
  }

  /* Responsive design */
  @media (max-width: 768px) {
    .content-item {
      flex-direction: column;
      align-items: flex-start;
    }

    .content-actions {
      flex-direction: row;
      width: 100%;
      justify-content: flex-end;
    }

    .content-drag-handle {
      padding: 5px;
    }
  }

  /* Bank Filter Button Active State - Green */
  .bank-filter-btn.active {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%) !important;
    color: white !important;
    border-color: #10b981 !important;
    box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3) !important;
  }

  .bank-filter-btn.active:hover {
    background: linear-gradient(135deg, #059669 0%, #047857 100%) !important;
    border-color: #059669 !important;
    box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4) !important;
  }

  /* Ensure all question types have the same color - remove yellow from medium difficulty */
  .question-item.medium {
    border-left-color: #3b82f6 !important;
    background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%) !important;
  }

  .question-item.medium:hover {
    background: linear-gradient(135deg, #ffffff 0%, #f1f5f9 100%) !important;
    border-left-color: #3b82f6 !important;
  }

  .question-item.selected.medium {
    background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%) !important;
    border-color: #3b82f6 !important;
    border-left-color: #3b82f6 !important;
    box-shadow: 0 8px 24px rgba(59, 130, 246, 0.25), 0 4px 8px rgba(59, 130, 246, 0.15) !important;
  }

  .question-item.selected.medium .question-item-number {
    background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%) !important;
    border-color: #3b82f6 !important;
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4), 0 2px 4px rgba(59, 130, 246, 0.2) !important;
  }

  .question-item.selected.medium .question-item-bank {
    background: rgba(59, 130, 246, 0.1) !important;
  }

  /* Ensure True/False questions get the same green selected styling as MCQ and Written */
  .question-item.selected {
    background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%) !important;
    border-color: #3b82f6 !important;
    border-left-color: #3b82f6 !important;
    box-shadow: 0 8px 24px rgba(59, 130, 246, 0.25), 0 4px 8px rgba(59, 130, 246, 0.15) !important;
    transform: translateY(-2px) !important;
  }

  .question-item.selected .question-item-number {
    background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%) !important;
    color: white !important;
    border-color: #3b82f6 !important;
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4), 0 2px 4px rgba(59, 130, 246, 0.2) !important;
    transform: scale(1.1) !important;
  }

  .question-item.selected .question-item-bank {
    background: rgba(59, 130, 246, 0.1) !important;
    color: #475569 !important;
  }

  .question-item.selected .question-check-indicator {
    opacity: 1 !important;
    color: #3b82f6 !important;
  }

  /* Override any difficulty-specific selected styles to use consistent green/blue */
  .question-item.selected.easy,
  .question-item.selected.medium,
  .question-item.selected.hard {
    background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%) !important;
    border-color: #3b82f6 !important;
    border-left-color: #3b82f6 !important;
    box-shadow: 0 8px 24px rgba(59, 130, 246, 0.25), 0 4px 8px rgba(59, 130, 246, 0.15) !important;
  }

  .question-item.selected.easy .question-item-number,
  .question-item.selected.medium .question-item-number,
  .question-item.selected.hard .question-item-number {
    background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%) !important;
    border-color: #3b82f6 !important;
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4), 0 2px 4px rgba(59, 130, 246, 0.2) !important;
  }

  .question-item.selected.easy .question-item-bank,
  .question-item.selected.medium .question-item-bank,
  .question-item.selected.hard .question-item-bank {
    background: rgba(59, 130, 246, 0.1) !important;
  }

  /* Zoom Settings Enhanced Styles */
  .zoom-setting-item:hover {
    background: #ffffff !important;
    border-color: #2d5aa0 !important;
    box-shadow: 0 1px 4px rgba(45, 90, 160, 0.12) !important;
    transform: translateY(-1px);
  }

  .zoom-setting-item .form-check-input:checked {
    background-color: #2d5aa0;
    border-color: #2d5aa0;
  }

  .zoom-setting-item .form-check-input:focus {
    border-color: #2d5aa0;
    box-shadow: 0 0 0 0.2rem rgba(45, 90, 160, 0.2);
  }

  .zoom-settings-grid .zoom-setting-item label:hover {
    color: #2d3748 !important;
  }

  .zoom-setting-item i {
    transition: color 0.2s ease;
  }

  .zoom-setting-item:hover i {
    color: #2d5aa0 !important;
  }

  /* Smaller toggle switch styling */
  .zoom-setting-item .form-check-input {
    flex-shrink: 0;
  }

  /* Input focus styles */
  #zoomMeetingName:focus,
  #zoomMeetingTopic:focus,
  #zoomScheduledTime:focus,
  #zoomDuration:focus,
  #zoomTimezone:focus,
  #zoomPassword:focus,
  #editZoomMeetingName:focus,
  #editZoomMeetingTopic:focus,
  #editZoomScheduledTime:focus,
  #editZoomDuration:focus,
  #editZoomTimezone:focus,
  #editZoomPassword:focus {
    border-color: #2d5aa0 !important;
    box-shadow: 0 0 0 0.2rem rgba(45, 90, 160, 0.15) !important;
    outline: none;
  }

  /* Responsive zoom settings */
  @media (max-width: 768px) {
    .zoom-settings-grid {
      grid-template-columns: 1fr !important;
      gap: 6px !important;
    }
    .zoom-settings-card {
      padding: 10px !important;
    }
    .zoom-setting-item {
      padding: 6px !important;
    }
  }

  @media (min-width: 769px) and (max-width: 992px) {
    .zoom-settings-grid {
      grid-template-columns: repeat(2, 1fr) !important;
    }
  }

  /* ==========================================
     SHARE MODAL STYLES
     ========================================== */
  
  /* Share Modal Popup */
  .share-modal-popup {
    border-radius: 20px !important;
    padding: 0 !important;
    overflow: hidden;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3) !important;
  }

  .share-modal-popup .swal2-title {
    font-size: 1.75rem;
    font-weight: 700;
    color: #1f2937;
    margin-bottom: 1.5rem;
    padding: 1.5rem 2rem 0;
  }

  .share-modal-popup .swal2-html-container {
    padding: 0 2rem 2rem;
    margin: 0;
  }

  .share-modal-close {
    font-size: 1.5rem !important;
    color: #6b7280 !important;
    transition: all 0.3s ease !important;
  }

  .share-modal-close:hover {
    color: #dc2626 !important;
    transform: rotate(90deg);
  }

  /* Share Modal Content */
  .share-modal-content {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }

  /* Share Item Info */
  .share-item-info {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1.25rem;
    background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
    border-radius: 12px;
    border-left: 4px solid #dc2626;
  }

  .share-item-icon {
    width: 50px;
    height: 50px;
    background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 1.5rem;
    flex-shrink: 0;
    box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3);
  }

  .share-item-details {
    flex: 1;
    text-align: left;
  }

  .share-item-title {
    font-size: 1.1rem;
    font-weight: 600;
    color: #1f2937;
    margin: 0 0 0.25rem 0;
  }

  .share-item-description {
    font-size: 0.875rem;
    color: #6b7280;
    margin: 0;
    line-height: 1.4;
  }

  /* Share Link Container */
  .share-link-container {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  .share-link-label {
    font-size: 0.875rem;
    font-weight: 600;
    color: #374151;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .share-link-label i {
    color: #dc2626;
  }

  .share-link-input-wrapper {
    display: flex;
    gap: 0.5rem;
    align-items: stretch;
  }

  .share-link-input {
    flex: 1;
    padding: 0.875rem 1rem;
    border: 2px solid #e5e7eb;
    border-radius: 10px;
    font-size: 0.875rem;
    color: #1f2937;
    background: #f9fafb;
    transition: all 0.3s ease;
    font-family: 'Courier New', monospace;
  }

  .share-link-input:focus {
    outline: none;
    border-color: #dc2626;
    background: white;
    box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.1);
  }

  .share-copy-btn {
    padding: 0.875rem 1.5rem;
    background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
    color: white;
    border: none;
    border-radius: 10px;
    font-weight: 600;
    font-size: 0.875rem;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    white-space: nowrap;
    box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3);
  }

  .share-copy-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(220, 38, 38, 0.4);
  }

  .share-copy-btn:active {
    transform: translateY(0);
  }

  .share-copy-btn.copied {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
  }

  /* Share Actions */
  .share-actions {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 0.75rem;
  }

  .share-action-btn {
    padding: 0.875rem 1rem;
    border: 2px solid #e5e7eb;
    border-radius: 10px;
    background: white;
    color: #374151;
    font-weight: 600;
    font-size: 0.875rem;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
  }

  .share-action-btn i {
    font-size: 1.1rem;
  }

  .share-action-btn.whatsapp {
    border-color: #25D366;
    color: #25D366;
  }

  .share-action-btn.whatsapp:hover {
    background: #25D366;
    color: white;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(37, 211, 102, 0.3);
  }

  .share-action-btn.email {
    border-color: #3b82f6;
    color: #3b82f6;
  }

  .share-action-btn.email:hover {
    background: #3b82f6;
    color: white;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
  }

  .share-action-btn.telegram {
    border-color: #0088cc;
    color: #0088cc;
  }

  .share-action-btn.telegram:hover {
    background: #0088cc;
    color: white;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 136, 204, 0.3);
  }

  /* QR Section */
  .share-qr-section {
    padding-top: 0.5rem;
    border-top: 1px solid #e5e7eb;
  }

  .share-qr-btn {
    width: 100%;
    padding: 0.875rem 1.5rem;
    background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
    color: white;
    border: none;
    border-radius: 10px;
    font-weight: 600;
    font-size: 0.875rem;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
  }

  .share-qr-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(99, 102, 241, 0.4);
  }

  .share-qr-btn i {
    font-size: 1.1rem;
  }

  /* QR Code Modal */
  .qr-modal-popup {
    border-radius: 20px !important;
    padding: 2rem !important;
  }

  .qr-code-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1.5rem;
  }

  .qr-code-description {
    font-size: 1rem;
    color: #6b7280;
    margin: 0;
  }

  .qr-code-display {
    padding: 1.5rem;
    background: white;
    border-radius: 16px;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
  }

  .qr-code-url {
    font-size: 0.75rem;
    color: #9ca3af;
    margin: 0;
    word-break: break-all;
    text-align: center;
    font-family: 'Courier New', monospace;
  }

  .qr-download-btn {
    width: 100%;
    padding: 0.875rem 1.5rem;
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    color: white;
    border: none;
    border-radius: 10px;
    font-weight: 600;
    font-size: 0.875rem;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
  }

  .qr-download-btn:hover {
    background: linear-gradient(135deg, #059669 0%, #047857 100%);
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(16, 185, 129, 0.4);
  }

  .qr-download-btn:active {
    transform: translateY(0);
  }

  /* Share Button Styling in Topic Actions */
  .action-btn.share-btn {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    color: white;
    border: none;
  }

  .action-btn.share-btn:hover {
    background: linear-gradient(135deg, #059669 0%, #047857 100%);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
  }

  .action-btn.share-btn i {
    color: white;
  }

  /* Responsive Design */
  @media (max-width: 640px) {
    .share-modal-popup {
      width: 95% !important;
      margin: 0 auto;
    }

    .share-actions {
      grid-template-columns: 1fr;
    }

    .share-link-input-wrapper {
      flex-direction: column;
    }

    .share-copy-btn {
      width: 100%;
      justify-content: center;
    }

    .share-item-info {
      flex-direction: column;
      text-align: center;
    }

    .share-item-details {
      text-align: center;
    }
  }

  /* Dark Theme Support */
  .dark-theme .share-modal-popup .swal2-title {
    color: #f9fafb;
  }

  .dark-theme .share-item-info {
    background: linear-gradient(135deg, #374151 0%, #1f2937 100%);
  }

  .dark-theme .share-item-title {
    color: #f9fafb;
  }

  .dark-theme .share-item-description {
    color: #d1d5db;
  }

  .dark-theme .share-link-label {
    color: #e5e7eb;
  }

  .dark-theme .share-link-input {
    background: #1f2937;
    border-color: #374151;
    color: #f9fafb;
  }

  .dark-theme .share-link-input:focus {
    background: #111827;
    border-color: #dc2626;
  }

  .dark-theme .share-action-btn {
    background: #1f2937;
    border-color: #374151;
    color: #d1d5db;
  }

  .dark-theme .share-qr-section {
    border-top-color: #374151;
  }

  .dark-theme .qr-code-description {
    color: #d1d5db;
  }

  .dark-theme .qr-code-url {
    color: #6b7280;
  }

</style>