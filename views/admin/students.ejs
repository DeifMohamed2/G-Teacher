<%- include('partials/admin-header') %>

  <style>
    /* CSS Variables for Admin Theme */
    .light-theme {
      --admin-primary: #b80101;
      --admin-secondary: #f8f9fa;
      --admin-success: #10b981;
      --admin-warning: #f59e0b;
      --admin-danger: #ef4444;
      --admin-info: #3b82f6;
      --admin-bg-light: #f8fafc;
      --admin-bg-dark: #1e293b;
      --admin-card-light: #ffffff;
      --admin-card-dark: #2d3748;
      --admin-text-light: #1e293b;
      --admin-text-dark: #f7fafc;
      --admin-border-light: #e2e8f0;
      --admin-border-dark: #4a5568;
      --admin-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }

    .dark-theme {
      --admin-primary: #d40000;
      --admin-secondary: #2d3748;
      --admin-success: #10b981;
      --admin-warning: #f59e0b;
      --admin-danger: #ef4444;
      --admin-info: #3b82f6;
      --admin-bg-light: #1e293b;
      --admin-bg-dark: #0f172a;
      --admin-card-light: #2d3748;
      --admin-card-dark: #1e293b;
      --admin-text-light: #f7fafc;
      --admin-text-dark: #e2e8f0;
      --admin-border-light: #4a5568;
      --admin-border-dark: #2d3748;
      --admin-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3), 0 2px 4px -1px rgba(0, 0, 0, 0.2);
    }

    /* Professional Student Management Styles */
    .admin-main-content {
      margin-left: 280px;
      min-height: 100vh;
      background: var(--admin-bg-light);
      transition: margin-left 0.3s ease;
    }

    /* Sidebar hidden state */
    .admin-sidebar.sidebar-hidden {
      transform: translateX(-100%);
    }

    .admin-students-container {
      padding: 20px;
      background: var(--admin-bg-light);
      min-height: calc(100vh - 80px);
    }

    /* Responsive adjustments for smaller screens */
    @media (max-width: 1024px) {
      .admin-main-content {
        margin-left: 0;
      }
      
      .admin-students-container {
        padding: 15px;
      }
    }

    /* Page Header */
    .students-page-header {
      background: var(--admin-card-light);
      border: 1px solid var(--admin-border-light);
      border-radius: 12px;
      padding: 30px;
      margin-bottom: 30px;
      box-shadow: var(--admin-shadow);
    }


    .page-header-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .page-title-section {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .page-title-icon {
      width: 50px;
      height: 50px;
      background: var(--admin-primary);
      color: white;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
    }

    .page-title {
      font-size: 2rem;
      font-weight: 700;
      color: var(--admin-text-light);
      margin: 0;
    }


    .page-subtitle {
      color: var(--admin-text-light);
      opacity: 0.7;
      margin: 0;
      font-size: 1rem;
    }


    .page-actions {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .action-btn {
      padding: 14px 28px;
      border-radius: 10px;
      font-weight: 600;
      text-decoration: none;
      display: flex;
      align-items: center;
      gap: 10px;
      transition: all 0.3s ease;
      border: none;
      cursor: pointer;
      font-size: 1rem;
      position: relative;
      overflow: hidden;
      min-width: 140px;
      justify-content: center;
    }

    .action-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: left 0.5s;
    }

    .action-btn:hover::before {
      left: 100%;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--admin-primary) 0%, #a00000 100%);
      color: white;
      border: 1px solid var(--admin-primary);
      box-shadow: 0 4px 12px rgba(184, 1, 1, 0.3);
    }

    .btn-primary:hover {
      background: linear-gradient(135deg, #a00000 0%, #800000 100%);
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(184, 1, 1, 0.4);
    }

    .btn-secondary {
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0.05) 100%);
      color: var(--admin-text-light);
      border: 2px solid var(--admin-border-light);
      backdrop-filter: blur(10px);
    }


    .btn-secondary:hover {
      background: linear-gradient(135deg, var(--admin-primary) 0%, #a00000 100%);
      color: white;
      transform: translateY(-2px);
      border-color: var(--admin-primary);
      box-shadow: 0 6px 20px rgba(184, 1, 1, 0.3);
    }

    /* Enhanced Clear Button */
    .btn-clear {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      color: white;
      border: 1px solid #ef4444;
      box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
    }

    .btn-clear:hover {
      background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(239, 68, 68, 0.4);
    }

    /* Enhanced Export Button */
    .btn-export {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
      border: 1px solid #10b981;
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
    }

    .btn-export:hover {
      background: linear-gradient(135deg, #059669 0%, #047857 100%);
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
    }

    /* Button Group Styles */
    .btn-group {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .btn-group .btn {
      margin: 0;
    }

    .btn-group .btn:first-child {
      border-top-right-radius: 0;
      border-bottom-right-radius: 0;
    }

    .btn-group .btn:last-child {
      border-top-left-radius: 0;
      border-bottom-left-radius: 0;
    }

    /* Button styles matching student-details.ejs */
    .btn {
      padding: 14px 28px;
      border: none;
      border-radius: 10px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 10px;
      font-size: 1rem;
      min-width: 140px;
      justify-content: center;
      position: relative;
      overflow: hidden;
    }

    .btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: left 0.5s;
    }

    .btn:hover::before {
      left: 100%;
    }

    .btn-primary {
      background: linear-gradient(135deg, #b80101 0%, #8b0000 100%);
      color: white;
      border: 1px solid #b80101;
      box-shadow: 0 4px 12px rgba(184, 1, 1, 0.3);
    }

    .btn-primary:hover {
      background: linear-gradient(135deg, #8b0000 0%, #660000 100%);
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(184, 1, 1, 0.4);
    }

    .btn-secondary {
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0.05) 100%);
      color: #1e293b;
      border: 2px solid #e2e8f0;
      backdrop-filter: blur(10px);
    }

    .btn-secondary:hover {
      background: linear-gradient(135deg, #b80101 0%, #8b0000 100%);
      color: white;
      transform: translateY(-2px);
      border-color: #b80101;
      box-shadow: 0 6px 20px rgba(184, 1, 1, 0.3);
    }

    /* Enhanced Apply Filters Button */
    .btn-apply {
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      color: white;
      border: 1px solid #3b82f6;
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }

    .btn-apply:hover {
      background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
    }

    /* Analytics Stats Grid */
    .admin-analytics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 24px;
      margin-bottom: 30px;
    }

    .admin-analytics-card {
      background: var(--admin-card-light);
      border: 1px solid var(--admin-border-light);
      border-radius: 12px;
      padding: 24px;
      box-shadow: var(--admin-shadow);
      transition: all 0.3s ease;
    }


    .admin-analytics-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }

    .analytics-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .analytics-icon {
      width: 50px;
      height: 50px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      color: white;
    }

    .analytics-icon.students {
      background: var(--admin-primary);
    }

    .analytics-icon.active {
      background: #10b981;
    }

    .analytics-icon.courses {
      background: #3b82f6;
    }

    .analytics-icon.schools {
      background: #f59e0b;
    }

    .analytics-trend {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 0.85rem;
      padding: 4px 8px;
      border-radius: 16px;
    }

    .trend-up {
      background: rgba(16, 185, 129, 0.1);
      color: #10b981;
    }

    .trend-down {
      background: rgba(239, 68, 68, 0.1);
      color: #ef4444;
    }

    .analytics-number {
      font-size: 2.5rem;
      font-weight: 800;
      color: var(--admin-text-light);
      margin: 8px 0;
    }

    .analytics-label {
      color: var(--admin-text-light);
      opacity: 0.7;
      font-weight: 500;
    }

    /* Filters Section */
    .filters-section {
      background: var(--admin-card-light);
      border: 1px solid var(--admin-border-light);
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 30px;
      box-shadow: var(--admin-shadow);
    }

    .filters-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--admin-border-light);
    }

    .filters-title {
      font-size: 1.2rem;
      font-weight: 600;
      color: var(--admin-text-light);
      margin: 0;
      display: flex;
      align-items: center;
      gap: 8px;
    }


    .filters-toggle {
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0.05) 100%);
      border: 2px solid #e2e8f0;
      color: #1e293b;
      padding: 10px 20px;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 600;
      position: relative;
      overflow: hidden;
      backdrop-filter: blur(10px);
    }

    .filters-toggle::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: left 0.5s;
    }

    .filters-toggle:hover::before {
      left: 100%;
    }

    .dark-theme .filters-toggle {
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.15) 0%, rgba(59, 130, 246, 0.08) 100%);
      border-color: #3b82f6;
      color: #60a5fa;
    }

    .filters-toggle:hover {
      background: linear-gradient(135deg, #b80101 0%, #8b0000 100%);
      color: white;
      border-color: #b80101;
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(184, 1, 1, 0.3);
    }

    .filters-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 20px;
    }

    .filter-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .filter-label {
      font-size: 0.9rem;
      font-weight: 500;
      color: var(--admin-text-light);
      opacity: 0.8;
    }

    .dark-theme .filter-label {
      color: var(--admin-text-dark);
    }

    .filter-control {
      padding: 10px 12px;
      border: 1px solid var(--admin-border-light);
      border-radius: 6px;
      background: var(--admin-card-light);
      color: var(--admin-text-light);
      font-size: 0.9rem;
      transition: all 0.3s ease;
    }


    .filter-control:focus {
      outline: none;
      border-color: var(--admin-primary);
      box-shadow: 0 0 0 3px rgba(184, 1, 1, 0.1);
    }

    .search-box {
      position: relative;
    }

    .search-input {
      padding: 10px 12px 10px 40px;
      border: 1px solid var(--admin-border-light);
      border-radius: 8px;
      background: var(--admin-card-light);
      color: var(--admin-text-light);
      width: 100%;
      font-size: 0.9rem;
    }


    .search-icon {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--admin-text-light);
      opacity: 0.5;
    }


    .filters-actions {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    }

    /* Students Table */
    .students-table-container {
      background: var(--admin-card-light);
      border: 1px solid var(--admin-border-light);
      border-radius: 16px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      overflow: hidden;
      transition: all 0.3s ease;
    }

    .students-table-container:hover {
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
    }

    .table-header {
      padding: 24px 28px;
      border-bottom: 2px solid var(--admin-border-light);
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: var(--admin-card-light);
      position: sticky;
      top: 0;
      z-index: 20;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    .dark-theme .table-header {
      background: var(--admin-card-light);
    }


    .table-title {
      font-size: 1.4rem;
      font-weight: 800;
      color: var(--admin-text-light);
      margin: 0;
      display: flex;
      align-items: center;
      gap: 12px;
      letter-spacing: -0.5px;
    }

    .table-title::before {
      content: 'ðŸ‘¥';
      font-size: 1.8rem;
      filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
    }

    .table-actions {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .table-actions .action-btn {
      padding: 12px 20px;
      font-size: 0.9rem;
    }

    .table-overflow {
      overflow-x: auto;
      max-height: calc(100vh - 450px);
    }

    .table-overflow::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    .table-overflow::-webkit-scrollbar-track {
      background: var(--admin-bg-light);
    }

    .table-overflow::-webkit-scrollbar-thumb {
      background: var(--admin-border-light);
      border-radius: 4px;
    }

    .table-overflow::-webkit-scrollbar-thumb:hover {
      background: var(--admin-primary);
    }

    .students-table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      table-layout: auto;
    }

    /* Adjust column widths for better name display */
    .students-table th:nth-child(1),
    .students-table td:nth-child(1) {
      width: 25%;
      min-width: 50px;
    }

    .students-table th {
      background: var(--admin-card-light);
      color: var(--admin-text-light);
      font-weight: 700;
      padding: 18px 16px;
      text-align: left;
      border-bottom: 2px solid var(--admin-primary);
      white-space: nowrap;
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      position: sticky;
      top: 0;
      z-index: 10;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    .students-table th.checkbox-cell {
      border-top-left-radius: 12px;
    }

    .students-table th:last-child {
      border-top-right-radius: 12px;
    }

    .dark-theme .students-table th {
      background: var(--admin-card-light);
    }


    .students-table td {
      padding: 18px 16px;
      border-bottom: 1px solid var(--admin-border-light);
      vertical-align: middle;
      font-size: 0.9rem;
      transition: all 0.2s ease;
    }

    /* Special styling for checkbox cells */
    .students-table td.checkbox-cell {
      padding: 18px 8px;
      vertical-align: middle;
      text-align: center;
    }

    /* Alternating row colors */
    .students-table tbody tr:nth-child(even) {
      background: rgba(184, 1, 1, 0.01);
    }

    .students-table tbody tr {
      transition: all 0.3s ease;
      border-left: 3px solid transparent;
    }

    .students-table tbody tr:hover {
      background: linear-gradient(90deg, rgba(184, 1, 1, 0.05) 0%, rgba(184, 1, 1, 0.02) 100%);
      border-left-color: var(--admin-primary);
      transform: scale(1.001);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    .students-table tbody tr:last-child td {
      border-bottom: none;
    }


    /* Student Profile Cell */
    .student-profile {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .student-avatar {
      width: 50px;
      height: 50px;
      background: linear-gradient(135deg, var(--admin-primary) 0%, #8b0000 100%);
      color: white;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.3rem;
      font-weight: 800;
      flex-shrink: 0;
      box-shadow: 0 4px 12px rgba(184, 1, 1, 0.3);
      transition: all 0.3s ease;
      border: 2px solid rgba(255, 255, 255, 0.2);
    }

    .student-avatar:hover {
      transform: scale(1.08) rotate(2deg);
      box-shadow: 0 6px 16px rgba(184, 1, 1, 0.4);
    }

    .student-info {
      flex: 1;
      min-width: 0;
    }

    .student-name {
      font-weight: 700;
      color: var(--admin-text-light);
      margin-bottom: 2px;
      white-space: normal;
      word-wrap: break-word;
      line-height: 1.4;
      font-size: 0.95rem;
    }

    .student-email {
      font-size: 0.8rem;
      color: var(--admin-text-light);
      opacity: 0.65;
      white-space: normal;
      word-wrap: break-word;
      line-height: 1.3;
    }

    /* Student Code Cell */
    .student-code-cell {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .code-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 14px;
      background: transparent;
      color: var(--admin-primary);
      border: 2px solid var(--admin-primary);
      border-radius: 8px;
      font-size: 0.9rem;
      font-weight: 700;
      transition: all 0.3s ease;
    }

    .code-badge:hover {
      background: var(--admin-primary);
      color: white;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(184, 1, 1, 0.3);
    }

    .code-badge i {
      font-size: 0.75rem;
      opacity: 0.9;
    }

    /* Grade Badge */
    .grade-badge {
      display: inline-block;
      padding: 8px 16px;
      background: transparent;
      color: var(--admin-primary);
      border: 2px solid var(--admin-primary);
      border-radius: 8px;
      font-weight: 700;
      font-size: 0.95rem;
      text-align: center;
      transition: all 0.3s ease;
    }

    .grade-badge:hover {
      background: var(--admin-primary);
      color: white;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(184, 1, 1, 0.3);
    }

    /* Courses Cell */
    .courses-cell {
      text-align: center;
      padding: 10px 0;
    }

    .courses-count {
      font-weight: 800;
      font-size: 1.3rem;
      color: var(--admin-primary);
      margin-bottom: 4px;
      text-shadow: 0 1px 2px rgba(184, 1, 1, 0.1);
    }

    .courses-active {
      font-size: 0.8rem;
      opacity: 0.8;
      color: var(--admin-text-light);
      font-weight: 600;
    }

    /* Date Cell */
    .date-cell {
      text-align: center;
      padding: 10px 0;
    }

    .date-main {
      font-weight: 700;
      color: var(--admin-text-light);
      font-size: 0.95rem;
      margin-bottom: 4px;
    }

    .date-sub {
      font-size: 0.8rem;
      opacity: 0.7;
      color: var(--admin-text-light);
      font-weight: 500;
    }

    /* Activity Cell */
    .activity-cell {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      padding: 10px 0;
    }

    .activity-time {
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--admin-text-light);
    }

    .activity-indicator {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      box-shadow: 0 0 0 3px rgba(184, 1, 1, 0.2);
      animation: pulse 2s infinite;
    }

    .activity-indicator.active {
      background: var(--admin-primary);
      box-shadow: 0 0 0 3px rgba(184, 1, 1, 0.3);
    }

    .activity-indicator.moderate {
      background: #d97706;
      box-shadow: 0 0 0 3px rgba(217, 119, 6, 0.3);
    }

    .activity-indicator.inactive {
      background: #6b7280;
      box-shadow: 0 0 0 3px rgba(107, 114, 128, 0.3);
    }

    .no-activity {
      opacity: 0.5;
      font-size: 0.85rem;
      color: var(--admin-text-light);
      font-style: italic;
    }

    @keyframes pulse {
      0%, 100% {
        transform: scale(1);
        opacity: 1;
      }
      50% {
        transform: scale(1.1);
        opacity: 0.8;
      }
    }

    /* Status Badge */
    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
    }

    .status-active {
      background: rgba(16, 185, 129, 0.1);
      color: #10b981;
    }

    .status-inactive {
      background: rgba(107, 114, 128, 0.1);
      color: #6b7280;
    }

    .status-icon {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: currentColor;
    }

    /* Progress Bar */
    .progress-bar-container {
      width: 120px;
      text-align: center;
    }

    .progress-percentage {
      font-size: 0.85rem;
      font-weight: 700;
      color: var(--admin-primary);
      margin-bottom: 6px;
    }

    .progress-bar {
      width: 100%;
      height: 8px;
      background: rgba(184, 1, 1, 0.1);
      border-radius: 10px;
      overflow: hidden;
      box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--admin-primary) 0%, #8b0000 100%);
      border-radius: 10px;
      transition: width 0.8s ease;
      box-shadow: 0 2px 4px rgba(184, 1, 1, 0.3);
    }

    /* Action Buttons */
    .student-actions {
      display: flex;
      gap: 6px;
      align-items: center;
      justify-content: center;
    }

    .action-btn-sm {
      width: 36px;
      height: 36px;
      border-radius: 8px;
      border: 2px solid transparent;
      background: transparent;
      color: var(--admin-text-light);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s ease;
      text-decoration: none;
      position: relative;
      overflow: hidden;
    }

    .action-btn-sm::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.2);
      transform: translate(-50%, -50%);
      transition: width 0.3s ease, height 0.3s ease;
    }

    .action-btn-sm:hover::before {
      width: 100%;
      height: 100%;
    }

    .action-btn-sm:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .action-btn-sm.view {
      color: var(--admin-primary);
      border-color: rgba(184, 1, 1, 0.3);
    }

    .action-btn-sm.view:hover {
      background: var(--admin-primary);
      color: white;
      border-color: var(--admin-primary);
    }

    .action-btn-sm.edit {
      color: var(--admin-primary);
      border-color: rgba(184, 1, 1, 0.3);
    }

    .action-btn-sm.edit:hover {
      background: var(--admin-primary);
      color: white;
      border-color: var(--admin-primary);
    }

    .action-btn-sm.delete {
      color: var(--admin-primary);
      border-color: rgba(184, 1, 1, 0.3);
    }

    .action-btn-sm.delete:hover {
      background: var(--admin-primary);
      color: white;
      border-color: var(--admin-primary);
    }

    /* Pagination */
    .pagination-container {
      padding: 20px 24px;
      border-top: 1px solid var(--admin-border-light);
      display: flex;
      justify-content: between;
      align-items: center;
    }


    .pagination-info {
      color: var(--admin-text-light);
      opacity: 0.7;
      font-size: 0.9rem;
    }


    .pagination {
      display: flex;
      gap: 4px;
      margin: 0;
    }

    .pagination-btn {
      padding: 10px 16px;
      border: 2px solid var(--admin-border-light);
      background: var(--admin-card-light);
      color: var(--admin-text-light);
      border-radius: 8px;
      text-decoration: none;
      font-size: 0.9rem;
      font-weight: 600;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .pagination-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: left 0.5s;
    }

    .pagination-btn:hover::before {
      left: 100%;
    }


    .pagination-btn:hover {
      background: linear-gradient(135deg, var(--admin-primary) 0%, #a00000 100%);
      color: white;
      border-color: var(--admin-primary);
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(184, 1, 1, 0.3);
    }

    .pagination-btn.active {
      background: linear-gradient(135deg, var(--admin-primary) 0%, #a00000 100%);
      color: white;
      border-color: var(--admin-primary);
      box-shadow: 0 4px 12px rgba(184, 1, 1, 0.3);
    }

    .pagination-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .pagination-btn:disabled:hover {
      transform: none;
      box-shadow: none;
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--admin-text-light);
      opacity: 0.6;
    }


    .empty-state i {
      font-size: 4rem;
      margin-bottom: 20px;
      opacity: 0.3;
    }

    .empty-state h3 {
      font-size: 1.5rem;
      font-weight: 600;
      margin-bottom: 12px;
    }

    .empty-state p {
      font-size: 1rem;
      margin: 0;
    }

    /* Loading States */
    .loading-skeleton {
      background: linear-gradient(90deg, transparent, rgba(184, 1, 1, 0.1), transparent);
      background-size: 200% 100%;
      animation: loading 1.5s infinite;
    }

    @keyframes loading {
      0% {
        background-position: 200% 0;
      }

      100% {
        background-position: -200% 0;
      }
    }

    /* Responsive Design */
    @media (max-width: 1200px) {
      .admin-analytics-grid {
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      }

      .filters-grid {
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      }
    }

    @media (max-width: 768px) {
      .students-page-header {
        padding: 20px;
      }

      .page-header-top {
        flex-direction: column;
        align-items: flex-start;
        gap: 16px;
      }

      .page-actions {
        width: 100%;
        justify-content: flex-start;
      }

      .admin-analytics-grid {
        grid-template-columns: 1fr;
      }

      .filters-grid {
        grid-template-columns: 1fr;
      }

      .table-overflow {
        border-radius: 8px;
      }

      .students-table th,
      .students-table td {
        padding: 12px 8px;
        font-size: 0.8rem;
      }

      .student-profile {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
      }

      .student-info {
        width: 100%;
      }

      .student-name {
        font-size: 0.9rem;
      }

      .student-actions {
        flex-direction: column;
        gap: 4px;
      }

      .pagination-container {
        flex-direction: column;
        gap: 16px;
        align-items: flex-start;
      }
    }

    @media (max-width: 480px) {
      .students-page-header {
        padding: 16px;
      }

      .admin-analytics-card {
        padding: 16px;
      }

      .filters-section {
        padding: 16px;
      }

      .students-table-container {
        margin: 0 -16px;
        border-radius: 0;
        border-left: none;
        border-right: none;
      }
    }

    /* Status Filter Section */
    .status-filter-section {
      margin-bottom: 24px;
      padding-bottom: 20px;
      border-bottom: 2px solid var(--admin-border-light);
    }


    .status-filter-buttons {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    .status-filter-btn {
      flex: 1;
      min-width: 200px;
      padding: 14px 20px;
      border: 2px solid #e2e8f0;
      background: rgba(255, 255, 255, 0.1);
      color: #1e293b;
      border-radius: 10px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      position: relative;
      overflow: hidden;
      backdrop-filter: blur(10px);
    }


    .status-filter-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
      transition: left 0.5s;
    }

    .status-filter-btn:hover::before {
      left: 100%;
    }

    .status-filter-btn:hover {
      background: linear-gradient(135deg, #b80101 0%, #8b0000 100%);
      color: white;
      border-color: #b80101;
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(184, 1, 1, 0.3);
    }

    .status-filter-btn.active {
      background: linear-gradient(135deg, #b80101 0%, #8b0000 100%);
      color: white;
      border-color: #b80101;
      box-shadow: 0 4px 12px rgba(184, 1, 1, 0.3);
    }

    .status-filter-btn i {
      font-size: 1.2rem;
    }

    .status-count {
      background: rgba(255, 255, 255, 0.2);
      color: inherit;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 0.85rem;
      font-weight: 700;
      min-width: 24px;
      text-align: center;
    }

    .status-filter-btn.active .status-count {
      background: rgba(255, 255, 255, 0.3);
    }

    /* Advanced Filters (Hidden by Default) */
    .advanced-filters {
      display: none;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid var(--admin-border-light);
    }


    .advanced-filters.show {
      display: grid;
    }

    /* Date Range Picker */
    .date-range {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .date-range input {
      flex: 1;
      padding: 8px 10px;
      border: 1px solid var(--admin-border-light);
      border-radius: 4px;
      background: var(--admin-card-light);
      color: var(--admin-text-light);
      font-size: 0.85rem;
    }


    /* Toast Notification Styles */
    .toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 9999;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .toast {
      background: var(--admin-card-light);
      border: 1px solid var(--admin-border-light);
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
      min-width: 400px;
      max-width: 500px;
      transform: translateX(100%);
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .toast.show {
      transform: translateX(0);
    }


    .toast-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
    }

    .toast-icon {
      width: 40px;
      height: 40px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
      color: white;
    }

    .toast-icon.warning {
      background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    }

    .toast-icon.success {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    }

    .toast-icon.error {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    }

    .toast-title {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--admin-text-light);
      margin: 0;
    }

    .toast-message {
      color: var(--admin-text-light);
      opacity: 0.8;
      margin-bottom: 20px;
      line-height: 1.5;
    }

    .toast-actions {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    }

    .toast-btn {
      padding: 10px 20px;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      border: none;
      font-size: 0.9rem;
      position: relative;
      overflow: hidden;
    }

    .toast-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: left 0.5s;
    }

    .toast-btn:hover::before {
      left: 100%;
    }

    .toast-btn.cancel {
      background: var(--admin-border-light);
      color: var(--admin-text-light);
      border: 1px solid var(--admin-border-light);
    }


    .toast-btn.cancel:hover {
      background: rgba(107, 114, 128, 0.1);
      transform: translateY(-1px);
    }

    .toast-btn.confirm {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      color: white;
      border: 1px solid #ef4444;
    }

    .toast-btn.confirm:hover {
      background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
    }

    .toast-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .toast-btn:disabled:hover {
      transform: none;
      box-shadow: none;
    }

    /* Loading state for toast buttons */
    .toast-btn.loading {
      position: relative;
      color: transparent;
    }

    .toast-btn.loading::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 16px;
      height: 16px;
      margin: -8px 0 0 -8px;
      border: 2px solid transparent;
      border-top: 2px solid currentColor;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Responsive toast */
    @media (max-width: 768px) {
      .toast-container {
        top: 10px;
        right: 10px;
        left: 10px;
      }

      .toast {
        min-width: auto;
        max-width: none;
      }

      .toast-actions {
        flex-direction: column;
      }

      .toast-btn {
        width: 100%;
        justify-content: center;
      }
    }

    /* Bulk Actions Styles */
    .bulk-actions-toolbar {
      position: sticky;
      top: 0;
      z-index: 100;
      background: linear-gradient(135deg, var(--admin-primary) 0%, #8b0000 100%);
      color: white;
      padding: 16px 24px;
      margin: -24px -28px 24px -28px;
      border-radius: 12px 12px 0 0;
      display: none;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 4px 12px rgba(184, 1, 1, 0.3);
      animation: slideDown 0.3s ease;
    }

    .bulk-actions-toolbar.show {
      display: flex;
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .bulk-actions-info {
      display: flex;
      align-items: center;
      gap: 12px;
      font-weight: 600;
      font-size: 1rem;
    }

    .bulk-actions-info i {
      font-size: 1.2rem;
    }

    .bulk-actions-buttons {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .bulk-action-btn {
      padding: 10px 20px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      background: rgba(255, 255, 255, 0.15);
      color: white;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.9rem;
      backdrop-filter: blur(10px);
    }

    .bulk-action-btn:hover {
      background: rgba(255, 255, 255, 0.25);
      border-color: rgba(255, 255, 255, 0.5);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    .bulk-action-btn.activate {
      background: rgba(16, 185, 129, 0.3);
      border-color: rgba(16, 185, 129, 0.5);
    }

    .bulk-action-btn.activate:hover {
      background: rgba(16, 185, 129, 0.5);
      border-color: #10b981;
    }

    .bulk-action-btn.deactivate {
      background: rgba(239, 68, 68, 0.3);
      border-color: rgba(239, 68, 68, 0.5);
    }

    .bulk-action-btn.deactivate:hover {
      background: rgba(239, 68, 68, 0.5);
      border-color: #ef4444;
    }

    .bulk-action-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .bulk-action-btn:disabled:hover {
      transform: none;
      box-shadow: none;
    }

    /* Checkbox Styles */
    .student-checkbox {
      width: 16px;
      height: 16px;
      cursor: pointer;
      accent-color: var(--admin-primary);
      border-radius: 3px;
      transition: all 0.2s ease;
    }

    .student-checkbox:hover {
      transform: scale(1.1);
    }

    .select-all-checkbox {
      width: 16px;
      height: 16px;
      cursor: pointer;
      accent-color: var(--admin-primary);
      border-radius: 3px;
      transition: all 0.2s ease;
    }

    .select-all-checkbox:hover {
      transform: scale(1.1);
    }

    .checkbox-cell {
      width: 40px;
      text-align: center;
      padding: 18px 8px !important;
    }

    /* Status Badge in Table */
    .status-badge-table {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
      transition: all 0.2s ease;
    }

    .status-badge-table.active {
      background: rgba(16, 185, 129, 0.1);
      color: #10b981;
      border: 1px solid rgba(16, 185, 129, 0.3);
    }

    .status-badge-table.inactive {
      background: rgba(239, 68, 68, 0.1);
      color: #ef4444;
      border: 1px solid rgba(239, 68, 68, 0.3);
    }

    .status-icon-table {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: currentColor;
    }

    /* Clickable Badge Styles */
    .status-badge-table.clickable-badge {
      cursor: pointer;
      user-select: none;
    }

    .status-badge-table.clickable-badge:hover {
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
    }

    .status-badge-table.clickable-badge.active:hover {
      background: rgba(16, 185, 129, 0.2);
      border-color: rgba(16, 185, 129, 0.5);
    }

    .status-badge-table.clickable-badge.inactive:hover {
      background: rgba(239, 68, 68, 0.2);
      border-color: rgba(239, 68, 68, 0.5);
    }

    .status-badge-table.clickable-badge:active {
      transform: translateY(0);
    }

    /* Responsive bulk actions */
    @media (max-width: 768px) {
      .bulk-actions-toolbar {
        flex-direction: column;
        gap: 12px;
        padding: 12px 16px;
        margin: -24px -16px 16px -16px;
      }

      .bulk-actions-info {
        width: 100%;
        justify-content: center;
      }

      .bulk-actions-buttons {
        width: 100%;
        flex-direction: column;
      }

      .bulk-action-btn {
        width: 100%;
        justify-content: center;
      }
    }
  </style>
</head>

<body class="<%= theme %>">
  <%- include('partials/admin-sidebar') %>

  <div class="admin-main-content">
    <%- include('partials/admin-topbar') %>
    <div class="admin-students-container">
      <!-- Page Header -->
      <div class="students-page-header">
        <div class="page-header-top">
          <div class="page-title-section">
            <div class="page-title-icon">
              <i class="fas fa-user-graduate"></i>
            </div>
            <div>
              <h1 class="page-title">Student Management</h1>
              <p class="page-subtitle">
                Manage and monitor student progress across all courses
                <% if (pagination && pagination.totalStudents) { %>
                â€¢ <%= pagination.totalStudents %> total students
                <% } %>
              </p>
            </div>
          </div>
          <div class="page-actions">
            <button class="btn btn-secondary" onclick="showBulkImportModal()">
              <i class="fas fa-upload"></i>
              Bulk Import Students
            </button>
            <button class="btn btn-primary" onclick="exportStudents()">
              <i class="fas fa-file-excel"></i>
              Export All Students 
            </button>
          </div>
        </div>
      </div>

      <!-- Analytics Grid -->
      <% if (analytics) { %>
      <div class="admin-analytics-grid">
        <div class="admin-analytics-card">
          <div class="analytics-header">
            <div class="analytics-icon students">
              <i class="fas fa-users"></i>
            </div>
            <div class="analytics-trend trend-up">
              <i class="fas fa-arrow-up"></i>
              +12%
            </div>
          </div>
          <div class="analytics-number"><%= analytics.totalStudents || 0 %></div>
          <div class="analytics-label">Total Students</div>
        </div>

        <div class="admin-analytics-card">
          <div class="analytics-header">
            <div class="analytics-icon active">
              <i class="fas fa-user-check"></i>
            </div>
            <div class="analytics-trend trend-up">
              <i class="fas fa-arrow-up"></i>
              +8%
            </div>
          </div>
          <div class="analytics-number"><%= analytics.activeStudents || 0 %></div>
          <div class="analytics-label">Active Students</div>
        </div>

        <div class="admin-analytics-card">
          <div class="analytics-header">
            <div class="analytics-icon courses">
              <i class="fas fa-book"></i>
            </div>
            <div class="analytics-trend trend-up">
              <i class="fas fa-arrow-up"></i>
              +15%
            </div>
          </div>
          <div class="analytics-number"><%= Math.round(analytics.courseStats?.avgCourses || 0) %></div>
          <div class="analytics-label">Avg. Courses per Student</div>
        </div>

        <div class="admin-analytics-card">
          <div class="analytics-header">
            <div class="analytics-icon schools">
              <i class="fas fa-school"></i>
            </div>
            <div class="analytics-trend trend-up">
              <i class="fas fa-arrow-up"></i>
              +5%
            </div>
          </div>
          <div class="analytics-number"><%= analytics.schoolDistribution?.length || 0 %></div>
          <div class="analytics-label">Schools Represented</div>
        </div>
      </div>
      <% } %>

      <!-- Filters Section -->
      <div class="filters-section">
        <div class="filters-header">
          <h3 class="filters-title">
            <i class="fas fa-filter"></i>
            Filters & Search
          </h3>
          <button class="filters-toggle" onclick="toggleAdvancedFilters()">
            <i class="fas fa-cog"></i>
            Advanced
          </button>
        </div>

        <form id="filtersForm" method="GET" action="/admin/students">
          <!-- Status Filter at Top -->
          <div class="status-filter-section">
            <div class="status-filter-buttons">
              <button type="button" class="status-filter-btn <%= (currentFilters?.status === 'all' || !currentFilters?.status) ? 'active' : '' %>" onclick="setStatusFilter('all')">
                <i class="fas fa-users"></i>
                All Students
                <span class="status-count"><%= analytics?.totalStudents || 0 %></span>
              </button>
              <button type="button" class="status-filter-btn <%= currentFilters?.status === 'active' ? 'active' : '' %>" onclick="setStatusFilter('active')">
                <i class="fas fa-user-check"></i>
                Active Students
                <span class="status-count"><%= analytics?.activeStudents || 0 %></span>
              </button>
              <button type="button" class="status-filter-btn <%= currentFilters?.status === 'inactive' ? 'active' : '' %>" onclick="setStatusFilter('inactive')">
                <i class="fas fa-user-times"></i>
                Inactive Students
                <span class="status-count"><%= analytics?.inactiveStudents || 0 %></span>
              </button>
            </div>
            <input type="hidden" name="status" id="statusInput" value="<%= currentFilters?.status || 'all' %>">
          </div>

          <div class="filters-grid">
            <div class="filter-group">
              <label class="filter-label">Search Students</label>
              <div class="search-box">
                <i class="fas fa-search search-icon"></i>
                <input type="text" name="search" class="search-input" placeholder="Name, email, username, or student code..." value="<%= currentFilters?.search || '' %>">
              </div>
            </div>

            <div class="filter-group">
              <label class="filter-label">Grade</label>
              <select name="grade" class="filter-control">
                <option value="all">All Grades</option>
                <% if (filterOptions?.grades) { %>
                <% filterOptions.grades.forEach(grade => { %>
                <option value="<%= grade %>" <%= currentFilters?.grade === grade ? 'selected' : '' %>><%= grade %></option>
                <% }) %>
                <% } %>
              </select>
            </div>

            <div class="filter-group">
              <label class="filter-label">Sort By</label>
              <select name="sortBy" class="filter-control">
                <option value="createdAt" <%= (currentFilters?.sortBy === 'createdAt' || !currentFilters?.sortBy) ? 'selected' : '' %>>Registration Date</option>
                <option value="lastName" <%= currentFilters?.sortBy === 'lastName' ? 'selected' : '' %>>Last Name</option>
                <option value="firstName" <%= currentFilters?.sortBy === 'firstName' ? 'selected' : '' %>>First Name</option>
                <option value="lastLogin" <%= currentFilters?.sortBy === 'lastLogin' ? 'selected' : '' %>>Last Activity</option>
                <option value="grade" <%= currentFilters?.sortBy === 'grade' ? 'selected' : '' %>>Grade</option>
              </select>
            </div>
          </div>

          <!-- Advanced Filters (Hidden by Default) -->
          <div class="advanced-filters" id="advancedFilters">
            <div class="filter-group">
              <label class="filter-label">School</label>
              <select name="school" class="filter-control">
                <option value="all">All Schools</option>
                <% if (filterOptions?.schools) { %>
                <% filterOptions.schools.slice(0, 20).forEach(school => { %>
                <option value="<%= school %>" <%= currentFilters?.school === school ? 'selected' : '' %>><%= school %></option>
                <% }) %>
                <% } %>
              </select>
            </div>

            <div class="filter-group">
              <label class="filter-label">Bundle</label>
              <select name="bundle" class="filter-control">
                <option value="all">All Bundles</option>
                <% if (filterOptions?.bundles) { %>
                <% filterOptions.bundles.forEach(bundle => { %>
                <option value="<%= bundle._id %>" <%= currentFilters?.bundle === bundle._id ? 'selected' : '' %>><%= bundle.title %></option>
                <% }) %>
                <% } %>
              </select>
            </div>

            <div class="filter-group">
              <label class="filter-label">Course</label>
              <select name="course" class="filter-control">
                <option value="all">All Courses</option>
                <% if (filterOptions?.courses) { %>
                <% filterOptions.courses.forEach(course => { %>
                <option value="<%= course._id %>" <%= currentFilters?.course === course._id ? 'selected' : '' %>><%= course.title %></option>
                <% }) %>
                <% } %>
              </select>
            </div>

            <div class="filter-group">
              <label class="filter-label">Enrollment Date Range</label>
              <div class="date-range">
                <input type="date" name="enrollmentStart" value="<%= currentFilters?.enrollmentStart || '' %>">
                <span>to</span>
                <input type="date" name="enrollmentEnd" value="<%= currentFilters?.enrollmentEnd || '' %>">
              </div>
            </div>
          </div>

          <div class="filters-actions">
            <button type="button" class="btn btn-secondary" onclick="clearFilters()">
              <i class="fas fa-times"></i>
              Clear
            </button>
            <button type="submit" class="btn btn-primary">
              <i class="fas fa-search"></i>
              Apply Filters
            </button>
          </div>
        </form>
      </div>

      <!-- Students Table -->
      <div class="students-table-container">
        <div class="table-header">
          <h3 class="table-title">
            Students List
            <% if (pagination && pagination.totalStudents) { %>
            <span style="font-weight: 400; opacity: 0.7;">(<%= pagination.totalStudents %> total)</span>
            <% } %>
          </h3>
          <div class="table-actions">
            <button class="btn btn-primary" onclick="exportVisible()">
              <i class="fas fa-file-excel"></i>
              Export Visible Students
            </button>
          </div>
        </div>

        <!-- Bulk Actions Toolbar -->
        <div class="bulk-actions-toolbar" id="bulkActionsToolbar">
          <div class="bulk-actions-info">
            <i class="fas fa-check-circle"></i>
            <span id="selectedCount">0</span> student(s) selected
          </div>
          <div class="bulk-actions-buttons">
            <button class="bulk-action-btn activate" onclick="bulkActivateStudents()" id="bulkActivateBtn">
              <i class="fas fa-check"></i>
              Activate Selected
            </button>
            <button class="bulk-action-btn deactivate" onclick="bulkDeactivateStudents()" id="bulkDeactivateBtn">
              <i class="fas fa-ban"></i>
              Deactivate Selected
            </button>
            <button class="bulk-action-btn activate" onclick="bulkMarkParentPhoneChecked()" id="bulkParentPhoneBtn">
              <i class="fas fa-phone"></i>
              Mark Parent Phone Checked
            </button>
            <button class="bulk-action-btn" onclick="clearSelection()">
              <i class="fas fa-times"></i>
              Clear Selection
            </button>
          </div>
        </div>

        <div class="table-overflow">
          <% if (students && students.length > 0) { %>
          <table class="students-table">
            <thead>
              <tr>
                <th class="checkbox-cell">
                  <input type="checkbox" class="select-all-checkbox" id="selectAllCheckbox" onchange="toggleSelectAll(this)">
                </th>
                <th>Student</th>
                <th>Status</th>
                <th>Parent Phone</th>
                <th>Student Code</th>
                <th>Grade</th>
                <th>Courses</th>
                <th>Progress</th>
                <th>Enrolled</th>
                <th>Last Activity</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <% students.forEach(student => { %>
              <tr data-student-id="<%= student._id %>" data-student-active="<%= student.isActive !== false %>">
                <td class="checkbox-cell">
                  <input type="checkbox" class="student-checkbox" value="<%= student._id %>" onchange="updateBulkActions()">
                </td>
                <td>
                  <div class="student-profile">
                    <div class="student-avatar">
                      <%= (student.firstName?.[0] || '').toUpperCase() %><%= (student.lastName?.[0] || '').toUpperCase() %>
                    </div>
                    <div class="student-info">
                      <div class="student-name" title="<%= student.firstName %> <%= student.lastName %>">
                        <%= student.firstName %> <%= student.lastName %>
                      </div>
                      <div class="student-email">
                        <%= student.studentEmail %>
                      </div>
                    </div>
                  </div>
                </td>
                <td>
                  <span class="status-badge-table <%= student.isActive !== false ? 'active' : 'inactive' %>">
                    <span class="status-icon-table"></span>
                    <%= student.isActive !== false ? 'Active' : 'Inactive' %>
                  </span>
                </td>
                <td>
                  <span class="status-badge-table <%= student.isParentPhoneChecked ? 'active' : 'inactive' %> clickable-badge" 
                        data-student-id="<%= student._id %>"
                        data-current-status="<%= student.isParentPhoneChecked %>"
                        onclick="toggleParentPhoneStatus(this)"
                        title="Click to toggle parent phone verification status"
                        style="cursor: pointer;">
                    <span class="status-icon-table"></span>
                    <%= student.isParentPhoneChecked ? 'Verified' : 'Not Verified' %>
                  </span>
                </td>
                <td>
                  <div class="student-code-cell">
                    <span class="code-badge">
                      <i class="fas fa-hashtag"></i>
                      <%= student.studentCode || 'N/A' %>
                    </span>
                  </div>
                </td>
                <td>
                  <span class="grade-badge">
                    <%= student.grade %>
                  </span>
                </td>
                <td>
                  <div class="courses-cell">
                    <div class="courses-count">
                      <%= student.analytics?.totalCourses || 0 %>
                    </div>
                    <div class="courses-active">
                      <%= student.analytics?.activeCourses || 0 %> active
                    </div>
                  </div>
                </td>
                <td>
                  <div class="progress-bar-container">
                    <div class="progress-percentage">
                      <%= (student.analytics?.overallProgress || 0) %>%
                    </div>
                    <div class="progress-bar">
                      <div class="progress-fill" data-width="<%= (student.analytics?.overallProgress || 0) %>"></div>
                    </div>
                  </div>
                </td>
                <td>
                  <div class="date-cell">
                    <div class="date-main">
                      <%= new Date(student.createdAt).toLocaleDateString() %>
                    </div>
                    <div class="date-sub">
                      <%= student.analytics?.daysSinceEnrollment || 0 %> days ago
                    </div>
                  </div>
                </td>
                <td>
                  <div class="activity-cell">
                    <% if (student.analytics?.daysSinceLastActivity !== null) { %>
                    <div class="activity-time">
                      <%= student.analytics.daysSinceLastActivity %> days ago
                    </div>
                    <div class="activity-indicator <%= student.analytics.daysSinceLastActivity <= 7 ? 'active' : student.analytics.daysSinceLastActivity <= 30 ? 'moderate' : 'inactive' %>"></div>
                    <% } else { %>
                    <span class="no-activity">Never</span>
                    <% } %>
                  </div>
                </td>
                <td>
                  <div class="student-actions">
                    <a href="/admin/students/<%= student._id %>" class="action-btn-sm view" title="View Details">
                      <i class="fas fa-eye"></i>
                    </a>
                    <button class="action-btn-sm edit" onclick="window.location.href='/admin/students/<%= student._id %>/edit'" title="Edit Student">
                      <i class="fas fa-edit"></i>
                    </button>
                    <button class="action-btn-sm delete" onclick="confirmDeleteStudent('<%= student._id %>', '<%= student.firstName %> <%= student.lastName %>')" title="Delete Student">
                      <i class="fas fa-trash"></i>
                    </button>
                  </div>
                </td>
              </tr>
              <% }) %>
            </tbody>
          </table>
          <% } else { %>
          <div class="empty-state">
            <i class="fas fa-user-graduate"></i>
            <h3>No Students Found</h3>
            <p>
              <% if (currentFilters?.search || currentFilters?.status !== 'all') { %>
              No students match your current filters. Try adjusting your search criteria.
              <% } else { %>
              No students have been registered yet. Students will appear here once they sign up.
              <% } %>
            </p>
          </div>
          <% } %>
        </div>

        <!-- Pagination -->
        <% if (pagination && pagination.totalPages > 1) { %>
        <%
          // Helper function to build query string for pagination
          const buildQueryString = (filters) => {
            if (!filters) return '';
            const params = new URLSearchParams();
            Object.keys(filters).forEach(key => {
              if (filters[key] && filters[key] !== 'all' && key !== 'page') {
                params.append(key, filters[key]);
              }
            });
            return params.toString() ? '&' + params.toString() : '';
          };
        %>
        <div class="pagination-container">
          <div class="pagination-info">
            Showing <%= ((pagination.currentPage - 1) * pagination.limit) + 1 %>-<%= Math.min(pagination.currentPage * pagination.limit, pagination.totalStudents) %>
            of <%= pagination.totalStudents %> students
          </div>
          <div class="pagination">
            <% if (pagination.hasPrev) { %>
            <a href="?page=<%= pagination.currentPage - 1 %><%= buildQueryString(currentFilters) %>" class="pagination-btn">
              <i class="fas fa-chevron-left"></i>
            </a>
            <% } %>

            <% 
                                const startPage = Math.max(1, pagination.currentPage - 2);
                                const endPage = Math.min(pagination.totalPages, pagination.currentPage + 2);
                            %>

            <% if (startPage > 1) { %>
            <a href="?page=1<%= buildQueryString(currentFilters) %>" class="pagination-btn">1</a>
            <% if (startPage > 2) { %>
            <span class="pagination-btn" style="cursor: default;">...</span>
            <% } %>
            <% } %>

            <% for (let i = startPage; i <= endPage; i++) { %>
            <a href="?page=<%= i %><%= buildQueryString(currentFilters) %>" class="pagination-btn <%= i === pagination.currentPage ? 'active' : '' %>">
              <%= i %>
            </a>
            <% } %>

            <% if (endPage < pagination.totalPages) { %>
            <% if (endPage < pagination.totalPages - 1) { %>
            <span class="pagination-btn" style="cursor: default;">...</span>
            <% } %>
            <a href="?page=<%= pagination.totalPages %><%= buildQueryString(currentFilters) %>" class="pagination-btn"><%= pagination.totalPages %></a>
            <% } %>

            <% if (pagination.hasNext) { %>
            <a href="?page=<%= pagination.currentPage + 1 %><%= buildQueryString(currentFilters) %>" class="pagination-btn">
              <i class="fas fa-chevron-right"></i>
            </a>
            <% } %>
          </div>
        </div>
        <% } %>
      </div>
    </div>
  </div>

  <%- include('partials/admin-footer') %>

  <!-- Bulk Import Modal -->
  <div id="bulkImportModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 10000; align-items: center; justify-content: center;">
    <div style="background: white; padding: 30px; border-radius: 12px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h3 style="margin: 0; color: #1e293b;">Bulk Import Students</h3>
        <button onclick="closeBulkImportModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #6b7280;">&times;</button>
      </div>
      
      <div style="margin-bottom: 20px; padding: 15px; background: #f0f9ff; border-left: 4px solid #3b82f6; border-radius: 4px;">
        <h4 style="margin: 0 0 10px 0; color: #1e40af; font-size: 14px;">ðŸ“‹ Excel Format Requirements:</h4>
        <ul style="margin: 0; padding-left: 20px; color: #1e40af; font-size: 13px;">
          <li><strong>Student Name</strong> - Full name of the student</li>
          <li><strong>Student Phone Number</strong> - Phone number with country code (e.g., +966XXXXXXXXX)</li>
          <li><strong>Parent Phone Number</strong> - Parent's phone with country code</li>
          <li><strong>Student Code</strong> - Unique student code</li>
        </ul>
      </div>

      <div style="margin-bottom: 16px; display: flex; justify-content: flex-end;">
        <a href="/admin/students/bulk-import/sample"
           style="padding: 10px 16px; background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; border-radius: 8px; text-decoration: none; font-weight: 600; box-shadow: 0 10px 15px -3px rgba(37, 99, 235, 0.3); display: inline-flex; align-items: center; gap: 8px;">
          <i class="fas fa-download"></i>
          Download Sample (4 students)
        </a>
      </div>

      <form id="bulkImportForm" enctype="multipart/form-data">
        <div style="margin-bottom: 20px;">
          <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Select Excel File:</label>
          <input type="file" name="excelFile" id="excelFile" accept=".xlsx,.xls" required 
                 style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
          <p style="margin: 8px 0 0 0; font-size: 12px; color: #6b7280;">Only .xlsx or .xls files are allowed</p>
        </div>

        <div style="display: flex; gap: 10px; justify-content: flex-end;">
          <button type="button" onclick="closeBulkImportModal()" 
                  style="padding: 10px 20px; background: #e5e7eb; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; color: #374151;">
            Cancel
          </button>
          <button type="submit" id="importSubmitBtn"
                  style="padding: 10px 20px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); border: none; border-radius: 8px; cursor: pointer; font-weight: 600; color: white;">
            <i class="fas fa-upload"></i> Import Students
          </button>
        </div>
      </form>

      <div id="importResults" style="display: none; margin-top: 20px; padding: 15px; border-radius: 8px;"></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
  <script>
    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
      try {
        // Initialize sidebar toggle
        initializeSidebarToggle();

        // Animate progress bars
        animateProgressBars();

        // Initialize real-time search
        initializeRealTimeSearch();

        // Initialize tooltips
        initializeTooltips();
      } catch (error) {
        console.error('Error initializing page:', error);
      }
    });

    // Toggle advanced filters
    function toggleAdvancedFilters() {
      const advancedFilters = document.getElementById('advancedFilters');
      const toggle = document.querySelector('.filters-toggle');

      if (advancedFilters && toggle) {
        if (advancedFilters.classList.contains('show')) {
          advancedFilters.classList.remove('show');
          toggle.innerHTML = '<i class="fas fa-cog"></i> Advanced';
        } else {
          advancedFilters.classList.add('show');
          toggle.innerHTML = '<i class="fas fa-times"></i> Hide Advanced';
        }
      }
    }

    // Clear all filters
    function clearFilters() {
      const form = document.getElementById('filtersForm');
      if (!form) return;
      
      const inputs = form.querySelectorAll('input, select');

      inputs.forEach(input => {
        if (input.type === 'text' || input.type === 'date') {
          input.value = '';
        } else if (input.tagName === 'SELECT') {
          input.selectedIndex = 0;
        }
      });

      form.submit();
    }

    // Set status filter
    function setStatusFilter(status) {
      const statusInput = document.getElementById('statusInput');
      const buttons = document.querySelectorAll('.status-filter-btn');
      const form = document.getElementById('filtersForm');
      
      if (!statusInput || !form) return;
      
      // Update hidden input
      statusInput.value = status;
      
      // Update button states
      buttons.forEach(btn => btn.classList.remove('active'));
      if (event && event.target) {
        const targetBtn = event.target.closest('.status-filter-btn');
        if (targetBtn) {
          targetBtn.classList.add('active');
        }
      }
      
      // Submit form
      form.submit();
    }

    // Export students with comprehensive data
    function exportStudents() {
      try {
        const currentUrl = new URL(window.location);
        currentUrl.pathname = '/admin/students/export';
        currentUrl.searchParams.set('format', 'excel');
        currentUrl.searchParams.set('comprehensive', 'true');
        currentUrl.searchParams.set('includeAnalytics', 'true');

        // Show loading state
        const exportBtn = document.querySelector('.btn-export');
        if (exportBtn) {
          const originalText = exportBtn.innerHTML;
          exportBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Exporting...';
          exportBtn.disabled = true;

          // Reset button after a delay
          setTimeout(() => {
            exportBtn.innerHTML = originalText;
            exportBtn.disabled = false;
          }, 3000);
        }

        // Create a temporary link to trigger download
        const link = document.createElement('a');
        link.href = currentUrl.toString();
        link.download = `students_comprehensive_report_${new Date().toISOString().split('T')[0]}.xlsx`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      } catch (error) {
        console.error('Error exporting students:', error);
        // Reset button on error
        const exportBtn = document.querySelector('.btn-export');
        if (exportBtn) {
          exportBtn.innerHTML = '<i class="fas fa-file-excel"></i> Export Excel Report';
          exportBtn.disabled = false;
        }
      }
    }

    // Export visible students
    function exportVisible() {
      try {
        // Show loading state
        const exportBtn = document.querySelector('.table-actions .btn');
        if (exportBtn) {
          const originalText = exportBtn.innerHTML;
          exportBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Exporting...';
          exportBtn.disabled = true;

          // Reset button after a delay
          setTimeout(() => {
            exportBtn.innerHTML = originalText;
            exportBtn.disabled = false;
          }, 3000);
        }

        const currentUrl = new URL(window.location);
        const filters = Object.fromEntries(currentUrl.searchParams);

        const exportUrl = new URL('/admin/students/export', window.location.origin);
        exportUrl.searchParams.set('format', 'excel');
        exportUrl.searchParams.set('filters', JSON.stringify(filters));

        // Create a temporary link to trigger download
        const link = document.createElement('a');
        link.href = exportUrl.toString();
        link.download = `students_filtered_report_${new Date().toISOString().split('T')[0]}.xlsx`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      } catch (error) {
        console.error('Error exporting visible students:', error);
        
        // Reset button on error
        const exportBtn = document.querySelector('.table-actions .btn');
        if (exportBtn) {
          exportBtn.innerHTML = '<i class="fas fa-file-excel"></i> Export Excel Report';
          exportBtn.disabled = false;
        }
      }
    }

    // Show delete confirmation dialog
    function confirmDeleteStudent(studentId, studentName) {
      if (confirm(`Are you sure you want to delete "${studentName}"?\n\nThis action cannot be undone and will permanently remove all student data, progress, and enrollment records.`)) {
        deleteStudent(studentId, studentName);
      }
    }

    // Delete student
    async function deleteStudent(studentId, studentName) {
      try {
        const response = await fetch(`/admin/students/${studentId}`, {
          method: 'DELETE',
          headers: {
            'Content-Type': 'application/json',
          }
        });

        const data = await response.json();

        if (data.success) {
          alert(`âœ“ ${studentName} has been successfully deleted from the system.`);
          // Reload page to show updated student list
          location.reload();
        } else {
          alert(`âœ— Failed to delete student: ${data.message || 'Unknown error occurred'}`);
        }
      } catch (error) {
        console.error('Error:', error);
        alert('âœ— Network error occurred while deleting student. Please try again.');
      }
    }

    // Animate progress bars
    function animateProgressBars() {
      const progressBars = document.querySelectorAll('.progress-fill');
      progressBars.forEach((bar, index) => {
        const widthValue = bar.getAttribute('data-width') || '0';
        const width = widthValue + '%';
        bar.style.width = '0%';
        setTimeout(() => {
          bar.style.width = width;
        }, index * 100);
      });
    }

    // Initialize real-time search
    function initializeRealTimeSearch() {
      const searchInput = document.querySelector('input[name="search"]');
      const filtersForm = document.getElementById('filtersForm');
      let searchTimeout;

      if (searchInput && filtersForm) {
        searchInput.addEventListener('input', function() {
          clearTimeout(searchTimeout);
          searchTimeout = setTimeout(() => {
            filtersForm.submit();
          }, 500);
        });
      }
    }

    // Initialize tooltips
    function initializeTooltips() {
      try {
        // Add tooltips to action buttons
        const actionButtons = document.querySelectorAll('.action-btn-sm');
        actionButtons.forEach(button => {
          if (button) {
            button.addEventListener('mouseenter', function() {
              // Simple tooltip implementation
              const title = this.getAttribute('title');
              if (title) {
                const tooltip = document.createElement('div');
                if (tooltip) {
                  tooltip.className = 'tooltip';
                  tooltip.textContent = title;
                  tooltip.style.cssText = `
                                    position: absolute;
                                    background: rgba(0,0,0,0.8);
                                    color: white;
                                    padding: 4px 8px;
                                    border-radius: 4px;
                                    font-size: 0.75rem;
                                    z-index: 1000;
                                    pointer-events: none;
                                `;
                  document.body.appendChild(tooltip);

                  const rect = this.getBoundingClientRect();
                  tooltip.style.left = rect.left + (rect.width / 2) - (tooltip.offsetWidth / 2) + 'px';
                  tooltip.style.top = rect.top - tooltip.offsetHeight - 5 + 'px';

                  this._tooltip = tooltip;
                }
              }
            });

            button.addEventListener('mouseleave', function() {
              if (this._tooltip && this._tooltip.parentNode) {
                document.body.removeChild(this._tooltip);
                this._tooltip = null;
              }
            });
          }
        });
      } catch (error) {
        console.error('Error initializing tooltips:', error);
      }
    }

    // Helper function to build query string for pagination
    function buildQueryString(filters) {
      if (!filters) return '';

      const params = new URLSearchParams();
      Object.keys(filters).forEach(key => {
        if (filters[key] && filters[key] !== 'all' && key !== 'page') {
          params.append(key, filters[key]);
        }
      });

      return params.toString() ? '&' + params.toString() : '';
    }

    // Initialize sidebar toggle functionality
    function initializeSidebarToggle() {
      const sidebarToggle = document.getElementById('sidebarToggle');
      const mainContent = document.querySelector('.admin-main-content');
      const sidebar = document.querySelector('.admin-sidebar');
      
      if (sidebarToggle && mainContent && sidebar) {
        sidebarToggle.addEventListener('click', function() {
          // Toggle sidebar visibility
          sidebar.classList.toggle('sidebar-hidden');
          
          // Adjust main content margin
          if (sidebar.classList.contains('sidebar-hidden')) {
            mainContent.style.marginLeft = '0';
          } else {
            mainContent.style.marginLeft = '280px';
          }
        });
        
        // Handle window resize
        window.addEventListener('resize', function() {
          if (window.innerWidth <= 1024) {
            sidebar.classList.add('sidebar-hidden');
            mainContent.style.marginLeft = '0';
          } else {
            sidebar.classList.remove('sidebar-hidden');
            mainContent.style.marginLeft = '280px';
          }
        });
        
        // Initialize based on screen size
        if (window.innerWidth <= 1024) {
          sidebar.classList.add('sidebar-hidden');
          mainContent.style.marginLeft = '0';
        }
      }
    }

    // Theme toggle functionality is handled by admin-footer.ejs

    // Bulk Import Functions
    function showBulkImportModal() {
      const modal = document.getElementById('bulkImportModal');
      if (modal) {
        modal.style.display = 'flex';
      }
    }

    function closeBulkImportModal() {
      const modal = document.getElementById('bulkImportModal');
      if (modal) {
        modal.style.display = 'none';
        // Reset form
        document.getElementById('bulkImportForm').reset();
        document.getElementById('importResults').style.display = 'none';
        document.getElementById('importResults').innerHTML = '';
      }
    }

    // Handle bulk import form submission
    document.getElementById('bulkImportForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const formData = new FormData(this);
      const submitBtn = document.getElementById('importSubmitBtn');
      const originalBtnText = submitBtn.innerHTML;
      const resultsDiv = document.getElementById('importResults');
      
      // Show loading state
      submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Importing...';
      submitBtn.disabled = true;
      resultsDiv.style.display = 'none';
      
      try {
        const response = await fetch('/admin/students/bulk-import', {
          method: 'POST',
          body: formData
        });
        
        const data = await response.json();
        
        // Display results
        resultsDiv.style.display = 'block';
        
        if (data.success) {
          resultsDiv.style.background = '#d1fae5';
          resultsDiv.style.border = '1px solid #10b981';
          resultsDiv.innerHTML = `
            <h4 style="margin: 0 0 10px 0; color: #065f46;">âœ“ Import Successful</h4>
            <p style="margin: 0 0 10px 0; color: #065f46;">${data.message}</p>
            <div style="margin-top: 15px;">
              <p style="margin: 5px 0; color: #065f46;"><strong>Successful:</strong> ${data.results.success.length}</p>
              <p style="margin: 5px 0; color: #991b1b;"><strong>Failed:</strong> ${data.results.failed.length}</p>
              <p style="margin: 5px 0; color: #1e40af;"><strong>Total:</strong> ${data.results.total}</p>
            </div>
            ${data.results.failed.length > 0 ? `
              <details style="margin-top: 10px;">
                <summary style="cursor: pointer; color: #991b1b; font-weight: 600;">View Failed Imports</summary>
                <ul style="margin: 10px 0 0 20px; color: #991b1b;">
                  ${data.results.failed.map(f => `<li>Row ${f.row}: ${f.studentName} - ${f.reason}</li>`).join('')}
                </ul>
              </details>
            ` : ''}
            <button onclick="location.reload()" style="margin-top: 15px; padding: 8px 16px; background: #10b981; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
              Refresh Page
            </button>
          `;
        } else {
          resultsDiv.style.background = '#fee2e2';
          resultsDiv.style.border = '1px solid #ef4444';
          resultsDiv.innerHTML = `
            <h4 style="margin: 0 0 10px 0; color: #991b1b;">âœ— Import Failed</h4>
            <p style="margin: 0; color: #991b1b;">${data.message}</p>
          `;
        }
      } catch (error) {
        console.error('Import error:', error);
        resultsDiv.style.display = 'block';
        resultsDiv.style.background = '#fee2e2';
        resultsDiv.style.border = '1px solid #ef4444';
        resultsDiv.innerHTML = `
          <h4 style="margin: 0 0 10px 0; color: #991b1b;">âœ— Import Failed</h4>
          <p style="margin: 0; color: #991b1b;">An error occurred during import. Please try again.</p>
        `;
      } finally {
        // Reset button
        submitBtn.innerHTML = originalBtnText;
        submitBtn.disabled = false;
      }
    });

    // Close modal when clicking outside
    document.getElementById('bulkImportModal').addEventListener('click', function(e) {
      if (e.target === this) {
        closeBulkImportModal();
      }
    });

    // ==================== BULK ACTIONS FUNCTIONALITY ====================
    
    // Toggle select all checkbox
    function toggleSelectAll(checkbox) {
      const studentCheckboxes = document.querySelectorAll('.student-checkbox');
      studentCheckboxes.forEach(cb => {
        cb.checked = checkbox.checked;
      });
      updateBulkActions();
    }

    // Update bulk actions toolbar visibility and button states
    function updateBulkActions() {
      const selectedCheckboxes = document.querySelectorAll('.student-checkbox:checked');
      const selectedCount = selectedCheckboxes.length;
      const toolbar = document.getElementById('bulkActionsToolbar');
      const selectedCountSpan = document.getElementById('selectedCount');
      const bulkActivateBtn = document.getElementById('bulkActivateBtn');
      const bulkDeactivateBtn = document.getElementById('bulkDeactivateBtn');

      if (selectedCountSpan) {
        selectedCountSpan.textContent = selectedCount;
      }

      if (toolbar) {
        if (selectedCount > 0) {
          toolbar.classList.add('show');
        } else {
          toolbar.classList.remove('show');
        }
      }

      // Update button states based on selected students' current status
      if (selectedCount > 0) {
        let allActive = true;
        let allInactive = true;

        selectedCheckboxes.forEach(checkbox => {
          const row = checkbox.closest('tr');
          const isActive = row.getAttribute('data-student-active') === 'true';
          
          if (isActive) {
            allInactive = false;
          } else {
            allActive = false;
          }
        });

        // Enable/disable buttons based on selection
        if (bulkActivateBtn) {
          bulkActivateBtn.disabled = allActive;
        }
        if (bulkDeactivateBtn) {
          bulkDeactivateBtn.disabled = allInactive;
        }
      } else {
        if (bulkActivateBtn) bulkActivateBtn.disabled = false;
        if (bulkDeactivateBtn) bulkDeactivateBtn.disabled = false;
      }

      // Update select all checkbox state
      const selectAllCheckbox = document.getElementById('selectAllCheckbox');
      if (selectAllCheckbox) {
        const totalCheckboxes = document.querySelectorAll('.student-checkbox').length;
        selectAllCheckbox.checked = selectedCount === totalCheckboxes && totalCheckboxes > 0;
        selectAllCheckbox.indeterminate = selectedCount > 0 && selectedCount < totalCheckboxes;
      }
    }

    // Clear all selections
    function clearSelection() {
      const checkboxes = document.querySelectorAll('.student-checkbox, .select-all-checkbox');
      checkboxes.forEach(cb => {
        cb.checked = false;
      });
      const selectAllCheckbox = document.getElementById('selectAllCheckbox');
      if (selectAllCheckbox) {
        selectAllCheckbox.indeterminate = false;
      }
      updateBulkActions();
    }

    // Get selected student IDs
    function getSelectedStudentIds() {
      const selectedCheckboxes = document.querySelectorAll('.student-checkbox:checked');
      return Array.from(selectedCheckboxes).map(cb => cb.value);
    }

    // Bulk activate students
    async function bulkActivateStudents() {
      const selectedIds = getSelectedStudentIds();
      
      if (selectedIds.length === 0) {
        alert('Please select at least one student to activate.');
        return;
      }

      if (!confirm(`Are you sure you want to activate ${selectedIds.length} student(s)?\n\nThis will allow them to log in and access their courses.`)) {
        return;
      }

      const bulkActivateBtn = document.getElementById('bulkActivateBtn');
      const originalText = bulkActivateBtn ? bulkActivateBtn.innerHTML : '';
      
      if (bulkActivateBtn) {
        bulkActivateBtn.disabled = true;
        bulkActivateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Activating...';
      }

      try {
        const response = await fetch('/admin/students/bulk-status', {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            studentIds: selectedIds,
            isActive: true
          })
        });

        const data = await response.json();

        if (data.success) {
          // Show success message
          showToast('success', 'Success', `Successfully activated ${data.modifiedCount} student(s).`);
          
          // Reload page after a short delay to show updated status
          setTimeout(() => {
            location.reload();
          }, 1500);
        } else {
          showToast('error', 'Error', data.message || 'Failed to activate students. Please try again.');
          if (bulkActivateBtn) {
            bulkActivateBtn.disabled = false;
            bulkActivateBtn.innerHTML = originalText;
          }
        }
      } catch (error) {
        console.error('Error activating students:', error);
        showToast('error', 'Error', 'Network error occurred. Please try again.');
        if (bulkActivateBtn) {
          bulkActivateBtn.disabled = false;
          bulkActivateBtn.innerHTML = originalText;
        }
      }
    }

    // Bulk deactivate students
    async function bulkDeactivateStudents() {
      const selectedIds = getSelectedStudentIds();
      
      if (selectedIds.length === 0) {
        alert('Please select at least one student to deactivate.');
        return;
      }

      if (!confirm(`Are you sure you want to deactivate ${selectedIds.length} student(s)?\n\nThis will prevent them from logging in and accessing their courses.`)) {
        return;
      }

      const bulkDeactivateBtn = document.getElementById('bulkDeactivateBtn');
      const originalText = bulkDeactivateBtn ? bulkDeactivateBtn.innerHTML : '';
      
      if (bulkDeactivateBtn) {
        bulkDeactivateBtn.disabled = true;
        bulkDeactivateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Deactivating...';
      }

      try {
        const response = await fetch('/admin/students/bulk-status', {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            studentIds: selectedIds,
            isActive: false
          })
        });

        const data = await response.json();

        if (data.success) {
          // Show success message
          showToast('success', 'Success', `Successfully deactivated ${data.modifiedCount} student(s).`);
          
          // Reload page after a short delay to show updated status
          setTimeout(() => {
            location.reload();
          }, 1500);
        } else {
          showToast('error', 'Error', data.message || 'Failed to deactivate students. Please try again.');
          if (bulkDeactivateBtn) {
            bulkDeactivateBtn.disabled = false;
            bulkDeactivateBtn.innerHTML = originalText;
          }
        }
      } catch (error) {
        console.error('Error deactivating students:', error);
        showToast('error', 'Error', 'Network error occurred. Please try again.');
        if (bulkDeactivateBtn) {
          bulkDeactivateBtn.disabled = false;
          bulkDeactivateBtn.innerHTML = originalText;
        }
      }
    }

    // Toggle individual parent phone status
    async function toggleParentPhoneStatus(badgeElement) {
      const studentId = badgeElement.getAttribute('data-student-id');
      const currentStatus = badgeElement.getAttribute('data-current-status') === 'true';
      const newStatus = !currentStatus;
      const originalContent = badgeElement.innerHTML;
      
      // Show loading state
      badgeElement.style.opacity = '0.6';
      badgeElement.style.pointerEvents = 'none';
      badgeElement.innerHTML = '<span class="status-icon-table"></span> Updating...';

      try {
        const response = await fetch(`/admin/students/${studentId}/parent-phone-status`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            isParentPhoneChecked: newStatus,
          }),
        });

        const data = await response.json();

        if (data.success) {
          showToast('success', 'Success', `Parent phone status ${newStatus ? 'verified' : 'unverified'} successfully.`);
          
          // Update badge immediately
          badgeElement.className = `status-badge-table ${newStatus ? 'active' : 'inactive'} clickable-badge`;
          badgeElement.setAttribute('data-current-status', newStatus.toString());
          badgeElement.innerHTML = `<span class="status-icon-table"></span>${newStatus ? 'Verified' : 'Not Verified'}`;
          badgeElement.style.opacity = '1';
          badgeElement.style.pointerEvents = 'auto';
        } else {
          showToast('error', 'Error', data.message || 'Failed to update parent phone status. Please try again.');
          badgeElement.innerHTML = originalContent;
          badgeElement.style.opacity = '1';
          badgeElement.style.pointerEvents = 'auto';
        }
      } catch (error) {
        console.error('Error toggling parent phone status:', error);
        showToast('error', 'Error', 'Network error occurred. Please try again.');
        badgeElement.innerHTML = originalContent;
        badgeElement.style.opacity = '1';
        badgeElement.style.pointerEvents = 'auto';
      }
    }

    // Bulk mark parent phone as checked
    async function bulkMarkParentPhoneChecked() {
      const selectedIds = getSelectedStudentIds();
      
      if (selectedIds.length === 0) {
        alert('Please select at least one student to update.');
        return;
      }

      if (!confirm(`Are you sure you want to mark the parent phone as verified for ${selectedIds.length} student(s)?`)) {
        return;
      }

      const bulkParentPhoneBtn = document.getElementById('bulkParentPhoneBtn');
      const originalText = bulkParentPhoneBtn ? bulkParentPhoneBtn.innerHTML : '';
      
      if (bulkParentPhoneBtn) {
        bulkParentPhoneBtn.disabled = true;
        bulkParentPhoneBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Updating...';
      }

      try {
        const response = await fetch('/admin/students/bulk-status', {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            studentIds: selectedIds,
            isParentPhoneChecked: true,
          }),
        });

        const data = await response.json();

        if (data.success) {
          showToast('success', 'Success', `Successfully updated ${data.modifiedCount} student(s).`);
          setTimeout(() => {
            location.reload();
          }, 1500);
        } else {
          showToast('error', 'Error', data.message || 'Failed to update students. Please try again.');
          if (bulkParentPhoneBtn) {
            bulkParentPhoneBtn.disabled = false;
            bulkParentPhoneBtn.innerHTML = originalText;
          }
        }
      } catch (error) {
        console.error('Error updating parent phone status:', error);
        showToast('error', 'Error', 'Network error occurred. Please try again.');
        if (bulkParentPhoneBtn) {
          bulkParentPhoneBtn.disabled = false;
          bulkParentPhoneBtn.innerHTML = originalText;
        }
      }
    }

    // Toast notification function
    function showToast(type, title, message) {
      // Create toast container if it doesn't exist
      let toastContainer = document.querySelector('.toast-container');
      if (!toastContainer) {
        toastContainer = document.createElement('div');
        toastContainer.className = 'toast-container';
        document.body.appendChild(toastContainer);
      }

      // Create toast element
      const toast = document.createElement('div');
      toast.className = `toast show`;
      
      const iconClass = type === 'success' ? 'success' : type === 'error' ? 'error' : 'warning';
      const icon = type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-exclamation-triangle';

      toast.innerHTML = `
        <div class="toast-header">
          <div class="toast-icon ${iconClass}">
            <i class="fas ${icon}"></i>
          </div>
          <h4 class="toast-title">${title}</h4>
        </div>
        <p class="toast-message">${message}</p>
      `;

      toastContainer.appendChild(toast);

      // Remove toast after 5 seconds
      setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => {
          if (toast.parentNode) {
            toast.parentNode.removeChild(toast);
          }
        }, 300);
      }, 5000);
    }

    // Initialize bulk actions on page load
    document.addEventListener('DOMContentLoaded', function() {
      updateBulkActions();
    });
  </script>

  <!-- Essential JavaScript Libraries -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>

</body>

</html>