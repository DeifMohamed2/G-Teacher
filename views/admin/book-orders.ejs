<%- include('./partials/admin-header', { title, user, theme, currentPage: 'book-orders', pageCSS: 'orders' }) %>

<!-- Admin Layout -->
<div class="admin-layout">

  <!-- Sidebar -->
  <%- include('./partials/admin-sidebar', { currentPage: 'book-orders' }) %>

  <!-- Main Content -->
  <main class="admin-main">

    <!-- Top Bar -->
    <%- include('./partials/admin-topbar', { 
        breadcrumb: 'Book Orders',
        breadcrumbSubtitle: 'Manage physical book orders and shipping',
        showSearch: false
    }) %>

    <!-- Content Area -->
    <div class="admin-content">
      <div class="admin-orders-container">
        <!-- Orders Header -->
        <div class="admin-orders-header d-flex align-items-center justify-content-between mb-4">
          <div>
            <h1 class="mb-0" style="color: var(--admin-text-light); font-weight: 700; font-size: 2rem;">Book Orders Management</h1>
            <p class="text-muted" style="color: #64748b; font-size: 14px; margin-top: 8px;">Track and manage all physical book orders and shipping</p>
          </div>
          <div class="admin-header-actions d-flex gap-2">
            <div id="bulkActionsContainer" style="display: none;">
              <div class="d-flex align-items-center gap-2" style="background: rgba(var(--admin-primary-rgb), 0.1); padding: 8px 16px; border-radius: 12px; border: 2px solid var(--admin-primary);">
                <span id="selectedCount" style="color: var(--admin-primary); font-weight: 700; font-size: 14px;">0 selected</span>
                <div class="dropdown">
                  <button class="btn btn-sm btn-primary dropdown-toggle" type="button" id="bulkStatusDropdown" data-bs-toggle="dropdown" aria-expanded="false" style="padding: 8px 16px; border-radius: 8px; font-weight: 600; font-size: 13px;">
                    Update Status
                  </button>
                  <ul class="dropdown-menu" aria-labelledby="bulkStatusDropdown">
                    <li><a class="dropdown-item" href="#" onclick="bulkUpdateStatus('pending'); return false;"><i class="fas fa-clock me-2"></i>Pending</a></li>
                    <li><a class="dropdown-item" href="#" onclick="bulkUpdateStatus('processing'); return false;"><i class="fas fa-cog me-2"></i>Processing</a></li>
                    <li><a class="dropdown-item" href="#" onclick="bulkUpdateStatus('shipped'); return false;"><i class="fas fa-truck me-2"></i>Shipped</a></li>
                    <li><a class="dropdown-item" href="#" onclick="bulkUpdateStatus('delivered'); return false;"><i class="fas fa-check-circle me-2"></i>Delivered</a></li>
                  </ul>
                </div>
                <button onclick="clearSelection()" class="btn btn-sm btn-outline-secondary" style="padding: 8px 16px; border-radius: 8px; font-weight: 600; font-size: 13px;">
                  <i class="fas fa-times me-1"></i>Clear
                </button>
              </div>
            </div>
            <button onclick="exportBookOrdersToExcel()" class="btn btn-success" style="padding: 12px 24px; border-radius: 12px; font-weight: 600; font-size: 14px; display: inline-flex; align-items: center; gap: 8px; transition: all 0.3s ease; background: #28a745; border-color: #28a745; color: white;">
              <i class="fas fa-file-excel"></i>
              Export to Excel
            </button>
          </div>
        </div>

        <!-- Analytics Cards -->
        <style>
          .orders-kpi .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1) !important;
          }
          .order-number-link:hover {
            text-decoration: underline;
            opacity: 0.8;
          }
          .order-action-button:hover {
            background: var(--admin-primary) !important;
            color: white !important;
            transform: scale(1.05);
          }
          .order-checkbox {
            accent-color: var(--admin-primary);
          }
          tbody tr[data-order-id] {
            transition: all 0.3s ease;
          }
          tbody tr.selected-row {
            background-color: rgba(var(--admin-primary-rgb), 0.05) !important;
            border-left: 3px solid var(--admin-primary);
          }
          tbody tr.selected-row:hover {
            background-color: rgba(var(--admin-primary-rgb), 0.1) !important;
          }
          #bulkActionsContainer {
            animation: slideDown 0.3s ease;
          }
          @keyframes slideDown {
            from {
              opacity: 0;
              transform: translateY(-10px);
            }
            to {
              opacity: 1;
              transform: translateY(0);
            }
          }
        </style>
        <div class="row g-4 mb-4 orders-kpi">
          <div class="col-12 col-lg-3">
            <div class="card shadow-sm h-100" style="border-radius: 16px; border: 1px solid rgba(0, 0, 0, 0.05); transition: all 0.3s ease;">
              <div class="card-body" style="padding: 24px;">
                <div class="d-flex align-items-center">
                  <div class="summary-icon" style="background-color: rgba(var(--admin-primary-rgb), 0.1); color: var(--admin-primary); width: 56px; height: 56px; display: flex; align-items: center; justify-content: center; border-radius: 14px; font-size: 1.5rem; margin-right: 16px;">
                    <i class="fas fa-book"></i>
                  </div>
                  <div>
                    <div class="text-muted small" style="color: #64748b; font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">Total Book Orders</div>
                    <div class="fs-4 fw-bold" style="color: var(--admin-text-light); font-size: 28px; font-weight: 700;"><%= analytics.totalOrders %></div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-12 col-lg-3">
            <div class="card shadow-sm h-100" style="border-radius: 16px; border: 1px solid rgba(0, 0, 0, 0.05); transition: all 0.3s ease;">
              <div class="card-body" style="padding: 24px;">
                <div class="d-flex align-items-center">
                  <div class="summary-icon" style="background-color: rgba(40, 167, 69, 0.1); color: #28a745; width: 56px; height: 56px; display: flex; align-items: center; justify-content: center; border-radius: 14px; font-size: 1.5rem; margin-right: 16px;">
                    <i class="fas fa-coins"></i>
                  </div>
                  <div>
                    <div class="text-muted small" style="color: #64748b; font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">Total Revenue</div>
                    <div class="fs-4 fw-bold" style="color: var(--admin-text-light); font-size: 28px; font-weight: 700;">EGP <%= analytics.totalRevenue.toFixed(2) %></div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-12 col-lg-3">
            <div class="card shadow-sm h-100" style="border-radius: 16px; border: 1px solid rgba(0, 0, 0, 0.05); transition: all 0.3s ease;">
              <div class="card-body" style="padding: 24px;">
                <div class="d-flex align-items-center">
                  <div class="summary-icon" style="background-color: rgba(255, 193, 7, 0.1); color: #ffc107; width: 56px; height: 56px; display: flex; align-items: center; justify-content: center; border-radius: 14px; font-size: 1.5rem; margin-right: 16px;">
                    <i class="fas fa-clock"></i>
                  </div>
                  <div>
                    <div class="text-muted small" style="color: #64748b; font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">Pending</div>
                    <div class="fs-4 fw-bold" style="color: var(--admin-text-light); font-size: 28px; font-weight: 700;"><%= analytics.pending %></div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-12 col-lg-3">
            <div class="card shadow-sm h-100" style="border-radius: 16px; border: 1px solid rgba(0, 0, 0, 0.05); transition: all 0.3s ease;">
              <div class="card-body" style="padding: 24px;">
                <div class="d-flex align-items-center">
                  <div class="summary-icon" style="background-color: rgba(23, 162, 184, 0.1); color: #17a2b8; width: 56px; height: 56px; display: flex; align-items: center; justify-content: center; border-radius: 14px; font-size: 1.5rem; margin-right: 16px;">
                    <i class="fas fa-truck"></i>
                  </div>
                  <div>
                    <div class="text-muted small" style="color: #64748b; font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">Shipped</div>
                    <div class="fs-4 fw-bold" style="color: var(--admin-text-light); font-size: 28px; font-weight: 700;"><%= analytics.shipped %></div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Filters -->
        <div class="card shadow-sm mb-4 orders-filter-card" style="border-radius: 16px; border: 1px solid rgba(0, 0, 0, 0.05); overflow: hidden;">
          <div class="card-header" style="background: linear-gradient(135deg, var(--admin-primary), #dc2626); border-bottom: none; padding: 20px 24px;">
            <h5 class="mb-0" style="color: #ffffff; font-weight: 700; display: flex; align-items: center; gap: 12px;">
              <i class="fas fa-filter"></i> Filter Book Orders
            </h5>
          </div>
          <div class="card-body" style="padding: 24px;">
            <form method="GET" action="/admin/book-orders" class="row g-3">
              <div class="col-md-3">
                <label class="form-label" style="color: var(--admin-text-light); font-weight: 600; font-size: 14px; margin-bottom: 8px;">Status</label>
                <select name="status" class="form-select" style="border: 2px solid var(--admin-border-light); border-radius: 12px; padding: 12px 16px; font-size: 14px; transition: all 0.3s ease; background: var(--admin-card-light); color: var(--admin-text-light);">
                  <option value="all" <%= currentFilters.status === 'all' ? 'selected' : '' %>>All Status</option>
                  <option value="pending" <%= currentFilters.status === 'pending' ? 'selected' : '' %>>Pending</option>
                  <option value="processing" <%= currentFilters.status === 'processing' ? 'selected' : '' %>>Processing</option>
                  <option value="shipped" <%= currentFilters.status === 'shipped' ? 'selected' : '' %>>Shipped</option>
                  <option value="delivered" <%= currentFilters.status === 'delivered' ? 'selected' : '' %>>Delivered</option>
                </select>
              </div>
              <div class="col-md-4">
                <label class="form-label" style="color: var(--admin-text-light); font-weight: 600; font-size: 14px; margin-bottom: 8px;">Search</label>
                <div class="input-group">
                  <span class="input-group-text" style="background: var(--admin-primary); border: 2px solid var(--admin-primary); color: white; border-radius: 12px 0 0 12px;">
                    <i class="fas fa-search"></i>
                  </span>
                  <input type="text" name="search" class="form-control" placeholder="Order number, tracking number, book name, student email, student code, phone, address..." value="<%= currentFilters.search || '' %>" style="border: 2px solid var(--admin-border-light); border-radius: 0 12px 12px 0; padding: 12px 16px; font-size: 14px; transition: all 0.3s ease; background: var(--admin-card-light); color: var(--admin-text-light);">
                </div>
              </div>
              <div class="col-md-2">
                <label class="form-label" style="color: var(--admin-text-light); font-weight: 600; font-size: 14px; margin-bottom: 8px;">Date From</label>
                <input type="date" name="dateFrom" class="form-control" value="<%= currentFilters.dateFrom || '' %>" style="border: 2px solid var(--admin-border-light); border-radius: 12px; padding: 12px 16px; font-size: 14px; transition: all 0.3s ease; background: var(--admin-card-light); color: var(--admin-text-light);">
              </div>
              <div class="col-md-2">
                <label class="form-label" style="color: var(--admin-text-light); font-weight: 600; font-size: 14px; margin-bottom: 8px;">Date To</label>
                <input type="date" name="dateTo" class="form-control" value="<%= currentFilters.dateTo || '' %>" style="border: 2px solid var(--admin-border-light); border-radius: 12px; padding: 12px 16px; font-size: 14px; transition: all 0.3s ease; background: var(--admin-card-light); color: var(--admin-text-light);">
              </div>
              <div class="col-md-1 d-flex align-items-end">
                <button type="submit" class="btn btn-primary w-100" style="padding: 12px; border-radius: 12px; font-weight: 600; font-size: 14px; transition: all 0.3s ease; background: var(--admin-primary); border-color: var(--admin-primary);">
                  <i class="fas fa-search"></i>
                </button>
              </div>
              <div class="col-12 d-flex justify-content-end gap-2 mt-2">
                <a href="/admin/book-orders" class="btn btn-outline-secondary" style="padding: 12px 24px; border-radius: 12px; font-weight: 600; font-size: 14px; transition: all 0.3s ease; border: 2px solid var(--admin-border-light); color: var(--admin-text-light);">
                  <i class="fas fa-times me-1"></i> Clear
                </a>
              </div>
            </form>
          </div>
        </div>

        <!-- Book Orders Table -->
        <div class="card shadow-sm orders-table" style="border-radius: 16px; overflow: hidden; border: 1px solid rgba(0, 0, 0, 0.05);">
          <div class="card-header" style="background: linear-gradient(135deg, var(--admin-primary), #dc2626); border-bottom: none; padding: 20px 24px;">
            <div class="d-flex justify-content-between align-items-center">
              <h5 class="mb-0" style="color: #ffffff; font-weight: 700; display: flex; align-items: center; gap: 12px;">
                <i class="fas fa-list"></i> Book Orders List
              </h5>
              <div class="badge" style="background: rgba(255, 255, 255, 0.2); color: white; border: 1px solid rgba(255, 255, 255, 0.3); padding: 8px 16px; border-radius: 20px; font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">
                <%= pagination.totalOrders %> Total Orders
              </div>
            </div>
          </div>
            <div class="table-responsive">
            <table class="table table-hover align-middle mb-0" style="background: transparent; border: none; margin: 0;">
                <thead>
                  <tr>
                  <th style="background: transparent; color: var(--admin-text-light); padding: 20px 24px; text-align: left; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; font-size: 12px; border-bottom: 2px solid var(--admin-border-light); position: sticky; top: 0; z-index: 10; white-space: nowrap; width: 50px;">
                    <input type="checkbox" id="selectAllOrders" onchange="toggleSelectAll()" style="width: 18px; height: 18px; cursor: pointer;">
                  </th>
                  <th style="background: transparent; color: var(--admin-text-light); padding: 20px 24px; text-align: left; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; font-size: 12px; border-bottom: 2px solid var(--admin-border-light); position: sticky; top: 0; z-index: 10; white-space: nowrap;">Book Order #</th>
                  <th style="background: transparent; color: var(--admin-text-light); padding: 20px 24px; text-align: left; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; font-size: 12px; border-bottom: 2px solid var(--admin-border-light); position: sticky; top: 0; z-index: 10;">Book Name</th>
                  <th style="background: transparent; color: var(--admin-text-light); padding: 20px 24px; text-align: left; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; font-size: 12px; border-bottom: 2px solid var(--admin-border-light); position: sticky; top: 0; z-index: 10;">Bundle</th>
                  <th style="background: transparent; color: var(--admin-text-light); padding: 20px 24px; text-align: left; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; font-size: 12px; border-bottom: 2px solid var(--admin-border-light); position: sticky; top: 0; z-index: 10;">Student</th>
                  <th style="background: transparent; color: var(--admin-text-light); padding: 20px 24px; text-align: left; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; font-size: 12px; border-bottom: 2px solid var(--admin-border-light); position: sticky; top: 0; z-index: 10;">Price</th>
                  <th style="background: transparent; color: var(--admin-text-light); padding: 20px 24px; text-align: left; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; font-size: 12px; border-bottom: 2px solid var(--admin-border-light); position: sticky; top: 0; z-index: 10;">Status</th>
                  <th style="background: transparent; color: var(--admin-text-light); padding: 20px 24px; text-align: left; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; font-size: 12px; border-bottom: 2px solid var(--admin-border-light); position: sticky; top: 0; z-index: 10;">Tracking</th>
                  <th style="background: transparent; color: var(--admin-text-light); padding: 20px 24px; text-align: left; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; font-size: 12px; border-bottom: 2px solid var(--admin-border-light); position: sticky; top: 0; z-index: 10;">Date</th>
                  <th class="text-end" style="background: transparent; color: var(--admin-text-light); padding: 20px 24px; text-align: left; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; font-size: 12px; border-bottom: 2px solid var(--admin-border-light); position: sticky; top: 0; z-index: 10;">Actions</th>
                  </tr>
                </thead>
                <tbody>
                <% if (!bookOrders || bookOrders.length === 0) { %>
                <tr>
                  <td colspan="10" class="text-center py-5" style="padding: 20px 24px; border-bottom: 1px solid var(--admin-border-light); vertical-align: middle; color: var(--admin-text-light);">
                    <div class="orders-empty-state">
                      <div class="orders-empty-icon" style="width: 80px; height: 80px; margin: 0 auto 20px; background: rgba(var(--admin-primary-rgb), 0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-book fa-3x" style="color: var(--admin-primary);"></i>
                      </div>
                      <div class="orders-empty-title" style="font-size: 20px; font-weight: 700; color: var(--admin-text-light); margin-bottom: 8px;">No Book Orders Found</div>
                      <div class="orders-empty-description" style="color: #64748b; font-size: 14px;">No book orders match your current filters.</div>
                    </div>
                  </td>
                </tr>
                <% } %>
                <% (bookOrders || []).forEach(order => { %>
                <tr style="transition: all 0.3s ease;" data-order-id="<%= order._id %>">
                  <td style="padding: 20px 24px; border-bottom: 1px solid var(--admin-border-light); vertical-align: middle; text-align: center;">
                    <input type="checkbox" class="order-checkbox" value="<%= order._id %>" onchange="updateSelection()" style="width: 18px; height: 18px; cursor: pointer;">
                  </td>
                  <td style="padding: 20px 24px; border-bottom: 1px solid var(--admin-border-light); vertical-align: middle; color: var(--admin-text-light);">
                    <div style="display: flex; align-items: center; gap: 8px; flex-wrap: nowrap; white-space: nowrap;">
                      <% if (order.purchase && order.purchase.orderNumber) { %>
                      <a href="/admin/orders/<%= order.purchase.orderNumber %>" class="order-number-link" style="color: var(--admin-primary); text-decoration: none; font-weight: 700; font-size: 15px; white-space: nowrap;">
                        #<%= order.orderNumber %>
                      </a>
                      <% } else { %>
                      <span style="color: var(--admin-text-light); font-weight: 700; font-size: 15px; white-space: nowrap;">
                        #<%= order.orderNumber %>
                      </span>
                      <% } %>
                      <span class="badge" style="background: rgba(107, 114, 128, 0.1); color: #6b7280; border: 1px solid rgba(107, 114, 128, 0.2); padding: 4px 10px; border-radius: 8px; font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.3px; white-space: nowrap;">
                        Book Order
                      </span>
                    </div>
                    </td>
                  <td style="padding: 20px 24px; border-bottom: 1px solid var(--admin-border-light); vertical-align: middle; color: var(--admin-text-light);">
                      <div class="d-flex align-items-center">
                      <div style="width: 40px; height: 40px; background: rgba(var(--admin-primary-rgb), 0.1); border-radius: 10px; display: flex; align-items: center; justify-content: center; margin-right: 12px;">
                        <i class="fas fa-book" style="color: var(--admin-primary);"></i>
                      </div>
                      <span style="font-weight: 600; font-size: 14px; color: var(--admin-text-light);"><%= order.bookName %></span>
                      </div>
                    </td>
                  <td style="padding: 20px 24px; border-bottom: 1px solid var(--admin-border-light); vertical-align: middle;">
                      <% if (order.bundle) { %>
                    <div class="d-flex flex-column gap-1">
                      <div style="font-weight: 600; font-size: 14px; color: var(--admin-text-light);">
                        <%= order.bundle.title || 'N/A' %>
                      </div>
                      <div>
                        <span class="badge" style="background: rgba(23, 162, 184, 0.1); color: #17a2b8; border: 1px solid rgba(23, 162, 184, 0.2); padding: 4px 10px; border-radius: 8px; font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">
                          <%= order.bundle.bundleCode || 'N/A' %>
                        </span>
                      </div>
                  
                    </div>
                    <% } else { %>
                    <span class="text-muted" style="color: #64748b; font-size: 13px; font-style: italic;">N/A</span>
                      <% } %>
                    </td>
                  <td style="padding: 20px 24px; border-bottom: 1px solid var(--admin-border-light); vertical-align: middle; color: var(--admin-text-light);">
                      <% if (order.user) { %>
                    <div class="order-customer-info">
                      <div class="fw-semibold" style="color: var(--admin-text-light); font-weight: 600; font-size: 14px;">
                        <%= order.user.firstName %> <%= order.user.lastName %>
                      </div>
                      <div class="text-muted small" style="color: #64748b; font-size: 12px; display: flex; align-items: center; gap: 4px; margin-top: 4px;">
                        <i class="fas fa-envelope"></i> <%= order.user.studentEmail %>
                      </div>
                      <% if (order.user.studentCode) { %>
                      <div class="text-muted small" style="color: #64748b; font-size: 11px; margin-top: 2px;">
                        Code: <%= order.user.studentCode %>
                      </div>
                      <% } %>
                    </div>
                    <% } else { %>
                    <span class="text-muted" style="color: #64748b; font-size: 13px; font-style: italic;">N/A</span>
                      <% } %>
                    </td>
                  <td class="fw-bold" style="padding: 20px 24px; border-bottom: 1px solid var(--admin-border-light); vertical-align: middle; color: var(--admin-primary); font-weight: 700; font-size: 16px;">
                    EGP <%= order.bookPrice.toFixed(2) %>
                    </td>
                  <td style="padding: 20px 24px; border-bottom: 1px solid var(--admin-border-light); vertical-align: middle; width: 120px;">
                    <span class="status-badge status-<%= order.status %>" style="display: inline-block; padding: 6px 12px; border-radius: 8px; font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.3px; background-color: <%= order.status === 'delivered' ? 'rgba(40, 167, 69, 0.15)' : order.status === 'shipped' ? 'rgba(23, 162, 184, 0.15)' : order.status === 'processing' ? 'rgba(255, 193, 7, 0.15)' : 'rgba(108, 117, 125, 0.15)' %>; color: <%= order.status === 'delivered' ? '#28a745' : order.status === 'shipped' ? '#17a2b8' : order.status === 'processing' ? '#ffc107' : '#6c757d' %>;">
                        <%= order.status.charAt(0).toUpperCase() + order.status.slice(1) %>
                      </span>
                    </td>
                  <td style="padding: 20px 24px; border-bottom: 1px solid var(--admin-border-light); vertical-align: middle; color: var(--admin-text-light);">
                      <% if (order.trackingNumber) { %>
                    <code style="background: rgba(var(--admin-primary-rgb), 0.1); color: var(--admin-primary); padding: 6px 10px; border-radius: 8px; font-size: 12px; font-weight: 600; font-family: 'Courier New', monospace; border: 1px solid rgba(var(--admin-primary-rgb), 0.2);">
                      <%= order.trackingNumber %>
                    </code>
                      <% } else { %>
                    <span class="text-muted" style="color: #64748b; font-size: 13px; font-style: italic;">-</span>
                      <% } %>
                    </td>
                  <td style="padding: 20px 24px; border-bottom: 1px solid var(--admin-border-light); vertical-align: middle; color: var(--admin-text-light);">
                    <div class="text-muted small" style="color: #64748b; font-size: 12px; display: flex; align-items: center; gap: 4px;">
                      <i class="far fa-calendar-alt"></i> <%= new Date(order.createdAt).toLocaleDateString() %>
                    </div>
                    <div class="text-muted small" style="color: #64748b; font-size: 12px; display: flex; align-items: center; gap: 4px; margin-top: 4px;">
                      <i class="far fa-clock"></i> <%= new Date(order.createdAt).toLocaleTimeString() %>
                      </div>
                    </td>
                  <td style="padding: 20px 24px; border-bottom: 1px solid var(--admin-border-light); vertical-align: middle;">
                    <div class="d-flex justify-content-end gap-1">
                      <button class="btn btn-sm btn-outline-primary order-action-button" onclick="openBookOrderModal('<%= order._id %>')" data-bs-toggle="modal" data-bs-target="#bookOrderModal" title="Edit Order" style="width: 36px; height: 36px; padding: 0; display: inline-flex; align-items: center; justify-content: center; border-radius: 8px; border: 2px solid var(--admin-primary); color: var(--admin-primary); background: transparent; transition: all 0.3s ease;">
                        <i class="fas fa-edit"></i>
                      </button>
                    </div>
                    </td>
                  </tr>
                  <% }); %>
                </tbody>
              </table>
            </div>

          </div>
          <div class="card-footer order-pagination" style="background: var(--admin-card-light); border: 2px solid var(--admin-border-light); border-radius: 16px; padding: 20px 24px; margin-top: 24px; box-shadow: var(--admin-shadow);">
            <div class="d-flex justify-content-between align-items-center">
              <div class="text-muted" style="color: #64748b; font-size: 14px; font-weight: 500;">
                Showing <span class="fw-semibold" style="color: var(--admin-primary); font-weight: 700;"><%= bookOrders?.length || 0 %></span> orders -
                Page <span class="fw-semibold" style="color: var(--admin-primary); font-weight: 700;"><%= pagination.currentPage %></span> of
                <span class="fw-semibold" style="color: var(--admin-primary); font-weight: 700;"><%= pagination.totalPages %></span>
                (<span class="fw-semibold" style="color: var(--admin-primary); font-weight: 700;"><%= pagination.totalOrders %></span> total)
              </div>
            <% if (pagination.totalPages > 1) { %>
              <div class="d-flex gap-1">
                <a class="btn btn-sm <%= pagination.hasPrev?'btn-primary':'btn-outline-secondary disabled' %>" href="?page=1&status=<%= currentFilters.status || 'all' %>&search=<%= currentFilters.search || '' %>&dateFrom=<%= currentFilters.dateFrom || '' %>&dateTo=<%= currentFilters.dateTo || '' %>" style="padding: 8px 12px; border: 2px solid var(--admin-border-light); background: var(--admin-card-light); color: var(--admin-text-light); border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; text-decoration: none; display: inline-flex; align-items: center; justify-content: center; min-width: 40px; height: 40px;">
                  <i class="fas fa-angle-double-left"></i>
                </a>
                <a class="btn btn-sm <%= pagination.hasPrev?'btn-outline-primary':'btn-outline-secondary disabled' %>" href="?page=<%= pagination.currentPage-1 %>&status=<%= currentFilters.status || 'all' %>&search=<%= currentFilters.search || '' %>&dateFrom=<%= currentFilters.dateFrom || '' %>&dateTo=<%= currentFilters.dateTo || '' %>" style="padding: 8px 12px; border: 2px solid var(--admin-border-light); background: var(--admin-card-light); color: var(--admin-text-light); border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; text-decoration: none; display: inline-flex; align-items: center; justify-content: center; min-width: 40px; height: 40px;">
                  <i class="fas fa-angle-left"></i> Prev
                </a>
                <a class="btn btn-sm <%= pagination.hasNext?'btn-outline-primary':'btn-outline-secondary disabled' %>" href="?page=<%= pagination.currentPage+1 %>&status=<%= currentFilters.status || 'all' %>&search=<%= currentFilters.search || '' %>&dateFrom=<%= currentFilters.dateFrom || '' %>&dateTo=<%= currentFilters.dateTo || '' %>" style="padding: 8px 12px; border: 2px solid var(--admin-border-light); background: var(--admin-card-light); color: var(--admin-text-light); border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; text-decoration: none; display: inline-flex; align-items: center; justify-content: center; min-width: 40px; height: 40px;">
                  Next <i class="fas fa-angle-right"></i>
                </a>
                <a class="btn btn-sm <%= pagination.hasNext?'btn-primary':'btn-outline-secondary disabled' %>" href="?page=<%= pagination.totalPages %>&status=<%= currentFilters.status || 'all' %>&search=<%= currentFilters.search || '' %>&dateFrom=<%= currentFilters.dateFrom || '' %>&dateTo=<%= currentFilters.dateTo || '' %>" style="padding: 8px 12px; border: 2px solid var(--admin-border-light); background: var(--admin-card-light); color: var(--admin-text-light); border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; text-decoration: none; display: inline-flex; align-items: center; justify-content: center; min-width: 40px; height: 40px;">
                  <i class="fas fa-angle-double-right"></i>
                </a>
              </div>
            <% } %>
            </div>
          </div>
        </div>
      </div>
    </div>

  </main>
</div>

<!-- Book Order Modal -->
<div class="modal fade" id="bookOrderModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content" style="border-radius: 16px; border: none; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);">
      <div class="modal-header" style="background: linear-gradient(135deg, var(--admin-primary), #dc2626); border-bottom: none; border-radius: 16px 16px 0 0; padding: 24px;">
        <h5 class="modal-title" style="color: #ffffff; font-weight: 700; display: flex; align-items: center; gap: 12px;">
          <i class="fas fa-edit"></i> Update Book Order
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" style="filter: brightness(0) invert(1);"></button>
      </div>
      <div class="modal-body" style="padding: 24px; background: var(--admin-card-light);">
        <form id="bookOrderForm">
          <input type="hidden" id="bookOrderId" name="bookOrderId">
          
          <div class="mb-4">
            <label class="form-label" style="color: var(--admin-text-light); font-weight: 600; font-size: 14px; margin-bottom: 8px;">
              <i class="fas fa-info-circle me-2" style="color: var(--admin-primary);"></i>Status
            </label>
            <select class="form-select" id="bookOrderStatus" name="status" required style="border: 2px solid var(--admin-border-light); border-radius: 12px; padding: 12px 16px; font-size: 14px; transition: all 0.3s ease; background: var(--admin-card-light); color: var(--admin-text-light);">
              <option value="pending">Pending</option>
              <option value="processing">Processing</option>
              <option value="shipped">Shipped</option>
              <option value="delivered">Delivered</option>
              <option value="cancelled">Cancelled</option>
            </select>
          </div>

          <div class="mb-4">
            <label class="form-label" style="color: var(--admin-text-light); font-weight: 600; font-size: 14px; margin-bottom: 8px;">
              <i class="fas fa-truck me-2" style="color: var(--admin-primary);"></i>Tracking Number
            </label>
            <input type="text" class="form-control" id="bookOrderTracking" name="trackingNumber" placeholder="Enter tracking number" style="border: 2px solid var(--admin-border-light); border-radius: 12px; padding: 12px 16px; font-size: 14px; transition: all 0.3s ease; background: var(--admin-card-light); color: var(--admin-text-light);">
          </div>

          <div class="mb-4">
            <label class="form-label" style="color: var(--admin-text-light); font-weight: 600; font-size: 14px; margin-bottom: 8px;">
              <i class="fas fa-sticky-note me-2" style="color: var(--admin-primary);"></i>Notes
            </label>
            <textarea class="form-control" id="bookOrderNotes" name="notes" rows="3" placeholder="Add any notes about this order" style="border: 2px solid var(--admin-border-light); border-radius: 12px; padding: 12px 16px; font-size: 14px; transition: all 0.3s ease; background: var(--admin-card-light); color: var(--admin-text-light);"></textarea>
          </div>

          <div id="bookOrderDetails"></div>
        </form>
      </div>
      <div class="modal-footer" style="background: var(--admin-card-light); border-top: 2px solid var(--admin-border-light); border-radius: 0 0 16px 16px; padding: 20px 24px;">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal" style="padding: 12px 24px; border-radius: 12px; font-weight: 600; font-size: 14px; transition: all 0.3s ease; border: 2px solid var(--admin-border-light); color: var(--admin-text-light);">
          <i class="fas fa-times me-2"></i>Close
        </button>
        <button type="button" class="btn btn-primary" onclick="updateBookOrder()" style="padding: 12px 24px; border-radius: 12px; font-weight: 600; font-size: 14px; transition: all 0.3s ease; background: var(--admin-primary); border-color: var(--admin-primary);">
          <i class="fas fa-save me-2"></i>Update Order
        </button>
      </div>
    </div>
  </div>
</div>

<script>
  let currentBookOrder = null;

  async function openBookOrderModal(orderId) {
    try {
      const response = await fetch(`/admin/book-orders/${orderId}`);
      const data = await response.json();
      
      if (data.success) {
        currentBookOrder = data.bookOrder;
        document.getElementById('bookOrderId').value = orderId;
        document.getElementById('bookOrderStatus').value = data.bookOrder.status;
        document.getElementById('bookOrderTracking').value = data.bookOrder.trackingNumber || '';
        document.getElementById('bookOrderNotes').value = data.bookOrder.notes || '';

        // Display order details
        const detailsDiv = document.getElementById('bookOrderDetails');
        const mainOrderLink = data.bookOrder.purchase && data.bookOrder.purchase.orderNumber 
          ? `<a href="/admin/orders/${data.bookOrder.purchase.orderNumber}" class="order-number-link" style="color: var(--admin-primary); text-decoration: none; font-weight: 700;">#${data.bookOrder.purchase.orderNumber}</a>`
          : 'N/A';
        
        detailsDiv.innerHTML = `
          <div class="card mt-3" style="border-radius: 12px; border: 2px solid var(--admin-border-light); background: var(--admin-card-light); overflow: hidden;">
            <div class="card-header" style="background: linear-gradient(135deg, rgba(var(--admin-primary-rgb), 0.1), rgba(220, 38, 38, 0.1)); border-bottom: 2px solid var(--admin-border-light); padding: 16px 20px;">
              <h6 class="mb-0" style="color: var(--admin-text-light); font-weight: 700; display: flex; align-items: center; gap: 8px;">
                <i class="fas fa-info-circle" style="color: var(--admin-primary);"></i>Order Details
              </h6>
            </div>
            <div class="card-body" style="padding: 20px;">
              <div class="row g-3">
                <div class="col-md-6">
                  <div style="margin-bottom: 16px;">
                    <div style="color: #64748b; font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">Book Name</div>
                    <div style="color: var(--admin-text-light); font-weight: 600; font-size: 15px;">
                      <i class="fas fa-book me-2" style="color: var(--admin-primary);"></i>${data.bookOrder.bookName}
                    </div>
                  </div>
                  <div style="margin-bottom: 16px;">
                    <div style="color: #64748b; font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">Price</div>
                    <div style="color: var(--admin-primary); font-weight: 700; font-size: 18px;">EGP ${data.bookOrder.bookPrice.toFixed(2)}</div>
                  </div>
                </div>
                <div class="col-md-6">
                  <div style="margin-bottom: 16px;">
                    <div style="color: #64748b; font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">Main Order #</div>
                    <div style="color: var(--admin-text-light); font-weight: 600; font-size: 15px;">
                      ${mainOrderLink}
                    </div>
                  </div>
                  <div style="margin-bottom: 16px;">
                    <div style="color: #64748b; font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">Book Order #</div>
                    <div style="color: var(--admin-text-light); font-weight: 600; font-size: 15px;">
                      #${data.bookOrder.orderNumber}
                    </div>
                  </div>
                </div>
              </div>
              <hr style="margin: 20px 0; border-color: var(--admin-border-light);">
              ${data.bookOrder.bundle ? `
              <div style="margin-bottom: 16px;">
                <div style="color: #64748b; font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px;">Bundle Information</div>
                <div style="color: var(--admin-text-light); font-weight: 600; font-size: 14px; margin-bottom: 4px;">
                  <i class="fas fa-layer-group me-2" style="color: var(--admin-primary);"></i>${data.bookOrder.bundle.title || 'N/A'}
                </div>
                <div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
                  <span class="badge" style="background: rgba(23, 162, 184, 0.1); color: #17a2b8; border: 1px solid rgba(23, 162, 184, 0.2); padding: 4px 10px; border-radius: 8px; font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">
                    ${data.bookOrder.bundle.bundleCode || 'N/A'}
                  </span>
                  ${data.bookOrder.bundle._id ? `
                  <span style="color: #64748b; font-size: 11px; font-family: monospace;">
                    ID: ${data.bookOrder.bundle._id}
                  </span>
                  ` : ''}
                </div>
              </div>
              <hr style="margin: 20px 0; border-color: var(--admin-border-light);">
              ` : ''}
              <div style="margin-bottom: 16px;">
                <div style="color: #64748b; font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px;">Student Information</div>
                <div style="color: var(--admin-text-light); font-weight: 600; font-size: 14px; margin-bottom: 4px;">
                  <i class="fas fa-user me-2" style="color: var(--admin-primary);"></i>${data.bookOrder.user.firstName} ${data.bookOrder.user.lastName}
                </div>
                <div style="color: #64748b; font-size: 13px;">
                  <i class="fas fa-envelope me-2"></i>${data.bookOrder.user.studentEmail}
                </div>
              </div>
              <hr style="margin: 20px 0; border-color: var(--admin-border-light);">
              <div>
                <div style="color: #64748b; font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 12px;">
                  <i class="fas fa-map-marker-alt me-2" style="color: var(--admin-primary);"></i>Shipping Address
                </div>
                <div style="color: var(--admin-text-light); font-size: 14px; line-height: 1.8; background: rgba(var(--admin-primary-rgb), 0.05); padding: 16px; border-radius: 10px; border-left: 4px solid var(--admin-primary);">
                  ${data.bookOrder.shippingAddress.streetName ? `<div style="font-weight: 600; margin-bottom: 4px;">Street: ${data.bookOrder.shippingAddress.streetName}</div>` : ''}
                  ${data.bookOrder.shippingAddress.buildingNumber ? `<div>Building: ${data.bookOrder.shippingAddress.buildingNumber}</div>` : ''}
                  ${data.bookOrder.shippingAddress.apartmentNumber ? `<div>Apartment: ${data.bookOrder.shippingAddress.apartmentNumber}</div>` : ''}
                  ${data.bookOrder.shippingAddress.city ? `<div style="margin-top: 8px;">Zone: ${data.bookOrder.shippingAddress.city}</div>` : ''}
                  ${data.bookOrder.shippingAddress.governorate ? `<div>Governorate: ${data.bookOrder.shippingAddress.governorate}</div>` : ''}
                  <div>${data.bookOrder.shippingAddress.country} ${data.bookOrder.shippingAddress.zipCode ? '- ' + data.bookOrder.shippingAddress.zipCode : ''}</div>
                  <div style="margin-top: 8px; color: #64748b; font-size: 13px;">
                    <i class="fas fa-phone me-2"></i>${data.bookOrder.shippingAddress.phone}
                  </div>
                </div>
              </div>
            </div>
          </div>
        `;
      }
    } catch (error) {
      console.error('Error loading book order:', error);
      alert('Error loading book order details');
    }
  }

  async function updateBookOrder() {
    const orderId = document.getElementById('bookOrderId').value;
    const status = document.getElementById('bookOrderStatus').value;
    const trackingNumber = document.getElementById('bookOrderTracking').value;
    const notes = document.getElementById('bookOrderNotes').value;

    try {
      const response = await fetch(`/admin/book-orders/${orderId}/update`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          status,
          trackingNumber,
          notes,
        }),
      });

      const data = await response.json();

      if (data.success) {
        alert('Book order updated successfully!');
        location.reload();
      } else {
        alert('Error updating book order: ' + data.message);
      }
    } catch (error) {
      console.error('Error updating book order:', error);
      alert('Error updating book order');
    }
  }

  // Excel Export Function
  function exportBookOrdersToExcel() {
    // Show loading state
    const btn = event.target.closest('button');
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Exporting...';
    btn.disabled = true;

    // Get current filters
    const urlParams = new URLSearchParams(window.location.search);
    const queryString = urlParams.toString();

    // Create export URL with current filters
    const exportUrl = `/admin/book-orders/export?${queryString}`;

    // Trigger download
    window.location.href = exportUrl;

    // Reset button after a delay
    setTimeout(() => {
      btn.innerHTML = originalText;
      btn.disabled = false;
    }, 2000);
  }

  // Bulk Selection Functions
  function updateSelection() {
    const checkboxes = document.querySelectorAll('.order-checkbox');
    const checkedBoxes = document.querySelectorAll('.order-checkbox:checked');
    const selectedCount = checkedBoxes.length;
    const bulkActionsContainer = document.getElementById('bulkActionsContainer');
    const selectedCountSpan = document.getElementById('selectedCount');
    const selectAllCheckbox = document.getElementById('selectAllOrders');

    // Update row highlighting
    checkboxes.forEach(checkbox => {
      const row = checkbox.closest('tr');
      if (checkbox.checked) {
        row.classList.add('selected-row');
      } else {
        row.classList.remove('selected-row');
      }
    });

    // Update selected count
    selectedCountSpan.textContent = `${selectedCount} selected`;

    // Show/hide bulk actions
    if (selectedCount > 0) {
      bulkActionsContainer.style.display = 'block';
    } else {
      bulkActionsContainer.style.display = 'none';
    }

    // Update select all checkbox state
    const totalCheckboxes = checkboxes.length;
    selectAllCheckbox.checked = selectedCount === totalCheckboxes && totalCheckboxes > 0;
    selectAllCheckbox.indeterminate = selectedCount > 0 && selectedCount < totalCheckboxes;
  }

  function toggleSelectAll() {
    const selectAllCheckbox = document.getElementById('selectAllOrders');
    const checkboxes = document.querySelectorAll('.order-checkbox');
    
    checkboxes.forEach(checkbox => {
      checkbox.checked = selectAllCheckbox.checked;
    });
    
    updateSelection();
  }

  function clearSelection() {
    const checkboxes = document.querySelectorAll('.order-checkbox');
    const selectAllCheckbox = document.getElementById('selectAllOrders');
    
    checkboxes.forEach(checkbox => {
      checkbox.checked = false;
      const row = checkbox.closest('tr');
      row.classList.remove('selected-row');
    });
    
    selectAllCheckbox.checked = false;
    selectAllCheckbox.indeterminate = false;
    
    updateSelection();
  }

  async function bulkUpdateStatus(status) {
    const checkboxes = document.querySelectorAll('.order-checkbox:checked');
    
    if (checkboxes.length === 0) {
      alert('Please select at least one order to update');
      return;
    }

    // Confirm action
    const statusNames = {
      'pending': 'Pending',
      'processing': 'Processing',
      'shipped': 'Shipped',
      'delivered': 'Delivered'
    };

    if (!confirm(`Are you sure you want to update ${checkboxes.length} order(s) to "${statusNames[status]}" status?`)) {
      return;
    }

    // Collect order IDs
    const orderIds = Array.from(checkboxes).map(cb => cb.value);

    // Show loading state
    const bulkActionsContainer = document.getElementById('bulkActionsContainer');
    const originalContent = bulkActionsContainer.innerHTML;
    bulkActionsContainer.innerHTML = '<div class="d-flex align-items-center gap-2"><i class="fas fa-spinner fa-spin"></i> Updating...</div>';

    try {
      const response = await fetch('/admin/book-orders/bulk-update', {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          orderIds: orderIds,
          status: status,
        }),
      });

      const data = await response.json();

      if (data.success) {
        alert(`Successfully updated ${data.modifiedCount} order(s) to "${statusNames[status]}" status!`);
        // Reload the page to reflect changes
        location.reload();
      } else {
        alert('Error updating orders: ' + (data.message || 'Unknown error'));
        bulkActionsContainer.innerHTML = originalContent;
      }
    } catch (error) {
      console.error('Error bulk updating orders:', error);
      alert('Error updating orders. Please try again.');
      bulkActionsContainer.innerHTML = originalContent;
    }
  }
</script>

<%- include('./partials/admin-footer') %>

