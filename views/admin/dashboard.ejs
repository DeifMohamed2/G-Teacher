<%- include('./partials/admin-header', { pageCSS: 'dashboard' }) %>

  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Admin Layout -->
  <div class="admin-layout">

    <!-- Sidebar -->
    <%- include('./partials/admin-sidebar', { currentPage: 'dashboard' , admin: user }) %>

      <!-- Main Content -->
      <main class="admin-main">

        <!-- Top Bar -->
        <%- include('./partials/admin-topbar', { breadcrumb: 'Dashboard' , breadcrumbSubtitle: 'Platform Overview' ,
          showSearch: false }) %>

          <!-- Content Area -->
          <div class="admin-content">
            <div class="admin-dashboard admin-fade-in">

              <!-- Compact Toast Notification -->
              <% if (dashboardData.newOrdersCount> 0) { %>
                <div class="toast-notification" id="newOrdersNotification"
                  data-order-count="<%= dashboardData.newOrdersCount %>">
                  <div class="toast-content">
                    <div class="toast-icon">
                      <i class="fas fa-shopping-cart"></i>
                      <span class="toast-badge">
                        <%= dashboardData.newOrdersCount %>
                      </span>
                    </div>
                    <div class="toast-text">
                      <div class="toast-title">
                        <strong>
                          <%= dashboardData.newOrdersCount %>
                        </strong> New Order<%= dashboardData.newOrdersCount> 1 ? 's' : '' %>
                      </div>
                      <div class="toast-message">Needs your attention</div>
                    </div>
                    <div class="toast-actions">
                      <button class="toast-btn" onclick="viewNewOrders()" title="View Orders">
                        <i class="fas fa-eye"></i>
                      </button>
                      <button class="toast-btn close" onclick="dismissNotification()" title="Dismiss">
                        <i class="fas fa-times"></i>
                      </button>
                    </div>
                  </div>
                  <div class="toast-progress" id="notificationProgress"></div>
                </div>
                <% } %>

                  <!-- Enhanced Dashboard Header -->
                  <div class="dashboard-hero-header">
                    <div class="dashboard-hero-content">
                      <div class="dashboard-hero-left">
                        <div class="dashboard-greeting">
                          <span class="greeting-wave">ðŸ‘‹</span>
                          <span class="greeting-text">Welcome back, <strong><%= user.name || 'Admin' %></strong></span>
                        </div>
                        <h1 class="dashboard-title">
                          <i class="fas fa-chart-line dashboard-title-icon"></i>
                          Dashboard Overview
                        </h1>
                        <p class="dashboard-subtitle">
                          <i class="fas fa-graduation-cap"></i>
                          G-Teacher IGCSE Academy â€” Track your platform performance
                        </p>
                      </div>
                      <div class="dashboard-hero-right">
                        <div class="dashboard-date-card">
                          <div class="date-icon">
                            <i class="fas fa-calendar-alt"></i>
                          </div>
                          <div class="date-info">
                            <span class="date-label">Today</span>
                            <span class="date-value" id="currentDate"></span>
                          </div>
                        </div>
                        <div class="dashboard-quick-stats">
                          <div class="quick-stat-item">
                            <span class="quick-stat-value"><%= dashboardData.students.newThisMonth || 0 %></span>
                            <span class="quick-stat-label">New Students</span>
                          </div>
                          <div class="quick-stat-divider"></div>
                          <div class="quick-stat-item">
                            <span class="quick-stat-value"><%= dashboardData.courses?.total || 0 %></span>
                            <span class="quick-stat-label">Active Courses</span>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                  
                  <style>
                    .dashboard-hero-header {
                      background: linear-gradient(135deg, #3a92bd 0%, #0c5374 100%);
                      border-radius: 20px;
                      padding: 32px 36px;
                      margin-bottom: 28px;
                      position: relative;
                      overflow: hidden;
                      box-shadow: 0 10px 40px rgba(58, 146, 189, 0.25);
                    }
                    
                    .dashboard-hero-header::before {
                      content: '';
                      position: absolute;
                      top: -50%;
                      right: -20%;
                      width: 400px;
                      height: 400px;
                      background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
                      border-radius: 50%;
                    }
                    
                    .dashboard-hero-header::after {
                      content: '';
                      position: absolute;
                      bottom: -30%;
                      left: 10%;
                      width: 250px;
                      height: 250px;
                      background: radial-gradient(circle, rgba(255,255,255,0.08) 0%, transparent 70%);
                      border-radius: 50%;
                    }
                    
                    .dashboard-hero-content {
                      display: flex;
                      justify-content: space-between;
                      align-items: center;
                      position: relative;
                      z-index: 1;
                    }
                    
                    .dashboard-hero-left {
                      flex: 1;
                    }
                    
                    .dashboard-greeting {
                      display: flex;
                      align-items: center;
                      gap: 10px;
                      margin-bottom: 12px;
                    }
                    
                    .greeting-wave {
                      font-size: 24px;
                      animation: wave 2s ease-in-out infinite;
                    }
                    
                    @keyframes wave {
                      0%, 100% { transform: rotate(0deg); }
                      25% { transform: rotate(20deg); }
                      75% { transform: rotate(-10deg); }
                    }
                    
                    .greeting-text {
                      color: rgba(255, 255, 255, 0.9);
                      font-size: 15px;
                      font-weight: 500;
                    }
                    
                    .greeting-text strong {
                      color: #fff;
                      font-weight: 700;
                    }
                    
                    .dashboard-title {
                      color: #ffffff;
                      font-size: 2.2rem;
                      font-weight: 800;
                      margin: 0 0 10px 0;
                      display: flex;
                      align-items: center;
                      gap: 14px;
                      text-shadow: 0 2px 10px rgba(0,0,0,0.1);
                    }
                    
                    .dashboard-title-icon {
                      background: rgba(255, 255, 255, 0.2);
                      padding: 12px;
                      border-radius: 14px;
                      font-size: 1.3rem;
                    }
                    
                    .dashboard-subtitle {
                      color: rgba(255, 255, 255, 0.85);
                      font-size: 14px;
                      margin: 0;
                      display: flex;
                      align-items: center;
                      gap: 8px;
                    }
                    
                    .dashboard-subtitle i {
                      opacity: 0.8;
                    }
                    
                    .dashboard-hero-right {
                      display: flex;
                      flex-direction: column;
                      gap: 16px;
                      align-items: flex-end;
                    }
                    
                    .dashboard-date-card {
                      display: flex;
                      align-items: center;
                      gap: 12px;
                      background: rgba(255, 255, 255, 0.15);
                      backdrop-filter: blur(10px);
                      padding: 12px 18px;
                      border-radius: 14px;
                      border: 1px solid rgba(255, 255, 255, 0.2);
                    }
                    
                    .date-icon {
                      background: rgba(255, 255, 255, 0.2);
                      width: 40px;
                      height: 40px;
                      border-radius: 10px;
                      display: flex;
                      align-items: center;
                      justify-content: center;
                      color: #fff;
                      font-size: 16px;
                    }
                    
                    .date-info {
                      display: flex;
                      flex-direction: column;
                    }
                    
                    .date-label {
                      color: rgba(255, 255, 255, 0.7);
                      font-size: 11px;
                      font-weight: 600;
                      text-transform: uppercase;
                      letter-spacing: 0.5px;
                    }
                    
                    .date-value {
                      color: #fff;
                      font-size: 14px;
                      font-weight: 700;
                    }
                    
                    .dashboard-quick-stats {
                      display: flex;
                      align-items: center;
                      gap: 20px;
                      background: rgba(255, 255, 255, 0.15);
                      backdrop-filter: blur(10px);
                      padding: 14px 22px;
                      border-radius: 14px;
                      border: 1px solid rgba(255, 255, 255, 0.2);
                    }
                    
                    .quick-stat-item {
                      display: flex;
                      flex-direction: column;
                      align-items: center;
                      text-align: center;
                    }
                    
                    .quick-stat-value {
                      color: #fff;
                      font-size: 22px;
                      font-weight: 800;
                      line-height: 1;
                    }
                    
                    .quick-stat-label {
                      color: rgba(255, 255, 255, 0.75);
                      font-size: 11px;
                      font-weight: 600;
                      margin-top: 4px;
                      text-transform: uppercase;
                      letter-spacing: 0.3px;
                    }
                    
                    .quick-stat-divider {
                      width: 1px;
                      height: 36px;
                      background: rgba(255, 255, 255, 0.25);
                    }
                    
                    @media (max-width: 992px) {
                      .dashboard-hero-content {
                        flex-direction: column;
                        gap: 24px;
                        text-align: center;
                      }
                      
                      .dashboard-hero-right {
                        align-items: center;
                        flex-direction: row;
                        flex-wrap: wrap;
                        justify-content: center;
                      }
                      
                      .dashboard-title {
                        justify-content: center;
                        font-size: 1.8rem;
                      }
                      
                      .dashboard-subtitle {
                        justify-content: center;
                      }
                      
                      .dashboard-greeting {
                        justify-content: center;
                      }
                    }
                    
                    @media (max-width: 576px) {
                      .dashboard-hero-header {
                        padding: 24px 20px;
                      }
                      
                      .dashboard-title {
                        font-size: 1.5rem;
                        flex-direction: column;
                        gap: 10px;
                      }
                      
                      .dashboard-hero-right {
                        flex-direction: column;
                      }
                      
                      .dashboard-quick-stats {
                        width: 100%;
                        justify-content: center;
                      }
                    }
                  </style>
                  
                  <script>
                    // Set current date
                    document.addEventListener('DOMContentLoaded', function() {
                      const dateEl = document.getElementById('currentDate');
                      if (dateEl) {
                        const options = { weekday: 'short', month: 'short', day: 'numeric', year: 'numeric' };
                        dateEl.textContent = new Date().toLocaleDateString('en-US', options);
                      }
                    });
                  </script>

                  <!-- KPI Stats Cards (Horizontal Layout) -->
                  <div class="row g-4 mb-4 dashboard-kpi">
                    <!-- Total Students -->
                    <div class="col-12 col-lg-4 col-md-6">
                      <div class="card shadow-sm h-100"
                        style="border-radius: 16px; border: 1px solid rgba(0, 0, 0, 0.05); transition: all 0.3s ease;">
                        <div class="card-body" style="padding: 24px;">
                          <div class="d-flex align-items-center">
                            <div class="kpi-icon"
                              style="background-color: rgba(58, 146, 189, 0.1); color: #3a92bd; width: 56px; height: 56px; display: flex; align-items: center; justify-content: center; border-radius: 14px; font-size: 1.5rem; margin-right: 16px;">
                              <i class="fas fa-users"></i>
                            </div>
                            <div class="flex-grow-1">
                              <div class="text-muted small"
                                style="color: #64748b; font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">
                                Total Students</div>
                              <div class="d-flex align-items-center gap-2 flex-wrap">
                                <span class="fs-4 fw-bold"
                                  style="color: var(--admin-text-light); font-size: 28px; font-weight: 700;">
                                  <%= dashboardData.students.total || 0 %>
                                </span>
                                <% const studentGrowth = dashboardData.students.growth; %>
                                <% if (studentGrowth > 0) { %>
                                  <span class="badge"
                                    style="background: rgba(16, 185, 129, 0.12); color: #0f9f6e; font-size: 11px; font-weight: 600; padding: 4px 8px; border-radius: 6px;">
                                    â–² <%= studentGrowth %>% vs prev 30d
                                  </span>
                                  <% } else if (studentGrowth < 0) { %>
                                    <span class="badge"
                                      style="background: rgba(239, 68, 68, 0.1); color: #dc2626; font-size: 11px; font-weight: 600; padding: 4px 8px; border-radius: 6px;">
                                      â–¼ <%= Math.abs(studentGrowth) %>% vs prev 30d
                                    </span>
                                    <% } else { %>
                                      <span class="badge"
                                        style="background: rgba(100, 116, 139, 0.1); color: #475569; font-size: 11px; font-weight: 600; padding: 4px 8px; border-radius: 6px;">
                                        â€¢ Stable vs prev 30d
                                      </span>
                                      <% } %>
                              </div>
                              <div class="text-muted" style="font-size: 11px; margin-top: 4px;">Active: <%= 
                                  dashboardData.students.active || 0 %> â€¢ New (30d): <%= dashboardData.students.newThisMonth
                                    || 0 %>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- Total Courses -->
                    <div class="col-12 col-lg-4 col-md-6">
                      <div class="card shadow-sm h-100"
                        style="border-radius: 16px; border: 1px solid rgba(0, 0, 0, 0.05); transition: all 0.3s ease;">
                        <div class="card-body" style="padding: 24px;">
                          <div class="d-flex align-items-center">
                            <div class="kpi-icon"
                              style="background-color: rgba(58, 146, 189, 0.12); color: #3a92bd; width: 56px; height: 56px; display: flex; align-items: center; justify-content: center; border-radius: 14px; font-size: 1.5rem; margin-right: 16px;">
                              <i class="fas fa-graduation-cap"></i>
                            </div>
                            <div class="flex-grow-1">
                              <div class="text-muted small"
                                style="color: #64748b; font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">
                                Total Courses</div>
                              <div class="d-flex align-items-center gap-2 flex-wrap">
                                <span class="fs-4 fw-bold"
                                  style="color: var(--admin-text-light); font-size: 28px; font-weight: 700;">
                                  <%= dashboardData.courses.total || 0 %>
                                </span>
                                <% const courseGrowth = dashboardData.courses.growth; %>
                                <% if (courseGrowth > 0) { %>
                                  <span class="badge"
                                    style="background: rgba(16, 185, 129, 0.12); color: #0f9f6e; font-size: 11px; font-weight: 600; padding: 4px 8px; border-radius: 6px;">
                                    â–² <%= courseGrowth %>% vs prev 30d
                                  </span>
                                  <% } else if (courseGrowth < 0) { %>
                                    <span class="badge"
                                      style="background: rgba(239, 68, 68, 0.1); color: #dc2626; font-size: 11px; font-weight: 600; padding: 4px 8px; border-radius: 6px;">
                                      â–¼ <%= Math.abs(courseGrowth) %>% vs prev 30d
                                    </span>
                                    <% } else { %>
                                      <span class="badge"
                                        style="background: rgba(100, 116, 139, 0.1); color: #475569; font-size: 11px; font-weight: 600; padding: 4px 8px; border-radius: 6px;">
                                        â€¢ Stable vs prev 30d
                                      </span>
                                      <% } %>
                              </div>
                              <div class="text-muted" style="font-size: 11px; margin-top: 4px;">Published: <%= 
                                  dashboardData.courses.published || 0 %> â€¢ Draft: <%= dashboardData.courses.draft || 0
                                    %>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- Engagement Score -->
                    <div class="col-12 col-lg-4 col-md-6">
                      <div class="card shadow-sm h-100"
                        style="border-radius: 16px; border: 1px solid rgba(0, 0, 0, 0.05); transition: all 0.3s ease;">
                        <div class="card-body" style="padding: 24px;">
                          <div class="d-flex align-items-center">
                            <div class="kpi-icon"
                              style="background-color: rgba(58, 146, 189, 0.12); color: #3a92bd; width: 56px; height: 56px; display: flex; align-items: center; justify-content: center; border-radius: 14px; font-size: 1.5rem; margin-right: 16px;">
                              <i class="fas fa-chart-line"></i>
                            </div>
                            <div class="flex-grow-1">
                              <div class="text-muted small"
                                style="color: #64748b; font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">
                                Engagement</div>
                              <div class="d-flex align-items-center gap-2">
                                <span class="fs-4 fw-bold"
                                  style="color: var(--admin-text-light); font-size: 28px; font-weight: 700;">
                                  <%= dashboardData.engagement.score || 0 %>%
                                </span>
                                <% if (dashboardData.engagement.trend==='up' ) { %>
                                  <span class="badge"
                                    style="background: rgba(16, 185, 129, 0.1); color: #10b981; font-size: 11px; font-weight: 600; padding: 4px 8px; border-radius: 6px;">
                                    <i class="fas fa-arrow-up" style="font-size: 9px;"></i> +<%=
                                      dashboardData.engagement.change || 0 %>%
                                  </span>
                                  <% } else if (dashboardData.engagement.trend==='down' ) { %>
                                    <span class="badge"
                                      style="background: rgba(239, 68, 68, 0.1); color: #ef4444; font-size: 11px; font-weight: 600; padding: 4px 8px; border-radius: 6px;">
                                      <i class="fas fa-arrow-down" style="font-size: 9px;"></i>
                                      <%= dashboardData.engagement.change || 0 %>%
                                    </span>
                                    <% } %>
                              </div>
                              <div class="text-muted" style="font-size: 11px; margin-top: 4px;">Active: <%=
                                  dashboardData.engagement.activeStudents || 0 %> students</div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Additional Stats Row -->
                  <div class="row g-4 mb-4">
                    <!-- Teachers Overview -->
                    <div class="col-12 col-lg-6">
                      <div class="card shadow-sm h-100"
                        style="border-radius: 16px; border: 1px solid rgba(0, 0, 0, 0.05);">
                        <div class="card-body" style="padding: 24px;">
                          <div class="d-flex align-items-center">
                            <div class="kpi-icon"
                              style="background-color: rgba(58, 146, 189, 0.12); color: #3a92bd; width: 56px; height: 56px; display: flex; align-items: center; justify-content: center; border-radius: 14px; font-size: 1.5rem; margin-right: 16px;">
                              <i class="fas fa-chalkboard-teacher"></i>
                            </div>
                            <div class="flex-grow-1">
                              <div class="text-muted small"
                                style="color: #64748b; font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">
                                Teachers</div>
                              <div class="d-flex align-items-center gap-2 flex-wrap">
                                <span class="fs-4 fw-bold"
                                  style="color: var(--admin-text-light); font-size: 28px; font-weight: 700;">
                                  <%= (dashboardData.teachers && dashboardData.teachers.total) || 0 %>
                                </span>
                                <span class="badge"
                                  style="background: rgba(16, 185, 129, 0.12); color: #0f9f6e; font-size: 11px; font-weight: 600; padding: 4px 8px; border-radius: 6px;">
                                  Active: <%= (dashboardData.teachers && dashboardData.teachers.active) || 0 %>
                                </span>
                              </div>
                              <div class="text-muted" style="font-size: 11px; margin-top: 4px;">New (30d): <%=
                                  (dashboardData.teachers && dashboardData.teachers.newThisMonth) || 0 %>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- Orders Overview -->
                    <div class="col-12 col-lg-6">
                      <div class="card shadow-sm h-100"
                        style="border-radius: 16px; border: 1px solid rgba(0, 0, 0, 0.05);">
                        <div class="card-body" style="padding: 24px;">
                          <div class="d-flex align-items-center">
                            <div class="kpi-icon"
                              style="background-color: rgba(58, 146, 189, 0.12); color: #3a92bd; width: 56px; height: 56px; display: flex; align-items: center; justify-content: center; border-radius: 14px; font-size: 1.5rem; margin-right: 16px;">
                              <i class="fas fa-shopping-cart"></i>
                            </div>
                            <div class="flex-grow-1">
                              <div class="text-muted small"
                                style="color: #64748b; font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">
                                Orders</div>
                              <div class="d-flex align-items-center gap-2 flex-wrap">
                                <span class="fs-4 fw-bold"
                                  style="color: var(--admin-text-light); font-size: 28px; font-weight: 700;">
                                  <%= dashboardData.revenue.orders || 0 %>
                                </span>
                                <% if (dashboardData.newOrdersCount> 0) { %>
                                  <span class="badge"
                                    style="background: rgba(239, 68, 68, 0.1); color: #ef4444; font-size: 11px; font-weight: 600; padding: 4px 8px; border-radius: 6px;">
                                    <%= dashboardData.newOrdersCount %> new (24h)
                                  </span>
                                  <% } %>
                              </div>
                              <div class="text-muted" style="font-size: 11px; margin-top: 4px;">Revenue last 30 days: AED
                                <%= dashboardData.revenue.thisMonth || 0 %>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>

1                  <!-- Top Performing Teachers (at top) -->
                  <div class="card shadow-sm mb-4 dashboard-teachers-card" style="border-radius: 16px; border: 1px solid rgba(58, 146, 189, 0.15); overflow: hidden;">
                    <div class="card-header" style="background: linear-gradient(135deg, #3a92bd, #0c5374); border-bottom: none; padding: 20px 24px;">
                      <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
                        <h5 class="mb-0" style="color: #ffffff; font-weight: 700; display: flex; align-items: center; gap: 12px;">
                          <i class="fas fa-chalkboard-teacher"></i> Top Performing Teachers
                        </h5>
                        <div class="d-flex align-items-center gap-2 flex-wrap">
                          <span class="badge" style="background: rgba(255, 255, 255, 0.2); color: white; border: 1px solid rgba(255, 255, 255, 0.3); padding: 8px 16px; border-radius: 20px; font-size: 12px; font-weight: 600;">
                            <%= (dashboardData.teachers && dashboardData.teachers.total) || 0 %> Total Teachers
                          </span>
                        </div>
                      </div>
                    </div>
                    
                    <!-- Commission Summary Cards -->
                    <div class="dashboard-teachers-commission-wrap" style="background: rgba(58, 146, 189, 0.03); padding: 20px 24px; border-bottom: 1px solid rgba(58, 146, 189, 0.1);">
                      <div class="row g-3">
                        <div class="col-12 col-sm-6 col-lg-3">
                          <div class="dashboard-teachers-metric-card" style="background: linear-gradient(135deg, #ffffff, #f8fafc); border-radius: 12px; padding: 16px; border: 1px solid rgba(58, 146, 189, 0.15); height: 100%;">
                            <div class="d-flex align-items-center gap-3">
                              <div style="width: 44px; height: 44px; border-radius: 10px; background: linear-gradient(135deg, #10b981, #059669); display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-coins" style="color: white; font-size: 18px;"></i>
                              </div>
                              <div>
                                <div class="dashboard-teachers-metric-label" style="font-size: 11px; color: #64748b; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Total Revenue</div>
                                <div style="font-size: 20px; font-weight: 700; color: #10b981;">AED <%= ((dashboardData.teachers?.commissionTotals?.totalRevenue) || 0).toLocaleString() %></div>
                              </div>
                            </div>
                          </div>
                        </div>
                        <div class="col-12 col-sm-6 col-lg-3">
                          <div class="dashboard-teachers-metric-card" style="background: linear-gradient(135deg, #ffffff, #f8fafc); border-radius: 12px; padding: 16px; border: 1px solid rgba(58, 146, 189, 0.15); height: 100%;">
                            <div class="d-flex align-items-center gap-3">
                              <div style="width: 44px; height: 44px; border-radius: 10px; background: linear-gradient(135deg, #3a92bd, #0c5374); display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-percentage" style="color: white; font-size: 18px;"></i>
                              </div>
                              <div>
                                <div class="dashboard-teachers-metric-label" style="font-size: 11px; color: #64748b; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">G-Teacher Commission</div>
                                <div style="font-size: 20px; font-weight: 700; color: #3a92bd;">AED <%= ((dashboardData.teachers?.commissionTotals?.totalGTeacherCommission) || 0).toLocaleString() %></div>
                              </div>
                            </div>
                          </div>
                        </div>
                        <div class="col-12 col-sm-6 col-lg-3">
                          <div class="dashboard-teachers-metric-card" style="background: linear-gradient(135deg, #ffffff, #f8fafc); border-radius: 12px; padding: 16px; border: 1px solid rgba(58, 146, 189, 0.15); height: 100%;">
                            <div class="d-flex align-items-center gap-3">
                              <div style="width: 44px; height: 44px; border-radius: 10px; background: linear-gradient(135deg, #f59e0b, #d97706); display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-hand-holding-usd" style="color: white; font-size: 18px;"></i>
                              </div>
                              <div>
                                <div class="dashboard-teachers-metric-label" style="font-size: 11px; color: #64748b; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Teacher Net</div>
                                <div style="font-size: 20px; font-weight: 700; color: #f59e0b;">AED <%= ((dashboardData.teachers?.commissionTotals?.totalTeacherNet) || 0).toLocaleString() %></div>
                              </div>
                            </div>
                          </div>
                        </div>
                        <div class="col-12 col-sm-6 col-lg-3">
                          <div class="dashboard-teachers-metric-card" style="background: linear-gradient(135deg, #ffffff, #f8fafc); border-radius: 12px; padding: 16px; border: 1px solid rgba(58, 146, 189, 0.15); height: 100%;">
                            <div class="d-flex align-items-center gap-3">
                              <div style="width: 44px; height: 44px; border-radius: 10px; background: linear-gradient(135deg, #8b5cf6, #7c3aed); display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-receipt" style="color: white; font-size: 18px;"></i>
                              </div>
                              <div>
                                <div class="dashboard-teachers-metric-label" style="font-size: 11px; color: #64748b; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Total Sales</div>
                                <div style="font-size: 20px; font-weight: 700; color: #8b5cf6;"><%= ((dashboardData.teachers?.commissionTotals?.totalOrders) || 0).toLocaleString() %></div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                    
                    <!-- Filter & Sort Controls -->
                    <div class="dashboard-teachers-filters" style="padding: 16px 24px; background: white; border-bottom: 1px solid rgba(226, 232, 240, 0.8);">
                      <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
                        <div class="d-flex align-items-center gap-2 flex-wrap">
                          <span class="dashboard-teachers-sort-label" style="font-size: 12px; color: #64748b; font-weight: 600;">Sort by:</span>
                          <div class="btn-group" role="group" id="teacherSortBtns">
                            <button type="button" class="btn btn-sm teacher-sort-btn active" data-sort="revenue" style="padding: 6px 12px; font-size: 12px; border-radius: 6px 0 0 6px; background: #3a92bd; color: white; border: 1px solid #3a92bd;">
                              <i class="fas fa-coins me-1"></i> Revenue
                            </button>
                            <button type="button" class="btn btn-sm teacher-sort-btn" data-sort="commission" style="padding: 6px 12px; font-size: 12px; background: white; color: #3a92bd; border: 1px solid #e2e8f0;">
                              <i class="fas fa-percentage me-1"></i> Commission
                            </button>
                            <button type="button" class="btn btn-sm teacher-sort-btn" data-sort="net" style="padding: 6px 12px; font-size: 12px; background: white; color: #3a92bd; border: 1px solid #e2e8f0;">
                              <i class="fas fa-hand-holding-usd me-1"></i> Net
                            </button>
                            <button type="button" class="btn btn-sm teacher-sort-btn" data-sort="students" style="padding: 6px 12px; font-size: 12px; border-radius: 0 6px 6px 0; background: white; color: #3a92bd; border: 1px solid #e2e8f0;">
                              <i class="fas fa-users me-1"></i> Students
                            </button>
                          </div>
                        </div>
                        <div class="d-flex align-items-center gap-2">
                          <div class="position-relative">
                            <input type="text" id="teacherSearchInput" class="form-control form-control-sm dashboard-teachers-search-input" placeholder="Search teachers..." 
                              style="padding: 6px 12px 6px 32px; font-size: 12px; border-radius: 6px; border: 1px solid #e2e8f0; min-width: 200px;">
                            <i class="fas fa-search dashboard-teachers-search-icon" style="position: absolute; left: 10px; top: 50%; transform: translateY(-50%); color: #94a3b8; font-size: 12px;"></i>
                          </div>
                          <select id="teacherSubjectFilter" class="form-select form-select-sm dashboard-teachers-subject-select" style="padding: 6px 32px 6px 12px; font-size: 12px; border-radius: 6px; border: 1px solid #e2e8f0; min-width: 120px;">
                            <option value="">All Subjects</option>
                            <% const subjects = [...new Set((dashboardData.teachers?.allTeachers || []).map(t => t.subject).filter(Boolean))]; %>
                            <% subjects.forEach(subject => { %>
                              <option value="<%= subject %>"><%= subject %></option>
                            <% }); %>
                          </select>
                        </div>
                      </div>
                    </div>

                    <div class="card-body" style="padding: 0;">
                      <% const teachersList = (dashboardData.teachers && dashboardData.teachers.list) || []; %>
                      <% if (teachersList.length > 0) { %>
                        <div class="table-responsive">
                          <table class="table table-hover mb-0 dashboard-teachers-table" id="teachersPerformanceTable" style="margin: 0;">
                            <thead class="dashboard-teachers-thead" style="background: rgba(58, 146, 189, 0.06);">
                              <tr>
                                <th style="padding: 16px 20px; font-size: 11px; font-weight: 700; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px; border: none; width: 50px;">#</th>
                                <th style="padding: 16px 20px; font-size: 11px; font-weight: 700; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px; border: none;">Teacher</th>
                                <th style="padding: 16px 20px; font-size: 11px; font-weight: 700; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px; border: none; text-align: center;">Subject</th>
                                <th style="padding: 16px 20px; font-size: 11px; font-weight: 700; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px; border: none; text-align: center;">Courses</th>
                                <th style="padding: 16px 20px; font-size: 11px; font-weight: 700; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px; border: none; text-align: center;">Students</th>
                                <th style="padding: 16px 20px; font-size: 11px; font-weight: 700; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px; border: none; text-align: right;">Revenue</th>
                                <th style="padding: 16px 20px; font-size: 11px; font-weight: 700; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px; border: none; text-align: center;">Commission %</th>
                                <th style="padding: 16px 20px; font-size: 11px; font-weight: 700; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px; border: none; text-align: right;">G-Teacher Fee</th>
                                <th style="padding: 16px 20px; font-size: 11px; font-weight: 700; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px; border: none; text-align: right;">Teacher Net</th>
                              </tr>
                            </thead>
                            <tbody id="teachersTableBody">
                              <% teachersList.forEach((teacher, index) => { %>
                                <tr class="teacher-row" 
                                    data-name="<%= teacher.name.toLowerCase() %>" 
                                    data-subject="<%= teacher.subject %>" 
                                    data-revenue="<%= teacher.revenue || 0 %>" 
                                    data-commission="<%= teacher.gTeacherCommission || 0 %>"
                                    data-net="<%= teacher.teacherNet || 0 %>"
                                    data-students="<%= teacher.studentsCount || 0 %>"
                                    style="border-bottom: 1px solid rgba(226, 232, 240, 0.8);">
                                  <td style="padding: 16px 20px; vertical-align: middle; border: none;">
                                    <% if (index === 0) { %>
                                      <span class="rank-badge rank-1" style="background: linear-gradient(135deg, #fbbf24, #f59e0b); color: white; width: 32px; height: 32px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; font-weight: 700; font-size: 14px; box-shadow: 0 2px 8px rgba(245, 158, 11, 0.4);">
                                        <i class="fas fa-crown" style="font-size: 12px;"></i>
                                      </span>
                                    <% } else if (index === 1) { %>
                                      <span class="rank-badge rank-2" style="background: linear-gradient(135deg, #94a3b8, #64748b); color: white; width: 32px; height: 32px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; font-weight: 700; font-size: 14px;">2</span>
                                    <% } else if (index === 2) { %>
                                      <span class="rank-badge rank-3" style="background: linear-gradient(135deg, #cd7f32, #b8860b); color: white; width: 32px; height: 32px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; font-weight: 700; font-size: 14px;">3</span>
                                    <% } else { %>
                                      <span style="background: rgba(58, 146, 189, 0.1); color: #3a92bd; width: 32px; height: 32px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; font-weight: 600; font-size: 14px;"><%= index + 1 %></span>
                                    <% } %>
                                  </td>
                                  <td style="padding: 16px 20px; vertical-align: middle; border: none;">
                                    <div style="display: flex; align-items: center; gap: 12px;">
                                      <% if (teacher.profilePicture) { %>
                                        <img src="<%= teacher.profilePicture %>" alt="<%= teacher.name %>" style="width: 44px; height: 44px; border-radius: 12px; object-fit: cover; border: 2px solid rgba(58, 146, 189, 0.2);">
                                      <% } else { %>
                                        <div style="width: 44px; height: 44px; border-radius: 12px; background: linear-gradient(135deg, #3a92bd, #0c5374); color: white; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 14px;">
                                          <%= teacher.initials %>
                                        </div>
                                      <% } %>
                                      <div>
                                        <div class="dashboard-teachers-text-primary" style="font-weight: 600; color: #1e293b; font-size: 14px;"><%= teacher.name %></div>
                                        <div class="dashboard-teachers-text-muted" style="font-size: 12px; color: #94a3b8;"><%= teacher.teacherCode %></div>
                                      </div>
                                    </div>
                                  </td>
                                  <td style="padding: 16px 20px; vertical-align: middle; border: none; text-align: center;">
                                    <span class="dashboard-teachers-badge" style="background: rgba(58, 146, 189, 0.12); color: #0c5374; padding: 6px 12px; border-radius: 8px; font-size: 12px; font-weight: 600;">
                                      <%= teacher.subject %>
                                    </span>
                                  </td>
                                  <td style="padding: 16px 20px; vertical-align: middle; border: none; text-align: center;">
                                    <div class="dashboard-teachers-text-primary" style="font-weight: 700; color: #1e293b; font-size: 16px;"><%= teacher.coursesCount %></div>
                                    <div class="dashboard-teachers-text-muted" style="font-size: 11px; color: #94a3b8;"><%= teacher.publishedCourses %> published</div>
                                  </td>
                                  <td style="padding: 16px 20px; vertical-align: middle; border: none; text-align: center;">
                                    <div class="dashboard-teachers-text-primary" style="font-weight: 700; color: #1e293b; font-size: 16px;"><%= teacher.studentsCount %></div>
                                    <div class="dashboard-teachers-text-muted" style="font-size: 11px; color: #94a3b8;">enrolled</div>
                                  </td>
                                  <td style="padding: 16px 20px; vertical-align: middle; border: none; text-align: right;">
                                    <div style="font-weight: 700; color: #10b981; font-size: 15px;">AED <%= (teacher.revenue || 0).toLocaleString() %></div>
                                  </td>
                                  <td style="padding: 16px 20px; vertical-align: middle; border: none; text-align: center;">
                                    <span style="background: rgba(139, 92, 246, 0.12); color: #7c3aed; padding: 6px 12px; border-radius: 20px; font-size: 13px; font-weight: 700;">
                                      <%= teacher.gTeacherPercentage || 0 %>%
                                    </span>
                                  </td>
                                  <td style="padding: 16px 20px; vertical-align: middle; border: none; text-align: right;">
                                    <div style="font-weight: 700; color: #3a92bd; font-size: 15px;">AED <%= (teacher.gTeacherCommission || 0).toLocaleString() %></div>
                                  </td>
                                  <td style="padding: 16px 20px; vertical-align: middle; border: none; text-align: right;">
                                    <div style="font-weight: 700; color: #f59e0b; font-size: 15px;">AED <%= (teacher.teacherNet || 0).toLocaleString() %></div>
                                  </td>
                                </tr>
                              <% }); %>
                            </tbody>
                          </table>
                        </div>
                      <% } else { %>
                        <div class="dashboard-teachers-empty" style="padding: 48px; text-align: center; color: #64748b;">
                          <i class="fas fa-chalkboard-teacher" style="font-size: 48px; color: rgba(58, 146, 189, 0.3); margin-bottom: 16px;"></i>
                          <p style="margin: 0; font-size: 14px;">No teachers found. Add teachers to see performance data.</p>
                        </div>
                      <% } %>
                    </div>
                  </div>

                  <!-- Teacher Table Sorting/Filtering Script -->
                  <script>
                    document.addEventListener('DOMContentLoaded', function() {
                      const sortBtns = document.querySelectorAll('.teacher-sort-btn');
                      const searchInput = document.getElementById('teacherSearchInput');
                      const subjectFilter = document.getElementById('teacherSubjectFilter');
                      const tableBody = document.getElementById('teachersTableBody');
                      
                      if (!tableBody) return;
                      
                      // Function to update rank badges based on current visible order
                      function updateRankBadges(visibleRows) {
                        visibleRows.forEach((row, index) => {
                          const rankCell = row.querySelector('td:first-child');
                          if (!rankCell) return;
                          
                          let badgeHtml = '';
                          if (index === 0) {
                            badgeHtml = '<span class="rank-badge rank-1" style="background: linear-gradient(135deg, #fbbf24, #f59e0b); color: white; width: 32px; height: 32px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; font-weight: 700; font-size: 14px; box-shadow: 0 2px 8px rgba(245, 158, 11, 0.4);"><i class="fas fa-crown" style="font-size: 12px;"></i></span>';
                          } else if (index === 1) {
                            badgeHtml = '<span class="rank-badge rank-2" style="background: linear-gradient(135deg, #94a3b8, #64748b); color: white; width: 32px; height: 32px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; font-weight: 700; font-size: 14px;">2</span>';
                          } else if (index === 2) {
                            badgeHtml = '<span class="rank-badge rank-3" style="background: linear-gradient(135deg, #cd7f32, #b8860b); color: white; width: 32px; height: 32px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; font-weight: 700; font-size: 14px;">3</span>';
                          } else {
                            badgeHtml = '<span style="background: rgba(58, 146, 189, 0.1); color: #3a92bd; width: 32px; height: 32px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; font-weight: 600; font-size: 14px;">' + (index + 1) + '</span>';
                          }
                          rankCell.innerHTML = badgeHtml;
                        });
                      }
                      
                      function filterAndSortTable() {
                        const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
                        const selectedSubject = subjectFilter ? subjectFilter.value : '';
                        const activeSort = document.querySelector('.teacher-sort-btn.active');
                        const sortBy = activeSort ? activeSort.dataset.sort : 'revenue';
                        
                        const rows = Array.from(tableBody.querySelectorAll('.teacher-row'));
                        
                        // Filter rows
                        rows.forEach(row => {
                          const name = row.dataset.name || '';
                          const subject = row.dataset.subject || '';
                          const matchesSearch = name.includes(searchTerm);
                          const matchesSubject = !selectedSubject || subject === selectedSubject;
                          row.style.display = (matchesSearch && matchesSubject) ? '' : 'none';
                        });
                        
                        // Sort visible rows
                        const visibleRows = rows.filter(r => r.style.display !== 'none');
                        visibleRows.sort((a, b) => {
                          const aVal = parseFloat(a.dataset[sortBy]) || 0;
                          const bVal = parseFloat(b.dataset[sortBy]) || 0;
                          return bVal - aVal;
                        });
                        
                        // Re-append in sorted order
                        visibleRows.forEach((row) => {
                          tableBody.appendChild(row);
                        });
                        
                        // Update rank badges based on new order
                        updateRankBadges(visibleRows);
                      }
                      
                      // Bind events
                      sortBtns.forEach(btn => {
                        btn.addEventListener('click', function() {
                          sortBtns.forEach(b => {
                            b.classList.remove('active');
                            b.style.background = 'white';
                            b.style.color = '#3a92bd';
                          });
                          this.classList.add('active');
                          this.style.background = '#3a92bd';
                          this.style.color = 'white';
                          filterAndSortTable();
                        });
                      });
                      
                      if (searchInput) {
                        searchInput.addEventListener('input', filterAndSortTable);
                      }
                      
                      if (subjectFilter) {
                        subjectFilter.addEventListener('change', filterAndSortTable);
                      }
                    });
                  </script>

                  <!-- Analytics Charts Section -->
                  <div class="row g-4 mb-4">
                    <!-- Student Growth Chart -->
                    <div class="col-12 col-lg-6">
                      <div class="card shadow-sm"
                        style="border-radius: 16px; border: 1px solid rgba(0, 0, 0, 0.05); overflow: hidden;">
                        <div class="card-header"
                          style="background: linear-gradient(135deg, #3a92bd, #0c5374); border-bottom: none; padding: 20px 24px;">
                          <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"
                              style="color: #ffffff; font-weight: 700; display: flex; align-items: center; gap: 12px;">
                              <i class="fas fa-chart-line"></i> Student Growth Trend
                            </h5>
                            <div class="d-flex gap-1">
                              <button class="chart-period-btn btn btn-sm active" data-period="7d"
                                style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 6px 12px; border-radius: 6px; font-size: 12px; font-weight: 600;">7D</button>
                              <button class="chart-period-btn btn btn-sm" data-period="30d"
                                style="background: rgba(255,255,255,0.1); border: none; color: rgba(255,255,255,0.7); padding: 6px 12px; border-radius: 6px; font-size: 12px; font-weight: 600;">30D</button>
                              <button class="chart-period-btn btn btn-sm" data-period="90d"
                                style="background: rgba(255,255,255,0.1); border: none; color: rgba(255,255,255,0.7); padding: 6px 12px; border-radius: 6px; font-size: 12px; font-weight: 600;">90D</button>
                            </div>
                          </div>
                        </div>
                        <div class="card-body" style="padding: 24px; min-height: 300px;">
                          <div class="chart-loading" id="growthChartLoading"
                            style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 250px; color: #64748b;">
                            <i class="fas fa-chart-line fa-2x mb-3" style="color: #3a92bd;"></i>
                            <span>Loading growth data...</span>
                          </div>
                          <canvas id="growthChart" style="display: none;"></canvas>
                        </div>
                      </div>
                    </div>

                    <!-- Revenue Chart -->
                    <div class="col-12 col-lg-6">
                      <div class="card shadow-sm"
                        style="border-radius: 16px; border: 1px solid rgba(0, 0, 0, 0.05); overflow: hidden;">
                        <div class="card-header"
                          style="background: linear-gradient(135deg, #3a92bd, #0c5374); border-bottom: none; padding: 20px 24px;">
                          <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"
                              style="color: #ffffff; font-weight: 700; display: flex; align-items: center; gap: 12px;">
                              <i class="fas fa-coins"></i> Revenue Analytics
                            </h5>
                            <div class="d-flex gap-1">
                              <button class="chart-period-btn btn btn-sm active" data-period="7d"
                                style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 6px 12px; border-radius: 6px; font-size: 12px; font-weight: 600;">7D</button>
                              <button class="chart-period-btn btn btn-sm" data-period="30d"
                                style="background: rgba(255,255,255,0.1); border: none; color: rgba(255,255,255,0.7); padding: 6px 12px; border-radius: 6px; font-size: 12px; font-weight: 600;">30D</button>
                              <button class="chart-period-btn btn btn-sm" data-period="90d"
                                style="background: rgba(255,255,255,0.1); border: none; color: rgba(255,255,255,0.7); padding: 6px 12px; border-radius: 6px; font-size: 12px; font-weight: 600;">90D</button>
                            </div>
                          </div>
                        </div>
                        <div class="card-body" style="padding: 24px; min-height: 300px;">
                          <div class="chart-loading" id="revenueChartLoading"
                            style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 250px; color: #64748b;">
                            <i class="fas fa-coins fa-2x mb-3" style="color: #3a92bd;"></i>
                            <span>Loading revenue data...</span>
                          </div>
                          <canvas id="revenueChart" style="display: none;"></canvas>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Course Performance Section -->
                  <div class="course-performance-section">
                    <div class="course-performance-header">
                      <h3 class="course-performance-title">Top Performing Courses</h3>
                      <div class="course-performance-filters">
                        <button class="course-filter-btn active" data-filter="all">All Courses</button>
                        <button class="course-filter-btn" data-filter="published">Published</button>
                        <button class="course-filter-btn" data-filter="draft">Draft</button>
                        <button class="course-filter-btn" data-filter="featured">Featured</button>
                      </div>
                    </div>
                    <div class="course-performance-grid">
                      <% if (dashboardData.topCourses && dashboardData.topCourses.length> 0) { %>
                        <% dashboardData.topCourses.forEach((course, index)=> { %>
                          <div class="course-performance-card <%= course.featured ? 'featured' : '' %>"
                            data-status="<%= course.status %>" data-featured="<%= course.featured %>">
                            <div class="course-performance-header-card">
                              <div class="course-performance-info">
                                <h4>
                                  <%= course.title %>
                                    <% if (course.featured) { %> <span class="featured-badge">â­</span>
                                      <% } %>
                                </h4>
                                <p style="margin: 0; color: #6b7280; font-size: 12px;">
                                  <i class="fas fa-user" style="margin-right: 6px;"></i>
                                  <%= course.teacherName %>
                                  <% if (course.teacherSubject) { %>
                                    â€¢ <%= course.teacherSubject %>
                                  <% } %>
                                </p>
                              </div>
                              <div class="course-performance-badge">
                                <span class="badge badge-<%= course.status === 'published' ? 'success' : 'warning' %>">
                                  <%= course.status %>
                                </span>
                                <% if (course.featured) { %>
                                  <span class="badge badge-primary">Featured</span>
                                  <% } %>
                              </div>
                            </div>
                            <div class="course-performance-stats">
                              <div class="course-stat-item">
                                <div class="course-stat-value">
                                  <%= course.enrollments %>
                                </div>
                                <div class="course-stat-label">Enrollments</div>
                              </div>
                              <div class="course-stat-item">
                                <div class="course-stat-value">
                                  <%= course.completionRate %>%
                                </div>
                                <div class="course-stat-label">Completion</div>
                              </div>
                              <div class="course-stat-item">
                                <div class="course-stat-value">
                                  AED <%= course.revenue %>
                                </div>
                                <div class="course-stat-label">Revenue</div>
                              </div>
                            </div>
                          </div>
                          <% }); %>
                            <% } else { %>
                              <div class="course-performance-card">
                                <div class="course-performance-header-card">
                                  <div class="course-performance-info">
                                    <h4>No courses available</h4>
                                    <p>Create your first course to see performance data</p>
                                  </div>
                                </div>
                              </div>
                              <% } %>
                    </div>
                  </div>


                  <!-- Platform Summary Cards -->
                  <div class="row g-4 mb-4">
                    <!-- Quiz & Content Stats -->
                    <div class="col-12 col-lg-4">
                      <div class="card shadow-sm h-100" style="border-radius: 16px; border: 1px solid rgba(0, 0, 0, 0.05);">
                        <div class="card-body" style="padding: 24px;">
                          <div class="d-flex align-items-center mb-3">
                            <div style="background-color: rgba(58, 146, 189, 0.12); color: #3a92bd; width: 48px; height: 48px; display: flex; align-items: center; justify-content: center; border-radius: 12px; font-size: 1.25rem; margin-right: 14px;">
                              <i class="fas fa-book-open"></i>
                            </div>
                            <div>
                              <div style="font-size: 12px; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px;">Content Progress</div>
                              <div style="font-size: 24px; font-weight: 700; color: var(--admin-text-light);"><%= dashboardData.engagement.completion || 0 %>%</div>
                            </div>
                          </div>
                          <div style="display: flex; justify-content: space-between; padding-top: 12px; border-top: 1px solid #f1f5f9;">
                            <div style="text-align: center;">
                              <div style="font-size: 18px; font-weight: 700; color: #1e293b;"><%= dashboardData.engagement.totalEnrolled || 0 %></div>
                              <div style="font-size: 11px; color: #94a3b8;">Enrolled</div>
                            </div>
                            <div style="text-align: center;">
                              <div style="font-size: 18px; font-weight: 700; color: #1e293b;"><%= dashboardData.engagement.studentsWithProgress || 0 %></div>
                              <div style="font-size: 11px; color: #94a3b8;">In Progress</div>
                            </div>
                            <div style="text-align: center;">
                              <div style="font-size: 18px; font-weight: 700; color: #10b981;"><%= dashboardData.engagement.activeStudents || 0 %></div>
                              <div style="font-size: 11px; color: #94a3b8;">Active</div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- WhatsApp Status -->
                    <div class="col-12 col-lg-4">
                      <div class="card shadow-sm h-100" style="border-radius: 16px; border: 1px solid rgba(0, 0, 0, 0.05);">
                        <div class="card-body" style="padding: 24px;">
                          <div class="d-flex align-items-center mb-3">
                            <div style="background-color: rgba(37, 211, 102, 0.1); color: #25d366; width: 48px; height: 48px; display: flex; align-items: center; justify-content: center; border-radius: 12px; font-size: 1.25rem; margin-right: 14px;">
                              <i class="fab fa-whatsapp"></i>
                            </div>
                            <div class="flex-grow-1">
                              <div style="font-size: 12px; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px;">WhatsApp Integration</div>
                              <div style="display: flex; align-items: center; gap: 8px; margin-top: 4px;">
                                <% if (dashboardData.whatsappStatus === 'connected') { %>
                                  <span style="width: 10px; height: 10px; background: #10b981; border-radius: 50%; display: inline-block;"></span>
                                  <span style="font-size: 16px; font-weight: 700; color: #10b981;">Connected</span>
                                <% } else { %>
                                  <span style="width: 10px; height: 10px; background: #ef4444; border-radius: 50%; display: inline-block;"></span>
                                  <span style="font-size: 16px; font-weight: 700; color: #ef4444;">Disconnected</span>
                                <% } %>
                              </div>
                            </div>
                          </div>
                          <div style="display: flex; gap: 8px; padding-top: 12px; border-top: 1px solid #f1f5f9;">
                            <a href="/admin/bulk-sms" style="flex: 1; text-align: center; background: #25d366; color: white; padding: 10px; border-radius: 8px; text-decoration: none; font-size: 13px; font-weight: 600;">
                              <i class="fas fa-paper-plane" style="margin-right: 6px;"></i> Send SMS
                            </a>
                            <a href="/admin/whatsapp" style="flex: 1; text-align: center; background: #f1f5f9; color: #475569; padding: 10px; border-radius: 8px; text-decoration: none; font-size: 13px; font-weight: 600;">
                              <i class="fas fa-cog" style="margin-right: 6px;"></i> Settings
                            </a>
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- Quick Actions -->
                    <div class="col-12 col-lg-4">
                      <div class="card shadow-sm h-100" style="border-radius: 16px; border: 1px solid rgba(0, 0, 0, 0.05);">
                        <div class="card-body" style="padding: 24px;">
                          <div class="d-flex align-items-center mb-3">
                            <div style="background-color: rgba(58, 146, 189, 0.12); color: #3a92bd; width: 48px; height: 48px; display: flex; align-items: center; justify-content: center; border-radius: 12px; font-size: 1.25rem; margin-right: 14px;">
                              <i class="fas fa-bolt"></i>
                            </div>
                            <div>
                              <div style="font-size: 12px; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px;">Quick Actions</div>
                              <div style="font-size: 14px; color: #64748b;">Manage your platform</div>
                            </div>
                          </div>
                          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; padding-top: 12px; border-top: 1px solid #f1f5f9;">
                            <a href="/admin/courses/new" style="text-align: center; background: #f1f5f9; color: #475569; padding: 12px 8px; border-radius: 8px; text-decoration: none; font-size: 12px; font-weight: 600;">
                              <i class="fas fa-plus" style="display: block; margin-bottom: 4px; color: #3b82f6;"></i> New Course
                            </a>
                            <a href="/admin/students" style="text-align: center; background: #f1f5f9; color: #475569; padding: 12px 8px; border-radius: 8px; text-decoration: none; font-size: 12px; font-weight: 600;">
                              <i class="fas fa-users" style="display: block; margin-bottom: 4px; color: #10b981;"></i> Students
                            </a>
                            <a href="/admin/orders" style="text-align: center; background: #f1f5f9; color: #475569; padding: 12px 8px; border-radius: 8px; text-decoration: none; font-size: 12px; font-weight: 600;">
                              <i class="fas fa-receipt" style="display: block; margin-bottom: 4px; color: #f59e0b;"></i> Orders
                            </a>
                            <a href="/admin/promo-codes" style="text-align: center; background: #f1f5f9; color: #475569; padding: 12px 8px; border-radius: 8px; text-decoration: none; font-size: 12px; font-weight: 600;">
                              <i class="fas fa-tags" style="display: block; margin-bottom: 4px; color: #ec4899;"></i> Promo Codes
                            </a>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>

            </div>
          </div>

      </main>
  </div>

  <%- include('./partials/admin-footer') %>

    <script>
      // Dashboard JavaScript
      document.addEventListener('DOMContentLoaded', function () {
        // Initialize charts
        initializeCharts();

        // Initialize chart period controls
        initializeChartControls();

        // Initialize course filters
        initializeCourseFilters();
      });

      // Global chart instances
      let growthChartInstance = null;
      let revenueChartInstance = null;

      // Chart initialization with real data
      function initializeCharts() {
        // Get real data from the server
        const dashboardData = <%- JSON.stringify(dashboardData) %>;

        // Initialize with 30 days period by default
        loadChartData(30, dashboardData);
      }

      // Load chart data from API
      async function loadChartData(days = 30, cachedData = null) {
        try {
          // Show loading states
          document.getElementById('growthChartLoading').style.display = 'flex';
          document.getElementById('revenueChartLoading').style.display = 'flex';
          document.getElementById('growthChart').style.display = 'none';
          document.getElementById('revenueChart').style.display = 'none';

          // Fetch data from API
          const response = await fetch(`/admin/dashboard/chart-data?days=${days}`);
          const data = await response.json();

          // Update charts with new data
          updateGrowthChart(data.studentGrowth || []);
          updateRevenueChart(data.revenueData || []);

        } catch (error) {
          console.error('Error loading chart data:', error);
          // Fallback to cached data if available
          if (cachedData) {
            updateGrowthChart(cachedData.charts?.studentGrowth || []);
            updateRevenueChart(cachedData.charts?.revenueData || []);
          }
        }
      }

      // Update Growth Chart
      function updateGrowthChart(growthData) {
        const growthCtx = document.getElementById('growthChart');
        if (!growthCtx) return;

        document.getElementById('growthChartLoading').style.display = 'none';
        growthCtx.style.display = 'block';

        // Prepare data
        const labels = growthData.map(item => {
          const date = new Date(item._id);
          return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        });
        const data = growthData.map(item => item.count);

        // If no data, create placeholder
        let chartLabels = labels.length > 0 ? labels : [];
        let chartData = data.length > 0 ? data : [];

        if (chartLabels.length === 0) {
          chartLabels = ['No Data'];
          chartData = [0];
        }

        // Destroy existing chart if it exists
        if (growthChartInstance) {
          growthChartInstance.destroy();
        }

        // Create new chart
        growthChartInstance = new Chart(growthCtx, {
          type: 'line',
          data: {
            labels: chartLabels,
            datasets: [{
              label: 'New Students',
              data: chartData,
              borderColor: '#3a92bd',
              backgroundColor: 'rgba(58, 146, 189, 0.1)',
              borderWidth: 3,
              fill: true,
              tension: 0.4,
              pointBackgroundColor: '#3a92bd',
              pointBorderColor: '#ffffff',
              pointBorderWidth: 2,
              pointRadius: 6,
              pointHoverRadius: 8,
              pointHoverBorderWidth: 3,
              borderJoinStyle: 'round',
              borderCapStyle: 'round'
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
              intersect: false,
              mode: 'index'
            },
            plugins: {
              legend: {
                display: false
              },
              tooltip: {
                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                titleColor: '#ffffff',
                bodyColor: '#ffffff',
                borderColor: '#3a92bd',
                borderWidth: 2,
                cornerRadius: 8,
                displayColors: true,
                padding: 12,
                titleFont: {
                  size: 14,
                  weight: 'bold'
                },
                bodyFont: {
                  size: 13
                },
                callbacks: {
                  label: function (context) {
                    return `New Students: ${context.parsed.y}`;
                  }
                }
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                grid: {
                  color: 'rgba(0, 0, 0, 0.05)',
                  drawBorder: false
                },
                ticks: {
                  stepSize: 1,
                  font: {
                    size: 11
                  },
                  color: '#6b7280'
                }
              },
              x: {
                grid: {
                  display: false
                },
                ticks: {
                  font: {
                    size: 11
                  },
                  color: '#6b7280'
                }
              }
            }
          }
        });
      }

      // Update Revenue Chart
      function updateRevenueChart(revenueData) {
        const revenueCtx = document.getElementById('revenueChart');
        if (!revenueCtx) return;

        document.getElementById('revenueChartLoading').style.display = 'none';
        revenueCtx.style.display = 'block';

        // Prepare data
        const labels = revenueData.map(item => {
          const date = new Date(item._id);
          return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        });
        const data = revenueData.map(item => item.total);

        // If no data, create placeholder
        let chartLabels = labels.length > 0 ? labels : [];
        let chartData = data.length > 0 ? data : [];

        if (chartLabels.length === 0) {
          chartLabels = ['No Data'];
          chartData = [0];
        }

        // Destroy existing chart if it exists
        if (revenueChartInstance) {
          revenueChartInstance.destroy();
        }

        // Create new chart
        revenueChartInstance = new Chart(revenueCtx, {
          type: 'bar',
          data: {
            labels: chartLabels,
            datasets: [{
              label: 'Revenue (AED)',
              data: chartData,
              backgroundColor: 'rgba(58, 146, 189, 0.8)',
              borderColor: '#3a92bd',
              borderWidth: 2,
              borderRadius: 8,
              borderSkipped: false,
              hoverBackgroundColor: 'rgba(58, 146, 189, 1)',
              hoverBorderColor: '#ffffff',
              hoverBorderWidth: 3
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
              intersect: false,
              mode: 'index'
            },
            plugins: {
              legend: {
                display: false
              },
              tooltip: {
                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                titleColor: '#ffffff',
                bodyColor: '#ffffff',
                borderColor: '#3a92bd',
                borderWidth: 2,
                cornerRadius: 8,
                displayColors: true,
                padding: 12,
                titleFont: {
                  size: 14,
                  weight: 'bold'
                },
                bodyFont: {
                  size: 13
                },
                callbacks: {
                  label: function (context) {
                    return `Revenue: AED ${context.parsed.y.toFixed(2)}`;
                  }
                }
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                grid: {
                  color: 'rgba(0, 0, 0, 0.05)',
                  drawBorder: false
                },
                ticks: {
                  callback: function (value) {
                    return 'AED ' + value.toFixed(0);
                  },
                  font: {
                    size: 11
                  },
                  color: '#6b7280'
                }
              },
              x: {
                grid: {
                  display: false
                },
                ticks: {
                  font: {
                    size: 11
                  },
                  color: '#6b7280'
                }
              }
            }
          }
        });
      }

      // Chart period controls
      function initializeChartControls() {
        const periodBtns = document.querySelectorAll('.chart-period-btn');
        periodBtns.forEach(btn => {
          btn.addEventListener('click', function () {
            // Remove active class from all buttons
            periodBtns.forEach(b => b.classList.remove('active'));
            // Add active class to clicked button
            this.classList.add('active');

            // Update charts based on period
            const period = this.dataset.period;
            updateChartsForPeriod(period);
          });
        });
      }

      // Update charts for different periods
      function updateChartsForPeriod(period) {
        // Map period buttons to days
        const periodDays = {
          '7d': 7,
          '30d': 30,
          '90d': 90
        };

        const days = periodDays[period] || 30;

        // Load chart data for the selected period
        loadChartData(days);
      }

      // Course filters
      function initializeCourseFilters() {
        const filterBtns = document.querySelectorAll('.course-filter-btn');
        filterBtns.forEach(btn => {
          btn.addEventListener('click', function () {
            // Remove active class from all buttons
            filterBtns.forEach(b => b.classList.remove('active'));
            // Add active class to clicked button
            this.classList.add('active');

            // Filter courses
            const filter = this.dataset.filter;
            filterCourses(filter);
          });
        });
      }

      // Filter courses
      function filterCourses(filter) {
        const courseCards = document.querySelectorAll('.course-performance-card');
        courseCards.forEach(card => {
          const status = card.dataset.status;
          const isFeatured = card.dataset.featured === 'true';

          if (filter === 'all') {
            card.style.display = 'block';
          } else if (filter === 'published') {
            card.style.display = status === 'published' ? 'block' : 'none';
          } else if (filter === 'draft') {
            card.style.display = status === 'draft' ? 'block' : 'none';
          } else if (filter === 'featured') {
            card.style.display = isFeatured ? 'block' : 'none';
          } else {
            card.style.display = 'block';
          }
        });
      }


      // Enhanced Notification functions
      let notificationCountdown = null;
      let notificationProgress = null;

      function viewNewOrders() {
        // Mark notification as viewed and redirect
        markNotificationAsViewed();
        window.location.href = '/admin/orders';
      }

      function dismissNotification() {
        const notification = document.getElementById('newOrdersNotification');
        if (notification) {
          // Clear countdown
          if (notificationCountdown) {
            clearInterval(notificationCountdown);
          }
          if (notificationProgress) {
            clearInterval(notificationProgress);
          }

          // Mark as dismissed
          markNotificationAsViewed();

          // Animate out
          notification.style.animation = 'slideOutRight 0.4s ease-in-out forwards';
          setTimeout(() => {
            notification.style.display = 'none';
          }, 400);
        }
      }

      function markNotificationAsViewed() {
        // Store in localStorage to prevent showing again
        const notification = document.getElementById('newOrdersNotification');
        if (notification) {
          const orderCount = notification.dataset.orderCount;
          const viewedKey = `notificationViewed_${orderCount}_${new Date().toDateString()}`;
          localStorage.setItem(viewedKey, 'true');

          // Also store in sessionStorage for immediate session
          sessionStorage.setItem('notificationDismissed', 'true');
        }
      }

      function shouldShowNotification() {
        const notification = document.getElementById('newOrdersNotification');
        if (!notification) return false;

        const orderCount = notification.dataset.orderCount;
        const viewedKey = `notificationViewed_${orderCount}_${new Date().toDateString()}`;
        const isViewed = localStorage.getItem(viewedKey) === 'true';
        const isSessionDismissed = sessionStorage.getItem('notificationDismissed') === 'true';

        return !isViewed && !isSessionDismissed;
      }

      // Enhanced auto-dismiss with countdown and progress bar
      function initializeNotification() {
        const notification = document.getElementById('newOrdersNotification');
        if (!notification || !shouldShowNotification()) {
          if (notification) {
            notification.style.display = 'none';
          }
          return;
        }

        let countdown = 10;
        const timerElement = document.getElementById('countdownTimer');
        const progressElement = document.getElementById('notificationProgress');

        // Start countdown
        notificationCountdown = setInterval(() => {
          countdown--;
          if (timerElement) {
            timerElement.textContent = countdown;
          }

          if (countdown <= 0) {
            clearInterval(notificationCountdown);
            dismissNotification();
          }
        }, 1000);

        // Start progress bar animation
        let progress = 0;
        notificationProgress = setInterval(() => {
          progress += 1;
          if (progressElement) {
            progressElement.style.width = `${progress}%`;
          }

          if (progress >= 100) {
            clearInterval(notificationProgress);
          }
        }, 100);

        // Add pulse animation to primary button
        const pulseBtn = document.querySelector('.pulse-btn');
        if (pulseBtn) {
          setInterval(() => {
            pulseBtn.style.transform = 'scale(1.05)';
            setTimeout(() => {
              pulseBtn.style.transform = 'scale(1)';
            }, 200);
          }, 2000);
        }
      }

      // Initialize notification when DOM is ready
      document.addEventListener('DOMContentLoaded', function () {
        initializeNotification();
      });

      // Export dashboard data
      function exportDashboardData() {
        try {
          console.log('Exporting comprehensive dashboard data...');

          // Show loading state
          const exportBtn = document.querySelector('.dashboard-action-btn.secondary');
          if (exportBtn) {
            const originalText = exportBtn.innerHTML;
            exportBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Exporting...';
            exportBtn.disabled = true;

            // Reset button after a delay
            setTimeout(() => {
              exportBtn.innerHTML = originalText;
              exportBtn.disabled = false;
            }, 5000);
          }

          // Create a temporary link to trigger download
          const link = document.createElement('a');
          link.href = '/admin/export/comprehensive';
          link.download = `comprehensive-admin-report-${new Date().toISOString().split('T')[0]}.xlsx`;
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
        } catch (error) {
          console.error('Error exporting dashboard data:', error);
          // Reset button on error
          const exportBtn = document.querySelector('.dashboard-action-btn.secondary');
          if (exportBtn) {
            exportBtn.innerHTML = '<i class="fas fa-file-excel"></i> Export Excel Report';
            exportBtn.disabled = false;
          }
        }
      }

      // Add some interactive animations
      document.addEventListener('DOMContentLoaded', function () {
        // Animate stat cards on scroll
        const observerOptions = {
          threshold: 0.1,
          rootMargin: '0px 0px -50px 0px'
        };

        const observer = new IntersectionObserver((entries) => {
          entries.forEach(entry => {
            if (entry.isIntersecting) {
              entry.target.style.animationDelay = '0.1s';
              entry.target.classList.add('admin-slide-in');
            }
          });
        }, observerOptions);

        // Observe all stat cards
        document.querySelectorAll('.admin-stat-card').forEach(card => {
          observer.observe(card);
        });

        // Add hover effects to course cards
        document.querySelectorAll('.course-performance-card').forEach(card => {
          card.addEventListener('mouseenter', function () {
            this.style.transform = 'translateY(-8px) scale(1.02)';
          });

          card.addEventListener('mouseleave', function () {
            this.style.transform = 'translateY(0) scale(1)';
          });
        });
      });

      // Theme-aware chart colors
      function getChartColors() {
        const isDark = document.body.classList.contains('dark-theme');
        return {
          primary: isDark ? '#5ba9d1' : '#3a92bd',
          secondary: isDark ? '#6ec1e4' : '#0c5374',
          success: isDark ? '#4caf50' : '#10b981',
          warning: isDark ? '#ff9800' : '#f59e0b',
          info: isDark ? '#2196f3' : '#3b82f6',
          background: isDark ? 'rgba(26, 31, 46, 0.5)' : 'rgba(255, 255, 255, 0.5)',
          grid: isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)'
        };
      }

      // WhatsApp Status Functions
      function refreshWhatsAppStatus() {
        showNotification('Refreshing WhatsApp status...', 'info');
        loadWhatsAppSessionStatus();
      }

      function testWhatsAppConnection() {
        showNotification('Testing WhatsApp connection...', 'info');

        fetch('/admin/whatsapp/session-status')
          .then(response => response.json())
          .then(data => {
            if (data.success && data.session) {
              showNotification('âœ… WhatsApp connection is active!', 'success');
              updateWhatsAppSessionDisplay(data.session);
            } else {
              showNotification('âŒ WhatsApp connection failed or no active session', 'error');
              updateWhatsAppSessionDisplay(null);
            }
          })
          .catch(error => {
            console.error('Error testing WhatsApp connection:', error);
            showNotification('âŒ Error testing WhatsApp connection', 'error');
            updateWhatsAppSessionDisplay(null);
          });
      }

      function loadWhatsAppSessionStatus() {
        fetch('/admin/whatsapp/session-status')
          .then(response => response.json())
          .then(data => {
            if (data.success && data.session) {
              updateWhatsAppSessionDisplay(data.session);
            } else {
              updateWhatsAppSessionDisplay(null);
            }
          })
          .catch(error => {
            console.error('Error loading WhatsApp session status:', error);
            updateWhatsAppSessionDisplay(null);
          });
      }

      function updateWhatsAppSessionDisplay(session) {
        const statusElement = document.getElementById('whatsappSessionStatus');
        const detailsElement = document.getElementById('whatsappSessionDetails');

        if (session) {
          const status = session.status || 'DISCONNECTED';
          let statusText = '';
          let statusClass = '';

          switch (status) {
            case 'CONNECTED':
              statusText = 'âœ“';
              statusClass = 'text-success';
              break;
            case 'NEED_SCAN':
              statusText = 'âš ';
              statusClass = 'text-warning';
              break;
            default:
              statusText = 'âœ—';
              statusClass = 'text-danger';
          }

          if (statusElement) {
            statusElement.textContent = statusText;
            statusElement.className = `whatsapp-status-number ${statusClass}`;
          }

          if (detailsElement) {
            detailsElement.textContent = `Phone: ${session.phone_number || 'N/A'} | Status: ${status}`;
          }
        } else {
          if (statusElement) {
            statusElement.textContent = 'âœ—';
            statusElement.className = 'whatsapp-status-number text-danger';
          }

          if (detailsElement) {
            detailsElement.textContent = 'No active WhatsApp session found';
          }
        }
      }

      // Load WhatsApp status on page load
      document.addEventListener('DOMContentLoaded', function () {
        // Load WhatsApp session status after a short delay to ensure page is ready
        setTimeout(() => {
          loadWhatsAppSessionStatus();
          updateWhatsAppStatusInHeader();
        }, 1000);
      });

      // Update WhatsApp status in header
      function updateWhatsAppStatusInHeader() {
        const statusElement = document.getElementById('whatsappStatusValue');
        if (!statusElement) return;

        // Show loading state
        statusElement.textContent = 'Loading...';
        statusElement.className = 'meta-card-value status-neutral';

        fetch('/admin/whatsapp/session-status')
          .then(response => response.json())
          .then(data => {
            if (data.success && data.session && data.session.status === 'CONNECTED') {
              statusElement.textContent = 'Connected';
              statusElement.className = 'meta-card-value status-connected';
            } else {
              statusElement.textContent = 'Disconnected';
              statusElement.className = 'meta-card-value status-disconnected';
            }
          })
          .catch(error => {
            console.error('Error loading WhatsApp status:', error);
            statusElement.textContent = 'Disconnected';
            statusElement.className = 'meta-card-value status-disconnected';
          });
      }
    </script>