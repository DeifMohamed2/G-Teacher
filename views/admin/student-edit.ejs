<%- include('partials/admin-header') %>
  <link rel="stylesheet" href="/css/adminCSS/student-edit.css">
</head>

<body class="<%= theme %>">
  <%- include('partials/admin-sidebar') %>

  <div class="admin-main-content">
    <%- include('partials/admin-topbar') %>
    
    <div class="student-edit-container">
      <!-- Page Header -->
      <div class="edit-page-header">
        <div class="page-header-top">
          <div class="page-title-section">
            <div class="page-title-icon">
              <i class="fas fa-user-edit"></i>
            </div>
            <div>
              <div class="breadcrumb">
                <a href="/admin/students">Students</a>
                <i class="fas fa-chevron-right"></i>
                <a href="/admin/students/<%= student._id %>"><%= student.firstName %> <%= student.lastName %></a>
                <i class="fas fa-chevron-right"></i>
                <span>Edit</span>
              </div>
              <h1 class="page-title">Edit Student Information</h1>
              <p class="page-subtitle">Update student details and account settings</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Alert Messages -->
      <% if (typeof success !== 'undefined' && success) { %>
      <div class="alert alert-success">
        <i class="fas fa-check-circle"></i>
        <span><%= success %></span>
      </div>
      <% } %>

      <% if (typeof error !== 'undefined' && error) { %>
      <div class="alert alert-error">
        <i class="fas fa-exclamation-circle"></i>
        <span><%= error %></span>
      </div>
      <% } %>

      <!-- Edit Form -->
      <form id="studentEditForm" method="POST" action="/admin/students/<%= student._id %>/update" enctype="multipart/form-data">
        <div class="edit-form-container">
          <!-- Personal Information Section -->
          <div class="form-section">
            <div class="form-section-header">
              <div class="section-icon">
                <i class="fas fa-user"></i>
              </div>
              <div>
                <h3 class="section-title">Personal Information</h3>
                <p class="section-description">Basic student details and identification</p>
              </div>
            </div>

            <div class="form-grid">
              <div class="form-group">
                <label class="form-label">
                  <i class="fas fa-user"></i>
                  First Name
                  <span class="required-indicator">*</span>
                </label>
                <input 
                  type="text" 
                  name="firstName" 
                  class="form-control" 
                  value="<%= student.firstName %>"
                  required
                  minlength="2"
                  maxlength="50"
                >
                <span class="form-help">
                  <i class="fas fa-info-circle"></i>
                  Student's legal first name
                </span>
              </div>

              <div class="form-group">
                <label class="form-label">
                  <i class="fas fa-user"></i>
                  Last Name
                  <span class="required-indicator">*</span>
                </label>
                <input 
                  type="text" 
                  name="lastName" 
                  class="form-control" 
                  value="<%= student.lastName %>"
                  required
                  minlength="2"
                  maxlength="50"
                >
                <span class="form-help">
                  <i class="fas fa-info-circle"></i>
                  Student's legal last name
                </span>
              </div>

              <div class="form-group">
                <label class="form-label">
                  <i class="fas fa-id-card"></i>
                  Student Code
                </label>
                <input 
                  type="text" 
                  name="studentCode" 
                  class="form-control" 
                  value="<%= student.studentCode %>"
                  disabled
                >
                <span class="form-help">
                  <i class="fas fa-info-circle"></i>
                  Unique identifier (cannot be changed)
                </span>
              </div>

              <div class="form-group">
                <label class="form-label">
                  <i class="fas fa-user-circle"></i>
                  Username
                  <span class="required-indicator">*</span>
                </label>
                <input 
                  type="text" 
                  name="username" 
                  class="form-control" 
                  value="<%= student.username %>"
                  required
                  minlength="3"
                  maxlength="30"
                  pattern="[a-zA-Z0-9_]+"
                >
                <span class="form-help">
                  <i class="fas fa-info-circle"></i>
                  Letters, numbers, and underscores only
                </span>
              </div>

              <div class="form-group">
                <label class="form-label">
                  <i class="fas fa-graduation-cap"></i>
                  Grade
                  <span class="required-indicator">*</span>
                </label>
                <select name="grade" class="form-control" required>
                  <option value="">Select Grade</option>
                  <option value="Year 7" <%= student.grade === 'Year 7' ? 'selected' : '' %>>Year 7</option>
                  <option value="Year 8" <%= student.grade === 'Year 8' ? 'selected' : '' %>>Year 8</option>
                  <option value="Year 9" <%= student.grade === 'Year 9' ? 'selected' : '' %>>Year 9</option>
                  <option value="Year 10" <%= student.grade === 'Year 10' ? 'selected' : '' %>>Year 10</option>
                  <option value="Year 11" <%= student.grade === 'Year 11' ? 'selected' : '' %>>Year 11</option>
                  <option value="Year 12" <%= student.grade === 'Year 12' ? 'selected' : '' %>>Year 12</option>
                  <option value="Year 13" <%= student.grade === 'Year 13' ? 'selected' : '' %>>Year 13</option>
                </select>
              </div>

              <div class="form-group">
                <label class="form-label">
                  <i class="fas fa-school"></i>
                  School Name
                  <span class="required-indicator">*</span>
                </label>
                <input 
                  type="text" 
                  name="schoolName" 
                  class="form-control" 
                  value="<%= student.schoolName %>"
                  required
                  minlength="2"
                  maxlength="100"
                >
              </div>

              <div class="form-group">
                <label class="form-label">
                  <i class="fas fa-chalkboard-teacher"></i>
                  English Teacher
                  <span class="required-indicator">*</span>
                </label>
                <input 
                  type="text" 
                  name="englishTeacher" 
                  class="form-control" 
                  value="<%= student.englishTeacher %>"
                  required
                  minlength="2"
                  maxlength="100"
                >
              </div>

              <div class="form-group form-grid-full">
                <label class="form-label">
                  <i class="fas fa-question-circle"></i>
                  How Did You Know About Us?
                </label>
                <textarea 
                  name="howDidYouKnow" 
                  class="form-control"
                  maxlength="500"
                ><%= student.howDidYouKnow %></textarea>
              </div>
            </div>
          </div>

          <!-- Contact Information Section -->
          <div class="form-section">
            <div class="form-section-header">
              <div class="section-icon">
                <i class="fas fa-address-book"></i>
              </div>
              <div>
                <h3 class="section-title">Contact Information</h3>
                <p class="section-description">Email and phone contact details</p>
              </div>
            </div>

            <div class="form-grid">
              <div class="form-group form-grid-full">
                <label class="form-label">
                  <i class="fas fa-envelope"></i>
                  Email Address
                  <span class="required-indicator">*</span>
                </label>
                <input 
                  type="email" 
                  name="studentEmail" 
                  class="form-control" 
                  value="<%= student.studentEmail %>"
                  required
                >
                <span class="form-help">
                  <i class="fas fa-info-circle"></i>
                  Used for login and notifications
                </span>
              </div>

              <div class="form-group">
                <label class="form-label">
                  <i class="fas fa-mobile-alt"></i>
                  Student Phone Number
                  <span class="required-indicator">*</span>
                </label>
                <div class="input-group">
                  <div class="input-group-prepend">
                    <select name="studentCountryCode" class="form-control" required>
                      <option value="+966" <%= student.studentCountryCode === '+966' ? 'selected' : '' %>>ðŸ‡¸ðŸ‡¦ +966</option>
                      <option value="+20" <%= student.studentCountryCode === '+20' ? 'selected' : '' %>>ðŸ‡ªðŸ‡¬ +20</option>
                      <option value="+971" <%= student.studentCountryCode === '+971' ? 'selected' : '' %>>ðŸ‡¦ðŸ‡ª +971</option>
                      <option value="+965" <%= student.studentCountryCode === '+965' ? 'selected' : '' %>>ðŸ‡°ðŸ‡¼ +965</option>
                    </select>
                  </div>
                  <div class="input-group-append">
                    <input 
                      type="tel" 
                      name="studentNumber" 
                      class="form-control" 
                      value="<%= student.studentNumber %>"
                      required
                      minlength="10"
                      maxlength="15"
                      pattern="[0-9]+"
                    >
                  </div>
                </div>
              </div>

              <div class="form-group">
                <label class="form-label">
                  <i class="fas fa-phone"></i>
                  Parent Phone Number
                  <span class="required-indicator">*</span>
                </label>
                <div class="input-group">
                  <div class="input-group-prepend">
                    <select name="parentCountryCode" class="form-control" required>
                      <option value="+966" <%= student.parentCountryCode === '+966' ? 'selected' : '' %>>ðŸ‡¸ðŸ‡¦ +966</option>
                      <option value="+20" <%= student.parentCountryCode === '+20' ? 'selected' : '' %>>ðŸ‡ªðŸ‡¬ +20</option>
                      <option value="+971" <%= student.parentCountryCode === '+971' ? 'selected' : '' %>>ðŸ‡¦ðŸ‡ª +971</option>
                      <option value="+965" <%= student.parentCountryCode === '+965' ? 'selected' : '' %>>ðŸ‡°ðŸ‡¼ +965</option>
                    </select>
                  </div>
                  <div class="input-group-append">
                    <input 
                      type="tel" 
                      name="parentNumber" 
                      class="form-control" 
                      value="<%= student.parentNumber %>"
                      required
                      minlength="10"
                      maxlength="15"
                      pattern="[0-9]+"
                    >
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Profile Picture Section -->
          <div class="form-section">
            <div class="form-section-header">
              <div class="section-icon">
                <i class="fas fa-image"></i>
              </div>
              <div>
                <h3 class="section-title">Profile Picture</h3>
                <p class="section-description">Upload or update student profile photo</p>
              </div>
            </div>

            <div class="profile-picture-section">
              <div class="current-profile-picture">
                <div class="profile-avatar" id="profilePreview">
                  <% if (student.profilePicture && student.profilePicture.trim() !== '') { %>
                    <img src="<%= student.profilePicture %>" alt="Profile Picture">
                  <% } else { %>
                    <%= student.firstName.charAt(0).toUpperCase() %><%= student.lastName.charAt(0).toUpperCase() %>
                  <% } %>
                </div>
              </div>
              <div class="profile-upload-controls">
                <h4>Change Profile Picture</h4>
                <p>Upload a new profile picture. Recommended size: 400x400px. Max file size: 5MB.</p>
                <div class="file-input-wrapper">
                  <input 
                    type="file" 
                    name="profilePicture" 
                    id="profilePictureInput" 
                    accept="image/*"
                    onchange="previewProfilePicture(this)"
                  >
                  <label for="profilePictureInput" class="file-input-label">
                    <i class="fas fa-cloud-upload-alt"></i>
                    Choose File
                  </label>
                </div>
                <div class="file-name-display" id="fileNameDisplay"></div>
              </div>
            </div>
          </div>

          <!-- Account Status Section -->
          <div class="form-section">
            <div class="form-section-header">
              <div class="section-icon">
                <i class="fas fa-toggle-on"></i>
              </div>
              <div>
                <h3 class="section-title">Account Status</h3>
                <p class="section-description">Manage student account activation status and parent phone verification</p>
              </div>
            </div>

            <div class="status-toggle-section">
              <div class="status-toggle-info">
                <h4>Account Active Status</h4>
                <p>Enable or disable student access to the platform</p>
              </div>
              <label class="toggle-switch">
                <input 
                  type="checkbox" 
                  name="isActive" 
                  <%= student.isActive ? 'checked' : '' %>
                >
                <span class="toggle-slider"></span>
              </label>
            </div>

            <div class="status-toggle-section">
              <div class="status-toggle-info">
                <h4>Parent Phone Verified</h4>
                <p>Mark this when you have confirmed the parent's phone number</p>
              </div>
              <label class="toggle-switch">
                <input 
                  type="checkbox" 
                  name="isParentPhoneChecked" 
                  <%= student.isParentPhoneChecked ? 'checked' : '' %>
                >
                <span class="toggle-slider"></span>
              </label>
            </div>
          </div>

          <!-- Password Change Section (Optional) -->
          <div class="form-section">
            <div class="form-section-header">
              <div class="section-icon">
                <i class="fas fa-lock"></i>
              </div>
              <div>
                <h3 class="section-title">Change Password</h3>
                <p class="section-description">Update student login password (optional)</p>
              </div>
            </div>

            <div class="password-change-section">
              <div class="password-warning">
                <i class="fas fa-exclamation-triangle"></i>
                <div class="password-warning-content">
                  <h5>Password Change Warning</h5>
                  <p>Only fill in these fields if you want to change the student's password. Leave blank to keep the current password.</p>
                </div>
              </div>

              <div class="form-grid">
                <div class="form-group">
                  <label class="form-label">
                    <i class="fas fa-key"></i>
                    New Password
                  </label>
                  <input 
                    type="password" 
                    name="newPassword" 
                    id="newPassword"
                    class="form-control" 
                    minlength="5"
                    placeholder="Leave blank to keep current password"
                    onkeyup="checkPasswordStrength(this.value)"
                  >
                  <div class="password-strength-indicator" id="passwordStrength" style="display: none;">
                    <div class="strength-bar">
                      <div class="strength-fill"></div>
                    </div>
                    <div class="strength-text"></div>
                  </div>
                </div>

                <div class="form-group">
                  <label class="form-label">
                    <i class="fas fa-check-circle"></i>
                    Confirm New Password
                  </label>
                  <input 
                    type="password" 
                    name="confirmPassword" 
                    id="confirmPassword"
                    class="form-control" 
                    placeholder="Confirm new password"
                    onkeyup="checkPasswordMatch()"
                  >
                  <span class="form-error" id="passwordMatchError" style="display: none;">
                    <i class="fas fa-times-circle"></i>
                    Passwords do not match
                  </span>
                  <span class="form-success" id="passwordMatchSuccess" style="display: none;">
                    <i class="fas fa-check-circle"></i>
                    Passwords match
                  </span>
                </div>
              </div>
            </div>
          </div>

          <!-- Form Actions -->
          <div class="form-actions">
            <a href="/admin/students/<%= student._id %>" class="btn btn-secondary">
              <i class="fas fa-times"></i>
              Cancel
            </a>
            <button type="button" class="btn btn-danger" onclick="confirmReset()">
              <i class="fas fa-undo"></i>
              Reset Form
            </button>
            <button type="submit" class="btn btn-primary" id="submitBtn">
              <i class="fas fa-save"></i>
              Save Changes
            </button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <%- include('partials/admin-footer') %>

  <script>
    // Profile Picture Preview
    function previewProfilePicture(input) {
      const preview = document.getElementById('profilePreview');
      const fileDisplay = document.getElementById('fileNameDisplay');
      
      if (input.files && input.files[0]) {
        const file = input.files[0];
        
        // Validate file size (5MB max)
        if (file.size > 5 * 1024 * 1024) {
          alert('File size must be less than 5MB');
          input.value = '';
          return;
        }
        
        // Validate file type
        if (!file.type.match('image.*')) {
          alert('Please select an image file');
          input.value = '';
          return;
        }
        
        const reader = new FileReader();
        
        reader.onload = function(e) {
          preview.innerHTML = `<img src="${e.target.result}" alt="Profile Picture">`;
        };
        
        reader.readAsDataURL(file);
        fileDisplay.textContent = `Selected: ${file.name}`;
      }
    }

    // Password Strength Checker
    function checkPasswordStrength(password) {
      const indicator = document.getElementById('passwordStrength');
      const strengthBar = indicator.querySelector('.strength-fill');
      const strengthText = indicator.querySelector('.strength-text');
      
      if (password.length === 0) {
        indicator.style.display = 'none';
        return;
      }
      
      indicator.style.display = 'block';
      indicator.className = 'password-strength-indicator';
      
      let strength = 0;
      
      // Length check
      if (password.length >= 8) strength++;
      if (password.length >= 12) strength++;
      
      // Character variety checks
      if (/[a-z]/.test(password)) strength++;
      if (/[A-Z]/.test(password)) strength++;
      if (/[0-9]/.test(password)) strength++;
      if (/[^a-zA-Z0-9]/.test(password)) strength++;
      
      if (strength <= 2) {
        indicator.classList.add('strength-weak');
        strengthText.textContent = 'Weak';
      } else if (strength <= 4) {
        indicator.classList.add('strength-medium');
        strengthText.textContent = 'Medium';
      } else {
        indicator.classList.add('strength-strong');
        strengthText.textContent = 'Strong';
      }
    }

    // Password Match Checker
    function checkPasswordMatch() {
      const newPassword = document.getElementById('newPassword').value;
      const confirmPassword = document.getElementById('confirmPassword').value;
      const errorMsg = document.getElementById('passwordMatchError');
      const successMsg = document.getElementById('passwordMatchSuccess');
      
      if (confirmPassword.length === 0) {
        errorMsg.style.display = 'none';
        successMsg.style.display = 'none';
        return;
      }
      
      if (newPassword !== confirmPassword) {
        errorMsg.style.display = 'flex';
        successMsg.style.display = 'none';
      } else {
        errorMsg.style.display = 'none';
        successMsg.style.display = 'flex';
      }
    }

    // Form Validation
    document.getElementById('studentEditForm').addEventListener('submit', function(e) {
      const newPassword = document.getElementById('newPassword').value;
      const confirmPassword = document.getElementById('confirmPassword').value;
      
      // Check if passwords match (only if new password is provided)
      if (newPassword && newPassword !== confirmPassword) {
        e.preventDefault();
        alert('Passwords do not match. Please check and try again.');
        return false;
      }
      
      // Show loading state
      const submitBtn = document.getElementById('submitBtn');
      submitBtn.classList.add('loading');
      submitBtn.disabled = true;
    });

    // Reset Form Confirmation
    function confirmReset() {
      if (confirm('Are you sure you want to reset all changes? This will discard any unsaved modifications.')) {
        document.getElementById('studentEditForm').reset();
        
        // Reset profile picture preview
        const preview = document.getElementById('profilePreview');
        <% if (student.profilePicture && student.profilePicture.trim() !== '') { %>
          preview.innerHTML = `<img src="<%= student.profilePicture %>" alt="Profile Picture">`;
        <% } else { %>
          preview.innerHTML = '<%= student.firstName.charAt(0).toUpperCase() %><%= student.lastName.charAt(0).toUpperCase() %>';
        <% } %>
        
        // Reset file display
        document.getElementById('fileNameDisplay').textContent = '';
        
        // Reset password strength indicator
        document.getElementById('passwordStrength').style.display = 'none';
        document.getElementById('passwordMatchError').style.display = 'none';
        document.getElementById('passwordMatchSuccess').style.display = 'none';
      }
    }

    // Auto-hide alerts after 5 seconds
    document.addEventListener('DOMContentLoaded', function() {
      const alerts = document.querySelectorAll('.alert');
      alerts.forEach(alert => {
        setTimeout(() => {
          alert.style.transition = 'opacity 0.5s ease';
          alert.style.opacity = '0';
          setTimeout(() => alert.remove(), 500);
        }, 5000);
      });
    });

    // Phone number formatting
    const phoneInputs = document.querySelectorAll('input[type="tel"]');
    phoneInputs.forEach(input => {
      input.addEventListener('input', function(e) {
        // Remove non-numeric characters
        this.value = this.value.replace(/[^0-9]/g, '');
      });
    });

    // Username validation
    const usernameInput = document.querySelector('input[name="username"]');
    if (usernameInput) {
      usernameInput.addEventListener('input', function(e) {
        // Remove invalid characters
        this.value = this.value.replace(/[^a-zA-Z0-9_]/g, '');
      });
    }
  </script>

</body>
</html>

