<%- include('./partials/admin-header', { pageCSS: 'bundles' }) %>

<!-- Admin Layout -->
<div class="admin-layout">

  <!-- Sidebar -->
  <%- include('./partials/admin-sidebar', { currentPage: 'bundles' }) %>

  <!-- Main Content -->
  <main class="admin-main">

    <!-- Top Bar -->
    <%- include('./partials/admin-topbar', { 
        breadcrumb: 'Bundle Management',
        breadcrumbSubtitle: `Manage: ${bundle.title}`,
        showSearch: false
    }) %>

    <!-- Content Area -->
    <div class="admin-content">
      <div class="admin-dashboard admin-fade-in">

        <!-- Bundle Header -->
        <div class="bundle-header-card">
          <div class="bundle-header-content">
            <div class="bundle-header-top">
              <div class="bundle-badges">

                <span class="bundle-code-badge"><%= bundle.bundleCode %></span>
                <span class="bundle-status-badge <%= bundle.status %>">
                  <i class="fas fa-<%= bundle.status === 'published' ? 'eye' : bundle.status === 'draft' ? 'eye-slash' : 'archive' %>"></i>
                  <%= bundle.status.charAt(0).toUpperCase() + bundle.status.slice(1) %>
                </span>
              </div>
              <div class="bundle-header-actions">
                <a href="/admin/bundles" class="btn btn-outline-secondary btn-sm">
                  <i class="fas fa-arrow-left me-1"></i>
                  Back to Bundles
                </a>
                <button class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#editBundleModal">
                  <i class="fas fa-edit me-1"></i>
                  Edit Bundle
                </button>
                <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addCourseModal">
                  <i class="fas fa-plus me-1"></i>
                  Add Course
                </button>
                <a href="/admin/courses" class="btn btn-outline-success btn-sm">
                  <i class="fas fa-plus-circle me-1"></i>
                  Create Course
                </a>
                <button class="btn btn-outline-danger btn-sm" onclick="deleteBundle('<%= bundle.bundleCode %>')">
                  <i class="fas fa-trash me-1"></i>
                  Delete Bundle
                </button>
              </div>
            </div>

            <div class="bundle-title-section">
              <h1 class="bundle-title"><%= bundle.title %></h1>
              <p class="bundle-description"><%= bundle.description %></p>
            </div>

            <div class="bundle-stats-grid">
              <div class="stat-card">
                <div class="stat-icon">
                  <i class="fas fa-layer-group"></i>
                </div>
                <div class="stat-content">
                  <div class="stat-number"><%= bundle.courses ? bundle.courses.length : 0 %></div>
                  <div class="stat-label">Courses</div>
                </div>
              </div>
              <div class="stat-card">
                <div class="stat-icon">
                  <i class="fas fa-clock"></i>
                </div>
                <div class="stat-content">
                  <div class="stat-number"><%= bundle.duration || 0 %></div>
                  <div class="stat-label">Hours</div>
                </div>
              </div>
              <div class="stat-card">
                <div class="stat-icon">
                  <i class="fas fa-users"></i>
                </div>
                <div class="stat-content">
                  <div class="stat-number"><%= bundle.enrolledStudents ? bundle.enrolledStudents.length : 0 %></div>
                  <div class="stat-label">Students</div>
                </div>
              </div>
              <div class="stat-card">
                <div class="stat-icon">
                  <i class="fas fa-coins"></i>
                </div>
                <div class="stat-content">
                  <div class="stat-number">EGP <%= bundle.price %></div>
                  <div class="stat-label">Price</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Bundle Pricing Info -->
        <% if (bundle.discountPrice) { %>
        <div class="bundle-pricing-info">
          <div class="pricing-card">
            <div class="pricing-header">
              <h5><i class="fas fa-tag me-2"></i>Special Pricing</h5>
            </div>
            <div class="pricing-content">
              <div class="price-row">
                <span class="original-price">EGP <%= bundle.price %></span>
                <span class="discount-price">EGP <%= bundle.finalPrice.toFixed(2) %></span>
              </div>
              <div class="savings-badge">
                <i class="fas fa-percentage me-1"></i>
                Save EGP <%= bundle.savings.toFixed(2) %> (<%= bundle.savingsPercentage %>% off)
              </div>
            </div>
          </div>
        </div>
        <% } %>

        <!-- Bundle Courses -->
        <div class="bundle-courses-section">
          <div class="section-header">
            <div class="section-title">
              <h3><i class="fas fa-book me-2"></i>Bundle Courses</h3>
              <span class="course-count"><%= bundle.courses ? bundle.courses.length : 0 %> courses</span>
            </div>
            <div class="section-actions">
              <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addCourseModal">
                <i class="fas fa-plus me-1"></i>
                Add Existing Course
              </button>
              <a href="/admin/courses" class="btn btn-outline-success btn-sm">
                <i class="fas fa-plus-circle me-1"></i>
                Create New Course
              </a>
            </div>
          </div>

          <% if (bundle.courses && bundle.courses.length > 0) { %>
          <div class="courses-grid" id="coursesGrid">
            <% bundle.courses.forEach((course, index) => { %>
            <div class="course-card" data-course-id="<%= course._id %>" data-order="<%= course.order || (index + 1) %>">
              <div class="course-number">
                <span class="order-badge">Week <%= course.order || (index + 1) %></span>
              </div>

              <div class="course-thumbnail">
                <img src="<%= course.thumbnail || '/images/course-placeholder.jpg' %>" alt="Course Thumbnail">
                <div class="course-status <%= course.status %>">
                  <i class="fas fa-<%= course.status === 'published' ? 'eye' : 'eye-slash' %>"></i>
                  <%= course.status.charAt(0).toUpperCase() + course.status.slice(1) %>
                </div>
              </div>

              <div class="course-content">
                <div class="course-header">
                  <h4 class="course-title"><%= course.title %></h4>
                  <span class="course-code"><%= course.courseCode %></span>
                </div>

                <p class="course-description"><%= course.shortDescription %></p>

                <div class="course-meta">
                  <div class="meta-item">
                    <i class="fas fa-clock"></i>
                    <span><%= course.duration %>h</span>
                  </div>
                  <div class="meta-item">
                    <i class="fas fa-layer-group"></i>
                    <span><%= course.level %></span>
                  </div>
                  <div class="meta-item">
                    <i class="fas fa-coins"></i>
                    <span>EGP <%= course.price %></span>
                  </div>
                </div>

                <div class="course-actions">
                  <div class="order-controls mb-2">
                    <button class="btn btn-sm btn-outline-secondary" onclick="moveCourseOrder('<%= course._id %>', 'up')" title="Move Up" <%= index === 0 ? 'disabled' : '' %>>
                      <i class="fas fa-arrow-up"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-secondary" onclick="moveCourseOrder('<%= course._id %>', 'down')" title="Move Down" <%= index === bundle.courses.length - 1 ? 'disabled' : '' %>>
                      <i class="fas fa-arrow-down"></i>
                    </button>
                  </div>
                  <a href="/admin/courses/<%= course.courseCode %>/content" class="btn btn-sm btn-primary">
                    <i class="fas fa-edit me-1"></i>
                    Manage
                  </a>
                  <a href="/admin/courses/<%= course.courseCode %>" class="btn btn-sm btn-outline-info">
                    <i class="fas fa-eye me-1"></i>
                    View
                  </a>
                  <button class="btn btn-sm btn-outline-danger" onclick="removeCourseFromBundle('<%= course._id %>', '<%= course.title %>')">
                    <i class="fas fa-times"></i>
                  </button>
                </div>
              </div>
            </div>
            <% }); %>
          </div>
          <% } else { %>
          <div class="empty-state">
            <div class="empty-icon">
              <i class="fas fa-book-open"></i>
            </div>
            <h4>No courses in this bundle</h4>
            <p>Start building your bundle by adding existing courses or creating new ones</p>
            <div class="empty-actions">
              <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addCourseModal">
                <i class="fas fa-plus me-2"></i>
                Add Existing Course
              </button>
              <a href="/admin/courses" class="btn btn-outline-success">
                <i class="fas fa-plus-circle me-2"></i>
                Create New Course
              </a>
            </div>
          </div>
          <% } %>
        </div>

      </div>
    </div>

  </main>
</div>

<!-- Add Existing Course Modal -->
<div class="modal fade" id="addCourseModal" tabindex="-1" aria-labelledby="addCourseModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content admin-modal-content">
      <div class="modal-header admin-modal-header">
        <h5 class="modal-title" id="addCourseModalLabel">
          <i class="fas fa-plus me-2"></i>
          Add Existing Course
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body admin-modal-body">
        <% if (availableCourses && availableCourses.length > 0) { %>
        <div class="admin-available-courses">
          <% availableCourses.forEach(course => { %>
          <div class="admin-course-selection-card">
            <div class="row align-items-center">
              <div class="col-md-8">
                <div class="course-info">
                  <h6><%= course.title %></h6>
                  <small class="text-muted">
                    <%= course.courseCode %> • <%= course.duration %> hours • <%= course.level %>
                  </small>
                  <p class="mb-0 mt-1"><%= course.shortDescription %></p>
                </div>
              </div>
              <div class="col-md-4 text-end">
                <a href="/admin/bundles/<%= bundle.bundleCode %>/courses/<%= course._id %>/add" class="btn btn-sm btn-primary" onclick="return confirm('Add this course to the bundle?')">
                  <i class="fas fa-plus me-1"></i>
                  Add to Bundle
                </a>
              </div>
            </div>
          </div>
          <% }); %>
        </div>
        <% } else { %>
        <div class="admin-empty-state">
          <div class="admin-empty-icon">
            <i class="fas fa-search"></i>
          </div>
          <h5>No available courses found</h5>
          <p>No published courses found. Create a new course instead.</p>
        </div>
        <% } %>
      </div>

      <div class="modal-footer admin-modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>


<!-- Edit Bundle Modal -->
<div class="modal fade" id="editBundleModal" tabindex="-1" aria-labelledby="editBundleModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-fullscreen-lg-down modal-xl" style="max-width: 95vw; width: 90vw;">
    <div class="modal-content admin-modal-content admin-modal-wide" style="min-height: 80vh;">
      <div class="modal-header admin-modal-header">
        <h5 class="modal-title" id="editBundleModalLabel">
          <i class="fas fa-edit me-2"></i>
          Edit Bundle
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <form id="editBundleForm">
        <div class="modal-body admin-modal-body">
          <!-- Bundle Thumbnail Upload Section -->
          <div class="admin-form-section">
            <h6 class="admin-form-section-title">
              <i class="fas fa-image me-2"></i>
              Bundle Thumbnail
            </h6>
            <div class="upload-section">
              <input type="file" id="editBundleThumbnail" class="upload-input" accept="image/*">
              <label for="editBundleThumbnail" class="upload-label">
                <i class="fas fa-cloud-upload-alt"></i>
                Choose Thumbnail Image
              </label>
              <div id="editBundleThumbnailPreview" class="upload-preview">
                <% if (bundle.thumbnail) { %>
                <img src="<%= bundle.thumbnail %>" alt="Current Thumbnail" style="width: 100%; height: 100%; object-fit: cover; border-radius: 8px;">
                <% } else { %>
                <div class="preview-overlay">
                  <i class="fas fa-cloud-upload-alt"></i>
                  <p>Click or drag to upload</p>
                  <small>JPEG, PNG, JPG, WebP (max 10MB)</small>
                </div>
                <% } %>
              </div>
              <div id="editBundleThumbnailProgress" class="progress-container" style="display: none;"></div>
            </div>
            <input type="hidden" name="thumbnail" id="editBundleThumbnailUrl" value="<%= bundle.thumbnail || '' %>">
          </div>

          <!-- Bundle Details Section -->
          <div class="row mt-4">
            <div class="col-md-8">
              <div class="admin-form-section">
                <h6 class="admin-form-section-title">
                  <i class="fas fa-info-circle me-2"></i>
                  Bundle Information
                </h6>

                <div class="admin-form-group">
                  <label for="editBundleTitle" class="admin-form-label">
                    <i class="fas fa-heading me-2"></i>
                    Bundle Title
                  </label>
                  <input type="text" class="admin-form-control" id="editBundleTitle" name="title" value="<%= bundle.title %>" minlength="3" maxlength="100" required>
                  <small class="admin-form-text">Title must be between 3 and 100 characters</small>
                  <div class="invalid-feedback" id="editBundleTitleError"></div>
                </div>

                <div class="admin-form-group">
                  <label for="editBundleDescription" class="admin-form-label">
                    <i class="fas fa-align-left me-2"></i>
                    Bundle Description (Optional)
                  </label>
                  <textarea class="admin-form-control" id="editBundleDescription" name="description" rows="4" maxlength="1000"><%= bundle.description %></textarea>
                  <small class="admin-form-text">Description is optional (max 1000 characters)</small>
                  <div class="invalid-feedback" id="editBundleDescriptionError"></div>
                </div>

                <div class="admin-form-group">
                  <label for="editBundleShortDescription" class="admin-form-label">
                    <i class="fas fa-text-width me-2"></i>
                    Short Description (Optional)
                  </label>
                  <input type="text" class="admin-form-control" id="editBundleShortDescription" name="shortDescription" value="<%= bundle.shortDescription %>" maxlength="200">
                  <small class="admin-form-text">Short description is optional (max 200 characters)</small>
                  <div class="invalid-feedback" id="editBundleShortDescriptionError"></div>
                </div>
              </div>
            </div>

            <div class="col-md-4">
              <div class="admin-form-section">
                <h6 class="admin-form-section-title">
                  <i class="fas fa-cog me-2"></i>
                  Bundle Settings
                </h6>



                <div class="admin-form-group">
                  <label for="editBundleCourseType" class="admin-form-label">
                    <i class="fas fa-laptop me-2"></i>
                    Course Type
                  </label>
                  <select class="admin-form-control" id="editBundleCourseType" name="courseType" required>
                    <option value="">Select Course Type</option>
                    <option value="online" <%= bundle.courseType === 'online' ? 'selected' : '' %>>Online Course</option>
                    <option value="onground" <%= bundle.courseType === 'onground' ? 'selected' : '' %>>On-Ground Course</option>
                    <option value="recorded" <%= bundle.courseType === 'recorded' ? 'selected' : '' %>>Recorded Course</option>
                    <option value="recovery" <%= bundle.courseType === 'recovery' ? 'selected' : '' %>>Recovery Course</option>
                  </select>
                  <small class="admin-form-text">Choose whether this bundle contains online, onground, recorded, or recovery courses</small>
                  <div class="invalid-feedback" id="editBundleCourseTypeError"></div>
                </div>

                <div class="admin-form-group">
                  <label for="editBundleSubject" class="admin-form-label">
                    <i class="fas fa-book me-2"></i>
                    Level
                  </label>
                  <select class="admin-form-control" id="editBundleSubject" name="subject" required>
                    <option value="">Select Level</option>
                    <option value="Basics" <%= bundle.subject === 'Basics' ? 'selected' : '' %>>Basics</option>
                    <option value="Advanced" <%= bundle.subject === 'Advanced' ? 'selected' : '' %>>Advanced</option>
                    <option value="Basics & Advanced" <%= bundle.subject === 'Basics & Advanced' ? 'selected' : '' %>>Basics & Advanced</option>
                    <option value="Number2" <%= bundle.subject === 'Number2' ? 'selected' : '' %>>2</option>
                  </select>
                  <div class="invalid-feedback" id="editBundleSubjectError"></div>
                </div>

                <div class="admin-form-group">
                  <label for="editBundleTestType" class="admin-form-label">
                    <i class="fas fa-graduation-cap me-2"></i>
                    Test Type
                  </label>
                  <select class="admin-form-control" id="editBundleTestType" name="testType" required>
                    <option value="">Select Test Type</option>
                    <option value="EST" <%= bundle.testType === 'EST' ? 'selected' : '' %>>EST</option>
                    <option value="SAT" <%= bundle.testType === 'SAT' ? 'selected' : '' %>>SAT</option>
                    <option value="ACT" <%= bundle.testType === 'ACT' ? 'selected' : '' %>>ACT</option>
                    <option value="EST&SAT" <%= bundle.testType === 'EST&SAT' ? 'selected' : '' %>>EST&SAT</option>
                  </select>
                  <div class="invalid-feedback" id="editBundleTestTypeError"></div>
                </div>

                <div class="admin-form-group">
                  <label for="editBundleStatus" class="admin-form-label">
                    <i class="fas fa-toggle-on me-2"></i>
                    Status
                  </label>
                  <select class="admin-form-control" id="editBundleStatus" name="status" required>
                    <option value="draft" <%= bundle.status === 'draft' ? 'selected' : '' %>>Draft</option>
                    <option value="published" <%= bundle.status === 'published' ? 'selected' : '' %>>Published</option>
                    <option value="archived" <%= bundle.status === 'archived' ? 'selected' : '' %>>Archived</option>
                  </select>
                  <div class="invalid-feedback" id="editBundleStatusError"></div>
                </div>

                <div class="admin-form-group">
                  <label for="editBundlePrice" class="admin-form-label">
                    <i class="fas fa-coins me-2"></i>
                    Regular Price (EGP)
                  </label>
                  <input type="number" class="admin-form-control" id="editBundlePrice" name="price" value="<%= bundle.price %>" min="0" step="0.01" required>
                  <small class="admin-form-text">Price must be 0 or greater</small>
                  <div class="invalid-feedback" id="editBundlePriceError"></div>
                </div>

                <div class="admin-form-group">
                  <label for="editBundleDiscountPrice" class="admin-form-label">
                    <i class="fas fa-percentage me-2"></i>
                    Discount Percentage (%)
                  </label>
                  <input type="number" class="admin-form-control" id="editBundleDiscountPrice" name="discountPrice" value="<%= bundle.discountPrice || '' %>" min="0" max="100" step="1">
                  <small class="admin-form-text">Optional: Set a discount percentage (0-100)</small>
                  <div class="invalid-feedback" id="editBundleDiscountPriceError"></div>
                </div>
              </div>
            </div>

            <!-- Book Information Section -->
            <div class="row mt-4">
              <div class="col-12">
                <div class="admin-form-section">
                  <h6 class="admin-form-section-title">
                    <i class="fas fa-book me-2"></i>
                    Book Information (Optional)
                  </h6>

                  <div class="admin-form-group">
                    <div class="form-check mb-3">
                      <input class="form-check-input" type="checkbox" id="editBundleHasBook" name="hasBook" <%= bundle.hasBook ? 'checked' : '' %>>
                      <label class="form-check-label" for="editBundleHasBook">
                        This bundle has an associated physical book
                      </label>
                    </div>
                  </div>

                  <div id="bookFields" style="display: <%= bundle.hasBook ? 'block' : 'none' %>;">
                    <div class="admin-form-group">
                      <label for="editBundleBookName" class="admin-form-label">
                        <i class="fas fa-book-open me-2"></i>
                        Book Name
                      </label>
                      <input type="text" class="admin-form-control" id="editBundleBookName" name="bookName" value="<%= bundle.bookName || '' %>" maxlength="200">
                      <small class="admin-form-text">Enter the name of the physical book</small>
                      <div class="invalid-feedback" id="editBundleBookNameError"></div>
                    </div>

                    <div class="admin-form-group">
                      <label for="editBundleBookPrice" class="admin-form-label">
                        <i class="fas fa-coins me-2"></i>
                        Book Price (EGP)
                      </label>
                      <input type="number" class="admin-form-control" id="editBundleBookPrice" name="bookPrice" value="<%= bundle.bookPrice || '' %>" min="0" step="0.01">
                      <small class="admin-form-text">Price of the physical book</small>
                      <div class="invalid-feedback" id="editBundleBookPriceError"></div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Fully Booked Section -->
            <div class="row mt-4">
              <div class="col-12">
                <div class="admin-form-section">
                  <h6 class="admin-form-section-title">
                    <i class="fas fa-ban me-2"></i>
                    Enrollment Status
                  </h6>

                  <div class="admin-form-group">
                    <div class="form-check mb-3">
                      <input class="form-check-input" type="checkbox" id="editBundleIsFullyBooked" name="isFullyBooked" <%= bundle.isFullyBooked ? 'checked' : '' %>>
                      <label class="form-check-label" for="editBundleIsFullyBooked">
                        Fully Booked / Close Enrollment
                      </label>
                    </div>
                    <small class="admin-form-text">When enabled, this bundle will be marked as fully booked and students cannot enroll. This will close all weeks in the bundle.</small>
                  </div>

                  <div id="bundleFullyBookedMessageRow" style="display: <%= bundle.isFullyBooked ? 'block' : 'none' %>;">
                    <div class="admin-form-group">
                      <label for="editBundleFullyBookedMessage" class="admin-form-label">
                        <i class="fas fa-comment me-2"></i>
                        Fully Booked Message
                      </label>
                      <select class="admin-form-control" id="editBundleFullyBookedMessage" name="fullyBookedMessage">
                        <option value="FULLY BOOKED" <%= (bundle.fullyBookedMessage === 'FULLY BOOKED' || !bundle.fullyBookedMessage) ? 'selected' : '' %>>FULLY BOOKED</option>
                        <option value="Out of Stock" <%= bundle.fullyBookedMessage === 'Out of Stock' ? 'selected' : '' %>>Out of Stock</option>
                        <option value="Enrollment Closed" <%= bundle.fullyBookedMessage === 'Enrollment Closed' ? 'selected' : '' %>>Enrollment Closed</option>
                        <option value="Registration Closed" <%= bundle.fullyBookedMessage === 'Registration Closed' ? 'selected' : '' %>>Registration Closed</option>
                        <option value="Sold Out" <%= bundle.fullyBookedMessage === 'Sold Out' ? 'selected' : '' %>>Sold Out</option>
                        <option value="Not Available" <%= bundle.fullyBookedMessage === 'Not Available' ? 'selected' : '' %>>Not Available</option>
                        <option value="other" <%= !['FULLY BOOKED', 'Out of Stock', 'Enrollment Closed', 'Registration Closed', 'Sold Out', 'Not Available'].includes(bundle.fullyBookedMessage) && bundle.fullyBookedMessage ? 'selected' : '' %>>Other (Custom Message)</option>
                      </select>
                      <small class="admin-form-text">Choose a message to display when bundle is fully booked</small>
                      <div class="invalid-feedback" id="editBundleFullyBookedMessageError"></div>
                    </div>
                    <div class="admin-form-group" id="bundleCustomMessageRow" style="display: <%= !['FULLY BOOKED', 'Out of Stock', 'Enrollment Closed', 'Registration Closed', 'Sold Out', 'Not Available'].includes(bundle.fullyBookedMessage) && bundle.fullyBookedMessage ? 'block' : 'none' %>;">
                      <label for="editBundleCustomFullyBookedMessage" class="admin-form-label">
                        <i class="fas fa-edit me-2"></i>
                        Custom Message
                      </label>
                      <input type="text" class="admin-form-control" id="editBundleCustomFullyBookedMessage" name="customFullyBookedMessage" value="<%= !['FULLY BOOKED', 'Out of Stock', 'Enrollment Closed', 'Registration Closed', 'Sold Out', 'Not Available'].includes(bundle.fullyBookedMessage) && bundle.fullyBookedMessage ? bundle.fullyBookedMessage : '' %>" maxlength="100" placeholder="Enter your custom message">
                      <small class="admin-form-text">Enter a custom message (max 100 characters)</small>
                      <div class="invalid-feedback" id="editBundleCustomFullyBookedMessageError"></div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="modal-footer admin-modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary admin-btn-primary">
            <i class="fas fa-save me-2"></i>
            Update Bundle
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<%- include('./partials/admin-footer') %>

<!-- Local Upload Script -->
<script src="/js/local-upload.js"></script>

<script>
  // Bundle management functions
  async function deleteBundle(bundleCode) {
    // Create a beautiful confirmation modal instead of browser confirm
    const confirmModalHtml = `
    <div class="modal fade" id="deleteBundleConfirmModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header bg-danger text-white">
            <h5 class="modal-title">
              <i class="fas fa-exclamation-triangle me-2"></i>Confirm Bundle Deletion
            </h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="text-center">
              <div class="mb-3">
                <i class="fas fa-box text-danger" style="font-size: 48px;"></i>
              </div>
              <h6 class="mb-3">Are you sure you want to delete this bundle?</h6>
              <p class="text-muted mb-0">This action cannot be undone. The bundle will be removed from all courses and permanently deleted.</p>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
              <i class="fas fa-times me-1"></i>Cancel
            </button>
            <button type="button" class="btn btn-danger" id="confirmDeleteBundleBtn">
              <i class="fas fa-trash me-1"></i>Delete Bundle
            </button>
          </div>
        </div>
      </div>
    </div>
  `;

    // Remove existing modal if any
    const existingModal = document.getElementById('deleteBundleConfirmModal');
    if (existingModal) existingModal.remove();

    // Add modal to body
    document.body.insertAdjacentHTML('beforeend', confirmModalHtml);

    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('deleteBundleConfirmModal'));
    modal.show();

    // Handle delete confirmation
    document.getElementById('confirmDeleteBundleBtn').addEventListener('click', async function() {
      // Show loading state
      const deleteBtn = this;
      const originalText = deleteBtn.innerHTML;
      deleteBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Deleting...';
      deleteBtn.disabled = true;

      try {
        const response = await fetch(`/admin/bundles/${bundleCode}`, {
          method: 'DELETE',
          headers: {
            'Content-Type': 'application/json',
          }
        });

        const data = await response.json();

        if (data.success) {
          modal.hide();
          showNotification('Bundle deleted successfully!', 'success');
          // Redirect to bundles page
          setTimeout(() => {
            window.location.href = '/admin/bundles';
          }, 1000);
        } else {
          throw new Error(data.message || 'Failed to delete bundle');
        }
      } catch (error) {
        console.error('Error:', error);
        showNotification('Error deleting bundle: ' + error.message, 'error');
        // Restore button state
        deleteBtn.innerHTML = originalText;
        deleteBtn.disabled = false;
      }
    });

    // Clean up modal when hidden
    document.getElementById('deleteBundleConfirmModal').addEventListener('hidden.bs.modal', function() {
      this.remove();
    });
  }

  // Remove course from bundle
  async function removeCourseFromBundle(courseId, courseTitle) {
    const confirmModalHtml = `
    <div class="modal fade" id="removeCourseConfirmModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header bg-warning text-dark">
            <h5 class="modal-title">
              <i class="fas fa-exclamation-triangle me-2"></i>Remove Course from Bundle
            </h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="text-center">
              <div class="mb-3">
                <i class="fas fa-book text-warning" style="font-size: 48px;"></i>
              </div>
              <h6 class="mb-3">Remove "${courseTitle}" from this bundle?</h6>
              <p class="text-muted mb-0">The course will be removed from this bundle but will remain available in the system.</p>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
              <i class="fas fa-times me-1"></i>Cancel
            </button>
            <button type="button" class="btn btn-warning" id="confirmRemoveCourseBtn">
              <i class="fas fa-times me-1"></i>Remove Course
            </button>
          </div>
        </div>
      </div>
    </div>
  `;

    // Remove existing modal if any
    const existingModal = document.getElementById('removeCourseConfirmModal');
    if (existingModal) existingModal.remove();

    // Add modal to body
    document.body.insertAdjacentHTML('beforeend', confirmModalHtml);

    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('removeCourseConfirmModal'));
    modal.show();

    // Handle remove confirmation
    document.getElementById('confirmRemoveCourseBtn').addEventListener('click', async function() {
      // Show loading state
      const removeBtn = this;
      const originalText = removeBtn.innerHTML;
      removeBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Removing...';
      removeBtn.disabled = true;

      try {
        const response = await fetch(`/admin/bundles/<%= bundle.bundleCode %>/courses/${courseId}/remove`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          }
        });

        const data = await response.json();

        if (data.success) {
          modal.hide();
          showNotification('Course removed from bundle successfully!', 'success');

          // Remove the course card from UI with animation
          const courseCard = document.querySelector(`[data-course-id="${courseId}"]`);
          if (courseCard) {
            courseCard.style.transition = 'all 0.3s ease';
            courseCard.style.transform = 'scale(0.8)';
            courseCard.style.opacity = '0';
            setTimeout(() => {
              courseCard.remove();
              updateCourseNumbers();
            }, 300);
          }
        } else {
          throw new Error(data.message || 'Failed to remove course from bundle');
        }
      } catch (error) {
        console.error('Error:', error);
        showNotification('Error removing course: ' + error.message, 'error');
        // Restore button state
        removeBtn.innerHTML = originalText;
        removeBtn.disabled = false;
      }
    });

    // Clean up modal when hidden
    document.getElementById('removeCourseConfirmModal').addEventListener('hidden.bs.modal', function() {
      this.remove();
    });
  }

  // Update course numbers after removal
  function updateCourseNumbers() {
    const courseCards = document.querySelectorAll('.course-card');
    courseCards.forEach((card, index) => {
      const numberElement = card.querySelector('.course-number');
      if (numberElement) {
        numberElement.textContent = String(index + 1).padStart(2, '0');
      }
    });
  }

  // Notification function
  function showNotification(message, type = 'info') {
    // Remove existing notifications
    const existingNotifications = document.querySelectorAll('.notification');
    existingNotifications.forEach(notification => notification.remove());

    // Create notification element
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    notification.innerHTML = `
    <div class="notification-content">
      <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
      <span>${message}</span>
      <button class="notification-close" onclick="this.parentElement.parentElement.remove()">
        <i class="fas fa-times"></i>
      </button>
    </div>
  `;

    // Add to page
    document.body.appendChild(notification);

    // Auto remove after 5 seconds
    setTimeout(() => {
      if (notification.parentElement) {
        notification.remove();
      }
    }, 5000);
  }

  // Setup form validation and initialization
  document.addEventListener('DOMContentLoaded', function() {
    // Setup fully booked checkbox toggle and message dropdown
    const fullyBookedCheckbox = document.getElementById('editBundleIsFullyBooked');
    const fullyBookedMessageRow = document.getElementById('bundleFullyBookedMessageRow');
    const fullyBookedMessageSelect = document.getElementById('editBundleFullyBookedMessage');
    const customMessageRow = document.getElementById('bundleCustomMessageRow');
    const customMessageInput = document.getElementById('editBundleCustomFullyBookedMessage');
    
    if (fullyBookedCheckbox && fullyBookedMessageRow) {
      fullyBookedCheckbox.addEventListener('change', function() {
        fullyBookedMessageRow.style.display = this.checked ? 'block' : 'none';
      });
    }

    // Handle dropdown change for "Other" option
    if (fullyBookedMessageSelect && customMessageRow) {
      fullyBookedMessageSelect.addEventListener('change', function() {
        if (this.value === 'other') {
          customMessageRow.style.display = 'block';
          if (customMessageInput) {
            customMessageInput.required = true;
          }
        } else {
          customMessageRow.style.display = 'none';
          if (customMessageInput) {
            customMessageInput.required = false;
            customMessageInput.value = '';
          }
        }
      });
    }
    setupEditBundleForm();
    setupBookFields();
  });

  // Toggle book fields visibility
  function setupBookFields() {
    const hasBookCheckbox = document.getElementById('editBundleHasBook');
    const bookFields = document.getElementById('bookFields');

    if (hasBookCheckbox && bookFields) {
      hasBookCheckbox.addEventListener('change', function() {
        bookFields.style.display = this.checked ? 'block' : 'none';
        if (!this.checked) {
          // Clear book fields when unchecked
          document.getElementById('editBundleBookName').value = '';
          document.getElementById('editBundleBookPrice').value = '';
        }
      });
    }
  }



  // Setup edit bundle form
  function setupEditBundleForm() {
    const form = document.getElementById('editBundleForm');
    if (!form) return;

    form.addEventListener('submit', function(e) {
      e.preventDefault();
      submitEditBundleForm();
    });
  }

  // Submit edit bundle form via AJAX
  function submitEditBundleForm() {
    const form = document.getElementById('editBundleForm');
    const submitBtn = form.querySelector('button[type="submit"]');
    const bundleCode = '<%= bundle.bundleCode %>';

    // Disable submit button and show loading state
    const originalText = submitBtn.innerHTML;
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Updating...';

    // Collect form data
    const formData = new FormData(form);

    // Convert FormData to JSON
    const data = {};
    for (let [key, value] of formData.entries()) {
      data[key] = value;
    }

    // Handle checkbox values
    data.isFullyBooked = document.getElementById('editBundleIsFullyBooked').checked;
    
    // Handle fully booked message - use custom if "other" is selected, otherwise use dropdown value
    const fullyBookedMessageSelect = document.getElementById('editBundleFullyBookedMessage');
    const customMessageInput = document.getElementById('editBundleCustomFullyBookedMessage');
    
    if (!data.isFullyBooked) {
      data.fullyBookedMessage = 'FULLY BOOKED'; // Default value
    } else if (fullyBookedMessageSelect && fullyBookedMessageSelect.value === 'other' && customMessageInput) {
      data.fullyBookedMessage = customMessageInput.value.trim() || 'FULLY BOOKED';
    } else if (fullyBookedMessageSelect) {
      data.fullyBookedMessage = fullyBookedMessageSelect.value || 'FULLY BOOKED';
    } else {
      data.fullyBookedMessage = 'FULLY BOOKED';
    }

    // Send PUT request
    fetch(`/admin/bundles/${bundleCode}`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          'Accept': 'application/json',
          'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify(data)
      })
      .then(response => {
        if (response.ok) {
          return response.json();
        } else {
          return response.json().then(errorData => {
            throw new Error(errorData.message || 'Failed to update bundle');
          });
        }
      })
      .then(result => {
        if (result.success) {
          // Show success message and reload page
          showSuccessMessage(result.message || 'Bundle updated successfully!');
          setTimeout(() => {
            window.location.reload();
          }, 1500);
        } else {
          throw new Error(result.message || 'Failed to update bundle');
        }
      })
      .catch(error => {
        console.error('Error updating bundle:', error);
        showErrorMessage(error.message || 'Error updating bundle. Please try again.');

        // Re-enable submit button
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
      });
  }

  // Show success message
  function showSuccessMessage(message) {
    const alertDiv = document.createElement('div');
    alertDiv.className = 'alert alert-success alert-dismissible fade show position-fixed';
    alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    alertDiv.innerHTML = `
    <i class="fas fa-check-circle me-2"></i>
    ${message}
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
  `;

    document.body.appendChild(alertDiv);

    // Auto remove after 5 seconds
    setTimeout(() => {
      if (alertDiv.parentNode) {
        alertDiv.parentNode.removeChild(alertDiv);
      }
    }, 5000);
  }

  // Show error message
  function showErrorMessage(message) {
    const alertDiv = document.createElement('div');
    alertDiv.className = 'alert alert-danger alert-dismissible fade show position-fixed';
    alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    alertDiv.innerHTML = `
    <i class="fas fa-exclamation-triangle me-2"></i>
    ${message}
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
  `;

    document.body.appendChild(alertDiv);

    // Auto remove after 7 seconds
    setTimeout(() => {
      if (alertDiv.parentNode) {
        alertDiv.parentNode.removeChild(alertDiv);
      }
    }, 7000);
  }

  // Move course order up or down
  async function moveCourseOrder(courseId, direction) {
    try {
      const courseCard = document.querySelector(`[data-course-id="${courseId}"]`);
      if (!courseCard) return;

      const currentOrder = parseInt(courseCard.dataset.order);
      const allCourseCards = Array.from(document.querySelectorAll('.course-card'));
      allCourseCards.sort((a, b) => parseInt(a.dataset.order) - parseInt(b.dataset.order));

      const currentIndex = allCourseCards.findIndex(card => card.dataset.courseId === courseId);
      
      if (direction === 'up' && currentIndex === 0) return;
      if (direction === 'down' && currentIndex === allCourseCards.length - 1) return;

      const targetIndex = direction === 'up' ? currentIndex - 1 : currentIndex + 1;
      const targetCard = allCourseCards[targetIndex];
      const targetOrder = parseInt(targetCard.dataset.order);

      // Swap orders
      const tempOrder = currentOrder;
      courseCard.dataset.order = targetOrder;
      targetCard.dataset.order = tempOrder;

      // Update order badges
      courseCard.querySelector('.order-badge').textContent = `Week ${targetOrder}`;
      targetCard.querySelector('.order-badge').textContent = `Week ${tempOrder}`;

      // Prepare order updates
      const courseOrders = allCourseCards.map((card, idx) => ({
        courseId: card.dataset.courseId,
        order: parseInt(card.dataset.order)
      }));

      // Update on server
      const response = await fetch(`/admin/bundles/<%= bundle.bundleCode %>/courses/reorder`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ courseOrders })
      });

      const data = await response.json();

      if (data.success) {
        showSuccessMessage('Course order updated successfully');
        // Reload page after a short delay to reflect changes
        setTimeout(() => {
          window.location.reload();
        }, 1000);
      } else {
        showErrorMessage(data.message || 'Failed to update course order');
        // Revert on error
        window.location.reload();
      }
    } catch (error) {
      console.error('Error updating course order:', error);
      showErrorMessage('Error updating course order');
      window.location.reload();
    }
  }
</script>