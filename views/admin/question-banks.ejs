<%- include('./partials/admin-header', { pageCSS: 'question-banks', additionalJS: ['/js/question-bank.js'] }) %>

<!-- Admin Layout -->
<div class="admin-layout">
  
  <!-- Sidebar -->
  <%- include('./partials/admin-sidebar', { currentPage: 'question-banks' }) %>
  
  <!-- Main Content -->
  <main class="admin-main">
    
    <!-- Top Bar -->
    <%- include('./partials/admin-topbar', { 
        breadcrumb: 'Question Banks',
        breadcrumbSubtitle: 'Manage Your Question Libraries',
        showSearch: true
    }) %>
    
    <!-- Content Area -->
    <div class="admin-content">
      <div class="admin-dashboard admin-fade-in">
        
        <!-- Page Header -->
        <div class="admin-dashboard-header">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h1 class="admin-dashboard-title">Question Banks</h1>
              <p class="admin-dashboard-subtitle">Create and manage your question libraries for assessments</p>
            </div>
            <button class="btn btn-primary admin-btn-primary" data-bs-toggle="modal" data-bs-target="#createQuestionBankModal">
              <i class="fas fa-plus me-2"></i>
              Create New Bank
            </button>
          </div>
        </div>

        <!-- Question Bank Stats -->
        <div class="admin-stats-grid">
          <div class="admin-stat-card admin-slide-in">
            <div class="admin-stat-header">
              <div class="admin-stat-icon">
                <i class="fas fa-database"></i>
              </div>
              <div class="admin-stat-trend positive">
                <i class="fas fa-arrow-up"></i>
                +2
              </div>
            </div>
            <h3 class="admin-stat-number"><%= stats.totalBanks %></h3>
            <p class="admin-stat-label">Total Banks</p>
          </div>
          
          <div class="admin-stat-card admin-slide-in">
            <div class="admin-stat-header">
              <div class="admin-stat-icon">
                <i class="fas fa-check-circle"></i>
              </div>
              <div class="admin-stat-trend positive">
                <i class="fas fa-arrow-up"></i>
                +1
              </div>
            </div>
            <h3 class="admin-stat-number"><%= stats.activeBanks %></h3>
            <p class="admin-stat-label">Active Banks</p>
          </div>
          
          <div class="admin-stat-card admin-slide-in">
            <div class="admin-stat-header">
              <div class="admin-stat-icon">
                <i class="fas fa-edit"></i>
              </div>
              <div class="admin-stat-trend neutral">
                <i class="fas fa-minus"></i>
                0
              </div>
            </div>
            <h3 class="admin-stat-number"><%= stats.draftBanks %></h3>
            <p class="admin-stat-label">Draft Banks</p>
          </div>
          
          <div class="admin-stat-card admin-slide-in">
            <div class="admin-stat-header">
              <div class="admin-stat-icon">
                <i class="fas fa-question-circle"></i>
              </div>
              <div class="admin-stat-trend positive">
                <i class="fas fa-arrow-up"></i>
                +15
              </div>
            </div>
            <h3 class="admin-stat-number"><%= stats.totalQuestions %></h3>
            <p class="admin-stat-label">Total Questions</p>
          </div>
        </div>

        <!-- Filters and Search -->
        <div class="admin-filters-section">
          <form method="GET" class="admin-search-form">
            <div class="row">
              <div class="col-md-8">
                <div class="input-group">
                  <input type="text" class="form-control admin-search-input" 
                         name="search" placeholder="Search question banks..." 
                         value="<%= currentFilters.search || '' %>">
                  <button class="btn btn-outline-secondary admin-search-btn" type="submit">
                    <i class="fas fa-search"></i>
                  </button>
                </div>
              </div>
              <div class="col-md-2">
                <div class="admin-filter-controls">
                  <select name="status" class="form-select admin-filter-select" onchange="this.form.submit()">
                    <option value="all" <%= currentFilters.status === 'all' ? 'selected' : '' %>>All Status</option>
                    <option value="active" <%= currentFilters.status === 'active' ? 'selected' : '' %>>Active</option>
                    <option value="draft" <%= currentFilters.status === 'draft' ? 'selected' : '' %>>Draft</option>
                    <option value="archived" <%= currentFilters.status === 'archived' ? 'selected' : '' %>>Archived</option>
                  </select>
                </div>
              </div>
              <div class="col-md-2">
                <div class="admin-filter-controls">
                  <select name="testType" class="form-select admin-filter-select" onchange="this.form.submit()">
                    <option value="all" <%= currentFilters.testType === 'all' || !currentFilters.testType ? 'selected' : '' %>>All Test Types</option>
                    <option value="EST" <%= currentFilters.testType === 'EST' ? 'selected' : '' %>>EST</option>
                    <option value="SAT" <%= currentFilters.testType === 'SAT' ? 'selected' : '' %>>SAT</option>
                    <option value="ACT" <%= currentFilters.testType === 'ACT' ? 'selected' : '' %>>ACT</option>
                    <option value="EST 2" <%= currentFilters.testType === 'EST 2' ? 'selected' : '' %>>EST 2</option>
                    <option value="ACT 2" <%= currentFilters.testType === 'ACT 2' ? 'selected' : '' %>>ACT 2</option>
                    <option value="Basics ACT" <%= currentFilters.testType === 'Basics ACT' ? 'selected' : '' %>>Basics ACT</option>
                    <option value="Basics SAT & EST" <%= currentFilters.testType === 'Basics SAT & EST' ? 'selected' : '' %>>Basics SAT & EST</option>
                  </select>
                </div>
              </div>
            </div>
            
            <div class="row mt-3">
              <div class="col-md-6">
                <select name="sortBy" class="form-select admin-filter-select" onchange="this.form.submit()">
                  <option value="createdAt" <%= currentFilters.sortBy === 'createdAt' ? 'selected' : '' %>>Sort by Date</option>
                  <option value="name" <%= currentFilters.sortBy === 'name' ? 'selected' : '' %>>Sort by Name</option>
                  <option value="totalQuestions" <%= currentFilters.sortBy === 'totalQuestions' ? 'selected' : '' %>>Sort by Questions</option>
                </select>
              </div>
            </div>
          </form>
        </div>

        <!-- Question Banks Grid -->
        <div class="admin-content-section">
          <% if (questionBanks && questionBanks.length > 0) { %>
            <div class="row">
              <% questionBanks.forEach((bank, index) => { %>
                <div class="col-lg-4 col-md-6 mb-4">
                  <div class="question-bank-card-modern admin-slide-in" style="animation-delay: <%= index * 0.1 %>s">
                    <!-- Card Header with Gradient -->
                    <div class="question-bank-header">
                      <div class="question-bank-header-bg"></div>
                      <div class="question-bank-header-content">
                      <div class="d-flex justify-content-between align-items-start">
                        <div class="question-bank-title-section">
                          <h5 class="question-bank-title"><%= bank.name %></h5>
                          <p class="question-bank-code">ID: <%= bank.bankCode %></p>
                          <% if (bank.testType) { %>
                          <span class="badge bg-info mt-1"><%= bank.testType %></span>
                          <% } %>
                        </div>
                     
                      </div>
                      </div>
                    </div>
                    
                    <!-- Card Body -->
                    <div class="question-bank-body">
                      <p class="question-bank-description"><%= bank.description %></p>
                      
                      <!-- Statistics Grid -->
                      <div class="question-bank-stats-grid">
                        <div class="stat-item stat-primary">
                          <div class="stat-icon">
                            <i class="fas fa-question-circle"></i>
                          </div>
                          <div class="stat-content">
                            <span class="stat-number"><%= bank.totalQuestions %></span>
                            <span class="stat-label">Total</span>
                          </div>
                        </div>
                        <div class="stat-item stat-success">
                          <div class="stat-icon">
                            <i class="fas fa-check-circle"></i>
                          </div>
                          <div class="stat-content">
                            <span class="stat-number"><%= bank.totalEasy %></span>
                            <span class="stat-label">Easy</span>
                          </div>
                        </div>
                        <div class="stat-item stat-warning">
                          <div class="stat-icon">
                            <i class="fas fa-exclamation-circle"></i>
                          </div>
                          <div class="stat-content">
                            <span class="stat-number"><%= bank.totalMedium %></span>
                            <span class="stat-label">Medium</span>
                          </div>
                        </div>
                        <div class="stat-item stat-danger">
                          <div class="stat-icon">
                            <i class="fas fa-times-circle"></i>
                          </div>
                          <div class="stat-content">
                            <span class="stat-number"><%= bank.totalHard %></span>
                            <span class="stat-label">Hard</span>
                          </div>
                        </div>
                      </div>
                      
                      <!-- Tags Section -->
                      <% if (bank.tags && bank.tags.length > 0) { %>
                        <div class="question-bank-tags">
                          <% bank.tags.slice(0, 3).forEach(tag => { %>
                            <span class="question-bank-tag"><%= tag %></span>
                          <% }); %>
                          <% if (bank.tags.length > 3) { %>
                            <span class="question-bank-tag question-bank-tag-more">+<%= bank.tags.length - 3 %></span>
                          <% } %>
                        </div>
                      <% } %>
                    </div>
                    
                    <!-- Card Footer -->
                    <div class="question-bank-footer">
                      <div class="d-flex justify-content-between align-items-center">
                        <div class="question-bank-status">
                          <span class="status-indicator status-<%= bank.status %>"></span>
                          <span class="status-text"><%= bank.status.charAt(0).toUpperCase() + bank.status.slice(1) %></span>
                        </div>
                        <a href="/admin/question-banks/banks/<%= bank.bankCode %>" 
                           class="btn question-bank-manage-btn">
                          <i class="fas fa-arrow-right me-2"></i>
                          Manage Bank
                        </a>
                      </div>
                    </div>
                  </div>
                </div>
              <% }); %>
            </div>
          <% } else { %>
            <div class="admin-empty-state">
              <div class="admin-empty-icon">
                <i class="fas fa-database"></i>
              </div>
              <h3 class="admin-empty-title">No Question Banks Found</h3>
              <p class="admin-empty-description">
                Get started by creating your first question bank to organize your assessment questions.
              </p>
              <button class="btn btn-primary admin-btn-primary" data-bs-toggle="modal" data-bs-target="#createQuestionBankModal">
                <i class="fas fa-plus me-2"></i>
                Create Your First Bank
              </button>
            </div>
          <% } %>
        </div>

        <!-- Pagination -->
        <% if (pagination.totalPages > 1) { %>
          <div class="admin-pagination">
            <nav aria-label="Question banks pagination">
              <ul class="pagination justify-content-center">
                <%
                  // Build query string from current filters, excluding page and empty values
                  const buildQueryString = (pageNum) => {
                    const params = new URLSearchParams();
                    params.set('page', pageNum);
                    if (currentFilters.search) params.set('search', currentFilters.search);
                    if (currentFilters.status && currentFilters.status !== 'all') params.set('status', currentFilters.status);
                    if (currentFilters.testType && currentFilters.testType !== 'all') params.set('testType', currentFilters.testType);
                    if (currentFilters.sortBy) params.set('sortBy', currentFilters.sortBy);
                    if (currentFilters.sortOrder) params.set('sortOrder', currentFilters.sortOrder);
                    return params.toString();
                  };
                %>
                
                <% if (pagination.hasPrev) { %>
                  <li class="page-item">
                    <a class="page-link" href="?<%= buildQueryString(pagination.currentPage - 1) %>">
                      <i class="fas fa-chevron-left"></i>
                    </a>
                  </li>
                <% } %>
                
                <% for (let i = Math.max(1, pagination.currentPage - 2); i <= Math.min(pagination.totalPages, pagination.currentPage + 2); i++) { %>
                  <li class="page-item <%= i === pagination.currentPage ? 'active' : '' %>">
                    <a class="page-link" href="?<%= buildQueryString(i) %>">
                      <%= i %>
                    </a>
                  </li>
                <% } %>
                
                <% if (pagination.hasNext) { %>
                  <li class="page-item">
                    <a class="page-link" href="?<%= buildQueryString(pagination.currentPage + 1) %>">
                      <i class="fas fa-chevron-right"></i>
                    </a>
                  </li>
                <% } %>
              </ul>
            </nav>
          </div>
        <% } %>
      </div>
    </div>
  </main>
</div>

<!-- Create Question Bank Modal -->
<div class="modal fade admin-modal" id="createQuestionBankModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content admin-modal-content">
      <div class="modal-header admin-modal-header">
        <h5 class="modal-title admin-modal-title">
          <i class="fas fa-plus me-2"></i>
          Create New Question Bank
        </h5>
        <button type="button" class="btn-close admin-btn-close" data-bs-dismiss="modal"></button>
      </div>
      
      <form action="/admin/question-banks/banks/create" method="POST" class="admin-form">
        <div class="modal-body admin-modal-body">
          <div class="row">
            <div class="col-md-12">
              <div class="admin-form-group">
                <label for="name" class="admin-form-label">Bank Name *</label>
                <input type="text" class="form-control admin-form-control" id="name" name="name" 
                       placeholder="Enter bank name" required>
              </div>
            </div>
          </div>
          
          <div class="admin-form-group">
            <label for="description" class="admin-form-label">Description (Optional)</label>
            <textarea class="form-control admin-form-control" id="description" name="description" 
                      rows="3" placeholder="Describe the purpose and content of this question bank"></textarea>
          </div>
          
          
          <div class="admin-form-group">
            <label for="testType" class="admin-form-label">Test Type *</label>
            <select class="form-select admin-form-control" id="testType" name="testType" required>
              <option value="">Select Test Type</option>
              <option value="EST">EST</option>
              <option value="SAT">SAT</option>
              <option value="ACT">ACT</option>
              <option value="EST 2">EST 2</option>
              <option value="ACT 2">ACT 2</option>
              <option value="Basics ACT">Basics ACT</option>
              <option value="Basics SAT & EST">Basics SAT & EST</option>
            </select>
            <small class="admin-form-text">Select the test type for this question bank</small>
          </div>
          
          <div class="admin-form-group">
            <label for="tags" class="admin-form-label">Tags</label>
            <input type="text" class="form-control admin-form-control" id="tags" name="tags" 
                   placeholder="Enter tags separated by commas (e.g., algebra, geometry, trigonometry)">
            <small class="admin-form-text">Tags help organize and search your question banks</small>
          </div>
        </div>
        
        <div class="modal-footer admin-modal-footer">
          <button type="button" class="btn btn-secondary admin-btn-secondary" data-bs-dismiss="modal">
            Cancel
          </button>
          <button type="submit" class="btn btn-primary admin-btn-primary">
            <i class="fas fa-save me-2"></i>
            Create Bank
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<%- include('./partials/admin-footer') %>

<script>
// Delete Question Bank Function
function deleteQuestionBank(bankCode, bankName) {
  if (confirm(`Are you sure you want to delete the question bank "${bankName}"? This action cannot be undone and will delete all questions in this bank.`)) {
    // Create a form to submit the delete request
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = `/admin/question-banks/banks/${bankCode}`;
    
    // Add method override for DELETE
    const methodInput = document.createElement('input');
    methodInput.type = 'hidden';
    methodInput.name = '_method';
    methodInput.value = 'DELETE';
    form.appendChild(methodInput);
    
    document.body.appendChild(form);
    form.submit();
  }
}

// Auto-submit form on filter change
document.addEventListener('DOMContentLoaded', function() {
  const filterSelects = document.querySelectorAll('.admin-filter-select');
  filterSelects.forEach(select => {
    select.addEventListener('change', function() {
      const form = this.closest('form') || document.querySelector('.admin-search-form');
      if (form) {
        form.submit();
      }
    });
  });
});
</script>
