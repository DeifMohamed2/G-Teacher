<%- include('./partials/admin-header', { pageCSS: 'dashboard' }) %>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- html2pdf for PDF generation -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<!-- Admin Layout -->
<div class="admin-layout">
  <!-- Sidebar -->
  <%- include('./partials/admin-sidebar', { currentPage: 'gteacher-analysis', admin: user }) %>

  <!-- Main Content -->
  <main class="admin-main">
    <!-- Top Bar -->
    <%- include('./partials/admin-topbar', { breadcrumb: 'G-Teacher Analysis', breadcrumbSubtitle: 'Financial Overview & Invoices', showSearch: false }) %>

    <!-- Content Area -->
    <div class="admin-content">
      <div class="analysis-container admin-fade-in">
        
        <!-- Page Header -->
        <div class="analysis-header">
          <div class="header-content">
            <div class="header-left">
              <div class="header-icon">
                <i class="fas fa-chart-pie"></i>
              </div>
              <div class="header-info">
                <h1>G-Teacher Analysis & Invoices</h1>
                <p>Comprehensive financial overview, teacher rankings, and invoice generation</p>
              </div>
            </div>
            <div class="header-actions">
              <button class="btn btn-outline" onclick="exportAllData()">
                <i class="fas fa-download"></i>
                Export Report
              </button>
            </div>
          </div>
        </div>

        <!-- Platform Statistics Cards -->
        <div class="stats-grid">
          <div class="stat-card revenue">
            <div class="stat-icon">
              <i class="fas fa-coins"></i>
            </div>
            <div class="stat-content">
              <span class="stat-value"><%= platformStats.totalRevenue.toLocaleString() %></span>
              <span class="stat-label">Total Revenue (EGP)</span>
            </div>
          </div>
          
          <div class="stat-card commission">
            <div class="stat-icon">
              <i class="fas fa-percentage"></i>
            </div>
            <div class="stat-content">
              <span class="stat-value"><%= platformStats.totalGTeacherCommission.toLocaleString() %></span>
              <span class="stat-label">G-Teacher Commission (EGP)</span>
            </div>
          </div>
          
          <div class="stat-card teacher-net">
            <div class="stat-icon">
              <i class="fas fa-user-tie"></i>
            </div>
            <div class="stat-content">
              <span class="stat-value"><%= platformStats.totalTeacherNet.toLocaleString() %></span>
              <span class="stat-label">Teachers Net (EGP)</span>
            </div>
          </div>
          
          <div class="stat-card orders">
            <div class="stat-icon">
              <i class="fas fa-shopping-cart"></i>
            </div>
            <div class="stat-content">
              <span class="stat-value"><%= platformStats.totalOrders %></span>
              <span class="stat-label">Total Orders</span>
            </div>
          </div>
          
          <div class="stat-card refunds">
            <div class="stat-icon">
              <i class="fas fa-undo"></i>
            </div>
            <div class="stat-content">
              <span class="stat-value negative"><%= platformStats.refundAmount.toLocaleString() %></span>
              <span class="stat-label">Total Refunds (EGP)</span>
            </div>
          </div>
        </div>

        <!-- Teacher Rankings Section -->
        <div class="section-card">
          <div class="section-header">
            <h2><i class="fas fa-trophy"></i> Teacher Rankings & Revenue</h2>
            <span class="badge"><%= teacherRankings.length %> Teachers</span>
          </div>
          
          <div class="rankings-table-container">
            <table class="rankings-table">
              <thead>
                <tr>
                  <th>Rank</th>
                  <th>Teacher</th>
                  <th>Subject</th>
                  <th>Commission %</th>
                  <th>Total Revenue</th>
                  <th>G-Teacher Share</th>
                  <th>Teacher Net</th>
                  <th>Orders</th>
                  <th>Refunds</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <% teacherRankings.forEach(ranking => { %>
                <tr>
                  <td>
                    <div class="rank-badge rank-<%= ranking.rank <= 3 ? ranking.rank : 'default' %>">
                      <% if (ranking.rank === 1) { %>
                        <i class="fas fa-crown"></i>
                      <% } else { %>
                        #<%= ranking.rank %>
                      <% } %>
                    </div>
                  </td>
                  <td>
                    <div class="teacher-info">
                      <div class="teacher-avatar">
                        <% if (ranking.teacher.profilePicture) { %>
                          <img src="<%= ranking.teacher.profilePicture %>" alt="<%= ranking.teacher.firstName %>">
                        <% } else { %>
                          <span><%= ranking.teacher.firstName.charAt(0) %><%= ranking.teacher.lastName.charAt(0) %></span>
                        <% } %>
                      </div>
                      <div class="teacher-details">
                        <strong><%= ranking.teacher.firstName %> <%= ranking.teacher.lastName %></strong>
                        <span class="teacher-code"><%= ranking.teacher.teacherCode %></span>
                      </div>
                    </div>
                  </td>
                  <td><%= ranking.teacher.subject || 'N/A' %></td>
                  <td><span class="commission-badge"><%= ranking.teacher.gTeacherPercentage || 0 %>%</span></td>
                  <td class="amount positive"><%= ranking.totalRevenue.toLocaleString() %> EGP</td>
                  <td class="amount"><%= ranking.gTeacherCommission.toLocaleString() %> EGP</td>
                  <td class="amount positive"><%= ranking.teacherNet.toLocaleString() %> EGP</td>
                  <td><span class="order-count"><%= ranking.orderCount %></span></td>
                  <td>
                    <% if (ranking.refundCount > 0) { %>
                      <span class="refund-badge"><%= ranking.refundCount %> (-<%= ranking.refundAmount.toLocaleString() %>)</span>
                    <% } else { %>
                      <span class="no-refunds">None</span>
                    <% } %>
                  </td>
                  <td>
                    <button class="btn btn-sm btn-primary" onclick="openInvoiceModal('<%= ranking.teacher._id %>', '<%= ranking.teacher.firstName %> <%= ranking.teacher.lastName %>')">
                      <i class="fas fa-file-invoice"></i>
                      Generate Invoice
                    </button>
                  </td>
                </tr>
                <% }); %>
              </tbody>
            </table>
          </div>
        </div>

        <!-- All Teachers Grid (for quick access) -->
        <div class="section-card">
          <div class="section-header">
            <h2><i class="fas fa-users"></i> All Teachers - Quick Invoice Access</h2>
          </div>
          
          <div class="teachers-grid">
            <% teachers.forEach(teacher => { %>
            <div class="teacher-card">
              <div class="teacher-card-avatar">
                <% if (teacher.profilePicture) { %>
                  <img src="<%= teacher.profilePicture %>" alt="<%= teacher.firstName %>">
                <% } else { %>
                  <span><%= teacher.firstName.charAt(0) %><%= teacher.lastName.charAt(0) %></span>
                <% } %>
              </div>
              <div class="teacher-card-info">
                <h4><%= teacher.firstName %> <%= teacher.lastName %></h4>
                <p><%= teacher.subject || 'No Subject' %></p>
                <span class="commission-tag"><%= teacher.gTeacherPercentage || 0 %>% Commission</span>
              </div>
              <button class="invoice-btn" onclick="openInvoiceModal('<%= teacher._id %>', '<%= teacher.firstName %> <%= teacher.lastName %>')">
                <i class="fas fa-file-invoice-dollar"></i>
                Invoice
              </button>
            </div>
            <% }); %>
          </div>
        </div>

      </div>
    </div>
  </main>
</div>

<!-- Invoice Generation Modal -->
<div class="modal-overlay" id="invoiceModal">
  <div class="modal-container invoice-modal">
    <div class="modal-header">
      <h3><i class="fas fa-file-invoice-dollar"></i> Generate Invoice</h3>
      <button class="modal-close" onclick="closeInvoiceModal()">&times;</button>
    </div>
    
    <div class="modal-body">
      <!-- Step 1: Date Range Selection -->
      <div class="invoice-step" id="step1">
        <h4>Select Date Range for <span id="teacherNameDisplay"></span></h4>
        
        <div class="date-range-options">
          <button class="date-option" onclick="selectDateRange('lastWeek')">
            <i class="fas fa-calendar-week"></i>
            Last Week
          </button>
          <button class="date-option" onclick="selectDateRange('lastMonth')">
            <i class="fas fa-calendar-alt"></i>
            Last Month
          </button>
          <button class="date-option" onclick="selectDateRange('lastYear')">
            <i class="fas fa-calendar"></i>
            Last Year
          </button>
          <button class="date-option" onclick="selectDateRange('custom')">
            <i class="fas fa-calendar-plus"></i>
            Custom Range
          </button>
        </div>
        
        <div class="custom-date-range" id="customDateRange" style="display: none;">
          <div class="date-inputs">
            <div class="date-field">
              <label>Start Date</label>
              <input type="date" id="startDate">
            </div>
            <div class="date-field">
              <label>End Date</label>
              <input type="date" id="endDate">
            </div>
          </div>
          <button class="btn btn-primary" onclick="fetchInvoiceData()">
            <i class="fas fa-search"></i>
            Fetch Data
          </button>
        </div>
      </div>

      <!-- Step 2: Invoice Preview & Edit -->
      <div class="invoice-step" id="step2" style="display: none;">
        <div class="invoice-actions-top">
          <button class="btn btn-outline" onclick="goBackToStep1()">
            <i class="fas fa-arrow-left"></i>
            Change Date Range
          </button>
          <button class="btn btn-success" onclick="downloadInvoicePDF()">
            <i class="fas fa-download"></i>
            Download PDF
          </button>
        </div>

        <!-- Editable Invoice Preview -->
        <div class="invoice-preview-container">
          <div class="invoice-preview" id="invoicePreview">
            <!-- Invoice will be rendered here -->
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Invoice Template (Hidden, for PDF generation) -->
<div id="invoiceTemplate" style="display: none;">
  <div class="invoice-document" id="invoiceDocument">
    <!-- This will be populated dynamically -->
  </div>
</div>

<style>
  /* Analysis Page Styles */
  .analysis-container {
    padding: 0;
  }

  .analysis-header {
    background: linear-gradient(135deg, #3a92bd 0%, #0c5374 100%);
    border-radius: 16px;
    padding: 30px;
    margin-bottom: 24px;
    color: white;
    box-shadow: 0 10px 40px rgba(58, 146, 189, 0.25);
  }

  .header-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .header-left {
    display: flex;
    align-items: center;
    gap: 20px;
  }

  .header-icon {
    width: 70px;
    height: 70px;
    background: rgba(255,255,255,0.15);
    border-radius: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 32px;
  }

  .header-info h1 {
    font-size: 28px;
    font-weight: 700;
    margin: 0 0 8px 0;
  }

  .header-info p {
    font-size: 14px;
    opacity: 0.85;
    margin: 0;
  }

  /* Stats Grid */
  .stats-grid {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 16px;
    margin-bottom: 24px;
  }

  .stat-card {
    background: var(--card-bg, #fff);
    border-radius: 12px;
    padding: 20px;
    display: flex;
    align-items: center;
    gap: 16px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    border: 1px solid var(--border-color, #e5e7eb);
  }

  .stat-icon {
    width: 50px;
    height: 50px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 22px;
  }

  /* Dashboard-matching colors */
  .stat-card.revenue .stat-icon { background: linear-gradient(135deg, #10b981, #059669); color: white; }
  .stat-card.commission .stat-icon { background: linear-gradient(135deg, #3a92bd, #0c5374); color: white; }
  .stat-card.teacher-net .stat-icon { background: linear-gradient(135deg, #f59e0b, #d97706); color: white; }
  .stat-card.orders .stat-icon { background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: white; }
  .stat-card.refunds .stat-icon { background: linear-gradient(135deg, #ef4444, #dc2626); color: white; }
  
  .stat-card.revenue .stat-value { color: #10b981; }
  .stat-card.commission .stat-value { color: #3a92bd; }
  .stat-card.teacher-net .stat-value { color: #f59e0b; }
  .stat-card.orders .stat-value { color: #8b5cf6; }

  .stat-content {
    display: flex;
    flex-direction: column;
  }

  .stat-value {
    font-size: 24px;
    font-weight: 700;
    color: var(--text-primary, #111827);
  }

  .stat-value.negative {
    color: #dc2626;
  }

  .stat-label {
    font-size: 13px;
    color: var(--text-secondary, #6b7280);
  }

  /* Section Card */
  .section-card {
    background: var(--card-bg, #fff);
    border-radius: 16px;
    padding: 24px;
    margin-bottom: 24px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    border: 1px solid var(--border-color, #e5e7eb);
  }

  .section-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 20px;
    padding-bottom: 16px;
    border-bottom: 1px solid var(--border-color, #e5e7eb);
  }

  .section-header h2 {
    font-size: 18px;
    font-weight: 600;
    color: var(--text-primary, #111827);
    display: flex;
    align-items: center;
    gap: 10px;
    margin: 0;
  }

  .section-header h2 i {
    color: #3a92bd;
  }

  .section-header .badge {
    background: rgba(58, 146, 189, 0.15);
    color: #3a92bd;
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
  }

  /* Rankings Table */
  .rankings-table-container {
    overflow-x: auto;
  }

  .rankings-table {
    width: 100%;
    border-collapse: collapse;
  }

  .rankings-table th,
  .rankings-table td {
    padding: 14px 12px;
    text-align: left;
    border-bottom: 1px solid var(--border-color, #e5e7eb);
  }

  .rankings-table th {
    background: var(--table-header-bg, #f9fafb);
    font-weight: 600;
    font-size: 13px;
    color: var(--text-secondary, #6b7280);
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .rankings-table tbody tr:hover {
    background: var(--table-hover-bg, #f9fafb);
  }

  .rank-badge {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 13px;
  }

  .rank-1 { background: linear-gradient(135deg, #ffd700, #ffb300); color: #000; }
  .rank-2 { background: linear-gradient(135deg, #c0c0c0, #a8a8a8); color: #000; }
  .rank-3 { background: linear-gradient(135deg, #cd7f32, #b8690e); color: #fff; }
  .rank-default { background: #e5e7eb; color: #374151; }

  .teacher-info {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .teacher-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: linear-gradient(135deg, #3a92bd, #0c5374);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 600;
    font-size: 14px;
    overflow: hidden;
  }

  .teacher-avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .teacher-details {
    display: flex;
    flex-direction: column;
  }

  .teacher-details strong {
    color: var(--text-primary, #111827);
    font-size: 14px;
  }

  .teacher-code {
    font-size: 12px;
    color: var(--text-secondary, #6b7280);
  }

  .commission-badge {
    background: rgba(58, 146, 189, 0.15);
    color: #3a92bd;
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 600;
  }

  .amount {
    font-weight: 600;
    font-size: 14px;
  }

  .amount.positive {
    color: #16a34a;
  }

  .order-count {
    background: rgba(139, 92, 246, 0.15);
    color: #8b5cf6;
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 600;
  }

  .refund-badge {
    background: #fee2e2;
    color: #dc2626;
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 600;
  }

  .no-refunds {
    color: #16a34a;
    font-size: 13px;
  }

  /* Teachers Grid */
  .teachers-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 16px;
  }

  .teacher-card {
    background: var(--card-bg, #fff);
    border: 1px solid var(--border-color, #e5e7eb);
    border-radius: 12px;
    padding: 16px;
    display: flex;
    align-items: center;
    gap: 14px;
    transition: all 0.2s ease;
  }

  .teacher-card:hover {
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    transform: translateY(-2px);
  }

  .teacher-card-avatar {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background: linear-gradient(135deg, #3a92bd, #0c5374);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 600;
    font-size: 16px;
    flex-shrink: 0;
    overflow: hidden;
  }

  .teacher-card-avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .teacher-card-info {
    flex: 1;
    min-width: 0;
  }

  .teacher-card-info h4 {
    margin: 0 0 4px 0;
    font-size: 14px;
    font-weight: 600;
    color: var(--text-primary, #111827);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .teacher-card-info p {
    margin: 0 0 6px 0;
    font-size: 12px;
    color: var(--text-secondary, #6b7280);
  }

  .commission-tag {
    background: #f3f4f6;
    padding: 2px 8px;
    border-radius: 4px;
    font-size: 11px;
    color: var(--text-secondary, #6b7280);
  }

  .invoice-btn {
    background: linear-gradient(135deg, #3a92bd, #0c5374);
    color: white;
    border: none;
    padding: 10px 16px;
    border-radius: 8px;
    font-size: 13px;
    font-weight: 500;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 6px;
    transition: all 0.2s ease;
  }

  .invoice-btn:hover {
    background: linear-gradient(135deg, #0c5374, #094260);
    transform: translateY(-1px);
  }

  /* Modal Styles */
  .modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.6);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 9999;
    padding: 20px;
  }

  .modal-overlay.active {
    display: flex;
  }

  .modal-container {
    background: var(--card-bg, #fff);
    border-radius: 16px;
    width: 100%;
    max-width: 1000px;
    max-height: 90vh;
    overflow: hidden;
    display: flex;
    flex-direction: column;
  }

  .invoice-modal {
    max-width: 1200px;
  }

  .modal-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 20px 24px;
    border-bottom: 1px solid var(--border-color, #e5e7eb);
  }

  .modal-header h3 {
    margin: 0;
    font-size: 18px;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 10px;
    color: var(--text-primary, #111827);
  }

  .modal-header h3 i {
    color: #3a92bd;
  }

  .modal-close {
    width: 36px;
    height: 36px;
    border: none;
    background: var(--bg-secondary, #f3f4f6);
    border-radius: 50%;
    font-size: 20px;
    cursor: pointer;
    color: var(--text-secondary, #6b7280);
    transition: all 0.2s ease;
  }

  .modal-close:hover {
    background: #fee2e2;
    color: #dc2626;
  }

  .modal-body {
    padding: 24px;
    overflow-y: auto;
    flex: 1;
  }

  /* Invoice Step Styles */
  .invoice-step h4 {
    margin: 0 0 20px 0;
    font-size: 16px;
    color: var(--text-primary, #111827);
  }

  .date-range-options {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 12px;
    margin-bottom: 20px;
  }

  .date-option {
    background: var(--bg-secondary, #f9fafb);
    border: 2px solid var(--border-color, #e5e7eb);
    padding: 20px;
    border-radius: 12px;
    cursor: pointer;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 10px;
    transition: all 0.2s ease;
    font-size: 14px;
    font-weight: 500;
    color: var(--text-primary, #111827);
  }

  .date-option i {
    font-size: 24px;
    color: #3a92bd;
  }

  .date-option:hover,
  .date-option.active {
    border-color: #3a92bd;
    background: rgba(58, 146, 189, 0.1);
  }

  .custom-date-range {
    background: var(--bg-secondary, #f9fafb);
    padding: 20px;
    border-radius: 12px;
    margin-top: 16px;
  }

  .date-inputs {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
    margin-bottom: 16px;
  }

  .date-field label {
    display: block;
    font-size: 13px;
    font-weight: 500;
    color: var(--text-secondary, #6b7280);
    margin-bottom: 6px;
  }

  .date-field input {
    width: 100%;
    padding: 12px;
    border: 1px solid var(--border-color, #e5e7eb);
    border-radius: 8px;
    font-size: 14px;
    background: var(--card-bg, #fff);
    color: var(--text-primary, #111827);
  }

  .invoice-actions-top {
    display: flex;
    justify-content: space-between;
    margin-bottom: 20px;
  }

  /* Invoice Preview */
  .invoice-preview-container {
    background: #f3f4f6;
    border-radius: 12px;
    padding: 20px;
    max-height: 600px;
    overflow-y: auto;
  }

  .invoice-preview {
    background: white;
    padding: 40px;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    min-height: 800px;
  }

  /* Invoice Document Styles */
  .invoice-doc {
    font-family: 'Segoe UI', Arial, sans-serif;
    color: #333;
  }

  .invoice-doc-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 30px;
  }

  .invoice-brand {
    display: flex;
    flex-direction: column;
  }

  .invoice-brand h1 {
    font-size: 36px;
    font-weight: 700;
    color: #1e3a5f;
    margin: 0;
  }

  .invoice-brand .arabic-text {
    font-size: 14px;
    color: #666;
    margin: 4px 0;
  }

  .invoice-brand .tagline {
    font-size: 14px;
    color: #333;
    font-weight: 500;
  }

  .invoice-title-section {
    text-align: right;
  }

  .invoice-title-section h2 {
    font-size: 42px;
    color: #0077b6;
    font-weight: 700;
    margin: 0;
  }

  .invoice-logo {
    width: 80px;
    margin-top: 10px;
  }

  .invoice-info-section {
    display: flex;
    justify-content: space-between;
    margin-bottom: 30px;
    gap: 30px;
  }

  .invoice-bill-to {
    flex: 1;
  }

  .invoice-bill-to-header {
    background: #1e3a5f;
    color: white;
    padding: 8px 16px;
    font-weight: 600;
    font-size: 14px;
    border-radius: 4px 4px 0 0;
  }

  .invoice-bill-to-content {
    border: 1px solid #ddd;
    border-top: none;
    padding: 12px 16px;
  }

  .invoice-bill-to-content p {
    margin: 6px 0;
    font-size: 14px;
  }

  .invoice-dates {
    flex: 1;
  }

  .invoice-dates table {
    width: 100%;
    border-collapse: collapse;
  }

  .invoice-dates td {
    padding: 8px 12px;
    border: 1px solid #ddd;
    font-size: 14px;
  }

  .invoice-dates td:first-child {
    background: #f5f5f5;
    font-weight: 500;
    width: 40%;
  }

  /* Course Tables */
  .course-section {
    margin-bottom: 30px;
  }

  .course-header {
    display: flex;
    align-items: center;
    margin-bottom: 10px;
    padding: 10px 0;
    border-bottom: 2px solid #1e3a5f;
  }

  .course-header-label {
    font-size: 14px;
    color: #666;
  }

  .course-header-title {
    font-size: 16px;
    font-weight: 600;
    color: #333;
    margin-left: 10px;
  }

  .course-header-total {
    margin-left: auto;
    text-align: right;
  }

  .course-header-total-label {
    font-size: 12px;
    color: #666;
  }

  .course-header-total-value {
    font-size: 20px;
    font-weight: 700;
    color: #333;
  }

  .course-table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 20px;
  }

  .course-table th {
    background: #1e3a5f;
    color: white;
    padding: 10px 12px;
    font-size: 13px;
    font-weight: 600;
    text-align: left;
  }

  .course-table td {
    padding: 10px 12px;
    border-bottom: 1px solid #eee;
    font-size: 13px;
  }

  .course-table tr:nth-child(even) {
    background: #f9f9f9;
  }

  .status-refund {
    color: #dc2626;
    font-weight: 500;
  }

  .revenue-positive {
    color: #16a34a;
    font-weight: 600;
  }

  .revenue-negative {
    color: #dc2626;
    font-weight: 600;
  }

  /* Invoice Totals */
  .invoice-description-section {
    margin-bottom: 30px;
  }

  .invoice-description-header {
    display: flex;
    background: #1e3a5f;
    color: white;
    font-weight: 600;
    font-size: 14px;
  }

  .invoice-description-header > div {
    padding: 10px 12px;
  }

  .invoice-description-header .desc-col {
    flex: 1;
  }

  .invoice-description-header .total-col {
    width: 150px;
    text-align: right;
  }

  .invoice-description-body {
    border: 1px solid #ddd;
    border-top: none;
  }

  .invoice-description-row {
    display: flex;
    border-bottom: 1px solid #eee;
  }

  .invoice-description-row:last-child {
    border-bottom: none;
  }

  .invoice-description-row > div {
    padding: 10px 12px;
    font-size: 14px;
  }

  .invoice-description-row .desc-col {
    flex: 1;
  }

  .invoice-description-row .total-col {
    width: 150px;
    text-align: right;
    font-weight: 600;
  }

  .invoice-description-row.highlight {
    background: #e6f3ff;
  }

  /* Invoice Summary */
  .invoice-summary-section {
    display: flex;
    gap: 30px;
    margin-bottom: 30px;
  }

  .invoice-notes {
    flex: 1;
  }

  .invoice-notes-header {
    background: #1e3a5f;
    color: white;
    padding: 10px 16px;
    font-weight: 600;
    font-size: 14px;
    border-radius: 4px 4px 0 0;
  }

  .invoice-notes-content {
    border: 1px solid #ddd;
    border-top: none;
    padding: 20px 16px;
    min-height: 100px;
    font-size: 14px;
    color: #666;
  }

  .invoice-totals {
    width: 280px;
  }

  .invoice-totals-row {
    display: flex;
    justify-content: space-between;
    padding: 12px 16px;
    border: 1px solid #ddd;
    border-bottom: none;
    font-size: 14px;
  }

  .invoice-totals-row:last-child {
    border-bottom: 1px solid #ddd;
  }

  .invoice-totals-row.total-row {
    background: #1e3a5f;
    color: white;
    font-weight: 600;
  }

  .invoice-totals-row .label {
    color: #666;
  }

  .invoice-totals-row.total-row .label {
    color: white;
  }

  .invoice-totals-row .value {
    font-weight: 600;
    font-size: 18px;
  }

  /* Invoice Footer */
  .invoice-footer {
    text-align: center;
    padding-top: 30px;
    border-top: 2px solid #0077b6;
    margin-top: 30px;
  }

  .invoice-footer h3 {
    color: #0077b6;
    font-size: 18px;
    margin: 0 0 10px 0;
  }

  .invoice-footer p {
    color: #666;
    font-size: 12px;
    margin: 4px 0;
  }

  /* Editable Fields */
  .editable-field {
    border: 1px dashed transparent;
    padding: 2px 4px;
    border-radius: 4px;
    transition: all 0.2s ease;
    cursor: text;
  }

  .editable-field:hover {
    border-color: #3a92bd;
    background: rgba(58, 146, 189, 0.1);
  }

  .editable-field:focus {
    outline: none;
    border-color: #3a92bd;
    background: rgba(58, 146, 189, 0.1);
  }

  /* Responsive */
  @media (max-width: 1200px) {
    .stats-grid {
      grid-template-columns: repeat(3, 1fr);
    }
  }

  @media (max-width: 768px) {
    .stats-grid {
      grid-template-columns: repeat(2, 1fr);
    }

    .date-range-options {
      grid-template-columns: repeat(2, 1fr);
    }

    .header-content {
      flex-direction: column;
      gap: 16px;
    }
  }

  /* Dark Theme */
  .dark-theme .analysis-header {
    background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
  }

  .dark-theme .stat-card,
  .dark-theme .section-card,
  .dark-theme .teacher-card {
    background: #1e293b;
    border-color: #334155;
  }

  .dark-theme .invoice-preview {
    background: #1e293b;
  }

  .dark-theme .invoice-doc {
    color: #e2e8f0;
  }

  .dark-theme .invoice-bill-to-content,
  .dark-theme .invoice-dates td,
  .dark-theme .course-table td,
  .dark-theme .invoice-description-body,
  .dark-theme .invoice-notes-content,
  .dark-theme .invoice-totals-row {
    border-color: #334155;
    background: #1e293b;
  }

  .dark-theme .rankings-table th {
    background: #334155;
  }

  .dark-theme .modal-container {
    background: #1e293b;
  }

  .dark-theme .custom-date-range,
  .dark-theme .invoice-preview-container {
    background: #0f172a;
  }

  .dark-theme .date-option {
    background: #0f172a;
    border-color: #334155;
    color: #e2e8f0;
  }

  .dark-theme .date-option:hover,
  .dark-theme .date-option.active {
    border-color: #3a92bd;
    background: #1e3a5f;
  }
</style>

<script>
  // Global variables
  let currentTeacherId = null;
  let currentTeacherName = '';
  let currentInvoiceData = null;

  // Open Invoice Modal
  function openInvoiceModal(teacherId, teacherName) {
    currentTeacherId = teacherId;
    currentTeacherName = teacherName;
    document.getElementById('teacherNameDisplay').textContent = teacherName;
    document.getElementById('invoiceModal').classList.add('active');
    document.getElementById('step1').style.display = 'block';
    document.getElementById('step2').style.display = 'none';
    
    // Reset selections
    document.querySelectorAll('.date-option').forEach(btn => btn.classList.remove('active'));
    document.getElementById('customDateRange').style.display = 'none';
  }

  // Close Invoice Modal
  function closeInvoiceModal() {
    document.getElementById('invoiceModal').classList.remove('active');
    currentTeacherId = null;
    currentTeacherName = '';
    currentInvoiceData = null;
  }

  // Select Date Range
  function selectDateRange(range) {
    document.querySelectorAll('.date-option').forEach(btn => btn.classList.remove('active'));
    event.target.closest('.date-option').classList.add('active');

    const today = new Date();
    let startDate, endDate;

    switch (range) {
      case 'lastWeek':
        endDate = new Date(today);
        startDate = new Date(today);
        startDate.setDate(startDate.getDate() - 7);
        fetchInvoiceDataWithDates(startDate, endDate);
        break;
      case 'lastMonth':
        endDate = new Date(today);
        startDate = new Date(today);
        startDate.setMonth(startDate.getMonth() - 1);
        fetchInvoiceDataWithDates(startDate, endDate);
        break;
      case 'lastYear':
        endDate = new Date(today);
        startDate = new Date(today);
        startDate.setFullYear(startDate.getFullYear() - 1);
        fetchInvoiceDataWithDates(startDate, endDate);
        break;
      case 'custom':
        document.getElementById('customDateRange').style.display = 'block';
        // Set default dates
        document.getElementById('endDate').value = formatDateForInput(today);
        const lastMonth = new Date(today);
        lastMonth.setMonth(lastMonth.getMonth() - 1);
        document.getElementById('startDate').value = formatDateForInput(lastMonth);
        break;
    }
  }

  // Format date for input field
  function formatDateForInput(date) {
    return date.toISOString().split('T')[0];
  }

  // Fetch invoice data (from custom date inputs)
  function fetchInvoiceData() {
    const startDate = new Date(document.getElementById('startDate').value);
    const endDate = new Date(document.getElementById('endDate').value);
    
    if (startDate > endDate) {
      alert('Start date cannot be after end date');
      return;
    }
    
    fetchInvoiceDataWithDates(startDate, endDate);
  }

  // Fetch invoice data with specific dates
  async function fetchInvoiceDataWithDates(startDate, endDate) {
    try {
      const response = await fetch(
        `/admin/api/teacher-invoice/${currentTeacherId}?startDate=${startDate.toISOString()}&endDate=${endDate.toISOString()}`
      );
      
      const data = await response.json();
      
      if (!data.success) {
        alert(data.message || 'Failed to fetch invoice data');
        return;
      }
      
      currentInvoiceData = data.data;
      renderInvoicePreview();
      
      // Show step 2
      document.getElementById('step1').style.display = 'none';
      document.getElementById('step2').style.display = 'block';
      
    } catch (error) {
      console.error('Error fetching invoice data:', error);
      alert('Error fetching invoice data');
    }
  }

  // Go back to step 1
  function goBackToStep1() {
    document.getElementById('step1').style.display = 'block';
    document.getElementById('step2').style.display = 'none';
  }

  // Render Invoice Preview
  function renderInvoicePreview() {
    const data = currentInvoiceData;
    const preview = document.getElementById('invoicePreview');
    
    // Format dates
    const dateOptions = { year: 'numeric', month: 'long', day: 'numeric' };
    const invoiceDate = new Date().toLocaleDateString('en-US', dateOptions);
    
    let courseSectionsHTML = '';
    data.courses.forEach(course => {
      let ordersHTML = '';
      course.orders.forEach((order, idx) => {
        const statusClass = order.orderStatus === 'Refund' ? 'status-refund' : '';
        const revenueClass = order.revenue < 0 ? 'revenue-negative' : 'revenue-positive';
        ordersHTML += `
          <tr>
            <td>${idx + 1}</td>
            <td class="${statusClass}" contenteditable="true">${order.orderStatus || ''}</td>
            <td contenteditable="true">${order.firstName}</td>
            <td contenteditable="true">${order.lastName}</td>
            <td class="${revenueClass}" contenteditable="true">${order.revenue}</td>
          </tr>
        `;
      });

      courseSectionsHTML += `
        <div class="course-section">
          <div class="course-header">
            <span class="course-header-label">Subject</span>
            <span class="course-header-title editable-field" contenteditable="true">${course.title}</span>
            <div class="course-header-total">
              <div class="course-header-total-label">Total (AED)</div>
              <div class="course-header-total-value editable-field" contenteditable="true">${Math.round(course.netRevenue * 0.0735)}</div>
            </div>
          </div>
          <table class="course-table">
            <thead>
              <tr>
                <th style="width: 50px;">no.</th>
                <th style="width: 120px;">Order Status</th>
                <th>First Name</th>
                <th>Last Name</th>
                <th style="width: 100px;">Revenue</th>
              </tr>
            </thead>
            <tbody>
              ${ordersHTML}
            </tbody>
          </table>
        </div>
      `;
    });

    // Create course summary rows
    let descriptionRowsHTML = '';
    data.courses.forEach((course, idx) => {
      const highlightClass = idx % 2 === 1 ? 'highlight' : '';
      descriptionRowsHTML += `
        <div class="invoice-description-row ${highlightClass}">
          <div class="desc-col editable-field" contenteditable="true">${course.title}</div>
          <div class="total-col editable-field" contenteditable="true">${course.netRevenue.toLocaleString()}</div>
        </div>
      `;
    });

    preview.innerHTML = `
      <div class="invoice-doc">
        <!-- Header -->
        <div class="invoice-doc-header">
          <div class="invoice-brand">
            <h1 contenteditable="true">G-Teacher</h1>
            <span class="arabic-text" contenteditable="true">لتعليم أفضل!</span>
            <span class="tagline" contenteditable="true">For better education!</span>
          </div>
          <div class="invoice-title-section">
            <h2>Invoice</h2>
            <img src="/images/G-Teacher-favicon.png" alt="G-Teacher" class="invoice-logo" onerror="this.style.display='none'">
          </div>
        </div>

        <!-- Info Section -->
        <div class="invoice-info-section">
          <div class="invoice-bill-to">
            <div class="invoice-bill-to-header">Bill To:</div>
            <div class="invoice-bill-to-content">
              <p><strong>Teacher Name:</strong> <span class="editable-field" contenteditable="true">${data.teacher.name}</span></p>
              <p><strong>Sender Name:</strong> <span class="editable-field" contenteditable="true">G-Teacher</span></p>
              <p><strong>Phone:</strong> <span class="editable-field" contenteditable="true">${data.teacher.phone}</span></p>
            </div>
          </div>
          <div class="invoice-dates">
            <table>
              <tr>
                <td>Date:</td>
                <td class="editable-field" contenteditable="true">${invoiceDate}</td>
              </tr>
              <tr>
                <td>Payment of:</td>
                <td class="editable-field" contenteditable="true">${data.dateRange.displayStart} - ${data.dateRange.displayEnd}</td>
              </tr>
              <tr>
                <td>Transfer Type:</td>
                <td class="editable-field" contenteditable="true">Bank</td>
              </tr>
            </table>
          </div>
        </div>

        <!-- Course Details -->
        ${courseSectionsHTML}

        <!-- Description Summary -->
        <div class="invoice-description-section">
          <div class="invoice-description-header">
            <div class="desc-col">Description</div>
            <div class="total-col">Line Total</div>
          </div>
          <div class="invoice-description-body">
            ${descriptionRowsHTML}
          </div>
        </div>

        <!-- Notes and Totals -->
        <div class="invoice-summary-section">
          <div class="invoice-notes">
            <div class="invoice-notes-header">Special Notes and Instructions</div>
            <div class="invoice-notes-content editable-field" contenteditable="true">
              Enter any special notes or instructions here...
            </div>
          </div>
          <div class="invoice-totals">
            <div class="invoice-totals-row total-row">
              <span class="label">Total</span>
              <span>AED</span>
              <span class="value editable-field" contenteditable="true">${data.totals.totalAED.toLocaleString()}</span>
            </div>
            <div class="invoice-totals-row total-row">
              <span class="label">Total</span>
              <span>EGP</span>
              <span class="value editable-field" contenteditable="true">${data.totals.totalEGP.toLocaleString()}</span>
            </div>
          </div>
        </div>

        <!-- Footer -->
        <div class="invoice-footer">
          <h3>Thank you for being one of G-Teacher family!</h3>
          <p>G-Teacher is a long-term educational organization located in UAE, Dubai, providing knowledge to all students worldwide.</p>
          <p>Should you have any inquiries concerning this invoice, don't hesitate to contact us.</p>
        </div>
      </div>
    `;
  }

  // Download Invoice as PDF
  async function downloadInvoicePDF() {
    const element = document.getElementById('invoicePreview');
    
    const opt = {
      margin: 10,
      filename: `Invoice-${currentTeacherName.replace(/\s+/g, '-')}-${new Date().toISOString().split('T')[0]}.pdf`,
      image: { type: 'jpeg', quality: 0.98 },
      html2canvas: { scale: 2, useCORS: true },
      jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
    };

    try {
      await html2pdf().set(opt).from(element).save();
    } catch (error) {
      console.error('Error generating PDF:', error);
      alert('Error generating PDF. Please try again.');
    }
  }

  // Export all data
  function exportAllData() {
    window.location.href = '/admin/orders?export=excel';
  }

  // Close modal on outside click
  document.getElementById('invoiceModal').addEventListener('click', function(e) {
    if (e.target === this) {
      closeInvoiceModal();
    }
  });

  // Close modal on Escape key
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
      closeInvoiceModal();
    }
  });
</script>

<%- include('./partials/admin-footer') %>
