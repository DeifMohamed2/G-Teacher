<%- include('./partials/admin-header', { title, user, theme, currentPage: 'orders', pageCSS: 'orders' }) %>

<div class="admin-layout">
  <%- include('./partials/admin-sidebar', { currentPage: 'orders' }) %>

  <main class="admin-main">
    <%- include('./partials/admin-topbar', { 
      breadcrumb: 'Order Details',
      breadcrumbSubtitle: `Order #${order.orderNumber}`,
      showSearch: false
    }) %>

    <div class="admin-content">
      <div class="order-details-container">
        <!-- Order Header -->
        <div class="order-header-card">
          <div class="row g-3">
            <div class="col-12 col-lg-8">
              <div class="order-header-content">
                <div class="order-header-title">
                  <div class="order-icon-wrapper">
                    <i class="fas fa-receipt"></i>
                  </div>
                  <div>
                    <h1 class="order-id">Order #<%= order.orderNumber %></h1>
                    <div class="order-date">
                      <i class="far fa-calendar-alt"></i>
                      <span>Placed on <%= new Date(order.createdAt).toLocaleString() %></span>
                    </div>
                  </div>
                </div>
                <div class="order-status-grid">
                  <div class="status-card">
                    <div class="status-label">Order Status</div>
                    <span class="status-badge status-<%= order.status %>">
                      <%= order.statusDisplay || order.status.charAt(0).toUpperCase() + order.status.slice(1) %>
                    </span>
                  </div>
                  <div class="status-card">
                    <div class="status-label">Payment Status</div>
                    <span class="status-badge status-<%= order.paymentStatus %>">
                      <%= order.paymentStatusDisplay || order.paymentStatus.charAt(0).toUpperCase() + order.paymentStatus.slice(1) %>
                    </span>
                  </div>
                  <div class="status-card">
                    <div class="status-label">Total Amount</div>
                    <span class="amount-display">
                      <%= order.currency %> <%= order.total.toFixed(2) %>
                    </span>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-12 col-lg-4">
              <div class="order-actions">
                <% if (order.status !== 'refunded') { %>
                <form method="post" action="/admin/orders/<%= order.orderNumber %>/refund" onsubmit="return confirm('Are you sure you want to refund this order and revoke access? This action cannot be undone.')">
                  <input type="hidden" name="amount" value="<%= order.total %>">
                  <button class="btn btn-danger w-100 order-action-btn" type="submit">
                    <i class="fas fa-undo me-2"></i> Process Refund
                  </button>
                </form>
                <% } %>
          
                <a href="/admin/orders" class="btn btn-outline-secondary w-100 order-action-btn">
                  <i class="fas fa-arrow-left me-2"></i> Back to Orders
                </a>
              </div>
            </div>
          </div>
        </div>

        <!-- Order Items Section -->
        <div class="card shadow-sm admin-card mb-4">
          <div class="card-header">
            <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
              <h5 class="mb-0">
                <i class="fas fa-shopping-basket me-2"></i> Order Items
              </h5>
              <span class="badge badge-primary">
                <%= itemsSummary.length %> item<%= itemsSummary.length !== 1 ? 's' : '' %>
              </span>
            </div>
          </div>
          <div class="card-body p-0">
            <div class="table-responsive">
              <table class="table table-hover align-middle order-items-table mb-0">
                <thead>
                  <tr>
                    <th>Product</th>
                    <th>Type</th>
                    <th class="text-end">Price</th>
                  </tr>
                </thead>
                <tbody>
                  <% itemsSummary.forEach(item => { %>
                  <tr>
                    <td>
                      <div class="d-flex align-items-center">
                        <img src="<%= item.thumbnail || (item.type === 'book' ? '/images/book-placeholder.jpg' : (item.type === 'bundle' ? '/images/bundle-placeholder.png' : (item.type === 'course' ? '/images/course-placeholder.png' : '/images/quiz-placeholder.png'))) %>" alt="<%= item.title %>" class="product-thumbnail me-3" onerror="this.src='https://via.placeholder.com/60x60?text=<%= item.type %>'">
                        <div class="product-details">
                          <h6 class="mb-1"><%= item.title %></h6>
                          <% if (item.type === 'book' && item.description) { %>
                          <small class="text-muted"><%= item.description %></small>
                          <% } %>
                          <% if (item.courseCode || item.bundleCode) { %>
                          <br><small class="text-muted">Code: <%= item.courseCode || item.bundleCode %></small>
                          <% } %>
                        </div>
                      </div>
                    </td>
                    <td>
                      <span class="product-type <%= item.type.toLowerCase() %>">
                        <%= item.type === 'book' ? 'Physical Book' : item.type.charAt(0).toUpperCase() + item.type.slice(1) %>
                      </span>
                      <% if (item.type === 'book' && item.description) { %>
                      <br><small class="text-muted"><%= item.description %></small>
                      <% } %>
                    </td>
                    <td class="text-end fw-bold">
                      <%= order.currency %> <%= item.price.toFixed(2) %>
                    </td>
                  </tr>
                  <% }) %>
                </tbody>
              </table>
            </div>
          </div>
          <% if(order.notes) { %>
          <div class="card-footer">
            <div class="order-notes">
              <strong>Order Notes:</strong> <%= order.notes %>
            </div>
          </div>
          <% } %>
        </div>

        <!-- Order Summary -->
        <div class="card shadow-sm admin-card mb-4 order-summary-card">
          <div class="card-header order-summary-header">
            <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
              <h5 class="mb-0">
                <i class="fas fa-calculator me-2"></i> Order Summary
              </h5>
              <% if (bookOrders && bookOrders.length > 0) { %>
              <span class="badge book-count-badge">
                <i class="fas fa-book me-1"></i><%= bookOrders.length %> Book<%= bookOrders.length !== 1 ? 's' : '' %>
              </span>
              <% } %>
            </div>
          </div>
          <div class="card-body">
      
            <% if (bookOrders && bookOrders.length > 0) { %>
            <div class="book-orders-section">
              <div class="book-orders-header">
                <div class="book-orders-title">
                  <i class="fas fa-book"></i>
                  <span>Physical Books</span>
                </div>
                <a href="/admin/book-orders?search=<%= order.orderNumber %>" class="book-orders-link">
                  View Details <i class="fas fa-arrow-right"></i>
                </a>
              </div>
              <div class="book-orders-grid">
                <% bookOrders.forEach(bookOrder => { %>
                <div class="book-order-card">
                  <div class="book-order-header">
                    <div class="book-order-info">
                      <div class="book-order-number">
                        <a href="/admin/book-orders" class="order-number-link">#<%= bookOrder.orderNumber %></a>
                      </div>
                      <div class="book-order-name"><%= bookOrder.bookName %></div>
                      <% if (bookOrder.bundle) { %>
                      <span class="badge bundle-badge"><%= bookOrder.bundle.bundleCode %></span>
                      <% } %>
                    </div>
                  </div>
                  <div class="book-order-footer">
                
                    <span class="book-order-price">EGP <%= bookOrder.bookPrice.toFixed(2) %></span>
                  </div>
                  <% if (bookOrder.trackingNumber) { %>
                  <div class="book-order-tracking">
                    <div class="tracking-label">Tracking:</div>
                    <code class="tracking-code"><%= bookOrder.trackingNumber %></code>
                  </div>
                  <% } %>
                </div>
                <% }); %>
              </div>
            </div>
            <% } %>

            <hr class="summary-divider">
            <div class="summary-row total-row">
              <span class="summary-label">Total</span>
              <span class="summary-value total-amount"><%= order.currency %> <%= summary.total.toFixed(2) %></span>
            </div>
          </div>
        </div>

        <!-- Information Cards -->
        <div class="row g-4">
          <!-- Customer Information -->
          <div class="col-12 col-md-6 col-lg-4 col-xl-3">
            <div class="card shadow-sm admin-card h-100">
              <div class="card-header">
                <h5 class="mb-0">
                  <i class="fas fa-user me-2"></i> Customer Information
                </h5>
              </div>
              <div class="card-body">
                <div class="customer-info">
                  <div class="customer-details mb-3">
                    <h6 class="mb-1"><%= order.billingAddress.firstName %> <%= order.billingAddress.lastName %></h6>
                    <small class="text-muted"><%= order.billingAddress.email %></small>
                  </div>
                  <div class="contact-info">
                    <div class="contact-item">
                      <i class="fas fa-phone"></i>
                      <span><%= order.billingAddress.phone %></span>
                    </div>
                  </div>
                  <div class="billing-address mt-3">
                    <h6 class="mb-2">Billing Address</h6>
                    <div class="address-text">
                      <%= order.billingAddress.address %><br>
                      <%= order.billingAddress.city %>, <%= order.billingAddress.state %> <%= order.billingAddress.zipCode %><br>
                      <%= order.billingAddress.country %>
                    </div>
                  </div>
                </div>
              </div>
              <div class="card-footer">
                <a href="/admin/students?search=<%= order.billingAddress.email %>" class="btn btn-primary w-100">
                  <i class="fas fa-user me-2"></i> View Customer Profile
                </a>
              </div>
            </div>
          </div>

          <!-- Payment Information -->
          <div class="col-12 col-md-6 col-lg-6 col-xl-5">
            <div class="card shadow-sm admin-card h-100 payment-info-card">
              <div class="card-header payment-card-header">
                <h5 class="mb-0">
                  <i class="fas fa-credit-card me-2"></i> Payment Information
                </h5>
              </div>
              <div class="card-body">
                <div class="payment-info">
                  <div class="payment-method-section">
                    <div class="method-icon-wrapper">
                      <i class="fas fa-credit-card"></i>
                    </div>
                    <div class="method-details">
                      <h6 class="method-title">Payment Method</h6>
                      <span class="badge badge-method">
                        <%= order.paymentMethod.replace('_', ' ').toUpperCase() %>
                      </span>
                    </div>
                  </div>
                  <div class="payment-details-section">
                    <div class="detail-row">
                      <span class="detail-label">
                        <i class="fas fa-network-wired me-1"></i> Gateway
                      </span>
                      <span class="detail-value">Paymob</span>
                    </div>
                    <div class="detail-row">
                      <span class="detail-label">
                        <i class="fas fa-coins me-1"></i> Currency
                      </span>
                      <span class="detail-value"><%= order.currency %></span>
                    </div>
                    <% if (order.paymentIntentId) { %>
                    <div class="detail-row copyable-row">
                      <span class="detail-label">
                        <i class="fas fa-fingerprint me-1"></i> Intent ID
                      </span>
                      <div class="detail-value-wrapper">
                        <code class="detail-value copyable-value" data-value="<%= order.paymentIntentId %>"><%= order.paymentIntentId %></code>
                        <button class="copy-btn" onclick="copyPaymentValue(this, '<%= order.paymentIntentId %>')" title="Copy to clipboard">
                          <i class="fas fa-copy"></i>
                        </button>
                      </div>
                    </div>
                    <% } %>
                    <% if (order.paymobTransactionId) { %>
                    <div class="detail-row copyable-row">
                      <span class="detail-label">
                        <i class="fas fa-exchange-alt me-1"></i> Paymob Transaction ID
                      </span>
                      <div class="detail-value-wrapper">
                        <code class="detail-value copyable-value" data-value="<%= order.paymobTransactionId %>"><%= order.paymobTransactionId %></code>
                        <button class="copy-btn" onclick="copyPaymentValue(this, '<%= order.paymobTransactionId %>')" title="Copy to clipboard">
                          <i class="fas fa-copy"></i>
                        </button>
                      </div>
                    </div>
                    <% } %>
                    <% if (order.paymobOrderId) { %>
                    <div class="detail-row copyable-row">
                      <span class="detail-label">
                        <i class="fas fa-shopping-cart me-1"></i> Paymob Order ID
                      </span>
                      <div class="detail-value-wrapper">
                        <code class="detail-value copyable-value" data-value="<%= order.paymobOrderId %>"><%= order.paymobOrderId %></code>
                        <button class="copy-btn" onclick="copyPaymentValue(this, '<%= order.paymobOrderId %>')" title="Copy to clipboard">
                          <i class="fas fa-copy"></i>
                        </button>
                      </div>
                    </div>
                    <% } %>
                    <% if (order.status === 'failed' && order.failureReason) { %>
                    <div class="detail-row error-row">
                      <span class="detail-label text-danger">
                        <i class="fas fa-exclamation-triangle me-1"></i> Failure Reason
                      </span>
                      <span class="detail-value small text-danger"><%= order.failureReason %></span>
                    </div>
                    <% } %>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Refund Information (if applicable) -->
          <% if (order.status === 'refunded') { %>
          <div class="col-12 col-md-6 col-lg-4 col-xl-3">
            <div class="card shadow-sm admin-card refund-alert h-100">
              <div class="card-header">
                <h5 class="mb-0 text-danger">
                  <i class="fas fa-exclamation-circle me-2"></i> Refund Processed
                </h5>
              </div>
              <div class="card-body">
                <div class="refund-details">
                  <div class="detail-row">
                    <span class="detail-label">Refund Amount</span>
                    <span class="detail-value text-danger fw-bold">
                      <%= order.currency %> <%= (order.refundAmount||0).toFixed(2) %>
                    </span>
                  </div>
                  <div class="detail-row">
                    <span class="detail-label">Refund Date</span>
                    <span class="detail-value"><%= new Date(order.refundedAt).toLocaleString() %></span>
                  </div>
                  <% if (order.refundReason) { %>
                  <div class="detail-row">
                    <span class="detail-label">Reason</span>
                    <span class="detail-value"><%= order.refundReason %></span>
                  </div>
                  <% } %>
                </div>
                <div class="alert alert-warning mt-3 mb-0">
                  <i class="fas fa-info-circle me-2"></i>
                  Access to purchased items has been revoked.
                </div>
              </div>
            </div>
          </div>
          <% } %>

        </div>
      </div>
    </div>
  </main>
</div>

<link rel="stylesheet" href="/css/admin-orders.css">

<script>
  // Copy payment value to clipboard
  function copyPaymentValue(button, value) {
    navigator.clipboard.writeText(value).then(() => {
      const icon = button.querySelector('i');
      const originalClass = icon.className;
      
      // Change icon to checkmark
      icon.className = 'fas fa-check';
      button.classList.add('copied');
      button.setAttribute('title', 'Copied!');
      
      // Show toast notification
      showCopyNotification('Copied to clipboard!');
      
      // Reset after 2 seconds
      setTimeout(() => {
        icon.className = originalClass;
        button.classList.remove('copied');
        button.setAttribute('title', 'Copy to clipboard');
      }, 2000);
    }).catch(err => {
      console.error('Failed to copy:', err);
      showCopyNotification('Failed to copy. Please try again.', 'error');
    });
  }

  // Show copy notification
  function showCopyNotification(message, type = 'success') {
    // Remove existing notification if any
    const existing = document.querySelector('.copy-notification');
    if (existing) {
      existing.remove();
    }

    // Create notification element
    const notification = document.createElement('div');
    notification.className = `copy-notification ${type}`;
    notification.innerHTML = `
      <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
      <span>${message}</span>
    `;
    
    document.body.appendChild(notification);
    
    // Animate in
    setTimeout(() => {
      notification.classList.add('show');
    }, 10);
    
    // Remove after 3 seconds
    setTimeout(() => {
      notification.classList.remove('show');
      setTimeout(() => {
        if (notification.parentNode) {
          notification.remove();
        }
      }, 300);
    }, 3000);
  }
</script>

<%- include('partials/admin-footer') %>