<%- include('./partials/admin-header', { pageCSS: 'courses' }) %>

<!-- SweetAlert2 -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<div class="admin-layout">
  <%- include('./partials/admin-sidebar', { currentPage: 'courses' }) %>

  <main class="admin-main">
    <%- include('./partials/admin-topbar', { 
        breadcrumb: 'Courses',
        breadcrumbSubtitle: 'Manage Your Courses',
        showSearch: true
    }) %>

    <div class="admin-content">
      <div class="courses-container">

        <!-- Page Header -->
        <div class="page-header">
          <div class="header-left">
            <h1 class="page-title">
              <i class="fas fa-graduation-cap"></i>
              Course Management
            </h1>
            <p class="page-subtitle">Organize and manage all your courses</p>
          </div>
          <div class="header-actions">
            <button class="btn-secondary" data-bs-toggle="modal" data-bs-target="#examPeriodModal">
              <i class="fas fa-calendar-alt"></i>
              <span>Exam Periods</span>
            </button>
            <button class="btn-primary" data-bs-toggle="modal" data-bs-target="#createCourseModal">
              <i class="fas fa-plus"></i>
              <span>New Course</span>
            </button>
          </div>
        </div>

        <!-- Quick Stats -->
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-icon blue"><i class="fas fa-book-open"></i></div>
            <div class="stat-info">
              <span class="stat-value"><%= stats.totalCourses %></span>
              <span class="stat-label">Total Courses</span>
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-icon green"><i class="fas fa-check-circle"></i></div>
            <div class="stat-info">
              <span class="stat-value"><%= stats.publishedCourses %></span>
              <span class="stat-label">Published</span>
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-icon orange"><i class="fas fa-edit"></i></div>
            <div class="stat-info">
              <span class="stat-value"><%= stats.draftCourses %></span>
              <span class="stat-label">Draft</span>
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-icon purple"><i class="fas fa-users"></i></div>
            <div class="stat-info">
              <span class="stat-value"><%= stats.totalEnrollments %></span>
              <span class="stat-label">Enrollments</span>
            </div>
          </div>
        </div>

        <!-- Filter Section - Collapsible -->
        <div class="filter-section">
          <div class="filter-header" onclick="toggleFilterSection()">
            <div class="filter-title">
              <i class="fas fa-filter"></i>
              <span>Filter Courses</span>
              <span class="filter-badge" id="activeFiltersCount" style="display: none;">0</span>
            </div>
            <div class="filter-toggle">
              <span id="filterStatus">Click to filter by Exam Period & Teacher</span>
              <i class="fas fa-chevron-down" id="filterIcon"></i>
            </div>
          </div>

          <div class="filter-content" id="filterContent" style="display: none;">
            <!-- Step 0: Curriculum Type Selection -->
            <div class="filter-step">
              <h4 class="step-title">
                <span class="step-number">1</span>
                Select Curriculum Type
              </h4>
              <div class="curriculum-type-pills" id="curriculumTypePills">
                <button class="curriculum-pill active" data-curriculum="all" onclick="selectCurriculumType('all')">
                  <i class="fas fa-globe"></i>
                  <span>All Curricula</span>
                </button>
                <button class="curriculum-pill" data-curriculum="IGCSE" onclick="selectCurriculumType('IGCSE')">
                  <i class="fas fa-graduation-cap"></i>
                  <span>IGCSE</span>
                </button>
                <button class="curriculum-pill" data-curriculum="American" onclick="selectCurriculumType('American')">
                  <i class="fas fa-flag-usa"></i>
                  <span>American</span>
                </button>
              </div>
            </div>

            <!-- Step 1: Exam Period Selection -->
            <div class="filter-step">
              <h4 class="step-title">
                <span class="step-number">2</span>
                Select Exam Period
              </h4>
              <div class="exam-period-pills" id="examPeriodPills">
                <button class="period-pill active" data-period="all" onclick="selectExamPeriod('all')">
                  <i class="fas fa-globe"></i>
                  <span>All Periods</span>
                  <span class="pill-count"><%= stats.totalCourses %></span>
                </button>
                <% 
                  const periodCounts = {};
                  if (courses && courses.length > 0) {
                    courses.forEach(course => {
                      const periodId = course.examPeriod ? course.examPeriod._id : 'none';
                      const periodName = course.examPeriod ? course.examPeriod.name : 'No Period';
                      const curriculumType = course.examPeriod ? (course.examPeriod.curriculumType || 'IGCSE') : 'none';
                      if (!periodCounts[periodId]) {
                        periodCounts[periodId] = { name: periodName, count: 0, curriculumType: curriculumType };
                      }
                      periodCounts[periodId].count++;
                    });
                  }
                %>
                <% Object.keys(periodCounts).forEach(periodId => { %>
                <button class="period-pill" data-period="<%= periodId %>" data-curriculum="<%= periodCounts[periodId].curriculumType %>" onclick="selectExamPeriod('<%= periodId %>')">
                  <i class="fas fa-calendar"></i>
                  <span><%= periodCounts[periodId].name %></span>
                  <span class="pill-count"><%= periodCounts[periodId].count %></span>
                </button>
                <% }); %>
              </div>
            </div>

            <!-- Step 2: Teacher Selection (Shows after selecting period) -->
            <div class="filter-step" id="teacherFilterStep" style="display: none;">
              <h4 class="step-title">
                <span class="step-number">3</span>
                Select Teacher
                <button class="clear-step-btn" onclick="clearTeacherFilter()">
                  <i class="fas fa-times"></i> Clear
                </button>
              </h4>
              <div class="teacher-cards-row" id="teacherCardsRow">
                <!-- Teachers will be populated dynamically -->
              </div>
            </div>

            <!-- Active Filters Display -->
            <div class="active-filters" id="activeFilters" style="display: none;">
              <span class="active-filters-label">Active Filters:</span>
              <div class="filter-tags" id="filterTags"></div>
              <button class="clear-all-btn" onclick="clearAllFilters()">
                <i class="fas fa-times-circle"></i> Clear All
              </button>
            </div>
          </div>
        </div>

        <!-- Courses Section -->
        <div class="courses-section">
          <div class="section-header">
            <div class="section-title">
              <h3 id="coursesTitle">All Courses</h3>
              <span class="courses-count" id="coursesCount"><%= courses ? courses.length : 0 %> courses</span>
            </div>
            <div class="section-controls">
              <div class="view-toggle">
                <button class="view-btn active" data-view="grid" onclick="setView('grid')">
                  <i class="fas fa-th-large"></i>
                </button>
                <button class="view-btn" data-view="list" onclick="setView('list')">
                  <i class="fas fa-list"></i>
                </button>
              </div>
              <select class="sort-select" id="sortSelect" onchange="sortCourses()">
                <option value="newest">Newest First</option>
                <option value="oldest">Oldest First</option>
                <option value="title">Title A-Z</option>
                <option value="price-high">Price High-Low</option>
                <option value="price-low">Price Low-High</option>
              </select>
              <select class="status-filter" id="statusSelect" onchange="filterByStatus()">
                <option value="all">All Status</option>
                <option value="published">Published</option>
                <option value="draft">Draft</option>
                <option value="archived">Archived</option>
              </select>
              <select class="subject-filter" id="subjectSelect" onchange="filterBySubject()">
                <option value="all">All Subjects</option>
              </select>
              <div class="search-box">
                <i class="fas fa-search"></i>
                <input type="text" id="searchInput" placeholder="Search courses..." oninput="searchCourses()">
              </div>
            </div>
          </div>

          <!-- Bulk Actions -->
          <div class="bulk-actions" id="bulkActions" style="display: none;">
            <div class="bulk-info">
              <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
              <span id="selectedCount">0 selected</span>
            </div>
            <div class="bulk-buttons">
              <select id="bulkActionSelect">
                <option value="">Choose action...</option>
                <option value="published">Publish</option>
                <option value="draft">Set to Draft</option>
                <option value="archived">Archive</option>
              </select>
              <button class="bulk-apply" onclick="applyBulkAction()">
                <i class="fas fa-check"></i> Apply
              </button>
            </div>
          </div>

          <!-- Courses Grid -->
          <div class="courses-grid" id="coursesGrid">
            <% if (courses && courses.length > 0) { %>
              <% courses.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt)).forEach(course => { %>
              <div class="course-card" 
                   data-id="<%= course._id %>"
                   data-code="<%= course.courseCode %>"
                   data-status="<%= course.status %>"
                   data-teacher="<%= course.teacher ? course.teacher._id : '' %>"
                   data-subject="<%= course.teacher && course.teacher.subject ? course.teacher.subject.toLowerCase() : '' %>"
                   data-period="<%= course.examPeriod ? course.examPeriod._id : '' %>"
                   data-curriculum="<%= course.examPeriod && course.examPeriod.curriculumType ? course.examPeriod.curriculumType : 'IGCSE' %>"
                   data-title="<%= course.title.toLowerCase() %>"
                   data-price="<%= course.price %>"
                   data-created="<%= course.createdAt %>">
                <div class="card-checkbox">
                  <input type="checkbox" class="course-checkbox" onchange="updateBulkSelection()">
                </div>
                <div class="card-thumbnail">
                  <img src="<%= course.thumbnail || '/images/course-placeholder.jpg' %>" alt="<%= course.title %>" loading="lazy">
                  <div class="card-overlay">
                    <a href="/admin/courses/<%= course.courseCode %>/content" class="overlay-btn primary">
                      <i class="fas fa-edit"></i> Manage Content
                    </a>
                  </div>
                  <div class="card-badges">
                    <span class="status-badge <%= course.status %>">
                      <i class="fas fa-<%= course.status === 'published' ? 'check-circle' : course.status === 'draft' ? 'pencil-alt' : 'archive' %>"></i>
                      <%= course.status %>
                    </span>
                    <% if (course.discountPrice && course.discountPrice > 0) { %>
                    <span class="discount-badge">
                      <i class="fas fa-percent"></i> <%= course.discountPrice %>% OFF
                    </span>
                    <% } %>
                  </div>
                  <% if (course.enrolledStudents && course.enrolledStudents.length > 0) { %>
                  <div class="enrolled-badge">
                    <i class="fas fa-users"></i> <%= course.enrolledStudents.length %>
                  </div>
                  <% } %>
                </div>
                <div class="card-body">
                  <h4 class="card-title"><%= course.title %></h4>
                  <div class="card-info">
                    <% if (course.teacher) { %>
                    <div class="teacher-info">
                      <% if (course.teacher.profilePicture) { %>
                      <img src="<%= course.teacher.profilePicture %>" alt="<%= course.teacher.firstName %>" class="teacher-avatar-img">
                      <% } else { %>
                      <div class="teacher-avatar">
                        <%= course.teacher.firstName.charAt(0) %><%= course.teacher.lastName.charAt(0) %>
                      </div>
                      <% } %>
                      <div class="teacher-details">
                        <span class="teacher-name"><%= course.teacher.firstName %> <%= course.teacher.lastName %></span>
                        <% if (course.teacher.subject) { %>
                        <span class="teacher-subject"><i class="fas fa-book-reader"></i> <%= course.teacher.subject %></span>
                        <% } %>
                      </div>
                    </div>
                    <% } else { %>
                    <div class="no-teacher">
                      <i class="fas fa-user-slash"></i> No teacher assigned
                    </div>
                    <% } %>
                  </div>
                  <div class="card-meta">
                    <span class="meta-code"><i class="fas fa-hashtag"></i> <%= course.courseCode %></span>
                    <% if (course.examPeriod) { %>
                    <span class="meta-period"><i class="fas fa-calendar"></i> <%= course.examPeriod.displayName || course.examPeriod.name %></span>
                    <% } %>
                    <span class="meta-topics"><i class="fas fa-layer-group"></i> <%= course.topics ? course.topics.length : 0 %> Topics</span>
                  </div>
                  <div class="card-footer">
                    <div class="price-section">
                      <% if (course.discountPrice && course.discountPrice > 0) { %>
                      <span class="original-price">AED <%= course.price %></span>
                      <span class="card-price">AED <%= Math.round(course.price * (1 - course.discountPrice / 100)) %></span>
                      <% } else { %>
                      <span class="card-price">AED <%= course.price %></span>
                      <% } %>
                    </div>
                    <div class="card-actions">
                      <a href="/admin/courses/<%= course.courseCode %>/details" class="action-icon analytics" title="Analytics">
                        <i class="fas fa-chart-line"></i>
                      </a>
                      <button class="action-icon share" onclick="shareCourse('<%= course.courseCode %>', '<%= course.title.replace(/'/g, "\\'") %>', '<%= course._id %>')" title="Share">
                        <i class="fas fa-share-alt"></i>
                      </button>
                      <button class="action-icon duplicate" onclick="duplicateCourse('<%= course.courseCode %>')" title="Duplicate">
                        <i class="fas fa-copy"></i>
                      </button>
                      <button class="action-icon danger" onclick="deleteCourse('<%= course.courseCode %>', '<%= course.status %>')" title="Delete">
                        <i class="fas fa-trash"></i>
                      </button>
                    </div>
                  </div>
                </div>
              </div>
              <% }); %>
            <% } else { %>
              <div class="empty-state">
                <i class="fas fa-book-open"></i>
                <h3>No courses yet</h3>
                <p>Create your first course to get started</p>
                <button class="btn-primary" data-bs-toggle="modal" data-bs-target="#createCourseModal">
                  <i class="fas fa-plus"></i> Create Course
                </button>
              </div>
            <% } %>
          </div>
        </div>

      </div>
    </div>
  </main>
</div>

<!-- Create Course Modal (Matching Edit Course Style) -->
<div class="modal fade" id="createCourseModal" tabindex="-1" aria-labelledby="createCourseModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content admin-modal-content admin-modal-wide">
      <div class="modal-header admin-modal-header">
        <h5 class="modal-title" id="createCourseModalLabel">
          <i class="fas fa-plus-circle me-2"></i>
          Create New Course
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="createCourseForm" method="POST" action="/admin/courses/create">
        <div class="modal-body admin-modal-body">
          <div class="row">
            <!-- Basic Information -->
            <div class="col-md-8">
              <div class="admin-form-section mb-4">
                <h6 class="admin-form-section-title">
                  <i class="fas fa-info-circle me-2"></i>Basic Information
                </h6>
                
                <div class="mb-3">
                  <label for="courseTitle" class="form-label">Course Title <span class="text-danger">*</span></label>
                  <input type="text" class="form-control" id="courseTitle" name="title" required minlength="3" maxlength="100" placeholder="Enter course title">
                </div>

                <div class="mb-3">
                  <label for="courseDescription" class="form-label">Description</label>
                  <textarea class="form-control" id="courseDescription" name="description" rows="3" maxlength="500" placeholder="Course description"></textarea>
                </div>

                <div class="mb-3">
                  <label for="courseShortDescription" class="form-label">Short Description</label>
                  <input type="text" class="form-control" id="courseShortDescription" name="shortDescription" maxlength="150" placeholder="Brief summary for listings">
                </div>
              </div>
            </div>

            <!-- Thumbnail -->
            <div class="col-md-4">
              <div class="admin-form-section mb-4">
                <h6 class="admin-form-section-title">
                  <i class="fas fa-image me-2"></i>Thumbnail
                </h6>
                
                <div class="thumbnail-upload-box" id="thumbnailUploadBox" onclick="document.getElementById('courseThumbnail').click()">
                  <div class="thumbnail-placeholder" id="thumbnailPlaceholder">
                    <i class="fas fa-cloud-upload-alt"></i>
                    <span>Click to upload</span>
                    <small>800Ã—450px recommended</small>
                  </div>
                  <img id="thumbnailPreviewImg" src="" alt="Preview" style="display: none;">
                </div>
                <input type="file" id="courseThumbnail" accept="image/*" style="display: none;">
                <input type="hidden" name="thumbnail" id="thumbnailUrl">
              </div>
            </div>

            <!-- Teacher and Exam Period -->
            <div class="col-md-6">
              <div class="admin-form-section mb-4">
                <h6 class="admin-form-section-title">
                  <i class="fas fa-user-tie me-2"></i>Teacher
                </h6>
                <select class="form-select" id="courseTeacher" name="teacher">
                  <option value="">No Teacher</option>
                </select>
              </div>
            </div>

            <div class="col-md-6">
              <div class="admin-form-section mb-4">
                <h6 class="admin-form-section-title">
                  <i class="fas fa-calendar me-2"></i>Exam Period
                </h6>
                <select class="form-select" id="courseExamPeriod" name="examPeriod">
                  <option value="">No Period</option>
                </select>
              </div>
            </div>

            <!-- Pricing -->
            <div class="col-md-6">
              <div class="admin-form-section mb-4">
                <h6 class="admin-form-section-title">
                  <i class="fas fa-dollar-sign me-2"></i>Pricing
                </h6>
                
                <div class="row g-3">
                  <div class="col-6">
                    <label for="coursePrice" class="form-label">Price (AED) <span class="text-danger">*</span></label>
                    <input type="number" class="form-control" id="coursePrice" name="price" min="0" step="0.01" required placeholder="0.00">
                  </div>
                  <div class="col-6">
                    <label for="courseDiscount" class="form-label">Discount %</label>
                    <input type="number" class="form-control" id="courseDiscount" name="discountPrice" min="0" max="100" value="0">
                  </div>
                </div>
              </div>
            </div>

            <!-- Status -->
            <div class="col-md-6">
              <div class="admin-form-section mb-4">
                <h6 class="admin-form-section-title">
                  <i class="fas fa-cog me-2"></i>Status
                </h6>
                <select class="form-select" id="courseStatus" name="status">
                  <option value="draft">Draft</option>
                  <option value="published">Published</option>
                </select>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer admin-modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
            <i class="fas fa-times me-1"></i>Cancel
          </button>
          <button type="submit" class="btn btn-primary">
            <i class="fas fa-plus me-1"></i>Create Course
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Exam Period Modal -->
<div class="modal fade" id="examPeriodModal" tabindex="-1" aria-labelledby="examPeriodModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content admin-modal-content">
      <div class="modal-header admin-modal-header" style="background: linear-gradient(135deg, #3a92bd 0%, #0c5374 100%);">
        <h5 class="modal-title" id="examPeriodModalLabel">
          <i class="fas fa-calendar-alt me-2"></i>
          Manage Exam Periods
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body admin-modal-body">
        <!-- Add Period Form -->
        <div class="admin-form-section mb-4">
          <h6 class="admin-form-section-title">
            <i class="fas fa-plus-circle me-2"></i>Add New Period
          </h6>
          <form id="addPeriodForm">
            <div class="row g-3">
              <div class="col-md-3">
                <label class="form-label">Curriculum Type</label>
                <select id="periodCurriculumType" class="form-select" required>
                  <option value="IGCSE">IGCSE</option>
                  <option value="American">American</option>
                </select>
              </div>
              <div class="col-md-3">
                <label class="form-label">Period Name</label>
                <input type="text" id="periodName" class="form-control" placeholder="e.g., January 2026" required>
              </div>
              <div class="col-md-2">
                <label class="form-label">Display</label>
                <input type="text" id="periodDisplayName" class="form-control" placeholder="Jan '26" required>
              </div>
              <div class="col-md-1">
                <label class="form-label">Year</label>
                <input type="number" id="periodYear" class="form-control" value="2026" required>
              </div>
              <div class="col-md-1">
                <label class="form-label">Start</label>
                <input type="date" id="periodStartDate" class="form-control" required>
              </div>
              <div class="col-md-2">
                <label class="form-label">End</label>
                <input type="date" id="periodEndDate" class="form-control" required>
              </div>
            </div>
            <button type="submit" class="btn btn-primary mt-3">
              <i class="fas fa-plus me-1"></i>Add Period
            </button>
          </form>
        </div>

        <!-- Existing Periods -->
        <div class="admin-form-section">
          <h6 class="admin-form-section-title">
            <i class="fas fa-list me-2"></i>Existing Periods
          </h6>
          <div id="periodsList" class="periods-list">
            <div class="text-center text-muted py-4">
              <i class="fas fa-spinner fa-spin me-2"></i>Loading...
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer admin-modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<%- include('./partials/admin-footer') %>

<style>
/* ============================================ */
/* Courses Page - Clean Professional Design    */
/* ============================================ */

:root {
  --primary: #3a92bd;
  --primary-dark: #0c5374;
  --primary-light: #5ba9d1;
  --success: #22c55e;
  --warning: #f59e0b;
  --danger: #ef4444;
  --bg-page: #f1f5f9;
  --bg-card: #ffffff;
  --text-primary: #1e293b;
  --text-secondary: #64748b;
  --text-muted: #94a3b8;
  --border: #e2e8f0;
  --shadow-sm: 0 1px 3px rgba(0,0,0,0.08);
  --shadow-md: 0 4px 12px rgba(0,0,0,0.1);
  --shadow-lg: 0 8px 25px rgba(0,0,0,0.12);
  --radius: 12px;
  --radius-sm: 8px;
}

.dark-theme {
  --bg-page: #0f172a;
  --bg-card: #1e293b;
  --text-primary: #f1f5f9;
  --text-secondary: #94a3b8;
  --text-muted: #64748b;
  --border: #334155;
}

.courses-container {
  padding: 0;
}

/* Page Header */
.page-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 24px;
  flex-wrap: wrap;
  gap: 16px;
}

.page-title {
  font-size: 1.75rem;
  font-weight: 700;
  color: var(--text-primary);
  display: flex;
  align-items: center;
  gap: 12px;
  margin: 0;
}

.page-title i {
  color: var(--primary);
}

.page-subtitle {
  color: var(--text-secondary);
  margin: 4px 0 0;
  font-size: 0.9rem;
}

.header-actions {
  display: flex;
  gap: 10px;
}

.btn-primary, .btn-secondary {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  padding: 10px 20px;
  border-radius: var(--radius-sm);
  font-weight: 600;
  font-size: 14px;
  cursor: pointer;
  transition: all 0.2s;
  border: none;
}

.btn-primary {
  background: linear-gradient(135deg, var(--primary), var(--primary-dark));
  color: white;
}

.btn-primary:hover {
  box-shadow: 0 4px 15px rgba(58, 146, 189, 0.4);
  transform: translateY(-1px);
}

.btn-secondary {
  background: var(--bg-card);
  color: var(--primary);
  border: 2px solid var(--primary);
}

.btn-secondary:hover {
  background: var(--primary);
  color: white;
}

/* Stats Grid */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
  gap: 16px;
  margin-bottom: 24px;
}

.stat-card {
  background: var(--bg-card);
  border-radius: var(--radius);
  padding: 16px 20px;
  display: flex;
  align-items: center;
  gap: 14px;
  box-shadow: var(--shadow-sm);
  border: 1px solid var(--border);
  transition: all 0.2s;
}

.stat-card:hover {
  box-shadow: var(--shadow-md);
  transform: translateY(-2px);
}

.stat-icon {
  width: 48px;
  height: 48px;
  border-radius: var(--radius-sm);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 20px;
}

.stat-icon.blue { background: rgba(58, 146, 189, 0.15); color: var(--primary); }
.stat-icon.green { background: rgba(34, 197, 94, 0.15); color: var(--success); }
.stat-icon.orange { background: rgba(245, 158, 11, 0.15); color: var(--warning); }
.stat-icon.purple { background: rgba(99, 102, 241, 0.15); color: #6366f1; }

.stat-value {
  font-size: 1.5rem;
  font-weight: 700;
  color: var(--text-primary);
  line-height: 1;
}

.stat-label {
  font-size: 0.8rem;
  color: var(--text-secondary);
  margin-top: 2px;
}

/* Filter Section */
.filter-section {
  background: var(--bg-card);
  border-radius: var(--radius);
  margin-bottom: 24px;
  box-shadow: var(--shadow-sm);
  border: 1px solid var(--border);
  overflow: hidden;
}

.filter-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 16px 20px;
  cursor: pointer;
  transition: background 0.2s;
}

.filter-header:hover {
  background: rgba(58, 146, 189, 0.05);
}

.filter-title {
  display: flex;
  align-items: center;
  gap: 10px;
  font-weight: 600;
  color: var(--text-primary);
}

.filter-title i {
  color: var(--primary);
}

.filter-badge {
  background: var(--primary);
  color: white;
  font-size: 11px;
  padding: 2px 8px;
  border-radius: 10px;
}

.filter-toggle {
  display: flex;
  align-items: center;
  gap: 10px;
  color: var(--text-secondary);
  font-size: 13px;
}

.filter-toggle i {
  transition: transform 0.3s;
}

.filter-toggle i.rotated {
  transform: rotate(180deg);
}

.filter-content {
  padding: 0 20px 20px;
  border-top: 1px solid var(--border);
}

.filter-step {
  padding: 20px 0;
  border-bottom: 1px solid var(--border);
}

.filter-step:last-of-type {
  border-bottom: none;
}

.step-title {
  display: flex;
  align-items: center;
  gap: 10px;
  font-size: 14px;
  font-weight: 600;
  color: var(--text-primary);
  margin-bottom: 14px;
}

.step-number {
  width: 24px;
  height: 24px;
  background: var(--primary);
  color: white;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 12px;
  font-weight: 700;
}

.clear-step-btn {
  margin-left: auto;
  background: none;
  border: none;
  color: var(--text-secondary);
  font-size: 12px;
  cursor: pointer;
  padding: 4px 10px;
  border-radius: 4px;
}

.clear-step-btn:hover {
  background: rgba(239, 68, 68, 0.1);
  color: var(--danger);
}

/* Exam Period Pills */
.exam-period-pills {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
}

/* Curriculum Type Pills */
.curriculum-type-pills {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  margin-bottom: 10px;
}

.curriculum-pill {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 12px 20px;
  background: var(--bg-page);
  border: 2px solid transparent;
  border-radius: var(--radius-sm);
  cursor: pointer;
  transition: all 0.2s;
  font-size: 14px;
  font-weight: 600;
  color: var(--text-primary);
}

.curriculum-pill:hover {
  border-color: var(--primary);
  background: rgba(58, 146, 189, 0.05);
}

.curriculum-pill.active {
  background: linear-gradient(135deg, var(--primary), var(--primary-dark));
  color: white;
  border-color: var(--primary);
  box-shadow: 0 4px 12px rgba(58, 146, 189, 0.3);
}

.curriculum-pill i {
  font-size: 16px;
}

.curriculum-pill.active i {
  color: white;
}

.period-pill {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 10px 16px;
  background: var(--bg-page);
  border: 2px solid transparent;
  border-radius: var(--radius-sm);
  cursor: pointer;
  transition: all 0.2s;
  font-size: 13px;
  color: var(--text-primary);
}

.period-pill:hover {
  border-color: var(--primary);
  background: rgba(58, 146, 189, 0.05);
}

.period-pill.active {
  background: var(--primary);
  color: white;
  border-color: var(--primary);
}

.period-pill i {
  font-size: 14px;
}

.pill-count {
  background: rgba(0,0,0,0.1);
  padding: 2px 8px;
  border-radius: 10px;
  font-size: 11px;
  font-weight: 600;
}

.period-pill.active .pill-count {
  background: rgba(255,255,255,0.2);
}

/* Teacher Cards Row */
.teacher-cards-row {
  display: flex;
  flex-wrap: wrap;
  gap: 12px;
}

.teacher-card-mini {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 10px 16px;
  background: var(--bg-page);
  border: 2px solid transparent;
  border-radius: var(--radius-sm);
  cursor: pointer;
  transition: all 0.2s;
}

.teacher-card-mini:hover {
  border-color: var(--primary);
  background: rgba(58, 146, 189, 0.05);
}

.teacher-card-mini.active {
  background: var(--primary);
  color: white;
  border-color: var(--primary);
}

.teacher-avatar-mini {
  width: 36px;
  height: 36px;
  background: linear-gradient(135deg, var(--primary), var(--primary-dark));
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-weight: 700;
  font-size: 14px;
}

.teacher-card-mini.active .teacher-avatar-mini {
  background: rgba(255,255,255,0.2);
}

.teacher-name-mini {
  font-weight: 600;
  font-size: 13px;
}

.teacher-count-mini {
  font-size: 11px;
  opacity: 0.7;
}

/* Active Filters */
.active-filters {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 14px 0;
  flex-wrap: wrap;
}

.active-filters-label {
  font-size: 13px;
  color: var(--text-secondary);
  font-weight: 500;
}

.filter-tags {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
}

.filter-tag {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 5px 12px;
  background: rgba(58, 146, 189, 0.15);
  color: var(--primary-dark);
  border-radius: 20px;
  font-size: 12px;
  font-weight: 500;
}

.filter-tag i {
  cursor: pointer;
  opacity: 0.7;
}

.filter-tag i:hover {
  opacity: 1;
}

.clear-all-btn {
  background: none;
  border: none;
  color: var(--danger);
  font-size: 12px;
  cursor: pointer;
  padding: 5px 10px;
}

.clear-all-btn:hover {
  text-decoration: underline;
}

/* Courses Section */
.courses-section {
  background: var(--bg-card);
  border-radius: var(--radius);
  padding: 20px;
  box-shadow: var(--shadow-sm);
  border: 1px solid var(--border);
}

.section-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
  flex-wrap: wrap;
  gap: 16px;
}

.section-title {
  display: flex;
  align-items: center;
  gap: 12px;
}

.section-title h3 {
  font-size: 1.1rem;
  font-weight: 700;
  color: var(--text-primary);
  margin: 0;
}

.courses-count {
  background: var(--bg-page);
  padding: 4px 12px;
  border-radius: 15px;
  font-size: 12px;
  color: var(--text-secondary);
}

.section-controls {
  display: flex;
  align-items: center;
  gap: 10px;
  flex-wrap: wrap;
}

.view-toggle {
  display: flex;
  background: var(--bg-page);
  border-radius: var(--radius-sm);
  padding: 3px;
}

.view-btn {
  padding: 6px 12px;
  border: none;
  background: transparent;
  color: var(--text-secondary);
  cursor: pointer;
  border-radius: 6px;
  transition: all 0.2s;
}

.view-btn.active {
  background: var(--primary);
  color: white;
}

.sort-select, .status-filter, .subject-filter {
  padding: 8px 12px;
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  background: var(--bg-card);
  color: var(--text-primary);
  font-size: 13px;
  cursor: pointer;
}

.subject-filter {
  min-width: 140px;
}

.search-box {
  position: relative;
}

.search-box i {
  position: absolute;
  left: 12px;
  top: 50%;
  transform: translateY(-50%);
  color: var(--text-muted);
  font-size: 14px;
}

.search-box input {
  padding: 8px 12px 8px 36px;
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  background: var(--bg-card);
  color: var(--text-primary);
  font-size: 13px;
  width: 200px;
}

.search-box input:focus {
  outline: none;
  border-color: var(--primary);
}

/* Bulk Actions */
.bulk-actions {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px 16px;
  background: rgba(58, 146, 189, 0.1);
  border: 2px solid var(--primary);
  border-radius: var(--radius-sm);
  margin-bottom: 16px;
}

.bulk-info {
  display: flex;
  align-items: center;
  gap: 12px;
  font-weight: 600;
  color: var(--primary-dark);
}

.bulk-buttons {
  display: flex;
  gap: 10px;
}

.bulk-apply {
  padding: 6px 16px;
  background: var(--primary);
  color: white;
  border: none;
  border-radius: var(--radius-sm);
  font-weight: 600;
  font-size: 13px;
  cursor: pointer;
}

/* Courses Grid */
.courses-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
  gap: 20px;
}

.courses-grid.list-view {
  grid-template-columns: 1fr;
}

.courses-grid.list-view .course-card {
  display: flex;
  flex-direction: row;
}

.courses-grid.list-view .card-thumbnail {
  width: 200px;
  height: auto;
  flex-shrink: 0;
}

.courses-grid.list-view .card-body {
  flex: 1;
  display: flex;
  flex-direction: column;
  justify-content: space-between;
}

.course-card {
  background: var(--bg-card);
  border-radius: var(--radius);
  overflow: hidden;
  transition: all 0.3s ease;
  position: relative;
  border: 1px solid var(--border);
  box-shadow: var(--shadow-sm);
}

.course-card:hover {
  box-shadow: var(--shadow-lg);
  transform: translateY(-5px);
  border-color: var(--primary);
}

.card-checkbox {
  position: absolute;
  top: 12px;
  left: 12px;
  z-index: 10;
}

.course-checkbox {
  width: 20px;
  height: 20px;
  cursor: pointer;
  accent-color: var(--primary);
  background: white;
  border-radius: 4px;
}

.card-thumbnail {
  position: relative;
  height: 180px;
  overflow: hidden;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

.card-thumbnail img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  transition: transform 0.4s ease;
}

.course-card:hover .card-thumbnail img {
  transform: scale(1.08);
}

.card-overlay {
  position: absolute;
  inset: 0;
  background: linear-gradient(135deg, rgba(58, 146, 189, 0.9), rgba(12, 83, 116, 0.9));
  display: flex;
  align-items: center;
  justify-content: center;
  opacity: 0;
  transition: opacity 0.3s ease;
}

.course-card:hover .card-overlay {
  opacity: 1;
}

.overlay-btn {
  padding: 12px 24px;
  background: white;
  color: var(--primary);
  border-radius: var(--radius-sm);
  font-weight: 700;
  font-size: 14px;
  text-decoration: none;
  display: flex;
  align-items: center;
  gap: 8px;
  transition: all 0.2s;
  box-shadow: 0 4px 15px rgba(0,0,0,0.2);
}

.overlay-btn:hover {
  transform: scale(1.05);
  color: var(--primary-dark);
}

/* Card Badges Container */
.card-badges {
  position: absolute;
  top: 10px;
  right: 10px;
  display: flex;
  flex-direction: column;
  gap: 6px;
  align-items: flex-end;
}

.status-badge {
  padding: 5px 12px;
  border-radius: 20px;
  font-size: 11px;
  font-weight: 700;
  text-transform: uppercase;
  color: white;
  display: flex;
  align-items: center;
  gap: 5px;
  backdrop-filter: blur(10px);
  box-shadow: 0 2px 8px rgba(0,0,0,0.2);
}

.status-badge i {
  font-size: 10px;
}

.status-badge.published { 
  background: linear-gradient(135deg, #22c55e, #16a34a); 
}
.status-badge.draft { 
  background: linear-gradient(135deg, #f59e0b, #d97706); 
}
.status-badge.archived { 
  background: linear-gradient(135deg, #94a3b8, #64748b); 
}

.discount-badge {
  padding: 4px 10px;
  border-radius: 20px;
  font-size: 10px;
  font-weight: 700;
  background: linear-gradient(135deg, #ef4444, #dc2626);
  color: white;
  display: flex;
  align-items: center;
  gap: 4px;
}

.enrolled-badge {
  position: absolute;
  bottom: 10px;
  left: 10px;
  padding: 5px 12px;
  border-radius: 20px;
  font-size: 12px;
  font-weight: 600;
  background: rgba(0,0,0,0.7);
  color: white;
  display: flex;
  align-items: center;
  gap: 6px;
  backdrop-filter: blur(10px);
}

.card-body {
  padding: 18px;
}

.card-title {
  font-size: 1rem;
  font-weight: 700;
  color: var(--text-primary);
  margin-bottom: 12px;
  line-height: 1.4;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
  min-height: 2.8em;
}

/* Teacher Info Section */
.card-info {
  margin-bottom: 12px;
}

.teacher-info {
  display: flex;
  align-items: center;
  gap: 10px;
}

.teacher-avatar {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background: linear-gradient(135deg, var(--primary), var(--primary-dark));
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 12px;
  font-weight: 700;
  flex-shrink: 0;
  border: 2px solid var(--border);
}

.teacher-avatar-img {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  object-fit: cover;
  flex-shrink: 0;
  border: 2px solid var(--primary);
  box-shadow: 0 2px 8px rgba(58, 146, 189, 0.3);
}

.teacher-details {
  display: flex;
  flex-direction: column;
  gap: 2px;
  min-width: 0;
}

.teacher-name {
  font-size: 13px;
  font-weight: 600;
  color: var(--text-primary);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.teacher-subject {
  font-size: 11px;
  color: var(--primary);
  display: flex;
  align-items: center;
  gap: 4px;
}

.no-teacher {
  font-size: 12px;
  color: var(--text-muted);
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 8px 0;
}

.card-meta {
  display: flex;
  flex-wrap: wrap;
  gap: 12px;
  margin-bottom: 14px;
  font-size: 11px;
  color: var(--text-secondary);
}

.card-meta span {
  display: flex;
  align-items: center;
  gap: 5px;
  background: var(--bg-page);
  padding: 4px 10px;
  border-radius: 20px;
}

.card-meta span i {
  color: var(--primary);
  font-size: 10px;
}

.card-footer {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding-top: 14px;
  border-top: 1px solid var(--border);
}

.price-section {
  display: flex;
  align-items: center;
  gap: 8px;
}

.original-price {
  font-size: 12px;
  color: var(--text-muted);
  text-decoration: line-through;
}

.card-price {
  font-weight: 800;
  color: var(--primary);
  font-size: 1.1rem;
}

.card-actions {
  display: flex;
  gap: 6px;
}

.action-icon {
  width: 34px;
  height: 34px;
  display: flex;
  align-items: center;
  justify-content: center;
  border: none;
  background: var(--bg-page);
  color: var(--text-secondary);
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.2s ease;
  text-decoration: none;
  font-size: 13px;
}

.action-icon:hover {
  transform: translateY(-2px);
}

.action-icon.analytics:hover {
  background: rgba(99, 102, 241, 0.15);
  color: #6366f1;
}

.action-icon.share:hover {
  background: rgba(34, 197, 94, 0.15);
  color: #22c55e;
}

.action-icon.duplicate:hover {
  background: rgba(58, 146, 189, 0.15);
  color: var(--primary);
}

.action-icon.danger:hover {
  background: rgba(239, 68, 68, 0.15);
  color: var(--danger);
}

/* Empty State */
.empty-state {
  grid-column: 1 / -1;
  text-align: center;
  padding: 60px 20px;
  color: var(--text-secondary);
}

.empty-state i {
  font-size: 48px;
  color: var(--text-muted);
  margin-bottom: 16px;
}

.empty-state h3 {
  color: var(--text-primary);
  margin-bottom: 8px;
}

.empty-state p {
  margin-bottom: 20px;
}

/* Periods List */
.periods-list {
  max-height: 300px;
  overflow-y: auto;
}

.period-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px 16px;
  background: var(--bg-page);
  border-radius: var(--radius-sm);
  margin-bottom: 10px;
}

.period-item h6 {
  font-size: 14px;
  margin: 0 0 4px;
  color: var(--text-primary);
}

.period-item small {
  font-size: 12px;
  color: var(--text-secondary);
}

.period-actions {
  display: flex;
  gap: 6px;
}

.period-actions button {
  width: 30px;
  height: 30px;
  border: none;
  background: var(--bg-card);
  color: var(--text-secondary);
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.2s;
}

.period-actions button:hover {
  background: var(--primary);
  color: white;
}

.period-actions button.danger:hover {
  background: var(--danger);
}

/* Thumbnail Upload */
.thumbnail-upload {
  position: relative;
}

.upload-area {
  padding: 40px;
  border: 2px dashed var(--border);
  border-radius: var(--radius-sm);
  text-align: center;
  cursor: pointer;
  transition: all 0.2s;
}

.upload-area:hover {
  border-color: var(--primary);
  background: rgba(58, 146, 189, 0.05);
}

.upload-area i {
  font-size: 32px;
  color: var(--primary);
  display: block;
  margin-bottom: 10px;
}

.upload-area span {
  color: var(--text-secondary);
  font-size: 13px;
}

.thumbnail-preview {
  margin-top: 12px;
}

.thumbnail-preview img {
  max-width: 150px;
  border-radius: var(--radius-sm);
}

/* Add Period Form */
.add-period-form {
  padding: 16px;
  background: var(--bg-page);
  border-radius: var(--radius-sm);
}

/* Responsive */
@media (max-width: 768px) {
  .page-header {
    flex-direction: column;
    align-items: stretch;
  }

  .header-actions {
    justify-content: stretch;
  }

  .header-actions button {
    flex: 1;
    justify-content: center;
  }

  .section-controls {
    width: 100%;
    justify-content: space-between;
  }

  .search-box input {
    width: 100%;
  }

  .courses-grid.list-view .course-card {
    flex-direction: column;
  }

  .courses-grid.list-view .card-thumbnail {
    width: 100%;
    height: 160px;
  }
}

/* ============================================ */
/* Admin Form Section Styles                   */
/* ============================================ */

.admin-form-section {
  background: var(--bg-page);
  padding: 20px;
  border-radius: 12px;
  border: 1px solid var(--border);
}

.admin-form-section-title {
  font-size: 14px;
  font-weight: 700;
  color: var(--primary);
  margin-bottom: 16px;
  display: flex;
  align-items: center;
  padding-bottom: 10px;
  border-bottom: 1px solid var(--border);
}

.admin-form-section-title i {
  color: var(--primary);
}

/* Thumbnail Upload Box */
.thumbnail-upload-box {
  width: 100%;
  height: 180px;
  border: 2px dashed var(--border);
  border-radius: 12px;
  cursor: pointer;
  transition: all 0.3s ease;
  overflow: hidden;
  position: relative;
  display: flex;
  align-items: center;
  justify-content: center;
  background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
}

.thumbnail-upload-box:hover {
  border-color: var(--primary);
  background: rgba(58, 146, 189, 0.05);
}

.thumbnail-placeholder {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 8px;
  color: var(--text-muted);
}

.thumbnail-placeholder i {
  font-size: 40px;
  color: var(--primary);
  opacity: 0.6;
}

.thumbnail-placeholder span {
  font-weight: 600;
  font-size: 14px;
}

.thumbnail-placeholder small {
  font-size: 11px;
  opacity: 0.7;
}

.thumbnail-upload-box img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.dark-theme .thumbnail-upload-box {
  background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
}

/* Periods List Styles */
.periods-list {
  max-height: 250px;
  overflow-y: auto;
}

.period-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 14px 16px;
  background: var(--bg-page);
  border-radius: 10px;
  margin-bottom: 10px;
  border: 1px solid var(--border);
  transition: all 0.2s;
}

.period-item:hover {
  border-color: var(--primary);
  box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}

.period-item h6 {
  font-size: 14px;
  font-weight: 600;
  margin: 0 0 4px;
  color: var(--text-primary);
}

.period-item small {
  font-size: 12px;
  color: var(--text-secondary);
}

.period-actions {
  display: flex;
  gap: 8px;
  align-items: center;
}

/* Enhanced Period Item Styles */
.period-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 16px;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 10px;
  margin-bottom: 12px;
  transition: all 0.2s;
}

.period-item:hover {
  box-shadow: var(--shadow-md);
  transform: translateY(-1px);
}

.period-item.inactive {
  opacity: 0.7;
  background: #f8f9fa;
}

.dark-theme .period-item.inactive {
  background: rgba(0,0,0,0.2);
}

.period-info {
  flex: 1;
}

.period-name {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 6px;
  flex-wrap: wrap;
}

.period-name strong {
  font-size: 1rem;
  color: var(--text-primary);
}

.period-status-badge {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  font-size: 11px;
  font-weight: 600;
  padding: 3px 10px;
  border-radius: 20px;
  text-transform: uppercase;
}

.period-status-badge.active {
  background: rgba(34, 197, 94, 0.15);
  color: #22c55e;
}

.period-status-badge.inactive {
  background: rgba(245, 158, 11, 0.15);
  color: #f59e0b;
}

.period-curriculum-badge {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  font-size: 11px;
  font-weight: 600;
  padding: 3px 10px;
  border-radius: 20px;
  text-transform: uppercase;
  margin-right: 6px;
}

.period-curriculum-badge.igcse {
  background: rgba(58, 146, 189, 0.15);
  color: #3a92bd;
}

.period-curriculum-badge.american {
  background: rgba(99, 102, 241, 0.15);
  color: #6366f1;
}

.period-dates {
  font-size: 13px;
  color: var(--text-secondary);
  display: flex;
  align-items: center;
  flex-wrap: wrap;
  gap: 4px;
}

.period-year {
  color: var(--primary);
  font-weight: 500;
}

.period-action-btn {
  width: 36px;
  height: 36px;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 14px;
}

.period-action-btn.toggle {
  background: rgba(34, 197, 94, 0.1);
  color: #22c55e;
}

.period-action-btn.toggle.inactive {
  background: rgba(245, 158, 11, 0.1);
  color: #f59e0b;
}

.period-action-btn.toggle:hover {
  background: #22c55e;
  color: white;
}

.period-action-btn.toggle.inactive:hover {
  background: #f59e0b;
  color: white;
}

.period-action-btn.edit {
  background: rgba(58, 146, 189, 0.1);
  color: var(--primary);
}

.period-action-btn.edit:hover {
  background: var(--primary);
  color: white;
}

.period-action-btn.delete {
  background: rgba(239, 68, 68, 0.1);
  color: #ef4444;
}

.period-action-btn.delete:hover {
  background: #ef4444;
  color: white;
}
</style>

<script>
// Store all courses data
const allCourses = <%- JSON.stringify(courses || []) %>;
let selectedCurriculumType = null;
let selectedPeriod = null;
let selectedTeacher = null;
let currentView = 'grid';

// Initialize
document.addEventListener('DOMContentLoaded', function() {
  loadTeachersSelect();
  loadExamPeriodsSelect();
  loadExamPeriodsList();
  loadSubjectsSelect();
  setupPeriodForm();
  setupThumbnailUpload();
});

// Toggle Filter Section
function toggleFilterSection() {
  const content = document.getElementById('filterContent');
  const icon = document.getElementById('filterIcon');
  const status = document.getElementById('filterStatus');
  
  if (content.style.display === 'none') {
    content.style.display = 'block';
    icon.classList.add('rotated');
    status.textContent = 'Collapse filter options';
  } else {
    content.style.display = 'none';
    icon.classList.remove('rotated');
    status.textContent = 'Click to filter by Curriculum & Teacher';
  }
}

// Select Curriculum Type
function selectCurriculumType(curriculumType) {
  selectedCurriculumType = curriculumType === 'all' ? null : curriculumType;
  
  // Update curriculum pills
  document.querySelectorAll('.curriculum-pill').forEach(pill => {
    pill.classList.toggle('active', pill.dataset.curriculum === curriculumType);
  });
  
  // Filter exam period pills based on selected curriculum
  document.querySelectorAll('.period-pill').forEach(pill => {
    const pillCurriculum = pill.dataset.curriculum;
    if (curriculumType === 'all' || !pillCurriculum || pillCurriculum === curriculumType) {
      pill.style.display = '';
    } else {
      pill.style.display = 'none';
      pill.classList.remove('active');
    }
  });
  
  // Make sure "All Periods" is always visible and active when curriculum changes
  const allPeriodsPill = document.querySelector('.period-pill[data-period="all"]');
  if (allPeriodsPill) {
    allPeriodsPill.style.display = '';
    allPeriodsPill.classList.add('active');
  }
  
  // Reset period and teacher selection
  selectedPeriod = null;
  selectedTeacher = null;
  
  // Hide teacher step
  document.getElementById('teacherFilterStep').style.display = 'none';
  
  applyFilters();
  updateActiveFiltersDisplay();
}

// Select Exam Period
function selectExamPeriod(periodId) {
  selectedPeriod = periodId === 'all' ? null : periodId;
  
  // Update pills
  document.querySelectorAll('.period-pill').forEach(pill => {
    pill.classList.toggle('active', pill.dataset.period === periodId);
  });
  
  // Get teachers for this period
  const teacherStep = document.getElementById('teacherFilterStep');
  const teacherRow = document.getElementById('teacherCardsRow');
  
  // Filter courses by period
  let filteredCourses = selectedPeriod 
    ? allCourses.filter(c => (c.examPeriod?._id || '') === selectedPeriod)
    : allCourses;
  
  // Get unique teachers
  const teachers = {};
  filteredCourses.forEach(course => {
    if (course.teacher && course.teacher._id) {
      const tid = course.teacher._id;
      if (!teachers[tid]) {
        teachers[tid] = {
          id: tid,
          name: `${course.teacher.firstName} ${course.teacher.lastName}`,
          firstName: course.teacher.firstName,
          count: 0
        };
      }
      teachers[tid].count++;
    }
  });
  
  if (Object.keys(teachers).length > 0) {
    teacherStep.style.display = 'block';
    
    let html = `
      <div class="teacher-card-mini active" data-teacher="all" onclick="selectTeacher('all')">
        <div class="teacher-avatar-mini"><i class="fas fa-users"></i></div>
        <div>
          <div class="teacher-name-mini">All Teachers</div>
          <div class="teacher-count-mini">${filteredCourses.length} courses</div>
        </div>
      </div>
    `;
    
    Object.values(teachers).forEach(t => {
      html += `
        <div class="teacher-card-mini" data-teacher="${t.id}" onclick="selectTeacher('${t.id}')">
          <div class="teacher-avatar-mini">${t.firstName.charAt(0)}</div>
          <div>
            <div class="teacher-name-mini">${t.name}</div>
            <div class="teacher-count-mini">${t.count} courses</div>
          </div>
        </div>
      `;
    });
    
    teacherRow.innerHTML = html;
  } else {
    teacherStep.style.display = 'none';
  }
  
  selectedTeacher = null;
  applyFilters();
  updateActiveFiltersDisplay();
}

// Select Teacher
function selectTeacher(teacherId) {
  selectedTeacher = teacherId === 'all' ? null : teacherId;
  
  document.querySelectorAll('.teacher-card-mini').forEach(card => {
    card.classList.toggle('active', card.dataset.teacher === teacherId);
  });
  
  applyFilters();
  updateActiveFiltersDisplay();
}

// Clear Teacher Filter
function clearTeacherFilter() {
  selectedTeacher = null;
  document.querySelectorAll('.teacher-card-mini').forEach(card => {
    card.classList.toggle('active', card.dataset.teacher === 'all');
  });
  applyFilters();
  updateActiveFiltersDisplay();
}

// Clear All Filters
function clearAllFilters() {
  selectedCurriculumType = null;
  selectedPeriod = null;
  selectedTeacher = null;
  
  // Reset curriculum pills
  document.querySelectorAll('.curriculum-pill').forEach(pill => {
    pill.classList.toggle('active', pill.dataset.curriculum === 'all');
  });
  
  // Reset and show all period pills
  document.querySelectorAll('.period-pill').forEach(pill => {
    pill.style.display = '';
    pill.classList.toggle('active', pill.dataset.period === 'all');
  });
  
  document.getElementById('teacherFilterStep').style.display = 'none';
  document.getElementById('statusSelect').value = 'all';
  document.getElementById('subjectSelect').value = 'all';
  document.getElementById('searchInput').value = '';
  
  applyFilters();
  updateActiveFiltersDisplay();
}

// Apply All Filters
function applyFilters() {
  const statusFilter = document.getElementById('statusSelect').value;
  const subjectFilter = document.getElementById('subjectSelect').value.toLowerCase();
  const searchQuery = document.getElementById('searchInput').value.toLowerCase();
  
  let visibleCount = 0;
  
  document.querySelectorAll('.course-card').forEach(card => {
    let show = true;
    
    // Curriculum type filter
    if (selectedCurriculumType) {
      const cardCurriculum = card.dataset.curriculum || 'IGCSE';
      if (cardCurriculum !== selectedCurriculumType) {
        show = false;
      }
    }
    
    // Period filter
    if (selectedPeriod && card.dataset.period !== selectedPeriod) {
      show = false;
    }
    
    // Teacher filter
    if (selectedTeacher && card.dataset.teacher !== selectedTeacher) {
      show = false;
    }
    
    // Subject filter
    if (subjectFilter !== 'all' && card.dataset.subject !== subjectFilter) {
      show = false;
    }
    
    // Status filter
    if (statusFilter !== 'all' && card.dataset.status !== statusFilter) {
      show = false;
    }
    
    // Search filter
    if (searchQuery && !card.dataset.title.includes(searchQuery)) {
      show = false;
    }
    
    card.style.display = show ? '' : 'none';
    if (show) visibleCount++;
  });
  
  // Update courses count
  document.getElementById('coursesCount').textContent = `${visibleCount} courses`;
  
  // Update title
  let title = 'All Courses';
  if (selectedCurriculumType || selectedPeriod || selectedTeacher) {
    const curriculumName = selectedCurriculumType || '';
    const periodName = selectedPeriod 
      ? document.querySelector(`[data-period="${selectedPeriod}"] span:first-of-type`)?.textContent || 'Selected Period'
      : '';
    const teacherName = selectedTeacher
      ? document.querySelector(`[data-teacher="${selectedTeacher}"] .teacher-name-mini`)?.textContent || ''
      : '';
    
    let parts = [];
    if (curriculumName) parts.push(curriculumName);
    if (periodName) parts.push(periodName);
    if (teacherName) parts.push(teacherName);
    
    title = parts.join(' - ') || 'All Courses';
  }
  document.getElementById('coursesTitle').textContent = title;
}

// Update Active Filters Display
function updateActiveFiltersDisplay() {
  const container = document.getElementById('activeFilters');
  const tags = document.getElementById('filterTags');
  const badge = document.getElementById('activeFiltersCount');
  
  let activeCount = 0;
  let tagsHtml = '';
  
  if (selectedCurriculumType) {
    tagsHtml += `<span class="filter-tag"><i class="fas fa-graduation-cap"></i> ${selectedCurriculumType} <i class="fas fa-times" onclick="clearCurriculumFilter()"></i></span>`;
    activeCount++;
  }
  
  if (selectedPeriod) {
    const periodName = document.querySelector(`[data-period="${selectedPeriod}"] span:first-of-type`)?.textContent || 'Period';
    tagsHtml += `<span class="filter-tag"><i class="fas fa-calendar"></i> ${periodName} <i class="fas fa-times" onclick="clearPeriodFilter()"></i></span>`;
    activeCount++;
  }
  
  if (selectedTeacher) {
    const teacherName = document.querySelector(`[data-teacher="${selectedTeacher}"] .teacher-name-mini`)?.textContent || 'Teacher';
    tagsHtml += `<span class="filter-tag"><i class="fas fa-user"></i> ${teacherName} <i class="fas fa-times" onclick="clearTeacherFilter()"></i></span>`;
    activeCount++;
  }
  
  tags.innerHTML = tagsHtml;
  container.style.display = activeCount > 0 ? 'flex' : 'none';
  badge.style.display = activeCount > 0 ? 'inline' : 'none';
  badge.textContent = activeCount;
}

function clearCurriculumFilter() {
  selectedCurriculumType = null;
  document.querySelectorAll('.curriculum-pill').forEach(p => p.classList.toggle('active', p.dataset.curriculum === 'all'));
  document.querySelectorAll('.period-pill').forEach(p => p.style.display = '');
  applyFilters();
  updateActiveFiltersDisplay();
}

function clearPeriodFilter() {
  selectedPeriod = null;
  selectedTeacher = null;
  document.querySelectorAll('.period-pill').forEach(p => p.classList.toggle('active', p.dataset.period === 'all'));
  document.getElementById('teacherFilterStep').style.display = 'none';
  applyFilters();
  updateActiveFiltersDisplay();
}

// Search
function searchCourses() {
  applyFilters();
}

// Filter by Status
function filterByStatus() {
  applyFilters();
}

// Sort Courses
function sortCourses() {
  const sortBy = document.getElementById('sortSelect').value;
  const grid = document.getElementById('coursesGrid');
  const cards = Array.from(grid.querySelectorAll('.course-card'));
  
  cards.sort((a, b) => {
    switch(sortBy) {
      case 'newest':
        return new Date(b.dataset.created) - new Date(a.dataset.created);
      case 'oldest':
        return new Date(a.dataset.created) - new Date(b.dataset.created);
      case 'title':
        return a.dataset.title.localeCompare(b.dataset.title);
      case 'price-high':
        return parseFloat(b.dataset.price) - parseFloat(a.dataset.price);
      case 'price-low':
        return parseFloat(a.dataset.price) - parseFloat(b.dataset.price);
      default:
        return 0;
    }
  });
  
  cards.forEach(card => grid.appendChild(card));
}

// Set View
function setView(view) {
  currentView = view;
  const grid = document.getElementById('coursesGrid');
  const btns = document.querySelectorAll('.view-btn');
  
  btns.forEach(btn => btn.classList.toggle('active', btn.dataset.view === view));
  grid.classList.toggle('list-view', view === 'list');
}

// Bulk Selection
function updateBulkSelection() {
  const checked = document.querySelectorAll('.course-checkbox:checked').length;
  const bulkBar = document.getElementById('bulkActions');
  const countEl = document.getElementById('selectedCount');
  const selectAll = document.getElementById('selectAll');
  
  bulkBar.style.display = checked > 0 ? 'flex' : 'none';
  countEl.textContent = `${checked} selected`;
  selectAll.checked = checked === document.querySelectorAll('.course-checkbox').length;
}

function toggleSelectAll() {
  const isChecked = document.getElementById('selectAll').checked;
  document.querySelectorAll('.course-checkbox').forEach(cb => {
    if (cb.closest('.course-card').style.display !== 'none') {
      cb.checked = isChecked;
    }
  });
  updateBulkSelection();
}

function applyBulkAction() {
  const action = document.getElementById('bulkActionSelect').value;
  if (!action) {
    Swal.fire('Error', 'Please select an action', 'error');
    return;
  }
  
  const codes = Array.from(document.querySelectorAll('.course-checkbox:checked'))
    .map(cb => cb.closest('.course-card').dataset.code);
  
  if (codes.length === 0) return;
  
  Swal.fire({
    title: 'Confirm Action',
    text: `Apply "${action}" to ${codes.length} course(s)?`,
    icon: 'question',
    showCancelButton: true,
    confirmButtonColor: '#3a92bd',
  }).then(result => {
    if (result.isConfirmed) {
      fetch('/admin/courses/bulk-status', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ courseCodes: codes, status: action })
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          Swal.fire('Success', data.message, 'success').then(() => location.reload());
        } else {
          Swal.fire('Error', data.message, 'error');
        }
      });
    }
  });
}

// Load Teachers for Select
function loadTeachersSelect() {
  fetch('/admin/api/teachers')
    .then(res => res.json())
    .then(teachers => {
      const select = document.getElementById('courseTeacher');
      teachers.filter(t => t.isActive).forEach(t => {
        const opt = document.createElement('option');
        opt.value = t._id;
        // Show teacher code if available, otherwise show last 6 chars of ID
        const identifier = t.teacherCode || `ID: ${t._id.slice(-6)}`;
        opt.textContent = `${t.firstName} ${t.lastName} (${identifier})`;
        select.appendChild(opt);
      });
    });
}

// Load Subjects for Filter
function loadSubjectsSelect() {
  const select = document.getElementById('subjectSelect');
  if (!select) return;
  
  // First, try to get subjects from allCourses data (already loaded)
  const subjects = new Set();
  allCourses.forEach(course => {
    if (course.teacher && course.teacher.subject) {
      subjects.add(course.teacher.subject.trim());
    }
  });
  
  // If we found subjects from courses, use them
  if (subjects.size > 0) {
    Array.from(subjects).sort().forEach(subject => {
      const opt = document.createElement('option');
      opt.value = subject.toLowerCase();
      opt.textContent = subject;
      select.appendChild(opt);
    });
  } else {
    // Fallback: fetch from teachers API
    fetch('/admin/api/teachers')
      .then(res => res.json())
      .then(teachers => {
        if (Array.isArray(teachers)) {
          teachers.filter(t => t.isActive && t.subject).forEach(t => {
            subjects.add(t.subject.trim());
          });
          
          Array.from(subjects).sort().forEach(subject => {
            const opt = document.createElement('option');
            opt.value = subject.toLowerCase();
            opt.textContent = subject;
            select.appendChild(opt);
          });
        }
      })
      .catch(err => console.error('Error loading subjects:', err));
  }
}

// Filter by Subject
function filterBySubject() {
  applyFilters();
}

// Load Exam Periods for Select
function loadExamPeriodsSelect() {
  fetch('/admin/api/exam-periods')
    .then(res => res.json())
    .then(periods => {
      const select = document.getElementById('courseExamPeriod');
      // Clear existing options except the first "No Period" option
      while (select.options.length > 1) {
        select.remove(1);
      }
      // Use a Set to track unique period IDs to prevent duplicates
      const addedPeriods = new Set();
      periods.filter(p => p.isActive).forEach(p => {
        if (!addedPeriods.has(p._id)) {
          addedPeriods.add(p._id);
          const opt = document.createElement('option');
          opt.value = p._id;
          opt.textContent = p.name;
          select.appendChild(opt);
        }
      });
    });
}

// Load Exam Periods List
function loadExamPeriodsList() {
  fetch('/admin/api/exam-periods')
    .then(res => res.json())
    .then(periods => {
      const list = document.getElementById('periodsList');
      
      if (!periods || periods.length === 0) {
        list.innerHTML = '<div class="text-center text-muted py-4"><i class="fas fa-calendar-times me-2"></i>No periods yet. Add your first exam period above.</div>';
        return;
      }
      
      list.innerHTML = periods.map(p => {
        const start = new Date(p.startDate).toLocaleDateString();
        const end = new Date(p.endDate).toLocaleDateString();
        const isActive = p.isActive !== false;
        const statusClass = isActive ? 'active' : 'inactive';
        const statusText = isActive ? 'Active' : 'Inactive';
        const statusIcon = isActive ? 'check-circle' : 'times-circle';
        const toggleAction = isActive ? 'Deactivate' : 'Activate';
        const curriculumType = p.curriculumType || 'IGCSE';
        const curriculumClass = curriculumType === 'American' ? 'american' : 'igcse';
        
        return `
          <div class="period-item ${statusClass}">
            <div class="period-info">
              <div class="period-name">
                <i class="fas fa-calendar-alt text-primary me-2"></i>
                <strong>${p.name}</strong>
                <span class="period-curriculum-badge ${curriculumClass}">
                  <i class="fas ${curriculumType === 'American' ? 'fa-flag-usa' : 'fa-graduation-cap'}"></i> ${curriculumType}
                </span>
                <span class="period-status-badge ${statusClass}">
                  <i class="fas fa-${statusIcon}"></i> ${statusText}
                </span>
              </div>
              <div class="period-dates">
                <i class="fas fa-clock me-1"></i>${start} - ${end}
                ${p.year ? `<span class="period-year"><i class="fas fa-calendar-check ms-2 me-1"></i>Year: ${p.year}</span>` : ''}
              </div>
            </div>
            <div class="period-actions">
              <button class="period-action-btn toggle ${statusClass}" onclick="togglePeriodStatus('${p._id}', ${isActive})" title="${toggleAction}">
                <i class="fas fa-${isActive ? 'toggle-on' : 'toggle-off'}"></i>
              </button>
              <button class="period-action-btn edit" onclick="editPeriod('${p._id}')" title="Edit">
                <i class="fas fa-edit"></i>
              </button>
              <button class="period-action-btn delete" onclick="deletePeriod('${p._id}')" title="Delete">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </div>
        `;
      }).join('');
    })
    .catch(err => {
      console.error('Error loading periods:', err);
      document.getElementById('periodsList').innerHTML = '<div class="text-center text-danger py-4"><i class="fas fa-exclamation-triangle me-2"></i>Error loading periods</div>';
    });
}

// Toggle Period Status
async function togglePeriodStatus(periodId, currentStatus) {
  const action = currentStatus ? 'deactivate' : 'activate';
  
  const result = await Swal.fire({
    title: `${currentStatus ? 'Deactivate' : 'Activate'} Period?`,
    text: `Are you sure you want to ${action} this exam period?`,
    icon: 'question',
    showCancelButton: true,
    confirmButtonColor: currentStatus ? '#f59e0b' : '#22c55e',
    confirmButtonText: `Yes, ${action} it`,
  });
  
  if (result.isConfirmed) {
    try {
      const res = await fetch(`/admin/api/exam-periods/${periodId}/toggle-status`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' }
      });
      const data = await res.json();
      
      if (data.success) {
        Swal.fire({
          toast: true,
          position: 'top-end',
          icon: 'success',
          title: `Period ${action}d successfully`,
          showConfirmButton: false,
          timer: 2000
        });
        loadExamPeriodsList();
        loadExamPeriodsSelect();
      } else {
        Swal.fire('Error', data.message || 'Failed to update period', 'error');
      }
    } catch (err) {
      console.error('Error toggling period status:', err);
      Swal.fire('Error', 'Failed to update period status', 'error');
    }
  }
}

// Edit Period
async function editPeriod(periodId) {
  try {
    const res = await fetch(`/admin/api/exam-periods/${periodId}`);
    const period = await res.json();
    
    if (!period || period.error) {
      Swal.fire('Error', 'Period not found', 'error');
      return;
    }
    
    const { value: formValues } = await Swal.fire({
      title: '<i class="fas fa-edit text-primary me-2"></i>Edit Exam Period',
      html: `
        <div class="text-start">
          <div class="mb-3">
            <label class="form-label fw-bold">Curriculum Type</label>
            <select id="editPeriodCurriculumType" class="form-select">
              <option value="IGCSE" ${period.curriculumType === 'IGCSE' ? 'selected' : ''}>IGCSE</option>
              <option value="American" ${period.curriculumType === 'American' ? 'selected' : ''}>American</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label fw-bold">Period Name</label>
            <input id="editPeriodName" class="form-control" value="${period.name || ''}" placeholder="e.g., January 2026">
          </div>
          <div class="mb-3">
            <label class="form-label fw-bold">Display Name</label>
            <input id="editPeriodDisplayName" class="form-control" value="${period.displayName || ''}" placeholder="e.g., Jan '26">
          </div>
          <div class="mb-3">
            <label class="form-label fw-bold">Year</label>
            <input id="editPeriodYear" type="number" class="form-control" value="${period.year || 2026}">
          </div>
          <div class="row">
            <div class="col-6">
              <label class="form-label fw-bold">Start Date</label>
              <input id="editPeriodStartDate" type="date" class="form-control" value="${period.startDate ? period.startDate.substring(0, 10) : ''}">
            </div>
            <div class="col-6">
              <label class="form-label fw-bold">End Date</label>
              <input id="editPeriodEndDate" type="date" class="form-control" value="${period.endDate ? period.endDate.substring(0, 10) : ''}">
            </div>
          </div>
        </div>
      `,
      showCancelButton: true,
      confirmButtonText: '<i class="fas fa-save me-1"></i>Save Changes',
      confirmButtonColor: '#3a92bd',
      preConfirm: () => {
        return {
          curriculumType: document.getElementById('editPeriodCurriculumType').value,
          name: document.getElementById('editPeriodName').value,
          displayName: document.getElementById('editPeriodDisplayName').value,
          year: parseInt(document.getElementById('editPeriodYear').value),
          startDate: document.getElementById('editPeriodStartDate').value,
          endDate: document.getElementById('editPeriodEndDate').value,
        };
      }
    });
    
    if (formValues) {
      const updateRes = await fetch(`/admin/api/exam-periods/${periodId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(formValues)
      });
      const updateData = await updateRes.json();
      
      if (updateData.success) {
        Swal.fire({
          toast: true,
          position: 'top-end',
          icon: 'success',
          title: 'Period updated successfully',
          showConfirmButton: false,
          timer: 2000
        });
        loadExamPeriodsList();
        loadExamPeriodsSelect();
      } else {
        Swal.fire('Error', updateData.message || 'Failed to update period', 'error');
      }
    }
  } catch (err) {
    console.error('Error editing period:', err);
    Swal.fire('Error', 'Failed to load period data', 'error');
  }
}

// Setup Period Form
function setupPeriodForm() {
  document.getElementById('addPeriodForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const data = {
      curriculumType: document.getElementById('periodCurriculumType').value,
      name: document.getElementById('periodName').value,
      displayName: document.getElementById('periodDisplayName').value,
      year: parseInt(document.getElementById('periodYear').value),
      startDate: document.getElementById('periodStartDate').value,
      endDate: document.getElementById('periodEndDate').value,
    };
    
    try {
      const res = await fetch('/admin/api/exam-periods', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });
      const result = await res.json();
      
      if (result.success) {
        Swal.fire('Success', 'Period added!', 'success');
        this.reset();
        loadExamPeriodsList();
        loadExamPeriodsSelect();
      } else {
        Swal.fire('Error', result.message, 'error');
      }
    } catch (err) {
      Swal.fire('Error', 'Failed to add period', 'error');
    }
  });
}

async function deletePeriod(id) {
  const result = await Swal.fire({
    title: 'Delete Period?',
    text: 'This cannot be undone',
    icon: 'warning',
    showCancelButton: true,
    confirmButtonColor: '#ef4444',
  });
  
  if (result.isConfirmed) {
    const res = await fetch(`/admin/api/exam-periods/${id}`, { method: 'DELETE' });
    const data = await res.json();
    if (data.success) {
      Swal.fire('Deleted', 'Period removed', 'success');
      loadExamPeriodsList();
    } else {
      Swal.fire('Error', data.message, 'error');
    }
  }
}

// Thumbnail Upload
function setupThumbnailUpload() {
  const input = document.getElementById('courseThumbnail');
  const placeholder = document.getElementById('thumbnailPlaceholder');
  const previewImg = document.getElementById('thumbnailPreviewImg');
  const urlInput = document.getElementById('thumbnailUrl');
  const uploadBox = document.getElementById('thumbnailUploadBox');
  
  if (!input) return;
  
  input.addEventListener('change', async function() {
    if (!this.files[0]) return;
    
    const file = this.files[0];
    
    // Validate file type
    const allowedTypes = ['image/jpeg', 'image/png', 'image/jpg', 'image/webp', 'image/gif'];
    if (!allowedTypes.includes(file.type)) {
      Swal.fire('Error', 'Please upload an image file (JPEG, PNG, WebP, or GIF)', 'error');
      return;
    }
    
    // Validate file size (5MB max)
    if (file.size > 5 * 1024 * 1024) {
      Swal.fire('Error', 'Image size must be less than 5MB', 'error');
      return;
    }
    
    const formData = new FormData();
    formData.append('image', file);
    formData.append('uploadType', 'course-thumbnails');
    
    // Show loading state
    if (placeholder) {
      placeholder.innerHTML = '<i class="fas fa-spinner fa-spin"></i><span>Uploading...</span>';
    }
    
    try {
      const res = await fetch('/api/upload/image', {
        method: 'POST',
        body: formData
      });
      
      // Check if response is OK and JSON
      const contentType = res.headers.get('content-type');
      if (!res.ok) {
        throw new Error(`Upload failed with status ${res.status}`);
      }
      if (!contentType || !contentType.includes('application/json')) {
        throw new Error('Server returned invalid response. Please try again.');
      }
      
      const data = await res.json();
      
      if (data.success) {
        urlInput.value = data.url;
        if (previewImg) {
          previewImg.src = data.url;
          previewImg.style.display = 'block';
        }
        if (placeholder) {
          placeholder.style.display = 'none';
        }
        Swal.fire({
          toast: true,
          position: 'top-end',
          icon: 'success',
          title: 'Thumbnail uploaded!',
          showConfirmButton: false,
          timer: 2000
        });
      } else {
        throw new Error(data.message || 'Upload failed');
      }
    } catch (err) {
      console.error('Upload error:', err);
      if (placeholder) {
        placeholder.innerHTML = '<i class="fas fa-cloud-upload-alt"></i><span>Click to upload</span><small>800Ã—450px recommended</small>';
        placeholder.style.display = 'flex';
      }
      if (previewImg) {
        previewImg.style.display = 'none';
      }
      Swal.fire('Upload Failed', err.message || 'Failed to upload image', 'error');
    }
  });
}

// Share Course
function shareCourse(code, title, id) {
  const baseUrl = window.location.hostname !== 'localhost' ? 'https://elkably.com' : window.location.origin;
  const url = `${baseUrl}/student/course/${id}/content`;
  
  Swal.fire({
    title: '<i class="fas fa-share-alt text-primary me-2"></i>Share Course',
    html: `
      <div class="text-start">
        <p class="mb-3"><strong>${title}</strong></p>
        <div class="mb-3">
          <label class="form-label small text-muted">Course Link</label>
          <div class="input-group">
            <input type="text" class="form-control" id="shareUrl" value="${url}" readonly>
            <button class="btn btn-primary" onclick="copyLink()"><i class="fas fa-copy"></i></button>
          </div>
        </div>
        <div class="d-flex gap-2">
          <a href="https://wa.me/?text=${encodeURIComponent(title + '\n' + url)}" target="_blank" class="btn btn-success flex-fill">
            <i class="fab fa-whatsapp me-1"></i>WhatsApp
          </a>
          <a href="mailto:?subject=${encodeURIComponent(title)}&body=${encodeURIComponent(url)}" class="btn btn-danger flex-fill">
            <i class="fas fa-envelope me-1"></i>Email
          </a>
        </div>
      </div>
    `,
    showConfirmButton: false,
    showCloseButton: true,
  });
}

function copyLink() {
  const input = document.getElementById('shareUrl');
  input.select();
  document.execCommand('copy');
  Swal.showValidationMessage('Copied!');
  setTimeout(() => Swal.resetValidationMessage(), 1500);
}

// Duplicate Course
function duplicateCourse(code) {
  Swal.fire({
    title: 'Duplicate Course?',
    text: 'This will create a copy with all content',
    icon: 'question',
    showCancelButton: true,
    confirmButtonColor: '#3a92bd',
  }).then(result => {
    if (result.isConfirmed) {
      fetch(`/admin/courses/${code}/duplicate`, { method: 'POST' })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            Swal.fire('Success', 'Course duplicated!', 'success').then(() => location.reload());
          } else {
            Swal.fire('Error', data.message, 'error');
          }
        });
    }
  });
}

// Delete Course
function deleteCourse(code, status) {
  const msg = status === 'archived' 
    ? 'PERMANENTLY DELETE this course?' 
    : 'Archive this course?';
  
  Swal.fire({
    title: 'Delete Course?',
    text: msg,
    icon: 'warning',
    showCancelButton: true,
    confirmButtonColor: '#ef4444',
  }).then(result => {
    if (result.isConfirmed) {
      fetch(`/admin/courses/${code}`, { method: 'DELETE' })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            Swal.fire('Done', data.message, 'success').then(() => location.reload());
          } else {
            Swal.fire('Error', data.message, 'error');
          }
        });
    }
  });
}
</script>
