<%- include('partials/admin-header', { title: 'Team Management', theme: 'admin', pageCSS: 'brilliant-students' }) %>

<!-- Admin Layout -->
<div class="admin-layout">

  <!-- Sidebar -->
  <%- include('./partials/admin-sidebar', { currentPage: 'team-management' }) %>

  <!-- Main Content -->
  <main class="admin-main">

    <!-- Top Bar -->
    <%- include('./partials/admin-topbar', { 
        breadcrumb: 'Team Management',
        breadcrumbSubtitle: 'Manage Elkably Team Members',
        showSearch: false
    }) %>

    <!-- Content Area -->
    <div class="admin-content">

      <!-- Team Management Page -->
      <div class="brilliant-students-container">
        <!-- Header Section -->
        <div class="brilliant-students-header">
          <div class="brilliant-students-title">
            <i class="fas fa-users"></i>
            <div>
              <h1>Elkably Team</h1>
              <p>Manage team members displayed on the homepage</p>
            </div>
          </div>
          <div class="brilliant-students-actions">
            <button class="btn-export" onclick="exportTeamMembers()">
              <i class="fas fa-file-excel"></i>
              Export Excel Report
            </button>
            <button class="btn-add-student" onclick="showAddMemberModal()">
              <i class="fas fa-plus"></i>
              Add Team Member
            </button>
          </div>
        </div>

        <!-- Statistics Cards -->
        <div class="brilliant-students-stats">
          <div class="stat-card">
            <div class="stat-card-icon">
              <i class="fas fa-users"></i>
            </div>
            <div class="stat-card-number"><%= pagination.totalMembers %></div>
            <div class="stat-card-label">Total Members</div>
          </div>

          <div class="stat-card">
            <div class="stat-card-icon">
              <i class="fas fa-user-check"></i>
            </div>
            <div class="stat-card-number"><%= stats.active %></div>
            <div class="stat-card-label">Active Members</div>
          </div>

          <div class="stat-card">
            <div class="stat-card-icon">
              <i class="fas fa-user-times"></i>
            </div>
            <div class="stat-card-number"><%= stats.inactive %></div>
            <div class="stat-card-label">Inactive Members</div>
          </div>
        </div>

        <!-- Filters Section -->
        <div class="brilliant-students-filters">
          <form method="GET" action="/admin/team-management" class="filters-form">
            <div class="filters-row">
              <div class="filter-group">
                <label class="filter-label">Status</label>
                <select name="isActive" class="filter-control">
                  <option value="">All Status</option>
                  <option value="true" <%= filters.isActive === 'true' ? 'selected' : '' %>>Active</option>
                  <option value="false" <%= filters.isActive === 'false' ? 'selected' : '' %>>Inactive</option>
                </select>
              </div>

              <div class="filter-group">
                <label class="filter-label">Search</label>
                <input type="text" name="search" class="filter-control" placeholder="Search by name or position..." value="<%= filters.search %>">
              </div>
            </div>

            <div class="filter-actions">
              <button type="submit" class="btn-filter primary">
                <i class="fas fa-search"></i>
                Apply Filters
              </button>
              <a href="/admin/team-management" class="btn-filter">
                <i class="fas fa-times"></i>
                Clear Filters
              </a>
            </div>
          </form>
        </div>

        <!-- Team Members Grid -->
        <div class="brilliant-students-grid" id="teamMembersGrid">
          <% if (teamMembers && teamMembers.length > 0) { %>
          <% teamMembers.forEach(member => { %>
          <div class="student-card draggable" data-id="<%= member._id %>">
            <div class="student-card-header">
              <div class="student-card-actions">
                <button class="student-card-action" onclick="editMember('<%= member._id %>')" title="Edit">
                  <i class="fas fa-edit"></i>
                </button>
                <button class="student-card-action" onclick="deleteMember('<%= member._id %>')" title="Delete">
                  <i class="fas fa-trash"></i>
                </button>
              </div>

              <div class="student-card-photo">
                <% if (member.image) { %>
                <img src="<%= member.image %>" alt="<%= member.name %>" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                <% } %>
                <div class="fallback" data-visible="<%= member.image ? 'false' : 'true' %>"><%= member.fallbackInitials %></div>
              </div>

              <div class="student-card-name"><%= member.name %></div>
              <div class="student-card-test-type"><%= member.position %></div>
            </div>

            <div class="student-card-body">
              <div class="student-card-details">
                <div class="student-detail-item">
                  <i class="fas fa-user-tag"></i>
                  <span><%= member.position %></span>
                </div>
                <div class="student-detail-item">
                  <i class="fas fa-sort-numeric-up"></i>
                  <span>Order: <%= member.displayOrder %></span>
                </div>
              </div>
            </div>

            <div class="student-card-footer">
              <div class="student-status <%= member.isActive ? 'active' : 'inactive' %>">
                <i class="fas fa-circle"></i>
                <%= member.isActive ? 'Active' : 'Inactive' %>
              </div>
              <div class="student-display-order">Order: <%= member.displayOrder %></div>
            </div>
          </div>
          <% }); %>
          <% } else { %>
          <div class="no-students-message">
            <div class="no-students-icon">
              <i class="fas fa-users"></i>
            </div>
            <h3>No Team Members Found</h3>
            <p>Start by adding some team members to showcase on the homepage.</p>
            <button class="btn-add-student" onclick="showAddMemberModal()">
              <i class="fas fa-plus"></i>
              Add First Member
            </button>
          </div>
          <% } %>
        </div>

      </div>

      <!-- Add/Edit Team Member Modal (Bootstrap) -->
      <div class="modal fade" id="memberModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="modalTitle">Add Team Member</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <form id="memberForm">
              <div class="modal-body">
                <div class="form-grid">
                  <div class="form-group">
                    <label class="form-label">Member Name <span class="required">*</span></label>
                    <input type="text" name="name" class="form-control" required>
                  </div>

                  <div class="form-group">
                    <label class="form-label">Position <span class="required">*</span></label>
                    <input type="text" name="position" class="form-control" placeholder="e.g., HEAD, TEAM LEADER" required>
                    <div class="form-help">Enter the team member's position/role</div>
                  </div>

                  <div class="form-group">
                    <label class="form-label">Fallback Initials <span class="required">*</span></label>
                    <input type="text" name="fallbackInitials" class="form-control" required maxlength="5" placeholder="e.g., NE">
                    <div class="form-help">Used when image is not available</div>
                  </div>

                  <div class="form-group">
                    <label class="form-label">Member Photo</label>
                    <input type="text" name="image" id="memberImageUrl" class="form-control" placeholder="Enter image URL or upload below">
                    <div class="form-help">Optional: URL to member's photo or upload using the section below</div>
                  </div>

                  <!-- Image Upload Section -->
                  <div class="form-group">
                    <label class="form-label">
                      <i class="fas fa-cloud-upload-alt me-2"></i>
                      Upload Member Photo
                    </label>
                    <div class="upload-section">
                      <input type="file" id="memberImageFile" class="upload-input" accept="image/*">
                      <label for="memberImageFile" class="upload-label">
                        <i class="fas fa-cloud-upload-alt"></i>
                        Choose Photo
                      </label>
                      <div id="memberImagePreview" class="upload-preview">
                        <div class="preview-overlay">
                          <i class="fas fa-cloud-upload-alt"></i>
                          <p>Click or drag to upload photo</p>
                          <small>JPEG, PNG, JPG, WebP (max 10MB)</small>
                        </div>
                      </div>
                      <div id="memberImageProgress" class="upload-progress" style="display: none;"></div>
                    </div>
                  </div>

                  <div class="form-group" id="displayOrderGroup" style="display: none;">
                    <label class="form-label">Display Order</label>
                    <input type="number" name="displayOrder" class="form-control" min="0" value="0">
                    <div class="form-help">Lower numbers appear first. New members are automatically added to the end.</div>
                  </div>

                  <div class="form-group">
                    <label class="form-label">Status</label>
                    <select name="isActive" class="form-control">
                      <option value="true">Active</option>
                      <option value="false">Inactive</option>
                    </select>
                  </div>
                </div>
              </div>

              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" class="btn btn-primary" id="submitButton">
                  <span class="button-text">Save Member</span>
                  <span class="button-loading" style="display: none;">
                    <i class="fas fa-spinner fa-spin"></i> Saving...
                  </span>
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>

      <!-- Local Upload Script -->
      <script src="/js/local-upload.js"></script>
      
      <!-- CropperJS CSS and JS -->
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
      <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>

      <!-- Image Crop Modal -->
      <div id="cropModal" class="crop-modal" style="display: none; position: fixed; z-index: 10000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.8); backdrop-filter: blur(4px);">
        <div class="crop-modal-content" style="background: #fff; border-radius: 12px; padding: 24px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.3); margin: auto; margin-top: 5vh;">
          <div class="crop-modal-header" style="margin-bottom: 20px; text-align: center; border-bottom: 2px solid #e5e7eb; padding-bottom: 16px;">
            <h3 class="crop-modal-title" style="font-size: 1.5rem; font-weight: 700; color: #1f2937; margin: 0 0 8px 0; display: flex; align-items: center; justify-content: center; gap: 8px;">
              <i class="fas fa-crop-alt" style="color: #B80101;"></i>
              Crop Your Photo
            </h3>
            <p class="crop-modal-subtitle" style="color: #6b7280; font-size: 0.875rem; margin: 0;">Adjust the crop area to select the perfect photo</p>
          </div>
          
          <div class="crop-container" style="width: 100%; max-height: 400px; background: #f3f4f6; border-radius: 8px; overflow: hidden; margin-bottom: 20px; border: 2px solid #e5e7eb;">
            <img id="cropImage" src="" alt="Image to crop" style="max-width: 100%; display: block;">
          </div>

          <div class="crop-controls" style="display: flex; flex-wrap: wrap; gap: 12px; margin-bottom: 20px; padding: 16px; background: #f9fafb; border-radius: 8px; border: 1px solid #e5e7eb;">
            <button type="button" class="crop-control-btn" onclick="rotateCropImage(-90)" style="flex: 1; min-width: 100px; padding: 8px 16px; border: 2px solid #e5e7eb; background: #fff; color: #1f2937; border-radius: 6px; cursor: pointer; transition: all 0.3s ease; font-size: 0.875rem; font-weight: 500; display: flex; align-items: center; justify-content: center; gap: 6px;">
              <i class="fas fa-undo"></i>
              Rotate Left
            </button>
            <button type="button" class="crop-control-btn" onclick="rotateCropImage(90)" style="flex: 1; min-width: 100px; padding: 8px 16px; border: 2px solid #e5e7eb; background: #fff; color: #1f2937; border-radius: 6px; cursor: pointer; transition: all 0.3s ease; font-size: 0.875rem; font-weight: 500; display: flex; align-items: center; justify-content: center; gap: 6px;">
              <i class="fas fa-redo"></i>
              Rotate Right
            </button>
            <button type="button" class="crop-control-btn" onclick="flipCropImage('horizontal')" style="flex: 1; min-width: 100px; padding: 8px 16px; border: 2px solid #e5e7eb; background: #fff; color: #1f2937; border-radius: 6px; cursor: pointer; transition: all 0.3s ease; font-size: 0.875rem; font-weight: 500; display: flex; align-items: center; justify-content: center; gap: 6px;">
              <i class="fas fa-arrows-alt-h"></i>
              Flip H
            </button>
            <button type="button" class="crop-control-btn" onclick="flipCropImage('vertical')" style="flex: 1; min-width: 100px; padding: 8px 16px; border: 2px solid #e5e7eb; background: #fff; color: #1f2937; border-radius: 6px; cursor: pointer; transition: all 0.3s ease; font-size: 0.875rem; font-weight: 500; display: flex; align-items: center; justify-content: center; gap: 6px;">
              <i class="fas fa-arrows-alt-v"></i>
              Flip V
            </button>
            <button type="button" class="crop-control-btn" onclick="resetCropImage()" style="flex: 1; min-width: 100px; padding: 8px 16px; border: 2px solid #e5e7eb; background: #fff; color: #1f2937; border-radius: 6px; cursor: pointer; transition: all 0.3s ease; font-size: 0.875rem; font-weight: 500; display: flex; align-items: center; justify-content: center; gap: 6px;">
              <i class="fas fa-sync-alt"></i>
              Reset
            </button>
          </div>
          
          <div class="crop-modal-footer" style="display: flex; gap: 12px; justify-content: flex-end;">
            <button type="button" class="btn btn-outline" onclick="closeCropModal()" style="padding: 10px 20px; border-radius: 6px; font-weight: 500; font-size: 0.875rem; transition: all 0.3s ease; cursor: pointer; border: 2px solid #e5e7eb; background: transparent; color: #1f2937;">
              <i class="fas fa-times"></i>
              Cancel
            </button>
            <button type="button" class="btn btn-primary" onclick="cropAndUploadMemberImage()" style="padding: 10px 20px; border-radius: 6px; font-weight: 500; font-size: 0.875rem; transition: all 0.3s ease; cursor: pointer; border: none; background: #B80101; color: white;">
              <i class="fas fa-check"></i>
              Crop & Upload
            </button>
          </div>
        </div>
      </div>

      <script>
        // Global variables
        let isEditMode = false;
        let currentMemberId = null;
        let cropper = null;
        let currentImageFile = null;
        let currentImagePreview = null;
        let currentImageProgress = null;
        let currentImageUrlInput = null;

        // Initialize local upload functionality
        document.addEventListener('DOMContentLoaded', function() {
          // Initialize local upload functionality and Bootstrap modal instance
          const modalEl = document.getElementById('memberModal');
          if (modalEl && typeof bootstrap !== 'undefined' && bootstrap.Modal) {
            // Make instance globally accessible for other functions
            window.memberModalInstance = bootstrap.Modal.getOrCreateInstance(modalEl);
            console.log('memberModal initialized');
          } else if (!modalEl) {
            console.warn('memberModal element not found');
          } else {
            console.warn('Bootstrap Modal API not available');
          }

          // Initialize image upload for member photos (using local upload)
          setupMemberImageUpload();
        });

        // Setup member image upload functionality
        function setupMemberImageUpload() {
          const imageFileInput = document.getElementById('memberImageFile');
          const imagePreview = document.getElementById('memberImagePreview');
          const imageProgress = document.getElementById('memberImageProgress');
          const imageUrlInput = document.getElementById('memberImageUrl');

          if (!imageFileInput || !imagePreview || !imageProgress || !imageUrlInput) {
            console.error('Member image upload elements not found');
            return;
          }

          // Handle file selection
          imageFileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
              handleMemberImageSelection(file, imagePreview, imageProgress, imageUrlInput);
            }
          });

          // Handle drag and drop
          imagePreview.addEventListener('dragover', (e) => {
            e.preventDefault();
            imagePreview.classList.add('drag-over');
          });

          imagePreview.addEventListener('dragleave', (e) => {
            e.preventDefault();
            imagePreview.classList.remove('drag-over');
          });

          imagePreview.addEventListener('drop', (e) => {
            e.preventDefault();
            imagePreview.classList.remove('drag-over');
            const file = e.dataTransfer.files[0];
            if (file) {
              imageFileInput.files = e.dataTransfer.files;
              handleMemberImageSelection(file, imagePreview, imageProgress, imageUrlInput);
            }
          });
        }

        // Handle member image selection and upload
        function handleMemberImageSelection(file, preview, progress, urlInput) {
          // Validate file
          if (!validateMemberImageFile(file)) {
            return;
          }

          // Store references for later use
          currentImageFile = file;
          currentImagePreview = preview;
          currentImageProgress = progress;
          currentImageUrlInput = urlInput;

          // Read the file and show in crop modal
          const reader = new FileReader();
          reader.onload = function(e) {
            const cropImage = document.getElementById('cropImage');
            cropImage.src = e.target.result;
            
            // Show crop modal
            showCropModal();
          };
          reader.readAsDataURL(file);
        }

        // Validate member image file
        function validateMemberImageFile(file) {
          const maxFileSize = 10 * 1024 * 1024; // 10MB
          const allowedTypes = ['image/jpeg', 'image/png', 'image/jpg', 'image/webp'];

          // Check file size
          if (file.size > maxFileSize) {
            showNotification('File size must be less than 10MB', 'error');
            return false;
          }

          // Check file type
          if (!allowedTypes.includes(file.type)) {
            showNotification('Only JPEG, PNG, JPG, and WebP images are allowed', 'error');
            return false;
          }

          return true;
        }

        // Show member image preview
        function showMemberImagePreview(file, preview) {
          const reader = new FileReader();
          reader.onload = (e) => {
            preview.innerHTML = `
              <img src="${e.target.result}" alt="Preview" class="preview-image">
              <div class="preview-overlay">
                <i class="fas fa-cloud-upload-alt"></i>
                <p>Uploading...</p>
                <small>${file.name}</small>
              </div>
            `;
          };
          reader.readAsDataURL(file);
        }

        // Show member image upload progress
        function showMemberImageProgress(progress, percent) {
          progress.style.display = 'block';
          progress.innerHTML = `
            <div class="progress-container">
              <div class="progress-bar">
                <div class="progress-fill" style="width: ${percent}%"></div>
              </div>
              <div class="progress-text">${percent}%</div>
            </div>
          `;
        }

        // Show crop modal
        function showCropModal() {
          const modal = document.getElementById('cropModal');
          modal.style.display = 'flex';
          document.body.style.overflow = 'hidden';

          // Initialize cropper
          const cropImage = document.getElementById('cropImage');
          if (cropper) {
            cropper.destroy();
          }
          
          cropper = new Cropper(cropImage, {
            aspectRatio: 1, // Square crop
            viewMode: 2,
            dragMode: 'move',
            autoCropArea: 0.8,
            restore: false,
            guides: true,
            center: true,
            highlight: false,
            cropBoxMovable: true,
            cropBoxResizable: true,
            toggleDragModeOnDblclick: false,
            responsive: true,
            background: false,
            modal: true,
            minContainerWidth: 200,
            minContainerHeight: 200,
            minCropBoxWidth: 100,
            minCropBoxHeight: 100,
          });
        }

        // Close crop modal
        function closeCropModal() {
          const modal = document.getElementById('cropModal');
          modal.style.display = 'none';
          document.body.style.overflow = 'auto';
          
          // Destroy cropper instance
          if (cropper) {
            cropper.destroy();
            cropper = null;
          }
          
          // Reset file input
          const fileInput = document.getElementById('memberImageFile');
          if (fileInput) {
            fileInput.value = '';
          }
          
          currentImageFile = null;
          currentImagePreview = null;
          currentImageProgress = null;
          currentImageUrlInput = null;
        }

        // Rotate crop image
        function rotateCropImage(degree) {
          if (cropper) {
            cropper.rotate(degree);
          }
        }

        // Flip crop image
        function flipCropImage(direction) {
          if (cropper) {
            if (direction === 'horizontal') {
              cropper.scaleX(-cropper.getData().scaleX || -1);
            } else if (direction === 'vertical') {
              cropper.scaleY(-cropper.getData().scaleY || -1);
            }
          }
        }

        // Reset crop image
        function resetCropImage() {
          if (cropper) {
            cropper.reset();
          }
        }

        // Crop and upload member image
        async function cropAndUploadMemberImage() {
          if (!cropper) {
            showNotification('No image to crop', 'error');
            return;
          }

          // Show loading state
          const uploadBtn = document.querySelector('.crop-modal-footer .btn-primary');
          const originalContent = uploadBtn.innerHTML;
          uploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uploading...';
          uploadBtn.disabled = true;

          try {
            // Get cropped canvas
            const canvas = cropper.getCroppedCanvas({
              width: 400,
              height: 400,
              imageSmoothingEnabled: true,
              imageSmoothingQuality: 'high',
            });

            // Convert canvas to blob
            canvas.toBlob(async (blob) => {
              if (!blob) {
                throw new Error('Failed to create image blob');
              }

              // Show progress bar
              if (currentImageProgress) {
                showMemberImageProgress(currentImageProgress, 0);
              }

              // Validate file size (max 5MB)
              if (blob.size > 5 * 1024 * 1024) {
                const fileSizeMB = (blob.size / (1024 * 1024)).toFixed(2);
                showNotification(`Image size (${fileSizeMB}MB) exceeds maximum allowed size of 5MB. Please choose a smaller image.`, 'error');
                uploadBtn.innerHTML = originalContent;
                uploadBtn.disabled = false;
                return;
              }

              // Create form data for local upload
              const formData = new FormData();
              formData.append('image', blob, currentImageFile.name);
              formData.append('uploadType', 'team-members');

              const xhr = new XMLHttpRequest();

              // Upload progress
              xhr.upload.addEventListener('progress', (e) => {
                if (e.lengthComputable && currentImageProgress) {
                  const percent = Math.round((e.loaded / e.total) * 100);
                  showMemberImageProgress(currentImageProgress, percent);
                }
              });

              // Upload complete
              xhr.addEventListener('load', () => {
                if (xhr.status === 200) {
                  try {
                    const response = JSON.parse(xhr.responseText);
                    if (response.success && response.url) {
                      if (currentImagePreview && currentImageProgress && currentImageUrlInput) {
                        showMemberImageSuccess(currentImagePreview, currentImageProgress, response.url, currentImageUrlInput);
                      }
                      closeCropModal();
                    } else {
                      throw new Error(response.message || 'Upload failed');
                    }
                  } catch (e) {
                    showNotification('Invalid response from server. Please try again.', 'error');
                    if (currentImagePreview && currentImageProgress) {
                      resetMemberImageUpload(currentImagePreview, currentImageProgress);
                    }
                  }
                } else {
                  try {
                    const error = JSON.parse(xhr.responseText);
                    showNotification(error.message || `Upload failed with status ${xhr.status}`, 'error');
                  } catch (e) {
                    showNotification(`Upload failed with status ${xhr.status}. Please try again.`, 'error');
                  }
                  if (currentImagePreview && currentImageProgress) {
                    resetMemberImageUpload(currentImagePreview, currentImageProgress);
                  }
                }
                uploadBtn.innerHTML = originalContent;
                uploadBtn.disabled = false;
              });

              // Upload error
              xhr.addEventListener('error', () => {
                showNotification('Upload failed. Please check your connection and try again.', 'error');
                if (currentImagePreview && currentImageProgress) {
                  resetMemberImageUpload(currentImagePreview, currentImageProgress);
                }
                uploadBtn.innerHTML = originalContent;
                uploadBtn.disabled = false;
              });

              // Start upload
              xhr.open('POST', '/api/upload/image', true);
              xhr.send(formData);
            }, 'image/jpeg', 0.9);
          } catch (error) {
            console.error('Error cropping image:', error);
            showNotification(error.message || 'Error cropping image', 'error');
            uploadBtn.innerHTML = originalContent;
            uploadBtn.disabled = false;
          }
        }

        // Close modal when clicking outside
        document.getElementById('cropModal')?.addEventListener('click', function(e) {
          if (e.target === this) {
            closeCropModal();
          }
        });

        // Show member image upload success
        function showMemberImageSuccess(preview, progress, url, urlInput) {
          preview.innerHTML = `
            <img src="${url}" alt="Uploaded Image" class="preview-image">
            <div class="preview-overlay" style="opacity: 1; background: rgba(40, 167, 69, 0.9);">
              <i class="fas fa-check-circle" style="color: white;"></i>
              <p>Upload Successful!</p>
              <small>Image saved to server</small>
            </div>
          `;

          // Set the URL input value
          urlInput.value = url;
          urlInput.style.backgroundColor = '#d4edda';
          urlInput.style.border = '1px solid #c3e6cb';

          progress.style.display = 'none';
          showNotification('Image uploaded successfully!', 'success');
        }

        // Reset member image upload
        function resetMemberImageUpload(preview, progress) {
          preview.innerHTML = `
            <div class="preview-overlay">
              <i class="fas fa-cloud-upload-alt"></i>
              <p>Click or drag to upload photo</p>
              <small>JPEG, PNG, JPG, WebP (max 10MB)</small>
            </div>
          `;
          progress.style.display = 'none';
        }

        // Show add member modal
        function showAddMemberModal() {
          isEditMode = false;
          currentMemberId = null;
          document.getElementById('modalTitle').textContent = 'Add Team Member';
          document.getElementById('memberForm').reset();
          
          // Hide displayOrder field when adding (will be auto-set to last)
          const displayOrderGroup = document.getElementById('displayOrderGroup');
          if (displayOrderGroup) {
            displayOrderGroup.style.display = 'none';
          }

          // Reset image upload section
          const imagePreview = document.getElementById('memberImagePreview');
          const imageProgress = document.getElementById('memberImageProgress');
          const imageUrlInput = document.getElementById('memberImageUrl');

          if (imagePreview) {
            imagePreview.innerHTML = `
              <div class="preview-overlay">
                <i class="fas fa-cloud-upload-alt"></i>
                <p>Click or drag to upload photo</p>
                <small>JPEG, PNG, JPG, WebP (max 10MB)</small>
              </div>
            `;
          }

          if (imageProgress) {
            imageProgress.style.display = 'none';
          }

          if (imageUrlInput) {
            imageUrlInput.style.backgroundColor = '';
            imageUrlInput.style.border = '';
          }

          // Lazy-init Bootstrap modal instance if bootstrap is now available
          if (!window.memberModalInstance && typeof bootstrap !== 'undefined' && bootstrap.Modal) {
            window.memberModalInstance = bootstrap.Modal.getOrCreateInstance(document.getElementById('memberModal'));
            console.log('memberModal instance created lazily');
          }

          // Use Bootstrap modal API to show
          if (window.memberModalInstance && typeof window.memberModalInstance.show === 'function') {
            window.memberModalInstance.show();
            console.log('Bootstrap modal shown');
          } else {
            // Fallback to direct element manipulation if Bootstrap not available
            const modal = document.getElementById('memberModal');
            if (modal) {
              modal.style.display = 'flex';
              modal.classList.add('show');
              console.log('Fallback modal shown');
            }
          }
        }

        // Show edit member modal
        async function editMember(memberId) {
          try {
            const response = await fetch(`/admin/team-management/${memberId}`);
            const member = await response.json();

            if (member.success) {
              isEditMode = true;
              currentMemberId = memberId;

              // Populate form with member data
              document.getElementById('modalTitle').textContent = 'Edit Team Member';

              // Show displayOrder field when editing
              const displayOrderGroup = document.getElementById('displayOrderGroup');
              if (displayOrderGroup) {
                displayOrderGroup.style.display = 'block';
              }

              // Fill form fields
              document.querySelector('input[name="name"]').value = member.data.name;
              document.querySelector('input[name="position"]').value = member.data.position;
              document.querySelector('input[name="fallbackInitials"]').value = member.data.fallbackInitials;
              document.querySelector('input[name="image"]').value = member.data.image || '';
              document.querySelector('input[name="displayOrder"]').value = member.data.displayOrder;
              document.querySelector('select[name="isActive"]').value = member.data.isActive;

              // Handle image preview for edit mode
              if (member.data.image) {
                const imagePreview = document.getElementById('memberImagePreview');
                imagePreview.innerHTML = `
                  <img src="${member.data.image}" alt="Current Image" class="preview-image">
                  <div class="preview-overlay" style="opacity: 0.7;">
                    <i class="fas fa-edit"></i>
                    <p>Current Image</p>
                    <small>Click to upload new image</small>
                  </div>
                `;
              }

              // Lazy-init bootstrap modal if needed
              if (!window.memberModalInstance && typeof bootstrap !== 'undefined' && bootstrap.Modal) {
                window.memberModalInstance = bootstrap.Modal.getOrCreateInstance(document.getElementById('memberModal'));
                console.log('memberModal instance created lazily for edit');
              }

              // Show using Bootstrap modal instance
              if (window.memberModalInstance && typeof window.memberModalInstance.show === 'function') {
                window.memberModalInstance.show();
                console.log('Bootstrap modal shown for edit');
              } else {
                const modal = document.getElementById('memberModal');
                if (modal) {
                  modal.style.display = 'flex';
                  modal.classList.add('show');
                  console.log('Fallback modal shown for edit');
                }
              }
            } else {
              showNotification('Failed to load member data', 'error');
            }
          } catch (error) {
            console.error('Error loading member data:', error);
            showNotification('Failed to load member data', 'error');
          }
        }

        // Hide member modal
        function hideMemberModal() {
          if (window.memberModalInstance && typeof window.memberModalInstance.hide === 'function') {
            window.memberModalInstance.hide();
            console.log('Bootstrap modal hidden');
            return;
          }

          const modal = document.getElementById('memberModal');
          if (modal) {
            modal.classList.remove('show');
            modal.style.display = 'none';
            console.log('Fallback modal hidden');
          }
        }

        // Handle form submission
        async function handleFormSubmit(event) {
          event.preventDefault();

          const form = document.getElementById('memberForm');
          const formData = new FormData(form);
          const submitButton = document.getElementById('submitButton');
          const buttonText = submitButton.querySelector('.button-text');
          const buttonLoading = submitButton.querySelector('.button-loading');

          // Show loading state
          submitButton.disabled = true;
          buttonText.style.display = 'none';
          buttonLoading.style.display = 'inline-block';

          try {
            // Prepare data object
            const data = {
              name: formData.get('name'),
              position: formData.get('position'),
              image: formData.get('image'),
              fallbackInitials: formData.get('fallbackInitials'),
              displayOrder: isEditMode ? parseInt(formData.get('displayOrder')) || 0 : 0, // Auto-set to last when creating
              isActive: formData.get('isActive')
            };

            console.log('Submitting data:', data);

            let url, method;
            if (isEditMode && currentMemberId) {
              url = `/admin/team-management/${currentMemberId}`;
              method = 'PUT';
            } else {
              url = '/admin/team-management';
              method = 'POST';
            }

            const response = await fetch(url, {
              method: method,
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify(data)
            });

            const result = await response.json();

            if (result.success) {
              showNotification(result.message, 'success');
              hideMemberModal();
              // Reload the page to show the new/updated member
              setTimeout(() => location.reload(), 1000);
            } else {
              showNotification(result.message, 'error');
              console.error('Server error:', result);
            }
          } catch (error) {
            console.error('Error submitting form:', error);
            showNotification('Failed to save member. Please try again.', 'error');
          } finally {
            // Reset button state
            submitButton.disabled = false;
            buttonText.style.display = 'inline-block';
            buttonLoading.style.display = 'none';
          }
        }

        // Add form submission event listener
        document.addEventListener('DOMContentLoaded', function() {
          const form = document.getElementById('memberForm');
          if (form) {
            form.addEventListener('submit', handleFormSubmit);
          }

          // Set fallback visibility from data attributes
          const fallbacks = document.querySelectorAll('.fallback[data-visible]');
          fallbacks.forEach(fallback => {
            const visible = fallback.getAttribute('data-visible') === 'true';
            fallback.style.display = visible ? 'flex' : 'none';
          });
        });

        // Delete member
        function deleteMember(memberId) {
          if (confirm('Are you sure you want to delete this team member? This action cannot be undone.')) {
            fetch(`/admin/team-management/${memberId}`, {
                method: 'DELETE',
                headers: {
                  'Content-Type': 'application/json',
                }
              })
              .then(response => response.json())
              .then(data => {
                if (data.success) {
                  showNotification(data.message, 'success');
                  setTimeout(() => location.reload(), 1000);
                } else {
                  showNotification(data.message, 'error');
                }
              })
              .catch(error => {
                console.error('Error:', error);
                showNotification('Failed to delete member', 'error');
              });
          }
        }

        // Export members data
        function exportTeamMembers() {
          try {
            const currentUrl = new URL(window.location.href);
            const exportUrl = new URL('/admin/team-management/export', window.location.origin);
            
            // Copy search parameters
            currentUrl.searchParams.forEach((value, key) => {
              exportUrl.searchParams.set(key, value);
            });
            
            // Ensure CSV format
            exportUrl.searchParams.set('format', 'csv');

            // Show loading state
            const exportBtn = document.querySelector('.btn-export');
            if (exportBtn) {
              const originalText = exportBtn.innerHTML;
              exportBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Exporting...';
              exportBtn.disabled = true;

              // Reset button after a delay
              setTimeout(() => {
                exportBtn.innerHTML = originalText;
                exportBtn.disabled = false;
              }, 3000);
            }

            // Create a temporary link to trigger download
            const link = document.createElement('a');
            link.href = exportUrl.toString();
            link.download = `team-members-report-${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
          } catch (error) {
            console.error('Error exporting team members:', error);
            // Reset button on error
            const exportBtn = document.querySelector('.btn-export');
            if (exportBtn) {
              exportBtn.innerHTML = '<i class="fas fa-file-excel"></i> Export Excel Report';
              exportBtn.disabled = false;
            }
          }
        }

        // Show notification
        function showNotification(message, type) {
          const notification = document.createElement('div');
          notification.className = `notification ${type === 'success' ? 'success-message' : 'error-message'}`;
          notification.textContent = message;

          document.body.appendChild(notification);

          setTimeout(() => {
            notification.classList.add('show');
          }, 100);

          setTimeout(() => {
            notification.classList.remove('show');
            setTimeout(() => notification.remove(), 300);
          }, 3000);
        }

        // Close modal on escape key using Bootstrap instance
        document.addEventListener('keydown', function(e) {
          if (e.key === 'Escape') {
            if (window.memberModalInstance && typeof window.memberModalInstance.hide === 'function') {
              window.memberModalInstance.hide();
            } else {
              hideMemberModal();
            }
          }
        });

        // Drag and drop functionality
        let draggedElement = null;
        let draggedIndex = null;

        document.addEventListener('DOMContentLoaded', function() {
          const grid = document.getElementById('teamMembersGrid');

          if (grid) {
            const draggableCards = grid.querySelectorAll('.draggable');
            
            draggableCards.forEach((card, index) => {
              // Make cards draggable
              card.setAttribute('draggable', 'true');
              
              card.addEventListener('dragstart', function(e) {
                draggedElement = card;
                draggedIndex = index;
                card.classList.add('dragging');
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('text/html', card.innerHTML);
              });

              card.addEventListener('dragend', function(e) {
                card.classList.remove('dragging');
                // Remove all drag-over classes
                grid.querySelectorAll('.drag-over').forEach(el => {
                  el.classList.remove('drag-over');
                });
              });

              card.addEventListener('dragover', function(e) {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
                
                if (draggedElement !== card) {
                  card.classList.add('drag-over');
                }
              });

              card.addEventListener('dragleave', function(e) {
                card.classList.remove('drag-over');
              });

              card.addEventListener('drop', function(e) {
                e.preventDefault();
                e.stopPropagation();
                
                card.classList.remove('drag-over');
                
                if (draggedElement !== card) {
                  // Get all cards
                  const allCards = Array.from(grid.querySelectorAll('.draggable'));
                  const draggedIdx = allCards.indexOf(draggedElement);
                  const targetIdx = allCards.indexOf(card);
                  
                  // Reorder in DOM
                  if (draggedIdx < targetIdx) {
                    card.parentNode.insertBefore(draggedElement, card.nextSibling);
                  } else {
                    card.parentNode.insertBefore(draggedElement, card);
                  }
                  
                  // Save new order to backend
                  saveTeamMembersOrder();
                }
              });
            });
          }
        });

        // Save team members order to backend
        async function saveTeamMembersOrder() {
          try {
            const grid = document.getElementById('teamMembersGrid');
            const cards = grid.querySelectorAll('.draggable');
            
            const membersOrder = Array.from(cards).map((card, index) => ({
              id: card.getAttribute('data-id'),
              order: index
            }));

            const response = await fetch('/admin/team-management/reorder', {
              method: 'PUT',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({ members: membersOrder })
            });

            const result = await response.json();

            if (result.success) {
              showNotification('Team members reordered successfully!', 'success');
            } else {
              showNotification('Failed to save order. Please refresh the page.', 'error');
            }
          } catch (error) {
            console.error('Error saving team members order:', error);
            showNotification('Failed to save order. Please try again.', 'error');
          }
        }
      </script>

    </div> <!-- admin-content -->
  </main> <!-- admin-main -->
</div> <!-- admin-layout -->

<%- include('partials/admin-footer') %>
