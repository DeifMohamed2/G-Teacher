<%- include('./partials/admin-header', { pageCSS: 'quizzes' }) %>

<!-- MathLive for professional math input -->
<script src="https://unpkg.com/mathlive"></script>

<style>
/* Styles are now in quizzes.css - keeping only edit-quiz specific styles here */

/* Notification Styles */
.notification {
  position: fixed;
  top: 20px;
  right: 20px;
  border-radius: 8px;
  box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
  padding: 16px;
  z-index: 9999;
  min-width: 300px;
  animation: slideIn 0.3s ease;
  border: 1px solid rgba(0, 0, 0, 0.1);
}

.notification-success {
  background: #f0fdf4;
  border-left: 4px solid #10b981;
  color: #065f46;
}

.notification-error {
  background: #fef2f2;
  border-left: 4px solid #ef4444;
  color: #991b1b;
}

.notification-info {
  background: #eff6ff;
  border-left: 4px solid #3b82f6;
  color: #1e40af;
}

.notification-warning {
  background: #fffbeb;
  border-left: 4px solid #f59e0b;
  color: #92400e;
}

.notification-content {
  color: black !important;
  display: flex;
  align-items: flex-start;
  gap: 12px;
}

.notification-message {
  flex: 1;
  line-height: 1.5;
}

.notification-content i {
  font-size: 18px;
}

.notification-success .notification-content i {
  color: #10b981;
}

.notification-error .notification-content i {
  color: #ef4444;
}

.notification-info .notification-content i {
  color: #3b82f6;
}

.notification-warning .notification-content i {
  color: #f59e0b;
}

.notification-content span {
  font-weight: 500;
  font-size: 14px;
}

.notification-close {
  position: absolute;
  top: 8px;
  right: 8px;
  background: none;
  border: none;
  cursor: pointer;
  color: #6b7280;
  font-size: 14px;
  padding: 4px;
}

@keyframes slideIn {
  from {
    transform: translateX(100%);
    opacity: 0;
  }
  to {
    transform: translateX(0);
    opacity: 1;
  }
}

/* Loading State */
.btn:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}

.fa-spinner {
  animation: spin 1s linear infinite;
}

@keyframes spin {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}

/* Enhanced Quiz Status Styles - Horizontal Layout */
.quiz-header-content {
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 2rem;
  flex-wrap: wrap;
}

.quiz-title-section {
  flex: 1;
  min-width: 300px;
}

.quiz-status-section {
  flex-shrink: 0;
}

.enhanced-quiz-status-card {
  background: #ffffff;
  border: 2px solid #e2e8f0;
  border-radius: 12px;
  padding: 20px;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
  min-width: 500px;
  max-width: 600px;
  position: relative;
  z-index: 1;
  transition: all 0.3s ease;
}

.enhanced-quiz-status-card:hover {
  box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
  transform: translateY(-2px);
}

.enhanced-status-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 16px;
  padding-bottom: 12px;
  border-bottom: 2px solid #f1f5f9;
}

.enhanced-status-title {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 16px;
  font-weight: 700;
  color: #1e293b;
}

.enhanced-status-title i {
  color: var(--admin-primary);
  font-size: 18px;
}

.enhanced-status-indicator {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 8px 16px;
  border-radius: 20px;
  font-size: 12px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.enhanced-status-indicator.status-draft {
  background: linear-gradient(135deg, #fef3c7, #fde68a);
  color: #92400e;
  border: 1px solid #f59e0b;
}

.enhanced-status-indicator.status-active {
  background: linear-gradient(135deg, #d1fae5, #a7f3d0);
  color: #065f46;
  border: 1px solid #10b981;
}

.enhanced-status-indicator.status-inactive {
  background: linear-gradient(135deg, #fee2e2, #fecaca);
  color: #991b1b;
  border: 1px solid #ef4444;
}

.enhanced-status-indicator.status-archived {
  background: linear-gradient(135deg, #f3f4f6, #e5e7eb);
  color: #374151;
  border: 1px solid #9ca3af;
}

.enhanced-status-indicator i {
  font-size: 8px;
}

.enhanced-status-options {
  display: flex;
  flex-direction: row;
  gap: 12px;
  justify-content: space-between;
}

.status-option {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 8px;
  padding: 16px 12px;
  border: 2px solid #e2e8f0;
  border-radius: 12px;
  cursor: pointer;
  transition: all 0.3s ease;
  background: #ffffff;
  position: relative;
  overflow: hidden;
  flex: 1;
  min-width: 100px;
  text-align: center;
}

.status-option::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: linear-gradient(135deg, var(--admin-primary), #dc2626);
  opacity: 0;
  transition: opacity 0.3s ease;
}

.status-option:hover {
  border-color: var(--admin-primary);
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(184, 1, 1, 0.15);
}

.status-option.active {
  border-color: var(--admin-primary);
  background: rgba(184, 1, 1, 0.05);
  box-shadow: 0 4px 15px rgba(184, 1, 1, 0.1);
}

.status-option.active::before {
  opacity: 0.1;
}

.status-option-icon {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 14px;
  color: #64748b;
  background: #f8fafc;
  border: 2px solid #e2e8f0;
  transition: all 0.3s ease;
  flex-shrink: 0;
  position: relative;
  z-index: 2;
}

.status-option:hover .status-option-icon {
  background: var(--admin-primary);
  color: #ffffff;
  border-color: var(--admin-primary);
}

.status-option.active .status-option-icon {
  background: var(--admin-primary);
  color: #ffffff;
  border-color: var(--admin-primary);
}

.status-option-content {
  position: relative;
  z-index: 2;
  width: 100%;
}

.status-option-title {
  font-size: 13px;
  font-weight: 700;
  color: #1e293b;
  margin-bottom: 4px;
  line-height: 1.2;
}

.status-option-description {
  font-size: 11px;
  color: #64748b;
  line-height: 1.3;
}

.status-option.active .status-option-title {
  color: var(--admin-primary);
}

/* Full Width Layout Styles */
.quiz-creation-content-full-width {
  width: 100%;
  max-width: none;
  margin: 0;
  padding: 0;
}

.quiz-form-section-full-width {
  width: 100%;
  max-width: none;
  margin: 0;
  padding: 0 24px;
}

.question-bank-selection-full-width {
  width: 100%;
  max-width: none;
  margin: 0;
}

/* Form Validation Styles */
.quiz-form-control.is-invalid {
  border-color: #ef4444;
  box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1);
}

.quiz-form-control.is-invalid:focus {
  border-color: #ef4444;
  box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.2);
}

.quiz-form-select.is-invalid {
  border-color: #ef4444;
  box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1);
}

.quiz-form-select.is-invalid:focus {
  border-color: #ef4444;
  box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.2);
}

/* Responsive adjustments */
@media (max-width: 1024px) {
  .enhanced-quiz-status-card {
    min-width: 450px;
    max-width: 500px;
  }
  
  .status-option {
    padding: 12px 8px;
    min-width: 80px;
  }
  
  .status-option-icon {
    width: 32px;
    height: 32px;
    font-size: 12px;
  }
  
  .status-option-title {
    font-size: 12px;
  }
  
  .status-option-description {
    font-size: 10px;
  }
}

@media (max-width: 768px) {
  .quiz-header-content {
    flex-direction: column;
    gap: 1.5rem;
    align-items: stretch;
  }
  
  .quiz-title-section {
    min-width: auto;
  }
  
  .quiz-status-section {
    align-self: stretch;
  }
  
  .enhanced-quiz-status-card {
    min-width: auto;
    width: 100%;
    max-width: none;
  }
  
  .enhanced-status-options {
    gap: 8px;
  }
  
  .status-option {
    padding: 12px 8px;
    min-width: 70px;
  }
  
  .status-option-icon {
    width: 30px;
    height: 30px;
    font-size: 12px;
  }
  
  .status-option-title {
    font-size: 11px;
  }
  
  .status-option-description {
    font-size: 9px;
  }
}

@media (max-width: 576px) {
  .enhanced-quiz-status-card {
    padding: 16px;
  }
  
  .enhanced-status-header {
    flex-direction: column;
    gap: 12px;
    align-items: flex-start;
  }
  
  .enhanced-status-indicator {
    align-self: flex-start;
  }
  
  .enhanced-status-options {
    flex-direction: column;
    gap: 8px;
  }
  
  .status-option {
    flex-direction: row;
    text-align: left;
    padding: 12px;
    min-width: auto;
  }
  
  .status-option-icon {
    width: 32px;
    height: 32px;
    font-size: 14px;
  }
  
  .status-option-title {
    font-size: 13px;
  }
  
  .status-option-description {
    font-size: 11px;
  }
}
</style>

<!-- Admin Layout -->
<div class="admin-layout">
  
  <!-- Sidebar -->
  <%- include('./partials/admin-sidebar', { currentPage: currentPage }) %>
  
  <!-- Main Content -->
  <main class="admin-main">
    
    <!-- Top Bar -->
    <%- include('./partials/admin-topbar', { 
        breadcrumb: 'Edit Quiz',
        breadcrumbSubtitle: 'Modify quiz settings and question selection'
    }) %>
    
    <!-- Content -->
    <div class="admin-content">
  <!-- Quiz Edit Header -->
  <div class="quiz-creation-header">
    <div class="quiz-header-content">
      <div class="quiz-title-section">
        <h1 class="quiz-creation-title">
          <i class="fas fa-edit"></i>
          Edit Quiz
        </h1>
        <p class="quiz-creation-subtitle">
          Modify quiz settings and question selection
        </p>
      </div>
      <div class="quiz-status-section">
        <div class="enhanced-quiz-status-card">
          <div class="enhanced-status-header">
            <div class="enhanced-status-title">
              <i class="fas fa-toggle-on"></i>
              Quiz Status
            </div>
            <div class="enhanced-status-indicator status-<%= quiz.status %>">
              <i class="fas fa-circle"></i>
              <span><%= quiz.status.charAt(0).toUpperCase() + quiz.status.slice(1) %></span>
            </div>
          </div>
          <div class="enhanced-status-options">
            <div class="status-option <%= quiz.status === 'draft' ? 'active' : '' %>" data-status="draft">
              <div class="status-option-icon">
                <i class="fas fa-edit"></i>
              </div>
              <div class="status-option-content">
                <div class="status-option-title">Draft</div>
                <div class="status-option-description">Work in progress</div>
              </div>
            </div>
            <div class="status-option <%= quiz.status === 'active' ? 'active' : '' %>" data-status="active">
              <div class="status-option-icon">
                <i class="fas fa-play"></i>
              </div>
              <div class="status-option-content">
                <div class="status-option-title">Active</div>
                <div class="status-option-description">Available to students</div>
              </div>
            </div>
            <div class="status-option <%= quiz.status === 'inactive' ? 'active' : '' %>" data-status="inactive">
              <div class="status-option-icon">
                <i class="fas fa-pause"></i>
              </div>
              <div class="status-option-content">
                <div class="status-option-title">Inactive</div>
                <div class="status-option-description">Temporarily disabled</div>
              </div>
            </div>
            <div class="status-option <%= quiz.status === 'archived' ? 'active' : '' %>" data-status="archived">
              <div class="status-option-icon">
                <i class="fas fa-archive"></i>
              </div>
              <div class="status-option-content">
                <div class="status-option-title">Archived</div>
                <div class="status-option-description">No longer in use</div>
              </div>
            </div>
          </div>
          <input type="hidden" id="quizStatusSelect" value="<%= quiz.status %>">
        </div>
      </div>
    </div>
  </div>
  <!-- Question Bank and Selection Section (Full Width Below) -->
  <div class="quiz-creation-content-full-width" style="margin-top: 2rem;">
    <!-- Question Bank Selection -->
    <div class="quiz-form-section-full-width">
      <div class="question-bank-selection-full-width">
        <div class="quiz-form-group">
          <label class="quiz-form-label">
            <i class="fas fa-database"></i>
            Question Banks * <span id="selectedBanksCount" class="text-muted">(0 selected)</span>
          </label>

          <% if (questionBanks && questionBanks.length > 0) { %>
          <!-- Multi-Select Bank Cards Grid -->
          <div class="bank-cards-grid" id="bankCardsGrid">
            <% questionBanks.forEach(bank => { %>
            <% 
              const isSelected = selectedBankIds && selectedBankIds.includes(bank._id.toString());
            %>
            <div class="bank-card-enhanced <%= isSelected ? 'selected' : '' %>" 
                 data-bank-id="<%= bank._id %>" 
                 data-questions="<%= bank.totalQuestions || 0 %>" 
                 data-title="<%= bank.name %>" 
                 data-code="<%= bank.bankCode %>" 
                 data-description="<%= bank.description || '' %>" 
                 onclick="toggleBankSelection('<%= bank._id %>')">
              <div class="bank-card-enhanced-content">
                <div class="bank-card-enhanced-header">
                  <div class="bank-card-enhanced-icon">
                    <i class="fas fa-database"></i>
                  </div>
                  <div class="bank-card-enhanced-title-section">
                    <h5 class="bank-card-enhanced-title"><%= bank.name %></h5>
                    <span class="bank-card-enhanced-code"><%= bank.bankCode %></span>
                  </div>
                </div>
                <p class="bank-card-enhanced-description"><%= bank.description || 'No description available' %></p>
                <div class="bank-card-enhanced-footer">
                  <div class="bank-card-enhanced-questions">
                    <i class="fas fa-question-circle"></i>
                    <span><%= bank.totalQuestions || 0 %> questions</span>
                  </div>
                  <div class="bank-card-enhanced-select-indicator">
                    <i class="fas fa-check-circle"></i>
                    <span>Select</span>
                  </div>
                </div>
              </div>
              <input type="checkbox" id="bank_<%= bank._id %>" value="<%= bank._id %>" <%= isSelected ? 'checked' : '' %> style="display: none;">
            </div>
            <% }) %>
          </div>

          <!-- Hidden input to store selected banks -->
          <input type="hidden" id="questionBank" name="questionBank" value="">
          <input type="hidden" id="questionBanks" name="questionBanks" value="">

          <% } else { %>
          <div class="alert alert-warning">
            <i class="fas fa-exclamation-triangle"></i>
            No question banks available - Please create a question bank first
          </div>
          <% } %>
        </div>

        <!-- Question Selection Container -->
        <div id="questionSelectionContainer" class="question-selection-container" style="margin-top: 2rem;">
          <!-- Bank Filter Section -->
          <div class="question-bank-filter-section">
            <div class="filter-section-header">
              <i class="fas fa-database"></i>
              <span>Filter by Question Bank</span>
            </div>
            <div class="bank-filter-buttons" id="bankFilterButtons">
              <button type="button" class="bank-filter-btn active" data-bank-id="all" onclick="filterByBank('all')">
                <i class="fas fa-th"></i>
                All Banks
              </button>
              <!-- Bank filter buttons will be dynamically added here -->
            </div>
          </div>

          <!-- Question Filters Section -->
          <div class="question-filters-section">
            <div class="filters-row">
              <div class="filter-item">
                <label class="filter-label">
                  <i class="fas fa-signal"></i>
                  Difficulty
                </label>
                <select class="filter-select" id="difficultyFilter" onchange="filterQuestions()">
                  <option value="">All Difficulties</option>
                  <option value="easy">Easy</option>
                  <option value="medium">Medium</option>
                  <option value="hard">Hard</option>
                </select>
              </div>

              <div class="filter-item">
                <label class="filter-label">
                  <i class="fas fa-tag"></i>
                  Type
                </label>
                <select class="filter-select" id="typeFilter" onchange="filterQuestions()">
                  <option value="">All Types</option>
                  <option value="MCQ">Multiple Choice</option>
                  <option value="True/False">True/False</option>
                  <option value="Written">Written</option>
                </select>
              </div>

              <div class="filter-item">
                <label class="filter-label">
                  <i class="fas fa-tags"></i>
                  Tags
                </label>
                <select class="filter-select" id="tagsFilter" onchange="filterQuestions()">
                  <option value="">All Tags</option>
                  <!-- Tags will be populated dynamically -->
                </select>
              </div>

              <div class="filter-item filter-search">
                <label class="filter-label">
                  <i class="fas fa-search"></i>
                  Search
                </label>
                <input type="text" class="filter-search-input" id="searchFilter" placeholder="Search questions..." onkeyup="filterQuestions()">
              </div>
            </div>
          </div>

          <!-- Quick Selection Tools -->
          <div class="quick-selection-tools">
            <div class="selection-tools-left">
              <input type="text" class="range-input" id="rangeInput" placeholder="Range: 1-5, 8, 10-12">
              <button type="button" class="tool-btn" onclick="selectRange()">
                <i class="fas fa-list-ol"></i>
                Select Range
              </button>
            </div>
            <div class="selection-tools-right">
              <button type="button" class="tool-btn" onclick="selectAllQuestions()">
                <i class="fas fa-check-double"></i>
                Select All
              </button>
              <button type="button" class="tool-btn" onclick="clearSelection()">
                <i class="fas fa-times"></i>
                Clear
              </button>
              <button type="button" class="tool-btn" onclick="selectEvenQuestions()">
                <i class="fas fa-sort-numeric-down"></i>
                Even
              </button>
              <button type="button" class="tool-btn" onclick="selectOddQuestions()">
                <i class="fas fa-sort-numeric-up"></i>
                Odd
              </button>
              <button type="button" class="tool-btn" onclick="selectRandomQuestions()">
                <i class="fas fa-random"></i>
                Random 30%
              </button>
            </div>
          </div>

          <!-- Questions List Container -->
          <div class="questions-list-container">
            <div class="questions-list" id="questionsList">
              <!-- Questions will be loaded here -->
            </div>
            <div id="noQuestionsMessage" class="no-questions-message">
              <i class="fas fa-question-circle"></i>
              <p>No Questions Loaded</p>
              <small>Please select question banks to load questions.</small>
            </div>
          </div>

          <!-- Selection Summary -->
          <div class="selection-summary" id="selectionSummary">
            <div class="summary-item">
              <span class="summary-label">Selected Questions:</span>
              <span class="summary-value" id="selectedCount">0</span>
            </div>
            <div class="summary-item">
              <span class="summary-label">Total Points:</span>
              <span class="summary-value" id="totalPoints">0</span>
            </div>
            <div class="summary-item">
              <span class="summary-label">Difficulty Distribution:</span>
              <div class="difficulty-distribution" id="difficultyDistribution">
                <div class="difficulty-item">
                  <span class="badge bg-success">Easy: <span id="easyCount">0</span></span>
                </div>
                <div class="difficulty-item">
                  <span class="badge bg-warning">Medium: <span id="mediumCount">0</span></span>
                </div>
                <div class="difficulty-item">
                  <span class="badge bg-danger">Hard: <span id="hardCount">0</span></span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
  <!-- Quiz Edit Content -->
  <div class="quiz-creation-content-full-width">
    <!-- Main Form Section -->
    <div class="quiz-form-section-full-width">
      <form id="quizEditForm">
        
        <!-- Basic Information -->
        <div class="quiz-form-section-title">
          <i class="fas fa-info-circle"></i>
          Basic Information
        </div>

        <div class="row">
          <div class="col-md-8">
            <div class="quiz-form-group">
              <label for="title" class="quiz-form-label">
                <i class="fas fa-heading"></i>
                Quiz Title *
              </label>
              <input type="text" id="title" name="title" class="quiz-form-control" 
                     value="<%= quiz.title %>" required maxlength="200">
            </div>
          </div>
          <div class="col-md-4">
            <div class="quiz-form-group">
              <label for="code" class="quiz-form-label">
                <i class="fas fa-code"></i>
                Quiz Code *
              </label>
              <input type="text" id="code" name="code" class="quiz-form-control" 
                     value="<%= quiz.code %>" required maxlength="20" 
                     pattern="[A-Z0-9-]+" title="Uppercase letters, numbers, and hyphens only">
            </div>
          </div>
        </div>

        <div class="quiz-form-group">
          <label for="description" class="quiz-form-label">
            <i class="fas fa-align-left"></i>
            Description (Optional)
          </label>
          <textarea id="description" name="description" class="quiz-form-control quiz-form-textarea" 
                    maxlength="1000"><%= quiz.description %></textarea>
        </div>

        <!-- Quiz Settings -->
        <div class="quiz-form-section-title">
          <i class="fas fa-cog"></i>
          Quiz Settings
        </div>

        <div class="row">
          <div class="col-md-4">
            <div class="quiz-form-group">
              <label for="duration" class="quiz-form-label">
                <i class="fas fa-clock"></i>
                Duration (minutes) * <small class="text-muted">(0 = no time limit)</small>
              </label>
              <input type="number" id="duration" name="duration" class="quiz-form-control" 
                     value="<%= quiz.duration %>" required min="0" max="480" 
                     title="Enter 0 for no time limit">
            </div>
          </div>
          <div class="col-md-4">
            <div class="quiz-form-group">
              <label for="difficulty" class="quiz-form-label">
                <i class="fas fa-signal"></i>
                Difficulty Level *
              </label>
              <select id="difficulty" name="difficulty" class="quiz-form-control quiz-form-select" required>
                <option value="">Select Difficulty</option>
                <option value="easy" <%= quiz.difficulty === 'easy' ? 'selected' : '' %>>Easy</option>
                <option value="medium" <%= quiz.difficulty === 'medium' ? 'selected' : '' %>>Medium</option>
                <option value="hard" <%= quiz.difficulty === 'hard' ? 'selected' : '' %>>Hard</option>
              </select>
            </div>
          </div>
          <div class="col-md-4">
            <div class="quiz-form-group">
              <label for="passingScore" class="quiz-form-label">
                <i class="fas fa-percentage"></i>
                Passing Score (%)
              </label>
              <input type="number" id="passingScore" name="passingScore" class="quiz-form-control" 
                     value="<%= quiz.passingScore %>" min="0" max="100">
            </div>
          </div>
        </div>

        <div class="row">
          <div class="col-md-6">
            <div class="quiz-form-group">
              <label for="maxAttempts" class="quiz-form-label">
                <i class="fas fa-redo"></i>
                Max Attempts
              </label>
              <input type="number" id="maxAttempts" name="maxAttempts" class="quiz-form-control" 
                     value="<%= quiz.maxAttempts %>" min="1" max="10">
            </div>
          </div>
          <div class="col-md-6">
            <div class="quiz-form-group">
              <label for="tags" class="quiz-form-label">
                <i class="fas fa-tags"></i>
                Tags (comma-separated)
              </label>
              <input type="text" id="tags" name="tags" class="quiz-form-control" 
                     value="<%= quiz.tags ? quiz.tags.join(', ') : '' %>">
            </div>
          </div>
        </div>

        <!-- Quiz Instructions -->
        <div class="quiz-form-group">
          <label for="instructions" class="quiz-form-label">
            <i class="fas fa-list-ol"></i>
            Instructions
          </label>
          <textarea id="instructions" name="instructions" class="quiz-form-control quiz-form-textarea" 
                    maxlength="2000"><%= quiz.instructions || '' %></textarea>
        </div>

        <!-- Quiz Options -->
        <div class="quiz-form-section-title">
          <i class="fas fa-sliders-h"></i>
          Quiz Options
        </div>

        <div class="row">
          <div class="col-md-6">
            <div class="quiz-form-check">
              <input type="checkbox" id="shuffleQuestions" name="shuffleQuestions" class="quiz-form-check-input" 
                     <%= quiz.shuffleQuestions ? 'checked' : '' %>>
              <label for="shuffleQuestions" class="quiz-form-check-label">
                Shuffle Questions
              </label>
            </div>
            <div class="quiz-form-check">
              <input type="checkbox" id="shuffleOptions" name="shuffleOptions" class="quiz-form-check-input" 
                     <%= quiz.shuffleOptions ? 'checked' : '' %>>
              <label for="shuffleOptions" class="quiz-form-check-label">
                Shuffle Answer Options
              </label>
            </div>
          </div>
          <div class="col-md-6">
            <div class="quiz-form-check">
              <input type="checkbox" id="showCorrectAnswers" name="showCorrectAnswers" class="quiz-form-check-input" 
                     <%= quiz.showCorrectAnswers ? 'checked' : '' %>>
              <label for="showCorrectAnswers" class="quiz-form-check-label">
                Show Correct Answers
              </label>
            </div>
            <div class="quiz-form-check">
              <input type="checkbox" id="showResults" name="showResults" class="quiz-form-check-input" 
                     <%= quiz.showResults ? 'checked' : '' %>>
              <label for="showResults" class="quiz-form-check-label">
                Show Results Immediately
              </label>
            </div>
          </div>
        </div>

        <!-- Submit Button -->
        <div class="quiz-form-group text-end">
          <a href="/admin/quizzes" class="btn btn-secondary btn-lg me-3">
            <i class="fas fa-arrow-left"></i>
            Cancel
          </a>
          <button type="submit" class="btn btn-primary btn-lg" id="updateQuizBtn">
            <i class="fas fa-save"></i>
            Update Quiz
          </button>
        </div>
      </form>
    </div>
  </div>



<!-- Enhanced Question Preview Modal -->
<div class="modal fade question-preview-modal" id="questionPreviewModal" tabindex="-1" aria-labelledby="questionPreviewModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content admin-modal-content">
      <div class="modal-header admin-modal-header">
        <h5 class="modal-title" id="questionPreviewModalLabel">
          <i class="fas fa-eye"></i>
          Question Preview
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body admin-modal-body">
        <div id="questionPreviewContent" class="enhanced-question-preview-content">
          <!-- Enhanced question preview will be loaded here -->
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// Fix the JSON parsing issues by properly escaping the data
let selectedBankIds = <%- JSON.stringify(selectedBankIds || []) %>;
let selectedQuestions = <%- JSON.stringify(quiz.selectedQuestions || []) %>;
let allQuestions = [];
let bankInfoMap = {};
let quizId = '<%= quiz._id %>';
window.currentBankFilter = 'all';

// Ensure selectedBankIds is always an array
if (!Array.isArray(selectedBankIds)) {
  selectedBankIds = [];
}

// Ensure selectedQuestions is always an array
if (!Array.isArray(selectedQuestions)) {
  selectedQuestions = [];
}

// Normalize selectedQuestions data structure
// Handle case where questions might be populated objects instead of just IDs
selectedQuestions = selectedQuestions.map(sq => {
  if (sq.question && typeof sq.question === 'object' && sq.question._id) {
    // If question is a populated object, extract just the ID
    return {
      question: sq.question._id.toString(),
      sourceBank: sq.sourceBank?.toString() || sq.sourceBank,
      order: sq.order || 1,
      points: sq.points || 1
    };
  }
  // If question is already just an ID, ensure it's a string
  return {
    question: sq.question?.toString() || sq.question,
    sourceBank: sq.sourceBank?.toString() || sq.sourceBank,
    order: sq.order || 1,
    points: sq.points || 1
  };
});

// Toggle Bank Selection
function toggleBankSelection(bankId) {
  const bankCard = document.querySelector(`[data-bank-id="${bankId}"]`);
  const checkbox = bankCard.querySelector('input[type="checkbox"]');
  const isCurrentlySelected = selectedBankIds.includes(bankId);

  if (isCurrentlySelected) {
    // Remove bank from selection
    const index = selectedBankIds.indexOf(bankId);
    if (index > -1) {
      selectedBankIds.splice(index, 1);
      bankCard.classList.remove('selected');
      checkbox.checked = false;

      // Remove questions from this bank
      selectedQuestions = selectedQuestions.filter(sq => sq.sourceBank !== bankId);
      allQuestions = allQuestions.filter(q => q.sourceBank !== bankId);
    }
  } else {
    // Add bank to selection
    selectedBankIds.push(bankId);
    bankCard.classList.add('selected');
    checkbox.checked = true;
  }

  updateBanksCount();
  updateHiddenInputs();

  // Reload questions if banks changed
  if (selectedBankIds.length > 0) {
    loadQuestions();
  } else {
    document.getElementById('questionsList').innerHTML = '';
    document.getElementById('noQuestionsMessage').style.display = 'flex';
  }
}

function updateBanksCount() {
  const count = selectedBankIds.length;
  const countElement = document.getElementById('selectedBanksCount');
  if (countElement) countElement.textContent = `(${count} selected)`;
}

function updateHiddenInputs() {
  const questionBankInput = document.getElementById('questionBank');
  const questionBanksInput = document.getElementById('questionBanks');
  if (questionBankInput) questionBankInput.value = selectedBankIds[0] || '';
  if (questionBanksInput) questionBanksInput.value = JSON.stringify(selectedBankIds);
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
  // Initialize bank selection state
  updateBanksCount();
  updateHiddenInputs();

  // Load questions if banks are already selected
  if (selectedBankIds.length > 0) {
    loadQuestions();
  }
  
  // Ensure selection state is correct after page loads
  setTimeout(() => {
    restoreQuestionSelection();
    updateSelectionSummary();
  }, 500);
  
  // Add event listeners for status options
  document.querySelectorAll('.status-option').forEach(option => {
    option.addEventListener('click', function() {
      const newStatus = this.dataset.status;
      selectStatusOption(newStatus);
    });
  });
});

// Load Questions from Multiple Banks
async function loadQuestions() {
  if (selectedBankIds.length === 0) {
    showNotification('No banks selected', 'error');
    return;
  }

  try {
    const response = await fetch('/admin/quizzes/api/banks/multiple/questions', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        bankIds: selectedBankIds
      })
    });

    const result = await response.json();

    if (result.success && result.questions) {
      // result.questions is grouped by bank: { bankId: [...questions] }
      allQuestions = [];
      bankInfoMap = {};

      // Flatten and add sourceBank to each question
      Object.entries(result.questions).forEach(([bankId, questions]) => {
        if (Array.isArray(questions)) {
          const bankCard = document.querySelector(`[data-bank-id="${bankId}"]`);
          const bankName = bankCard ? bankCard.dataset.title : 'Unknown Bank';
          const bankCode = bankCard ? bankCard.dataset.code : '';

          bankInfoMap[bankId] = {
            name: bankName,
            code: bankCode
          };

          questions.forEach(q => {
            allQuestions.push({
              ...q,
              sourceBank: bankId
            });
          });
        }
      });

      displayQuestions(result.questions);
      showNotification(`Loaded ${allQuestions.length} questions from ${selectedBankIds.length} bank(s)`, 'success');
    } else {
      showNotification(result.message || 'Failed to load questions', 'error');
    }
  } catch (error) {
    console.error('Error loading questions:', error);
    showNotification('An error occurred while loading questions', 'error');
  }
}

// Display Questions - All together, no grouping (Like Create Quiz)
function displayQuestions(questionsByBank) {
  const questionsList = document.getElementById('questionsList');
  const noQuestionsMessage = document.getElementById('noQuestionsMessage');

  // Safety checks
  if (!questionsList || !noQuestionsMessage) return;

  if (!questionsByBank || typeof questionsByBank !== 'object' || Object.keys(questionsByBank).length === 0) {
    questionsList.innerHTML = '';
    noQuestionsMessage.style.display = 'flex';
    return;
  }

  noQuestionsMessage.style.display = 'none';

  // Reset all questions array
  allQuestions = [];

  // Flatten all questions and store bank info
  let questionHTML = '';
  let globalIndex = 0;

  Object.entries(questionsByBank).forEach(([bankId, questions]) => {
    const bankCard = document.querySelector(`[data-bank-id="${bankId}"]`);
    const bankName = bankCard ? bankCard.dataset.title : 'Unknown Bank';

    // Store bank info
    if (!bankInfoMap[bankId]) {
      bankInfoMap[bankId] = {
        name: bankName,
        code: bankCard ? bankCard.dataset.code : ''
      };
    }

    // Add questions to allQuestions array
    questions.forEach((question) => {
      allQuestions.push({
        ...question,
        sourceBank: bankId
      });

      const difficultyClass = question.difficulty || 'medium';
      const questionTags = question.tags || [];
      const tagsJson = JSON.stringify(questionTags);

      questionHTML += `
        <div class="question-item ${difficultyClass}" 
             onclick="toggleQuestionSelection(${globalIndex})" 
             data-question-index="${globalIndex}"
             data-bank-id="${bankId}"
             data-question-id="${question._id}"
             data-tags='${tagsJson}'>
          <div class="question-item-top">
            <div class="question-item-number">${globalIndex + 1}</div>
            <button type="button" class="question-preview-btn" onclick="event.stopPropagation(); previewQuestion('${question._id}')" title="Preview Question">
              <i class="fas fa-eye"></i>
            </button>
          </div>
          <div class="question-item-content">
            <div class="question-item-header">
              <div class="question-item-bank">
                <i class="fas fa-database"></i>
                <span>${bankName}</span>
              </div>
            </div>
            <div class="question-item-footer">
              <span class="question-badge type-badge">${question.questionType || 'MCQ'}</span>
            </div>
          </div>
          <div class="question-check-indicator">
            <i class="fas fa-check-circle"></i>
          </div>
        </div>
      `;
      globalIndex++;
    });
  });

  questionsList.innerHTML = questionHTML;

  // Update bank filter buttons
  updateBankFilterButtons();

  // Reset bank filter to 'all' when questions are loaded
  window.currentBankFilter = 'all';
  const allBanksBtn = document.querySelector('.bank-filter-btn[data-bank-id="all"]');
  if (allBanksBtn) {
    document.querySelectorAll('.bank-filter-btn').forEach(btn => btn.classList.remove('active'));
    allBanksBtn.classList.add('active');
  }

  // Restore visual state of selected questions
  restoreQuestionSelection();
  updateSelectionSummary();
  
  // Populate tags filter
  populateTagsFilter('tagsFilter', allQuestions);
}

// Update Bank Filter Buttons
function updateBankFilterButtons() {
  const bankFilterButtons = document.getElementById('bankFilterButtons');
  if (!bankFilterButtons) return;

  // Get the "All Banks" button HTML first
  const allBanksBtn = bankFilterButtons.querySelector('[data-bank-id="all"]');
  let buttonsHTML = '';
  
  if (allBanksBtn) {
    buttonsHTML = allBanksBtn.outerHTML;
  } else {
    buttonsHTML = `
      <button type="button" class="bank-filter-btn active" data-bank-id="all" onclick="filterByBank('all')">
        <i class="fas fa-th"></i>
        All Banks
      </button>
    `;
  }

  // Add individual bank buttons
  Object.entries(bankInfoMap).forEach(([bankId, bankInfo]) => {
    buttonsHTML += `
      <button type="button" class="bank-filter-btn" data-bank-id="${bankId}" onclick="filterByBank('${bankId}')">
        <i class="fas fa-database"></i>
        ${bankInfo.name}
      </button>
    `;
  });

  bankFilterButtons.innerHTML = buttonsHTML;
}

// Filter by Bank
function filterByBank(bankId) {
  // Update active button
  document.querySelectorAll('.bank-filter-btn').forEach(btn => {
    btn.classList.remove('active');
  });
  const activeBtn = document.querySelector(`.bank-filter-btn[data-bank-id="${bankId}"]`);
  if (activeBtn) {
    activeBtn.classList.add('active');
  }

  // Store current bank filter
  window.currentBankFilter = bankId;

  // Filter questions
  const questionItems = document.querySelectorAll('.question-item');
  questionItems.forEach(item => {
    if (bankId === 'all') {
      item.style.display = '';
    } else {
      const itemBankId = item.dataset.bankId;
      item.style.display = itemBankId === bankId ? '' : 'none';
    }
  });

  // Also apply other active filters
  filterQuestions();
}

// Restore Question Selection
function restoreQuestionSelection() {
  // Clear all selections first
  document.querySelectorAll('.question-item').forEach(item => {
    item.classList.remove('selected');
  });

  // Restore selections based on selectedQuestions array
  selectedQuestions.forEach(selection => {
    const questionIndex = allQuestions.findIndex(q => {
      const qId = q._id?.toString() || q._id;
      const sId = selection.question?.toString() || selection.question;
      return qId === sId;
    });
    if (questionIndex !== -1) {
      const questionElement = document.querySelector(`[data-question-index="${questionIndex}"]`);
      if (questionElement) {
        questionElement.classList.add('selected');
      }
    }
  });
}

// Toggle Question Selection
function toggleQuestionSelection(index) {
  const questionElement = document.querySelector(`[data-question-index="${index}"]`);
  const question = allQuestions[index];
  const questionId = question._id;
  const sourceBank = question.sourceBank;
  const existingIndex = selectedQuestions.findIndex(sq => {
    const qId = sq.question?.toString() || sq.question;
    const currentId = questionId?.toString() || questionId;
    return qId === currentId;
  });

  if (existingIndex > -1) {
    // Remove from selection
    selectedQuestions.splice(existingIndex, 1);
    questionElement.classList.remove('selected');
  } else {
    // Add to selection with sourceBank
    selectedQuestions.push({
      question: questionId,
      sourceBank: sourceBank,
      order: selectedQuestions.length + 1,
      points: question.points || 1
    });
    questionElement.classList.add('selected');
  }

  updateSelectionSummary();
}

// Select All Questions
function selectAllQuestions() {
  // Only select visible questions
  const visibleQuestions = Array.from(document.querySelectorAll('.question-item'))
    .filter(item => item.style.display !== 'none')
    .map(item => {
      const index = parseInt(item.dataset.questionIndex);
      return allQuestions[index];
    })
    .filter(q => q);

  selectedQuestions = visibleQuestions.map(question => ({
    question: question._id,
    sourceBank: question.sourceBank,
    order: selectedQuestions.length + 1,
    points: question.points || 1
  }));

  document.querySelectorAll('.question-item').forEach((item) => {
    if (item.style.display !== 'none') {
      item.classList.add('selected');
    }
  });

  updateSelectionSummary();
  showNotification(`Selected ${visibleQuestions.length} visible questions`, 'success');
}

// Clear Selection
function clearSelection() {
  selectedQuestions = [];
  document.querySelectorAll('.question-item').forEach(item => {
    item.classList.remove('selected');
  });
  updateSelectionSummary();
  showNotification('Cleared all selections', 'info');
}

// Range Selection
function selectRange() {
  const rangeInput = document.getElementById('rangeInput').value.trim();
  if (!rangeInput) {
    showNotification('Please enter a range (e.g., 1-5, 3, 7-10)', 'error');
    return;
  }

  clearSelection();

  const ranges = rangeInput.split(',');
  let selectedCount = 0;

  ranges.forEach(rangeStr => {
    const trimmed = rangeStr.trim();
    if (trimmed.includes('-')) {
      // Range (e.g., "1-5")
      const [start, end] = trimmed.split('-').map(n => parseInt(n.trim()) - 1);
      for (let i = start; i <= end && i < allQuestions.length; i++) {
        if (i >= 0) {
          const question = allQuestions[i];
          selectedQuestions.push({
            question: question._id,
            sourceBank: question.sourceBank,
            order: selectedQuestions.length + 1,
            points: question.points || 1
          });
          const questionElement = document.querySelector(`[data-question-index="${i}"]`);
          if (questionElement) questionElement.classList.add('selected');
          selectedCount++;
        }
      }
    } else {
      // Single number (e.g., "3")
      const index = parseInt(trimmed) - 1;
      if (index >= 0 && index < allQuestions.length) {
        const question = allQuestions[index];
        selectedQuestions.push({
          question: question._id,
          sourceBank: question.sourceBank,
          order: selectedQuestions.length + 1,
          points: question.points || 1
        });
        document.querySelector(`[data-question-index="${index}"]`).classList.add('selected');
        selectedCount++;
      }
    }
  });

  updateSelectionSummary();

  if (selectedCount > 0) {
    showNotification(`Selected ${selectedCount} questions from range`, 'success');
  } else {
    showNotification('No valid questions found in the specified range', 'warning');
  }

  // Clear the input
  document.getElementById('rangeInput').value = '';
}

// Select Even Questions
function selectEvenQuestions() {
  clearSelection();
  let selectedCount = 0;

  for (let i = 1; i < allQuestions.length; i += 2) {
    const question = allQuestions[i];
    selectedQuestions.push({
      question: question._id,
      sourceBank: question.sourceBank,
      order: selectedQuestions.length + 1,
      points: question.points || 1
    });
    document.querySelector(`[data-question-index="${i}"]`).classList.add('selected');
    selectedCount++;
  }

  updateSelectionSummary();
  showNotification(`Selected ${selectedCount} even-numbered questions`, 'success');
}

// Select Odd Questions
function selectOddQuestions() {
  clearSelection();
  let selectedCount = 0;

  for (let i = 0; i < allQuestions.length; i += 2) {
    const question = allQuestions[i];
    selectedQuestions.push({
      question: question._id,
      sourceBank: question.sourceBank,
      order: selectedQuestions.length + 1,
      points: question.points || 1
    });
    document.querySelector(`[data-question-index="${i}"]`).classList.add('selected');
    selectedCount++;
  }

  updateSelectionSummary();
  showNotification(`Selected ${selectedCount} odd-numbered questions`, 'success');
}

// Select Random Questions
function selectRandomQuestions() {
  clearSelection();
  const count = Math.ceil(allQuestions.length * 0.3);
  const randomIndices = [];

  while (randomIndices.length < count) {
    const randomIndex = Math.floor(Math.random() * allQuestions.length);
    if (!randomIndices.includes(randomIndex)) {
      randomIndices.push(randomIndex);
    }
  }

  randomIndices.forEach(index => {
    const question = allQuestions[index];
    selectedQuestions.push({
      question: question._id,
      sourceBank: question.sourceBank,
      order: selectedQuestions.length + 1,
      points: question.points || 1
    });
    document.querySelector(`[data-question-index="${index}"]`).classList.add('selected');
  });

  updateSelectionSummary();
  showNotification(`Randomly selected ${count} questions`, 'success');
}

// Filter Questions
function filterQuestions() {
  const difficultyFilter = document.getElementById('difficultyFilter').value;
  const typeFilter = document.getElementById('typeFilter').value;
  const tagsFilter = document.getElementById('tagsFilter').value;
  const searchFilter = document.getElementById('searchFilter').value.toLowerCase();
  const activeBankFilter = window.currentBankFilter || document.querySelector('.bank-filter-btn.active')?.dataset.bankId || 'all';

  // Filter question items
  const questionElements = document.querySelectorAll('.question-item');

  questionElements.forEach(element => {
    const questionIndex = parseInt(element.dataset.questionIndex);
    const question = allQuestions[questionIndex];

    if (!question) return;

    let show = true;

    // Check bank filter first
    if (activeBankFilter !== 'all' && element.dataset.bankId !== activeBankFilter) {
      show = false;
    }

    // Check difficulty filter
    if (show && difficultyFilter && question.difficulty && question.difficulty.toLowerCase() !== difficultyFilter.toLowerCase()) {
      show = false;
    }

    // Check type filter
    if (show && typeFilter && question.questionType !== typeFilter) {
      show = false;
    }

    // Check tags filter
    if (show && tagsFilter) {
      const questionTags = question.tags || [];
      const hasTag = questionTags.some(tag => 
        tag && tag.toString().toLowerCase() === tagsFilter.toLowerCase()
      );
      if (!hasTag) {
        show = false;
      }
    }

    // Check search filter
    if (show && searchFilter && question.questionText && !question.questionText.toLowerCase().includes(searchFilter)) {
      show = false;
    }

    // Show/hide the element
    element.style.display = show ? '' : 'none';
  });
}

// Update Selection Summary
function updateSelectionSummary() {
  const selectedCount = document.getElementById('selectedCount');
  const totalPoints = document.getElementById('totalPoints');
  const easyCount = document.getElementById('easyCount');
  const mediumCount = document.getElementById('mediumCount');
  const hardCount = document.getElementById('hardCount');

  if (selectedCount) selectedCount.textContent = selectedQuestions.length;

  let points = 0;
  let easy = 0, medium = 0, hard = 0;

  selectedQuestions.forEach(selection => {
    const question = allQuestions.find(q => {
      const qId = q._id?.toString() || q._id;
      const sId = selection.question?.toString() || selection.question;
      return qId === sId;
    });
    if (question) {
      points += question.points || 1;

      const difficulty = question.difficulty || 'medium';
      if (difficulty.toLowerCase() === 'easy') easy++;
      else if (difficulty.toLowerCase() === 'hard') hard++;
      else medium++;
    }
  });

  if (totalPoints) totalPoints.textContent = points;
  if (easyCount) easyCount.textContent = easy;
  if (mediumCount) mediumCount.textContent = medium;
  if (hardCount) hardCount.textContent = hard;
}

// Preview Question
async function previewQuestion(questionId) {
  try {
    const response = await fetch(`/admin/quizzes/api/questions/${questionId}/preview`);
    const data = await response.json();
    
    if (data.success) {
      displayQuestionPreview(data.question);
      const modal = new bootstrap.Modal(document.getElementById('questionPreviewModal'));
      modal.show();
    } else {
      showNotification('Failed to load question preview', 'error');
    }
  } catch (error) {
    showNotification('Error loading question preview', 'error');
  }
}

// Enhanced Display Question Preview with MathLive Support and Written Question Answers
function displayQuestionPreview(question) {
  const content = document.getElementById('questionPreviewContent');

  // Enhanced question header with better styling
  const questionHeader = `
    <div class="enhanced-question-preview-header">
      <div class="question-meta-badges">
        <div class="meta-badge difficulty-${question.difficulty.toLowerCase()}">
          <i class="fas fa-signal"></i>
          ${question.difficulty.charAt(0).toUpperCase() + question.difficulty.slice(1)}
        </div>
        <div class="meta-badge type-${question.questionType.toLowerCase().replace('/', '-')}">
          <i class="fas fa-tag"></i>
          ${question.questionType.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase())}
        </div>
        <div class="meta-badge points">
          <i class="fas fa-star"></i>
          ${question.points} points
        </div>
      </div>
    </div>
  `;

  // Enhanced question text with MathLive support
  let questionTextHtml = '';
  if (question.questionText && question.questionText.includes('\\')) {
    // If it contains LaTeX, render it with MathLive
    questionTextHtml = `
      <div class="enhanced-question-preview-text">
        <math-field readonly 
          style="width: 100%; min-height: 40px; font-size: 16px; border: none; background: transparent; padding: 8px;"
          class="preview-math-field">
          ${question.questionText}
        </math-field>
      </div>
    `;
  } else {
    questionTextHtml = `
      <div class="enhanced-question-preview-text">
        ${question.questionText}
      </div>
    `;
  }

  // Enhanced options/answers with MathLive support
  let answersHtml = '';

  if (question.questionType === 'Written') {
    // For written questions, show correct answers with mandatory/optional status
    const correctAnswers = question.correctAnswers || [];
    if (correctAnswers.length > 0) {
      const answersList = correctAnswers.map((answer, index) => {
        // Handle both old string format and new object format
        let answerText = '';
        let isMandatory = true;

        if (typeof answer === 'string') {
          answerText = answer;
        } else if (typeof answer === 'object' && answer.text) {
          answerText = answer.text;
          isMandatory = answer.isMandatory !== false; // Default to true if not specified
        }

        // Check if answer contains LaTeX
        let answerTextHtml = '';
        if (answerText && answerText.includes('\\')) {
          // Render math for answer text
          answerTextHtml = `
            <math-field readonly 
              style="width: 100%; min-height: 30px; font-size: 14px; border: none; background: transparent; padding: 4px;"
              class="preview-math-field answer-math-field">
              ${answerText}
            </math-field>
          `;
        } else {
          answerTextHtml = answerText;
        }

        const mandatoryClass = isMandatory ? 'mandatory' : 'optional';
        const mandatoryIcon = isMandatory ? 'fas fa-lock' : 'fas fa-unlock';
        const mandatoryText = isMandatory ? 'Mandatory' : 'Optional';

        return `
          <div class="enhanced-written-answer-item ${mandatoryClass}">
            <div class="written-answer-header">
              <div class="written-answer-number">${index + 1}</div>
              <div class="written-answer-mandatory ${mandatoryClass}">
                <i class="${mandatoryIcon}"></i>
                <span>${mandatoryText}</span>
              </div>
            </div>
            <div class="written-answer-content">${answerTextHtml}</div>
          </div>
        `;
      }).join('');

      answersHtml = `
        <div class="enhanced-question-preview-answers">
          <div class="answers-title">
            <i class="fas fa-edit"></i>
            Correct Answers
            <span class="answers-count">(${correctAnswers.length} answer${correctAnswers.length !== 1 ? 's' : ''})</span>
          </div>
          <div class="written-answers-list">
            ${answersList}
          </div>
        </div>
      `;
    } else {
      answersHtml = `
        <div class="enhanced-question-preview-answers">
          <div class="answers-title">
            <i class="fas fa-edit"></i>
            Correct Answers
          </div>
          <div class="no-answers-message">
            <i class="fas fa-exclamation-triangle"></i>
            <span>No correct answers defined for this written question.</span>
          </div>
        </div>
      `;
    }
  } else if (question.options && question.options.length > 0) {
    // For MCQ and True/False questions, show options
    answersHtml = `
      <div class="enhanced-question-preview-options">
        <div class="options-title">
          <i class="fas fa-list"></i>
          Answer Options
          <span class="options-count">(${question.options.length} option${question.options.length !== 1 ? 's' : ''})</span>
        </div>
        <div class="options-list">
          ${question.options.map((option, index) => {
            const optionLetter = String.fromCharCode(65 + index);
            let optionTextHtml = '';
            
            if (option.text && option.text.includes('\\')) {
              // If option contains LaTeX, render it with MathLive
              optionTextHtml = `
                <math-field readonly 
                  style="width: 100%; min-height: 30px; font-size: 14px; border: none; background: transparent; padding: 4px;"
                  class="option-math-field">
            ${option.text}
                </math-field>
              `;
            } else {
              optionTextHtml = option.text;
            }
            
            return `
            <div class="enhanced-option-item ${option.isCorrect ? 'correct' : ''}">
              <div class="option-letter ${option.isCorrect ? 'correct' : 'default'}">${optionLetter}</div>
              <div class="option-content">${optionTextHtml}</div>
              ${option.isCorrect ? '<div class="correct-indicator"><i class="fas fa-check"></i></div>' : ''}
            </div>
          `;
          }).join('')}
        </div>
      </div>
    `;
  }

  // Enhanced explanation with MathLive support
  let explanationHtml = '';
  if (question.explanation) {
    let explanationTextHtml = '';
    if (question.explanation.includes('\\')) {
      // If explanation contains LaTeX, render it with MathLive
      explanationTextHtml = `
        <math-field readonly 
          style="width: 100%; min-height: 30px; font-size: 14px; border: none; background: transparent; padding: 4px;"
          class="explanation-math-field">
          ${question.explanation}
        </math-field>
      `;
    } else {
      explanationTextHtml = question.explanation;
    }

    explanationHtml = `
      <div class="enhanced-question-preview-explanation">
        <div class="explanation-title">
          <i class="fas fa-lightbulb"></i>
          Explanation
        </div>
        <div class="explanation-content">${explanationTextHtml}</div>
      </div>
    `;
  }

  content.innerHTML = `
    ${questionHeader}
    ${questionTextHtml}
    ${answersHtml}
    ${explanationHtml}
  `;

  // Initialize MathLive fields after content is loaded
  setTimeout(() => {
    initializeMathLiveFields();
  }, 100);
}

// MathLive Functions
function initializeMathLiveFields() {
  // Initialize all math-field elements in the preview
  const mathFields = document.querySelectorAll('math-field');
  mathFields.forEach(field => {
    if (field && !field.hasAttribute('data-initialized')) {
      field.setAttribute('data-initialized', 'true');
      // MathLive will automatically initialize math-field elements
    }
  });
}

// AJAX Form Submission
document.getElementById('quizEditForm').addEventListener('submit', async function(e) {
  e.preventDefault();
  
  // Get form elements
  const title = document.getElementById('title');
  const description = document.getElementById('description');
  const code = document.getElementById('code');
  const duration = document.getElementById('duration');
  const difficulty = document.getElementById('difficulty');
  
  // Validate required fields
  const errors = [];
  
  if (!title.value.trim()) {
    errors.push('Quiz title is required');
    title.classList.add('is-invalid');
  } else {
    title.classList.remove('is-invalid');
  }
  
  // Description is now optional, so no validation needed
  description.classList.remove('is-invalid');
  
  if (!code.value.trim()) {
    errors.push('Quiz code is required');
    code.classList.add('is-invalid');
  } else {
    code.classList.remove('is-invalid');
  }
  
  if (!duration.value || duration.value < 0) {
    errors.push('Duration must be 0 or greater (0 = no time limit)');
    duration.classList.add('is-invalid');
  } else {
    duration.classList.remove('is-invalid');
  }
  
  if (!difficulty.value) {
    errors.push('Difficulty level is required');
    difficulty.classList.add('is-invalid');
  } else {
    difficulty.classList.remove('is-invalid');
  }
  
  if (selectedBankIds.length === 0) {
    errors.push('Please select at least one question bank');
  }
  
  if (selectedQuestions.length === 0) {
    errors.push('Please select at least one question');
  }
  
  if (errors.length > 0) {
    showNotification('Please fix the following errors:\n ' + errors.join('\n '), 'error');
    return;
  }

  // Get form data
  const formData = {
    title: document.getElementById('title').value,
    description: document.getElementById('description').value,
    code: document.getElementById('code').value,
    questionBank: selectedBankIds[0] || '', // For backward compatibility
    questionBanks: selectedBankIds, // New multi-bank field
    selectedQuestions: selectedQuestions, // Each includes sourceBank
    duration: parseInt(document.getElementById('duration').value),
    difficulty: document.getElementById('difficulty').value,
    instructions: document.getElementById('instructions').value,
    passingScore: parseInt(document.getElementById('passingScore').value),
    maxAttempts: parseInt(document.getElementById('maxAttempts').value),
    shuffleQuestions: document.getElementById('shuffleQuestions').checked,
    shuffleOptions: document.getElementById('shuffleOptions').checked,
    showCorrectAnswers: document.getElementById('showCorrectAnswers').checked,
    showResults: document.getElementById('showResults').checked,
    tags: document.getElementById('tags').value.split(',').map(tag => tag.trim()).filter(Boolean)
  };
  
  // Show loading state
  const submitBtn = document.getElementById('updateQuizBtn');
  const originalText = submitBtn.innerHTML;
  submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Updating...';
  submitBtn.disabled = true;
  
  try {
    const response = await fetch(`/admin/quizzes/${quizId}`, {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json',
        'X-Requested-With': 'XMLHttpRequest'
      },
      body: JSON.stringify(formData)
    });
    
    const data = await response.json();
    
    if (data.success) {
      showNotification('Quiz updated successfully!', 'success');
      setTimeout(() => {
        window.location.href = '/admin/quizzes';
      }, 1500);
    } else {
      showNotification(data.message || 'Failed to update quiz', 'error');
    }
  } catch (error) {
    showNotification('Error updating quiz', 'error');
  } finally {
    // Reset button state
    submitBtn.innerHTML = originalText;
    submitBtn.disabled = false;
  }
});

// Select Status Option
function selectStatusOption(newStatus) {
  // Update visual selection
  document.querySelectorAll('.status-option').forEach(option => {
    option.classList.remove('active');
  });
  document.querySelector(`[data-status="${newStatus}"]`).classList.add('active');
  
  // Update hidden input
  const statusSelect = document.getElementById('quizStatusSelect');
  if (statusSelect) {
    statusSelect.value = newStatus;
  }
  
  // Update status indicator
  const statusIndicator = document.querySelector('.enhanced-status-indicator');
  if (statusIndicator) {
    statusIndicator.className = `enhanced-status-indicator status-${newStatus}`;
    statusIndicator.querySelector('span').textContent = newStatus.charAt(0).toUpperCase() + newStatus.slice(1);
  }
  
  // Update quiz status via API
  updateQuizStatus(newStatus);
}

// Update Quiz Status
async function updateQuizStatus(newStatus) {
  console.log('updateQuizStatus called with status:', newStatus); // Debug log
  const statusSelect = document.getElementById('quizStatusSelect');
  const currentStatus = statusSelect ? statusSelect.value : newStatus;
  const finalStatus = newStatus || currentStatus;
  
  console.log('Final status:', finalStatus); // Debug log
  
  // Show loading state
  const statusOptions = document.querySelectorAll('.status-option');
  statusOptions.forEach(option => {
    option.style.pointerEvents = 'none';
    option.style.opacity = '0.6';
  });
  
  // Add loading indicator to status indicator
  const statusIndicator = document.querySelector('.enhanced-status-indicator');
  const originalContent = statusIndicator.innerHTML;
  statusIndicator.innerHTML = '<i class="fas fa-spinner fa-spin"></i> <span>Updating...</span>';
  
  try {
    const response = await fetch(`/admin/quizzes/${quizId}/status`, {
      method: 'PATCH',
      headers: {
        'Content-Type': 'application/json',
        'X-Requested-With': 'XMLHttpRequest'
      },
      body: JSON.stringify({ status: finalStatus })
    });
    
    const data = await response.json();
    
    if (data.success) {
      showNotification(`Quiz status updated to ${finalStatus}`, 'success');
    } else {
      // Revert selection on error
      selectStatusOption(currentStatus);
      statusIndicator.innerHTML = originalContent;
      showNotification(data.message || 'Failed to update quiz status', 'error');
    }
  } catch (error) {
    // Revert selection on error
    selectStatusOption(currentStatus);
    statusIndicator.innerHTML = originalContent;
    showNotification('Error updating quiz status', 'error');
  } finally {
    // Reset loading state
    statusOptions.forEach(option => {
      option.style.pointerEvents = 'auto';
      option.style.opacity = '1';
    });
  }
}

// Populate Tags Filter Dropdown
function populateTagsFilter(filterId, questionsArray) {
  const filterSelect = document.getElementById(filterId);
  if (!filterSelect || !questionsArray || !Array.isArray(questionsArray)) return;

  // Extract all unique tags from questions
  const allTags = new Set();
  questionsArray.forEach(question => {
    if (question.tags && Array.isArray(question.tags)) {
      question.tags.forEach(tag => {
        if (tag && tag.toString().trim()) {
          allTags.add(tag.toString().trim());
        }
      });
    }
  });

  // Sort tags alphabetically
  const sortedTags = Array.from(allTags).sort();

  // Get current selected value
  const currentValue = filterSelect.value;

  // Clear existing options except "All Tags"
  filterSelect.innerHTML = '<option value="">All Tags</option>';

  // Add tag options
  sortedTags.forEach(tag => {
    const option = document.createElement('option');
    option.value = tag;
    option.textContent = tag;
    filterSelect.appendChild(option);
  });

  // Restore previous selection if it still exists
  if (currentValue && sortedTags.includes(currentValue)) {
    filterSelect.value = currentValue;
  }
}

// Notification function
function showNotification(message, type = 'info') {
  // Create notification element
  const notification = document.createElement('div');
  notification.className = `notification notification-${type}`;
  
  // Get appropriate icon for each type
  let iconClass = 'info-circle';
  switch(type) {
    case 'success':
      iconClass = 'check-circle';
      break;
    case 'error':
      iconClass = 'exclamation-triangle';
      break;
    case 'warning':
      iconClass = 'exclamation-circle';
      break;
    case 'info':
    default:
      iconClass = 'info-circle';
      break;
  }
  
  // Handle multi-line messages
  const messageHtml = message.replace(/\n/g, '<br>');
  
  notification.innerHTML = `
    <div class="notification-content">
      <i class="fas fa-${iconClass}"></i>
      <div class="notification-message">${messageHtml}</div>
    </div>
    <button class="notification-close" onclick="this.parentElement.remove()">
      <i class="fas fa-times"></i>
    </button>
  `;
  
  // Add to page
  document.body.appendChild(notification);
  
  // Auto remove after 8 seconds for error messages (longer for multi-line)
  const timeout = type === 'error' ? 8000 : 5000;
  setTimeout(() => {
    if (notification.parentElement) {
      notification.remove();
    }
  }, timeout);
}
</script>

    </div>
    
  </main>
</div>

<%- include('./partials/admin-footer') %>
