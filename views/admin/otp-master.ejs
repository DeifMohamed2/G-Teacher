<%- include('./partials/admin-header', { pageCSS: 'otp-master' }) %>

<!-- Admin Layout -->
<div class="admin-layout">
  
  <!-- Sidebar -->
  <%- include('./partials/admin-sidebar', { currentPage: 'otp-master' }) %>
  
  <!-- Main Content -->
  <main class="admin-main">
    
    <!-- Top Bar -->
    <%- include('./partials/admin-topbar', { 
        breadcrumb: 'OTP Master Generator',
        breadcrumbSubtitle: 'Generate Temporary Backup OTP Codes',
        showSearch: false
    }) %>
    
    <!-- Content Area -->
    <div class="admin-content">
      <div class="otp-master-dashboard admin-fade-in">
        
        <!-- OTP Master Dashboard Header -->
        <div class="admin-dashboard-header">
          <div class="dashboard-header-content">
            <div class="dashboard-header-left">
              <div class="dashboard-title-section">
                <h1 class="admin-dashboard-title">
                  <span class="title-icon">üîê</span>
                  OTP Master Generator
                </h1>
                <p class="admin-dashboard-subtitle">
                  Generate temporary OTP codes for backup authentication when SMS services are unavailable. All OTPs expire after <%= expiryMinutes %> minutes and are not saved to the database.
                </p>
              </div>
            </div>
            
            <div class="dashboard-header-right">
              <div class="dashboard-meta-cards">
                <div class="meta-card">
                  <div class="meta-card-icon">
                    <i class="fas fa-key"></i>
                  </div>
                  <div class="meta-card-content">
                    <span class="meta-card-label">Active OTPs</span>
                    <span class="meta-card-value" id="activeOTPCount"><%= stats.totalActive || 0 %></span>
                  </div>
                </div>
                
                <div class="meta-card">
                  <div class="meta-card-icon">
                    <i class="fas fa-check-circle"></i>
                  </div>
                  <div class="meta-card-content">
                    <span class="meta-card-label">Used OTPs</span>
                    <span class="meta-card-value" id="usedOTPCount"><%= stats.totalUsed || 0 %></span>
                  </div>
                </div>
                
                <div class="meta-card">
                  <div class="meta-card-icon">
                    <i class="fas fa-clock"></i>
                  </div>
                  <div class="meta-card-content">
                    <span class="meta-card-label">Expiry Time</span>
                    <span class="meta-card-value"><%= expiryMinutes %> min</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Generate OTP Section -->
        <div class="otp-section">
          <div class="admin-section-header">
            <h3 class="admin-section-title">
              <i class="fas fa-plus-circle"></i> Generate New OTP
            </h3>
          </div>

          <div class="otp-generator-container">
            <form id="generateOTPForm">
              <div class="form-group">
                <label class="form-label">
                  <i class="fas fa-comment-alt"></i> Purpose (Optional)
                </label>
                <input 
                  type="text" 
                  class="form-control" 
                  id="otpPurpose" 
                  name="purpose" 
                  placeholder="e.g., Emergency login for student #12345"
                  maxlength="200"
                >
                <small class="form-help">Add a note to remember why this OTP was generated</small>
              </div>

              <button type="submit" class="admin-action-btn primary generate-btn">
                <i class="fas fa-key"></i> Generate OTP
              </button>
            </form>

            <!-- Generated OTP Display -->
            <div id="generatedOTPDisplay" class="generated-otp-display" style="display: none;">
              <div class="otp-display-header">
                <i class="fas fa-check-circle"></i>
                <span>OTP Generated Successfully!</span>
              </div>
              
              <div class="otp-creator-info">
                <i class="fas fa-user"></i>
                <span>Generated by: <strong id="otpCreatorName">Admin</strong></span>
              </div>
              
              <div class="otp-code-container">
                <div class="otp-code-wrapper">
                  <div class="otp-code" id="otpCodeDisplay">------</div>
                  <div class="otp-code-label">Your Master OTP Code</div>
                </div>
                <button type="button" class="copy-btn" id="copyOTPBtn" title="Copy to clipboard">
                  <i class="fas fa-copy"></i>
                  <span class="copy-btn-text">Copy</span>
                </button>
              </div>

              <div class="otp-expiry-info">
                <i class="fas fa-clock"></i>
                <span>Expires in: <strong id="otpCountdown">--:--</strong></span>
              </div>

              <div class="otp-purpose-display" id="otpPurposeDisplay" style="display: none;">
                <i class="fas fa-info-circle"></i>
                <span id="otpPurposeText"></span>
              </div>
              
              <div class="otp-usage-info">
                <i class="fas fa-lightbulb"></i>
                <span>This OTP can be used in any authentication form when SMS services are unavailable</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Validate OTP Section -->
        <div class="otp-section">
          <div class="admin-section-header">
            <h3 class="admin-section-title">
              <i class="fas fa-check-double"></i> Validate OTP
            </h3>
          </div>

          <div class="otp-validator-container">
            <form id="validateOTPForm">
              <div class="form-group">
                <label class="form-label">
                  <i class="fas fa-key"></i> Enter OTP Code
                  <span class="required">*</span>
                </label>
                <input 
                  type="text" 
                  class="form-control otp-input" 
                  id="otpCodeInput" 
                  name="otpCode" 
                  placeholder="Enter 6-digit OTP"
                  maxlength="6"
                  pattern="[0-9]{6}"
                  required
                >
              </div>

              <button type="submit" class="admin-action-btn secondary">
                <i class="fas fa-check"></i> Validate OTP
              </button>
            </form>

            <!-- Validation Result -->
            <div id="validationResult" class="validation-result" style="display: none;"></div>
          </div>
        </div>

        <!-- Active OTPs List -->
        <div class="otp-section">
          <div class="admin-section-header">
            <h3 class="admin-section-title">
              <i class="fas fa-list"></i> Active OTPs
            </h3>
            <button type="button" class="admin-action-btn secondary" id="refreshOTPsBtn">
              <i class="fas fa-sync-alt"></i> Refresh
            </button>
          </div>

          <div class="active-otps-container">
            <div id="activeOTPsList">
              <% if (activeOTPs && activeOTPs.length > 0) { %>
                <% activeOTPs.forEach(function(otp) { %>
                  <div class="otp-card <%= otp.used ? 'used' : (otp.isExpired ? 'expired' : '') %>" data-otp-id="<%= otp.id %>">
                    <div class="otp-card-header">
                      <div class="otp-card-code">
                        <i class="fas fa-key"></i>
                        <span class="code-value"><%= otp.code %></span>
                        <button type="button" class="copy-btn-small" onclick="copyOTPCode('<%= otp.code %>')" title="Copy">
                          <i class="fas fa-copy"></i>
                        </button>
                      </div>
                      <div class="otp-card-status">
                        <% if (otp.used) { %>
                          <span class="status-badge used"><i class="fas fa-check-circle"></i> Used</span>
                        <% } else if (otp.isExpired) { %>
                          <span class="status-badge expired"><i class="fas fa-times-circle"></i> Expired</span>
                        <% } else { %>
                          <span class="status-badge active"><i class="fas fa-clock"></i> Active</span>
                        <% } %>
                      </div>
                    </div>

                    <div class="otp-card-body">
                      <div class="otp-info-row">
                        <i class="fas fa-user"></i>
                        <span>Generated by: <strong><%= otp.generatedBy %></strong></span>
                      </div>
                      
                      <% if (otp.purpose) { %>
                        <div class="otp-info-row">
                          <i class="fas fa-comment-alt"></i>
                          <span><%= otp.purpose %></span>
                        </div>
                      <% } %>

                      <div class="otp-info-row">
                        <i class="fas fa-calendar-alt"></i>
                        <span>Generated: <%= new Date(otp.generatedAt).toLocaleString() %></span>
                      </div>

                      <div class="otp-info-row">
                        <i class="fas fa-clock"></i>
                        <span>Expires: <%= new Date(otp.expiresAt).toLocaleString() %></span>
                      </div>
                    </div>

                    <% if (!otp.used && !otp.isExpired) { %>
                      <div class="otp-card-actions">
                        <button type="button" class="revoke-btn" onclick="revokeOTP('<%= otp.id %>')">
                          <i class="fas fa-ban"></i> Revoke
                        </button>
                      </div>
                    <% } %>
                  </div>
                <% }); %>
              <% } else { %>
                <div class="empty-state">
                  <i class="fas fa-key"></i>
                  <p>No active OTPs</p>
                  <small>Generate a new OTP to get started</small>
                </div>
              <% } %>
            </div>
          </div>
        </div>

      </div>
    </div>
  </main>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
  let currentOTPId = null;
  let countdownInterval = null;

  // Generate OTP
  document.getElementById('generateOTPForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const purpose = document.getElementById('otpPurpose').value;
    const btn = this.querySelector('button[type="submit"]');
    const originalBtnText = btn.innerHTML;
    
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';
    
    try {
      const response = await fetch('/admin/otp-master/generate', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ purpose })
      });
      
      const data = await response.json();
      
      if (data.success) {
        displayGeneratedOTP(data.otp, purpose);
        document.getElementById('otpPurpose').value = '';
        updateStats();
      } else {
        showNotification('Error generating OTP: ' + data.message, 'error');
      }
    } catch (error) {
      console.error('Error:', error);
      showNotification('Failed to generate OTP', 'error');
    } finally {
      btn.disabled = false;
      btn.innerHTML = originalBtnText;
    }
  });

  // Display generated OTP
  function displayGeneratedOTP(otp, purpose) {
    const display = document.getElementById('generatedOTPDisplay');
    const codeDisplay = document.getElementById('otpCodeDisplay');
    const purposeDisplay = document.getElementById('otpPurposeDisplay');
    const purposeText = document.getElementById('otpPurposeText');
    const creatorName = document.getElementById('otpCreatorName');
    
    currentOTPId = otp.id;
    codeDisplay.textContent = otp.code;
    
    // Set creator name if available
    if (otp.generatedBy) {
      creatorName.textContent = otp.generatedBy;
    }
    
    if (purpose) {
      purposeText.textContent = purpose;
      purposeDisplay.style.display = 'flex';
    } else {
      purposeDisplay.style.display = 'none';
    }
    
    display.style.display = 'block';
    display.classList.add('fade-in');
    
    startCountdown(new Date(otp.expiresAt));
  }

  // Start countdown timer
  function startCountdown(expiresAt) {
    if (countdownInterval) clearInterval(countdownInterval);
    
    const countdownEl = document.getElementById('otpCountdown');
    
    function updateCountdown() {
      const now = new Date();
      const diff = expiresAt - now;
      
      if (diff <= 0) {
        countdownEl.textContent = 'EXPIRED';
        countdownEl.style.color = '#ef4444';
        clearInterval(countdownInterval);
        setTimeout(refreshActiveOTPs, 1000);
        return;
      }
      
      const minutes = Math.floor(diff / 60000);
      const seconds = Math.floor((diff % 60000) / 1000);
      countdownEl.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
      
      // Color coding
      if (diff < 60000) {
        countdownEl.style.color = '#ef4444';
      } else if (diff < 120000) {
        countdownEl.style.color = '#f59e0b';
      } else {
        countdownEl.style.color = '#22c55e';
      }
    }
    
    updateCountdown();
    countdownInterval = setInterval(updateCountdown, 1000);
  }

  // Copy OTP to clipboard
  document.getElementById('copyOTPBtn').addEventListener('click', function() {
    const otpCode = document.getElementById('otpCodeDisplay').textContent;
    copyOTPCode(otpCode, this);
  });

  function copyOTPCode(code, button = null) {
    navigator.clipboard.writeText(code).then(() => {
      if (button) {
        const originalHTML = button.innerHTML;
        button.classList.add('copied');
        button.innerHTML = '<i class="fas fa-check"></i> <span class="copy-btn-text">Copied!</span>';
        setTimeout(() => {
          button.classList.remove('copied');
          button.innerHTML = originalHTML;
        }, 2000);
      }
      showNotification('OTP copied to clipboard!', 'success');
    }).catch(err => {
      console.error('Failed to copy:', err);
      showNotification('Failed to copy OTP', 'error');
    });
  }

  // Validate OTP
  document.getElementById('validateOTPForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const otpCode = document.getElementById('otpCodeInput').value;
    const btn = this.querySelector('button[type="submit"]');
    const originalBtnText = btn.innerHTML;
    const resultDiv = document.getElementById('validationResult');
    
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Validating...';
    
    try {
      const response = await fetch('/admin/otp-master/validate', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ otpCode })
      });
      
      const data = await response.json();
      
      resultDiv.style.display = 'block';
      if (data.success) {
        resultDiv.className = 'validation-result success';
        resultDiv.innerHTML = `
          <i class="fas fa-check-circle"></i>
          <div>
            <strong>Valid OTP!</strong>
            <p>${data.message}</p>
            ${data.otpData ? `<small>Generated by: ${data.otpData.generatedBy}</small>` : ''}
          </div>
        `;
        document.getElementById('otpCodeInput').value = '';
        setTimeout(refreshActiveOTPs, 1000);
      } else {
        resultDiv.className = 'validation-result error';
        resultDiv.innerHTML = `
          <i class="fas fa-times-circle"></i>
          <div>
            <strong>Invalid OTP</strong>
            <p>${data.message}</p>
          </div>
        `;
      }
      
      updateStats();
    } catch (error) {
      console.error('Error:', error);
      resultDiv.style.display = 'block';
      resultDiv.className = 'validation-result error';
      resultDiv.innerHTML = `
        <i class="fas fa-exclamation-triangle"></i>
        <div>
          <strong>Error</strong>
          <p>Failed to validate OTP</p>
        </div>
      `;
    } finally {
      btn.disabled = false;
      btn.innerHTML = originalBtnText;
    }
  });

  // Revoke OTP
  async function revokeOTP(otpId) {
    if (!confirm('Are you sure you want to revoke this OTP?')) return;
    
    try {
      const response = await fetch(`/admin/otp-master/${otpId}/revoke`, {
        method: 'DELETE'
      });
      
      const data = await response.json();
      
      if (data.success) {
        showNotification('OTP revoked successfully', 'success');
        refreshActiveOTPs();
      } else {
        showNotification('Error revoking OTP: ' + data.message, 'error');
      }
    } catch (error) {
      console.error('Error:', error);
      showNotification('Failed to revoke OTP', 'error');
    }
  }

  // Refresh active OTPs
  async function refreshActiveOTPs() {
    try {
      const response = await fetch('/admin/otp-master/active');
      const data = await response.json();
      
      if (data.success) {
        updateActiveOTPsList(data.activeOTPs);
        updateStatsFromData(data.stats);
      }
    } catch (error) {
      console.error('Error refreshing OTPs:', error);
    }
  }

  // Update active OTPs list
  function updateActiveOTPsList(otps) {
    const container = document.getElementById('activeOTPsList');
    
    if (otps.length === 0) {
      container.innerHTML = `
        <div class="empty-state">
          <i class="fas fa-key"></i>
          <p>No active OTPs</p>
          <small>Generate a new OTP to get started</small>
        </div>
      `;
      return;
    }
    
    container.innerHTML = otps.map(otp => {
      const isUsed = otp.used;
      const isExpired = otp.isExpired;
      const status = isUsed ? 'used' : (isExpired ? 'expired' : '');
      
      return `
        <div class="otp-card ${status}" data-otp-id="${otp.id}">
          <div class="otp-card-header">
            <div class="otp-card-code">
              <i class="fas fa-key"></i>
              <span class="code-value">${otp.code}</span>
              <button type="button" class="copy-btn-small" onclick="copyOTPCode('${otp.code}')" title="Copy">
                <i class="fas fa-copy"></i>
              </button>
            </div>
            <div class="otp-card-status">
              ${isUsed ? '<span class="status-badge used"><i class="fas fa-check-circle"></i> Used</span>' : 
                (isExpired ? '<span class="status-badge expired"><i class="fas fa-times-circle"></i> Expired</span>' :
                '<span class="status-badge active"><i class="fas fa-clock"></i> Active</span>')}
            </div>
          </div>
          <div class="otp-card-body">
            <div class="otp-info-row">
              <i class="fas fa-user"></i>
              <span>Generated by: <strong>${otp.generatedBy}</strong></span>
            </div>
            ${otp.purpose ? `
              <div class="otp-info-row">
                <i class="fas fa-comment-alt"></i>
                <span>${otp.purpose}</span>
              </div>
            ` : ''}
            <div class="otp-info-row">
              <i class="fas fa-calendar-alt"></i>
              <span>Generated: ${new Date(otp.generatedAt).toLocaleString()}</span>
            </div>
            <div class="otp-info-row">
              <i class="fas fa-clock"></i>
              <span>Expires: ${new Date(otp.expiresAt).toLocaleString()}</span>
            </div>
          </div>
          ${!isUsed && !isExpired ? `
            <div class="otp-card-actions">
              <button type="button" class="revoke-btn" onclick="revokeOTP('${otp.id}')">
                <i class="fas fa-ban"></i> Revoke
              </button>
            </div>
          ` : ''}
        </div>
      `;
    }).join('');
  }

  // Update stats
  async function updateStats() {
    try {
      const response = await fetch('/admin/otp-master/active');
      const data = await response.json();
      
      if (data.success) {
        updateStatsFromData(data.stats);
      }
    } catch (error) {
      console.error('Error updating stats:', error);
    }
  }

  function updateStatsFromData(stats) {
    document.getElementById('activeOTPCount').textContent = stats.totalActive || 0;
    document.getElementById('usedOTPCount').textContent = stats.totalUsed || 0;
  }

  // Show notification
  function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.innerHTML = `
      <i class="fas fa-${type === 'success' ? 'check-circle' : (type === 'error' ? 'times-circle' : 'info-circle')}"></i>
      <span>${message}</span>
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
      notification.classList.add('show');
    }, 100);
    
    setTimeout(() => {
      notification.classList.remove('show');
      setTimeout(() => notification.remove(), 300);
    }, 3000);
  }

  // Refresh button
  document.getElementById('refreshOTPsBtn').addEventListener('click', refreshActiveOTPs);

  // Auto-refresh every 30 seconds
  setInterval(refreshActiveOTPs, 30000);

  // Only allow numbers in OTP input
  document.getElementById('otpCodeInput').addEventListener('input', function(e) {
    this.value = this.value.replace(/[^0-9]/g, '');
  });
</script>

<%- include('./partials/admin-footer') %>
