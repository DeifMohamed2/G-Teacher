<%- include('partials/header', { title: title }) %>

<!-- Import Payment Results CSS -->
<link rel="stylesheet" href="/css/payment-results.css">

<!-- Floating Math Elements -->
<div class="floating-math-elements-professor" id="floatingMath">
  <div class="math-element-professor" data-equation="∂">∂</div>
  <div class="math-element-professor" data-equation="∇">∇</div>
  <div class="math-element-professor" data-equation="∫">∫</div>
  <div class="math-element-professor" data-equation="∑">∑</div>
  <div class="math-element-professor" data-equation="∏">∏</div>
  <div class="math-element-professor" data-equation="∞">∞</div>
  <div class="math-element-professor" data-equation="∃">∃</div>
  <div class="math-element-professor" data-equation="∀">∀</div>
  <div class="math-element-professor" data-equation="ℝ">ℝ</div>
  <div class="math-element-professor" data-equation="ℂ">ℂ</div>
</div>

<!-- Payment Success Page -->
<div class="payment-result-page payment-success-page">
  <div class="container">
    <div class="payment-result-container">
      <!-- Success Header -->
      <div class="payment-success-header">
        <div class="success-icon">
          <i class="fas fa-check-circle"></i>
        </div>
        <h1 class="success-title">Payment Successful!</h1>
        <p class="success-message">
          Thank you for your purchase. Your payment has been processed successfully.
        </p>
      </div>

      <!-- Order Details -->
      <div class="order-details">
        <div class="order-info-card">
          <div class="card-header">
            <h3><i class="fas fa-receipt"></i> Order Information</h3>
          </div>
          <div class="card-body">
            <div class="info-row">
              <span class="label">Order Number:</span>
              <span class="value"><strong><%= purchase.orderNumber %></strong></span>
            </div>
            <div class="info-row">
              <span class="label">Transaction Date:</span>
              <span class="value"><%= new Date(purchase.createdAt).toLocaleDateString('en-EG', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
              }) %></span>
            </div>
            <div class="info-row">
              <span class="label">Payment Method:</span>
              <span class="value">
                <i class="fas fa-credit-card"></i>
                Paymob Gateway
              </span>
            </div>
            <div class="info-row">
              <span class="label">Status:</span>
              <span class="value">
                <span class="status-badge status-completed">
                  <i class="fas fa-check"></i>
                  Completed
                </span>
              </span>
            </div>
          </div>
        </div>

        <!-- Purchased Items -->
        <div class="purchased-items-card">
          <div class="card-header">
            <h3><i class="fas fa-shopping-bag"></i> Purchased Items</h3>
          </div>
          <div class="card-body">
            <% if (purchase.items && purchase.items.length > 0) { %>
            <% purchase.items.forEach(item => { %>
            <div class="purchased-item">
              <div class="item-icon">
                <% if (item.itemType === 'bundle') { %>
                <i class="fas fa-layer-group text-primary"></i>
                <% } else { %>
                <i class="fas fa-book text-success"></i>
                <% } %>
              </div>
              <div class="item-details">
                <h4 class="item-title"><%= item.title %></h4>
                <p class="item-type">
                  <%= item.itemType === 'bundle' ? 'Course Bundle' : 'Individual Course' %>
                </p>
              </div>
              <div class="item-price">
                <span class="price">EGP <%= item.price.toFixed(2) %></span>
              </div>
            </div>
            <% }); %>
            <% } %>

            <!-- Book Orders -->
            <% if (purchase.bookOrders && purchase.bookOrders.length > 0) { %>
            <% purchase.bookOrders.forEach(bookOrder => { %>
            <% if (bookOrder && bookOrder.bookPrice) { %>
            <div class="purchased-item">
              <div class="item-icon">
                <i class="fas fa-book text-warning"></i>
              </div>
              <div class="item-details">
                <h4 class="item-title"><%= bookOrder.bookName || 'Book' %></h4>
                <p class="item-type">
                  Physical Book
                  <% if (bookOrder.bundle && bookOrder.bundle.title) { %>
                  <span class="text-muted"> - <%= bookOrder.bundle.title %></span>
                  <% } %>
                </p>
              </div>
              <div class="item-price">
                <span class="price">EGP <%= (bookOrder.bookPrice || 0).toFixed(2) %></span>
              </div>
            </div>
            <% } %>
            <% }) %>
            <% } %>
          </div>
        </div>

        <!-- Order Total -->
        <div class="order-total-card">
          <div class="card-body">
            <% 
              // Calculate courses/bundles subtotal (excluding books)
              const coursesSubtotal = purchase.items && purchase.items.length > 0 
                ? purchase.items.reduce((sum, item) => sum + (item.price || 0), 0) 
                : 0;
              const booksSubtotal = purchase.booksSubtotal || 0;
              
              // For book-only purchases (isBookOnly flag or empty items with books)
              const isBookOnly = purchase.isBookOnly || (coursesSubtotal === 0 && booksSubtotal > 0);
              
              // For book-only purchases, subtotal should equal booksSubtotal (not double)
              // For regular purchases, subtotal = coursesSubtotal + booksSubtotal
              // Use purchase.total as the source of truth for subtotal (it's already calculated correctly)
              const actualSubtotal = isBookOnly 
                ? booksSubtotal  // For book-only, subtotal = book price only
                : (purchase.subtotal || (coursesSubtotal + booksSubtotal));
            %>
            <% if (coursesSubtotal > 0) { %>
            <div class="total-row">
              <span class="label">Courses/Bundles:</span>
              <span class="value">EGP <%= coursesSubtotal.toFixed(2) %></span>
            </div>
            <% } %>
            <% if (booksSubtotal > 0) { %>
            <div class="total-row">
              <span class="label">Books:</span>
              <span class="value">EGP <%= booksSubtotal.toFixed(2) %></span>
            </div>
            <% } %>
            <div class="total-row final-total">
              <span class="label">Total:</span>
              <span class="value">EGP <%= purchase.total.toFixed(2) %></span>
            </div>
          </div>
        </div>
      </div>


      <!-- Action Buttons -->
      <div class="action-buttons">
        <a href="/student/enrolled-courses" class="btn btn-primary btn-lg">
          <i class="fas fa-graduation-cap"></i>
          View My Courses
        </a>
        <a href="/student/dashboard" class="btn btn-secondary btn-lg">
          <i class="fas fa-tachometer-alt"></i>
          Go to Dashboard
        </a>
        <a href="/" class="btn btn-outline btn-lg">
          <i class="fas fa-home"></i>
          Return Home
        </a>
      </div>
    </div>
  </div>
</div>

<script>
  // Clear cart immediately when page loads
  document.addEventListener('DOMContentLoaded', function() {
    // First clear server-side cart
    fetch('/purchase/cart/clear', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      }
    }).then(response => response.json())
      .then(data => {
        console.log('Server-side cart cleared:', data);
        
        // Clear client-side cart state
        if (window.sessionCart) {
          window.sessionCart = [];
        }
        
        // Update cart using globalCart methods if available
        if (window.globalCart) {
          window.globalCart.setSessionCart([]);
          window.globalCart.updateCartCount();
          window.globalCart.updateCartSidebar();
          if (typeof window.globalCart.clearCart === 'function') {
            window.globalCart.clearCart();
          }
        }
        
        // Update cart count badge manually
        const cartCountElements = document.querySelectorAll('#cartCount, .cart-count, .cart-badge');
        cartCountElements.forEach(element => {
          element.textContent = '0';
          element.style.display = 'none';
        });
        
        // Close cart sidebar if open
        const cartSidebar = document.getElementById('cartSidebar');
        if (cartSidebar && cartSidebar.classList.contains('active')) {
          cartSidebar.classList.remove('active');
          document.body.style.overflow = '';
        }
        
        // Clear cart items from sidebar
        const cartItems = document.getElementById('cartItems');
        if (cartItems) {
          cartItems.innerHTML = `
            <div class="cart-empty">
              <div class="cart-empty-icon">
                <i class="fas fa-shopping-cart"></i>
              </div>
              <h4>Your cart is empty</h4>
              <p>Add some courses to get started!</p>
            </div>
          `;
        }
        
        console.log('Cart fully cleared and UI updated on payment success page');
      })
      .catch(error => {
        console.error('Error clearing cart:', error);
      });
  });
</script>

<%- include('partials/footer') %>