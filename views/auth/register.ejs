<%- include('../partials/header') %>

<!-- Flash messages are now handled in the header partial -->

<!-- Modern Split-Screen Registration Layout -->
<div class="auth-container-modern register-layout">
  <!-- Left Side - Branding & Visual -->
  <div class="auth-visual-section">
    <div class="auth-visual-overlay"></div>
    <div class="auth-particles" id="auth-particles-register"></div>
    
    <!-- Floating Math Elements -->
    <div class="math-shape-auth auth-shape1 floating-element"></div>
    <div class="math-shape-auth auth-shape2 floating-element"></div>
    <div class="math-shape-auth auth-shape3 floating-element"></div>
    <div class="math-shape-auth auth-shape4 floating-element"></div>
    
    <!-- Brand Content -->
    <div class="auth-brand-content">
      <div class="auth-logo-container">
        <div class="auth-logo-icon">
          <img src="/images/K.png" alt="Elkably Logo" class="auth-main-logo" >
        </div>
        <h1 class="auth-brand-title">Elkably</h1>
        <p class="auth-brand-subtitle">Math Is <br> Root of Knowledge</p>
      </div>
      
      <div class="auth-features">
        <div class="auth-feature-item" data-aos="fade-right" data-aos-delay="100">
          <img src="/images/ESTLOGO.jpg" alt="EST" class="auth-feature-logo">
          <span>EST</span>
        </div>
        <div class="auth-feature-item" data-aos="fade-right" data-aos-delay="200">
          <img src="/images/SATLOGO.jpg" alt="SAT" class="auth-feature-logo">
          <span>D-SAT</span>
        </div>
        <div class="auth-feature-item" data-aos="fade-right" data-aos-delay="300">
          <img src="/images/ACTLOGO.jpg" alt="ACT" class="auth-feature-logo">
          <span>ACT</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Right Side - Registration Form -->
  <div class="auth-form-section">
    <div class="auth-form-container">
      <!-- Header -->
      <div class="auth-form-header">
        <h2 class="auth-form-title">
          <i class="fas fa-user-plus me-2"></i>
          Join The Math Journey
        </h2>
        <p class="auth-form-subtitle">Create your account and start learning</p>
        
        <!-- Progress Steps -->
        <div class="registration-steps">
          <div class="step-item active" data-step="1">
            <div class="step-number">1</div>
            <span class="step-label">Personal Info</span>
          </div>
          <div class="step-item" data-step="2">
            <div class="step-number">2</div>
            <span class="step-label">Academic Details</span>
          </div>
          <div class="step-item" data-step="3">
            <div class="step-number">3</div>
            <span class="step-label">Account Setup</span>
          </div>
        </div>
      </div>

      <!-- Display Errors -->
      <% if (typeof errors !== 'undefined' && errors.length > 0) { %>
      <div class="alert alert-danger auth-alert" role="alert">
        <div class="d-flex align-items-center">
          <i class="fas fa-exclamation-triangle me-2"></i>
          <strong>Registration Failed!</strong>
        </div>
        <hr class="my-2">
        <ul class="mb-0">
          <% errors.forEach(function(error) { %>
          <li><%= error.msg %></li>
          <% }); %>
        </ul>
      </div>
      <% } %>

      <!-- Display Success Messages -->
      <% if (typeof success_msg !== 'undefined' && success_msg.length > 0) { %>
      <div class="alert alert-success auth-alert" role="alert">
        <div class="d-flex align-items-center">
          <i class="fas fa-check-circle me-2"></i>
          <strong>Success!</strong>
        </div>
        <hr class="my-2">
        <p class="mb-0"><%= success_msg %></p>
      </div>
      <% } %>

      <!-- Registration Form -->
      <form action="/auth/register" method="POST" class="auth-form needs-validation" novalidate>
        <!-- Hidden submission ID to prevent duplicate submissions -->
        <input type="hidden" name="submissionId" id="submissionId" value="">
        <!-- Hidden field to pass OTP verification state -->
        <input type="hidden" id="serverOtpVerified" value="<%= typeof studentPhoneVerified !== 'undefined' && studentPhoneVerified ? 'true' : 'false' %>">
        
        <!-- Step 1: Personal Information -->
        <div class="form-step active" data-step="1">
          <h3 class="step-title">Personal Information</h3>
          
          <div class="form-row-modern">
            <div class="form-group-modern">
              <label for="firstName" class="form-label-modern">
                <i class="fas fa-user form-label-icon"></i>
                First Name *
              </label>
              <div class="input-group-modern">
                <input type="text" id="firstName" name="firstName" class="form-control-modern" 
                       placeholder="Enter your first name" 
                       value="<%= typeof firstName != 'undefined' ? firstName : '' %>" required>
                <div class="input-focus-line"></div>
              </div>
              <div class="invalid-feedback-modern">Please enter your first name.</div>
            </div>

            <div class="form-group-modern">
              <label for="lastName" class="form-label-modern">
                <i class="fas fa-user form-label-icon"></i>
                Last Name *
              </label>
              <div class="input-group-modern">
                <input type="text" id="lastName" name="lastName" class="form-control-modern" 
                       placeholder="Enter your last name" 
                       value="<%= typeof lastName != 'undefined' ? lastName : '' %>" required>
                <div class="input-focus-line"></div>
              </div>
              <div class="invalid-feedback-modern">Please enter your last name.</div>
            </div>
          </div>

          <div class="form-row-modern">
            <div class="form-group-modern">
              <label for="studentNumber" class="form-label-modern">
                <i class="fas fa-id-card form-label-icon"></i>
                Student Number *
              </label>
              <div class="input-group-modern phone-input-group">
                <div class="country-code-selector">
                  <select id="studentCountryCode" name="studentCountryCode" class="country-select" required>
                    <option value="+20" <%= typeof studentCountryCode != 'undefined' && studentCountryCode == '+20' ? 'selected' : (typeof studentCountryCode == 'undefined' ? 'selected' : '') %>>
                      ðŸ‡ªðŸ‡¬ +20
                    </option>
                    <option value="+966" <%= typeof studentCountryCode != 'undefined' && studentCountryCode == '+966' ? 'selected' : '' %>>
                      ðŸ‡¸ðŸ‡¦ +966
                    </option>
                    <option value="+971" <%= typeof studentCountryCode != 'undefined' && studentCountryCode == '+971' ? 'selected' : '' %>>
                      ðŸ‡¦ðŸ‡ª +971
                    </option>
                    <option value="+965" <%= typeof studentCountryCode != 'undefined' && studentCountryCode == '+965' ? 'selected' : '' %>>
                      ðŸ‡°ðŸ‡¼ +965
                    </option>
                  </select>
                </div>
                <input type="text" id="studentNumber" name="studentNumber" class="form-control-modern phone-input" 
                       placeholder="Enter your student number" 
                       value="<%= typeof studentNumber != 'undefined' ? studentNumber : '' %>" required>
                <div class="input-focus-line"></div>
              </div>
              <div class="invalid-feedback-modern">Please enter your student number.</div>
              
              <!-- Hidden inputs to preserve values when fields are disabled after OTP verification -->
              <input type="hidden" id="hiddenStudentNumber" name="studentNumber" value="">
              <input type="hidden" id="hiddenStudentCountryCode" name="studentCountryCode" value="">
              
              <!-- Student OTP Verification -->
              <div class="otp-verification-section" id="studentOtpSection" style="display: none;">
                <div class="otp-section-content">
                  <button type="button" id="sendStudentOtpBtn" class="btn-send-otp">
                    <i class="fas fa-paper-plane"></i> Send OTP
                  </button>
                  <div class="otp-input-group" id="studentOtpInputGroup" style="display: none;">
                    <input type="text" id="studentOtpInput" class="form-control-modern otp-input" 
                           placeholder="000000" maxlength="6" pattern="[0-9]{6}">
                    <button type="button" id="verifyStudentOtpBtn" class="btn-verify-otp">
                      <i class="fas fa-check"></i> Verify
                    </button>
                  </div>
                  <div class="otp-status" id="studentOtpStatus"></div>
                  <div class="otp-timer" id="studentOtpTimer" style="display: none;">
                    <i class="fas fa-clock"></i> Resend OTP in <span id="studentOtpCountdown">60</span>s
                  </div>
                  <button type="button" id="resendStudentOtpBtn" class="btn-resend-otp" style="display: none;">
                    <i class="fas fa-redo"></i> Resend OTP
                  </button>
                </div>
              </div>
            </div>

            <div class="form-group-modern">
              <label for="parentNumber" class="form-label-modern">
                <i class="fas fa-phone form-label-icon"></i>
                Parent Number *
              </label>
              <div class="input-group-modern phone-input-group">
                <div class="country-code-selector">
                  <select id="parentCountryCode" name="parentCountryCode" class="country-select" required>
                    <option value="+20" <%= typeof parentCountryCode != 'undefined' && parentCountryCode == '+20' ? 'selected' : (typeof parentCountryCode == 'undefined' ? 'selected' : '') %>>
                      ðŸ‡ªðŸ‡¬ +20
                    </option>
                    <option value="+966" <%= typeof parentCountryCode != 'undefined' && parentCountryCode == '+966' ? 'selected' : '' %>>
                      ðŸ‡¸ðŸ‡¦ +966
                    </option>
                    <option value="+971" <%= typeof parentCountryCode != 'undefined' && parentCountryCode == '+971' ? 'selected' : '' %>>
                      ðŸ‡¦ðŸ‡ª +971
                    </option>
                    <option value="+965" <%= typeof parentCountryCode != 'undefined' && parentCountryCode == '+965' ? 'selected' : '' %>>
                      ðŸ‡°ðŸ‡¼ +965
                    </option>
                  </select>
                </div>
                <input type="tel" id="parentNumber" name="parentNumber" class="form-control-modern phone-input" 
                       placeholder="Enter parent phone number" 
                       value="<%= typeof parentNumber != 'undefined' ? parentNumber : '' %>" required>
                <div class="input-focus-line"></div>
              </div>
              <div class="invalid-feedback-modern">Please enter a valid parent phone number.</div>
            </div>
          </div>

          <div class="form-row-modern">
            <div class="form-group-modern">
              <label for="studentEmail" class="form-label-modern">
                <i class="fas fa-envelope form-label-icon"></i>
                Student Email *
              </label>
              <div class="input-group-modern">
                <input type="email" id="studentEmail" name="studentEmail" class="form-control-modern" 
                       placeholder="Enter your student email" 
                       value="<%= typeof studentEmail != 'undefined' ? studentEmail : '' %>" required>
                <div class="input-focus-line"></div>
              </div>
              <div class="invalid-feedback-modern">Please enter a valid student email address.</div>
            </div>

            <div class="form-group-modern">
              <label for="username" class="form-label-modern">
                <i class="fas fa-at form-label-icon"></i>
                Username *
              </label>
              <div class="input-group-modern">
                <input type="text" id="username" name="username" class="form-control-modern" 
                       placeholder="Choose a username" 
                       value="<%= typeof username != 'undefined' ? username : '' %>" required>
                <div class="input-focus-line"></div>
              </div>
              <div class="form-text-modern">Only letters, numbers, and underscores allowed.</div>
              <div class="invalid-feedback-modern">Please choose a valid username.</div>
            </div>
          </div>
        </div>

        <!-- Step 2: Academic Details -->
        <div class="form-step" data-step="2">
          <h3 class="step-title">Academic Details</h3>
          
          <div class="form-row-modern">
            <div class="form-group-modern">
              <label for="schoolName" class="form-label-modern">
                <i class="fas fa-school form-label-icon"></i>
                School Name *
              </label>
              <div class="input-group-modern">
                <input type="text" id="schoolName" name="schoolName" class="form-control-modern" 
                       placeholder="Enter your school name" 
                       value="<%= typeof schoolName != 'undefined' ? schoolName : '' %>" required>
                <div class="input-focus-line"></div>
              </div>
              <div class="invalid-feedback-modern">Please enter your school name.</div>
            </div>

            <div class="form-group-modern">
              <label for="grade" class="form-label-modern">
                <i class="fas fa-graduation-cap form-label-icon"></i>
                Grade *
              </label>
              <div class="input-group-modern">
                <select id="grade" name="grade" class="form-control-modern" required>
                  <option value="">Select your grade</option>
                  <option value="Year 10" <%= typeof grade != 'undefined' && grade == 'Year 10' ? 'selected' : '' %>>Year 10</option>
                  <option value="Year 11" <%= typeof grade != 'undefined' && grade == 'Year 11' ? 'selected' : '' %>>Year 11</option>
                  <option value="Year 12" <%= typeof grade != 'undefined' && grade == 'Year 12' ? 'selected' : '' %>>Year 12</option>
                </select>
                <div class="input-focus-line"></div>
              </div>
              <div class="invalid-feedback-modern">Please select your grade.</div>
            </div>
          </div>

          <div class="form-group-modern">
            <label for="englishTeacher" class="form-label-modern">
              <i class="fas fa-chalkboard-teacher form-label-icon"></i>
              English Teacher *
            </label>
            <div class="input-group-modern">
              <input type="text" id="englishTeacher" name="englishTeacher" class="form-control-modern" 
                     placeholder="Enter your English teacher's name" 
                     value="<%= typeof englishTeacher != 'undefined' ? englishTeacher : '' %>" required>
              <div class="input-focus-line"></div>
            </div>
            <div class="invalid-feedback-modern">Please enter your English teacher's name.</div>
          </div>
        </div>

        <!-- Step 3: Account Setup -->
        <div class="form-step" data-step="3">
          <h3 class="step-title">Account Setup</h3>
          
          <div class="form-row-modern">
            <div class="form-group-modern">
              <label for="password" class="form-label-modern">
                <i class="fas fa-lock form-label-icon"></i>
                User Password *
              </label>
              <div class="input-group-modern">
                <input type="password" id="password" name="password" class="form-control-modern" 
                       placeholder="Create a password" required minlength="6">
                <button class="btn-toggle-password" type="button" id="togglePassword">
                  <i class="fas fa-eye"></i>
                </button>
                <div class="input-focus-line"></div>
              </div>
              <div class="form-text-modern">Password must be at least 6 characters long.</div>
              <div class="invalid-feedback-modern">Password must be at least 6 characters.</div>
            </div>

            <div class="form-group-modern">
              <label for="password2" class="form-label-modern">
                <i class="fas fa-lock form-label-icon"></i>
                Confirm Password *
              </label>
              <div class="input-group-modern">
                <input type="password" id="password2" name="password2" class="form-control-modern" 
                       placeholder="Confirm your password" required>
                <button class="btn-toggle-password" type="button" id="togglePassword2">
                  <i class="fas fa-eye"></i>
                </button>
                <div class="input-focus-line"></div>
              </div>
              <div class="invalid-feedback-modern">Please confirm your password.</div>
            </div>
          </div>

          <div class="form-group-modern">
            <label for="howDidYouKnow" class="form-label-modern">
              <i class="fas fa-question-circle form-label-icon"></i>
              How did you know Mr Kably? *
            </label>
            <div class="input-group-modern">
              <select id="howDidYouKnow" name="howDidYouKnow" class="form-control-modern" required>
                <option value="">Select an option...</option>
                <option value="TikTok" <%= typeof howDidYouKnow != 'undefined' && howDidYouKnow == 'TikTok' ? 'selected' : '' %>>TikTok</option>
                <option value="Instagram" <%= typeof howDidYouKnow != 'undefined' && howDidYouKnow == 'Instagram' ? 'selected' : '' %>>Instagram</option>
                <option value="Facebook" <%= typeof howDidYouKnow != 'undefined' && howDidYouKnow == 'Facebook' ? 'selected' : '' %>>Facebook</option>
                <option value="YouTube" <%= typeof howDidYouKnow != 'undefined' && howDidYouKnow == 'YouTube' ? 'selected' : '' %>>YouTube</option>
                <option value="Snapchat" <%= typeof howDidYouKnow != 'undefined' && howDidYouKnow == 'Snapchat' ? 'selected' : '' %>>Snapchat</option>
                <option value="Friend" <%= typeof howDidYouKnow != 'undefined' && howDidYouKnow == 'Friend' ? 'selected' : '' %>>Friend</option>
                <option value="Other" <%= typeof howDidYouKnow != 'undefined' && howDidYouKnow == 'Other' ? 'selected' : '' %>>Other</option>
              </select>
              <div class="input-focus-line"></div>
            </div>
            <div id="howDidYouKnowOtherContainer" style="display: none; margin-top: 10px;">
              <div class="input-group-modern">
                <input type="text" id="howDidYouKnowOther" name="howDidYouKnowOther" class="form-control-modern" 
                       placeholder="Please specify how you heard about Mr Kably...">
                <div class="input-focus-line"></div>
              </div>
            </div>
            <div class="invalid-feedback-modern">Please tell us how you heard about Mr Kably.</div>
          </div>

          <!-- Terms and Privacy Agreement Section -->
          <div class="terms-agreement-section">
            <div class="terms-agreement-header">
              <i class="fas fa-shield-check"></i>
              <h4>Legal Agreement Required</h4>
            </div>
            
            <p class="terms-agreement-text">
              Please read and agree to our legal documents:
            </p>
            
            <div class="terms-documents-grid">
              <a href="#" class="document-card" id="openTermsModal">
                <div class="document-card-icon">
                  <i class="fas fa-file-contract"></i>
                </div>
                <div class="document-card-content">
                  <h5>Terms of Service</h5>
                  <span id="termsReadStatus" class="document-status status-pending">
                    <i class="fas fa-clock"></i> Click to Read
                  </span>
                </div>
                <div class="document-card-arrow">
                  <i class="fas fa-arrow-right"></i>
                </div>
              </a>
              
              <a href="#" class="document-card" id="openPrivacyModal">
                <div class="document-card-icon">
                  <i class="fas fa-shield-alt"></i>
                </div>
                <div class="document-card-content">
                  <h5>Privacy Policy</h5>
                  <span id="privacyReadStatus" class="document-status status-pending">
                    <i class="fas fa-clock"></i> Click to Read
                  </span>
                </div>
                <div class="document-card-arrow">
                  <i class="fas fa-arrow-right"></i>
                </div>
              </a>
            </div>
            
            <div class="terms-completion-notice" id="termsCompletionNotice" style="display: none;">
              <i class="fas fa-check-circle"></i>
              <span>All documents read. You may proceed!</span>
            </div>
          </div>
        </div>

        <!-- Navigation Buttons -->
        <div class="form-navigation">
          <button type="button" class="btn-nav btn-nav-prev" id="prevStep" style="display: none;">
            <i class="fas fa-arrow-left"></i>
            Previous
          </button>
          
          <button type="button" class="btn-nav btn-nav-next" id="nextStep">
            Next
            <i class="fas fa-arrow-right"></i>
          </button>
          
          <button type="submit" class="btn-auth-primary" id="submitBtn" style="display: none;">
            <span class="btn-text">Create Account</span>
            <i class="fas fa-rocket btn-icon"></i>
            <div class="btn-ripple"></div>
          </button>
        </div>
      </form>

      <!-- Footer -->
      <div class="auth-form-footer">
        <p>Already have an account? 
          <a href="/auth/login" class="auth-link-modern">
            <span>Sign In</span>
            <i class="fas fa-arrow-right"></i>
          </a>
        </p>
      </div>
    </div>
  </div>
</div>

<!-- Country Code Selector Styles -->
<style>
/* Auth Logo Image Styling */
.auth-main-logo {
  width: 80px;
  height: 80px;
  object-fit: contain;
  border-radius: 50%;
  background: white;
  padding: 10px;
}

/* Auth Feature Logo Styling */
.auth-feature-logo {
  width: 40px;
  height: 40px;
  object-fit: contain;
  border-radius: 8px;
  background: white;
  padding: 5px;
}

.phone-input-group {
  display: flex;
  align-items: stretch;
  border-radius: 12px;
  overflow: hidden;
  background: #f8f9fa;
  border: 2px solid transparent;
  transition: all 0.3s ease;
}

.phone-input-group:focus-within {
  border-color: #dc2626;
  background: #fff;
  box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.1);
}

.country-code-selector {
  display: flex;
  align-items: center;
  background: #e5e7eb;
  border-right: 1px solid #d1d5db;
  min-width: 95px;
  max-width: 95px;
  position: relative;
}

/* Flag overlay element created by JavaScript */
.country-flag-overlay {
  position: absolute;
  left: 8px;
  top: 50%;
  transform: translateY(-50%);
  font-size: 13px;
  font-weight: 500;
  pointer-events: none;
  z-index: 100;
  display: block;
  line-height: 1;
  white-space: nowrap;
  color: #374151;
  width: calc(100% - 35px);
  overflow: hidden;
  text-overflow: ellipsis;
}


.country-select {
  border: none;
  background: transparent;
  padding: 12px 8px 12px 12px;
  font-size: 14px;
  font-weight: 500;
  color: transparent;
  cursor: pointer;
  outline: none;
  width: 100%;
  appearance: none;
  background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
  background-position: right 8px center;
  background-repeat: no-repeat;
  background-size: 16px 16px;
  padding-right: 32px;
  position: relative;
  z-index: 1;
}

/* Keep text transparent even when focused (open) */
.country-select:focus {
  color: transparent;
  padding-left: 12px;
}

/* Keep flag overlay visible even when focused (open) */
.country-select:focus + .country-flag-overlay {
  display: block;
}

.country-code-selector:has(.country-select:focus) .country-flag-overlay {
  display: block;
}

.country-select:focus {
  background-color: #f3f4f6;
}

.country-select option {
  background: #fff;
  color: #374151;
  padding: 8px;
  font-size: 14px;
}

.phone-input {
  flex: 1;
  border: none;
  background: transparent;
  padding: 12px 16px;
  font-size: 14px;
  color: #374151;
  outline: none;
}

.phone-input::placeholder {
  color: #9ca3af;
}

/* Dark theme support */
.dark-theme .phone-input-group {
  background: #374151;
  border-color: #4b5563;
}

.dark-theme .phone-input-group:focus-within {
  background: #1f2937;
  border-color: #ef4444;
}

.dark-theme .country-code-selector {
  background: #4b5563;
  border-color: #6b7280;
}

.dark-theme .country-select {
  color: transparent;
  background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%23d1d5db' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
}

.dark-theme .country-flag-overlay {
  color: #d1d5db;
}

.dark-theme .country-select:focus {
  background-color: #374151;
  color: transparent;
}

.dark-theme .country-select option {
  background: #1f2937;
  color: #d1d5db;
}

.dark-theme .phone-input {
  color: #d1d5db;
}

.dark-theme .phone-input::placeholder {
  color: #9ca3af;
}

/* Responsive design */
@media (max-width: 768px) {
  .country-code-selector {
    min-width: 90px;
    max-width: 90px;
  }
  
  .country-select {
    padding: 10px 6px 10px 10px;
    font-size: 13px;
    padding-right: 28px;
    background-size: 14px 14px;
  }
  
  .country-flag-overlay {
    font-size: 13px;
    left: 6px;
    width: calc(100% - 35px);
  }

  .country-select:focus {
    padding-left: 6px;
  }
  
  .phone-input {
    padding: 10px 12px;
    font-size: 13px;
  }
}

/* Flag emoji styling */
.country-select option {
  font-size: 16px;
  line-height: 1.5;
}

/* Animation for focus states */
.phone-input-group {
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.phone-input-group:hover {
  background: #f3f4f6;
}

.dark-theme .phone-input-group:hover {
  background: #374151;
}

/* OTP Verification Section Styling */
.otp-verification-section {
  margin-top: 16px;
  padding: 24px 20px;
  background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
  border-radius: 16px;
  border: 2px solid #e5e7eb;
  transition: all 0.3s ease;
  text-align: center;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
  position: relative;
  overflow: hidden;
}

.otp-section-content {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 12px;
  width: 100%;
}

.otp-verification-section::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 3px;
  background: linear-gradient(90deg, #dc2626, #ef4444, #dc2626);
  background-size: 200% 100%;
  animation: shimmer 3s ease-in-out infinite;
}

@keyframes shimmer {
  0%, 100% { background-position: 0% 50%; }
  50% { background-position: 100% 50%; }
}

.dark-theme .otp-verification-section {
  background: linear-gradient(135deg, #374151 0%, #1f2937 100%);
  border-color: #4b5563;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
}

.dark-theme .otp-verification-section::before {
  background: linear-gradient(90deg, #ef4444, #f87171, #ef4444);
  background-size: 200% 100%;
}

.btn-send-otp, .btn-verify-otp, .btn-resend-otp {
  padding: 12px 24px;
  border: none;
  border-radius: 10px;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  min-width: 160px;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
  margin: 0;
}

.btn-send-otp {
  background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
  color: white;
}

.btn-send-otp:hover:not(:disabled) {
  background: linear-gradient(135deg, #b91c1c 0%, #991b1b 100%);
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(220, 38, 38, 0.4);
}

.btn-send-otp:active:not(:disabled) {
  transform: translateY(0);
  box-shadow: 0 2px 6px rgba(220, 38, 38, 0.3);
}

.btn-send-otp:disabled {
  background: linear-gradient(135deg, #9ca3af 0%, #6b7280 100%);
  cursor: not-allowed;
  transform: none;
  box-shadow: none;
  opacity: 0.7;
}

.btn-verify-otp {
  background: linear-gradient(135deg, #10b981 0%, #059669 100%);
  color: white;
  margin: 0;
  width: 100%;
  max-width: 280px;
}

.btn-verify-otp:hover:not(:disabled) {
  background: linear-gradient(135deg, #059669 0%, #047857 100%);
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
}

.btn-verify-otp:active:not(:disabled) {
  transform: translateY(0);
  box-shadow: 0 2px 6px rgba(16, 185, 129, 0.3);
}

.btn-verify-otp:disabled {
  background: linear-gradient(135deg, #9ca3af 0%, #6b7280 100%);
  cursor: not-allowed;
  transform: none;
  box-shadow: none;
  opacity: 0.7;
}

.btn-resend-otp {
  background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
  color: white;
}

.btn-resend-otp:hover {
  background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
}

.btn-resend-otp:active {
  transform: translateY(0);
  box-shadow: 0 2px 6px rgba(59, 130, 246, 0.3);
}

.otp-input-group {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 12px;
  margin: 0;
  max-width: 400px;
  width: 100%;
}

.otp-input {
  width: 100%;
  max-width: 280px;
  padding: 14px 20px;
  border: 2px solid #d1d5db;
  border-radius: 12px;
  font-size: 24px;
  font-weight: 700;
  text-align: center;
  letter-spacing: 8px;
  transition: all 0.3s ease;
  background: white;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
}

.otp-input:focus {
  outline: none;
  border-color: #dc2626;
  box-shadow: 0 0 0 4px rgba(220, 38, 38, 0.15), 0 2px 8px rgba(220, 38, 38, 0.2);
  transform: scale(1.02);
}

.otp-input.verified {
  border-color: #10b981;
  background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
  animation: verifiedPulse 0.5s ease;
}

@keyframes verifiedPulse {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.05); }
}

.dark-theme .otp-input {
  background: #1f2937;
  border-color: #4b5563;
  color: #d1d5db;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
}

.dark-theme .otp-input:focus {
  border-color: #ef4444;
  box-shadow: 0 0 0 4px rgba(239, 68, 68, 0.15), 0 2px 8px rgba(239, 68, 68, 0.2);
}

.dark-theme .otp-input.verified {
  border-color: #10b981;
  background: linear-gradient(135deg, #064e3b 0%, #047857 100%);
}

/* Locked phone input styling */
.phone-input.otp-locked,
.country-select.otp-locked {
  background: #f3f4f6 !important;
  cursor: not-allowed;
  opacity: 0.8;
  position: relative;
}

.phone-input.otp-locked::after {
  content: 'ðŸ”’';
  position: absolute;
  right: 10px;
  top: 50%;
  transform: translateY(-50%);
  pointer-events: none;
  font-size: 16px;
}

.dark-theme .phone-input.otp-locked,
.dark-theme .country-select.otp-locked {
  background: #374151 !important;
}

.phone-input-group:has(.otp-locked) {
  border-color: #10b981;
  background: rgba(16, 185, 129, 0.05);
}

.dark-theme .phone-input-group:has(.otp-locked) {
  background: rgba(16, 185, 129, 0.1);
}

.otp-status {
  margin: 0;
  font-size: 14px;
  font-weight: 500;
  min-height: 22px;
  text-align: center;
  padding: 6px 14px;
  border-radius: 8px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  transition: all 0.3s ease;
  width: 100%;
  max-width: 400px;
}

.otp-status.success {
  color: #10b981;
  background: rgba(16, 185, 129, 0.1);
  border: 1px solid rgba(16, 185, 129, 0.2);
}

.otp-status.error {
  color: #ef4444;
  background: rgba(239, 68, 68, 0.1);
  border: 1px solid rgba(239, 68, 68, 0.2);
}

.otp-status.info {
  color: #3b82f6;
  background: rgba(59, 130, 246, 0.1);
  border: 1px solid rgba(59, 130, 246, 0.2);
}

.otp-timer {
  margin: 0;
  font-size: 14px;
  color: #6b7280;
  font-weight: 600;
  text-align: center;
  padding: 8px 16px;
  background: rgba(107, 114, 128, 0.1);
  border-radius: 8px;
  display: inline-flex;
  align-items: center;
  gap: 6px;
}

.otp-timer i {
  font-size: 12px;
}

.dark-theme .otp-timer {
  color: #9ca3af;
  background: rgba(156, 163, 175, 0.1);
}

.otp-timer span {
  font-weight: 700;
  color: #dc2626;
  font-size: 16px;
}

.dark-theme .otp-timer span {
  color: #ef4444;
}

@media (max-width: 768px) {
  .otp-verification-section {
    padding: 16px;
    margin-top: 12px;
  }

  .otp-input-group {
    gap: 12px;
    max-width: 100%;
  }

  .otp-input {
    max-width: 100%;
    width: 100%;
  }
  
  .btn-verify-otp {
    width: 100%;
    max-width: 100%;
    justify-content: center;
  }

  .btn-send-otp, .btn-resend-otp {
    width: 100%;
    max-width: 100%;
  }
}

/* Terms and Conditions Checkbox Styling */
.form-check-modern {
  display: flex;
  align-items: flex-start;
  gap: 12px;
  margin: 20px 0;
  padding: 16px;
  background: #f8f9fa;
  border-radius: 12px;
  border: 2px solid transparent;
  transition: all 0.3s ease;
}

.form-check-modern:hover {
  background: #f3f4f6;
  border-color: #e5e7eb;
}

.form-check-input-modern {
  width: 20px;
  height: 20px;
  margin: 0;
  cursor: pointer;
  accent-color: #dc2626;
  border-radius: 4px;
  border: 2px solid #d1d5db;
  background-color: #fff;
  transition: all 0.3s ease;
  flex-shrink: 0;
  margin-top: 2px;
}

.form-check-input-modern:checked {
  background-color: #dc2626;
  border-color: #dc2626;
}

.form-check-input-modern:focus {
  outline: none;
  box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.1);
}

.form-check-label-modern {
  font-size: 14px;
  line-height: 1.5;
  color: #374151;
  cursor: pointer;
  margin: 0;
  flex: 1;
}

.terms-link {
  color: #dc2626;
  text-decoration: none;
  font-weight: 500;
  transition: color 0.3s ease;
}

.terms-link:hover {
  color: #b91c1c;
  text-decoration: underline;
}

/* Dark theme support for checkbox */
.dark-theme .form-check-modern {
  background: #374151;
  border-color: #4b5563;
}

.dark-theme .form-check-modern:hover {
  background: #4b5563;
  border-color: #6b7280;
}

.dark-theme .form-check-input-modern {
  background-color: #1f2937;
  border-color: #6b7280;
}

.dark-theme .form-check-input-modern:checked {
  background-color: #ef4444;
  border-color: #ef4444;
}

.dark-theme .form-check-input-modern:focus {
  box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1);
}

.dark-theme .form-check-label-modern {
  color: #d1d5db;
}

.dark-theme .terms-link {
  color: #ef4444;
}

.dark-theme .terms-link:hover {
  color: #fca5a5;
}

/* Responsive design for checkbox */
@media (max-width: 768px) {
  .form-check-modern {
    padding: 12px;
    gap: 10px;
  }
  
  .form-check-input-modern {
    width: 18px;
    height: 18px;
  }
  
  .form-check-label-modern {
    font-size: 13px;
  }
}

/* ============================================ */
/* Field Validation Error/Success Styling */
/* ============================================ */

/* Field Error Message Styling */
.field-error-message {
  color: #dc3545;
  font-size: 0.85rem;
  margin-top: 8px;
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 8px 12px;
  background: rgba(220, 53, 69, 0.1);
  border-left: 3px solid #dc3545;
  border-radius: 6px;
  animation: slideInError 0.3s ease;
}

.field-error-message i {
  font-size: 0.9rem;
  color: #dc3545;
  flex-shrink: 0;
}

@keyframes slideInError {
  from {
    opacity: 0;
    transform: translateY(-5px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

/* Valid field styling */
.form-control-modern.is-valid,
.form-control-modern.is-valid:focus {
  border-color: #28a745;
  box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.1);
}

.form-control-modern.is-valid:focus {
  box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.15);
}

/* Invalid field styling */
.form-control-modern.is-invalid {
  border-color: #dc3545;
  box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.1);
}

.form-control-modern.is-invalid:focus {
  border-color: #dc3545;
  box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.15);
}

/* Select element validation */
.form-control-modern.is-invalid select,
select.form-control-modern.is-invalid {
  border-color: #dc3545;
}

.form-control-modern.is-valid select,
select.form-control-modern.is-valid {
  border-color: #28a745;
}

/* Textarea validation */
textarea.form-control-modern.is-invalid {
  border-color: #dc3545;
}

textarea.form-control-modern.is-valid {
  border-color: #28a745;
}

/* Phone input group validation */
.phone-input-group.has-error {
  border-color: #dc3545;
  background: #fff;
  box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.1);
}

.phone-input-group.has-success {
  border-color: #28a745;
  background: #fff;
  box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.1);
}

/* Disabled button styling */
.btn-nav.btn-disabled,
.btn-nav:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  pointer-events: none;
  background: #e9ecef !important;
  border-color: #dee2e6 !important;
  color: #6c757d !important;
}

.btn-nav.btn-disabled:hover,
.btn-nav:disabled:hover {
  transform: none !important;
  background: #e9ecef !important;
  border-color: #dee2e6 !important;
  color: #6c757d !important;
}

.btn-nav.btn-disabled i,
.btn-nav:disabled i {
  color: #6c757d !important;
}

/* Step completed indicator */
.step-item.completed .step-number {
  background: #28a745 !important;
  box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
  position: relative;
}

.step-item.completed .step-number::after {
  content: 'âœ“';
  position: absolute;
  color: white;
  font-size: 1.2rem;
  font-weight: bold;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
}

/* Checkbox validation */
.form-check-modern.has-error {
  border-color: #dc3545;
  background: rgba(220, 53, 69, 0.05);
}

.form-check-modern.has-success {
  border-color: #28a745;
  background: rgba(40, 167, 69, 0.05);
}

/* Dark theme error messages */
.dark-theme .field-error-message {
  background: rgba(220, 53, 69, 0.2);
  color: #ff6b6b;
  border-left-color: #ff6b6b;
}

.dark-theme .field-error-message i {
  color: #ff6b6b;
}

.dark-theme .form-control-modern.is-invalid {
  border-color: #ff6b6b;
  box-shadow: 0 0 0 3px rgba(255, 107, 107, 0.15);
}

.dark-theme .form-control-modern.is-valid {
  border-color: #51cf66;
  box-shadow: 0 0 0 3px rgba(81, 207, 102, 0.15);
}

.dark-theme .phone-input-group.has-error {
  border-color: #ff6b6b;
  background: #1f2937;
  box-shadow: 0 0 0 3px rgba(255, 107, 107, 0.15);
}

.dark-theme .phone-input-group.has-success {
  border-color: #51cf66;
  background: #1f2937;
  box-shadow: 0 0 0 3px rgba(81, 207, 102, 0.15);
}

.dark-theme .btn-nav.btn-disabled,
.dark-theme .btn-nav:disabled {
  background: #374151 !important;
  border-color: #4b5563 !important;
  color: #9ca3af !important;
}

.dark-theme .form-check-modern.has-error {
  border-color: #ff6b6b;
  background: rgba(255, 107, 107, 0.1);
}

.dark-theme .form-check-modern.has-success {
  border-color: #51cf66;
  background: rgba(81, 207, 102, 0.1);
}

/* Smooth transitions */
.form-control-modern,
.phone-input-group,
.form-check-modern {
  transition: all 0.3s ease;
}

/* Focus states for validation */
.form-group-modern:has(.is-invalid) .form-label-modern {
  color: #dc3545;
}

.form-group-modern:has(.is-valid) .form-label-modern {
  color: #28a745;
}

.dark-theme .form-group-modern:has(.is-invalid) .form-label-modern {
  color: #ff6b6b;
}

.dark-theme .form-group-modern:has(.is-valid) .form-label-modern {
  color: #51cf66;
}
</style>

<!-- Theme Manager -->
<script src="/js/theme-manager.js"></script>

<!-- Auth Common JavaScript -->
<script src="/js/auth-common.js"></script>

<!-- Auth Animations -->
<script src="/js/auth-animations.js"></script>

<!-- Comprehensive Step-by-Step Validation JavaScript -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  // ============================================
  // Configuration
  // ============================================
  // Phone length standards for specific countries (optional validation)
  // If a country is not listed, we use a flexible range of 7-15 digits
  const phoneLengthStandards = {
    '+966': 9,  // Saudi Arabia: 9 digits
    '+20': 11,  // Egypt: 11 digits (including leading 0)
    '+971': 9,  // UAE: 9 digits
    '+965': 8,  // Kuwait: 8 digits
    '+1': 10,   // US/Canada: 10 digits
    '+44': 10,  // UK: 10 digits
    '+91': 10,  // India: 10 digits
    '+86': 11,  // China: 11 digits
    '+81': 10,  // Japan: 10 digits
    '+49': 11,  // Germany: 11 digits
    '+33': 9,   // France: 9 digits
    '+39': 10,  // Italy: 10 digits
    '+34': 9,   // Spain: 9 digits
    '+7': 10,   // Russia/Kazakhstan: 10 digits
    '+82': 10,  // South Korea: 10 digits
    '+61': 9,   // Australia: 9 digits
    '+55': 11,  // Brazil: 11 digits
    '+52': 10,  // Mexico: 10 digits
    '+27': 9,   // South Africa: 9 digits
    '+90': 10,  // Turkey: 10 digits
    '+92': 10,  // Pakistan: 10 digits
    '+62': 10,  // Indonesia: 10 digits
    '+63': 10,  // Philippines: 10 digits
    '+84': 10,  // Vietnam: 10 digits
    '+66': 9,   // Thailand: 9 digits
    '+60': 9,   // Malaysia: 9 digits
    '+65': 8,   // Singapore: 8 digits
    '+64': 8,   // New Zealand: 8 digits
    '+31': 9,   // Netherlands: 9 digits
    '+32': 9,   // Belgium: 9 digits
    '+41': 9,   // Switzerland: 9 digits
    '+46': 9,   // Sweden: 9 digits
    '+47': 8,   // Norway: 8 digits
    '+45': 8,   // Denmark: 8 digits
    '+358': 9,  // Finland: 9 digits
    '+351': 9,  // Portugal: 9 digits
    '+30': 10,  // Greece: 10 digits
    '+48': 9,   // Poland: 9 digits
    '+40': 10,  // Romania: 10 digits
    '+36': 9,   // Hungary: 9 digits
    '+420': 9,  // Czech Republic: 9 digits
    '+421': 9,  // Slovakia: 9 digits
    '+385': 9,  // Croatia: 9 digits
    '+386': 8,  // Slovenia: 8 digits
    '+359': 9,  // Bulgaria: 9 digits
    '+372': 8,  // Estonia: 8 digits
    '+371': 8,  // Latvia: 8 digits
    '+370': 8,  // Lithuania: 8 digits
    '+353': 9,  // Ireland: 9 digits
    '+354': 7,  // Iceland: 7 digits
    '+352': 9,  // Luxembourg: 9 digits
    '+356': 8,  // Malta: 8 digits
    '+357': 8,  // Cyprus: 8 digits
    '+43': 10,  // Austria: 10 digits
    '+961': 8,  // Lebanon: 8 digits
    '+962': 9,  // Jordan: 9 digits
    '+974': 8,  // Qatar: 8 digits
    '+968': 8,  // Oman: 8 digits
    '+973': 8,  // Bahrain: 8 digits
    '+212': 9,  // Morocco: 9 digits
    '+213': 9,  // Algeria: 9 digits
    '+216': 8,  // Tunisia: 8 digits
    '+218': 9,  // Libya: 9 digits
    '+20': 11,  // Egypt: 11 digits (already listed, but keeping for clarity)
    '+234': 10, // Nigeria: 10 digits
    '+254': 9,  // Kenya: 9 digits
    '+27': 9,   // South Africa: 9 digits (already listed)
    '+233': 9,  // Ghana: 9 digits
    '+256': 9,  // Uganda: 9 digits
    '+255': 9,  // Tanzania: 9 digits
    '+251': 9,  // Ethiopia: 9 digits
    '+880': 10, // Bangladesh: 10 digits
    '+94': 9,   // Sri Lanka: 9 digits
    '+977': 10, // Nepal: 10 digits
    '+975': 8,  // Bhutan: 8 digits
    '+95': 9,   // Myanmar: 9 digits
    '+856': 8,  // Laos: 8 digits
    '+855': 9,  // Cambodia: 9 digits
    '+84': 10,  // Vietnam: 10 digits (already listed)
    '+66': 9,   // Thailand: 9 digits (already listed)
    '+60': 9,   // Malaysia: 9 digits (already listed)
    '+65': 8,   // Singapore: 8 digits (already listed)
    '+62': 10,  // Indonesia: 10 digits (already listed)
    '+63': 10,  // Philippines: 10 digits (already listed)
    '+61': 9,   // Australia: 9 digits (already listed)
    '+64': 8,   // New Zealand: 8 digits (already listed)
    '+679': 7,  // Fiji: 7 digits
    '+676': 5,  // Tonga: 5 digits
    '+685': 7,  // Samoa: 7 digits
    '+687': 6,  // New Caledonia: 6 digits
    '+689': 6,  // French Polynesia: 6 digits
    '+55': 11,  // Brazil: 11 digits (already listed)
    '+54': 10,  // Argentina: 10 digits
    '+56': 9,   // Chile: 9 digits
    '+57': 10,  // Colombia: 10 digits
    '+51': 9,   // Peru: 9 digits
    '+593': 9,  // Ecuador: 9 digits
    '+58': 10,  // Venezuela: 10 digits
    '+595': 9,  // Paraguay: 9 digits
    '+598': 8,  // Uruguay: 8 digits
    '+591': 8,  // Bolivia: 8 digits
    '+592': 7,  // Guyana: 7 digits
    '+597': 7,  // Suriname: 7 digits
    '+594': 9,  // French Guiana: 9 digits
    '+1-242': 7, // Bahamas: 7 digits
    '+1-246': 7, // Barbados: 7 digits
    '+1-268': 7, // Antigua and Barbuda: 7 digits
    '+1-284': 7, // British Virgin Islands: 7 digits
    '+1-340': 7, // US Virgin Islands: 7 digits
    '+1-441': 7, // Bermuda: 7 digits
    '+1-473': 7, // Grenada: 7 digits
    '+1-649': 7, // Turks and Caicos: 7 digits
    '+1-658': 7, // Jamaica: 7 digits
    '+1-670': 7, // Northern Mariana Islands: 7 digits
    '+1-671': 7, // Guam: 7 digits
    '+1-758': 7, // Saint Lucia: 7 digits
    '+1-767': 7, // Dominica: 7 digits
    '+1-784': 7, // Saint Vincent and the Grenadines: 7 digits
    '+1-809': 7, // Dominican Republic: 7 digits
    '+1-868': 7, // Trinidad and Tobago: 7 digits
    '+1-869': 7, // Saint Kitts and Nevis: 7 digits
    '+1-876': 7, // Jamaica: 7 digits
    '+1-939': 7, // Puerto Rico: 7 digits
    '+7': 10,   // Russia/Kazakhstan: 10 digits (already listed)
    '+380': 9,  // Ukraine: 9 digits
    '+375': 9,  // Belarus: 9 digits
    '+370': 8,  // Lithuania: 8 digits (already listed)
    '+371': 8,  // Latvia: 8 digits (already listed)
    '+372': 8,  // Estonia: 8 digits (already listed)
    '+373': 8,  // Moldova: 8 digits
    '+374': 8,  // Armenia: 8 digits
    '+375': 9,  // Belarus: 9 digits (already listed)
    '+376': 6,  // Andorra: 6 digits
    '+377': 8,  // Monaco: 8 digits
    '+378': 10, // San Marino: 10 digits
    '+379': 0,  // Vatican City: variable
    '+380': 9,  // Ukraine: 9 digits (already listed)
    '+381': 9,  // Serbia: 9 digits
    '+382': 8,  // Montenegro: 8 digits
    '+383': 8,  // Kosovo: 8 digits
    '+385': 9,  // Croatia: 9 digits (already listed)
    '+386': 8,  // Slovenia: 8 digits (already listed)
    '+387': 8,  // Bosnia and Herzegovina: 8 digits
    '+389': 8,  // North Macedonia: 8 digits
    '+390': 10, // Vatican City (alternative): 10 digits
    '+420': 9,  // Czech Republic: 9 digits (already listed)
    '+421': 9,  // Slovakia: 9 digits (already listed)
    '+423': 7,  // Liechtenstein: 7 digits
    '+500': 5,  // Falkland Islands: 5 digits
    '+501': 7,  // Belize: 7 digits
    '+502': 8,  // Guatemala: 8 digits
    '+503': 8,  // El Salvador: 8 digits
    '+504': 8,  // Honduras: 8 digits
    '+505': 8,  // Nicaragua: 8 digits
    '+506': 8,  // Costa Rica: 8 digits
    '+507': 8,  // Panama: 8 digits
    '+508': 6,  // Saint Pierre and Miquelon: 6 digits
    '+509': 8,  // Haiti: 8 digits
    '+590': 9,  // Guadeloupe: 9 digits
    '+591': 8,  // Bolivia: 8 digits (already listed)
    '+592': 7,  // Guyana: 7 digits (already listed)
    '+593': 9,  // Ecuador: 9 digits (already listed)
    '+594': 9,  // French Guiana: 9 digits (already listed)
    '+595': 9,  // Paraguay: 9 digits (already listed)
    '+596': 9,  // Martinique: 9 digits
    '+597': 7,  // Suriname: 7 digits (already listed)
    '+598': 8,  // Uruguay: 8 digits (already listed)
    '+599': 7,  // Netherlands Antilles: 7 digits
    '+670': 7,  // East Timor: 7 digits
    '+672': 5,  // Australian External Territories: 5 digits
    '+673': 7,  // Brunei: 7 digits
    '+674': 7,  // Nauru: 7 digits
    '+675': 7,  // Papua New Guinea: 7 digits
    '+676': 5,  // Tonga: 5 digits (already listed)
    '+677': 5,  // Solomon Islands: 5 digits
    '+678': 5,  // Vanuatu: 5 digits
    '+679': 7,  // Fiji: 7 digits (already listed)
    '+680': 7,  // Palau: 7 digits
    '+681': 6,  // Wallis and Futuna: 6 digits
    '+682': 5,  // Cook Islands: 5 digits
    '+683': 4,  // Niue: 4 digits
    '+684': 7,  // American Samoa: 7 digits
    '+685': 7,  // Samoa: 7 digits (already listed)
    '+686': 5,  // Kiribati: 5 digits
    '+687': 6,  // New Caledonia: 6 digits (already listed)
    '+688': 5,  // Tuvalu: 5 digits
    '+689': 6,  // French Polynesia: 6 digits (already listed)
    '+690': 4,  // Tokelau: 4 digits
    '+691': 7,  // Micronesia: 7 digits
    '+692': 7,  // Marshall Islands: 7 digits
    '+850': 8,  // North Korea: 8 digits
    '+852': 8,  // Hong Kong: 8 digits
    '+853': 8,  // Macau: 8 digits
    '+855': 9,  // Cambodia: 9 digits (already listed)
    '+856': 8,  // Laos: 8 digits (already listed)
    '+880': 10, // Bangladesh: 10 digits (already listed)
    '+886': 9,  // Taiwan: 9 digits
    '+960': 7,  // Maldives: 7 digits
    '+961': 8,  // Lebanon: 8 digits (already listed)
    '+962': 9,  // Jordan: 9 digits (already listed)
    '+963': 9,  // Syria: 9 digits
    '+964': 10, // Iraq: 10 digits
    '+965': 8,  // Kuwait: 8 digits (already listed)
    '+966': 9,  // Saudi Arabia: 9 digits (already listed)
    '+967': 9,  // Yemen: 9 digits
    '+968': 8,  // Oman: 8 digits (already listed)
    '+970': 9,  // Palestine: 9 digits
    '+971': 9,  // UAE: 9 digits (already listed)
    '+973': 8,  // Bahrain: 8 digits (already listed)
    '+974': 8,  // Qatar: 8 digits (already listed)
    '+975': 8,  // Bhutan: 8 digits (already listed)
    '+976': 8,  // Mongolia: 8 digits
    '+977': 10, // Nepal: 10 digits (already listed)
    '+992': 9,  // Tajikistan: 9 digits
    '+993': 8,  // Turkmenistan: 8 digits
    '+994': 9,  // Azerbaijan: 9 digits
    '+995': 9,  // Georgia: 9 digits
    '+996': 9,  // Kyrgyzstan: 9 digits
    '+998': 9   // Uzbekistan: 9 digits
  };
  
  // Default phone length range for countries not in the list
  const DEFAULT_MIN_PHONE_LENGTH = 7;
  const DEFAULT_MAX_PHONE_LENGTH = 15;

  // ============================================
  // DOM Elements
  // ============================================
  const form = document.querySelector('.auth-form');
  const nextStepBtn = document.getElementById('nextStep');
  const prevStepBtn = document.getElementById('prevStep');
  const submitBtn = document.getElementById('submitBtn');
  const formSteps = document.querySelectorAll('.form-step');
  const stepItems = document.querySelectorAll('.step-item');
  
  // Step 1 Fields
  const firstNameInput = document.getElementById('firstName');
  const lastNameInput = document.getElementById('lastName');
  const studentNumberInput = document.getElementById('studentNumber');
  const studentCountrySelect = document.getElementById('studentCountryCode');
  const parentNumberInput = document.getElementById('parentNumber');
  const parentCountrySelect = document.getElementById('parentCountryCode');
  const studentEmailInput = document.getElementById('studentEmail');
  const usernameInput = document.getElementById('username');
  
  // Step 2 Fields
  const schoolNameInput = document.getElementById('schoolName');
  const gradeSelect = document.getElementById('grade');
  const englishTeacherInput = document.getElementById('englishTeacher');
  
  // Step 3 Fields
  const passwordInput = document.getElementById('password');
  const password2Input = document.getElementById('password2');
  const howDidYouKnowInput = document.getElementById('howDidYouKnow');
  const howDidYouKnowOtherInput = document.getElementById('howDidYouKnowOther');
  const howDidYouKnowOtherContainer = document.getElementById('howDidYouKnowOtherContainer');

  // Current step tracker
  let currentStep = 1;
  const totalSteps = 3;
  
  // Comprehensive country list with country codes
  const countries = [
    { code: '+93', name: 'Afghanistan', flag: 'ðŸ‡¦ðŸ‡«' },
    { code: '+355', name: 'Albania', flag: 'ðŸ‡¦ðŸ‡±' },
    { code: '+213', name: 'Algeria', flag: 'ðŸ‡©ðŸ‡¿' },
    { code: '+376', name: 'Andorra', flag: 'ðŸ‡¦ðŸ‡©' },
    { code: '+244', name: 'Angola', flag: 'ðŸ‡¦ðŸ‡´' },
    { code: '+1-268', name: 'Antigua and Barbuda', flag: 'ðŸ‡¦ðŸ‡¬' },
    { code: '+54', name: 'Argentina', flag: 'ðŸ‡¦ðŸ‡·' },
    { code: '+374', name: 'Armenia', flag: 'ðŸ‡¦ðŸ‡²' },
    { code: '+61', name: 'Australia', flag: 'ðŸ‡¦ðŸ‡º' },
    { code: '+43', name: 'Austria', flag: 'ðŸ‡¦ðŸ‡¹' },
    { code: '+994', name: 'Azerbaijan', flag: 'ðŸ‡¦ðŸ‡¿' },
    { code: '+1-242', name: 'Bahamas', flag: 'ðŸ‡§ðŸ‡¸' },
    { code: '+973', name: 'Bahrain', flag: 'ðŸ‡§ðŸ‡­' },
    { code: '+880', name: 'Bangladesh', flag: 'ðŸ‡§ðŸ‡©' },
    { code: '+1-246', name: 'Barbados', flag: 'ðŸ‡§ðŸ‡§' },
    { code: '+375', name: 'Belarus', flag: 'ðŸ‡§ðŸ‡¾' },
    { code: '+32', name: 'Belgium', flag: 'ðŸ‡§ðŸ‡ª' },
    { code: '+501', name: 'Belize', flag: 'ðŸ‡§ðŸ‡¿' },
    { code: '+229', name: 'Benin', flag: 'ðŸ‡§ðŸ‡¯' },
    { code: '+975', name: 'Bhutan', flag: 'ðŸ‡§ðŸ‡¹' },
    { code: '+591', name: 'Bolivia', flag: 'ðŸ‡§ðŸ‡´' },
    { code: '+387', name: 'Bosnia and Herzegovina', flag: 'ðŸ‡§ðŸ‡¦' },
    { code: '+267', name: 'Botswana', flag: 'ðŸ‡§ðŸ‡¼' },
    { code: '+55', name: 'Brazil', flag: 'ðŸ‡§ðŸ‡·' },
    { code: '+673', name: 'Brunei Darussalam', flag: 'ðŸ‡§ðŸ‡³' },
    { code: '+359', name: 'Bulgaria', flag: 'ðŸ‡§ðŸ‡¬' },
    { code: '+226', name: 'Burkina Faso', flag: 'ðŸ‡§ðŸ‡«' },
    { code: '+257', name: 'Burundi', flag: 'ðŸ‡§ðŸ‡®' },
    { code: '+238', name: 'Cabo Verde', flag: 'ðŸ‡¨ðŸ‡»' },
    { code: '+855', name: 'Cambodia', flag: 'ðŸ‡°ðŸ‡­' },
    { code: '+237', name: 'Cameroon', flag: 'ðŸ‡¨ðŸ‡²' },
    { code: '+1', name: 'Canada', flag: 'ðŸ‡¨ðŸ‡¦' },
    { code: '+236', name: 'Central African Republic', flag: 'ðŸ‡¨ðŸ‡«' },
    { code: '+235', name: 'Chad', flag: 'ðŸ‡¹ðŸ‡©' },
    { code: '+56', name: 'Chile', flag: 'ðŸ‡¨ðŸ‡±' },
    { code: '+86', name: 'China', flag: 'ðŸ‡¨ðŸ‡³' },
    { code: '+57', name: 'Colombia', flag: 'ðŸ‡¨ðŸ‡´' },
    { code: '+269', name: 'Comoros', flag: 'ðŸ‡°ðŸ‡²' },
    { code: '+242', name: 'Congo', flag: 'ðŸ‡¨ðŸ‡¬' },
    { code: '+243', name: 'Congo, Democratic Republic', flag: 'ðŸ‡¨ðŸ‡©' },
    { code: '+506', name: 'Costa Rica', flag: 'ðŸ‡¨ðŸ‡·' },
    { code: '+225', name: 'CÃ´te d\'Ivoire', flag: 'ðŸ‡¨ðŸ‡®' },
    { code: '+385', name: 'Croatia', flag: 'ðŸ‡­ðŸ‡·' },
    { code: '+53', name: 'Cuba', flag: 'ðŸ‡¨ðŸ‡º' },
    { code: '+357', name: 'Cyprus', flag: 'ðŸ‡¨ðŸ‡¾' },
    { code: '+420', name: 'Czechia', flag: 'ðŸ‡¨ðŸ‡¿' },
    { code: '+45', name: 'Denmark', flag: 'ðŸ‡©ðŸ‡°' },
    { code: '+253', name: 'Djibouti', flag: 'ðŸ‡©ðŸ‡¯' },
    { code: '+1-767', name: 'Dominica', flag: 'ðŸ‡©ðŸ‡²' },
    { code: '+1-809', name: 'Dominican Republic', flag: 'ðŸ‡©ðŸ‡´' },
    { code: '+593', name: 'Ecuador', flag: 'ðŸ‡ªðŸ‡¨' },
    { code: '+20', name: 'Egypt', flag: 'ðŸ‡ªðŸ‡¬' },
    { code: '+503', name: 'El Salvador', flag: 'ðŸ‡¸ðŸ‡»' },
    { code: '+240', name: 'Equatorial Guinea', flag: 'ðŸ‡¬ðŸ‡¶' },
    { code: '+291', name: 'Eritrea', flag: 'ðŸ‡ªðŸ‡·' },
    { code: '+372', name: 'Estonia', flag: 'ðŸ‡ªðŸ‡ª' },
    { code: '+268', name: 'Eswatini', flag: 'ðŸ‡¸ðŸ‡¿' },
    { code: '+251', name: 'Ethiopia', flag: 'ðŸ‡ªðŸ‡¹' },
    { code: '+679', name: 'Fiji', flag: 'ðŸ‡«ðŸ‡¯' },
    { code: '+358', name: 'Finland', flag: 'ðŸ‡«ðŸ‡®' },
    { code: '+33', name: 'France', flag: 'ðŸ‡«ðŸ‡·' },
    { code: '+241', name: 'Gabon', flag: 'ðŸ‡¬ðŸ‡¦' },
    { code: '+220', name: 'Gambia', flag: 'ðŸ‡¬ðŸ‡²' },
    { code: '+995', name: 'Georgia', flag: 'ðŸ‡¬ðŸ‡ª' },
    { code: '+49', name: 'Germany', flag: 'ðŸ‡©ðŸ‡ª' },
    { code: '+233', name: 'Ghana', flag: 'ðŸ‡¬ðŸ‡­' },
    { code: '+30', name: 'Greece', flag: 'ðŸ‡¬ðŸ‡·' },
    { code: '+1-473', name: 'Grenada', flag: 'ðŸ‡¬ðŸ‡©' },
    { code: '+502', name: 'Guatemala', flag: 'ðŸ‡¬ðŸ‡¹' },
    { code: '+224', name: 'Guinea', flag: 'ðŸ‡¬ðŸ‡³' },
    { code: '+245', name: 'Guinea-Bissau', flag: 'ðŸ‡¬ðŸ‡¼' },
    { code: '+592', name: 'Guyana', flag: 'ðŸ‡¬ðŸ‡¾' },
    { code: '+509', name: 'Haiti', flag: 'ðŸ‡­ðŸ‡¹' },
    { code: '+504', name: 'Honduras', flag: 'ðŸ‡­ðŸ‡³' },
    { code: '+36', name: 'Hungary', flag: 'ðŸ‡­ðŸ‡º' },
    { code: '+354', name: 'Iceland', flag: 'ðŸ‡®ðŸ‡¸' },
    { code: '+91', name: 'India', flag: 'ðŸ‡®ðŸ‡³' },
    { code: '+62', name: 'Indonesia', flag: 'ðŸ‡®ðŸ‡©' },
    { code: '+98', name: 'Iran', flag: 'ðŸ‡®ðŸ‡·' },
    { code: '+964', name: 'Iraq', flag: 'ðŸ‡®ðŸ‡¶' },
    { code: '+353', name: 'Ireland', flag: 'ðŸ‡®ðŸ‡ª' },
    { code: '+39', name: 'Italy', flag: 'ðŸ‡®ðŸ‡¹' },
    { code: '+1-876', name: 'Jamaica', flag: 'ðŸ‡¯ðŸ‡²' },
    { code: '+81', name: 'Japan', flag: 'ðŸ‡¯ðŸ‡µ' },
    { code: '+962', name: 'Jordan', flag: 'ðŸ‡¯ðŸ‡´' },
    { code: '+7', name: 'Kazakhstan', flag: 'ðŸ‡°ðŸ‡¿' },
    { code: '+254', name: 'Kenya', flag: 'ðŸ‡°ðŸ‡ª' },
    { code: '+686', name: 'Kiribati', flag: 'ðŸ‡°ðŸ‡®' },
    { code: '+850', name: 'Korea, North', flag: 'ðŸ‡°ðŸ‡µ' },
    { code: '+82', name: 'Korea, South', flag: 'ðŸ‡°ðŸ‡·' },
    { code: '+965', name: 'Kuwait', flag: 'ðŸ‡°ðŸ‡¼' },
    { code: '+996', name: 'Kyrgyzstan', flag: 'ðŸ‡°ðŸ‡¬' },
    { code: '+856', name: 'Laos', flag: 'ðŸ‡±ðŸ‡¦' },
    { code: '+371', name: 'Latvia', flag: 'ðŸ‡±ðŸ‡»' },
    { code: '+961', name: 'Lebanon', flag: 'ðŸ‡±ðŸ‡§' },
    { code: '+266', name: 'Lesotho', flag: 'ðŸ‡±ðŸ‡¸' },
    { code: '+231', name: 'Liberia', flag: 'ðŸ‡±ðŸ‡·' },
    { code: '+218', name: 'Libya', flag: 'ðŸ‡±ðŸ‡¾' },
    { code: '+423', name: 'Liechtenstein', flag: 'ðŸ‡±ðŸ‡®' },
    { code: '+370', name: 'Lithuania', flag: 'ðŸ‡±ðŸ‡¹' },
    { code: '+352', name: 'Luxembourg', flag: 'ðŸ‡±ðŸ‡º' },
    { code: '+261', name: 'Madagascar', flag: 'ðŸ‡²ðŸ‡¬' },
    { code: '+265', name: 'Malawi', flag: 'ðŸ‡²ðŸ‡¼' },
    { code: '+60', name: 'Malaysia', flag: 'ðŸ‡²ðŸ‡¾' },
    { code: '+960', name: 'Maldives', flag: 'ðŸ‡²ðŸ‡»' },
    { code: '+223', name: 'Mali', flag: 'ðŸ‡²ðŸ‡±' },
    { code: '+356', name: 'Malta', flag: 'ðŸ‡²ðŸ‡¹' },
    { code: '+692', name: 'Marshall Islands', flag: 'ðŸ‡²ðŸ‡­' },
    { code: '+222', name: 'Mauritania', flag: 'ðŸ‡²ðŸ‡·' },
    { code: '+230', name: 'Mauritius', flag: 'ðŸ‡²ðŸ‡º' },
    { code: '+52', name: 'Mexico', flag: 'ðŸ‡²ðŸ‡½' },
    { code: '+691', name: 'Micronesia', flag: 'ðŸ‡«ðŸ‡²' },
    { code: '+373', name: 'Moldova', flag: 'ðŸ‡²ðŸ‡©' },
    { code: '+377', name: 'Monaco', flag: 'ðŸ‡²ðŸ‡¨' },
    { code: '+976', name: 'Mongolia', flag: 'ðŸ‡²ðŸ‡³' },
    { code: '+382', name: 'Montenegro', flag: 'ðŸ‡²ðŸ‡ª' },
    { code: '+212', name: 'Morocco', flag: 'ðŸ‡²ðŸ‡¦' },
    { code: '+258', name: 'Mozambique', flag: 'ðŸ‡²ðŸ‡¿' },
    { code: '+95', name: 'Myanmar', flag: 'ðŸ‡²ðŸ‡²' },
    { code: '+264', name: 'Namibia', flag: 'ðŸ‡³ðŸ‡¦' },
    { code: '+674', name: 'Nauru', flag: 'ðŸ‡³ðŸ‡·' },
    { code: '+977', name: 'Nepal', flag: 'ðŸ‡³ðŸ‡µ' },
    { code: '+31', name: 'Netherlands', flag: 'ðŸ‡³ðŸ‡±' },
    { code: '+64', name: 'New Zealand', flag: 'ðŸ‡³ðŸ‡¿' },
    { code: '+505', name: 'Nicaragua', flag: 'ðŸ‡³ðŸ‡®' },
    { code: '+227', name: 'Niger', flag: 'ðŸ‡³ðŸ‡ª' },
    { code: '+234', name: 'Nigeria', flag: 'ðŸ‡³ðŸ‡¬' },
    { code: '+389', name: 'North Macedonia', flag: 'ðŸ‡²ðŸ‡°' },
    { code: '+47', name: 'Norway', flag: 'ðŸ‡³ðŸ‡´' },
    { code: '+968', name: 'Oman', flag: 'ðŸ‡´ðŸ‡²' },
    { code: '+92', name: 'Pakistan', flag: 'ðŸ‡µðŸ‡°' },
    { code: '+680', name: 'Palau', flag: 'ðŸ‡µðŸ‡¼' },
    { code: '+970', name: 'Palestine', flag: 'ðŸ‡µðŸ‡¸' },
    { code: '+507', name: 'Panama', flag: 'ðŸ‡µðŸ‡¦' },
    { code: '+675', name: 'Papua New Guinea', flag: 'ðŸ‡µðŸ‡¬' },
    { code: '+595', name: 'Paraguay', flag: 'ðŸ‡µðŸ‡¾' },
    { code: '+51', name: 'Peru', flag: 'ðŸ‡µðŸ‡ª' },
    { code: '+63', name: 'Philippines', flag: 'ðŸ‡µðŸ‡­' },
    { code: '+48', name: 'Poland', flag: 'ðŸ‡µðŸ‡±' },
    { code: '+351', name: 'Portugal', flag: 'ðŸ‡µðŸ‡¹' },
    { code: '+974', name: 'Qatar', flag: 'ðŸ‡¶ðŸ‡¦' },
    { code: '+40', name: 'Romania', flag: 'ðŸ‡·ðŸ‡´' },
    { code: '+7', name: 'Russia', flag: 'ðŸ‡·ðŸ‡º' },
    { code: '+250', name: 'Rwanda', flag: 'ðŸ‡·ðŸ‡¼' },
    { code: '+1-869', name: 'Saint Kitts and Nevis', flag: 'ðŸ‡°ðŸ‡³' },
    { code: '+1-758', name: 'Saint Lucia', flag: 'ðŸ‡±ðŸ‡¨' },
    { code: '+1-784', name: 'Saint Vincent and the Grenadines', flag: 'ðŸ‡»ðŸ‡¨' },
    { code: '+685', name: 'Samoa', flag: 'ðŸ‡¼ðŸ‡¸' },
    { code: '+378', name: 'San Marino', flag: 'ðŸ‡¸ðŸ‡²' },
    { code: '+239', name: 'Sao Tome and Principe', flag: 'ðŸ‡¸ðŸ‡¹' },
    { code: '+966', name: 'Saudi Arabia', flag: 'ðŸ‡¸ðŸ‡¦' },
    { code: '+221', name: 'Senegal', flag: 'ðŸ‡¸ðŸ‡³' },
    { code: '+381', name: 'Serbia', flag: 'ðŸ‡·ðŸ‡¸' },
    { code: '+248', name: 'Seychelles', flag: 'ðŸ‡¸ðŸ‡¨' },
    { code: '+232', name: 'Sierra Leone', flag: 'ðŸ‡¸ðŸ‡±' },
    { code: '+65', name: 'Singapore', flag: 'ðŸ‡¸ðŸ‡¬' },
    { code: '+421', name: 'Slovakia', flag: 'ðŸ‡¸ðŸ‡°' },
    { code: '+386', name: 'Slovenia', flag: 'ðŸ‡¸ðŸ‡®' },
    { code: '+677', name: 'Solomon Islands', flag: 'ðŸ‡¸ðŸ‡§' },
    { code: '+252', name: 'Somalia', flag: 'ðŸ‡¸ðŸ‡´' },
    { code: '+27', name: 'South Africa', flag: 'ðŸ‡¿ðŸ‡¦' },
    { code: '+211', name: 'South Sudan', flag: 'ðŸ‡¸ðŸ‡¸' },
    { code: '+34', name: 'Spain', flag: 'ðŸ‡ªðŸ‡¸' },
    { code: '+94', name: 'Sri Lanka', flag: 'ðŸ‡±ðŸ‡°' },
    { code: '+249', name: 'Sudan', flag: 'ðŸ‡¸ðŸ‡©' },
    { code: '+597', name: 'Suriname', flag: 'ðŸ‡¸ðŸ‡·' },
    { code: '+46', name: 'Sweden', flag: 'ðŸ‡¸ðŸ‡ª' },
    { code: '+41', name: 'Switzerland', flag: 'ðŸ‡¨ðŸ‡­' },
    { code: '+963', name: 'Syria', flag: 'ðŸ‡¸ðŸ‡¾' },
    { code: '+886', name: 'Taiwan', flag: 'ðŸ‡¹ðŸ‡¼' },
    { code: '+992', name: 'Tajikistan', flag: 'ðŸ‡¹ðŸ‡¯' },
    { code: '+255', name: 'Tanzania', flag: 'ðŸ‡¹ðŸ‡¿' },
    { code: '+66', name: 'Thailand', flag: 'ðŸ‡¹ðŸ‡­' },
    { code: '+228', name: 'Togo', flag: 'ðŸ‡¹ðŸ‡¬' },
    { code: '+676', name: 'Tonga', flag: 'ðŸ‡¹ðŸ‡´' },
    { code: '+1-868', name: 'Trinidad and Tobago', flag: 'ðŸ‡¹ðŸ‡¹' },
    { code: '+216', name: 'Tunisia', flag: 'ðŸ‡¹ðŸ‡³' },
    { code: '+90', name: 'Turkey', flag: 'ðŸ‡¹ðŸ‡·' },
    { code: '+993', name: 'Turkmenistan', flag: 'ðŸ‡¹ðŸ‡²' },
    { code: '+1-649', name: 'Turks and Caicos Islands', flag: 'ðŸ‡¹ðŸ‡¨' },
    { code: '+256', name: 'Uganda', flag: 'ðŸ‡ºðŸ‡¬' },
    { code: '+380', name: 'Ukraine', flag: 'ðŸ‡ºðŸ‡¦' },
    { code: '+971', name: 'United Arab Emirates', flag: 'ðŸ‡¦ðŸ‡ª' },
    { code: '+44', name: 'United Kingdom', flag: 'ðŸ‡¬ðŸ‡§' },
    { code: '+1', name: 'United States', flag: 'ðŸ‡ºðŸ‡¸' },
    { code: '+598', name: 'Uruguay', flag: 'ðŸ‡ºðŸ‡¾' },
    { code: '+998', name: 'Uzbekistan', flag: 'ðŸ‡ºðŸ‡¿' },
    { code: '+678', name: 'Vanuatu', flag: 'ðŸ‡»ðŸ‡º' },
    { code: '+379', name: 'Vatican City', flag: 'ðŸ‡»ðŸ‡¦' },
    { code: '+58', name: 'Venezuela', flag: 'ðŸ‡»ðŸ‡ª' },
    { code: '+84', name: 'Vietnam', flag: 'ðŸ‡»ðŸ‡³' },
    { code: '+967', name: 'Yemen', flag: 'ðŸ‡¾ðŸ‡ª' },
    { code: '+260', name: 'Zambia', flag: 'ðŸ‡¿ðŸ‡²' },
    { code: '+263', name: 'Zimbabwe', flag: 'ðŸ‡¿ðŸ‡¼' }
  ];

  // Function to extract flag from option text
  function extractFlagFromOption(option) {
    if (!option || !option.textContent) return '';
    const text = option.textContent.trim();
    // Match emoji flag (usually 1-2 characters at the start)
    const flagMatch = text.match(/^[\u{1F1E6}-\u{1F1FF}]{2}/u);
    return flagMatch ? flagMatch[0] : '';
  }

  // Function to update flag display on select element
  function updateCountryFlagDisplay(selectElement) {
    if (!selectElement) return;
    const selectedOption = selectElement.options[selectElement.selectedIndex];
    if (selectedOption) {
      const flag = extractFlagFromOption(selectedOption);
      const countryCode = selectedOption.value;
      selectElement.setAttribute('data-flag', flag);
      selectElement.setAttribute('data-code', countryCode);
      
      // Also update or create a flag overlay element for better browser compatibility
      let flagOverlay = selectElement.parentElement.querySelector('.country-flag-overlay');
      if (!flagOverlay) {
        flagOverlay = document.createElement('span');
        flagOverlay.className = 'country-flag-overlay';
        selectElement.parentElement.style.position = 'relative';
        selectElement.parentElement.appendChild(flagOverlay);
      }
      flagOverlay.textContent = flag + ' ' + countryCode;
      flagOverlay.style.display = 'block';
    }
  }

  // Function to populate country dropdown
  function populateCountryDropdown(selectElement, selectedValue) {
    if (!selectElement) return;
    
    // Clear existing options
    selectElement.innerHTML = '';
    
    // Add default option
    const defaultOption = document.createElement('option');
    defaultOption.value = '';
    defaultOption.textContent = 'Select Country...';
    selectElement.appendChild(defaultOption);
    
    // Add all countries
    countries.forEach(country => {
      const option = document.createElement('option');
      option.value = country.code;
      // Show full name in dropdown, but only flag + code when selected
      option.textContent = `${country.flag} ${country.name} ${country.code}`;
      option.setAttribute('data-display', `${country.flag} ${country.code}`);
      if (selectedValue && country.code === selectedValue) {
        option.selected = true;
      }
      selectElement.appendChild(option);
    });
    
    // If no selected value and it's student country code, default to Egypt
    if (!selectedValue && selectElement.id === 'studentCountryCode') {
      const egyptOption = selectElement.querySelector('option[value="+20"]');
      if (egyptOption) {
        egyptOption.selected = true;
      }
    }

    // Update flag display after populating
    updateCountryFlagDisplay(selectElement);
  }
  
  // Populate country dropdowns immediately after DOM elements are available
  (function() {
    const studentCountryCode = '<%= typeof studentCountryCode != 'undefined' ? studentCountryCode : '+20' %>';
    const parentCountryCode = '<%= typeof parentCountryCode != 'undefined' ? parentCountryCode : '+20' %>';
    
    // Update flags for hardcoded options if dropdowns haven't been populated yet
    if (studentCountrySelect && studentCountrySelect.options.length > 0) {
      updateCountryFlagDisplay(studentCountrySelect);
    }
    if (parentCountrySelect && parentCountrySelect.options.length > 0) {
      updateCountryFlagDisplay(parentCountrySelect);
    }
    
    // Use setTimeout to ensure DOM is ready
    setTimeout(function() {
      if (studentCountrySelect) {
        populateCountryDropdown(studentCountrySelect, studentCountryCode);
      }
      if (parentCountrySelect) {
        populateCountryDropdown(parentCountrySelect, parentCountryCode);
      }
    }, 0);
  })();
  
  // Track which fields have been touched/interacted with
  const touchedFields = new Set();
  
  // OTP State Management (initialize early) - Only for student phone number
  // Check if OTP was verified on server side (from session)
  const serverOtpVerifiedInput = document.getElementById('serverOtpVerified');
  const serverSideVerified = serverOtpVerifiedInput && serverOtpVerifiedInput.value === 'true';
  const otpState = {
    student: {
      verified: serverSideVerified,
      timer: null,
      countdown: 0,
      rateLimitTimer: null,
      rateLimitCountdown: 0
    }
  };
  const otpStatusTimers = {};

  // ============================================
  // Validation Functions (must be defined first)
  // ============================================
  function validateStudentNumber() {
    if (!studentNumberInput || !studentCountrySelect) {
      return { valid: false, message: 'Student number is required' };
    }
    const phoneNumber = studentNumberInput.value.replace(/[^\d]/g, '');
    const countryCode = studentCountrySelect.value;
    const expectedLength = phoneLengthStandards[countryCode];
    
    if (!phoneNumber) {
      return { valid: false, message: 'Student number is required' };
    }
    
    if (expectedLength) {
      if (phoneNumber.length !== expectedLength) {
      return { valid: false, message: `Student number must be ${expectedLength} digits for ${countryCode}` };
      }
    } else {
      // Use flexible range for countries not in the list
      if (phoneNumber.length < DEFAULT_MIN_PHONE_LENGTH || phoneNumber.length > DEFAULT_MAX_PHONE_LENGTH) {
        return { valid: false, message: `Student number must be between ${DEFAULT_MIN_PHONE_LENGTH} and ${DEFAULT_MAX_PHONE_LENGTH} digits` };
      }
    }
    
    // Check if student and parent numbers are the same
    if (parentNumberInput && parentCountrySelect) {
      const parentNumber = parentNumberInput.value.replace(/[^\d]/g, '');
      const parentCountry = parentCountrySelect.value;
      if (phoneNumber && parentNumber && phoneNumber === parentNumber && countryCode === parentCountry) {
        return { valid: false, message: 'Student and parent phone numbers cannot be the same' };
      }
    }
    
    return { valid: true };
  }

  function validateParentNumber() {
    if (!parentNumberInput || !parentCountrySelect) {
      return { valid: false, message: 'Parent number is required' };
    }
    const phoneNumber = parentNumberInput.value.replace(/[^\d]/g, '');
    const countryCode = parentCountrySelect.value;
    const expectedLength = phoneLengthStandards[countryCode];
    
    if (!phoneNumber) {
      return { valid: false, message: 'Parent number is required' };
    }
    
    if (expectedLength) {
      if (phoneNumber.length !== expectedLength) {
      return { valid: false, message: `Parent number must be ${expectedLength} digits for ${countryCode}` };
      }
    } else {
      // Use flexible range for countries not in the list
      if (phoneNumber.length < DEFAULT_MIN_PHONE_LENGTH || phoneNumber.length > DEFAULT_MAX_PHONE_LENGTH) {
        return { valid: false, message: `Parent number must be between ${DEFAULT_MIN_PHONE_LENGTH} and ${DEFAULT_MAX_PHONE_LENGTH} digits` };
      }
    }
    
    // Check if student and parent numbers are the same
    if (studentNumberInput && studentCountrySelect) {
      const studentNumber = studentNumberInput.value.replace(/[^\d]/g, '');
      const studentCountry = studentCountrySelect.value;
      if (phoneNumber && studentNumber && phoneNumber === studentNumber && countryCode === studentCountry) {
        return { valid: false, message: 'Parent and student phone numbers cannot be the same' };
      }
    }
    
    return { valid: true };
  }

  function validatePasswordMatch() {
    if (!passwordInput || !password2Input) {
      return { valid: false, message: 'Passwords do not match' };
    }
    if (passwordInput.value !== password2Input.value) {
      return { valid: false, message: 'Passwords do not match' };
    }
    return { valid: true };
  }

  // ============================================
  // Validation Rules
  // ============================================
  const validationRules = {
    firstName: {
      required: true,
      minLength: 2,
      maxLength: 50,
      pattern: /^[a-zA-Z\s\u0600-\u06FF]+$/,
      message: 'First name must be 2-50 characters and contain only letters'
    },
    lastName: {
      required: true,
      minLength: 2,
      maxLength: 50,
      pattern: /^[a-zA-Z\s\u0600-\u06FF]+$/,
      message: 'Last name must be 2-50 characters and contain only letters'
    },
    studentNumber: {
      required: true,
      validate: validateStudentNumber,
      message: 'Student number is required and must match country format'
    },
    parentNumber: {
      required: true,
      validate: validateParentNumber,
      message: 'Parent number is required and must match country format'
    },
    studentEmail: {
      required: true,
      pattern: /^[^\s@]+@[^\s@]+\.[^\s@]+$/,
      message: 'Please enter a valid email address'
    },
    username: {
      required: true,
      minLength: 3,
      maxLength: 30,
      pattern: /^[a-zA-Z0-9_]+$/,
      message: 'Username must be 3-30 characters and contain only letters, numbers, and underscores'
    },
    schoolName: {
      required: true,
      minLength: 2,
      maxLength: 100,
      message: 'School name must be 2-100 characters'
    },
    grade: {
      required: true,
      message: 'Please select your grade'
    },
    englishTeacher: {
      required: true,
      minLength: 2,
      maxLength: 100,
      pattern: /^[a-zA-Z\s\u0600-\u06FF]+$/,
      message: 'English teacher name must be 2-100 characters and contain only letters'
    },
    password: {
      required: true,
      minLength: 6,
      message: 'Password must be at least 6 characters long'
    },
    password2: {
      required: true,
      validate: validatePasswordMatch,
      message: 'Passwords do not match'
    },
    howDidYouKnow: {
      required: true,
      message: 'Please select how you heard about Mr Kably'
    },
    howDidYouKnowOther: {
      required: false,
      minLength: 3,
      maxLength: 500,
      message: 'Please provide at least 3 characters describing how you heard about Mr Kably',
      validate: function() {
        // Only required if "Other" is selected
        if (howDidYouKnowInput && howDidYouKnowInput.value === 'Other') {
          const value = howDidYouKnowOtherInput ? howDidYouKnowOtherInput.value.trim() : '';
          if (!value || value.length < 3) {
            return { valid: false, message: 'Please provide at least 3 characters describing how you heard about Mr Kably' };
          }
        }
        return { valid: true };
      }
    }
  };

  // ============================================
  // Field Validation
  // ============================================
  function validateField(fieldName, input, rule) {
    const value = input.value.trim();
    let isValid = true;
    let errorMessage = '';

    // Check required
    if (rule.required && !value) {
      isValid = false;
      errorMessage = rule.message || 'This field is required';
    }

    // Check min length
    if (isValid && value && rule.minLength && value.length < rule.minLength) {
      isValid = false;
      errorMessage = rule.message || `Minimum length is ${rule.minLength} characters`;
    }

    // Check max length
    if (isValid && value && rule.maxLength && value.length > rule.maxLength) {
      isValid = false;
      errorMessage = rule.message || `Maximum length is ${rule.maxLength} characters`;
    }

    // Check pattern
    if (isValid && value && rule.pattern && !rule.pattern.test(value)) {
      isValid = false;
      errorMessage = rule.message || 'Invalid format';
    }

    // Custom validation
    if (isValid && value && rule.validate) {
      const customResult = rule.validate();
      if (!customResult.valid) {
        isValid = false;
        errorMessage = customResult.message || rule.message;
      }
    }

    // Special handling for select elements
    if (input.tagName === 'SELECT' && isValid && value === '') {
      isValid = false;
      errorMessage = rule.message || 'Please select an option';
    }

    // Special handling for checkboxes
    if (input.type === 'checkbox' && rule.required && !input.checked) {
      isValid = false;
      errorMessage = rule.message || 'This field is required';
    }

    return { isValid, errorMessage };
  }

  // ============================================
  // Display Error/Success
  // ============================================
  function showFieldError(input, message, showError = true) {
    const formGroup = input.closest('.form-group-modern');
    if (!formGroup) return;

    // Get field name to check if it's been touched
    const fieldId = input.id;
    const isTouched = touchedFields.has(fieldId);

    // Only show error message if field has been touched or if explicitly requested
    if (!showError && !isTouched) {
      // Just mark as invalid without showing message
      input.classList.remove('is-valid');
      input.classList.add('is-invalid');
      return;
    }

    // Remove existing error
    const existingError = formGroup.querySelector('.field-error-message');
    if (existingError) {
      existingError.remove();
    }

    // Remove valid class and classes from parent groups
    input.classList.remove('is-valid');
    input.classList.add('is-invalid');

    // Handle phone input groups
    if (input.classList.contains('phone-input')) {
      const phoneGroup = input.closest('.phone-input-group');
      if (phoneGroup) {
        phoneGroup.classList.remove('has-success');
        phoneGroup.classList.add('has-error');
      }
    }

    // Handle checkboxes
    if (input.type === 'checkbox') {
      const checkGroup = input.closest('.form-check-modern');
      if (checkGroup) {
        checkGroup.classList.remove('has-success');
        checkGroup.classList.add('has-error');
      }
    }

    // Only add error message if field has been touched
    if (isTouched || showError) {
      const errorDiv = document.createElement('div');
      errorDiv.className = 'field-error-message';
      errorDiv.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${message}`;
      formGroup.appendChild(errorDiv);
    }
  }

  function showFieldSuccess(input, showSuccess = true) {
    const formGroup = input.closest('.form-group-modern');
    if (!formGroup) return;

    // Get field name to check if it's been touched
    const fieldId = input.id;
    const isTouched = touchedFields.has(fieldId);

    // Only show success indicator if field has been touched or explicitly requested
    if (!showSuccess && !isTouched) {
      // Just remove invalid class without showing success
      input.classList.remove('is-invalid');
      return;
    }

    // Remove existing error
    const existingError = formGroup.querySelector('.field-error-message');
    if (existingError) {
      existingError.remove();
    }

    // Remove invalid class and add valid
    input.classList.remove('is-invalid');
    input.classList.add('is-valid');

    // Handle phone input groups
    if (input.classList.contains('phone-input')) {
      const phoneGroup = input.closest('.phone-input-group');
      if (phoneGroup) {
        phoneGroup.classList.remove('has-error');
        phoneGroup.classList.add('has-success');
      }
    }

    // Handle checkboxes
    if (input.type === 'checkbox') {
      const checkGroup = input.closest('.form-check-modern');
      if (checkGroup) {
        checkGroup.classList.remove('has-error');
        checkGroup.classList.add('has-success');
      }
    }
  }

  function clearFieldError(input) {
    const formGroup = input.closest('.form-group-modern');
    if (!formGroup) return;

    const existingError = formGroup.querySelector('.field-error-message');
    if (existingError) {
      existingError.remove();
    }

    input.classList.remove('is-invalid', 'is-valid');

    // Clear phone input group classes
    if (input.classList.contains('phone-input')) {
      const phoneGroup = input.closest('.phone-input-group');
      if (phoneGroup) {
        phoneGroup.classList.remove('has-error', 'has-success');
      }
    }

    // Clear checkbox group classes
    if (input.type === 'checkbox') {
      const checkGroup = input.closest('.form-check-modern');
      if (checkGroup) {
        checkGroup.classList.remove('has-error', 'has-success');
      }
    }
  }

  // ============================================
  // Step Validation
  // ============================================
  function validateStep(stepNumber, showErrors = true) {
    let isValid = true;
    const stepFields = getStepFields(stepNumber);

    stepFields.forEach(({ name, input }) => {
      const rule = validationRules[name];
      if (!rule || !input) return;

      const result = validateField(name, input, rule);
      if (!result.isValid) {
        showFieldError(input, result.errorMessage, showErrors);
        isValid = false;
      } else {
        // Only show success if field has been touched or errors are being shown
        showFieldSuccess(input, showErrors);
      }
    });

    return isValid;
  }

  // Check if step is valid without modifying DOM (for button state)
  function isStepValid(stepNumber) {
    // For step 1, check OTP verification first (only student phone needs OTP)
    if (stepNumber === 1) {
      if (!otpState || !otpState.student) {
        // OTP state not initialized yet, check form fields only
      } else if (!otpState.student.verified) {
        return false;
      }
    }
    
    let isValid = true;
    const stepFields = getStepFields(stepNumber);

    stepFields.forEach(({ name, input }) => {
      const rule = validationRules[name];
      if (!rule || !input) return;

      const result = validateField(name, input, rule);
      if (!result.isValid) {
        isValid = false;
      }
    });

    return isValid;
  }

  function getStepFields(stepNumber) {
    switch (stepNumber) {
      case 1:
        return [
          { name: 'firstName', input: firstNameInput },
          { name: 'lastName', input: lastNameInput },
          { name: 'studentNumber', input: studentNumberInput },
          { name: 'parentNumber', input: parentNumberInput },
          { name: 'studentEmail', input: studentEmailInput },
          { name: 'username', input: usernameInput }
        ];
      case 2:
        return [
          { name: 'schoolName', input: schoolNameInput },
          { name: 'grade', input: gradeSelect },
          { name: 'englishTeacher', input: englishTeacherInput }
        ];
      case 3:
        return [
          { name: 'password', input: passwordInput },
          { name: 'password2', input: password2Input },
          { name: 'howDidYouKnow', input: howDidYouKnowInput },
          { name: 'howDidYouKnowOther', input: howDidYouKnowOtherInput }
        ];
      default:
        return [];
    }
  }

  // ============================================
  // Real-time Validation
  // ============================================
  function setupFieldValidation(fieldName, input, rule) {
    if (!input) return;

    // Mark field as touched when user interacts
    const markTouched = () => {
      markFieldAsTouched(input);
    };

    // Real-time validation on input/blur
    const validateFieldHandler = () => {
      markFieldAsTouched(input);
      const result = validateField(fieldName, input, rule);
      if (result.isValid) {
        showFieldSuccess(input);
      } else {
        showFieldError(input, result.errorMessage, true);
      }
      updateNextButtonState();
    };

    // For text inputs, validate on blur and input
    if (input.type === 'text' || input.type === 'email' || input.type === 'tel' || input.tagName === 'TEXTAREA') {
      input.addEventListener('focus', markTouched);
      input.addEventListener('blur', validateFieldHandler);
      input.addEventListener('input', debounce(() => {
        markTouched();
        validateFieldHandler();
      }, 500));
    }
    
    // For select inputs, validate on change
    if (input.tagName === 'SELECT') {
      input.addEventListener('focus', markTouched);
      input.addEventListener('change', validateFieldHandler);
    }
    
    // For checkboxes, validate on change
    if (input.type === 'checkbox') {
      input.addEventListener('change', validateFieldHandler);
      input.addEventListener('click', markTouched);
    }
  }

  // ============================================
  // Step Navigation
  // ============================================
  function updateNextButtonState() {
    // Check validation without showing errors (for button state)
    const isValid = isStepValid(currentStep);
    
    if (nextStepBtn) {
      if (isValid) {
        nextStepBtn.disabled = false;
        nextStepBtn.classList.remove('btn-disabled');
      } else {
        nextStepBtn.disabled = true;
        nextStepBtn.classList.add('btn-disabled');
      }
    }
  }
  
  // Mark field as touched when user interacts
  function markFieldAsTouched(input) {
    if (input && input.id) {
      touchedFields.add(input.id);
    }
  }

  function goToStep(stepNumber) {
    if (stepNumber < 1 || stepNumber > totalSteps) return;

    // Validate current step before moving
    if (stepNumber > currentStep) {
      // Mark all fields in current step as touched before validation
      const stepFields = getStepFields(currentStep);
      stepFields.forEach(({ input }) => {
        if (input && input.id) {
          touchedFields.add(input.id);
        }
      });
      
      // Validate with errors shown
      if (!validateStep(currentStep, true)) {
        // Scroll to first error
        const firstError = document.querySelector('.form-step.active .is-invalid');
        if (firstError) {
          firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
          firstError.focus();
        }
        return;
      }
    }

    // Update step display
    formSteps.forEach((step, index) => {
      if (index + 1 === stepNumber) {
        step.classList.add('active');
      } else {
        step.classList.remove('active');
      }
    });

    // Update step indicators
    stepItems.forEach((item, index) => {
      if (index + 1 === stepNumber) {
        item.classList.add('active');
      } else if (index + 1 < stepNumber) {
        item.classList.add('completed');
      } else {
        item.classList.remove('active', 'completed');
      }
    });

    // Update navigation buttons
    if (prevStepBtn) {
      prevStepBtn.style.display = stepNumber > 1 ? 'flex' : 'none';
    }
    if (nextStepBtn) {
      nextStepBtn.style.display = stepNumber < totalSteps ? 'flex' : 'none';
    }
    if (submitBtn) {
      submitBtn.style.display = stepNumber === totalSteps ? 'flex' : 'none';
    }

    currentStep = stepNumber;
    updateNextButtonState();

    // Scroll to top of form
    const formContainer = document.querySelector('.auth-form-container');
    if (formContainer) {
      formContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
  }

  // ============================================
  // Event Listeners
  // ============================================
  if (nextStepBtn) {
    nextStepBtn.addEventListener('click', function(e) {
      e.preventDefault();
      // Mark all fields in current step as touched
      const stepFields = getStepFields(currentStep);
      stepFields.forEach(({ input }) => {
        if (input && input.id) {
          touchedFields.add(input.id);
        }
      });
      
      // Validate with errors shown
      if (validateStep(currentStep, true)) {
        goToStep(currentStep + 1);
      } else {
        // Scroll to first error
        const firstError = document.querySelector('.form-step.active .is-invalid');
        if (firstError) {
          firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
          firstError.focus();
        }
      }
    });
  }

  if (prevStepBtn) {
    prevStepBtn.addEventListener('click', function(e) {
      e.preventDefault();
      goToStep(currentStep - 1);
    });
  }

  // Setup validation for all fields (except phone numbers and passwords which are handled separately)
  Object.keys(validationRules).forEach(fieldName => {
    // Skip phone numbers and passwords - they have special validation handlers
    if (fieldName === 'studentNumber' || fieldName === 'parentNumber' || 
        fieldName === 'password' || fieldName === 'password2') {
      return;
    }
    
    const rule = validationRules[fieldName];
    let input;
    
    switch (fieldName) {
      case 'firstName': input = firstNameInput; break;
      case 'lastName': input = lastNameInput; break;
      case 'studentEmail': input = studentEmailInput; break;
      case 'username': input = usernameInput; break;
      case 'schoolName': input = schoolNameInput; break;
      case 'grade': input = gradeSelect; break;
      case 'englishTeacher': input = englishTeacherInput; break;
      case 'howDidYouKnow': input = howDidYouKnowInput; break;
      case 'howDidYouKnowOther': input = howDidYouKnowOtherInput; break;
    }
    
    if (input) {
      setupFieldValidation(fieldName, input, rule);
    }
  });

  // Phone number formatting and validation - validate both fields when either changes
  const validatePhoneNumbers = debounce(() => {
    if (currentStep === 1) {
      // Validate student number
      if (studentNumberInput && validationRules.studentNumber) {
        const studentResult = validateField('studentNumber', studentNumberInput, validationRules.studentNumber);
        if (studentResult.isValid) {
          showFieldSuccess(studentNumberInput);
        } else {
          showFieldError(studentNumberInput, studentResult.errorMessage, true);
        }
      }
      
      // Validate parent number
      if (parentNumberInput && validationRules.parentNumber) {
        const parentResult = validateField('parentNumber', parentNumberInput, validationRules.parentNumber);
        if (parentResult.isValid) {
          showFieldSuccess(parentNumberInput);
        } else {
          showFieldError(parentNumberInput, parentResult.errorMessage, true);
        }
      }
      
      updateNextButtonState();
    }
  }, 300);

  // Student number input handling
  if (studentNumberInput) {
    studentNumberInput.addEventListener('focus', () => markFieldAsTouched(studentNumberInput));
    studentNumberInput.addEventListener('input', function() {
      markFieldAsTouched(this);
      // Remove any non-numeric characters
      this.value = this.value.replace(/[^\d]/g, '');
      // Trigger validation for both phone fields
      validatePhoneNumbers();
    });
    studentNumberInput.addEventListener('blur', function() {
      markFieldAsTouched(this);
      validatePhoneNumbers();
    });
  }

  // Parent number input handling
  if (parentNumberInput) {
    parentNumberInput.addEventListener('focus', () => markFieldAsTouched(parentNumberInput));
    parentNumberInput.addEventListener('input', function() {
      markFieldAsTouched(this);
      // Remove any non-numeric characters
      this.value = this.value.replace(/[^\d]/g, '');
      // Trigger validation for both phone fields
      validatePhoneNumbers();
    });
    parentNumberInput.addEventListener('blur', function() {
      markFieldAsTouched(this);
      validatePhoneNumbers();
    });
  }

  // Special handling for country code changes - trigger phone validation
  if (studentCountrySelect) {
    studentCountrySelect.addEventListener('focus', function() {
      markFieldAsTouched(studentNumberInput);
      // Keep flag overlay visible
      const flagOverlay = this.parentElement.querySelector('.country-flag-overlay');
      if (flagOverlay) flagOverlay.style.display = 'block';
    });
    studentCountrySelect.addEventListener('change', function() {
      updateCountryFlagDisplay(this);
      markFieldAsTouched(studentNumberInput);
      validatePhoneNumbers();
    });
    studentCountrySelect.addEventListener('blur', function() {
      updateCountryFlagDisplay(this);
      const flagOverlay = this.parentElement.querySelector('.country-flag-overlay');
      if (flagOverlay) flagOverlay.style.display = 'block';
    });
  }

  if (parentCountrySelect) {
    parentCountrySelect.addEventListener('focus', function() {
      markFieldAsTouched(parentNumberInput);
      // Keep flag overlay visible
      const flagOverlay = this.parentElement.querySelector('.country-flag-overlay');
      if (flagOverlay) flagOverlay.style.display = 'block';
    });
    parentCountrySelect.addEventListener('change', function() {
      updateCountryFlagDisplay(this);
      markFieldAsTouched(parentNumberInput);
      validatePhoneNumbers();
    });
    parentCountrySelect.addEventListener('blur', function() {
      updateCountryFlagDisplay(this);
      const flagOverlay = this.parentElement.querySelector('.country-flag-overlay');
      if (flagOverlay) flagOverlay.style.display = 'block';
    });
  }

  // Handle "How did you know Mr Kably?" dropdown - show/hide "Other" field
  if (howDidYouKnowInput) {
    howDidYouKnowInput.addEventListener('change', function() {
      const selectedValue = this.value;
      if (selectedValue === 'Other') {
        if (howDidYouKnowOtherContainer) {
          howDidYouKnowOtherContainer.style.display = 'block';
        }
        if (howDidYouKnowOtherInput) {
          howDidYouKnowOtherInput.setAttribute('required', 'required');
        }
      } else {
        if (howDidYouKnowOtherContainer) {
          howDidYouKnowOtherContainer.style.display = 'none';
        }
        if (howDidYouKnowOtherInput) {
          howDidYouKnowOtherInput.removeAttribute('required');
          howDidYouKnowOtherInput.value = '';
        }
      }
      markFieldAsTouched(this);
      validateField('howDidYouKnow', this);
    });
    
    // Initialize on page load
    if (howDidYouKnowInput.value === 'Other') {
      if (howDidYouKnowOtherContainer) {
        howDidYouKnowOtherContainer.style.display = 'block';
      }
      if (howDidYouKnowOtherInput) {
        howDidYouKnowOtherInput.setAttribute('required', 'required');
      }
    }
  }

  // Password confirmation validation - validate both fields when either changes
  if (passwordInput && password2Input) {
    const validatePasswords = debounce(() => {
      if (currentStep === 3) {
        // Validate password field
        const passwordRule = validationRules.password;
        if (passwordRule) {
          const passwordResult = validateField('password', passwordInput, passwordRule);
          if (passwordResult.isValid) {
            showFieldSuccess(passwordInput);
          } else {
            showFieldError(passwordInput, passwordResult.errorMessage, true);
          }
        }
        
        // Validate password confirmation field
        const password2Rule = validationRules.password2;
        if (password2Rule) {
          const password2Result = validateField('password2', password2Input, password2Rule);
          if (password2Result.isValid) {
            showFieldSuccess(password2Input);
          } else {
            showFieldError(password2Input, password2Result.errorMessage, true);
          }
        }
        
        updateNextButtonState();
      }
    }, 300);

    passwordInput.addEventListener('focus', () => markFieldAsTouched(passwordInput));
    passwordInput.addEventListener('input', function() {
      markFieldAsTouched(this);
      validatePasswords();
    });
    passwordInput.addEventListener('blur', function() {
      markFieldAsTouched(this);
      validatePasswords();
    });
    
    password2Input.addEventListener('focus', () => markFieldAsTouched(password2Input));
    password2Input.addEventListener('input', function() {
      markFieldAsTouched(this);
      validatePasswords();
    });
    password2Input.addEventListener('blur', function() {
      markFieldAsTouched(this);
      validatePasswords();
    });
  }

  // Form submission
  if (form) {
    form.addEventListener('submit', function(e) {
      // Combine howDidYouKnow dropdown with "Other" text if "Other" is selected
      if (howDidYouKnowInput && howDidYouKnowInput.value === 'Other' && howDidYouKnowOtherInput) {
        const otherText = howDidYouKnowOtherInput.value.trim();
        if (otherText) {
          // Create a hidden input to store the combined value
          let hiddenInput = document.getElementById('howDidYouKnowCombined');
          if (!hiddenInput) {
            hiddenInput = document.createElement('input');
            hiddenInput.type = 'hidden';
            hiddenInput.id = 'howDidYouKnowCombined';
            hiddenInput.name = 'howDidYouKnow';
            form.appendChild(hiddenInput);
          }
          hiddenInput.value = 'Other: ' + otherText;
          // Temporarily disable the dropdown so it doesn't submit
          howDidYouKnowInput.disabled = true;
        }
      }
      
      // Mark all fields as touched before validation
      for (let i = 1; i <= totalSteps; i++) {
        const stepFields = getStepFields(i);
        stepFields.forEach(({ input }) => {
          if (input && input.id) {
            touchedFields.add(input.id);
          }
        });
      }
      
      // Validate all steps before submission with errors shown
      let allValid = true;
      for (let i = 1; i <= totalSteps; i++) {
        if (!validateStep(i, true)) {
          allValid = false;
          // Go to first invalid step
          goToStep(i);
          break;
        }
      }

      if (!allValid) {
        e.preventDefault();
        e.stopPropagation();
        // Re-enable dropdown if validation failed
        if (howDidYouKnowInput) {
          howDidYouKnowInput.disabled = false;
        }
        return false;
      }

      // Generate unique submission ID
      const submissionIdInput = document.getElementById('submissionId');
      if (submissionIdInput && !submissionIdInput.value) {
        submissionIdInput.value = 'sub_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
      }
    });
  }
  
  // Initialize submit button state - disabled by default
  if (submitBtn) {
    submitBtn.disabled = true;
    submitBtn.classList.add('btn-disabled');
  }

  // ============================================
  // Utility Functions
  // ============================================
  function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
      const later = () => {
        clearTimeout(timeout);
        func(...args);
      };
      clearTimeout(timeout);
      timeout = setTimeout(later, wait);
    };
  }

  // ============================================
  // Initialization
  // ============================================
  // Initialize button states - Next button should be disabled initially
  if (nextStepBtn) {
    nextStepBtn.disabled = true;
    nextStepBtn.classList.add('btn-disabled');
  }

  // Initialize step display
  goToStep(1);

  // Validate step 1 on page load if any fields have values (for form repopulation)
  const hasInitialValues = Array.from(document.querySelectorAll('.form-control-modern')).some(input => input.value.trim() !== '');
  if (hasInitialValues) {
    // Delay to ensure DOM is ready
    setTimeout(() => {
      updateNextButtonState();
    }, 100);
  }

  // ============================================
  // OTP Verification Functionality
  // ============================================
  
  // OTP State Management is defined earlier in the script

  // Show OTP section when phone number is entered and valid
  function checkAndShowOtpSection(type) {
    const phoneInput = type === 'student' ? studentNumberInput : parentNumberInput;
    const countrySelect = type === 'student' ? studentCountrySelect : parentCountrySelect;
    const otpSection = document.getElementById(`${type}OtpSection`);
    const sendBtn = document.getElementById(`send${type.charAt(0).toUpperCase() + type.slice(1)}OtpBtn`);
    
    if (!phoneInput || !countrySelect || !otpSection) return;
    
    const phoneNumber = phoneInput.value.replace(/[^\d]/g, '');
    const countryCode = countrySelect.value;
    const expectedLength = phoneLengthStandards[countryCode];
    
    // Check if phone number is valid
    let isValidLength = false;
    if (expectedLength) {
      isValidLength = phoneNumber.length === expectedLength;
    } else {
      isValidLength = phoneNumber.length >= DEFAULT_MIN_PHONE_LENGTH && phoneNumber.length <= DEFAULT_MAX_PHONE_LENGTH;
    }
    
    // Show OTP section if phone number is valid
    if (phoneNumber && isValidLength && !otpState[type].verified) {
      otpSection.style.display = 'block';
      // Enable send button if not rate limited
      if (sendBtn && !otpState[type].rateLimitTimer) {
        sendBtn.style.display = 'inline-flex';
        sendBtn.disabled = false;
        sendBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Send OTP';
      }
    } else if (otpState[type].verified) {
      otpSection.style.display = 'block';
      // Hide send button when verified
      if (sendBtn) {
        sendBtn.style.display = 'none';
      }
    } else {
      otpSection.style.display = 'none';
    }
  }


  // Send OTP function
  async function sendOTP(type) {
    const phoneInput = type === 'student' ? studentNumberInput : parentNumberInput;
    const countrySelect = type === 'student' ? studentCountrySelect : parentCountrySelect;
    const sendBtn = document.getElementById(`send${type.charAt(0).toUpperCase() + type.slice(1)}OtpBtn`);
    const otpInputGroup = document.getElementById(`${type}OtpInputGroup`);
    const otpStatus = document.getElementById(`${type}OtpStatus`);
    const otpTimer = document.getElementById(`${type}OtpTimer`);
    const resendBtn = document.getElementById(`resend${type.charAt(0).toUpperCase() + type.slice(1)}OtpBtn`);
    
    if (!phoneInput || !countrySelect) return;
    
    const phoneNumber = phoneInput.value.replace(/[^\d]/g, '');
    const countryCode = countrySelect.value;
    
    // Validate phone number first
    if (!phoneNumber || phoneNumber.length < 8) {
      showOtpStatus(type, 'Please enter a valid phone number', 'error');
      return;
    }
    
    // Disable send button
    sendBtn.disabled = true;
    sendBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...';
    showOtpStatus(type, 'Sending OTP...', 'info');
    
    try {
      const response = await fetch('/auth/send-otp', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          phoneNumber: phoneNumber,
          countryCode: countryCode,
          type: type
        })
      });
      
      const data = await response.json();
      
      if (data.success) {
        let statusMessage = 'OTP sent successfully! Please check your phone.';
        if (data.attemptsRemaining !== undefined) {
          statusMessage += ` (${data.attemptsRemaining} attempt(s) remaining)`;
        }
        showOtpStatus(type, statusMessage, 'success');
        sendBtn.style.display = 'none';
        otpInputGroup.style.display = 'flex';
        otpTimer.style.display = 'block';
        resendBtn.style.display = 'none';
        
        // Clear any rate limiting states
        clearRateLimitTimer(type);
        
        // Lock phone number input after OTP is sent (prevent changing number)
        lockPhoneNumberInput(type);
        
        // Start countdown timer
        startOtpCountdown(type, 60);
      } else if (response.status === 429) {
        // Rate limiting - too many attempts
        showOtpStatus(type, data.message || 'Too many OTP requests. Please try again later.', 'error');
        sendBtn.disabled = true;
        sendBtn.innerHTML = '<i class="fas fa-clock"></i> Try Again Later';
        
        // Start rate limit countdown timer
        if (data.retryAfter && data.blockedUntil) {
          const retryAfterSeconds = data.retryAfter * 60; // Convert minutes to seconds
          startRateLimitTimer(type, retryAfterSeconds, data.blockedUntil);
        }
      } else {
        showOtpStatus(type, data.message || 'Failed to send OTP. Please try again.', 'error');
        sendBtn.disabled = false;
        sendBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Send OTP';
      }
    } catch (error) {
      console.error('Send OTP error:', error);
      
      // Check if it's a rate limit error
      if (error.status === 429) {
        showOtpStatus(type, 'Too many OTP requests. Please try again later.', 'error');
        sendBtn.disabled = true;
        sendBtn.innerHTML = '<i class="fas fa-clock"></i> Try Again Later';
      } else {
        showOtpStatus(type, 'An error occurred. Please try again.', 'error');
        sendBtn.disabled = false;
        sendBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Send OTP';
      }
    }
  }

  // Verify OTP function
  async function verifyOTP(type) {
    const otpInput = document.getElementById(`${type}OtpInput`);
    const verifyBtn = document.getElementById(`verify${type.charAt(0).toUpperCase() + type.slice(1)}OtpBtn`);
    const otpStatus = document.getElementById(`${type}OtpStatus`);
    
    if (!otpInput) return;
    
    const otp = otpInput.value.trim();
    
    if (!otp || otp.length !== 6) {
      showOtpStatus(type, 'Please enter a valid 6-digit OTP', 'error');
      return;
    }
    
    // Disable verify button
    verifyBtn.disabled = true;
    verifyBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Verifying...';
    showOtpStatus(type, 'Verifying OTP...', 'info');
    
    try {
      const response = await fetch('/auth/verify-otp', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          otp: otp,
          type: type
        })
      });
      
      const data = await response.json();
      
      if (data.success) {
        otpState[type].verified = true;
        showOtpStatus(type, 'âœ“ Verified', 'success');
        otpInput.classList.add('verified');
        otpInput.disabled = true;
        verifyBtn.style.display = 'none';
        
        // Clear countdown and rate limit timer
        clearOtpCountdown(type);
        clearRateLimitTimer(type);
        
        // Hide timer and resend button after successful verification
        const otpTimer = document.getElementById(`${type}OtpTimer`);
        const resendBtn = document.getElementById(`resend${type.charAt(0).toUpperCase() + type.slice(1)}OtpBtn`);
        const otpInputGroup = document.getElementById(`${type}OtpInputGroup`);
        if (otpTimer) {
          otpTimer.style.display = 'none';
          // Clear any running timers
          clearOtpCountdown(type);
        }
        if (resendBtn) resendBtn.style.display = 'none';
        // Hide the input group but keep the status visible
        if (otpInputGroup) otpInputGroup.style.display = 'none';
        
        // Phone number is already locked when OTP was sent, no need to lock again
        
        // Update form validation
        updateNextButtonState();
      } else {
        showOtpStatus(type, data.message || 'Invalid OTP. Please try again.', 'error');
        otpInput.value = '';
        otpInput.focus();
        verifyBtn.disabled = false;
        verifyBtn.innerHTML = '<i class="fas fa-check"></i> Verify';
      }
    } catch (error) {
      console.error('Verify OTP error:', error);
      showOtpStatus(type, 'An error occurred. Please try again.', 'error');
      verifyBtn.disabled = false;
      verifyBtn.innerHTML = '<i class="fas fa-check"></i> Verify';
    }
  }

  // Show OTP status message
  function showOtpStatus(type, message, status) {
    const otpStatus = document.getElementById(`${type}OtpStatus`);
    if (!otpStatus) return;
    
    if (otpStatusTimers[type]) {
      clearTimeout(otpStatusTimers[type]);
      otpStatusTimers[type] = null;
    }
    
    otpStatus.textContent = message;
    otpStatus.className = `otp-status ${status}`;
    
    const isPermanentSuccess = status === 'success' && message === 'âœ“ Verified';
    if (!isPermanentSuccess) {
      if (status === 'success') {
        otpStatusTimers[type] = setTimeout(() => {
          otpStatus.textContent = '';
          otpStatus.className = 'otp-status';
          otpStatusTimers[type] = null;
        }, 5000);
      } else if (status === 'error') {
        otpStatusTimers[type] = setTimeout(() => {
          otpStatus.textContent = '';
          otpStatus.className = 'otp-status';
          otpStatusTimers[type] = null;
        }, 20000);
      }
    }
  }

  // Start OTP countdown timer
  function startOtpCountdown(type, seconds) {
    clearOtpCountdown(type);
    
    const countdownEl = document.getElementById(`${type}OtpCountdown`);
    const otpTimer = document.getElementById(`${type}OtpTimer`);
    const resendBtn = document.getElementById(`resend${type.charAt(0).toUpperCase() + type.slice(1)}OtpBtn`);
    
    otpState[type].countdown = seconds;
    
    if (countdownEl) {
      countdownEl.textContent = seconds;
    }
    
    otpState[type].timer = setInterval(() => {
      otpState[type].countdown--;
      
      if (countdownEl) {
        countdownEl.textContent = otpState[type].countdown;
      }
      
      if (otpState[type].countdown <= 0) {
        clearOtpCountdown(type);
        if (otpTimer) otpTimer.style.display = 'none';
        if (resendBtn) resendBtn.style.display = 'inline-flex';
      }
    }, 1000);
  }

  // Clear OTP countdown
  function clearOtpCountdown(type) {
    if (otpState[type].timer) {
      clearInterval(otpState[type].timer);
      otpState[type].timer = null;
    }
    otpState[type].countdown = 0;
  }

  // Start rate limit countdown timer (for 1 hour block)
  function startRateLimitTimer(type, seconds, blockedUntil) {
    // Clear any existing rate limit timer
    clearRateLimitTimer(type);
    
    const sendBtn = document.getElementById(`send${type.charAt(0).toUpperCase() + type.slice(1)}OtpBtn`);
    const otpStatus = document.getElementById(`${type}OtpStatus`);
    const otpTimer = document.getElementById(`${type}OtpTimer`);
    const resendBtn = document.getElementById(`resend${type.charAt(0).toUpperCase() + type.slice(1)}OtpBtn`);
    
    // Store rate limit timer in otpState
    if (!otpState[type].rateLimitTimer) {
      otpState[type].rateLimitTimer = null;
    }
    if (!otpState[type].rateLimitCountdown) {
      otpState[type].rateLimitCountdown = 0;
    }
    
    otpState[type].rateLimitCountdown = seconds;
    
    // Show timer message
    if (otpStatus) {
      otpStatus.textContent = `Too many attempts. Please try again after ${Math.ceil(seconds / 60)} minute(s).`;
      otpStatus.className = 'otp-status error';
    }
    
    if (otpTimer) {
      otpTimer.style.display = 'block';
      const countdownEl = document.getElementById(`${type}OtpCountdown`);
      if (countdownEl) {
        countdownEl.textContent = Math.ceil(seconds / 60);
      }
    }
    
    // Update countdown every second
    otpState[type].rateLimitTimer = setInterval(() => {
      const now = Date.now();
      const remaining = Math.max(0, Math.ceil((blockedUntil - now) / 1000));
      
      otpState[type].rateLimitCountdown = remaining;
      
      const minutes = Math.ceil(remaining / 60);
      
      if (otpStatus) {
        otpStatus.textContent = `Too many attempts. Please try again after ${minutes} minute(s).`;
      }
      
      const countdownEl = document.getElementById(`${type}OtpCountdown`);
      if (countdownEl && otpTimer) {
        countdownEl.textContent = minutes;
      }
      
      if (remaining <= 0) {
        clearRateLimitTimer(type);
        // Re-enable send button
        if (sendBtn) {
          sendBtn.disabled = false;
          sendBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Send OTP';
        }
        if (otpStatus) {
          otpStatus.textContent = '';
          otpStatus.className = 'otp-status';
        }
        if (otpTimer) {
          otpTimer.style.display = 'none';
        }
      }
    }, 1000);
  }

  // Clear rate limit timer
  function clearRateLimitTimer(type) {
    if (otpState[type].rateLimitTimer) {
      clearInterval(otpState[type].rateLimitTimer);
      otpState[type].rateLimitTimer = null;
    }
    otpState[type].rateLimitCountdown = 0;
  }

  // Lock phone number input after OTP is sent or verified (prevents tampering)
  function lockPhoneNumberInput(type) {
    const phoneInput = type === 'student' ? studentNumberInput : parentNumberInput;
    const countrySelect = type === 'student' ? studentCountrySelect : parentCountrySelect;
    
    if (!phoneInput || !countrySelect) return;
    
    // Check if already locked to prevent re-locking
    if (phoneInput.getAttribute('data-locked') === 'true') {
      return; // Already locked, don't try to lock again
    }
    
    // Store the original values
    const originalPhone = phoneInput.value;
    const originalCountry = countrySelect.value;
    
    // Mark as locked
    phoneInput.setAttribute('data-locked', 'true');
    phoneInput.setAttribute('data-original-phone', originalPhone);
    countrySelect.setAttribute('data-locked', 'true');
    countrySelect.setAttribute('data-original-country', originalCountry);
    
    // Populate hidden inputs to ensure values are submitted (disabled fields don't submit)
    if (type === 'student') {
      const hiddenStudentNumber = document.getElementById('hiddenStudentNumber');
      const hiddenStudentCountryCode = document.getElementById('hiddenStudentCountryCode');
      if (hiddenStudentNumber) {
        hiddenStudentNumber.value = originalPhone;
      }
      if (hiddenStudentCountryCode) {
        hiddenStudentCountryCode.value = originalCountry;
      }
    }
    // Note: Parent number doesn't need OTP verification, so no hidden inputs needed
    
    // Remove name attributes from visible inputs (they're disabled, so they won't submit anyway)
    // This ensures only the hidden inputs with values are submitted
    phoneInput.removeAttribute('name');
    countrySelect.removeAttribute('name');
    
    // Disable inputs
    phoneInput.disabled = true;
    countrySelect.disabled = true;
    
    // Add visual styling to show it's locked
    if (phoneInput.classList) {
      phoneInput.classList.add('otp-locked');
    }
    if (countrySelect.classList) {
      countrySelect.classList.add('otp-locked');
    }
    
    // Prevent any attempts to change via JavaScript or inspector
    // Note: We don't use Object.defineProperty on form elements as it's unreliable
    // Instead, we rely on disabled state, event prevention, and DOM mutation observer
    
    // Prevent input events
    const preventChange = function(e) {
      e.preventDefault();
      e.stopPropagation();
      phoneInput.value = originalPhone;
      countrySelect.value = originalCountry;
      return false;
    };
    
    phoneInput.addEventListener('input', preventChange, true);
    phoneInput.addEventListener('change', preventChange, true);
    phoneInput.addEventListener('keydown', preventChange, true);
    countrySelect.addEventListener('change', preventChange, true);
    
    // Monitor for DOM mutations (in case user tries to remove disabled attribute)
    const observer = new MutationObserver(function(mutations) {
      mutations.forEach(function(mutation) {
        if (mutation.type === 'attributes') {
          if (mutation.attributeName === 'disabled' && !phoneInput.disabled) {
            phoneInput.disabled = true;
          }
          if (mutation.attributeName === 'disabled' && !countrySelect.disabled) {
            countrySelect.disabled = true;
          }
          if (phoneInput.value !== originalPhone) {
            phoneInput.value = originalPhone;
          }
          if (countrySelect.value !== originalCountry) {
            countrySelect.value = originalCountry;
          }
        }
      });
    });
    
    observer.observe(phoneInput, {
      attributes: true,
      attributeFilter: ['disabled', 'value']
    });
    
    observer.observe(countrySelect, {
      attributes: true,
      attributeFilter: ['disabled', 'value']
    });
    
    // Store observer for cleanup if needed
    phoneInput._otpObserver = observer;
  }

  // Setup OTP event listeners
  function setupOtpListeners() {
    // Student OTP listeners
    if (studentNumberInput && studentCountrySelect) {
      studentNumberInput.addEventListener('input', () => {
        if (!otpState.student.verified) {
          checkAndShowOtpSection('student');
        }
      });
      
      studentNumberInput.addEventListener('blur', () => {
        if (!otpState.student.verified) {
          checkAndShowOtpSection('student');
        }
      });
      
      studentCountrySelect.addEventListener('change', () => {
        if (!otpState.student.verified) {
          checkAndShowOtpSection('student');
        }
      });
    }
    
    // Send OTP button - only for student
    const sendStudentOtpBtn = document.getElementById('sendStudentOtpBtn');
    
    if (sendStudentOtpBtn) {
      sendStudentOtpBtn.addEventListener('click', () => sendOTP('student'));
    }
    
    // Verify OTP button - only for student
    const verifyStudentOtpBtn = document.getElementById('verifyStudentOtpBtn');
    
    if (verifyStudentOtpBtn) {
      verifyStudentOtpBtn.addEventListener('click', () => verifyOTP('student'));
    }
    
    // Resend OTP button - only for student
    const resendStudentOtpBtn = document.getElementById('resendStudentOtpBtn');
    
    if (resendStudentOtpBtn) {
      resendStudentOtpBtn.addEventListener('click', () => {
        const sendBtn = document.getElementById('sendStudentOtpBtn');
        const otpInputGroup = document.getElementById('studentOtpInputGroup');
        const otpTimer = document.getElementById('studentOtpTimer');
        
        sendBtn.style.display = 'inline-flex';
        otpInputGroup.style.display = 'none';
        otpTimer.style.display = 'none';
        resendStudentOtpBtn.style.display = 'none';
        sendOTP('student');
      });
    }
    
    // Allow Enter key to verify OTP and restrict input to numbers only - only for student
    const studentOtpInput = document.getElementById('studentOtpInput');
    
    if (studentOtpInput) {
      // Only allow numeric input
      studentOtpInput.addEventListener('input', (e) => {
        e.target.value = e.target.value.replace(/[^\d]/g, '');
      });
      
      studentOtpInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && !verifyStudentOtpBtn.disabled) {
          verifyOTP('student');
        }
      });
    }
  }


  // Initialize OTP listeners
  setupOtpListeners();
  
  // Restore OTP verification state if verified on server side
  setTimeout(() => {
    // If OTP is verified on server side, restore verified state
    if (serverSideVerified && otpState.student.verified) {
      // Lock phone number fields
      lockPhoneNumberInput('student');
      
      // Show OTP section with verified status
      const otpSection = document.getElementById('studentOtpSection');
      const otpStatus = document.getElementById('studentOtpStatus');
      const sendBtn = document.getElementById('sendStudentOtpBtn');
      const otpInput = document.getElementById('studentOtpInput');
      const verifyBtn = document.getElementById('verifyStudentOtpBtn');
      const otpInputGroup = document.getElementById('studentOtpInputGroup');
      const otpTimer = document.getElementById('studentOtpTimer');
      const resendBtn = document.getElementById('resendStudentOtpBtn');
      
      if (otpSection) {
        otpSection.style.display = 'block';
      }
      if (sendBtn) {
        sendBtn.style.display = 'none';
      }
      if (otpStatus) {
        otpStatus.textContent = 'âœ“ Verified';
        otpStatus.className = 'otp-status success';
      }
      if (otpInput) {
        otpInput.classList.add('verified');
        otpInput.disabled = true;
        otpInput.value = '000000';
      }
      if (verifyBtn) {
        verifyBtn.style.display = 'none';
      }
      if (otpInputGroup) {
        otpInputGroup.style.display = 'none';
      }
      if (otpTimer) {
        otpTimer.style.display = 'none';
      }
      if (resendBtn) {
        resendBtn.style.display = 'none';
      }
      
      // Update form validation
      updateNextButtonState();
    } else if (studentNumberInput && studentNumberInput.value) {
      // Check if phone number is valid and show OTP section
      const phoneNumber = studentNumberInput.value.replace(/[^\d]/g, '');
      const countryCode = studentCountrySelect.value;
      const expectedLength = phoneLengthStandards[countryCode];
      
      // Check if phone number is valid
      let isValidLength = false;
      if (expectedLength) {
        isValidLength = phoneNumber.length === expectedLength;
      } else {
        isValidLength = phoneNumber.length >= DEFAULT_MIN_PHONE_LENGTH && phoneNumber.length <= DEFAULT_MAX_PHONE_LENGTH;
      }
      
      if (phoneNumber && isValidLength && !otpState.student.verified) {
        checkAndShowOtpSection('student');
      }
    }
    if (parentNumberInput && parentNumberInput.value) {
      // Don't auto-check, let user trigger it
    }
  }, 500);
});
</script>

<!-- Terms and Privacy Modal -->
<div class="reading-modal" id="readingModal">
  <div class="reading-modal-overlay" id="modalOverlay"></div>
  <div class="reading-modal-container">
    <div class="reading-modal-header">
      <div class="modal-header-left">
        <h3 id="modalTitle" data-english="Terms of Service" data-arabic="Ø´Ø±ÙˆØ· Ø§Ù„Ø®Ø¯Ù…Ø©">Terms of Service</h3>
        <!-- Language Toggle Button in Modal -->
        <button class="modal-lang-toggle-btn" id="modalLangToggle" data-lang="en">
          <i class="fas fa-globe"></i>
          <span class="modal-lang-text">AR</span>
        </button>
      </div>
      <button class="modal-close-btn" id="closeModalBtn" disabled data-english-title="Please read to the end" data-arabic-title="ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© Ø­ØªÙ‰ Ø§Ù„Ù†Ù‡Ø§ÙŠØ©" title="Please read to the end">
        <i class="fas fa-times"></i>
      </button>
    </div>
    
    <div class="reading-progress-bar">
      <div class="reading-progress-track">
        <div class="reading-progress-fill" id="readingProgressFill">
          <div class="progress-shine"></div>
        </div>
        <div class="progress-steps">
          <div class="progress-step" data-step="25"></div>
          <div class="progress-step" data-step="50"></div>
          <div class="progress-step" data-step="75"></div>
        </div>
      </div>
      <div class="progress-info">
        <span class="reading-progress-text" id="readingProgressText" data-english="Scroll to read: 0%" data-arabic="Ø§Ù†ØªÙ‚Ù„ Ù„Ù„Ù‚Ø±Ø§Ø¡Ø©: 0%">Scroll to read: 0%</span>
        <span class="progress-percentage" id="progressPercentage">0%</span>
      </div>
    </div>
    
    <div class="reading-modal-content" id="modalContent">
      <!-- Content will be loaded here dynamically -->
    </div>
    
    <div class="reading-modal-footer">
      <button class="btn-confirm-read" id="confirmReadBtn" disabled>
        <i class="fas fa-check-circle"></i>
        <span data-english="I Have Read and Understood" data-arabic="Ù„Ù‚Ø¯ Ù‚Ø±Ø£Øª ÙˆÙÙ‡Ù…Øª">I Have Read and Understood</span>
      </button>
    </div>
  </div>
</div>

<!-- Modal Styles -->
<style>
/* Reading Modal Styles */
.reading-modal {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  z-index: 10000;
  display: none;
  align-items: center;
  justify-content: center;
  opacity: 0;
  transition: opacity 0.3s ease;
}

.reading-modal.active {
  display: flex;
  opacity: 1;
}

.reading-modal-overlay {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.7);
  backdrop-filter: blur(5px);
}

.reading-modal-container {
  position: relative;
  width: 90%;
  max-width: 900px;
  max-height: 85vh;
  background: white;
  border-radius: 20px;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
  display: flex;
  flex-direction: column;
  overflow: hidden;
  z-index: 1;
  animation: modalSlideIn 0.4s ease-out;
}

@keyframes modalSlideIn {
  from {
    transform: scale(0.9) translateY(50px);
    opacity: 0;
  }
  to {
    transform: scale(1) translateY(0);
    opacity: 1;
  }
}

.reading-modal-header {
  padding: 25px 30px;
  border-bottom: 2px solid #e5e7eb;
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
  position: relative;
}

.modal-header-left {
  display: flex;
  align-items: center;
  gap: 15px;
  flex: 1;
}

.reading-modal-header h3 {
  margin: 0;
  font-size: 1.8rem;
  font-weight: 700;
  color: #dc2626;
}

/* Modal Language Toggle Button - Fixed Position */
.modal-lang-toggle-btn {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 8px 14px;
  background: rgba(220, 38, 38, 0.1);
  color: #dc2626;
  border: 2px solid rgba(220, 38, 38, 0.2);
  border-radius: 20px;
  font-size: 0.85rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  direction: ltr;
  text-align: left;
  flex-shrink: 0;
  z-index: 10;
}

.modal-lang-toggle-btn:hover {
  background: rgba(220, 38, 38, 0.15);
  border-color: rgba(220, 38, 38, 0.3);
  transform: translateY(-1px);
}

.modal-lang-toggle-btn i {
  font-size: 0.9rem;
}

.modal-lang-text {
  font-weight: 700;
  min-width: 32px;
  text-align: center;
  direction: ltr;
}

.modal-close-btn {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  border: none;
  background: #e5e7eb;
  color: #6b7280;
  cursor: not-allowed;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.3s ease;
  font-size: 1.2rem;
}

.modal-close-btn:not(:disabled) {
  cursor: pointer;
  background: #dc2626;
  color: white;
}

.modal-close-btn:not(:disabled):hover {
  background: #b91c1c;
  transform: scale(1.1);
}

.reading-progress-bar {
  position: relative;
  padding: 20px 30px;
  background: linear-gradient(135deg, #f8f9fa 0%, #f1f5f9 100%);
  border-bottom: 1px solid #e5e7eb;
}

.reading-progress-track {
  position: relative;
  height: 8px;
  background: #e5e7eb;
  border-radius: 10px;
  overflow: hidden;
  margin-bottom: 12px;
  box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.05);
}

.reading-progress-fill {
  position: relative;
  left: 0;
  top: 0;
  height: 100%;
  width: 0%;
  background: linear-gradient(90deg, #dc2626 0%, #ef4444 50%, #f87171 100%);
  transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
  border-radius: 10px;
  box-shadow: 0 2px 8px rgba(220, 38, 38, 0.3);
  overflow: hidden;
}

.progress-shine {
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
  animation: shine 2s infinite;
}

@keyframes shine {
  0% { left: -100%; }
  100% { left: 100%; }
}

.progress-steps {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  display: flex;
  justify-content: space-between;
  padding: 0 2px;
}

.progress-step {
  width: 4px;
  height: 100%;
  background: rgba(255, 255, 255, 0.6);
  border-radius: 2px;
  opacity: 0.5;
}

.progress-info {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.reading-progress-text {
  font-weight: 600;
  font-size: 0.9rem;
  color: #6b7280;
}

.progress-percentage {
  font-weight: 700;
  font-size: 1rem;
  color: #dc2626;
  min-width: 45px;
  text-align: right;
}

.reading-modal-content {
  flex: 1;
  overflow-y: auto;
  padding: 40px;
  background: white;
  scroll-behavior: smooth;
}

/* Custom Scrollbar */
.reading-modal-content::-webkit-scrollbar {
  width: 12px;
}

.reading-modal-content::-webkit-scrollbar-track {
  background: #f1f5f9;
  border-radius: 10px;
}

.reading-modal-content::-webkit-scrollbar-thumb {
  background: linear-gradient(135deg, #dc2626, #ef4444);
  border-radius: 10px;
  border: 2px solid #f1f5f9;
}

.reading-modal-content::-webkit-scrollbar-thumb:hover {
  background: linear-gradient(135deg, #b91c1c, #dc2626);
}

.reading-modal-footer {
  padding: 25px 30px;
  border-top: 2px solid #e5e7eb;
  background: #f8f9fa;
}

.btn-confirm-read {
  width: 100%;
  padding: 18px 30px;
  background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%);
  color: white;
  border: none;
  border-radius: 12px;
  font-size: 1.1rem;
  font-weight: 600;
  cursor: not-allowed;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 12px;
  transition: all 0.3s ease;
  opacity: 0.5;
}

.btn-confirm-read:not(:disabled) {
  cursor: pointer;
  opacity: 1;
}

.btn-confirm-read:not(:disabled):hover {
  transform: translateY(-2px);
  box-shadow: 0 10px 30px rgba(220, 38, 38, 0.3);
}

.btn-confirm-read i {
  font-size: 1.3rem;
}

/* Terms Agreement Section */
.terms-agreement-section {
  background: linear-gradient(135deg, rgba(220, 38, 38, 0.04) 0%, rgba(239, 68, 68, 0.04) 100%);
  border: 2px solid rgba(220, 38, 38, 0.15);
  border-radius: 12px;
  padding: 20px;
  margin: 20px 0;
  transition: all 0.3s ease;
}

.terms-agreement-header {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 12px;
}

.terms-agreement-header i {
  font-size: 1.3rem;
  color: #dc2626;
}

.terms-agreement-header h4 {
  margin: 0;
  font-size: 1.1rem;
  font-weight: 700;
  color: #dc2626;
}

.terms-agreement-text {
  font-size: 0.9rem;
  line-height: 1.5;
  color: #6b7280;
  margin-bottom: 15px;
  font-weight: 500;
}

/* Document Cards Grid */
.terms-documents-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
  margin-bottom: 15px;
}

.document-card {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 15px;
  background: white;
  border: 2px solid #e5e7eb;
  border-radius: 10px;
  text-decoration: none;
  transition: all 0.3s ease;
  cursor: pointer;
  position: relative;
  overflow: hidden;
}

.document-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(220, 38, 38, 0.05), transparent);
  transition: left 0.5s ease;
}

.document-card:hover {
  border-color: #dc2626;
  transform: translateY(-3px);
  box-shadow: 0 6px 16px rgba(220, 38, 38, 0.15);
}

.document-card:hover::before {
  left: 100%;
}

.document-card-icon {
  flex-shrink: 0;
  width: 40px;
  height: 40px;
  background: linear-gradient(135deg, rgba(220, 38, 38, 0.1), rgba(239, 68, 68, 0.1));
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  color: #dc2626;
  font-size: 1.2rem;
  transition: all 0.3s ease;
}

.document-card:hover .document-card-icon {
  background: linear-gradient(135deg, #dc2626, #ef4444);
  color: white;
  transform: scale(1.1);
}

.document-card-content {
  flex: 1;
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.document-card-content h5 {
  margin: 0;
  font-size: 0.95rem;
  font-weight: 700;
  color: #1f2937;
  transition: color 0.3s ease;
}

.document-card:hover .document-card-content h5 {
  color: #dc2626;
}

.document-status {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  font-size: 0.8rem;
  font-weight: 600;
  transition: all 0.3s ease;
}

.document-status.status-pending {
  color: #d97706;
}

.document-status.status-pending i {
  animation: clockSpin 2s linear infinite;
}

@keyframes clockSpin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.document-status.status-completed {
  color: #15803d;
}

.document-card-arrow {
  flex-shrink: 0;
  color: #9ca3af;
  font-size: 1rem;
  transition: all 0.3s ease;
}

.document-card:hover .document-card-arrow {
  color: #dc2626;
  transform: translateX(5px);
}

/* Completed state for document card */
.document-card.completed {
  border-color: rgba(34, 197, 94, 0.3);
  background: linear-gradient(135deg, rgba(34, 197, 94, 0.05), rgba(16, 185, 129, 0.05));
}

.document-card.completed:hover {
  border-color: #15803d;
  box-shadow: 0 6px 16px rgba(34, 197, 94, 0.15);
}

.document-card.completed .document-card-icon {
  background: linear-gradient(135deg, rgba(34, 197, 94, 0.15), rgba(16, 185, 129, 0.15));
  color: #15803d;
}

.document-card.completed:hover .document-card-icon {
  background: linear-gradient(135deg, #15803d, #22c55e);
  color: white;
}

@keyframes statusComplete {
  0% { transform: scale(1); }
  50% { transform: scale(1.05); }
  100% { transform: scale(1); }
}

/* Completion Notice */
.terms-completion-notice {
  padding: 12px 16px;
  background: linear-gradient(135deg, rgba(34, 197, 94, 0.12) 0%, rgba(16, 185, 129, 0.12) 100%);
  border: 2px solid rgba(34, 197, 94, 0.3);
  border-radius: 8px;
  display: flex;
  align-items: center;
  gap: 10px;
  animation: slideInNotice 0.4s ease-out;
}

@keyframes slideInNotice {
  from {
    opacity: 0;
    transform: scale(0.95);
  }
  to {
    opacity: 1;
    transform: scale(1);
  }
}

.terms-completion-notice i {
  font-size: 1.2rem;
  color: #15803d;
  flex-shrink: 0;
  animation: checkPulse 0.6s ease-in-out;
}

@keyframes checkPulse {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.15); }
}

.terms-completion-notice span {
  font-size: 0.85rem;
  color: #15803d;
  font-weight: 600;
  line-height: 1.4;
}

/* Dark Theme Support */
.dark-theme .terms-agreement-section {
  background: linear-gradient(135deg, rgba(220, 38, 38, 0.08) 0%, rgba(239, 68, 68, 0.08) 100%);
  border-color: rgba(220, 38, 38, 0.3);
}

.dark-theme .terms-agreement-header h4 {
  color: #ef4444;
}

.dark-theme .terms-agreement-text {
  color: #9ca3af;
}

.dark-theme .document-card {
  background: #2d2d2d;
  border-color: #374151;
}

.dark-theme .document-card:hover {
  border-color: #ef4444;
  box-shadow: 0 6px 16px rgba(239, 68, 68, 0.2);
}

.dark-theme .document-card-content h5 {
  color: #f3f4f6;
}

.dark-theme .document-card:hover .document-card-content h5 {
  color: #ef4444;
}

.dark-theme .document-status.status-pending {
  color: #fbbf24;
}

.dark-theme .document-status.status-completed {
  color: #4ade80;
}

.dark-theme .document-card.completed {
  border-color: rgba(34, 197, 94, 0.4);
  background: linear-gradient(135deg, rgba(34, 197, 94, 0.08), rgba(16, 185, 129, 0.08));
}

.dark-theme .document-card.completed:hover {
  border-color: #4ade80;
}

.dark-theme .terms-completion-notice {
  background: linear-gradient(135deg, rgba(34, 197, 94, 0.15) 0%, rgba(16, 185, 129, 0.15) 100%);
  border-color: rgba(34, 197, 94, 0.4);
}

.dark-theme .terms-completion-notice i,
.dark-theme .terms-completion-notice span {
  color: #4ade80;
}

/* Mobile Responsive */
@media (max-width: 768px) {
  .terms-agreement-section {
    padding: 16px;
  }
  
  .terms-agreement-header h4 {
    font-size: 1rem;
  }
  
  .terms-agreement-text {
    font-size: 0.85rem;
  }
  
  .terms-documents-grid {
    grid-template-columns: 1fr;
    gap: 10px;
  }
  
  .document-card {
    padding: 12px;
  }
  
  .document-card-icon {
    width: 36px;
    height: 36px;
    font-size: 1.1rem;
  }
  
  .document-card-content h5 {
    font-size: 0.9rem;
  }
  
  .document-status {
    font-size: 0.75rem;
  }
  
  .terms-completion-notice {
    padding: 10px 14px;
  }
  
  .terms-completion-notice span {
    font-size: 0.8rem;
  }
}

/* Dark Theme Support */
.dark-theme .reading-modal-container {
  background: #1a1a1a;
}

.dark-theme .reading-modal-header {
  background: linear-gradient(135deg, #2d2d2d 0%, #1a1a1a 100%);
  border-bottom-color: #374151;
}

.dark-theme .reading-modal-header h3 {
  color: #ef4444;
}

.dark-theme .reading-progress-bar {
  background: #2d2d2d;
}

.dark-theme .reading-progress-text {
  color: #d1d5db;
  text-shadow: 0 1px 2px rgba(0, 0, 0, 0.8);
}

.dark-theme .reading-modal-content {
  background: #1a1a1a;
  color: #d1d5db;
}

.dark-theme .reading-modal-content h3,
.dark-theme .reading-modal-content h4 {
  color: #f3f4f6;
}

.dark-theme .reading-modal-content p,
.dark-theme .reading-modal-content li {
  color: #d1d5db;
}

.dark-theme .reading-modal-footer {
  background: #2d2d2d;
  border-top-color: #374151;
}

.dark-theme .modal-close-btn {
  background: #374151;
  color: #9ca3af;
}

.dark-theme .modal-close-btn:not(:disabled) {
  background: #ef4444;
  color: white;
}

/* Mobile Responsive */
@media (max-width: 768px) {
  .reading-modal-container {
    width: 95%;
    max-height: 90vh;
    border-radius: 16px;
  }
  
  .reading-modal-header {
    padding: 20px;
  }
  
  .reading-modal-header h3 {
    font-size: 1.4rem;
  }
  
  .reading-modal-content {
    padding: 25px 20px;
  }
  
  .reading-modal-footer {
    padding: 20px;
  }
  
  .btn-confirm-read {
    padding: 16px 24px;
    font-size: 1rem;
  }
  
  .terms-status-info {
    flex-direction: column;
  }
  
  .status-badge {
    width: 100%;
    justify-content: center;
  }
}

/* Modal Content Styles */
.modal-document-content {
  color: #374151;
  line-height: 1.7;
}

.document-section {
  margin-bottom: 35px;
  padding: 25px;
  background: rgba(248, 250, 252, 0.5);
  border-radius: 16px;
  border-left: 4px solid #dc2626;
}

.document-section h3 {
  display: flex;
  align-items: center;
  gap: 12px;
  color: #1f2937;
  font-size: 1.4rem;
  font-weight: 600;
  margin-bottom: 20px;
}

.section-number {
  width: 36px;
  height: 36px;
  background: #dc2626;
  color: white;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 700;
  font-size: 1rem;
  flex-shrink: 0;
}

.document-section h4 {
  color: #1f2937;
  font-size: 1.15rem;
  font-weight: 600;
  margin: 20px 0 12px 0;
}

.document-section p {
  margin-bottom: 15px;
  color: #4b5563;
}

.document-section ul {
  list-style: none;
  padding: 0;
  margin: 15px 0;
}

.document-section ul li {
  display: flex;
  align-items: flex-start;
  gap: 12px;
  padding: 10px 0;
  color: #4b5563;
}

.document-section ul li i {
  color: #dc2626;
  font-size: 0.95rem;
  width: 18px;
  margin-top: 3px;
  flex-shrink: 0;
}

.info-note {
  display: flex;
  align-items: flex-start;
  gap: 12px;
  background: rgba(220, 38, 38, 0.05);
  border: 1px solid rgba(220, 38, 38, 0.1);
  border-radius: 12px;
  padding: 15px;
  margin: 20px 0;
}

.info-note i {
  color: #dc2626;
  font-size: 1.2rem;
  margin-top: 2px;
  flex-shrink: 0;
}

.info-note p {
  margin: 0;
  color: #4b5563;
  font-size: 0.95rem;
}

/* Terms Video Container Styles */
.terms-video-container {
  margin: 20px 0;
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  background: #000;
}

.terms-video-container iframe {
  border-radius: 12px;
}

.video-watch-status {
  display: flex;
  align-items: center;
  gap: 10px;
  font-size: 0.9rem;
  color: #4b5563;
}

.video-watch-status i {
  color: #dc2626;
  font-size: 1.1rem;
}

.video-watch-status.watching {
  background: #e0f2fe;
  color: #0369a1;
  border-left: 3px solid #0284c7;
}

.video-watch-status.watching i {
  color: #0284c7;
}

.video-watch-status.completed {
  background: #d1fae5;
  color: #065f46;
  border-left: 3px solid #10b981;
}

.video-watch-status.completed i {
  color: #10b981;
}

/* Dark theme for modal content */
.dark-theme .modal-document-content {
  color: #d1d5db;
}

.dark-theme .document-section {
  background: rgba(51, 65, 85, 0.3);
}

.dark-theme .document-section h3,
.dark-theme .document-section h4 {
  color: #f3f4f6;
}

.dark-theme .document-section p,
.dark-theme .document-section ul li {
  color: #d1d5db;
}

.dark-theme .info-note {
  background: rgba(220, 38, 38, 0.1);
  border-color: rgba(220, 38, 38, 0.2);
}

.dark-theme .info-note p {
  color: #d1d5db;
}

/* RTL Support for Modal - Only content, not header */
.reading-modal-content.rtl {
  direction: rtl;
  text-align: right;
}

.reading-modal-content.rtl .modal-document-content {
  direction: rtl;
  text-align: right;
}

.reading-modal-content.rtl .reading-progress-fill {
  right: 0;
  left: auto;
}

.reading-modal-content.rtl .progress-info {
  flex-direction: row-reverse;
}

.reading-modal-content.rtl .progress-percentage {
  text-align: left;
}

.reading-modal-content.rtl .document-section {
  border-left: none;
  border-right: 4px solid #dc2626;
  text-align: right;
}

.reading-modal-content.rtl .document-section h3 {
  display: flex;
  flex-direction: row;
  align-items: center;
  justify-content: flex-start;
  gap: 12px;
  text-align: right;
}

.reading-modal-content.rtl .document-section h3 .section-number {
  order: 2;
  margin-left: 12px;
  margin-right: 0;
}

.reading-modal-content.rtl .document-section h4 {
  text-align: right;
}

.reading-modal-content.rtl .document-section p {
  text-align: right;
}

.reading-modal-content.rtl .document-section ul {
  text-align: right;
}

.reading-modal-content.rtl .document-section ul li {
  display: flex;
  flex-direction: row;
  align-items: flex-start;
  justify-content: flex-start;
  gap: 12px;
  text-align: right;
  direction: rtl;
  unicode-bidi: embed;
  position: relative;
}

.reading-modal-content.rtl .document-section ul li i {
  order: 2;
  margin-left: 0;
  margin-right: 0;
  flex-shrink: 0;
  width: 18px;
  direction: ltr;
  text-align: center;
}

.reading-modal-content.rtl .document-section ul li strong {
  order: 1;
  text-align: right;
  direction: rtl;
  margin-left: 0;
  margin-right: 0;
  unicode-bidi: embed;
}

.reading-modal-content.rtl .document-section ul li span {
  order: 1;
  text-align: right;
  direction: rtl;
  unicode-bidi: embed;
  flex: 1;
}

/* Ensure all non-icon content in list items flows RTL */
.reading-modal-content.rtl .document-section ul li > *:not(i) {
  order: 1;
  text-align: right;
  direction: rtl;
  unicode-bidi: embed;
}

.reading-modal-content.rtl .info-note {
  flex-direction: row;
  justify-content: flex-start;
  text-align: right;
}

.reading-modal-content.rtl .info-note i {
  order: 2;
  margin-left: 12px;
  margin-right: 0;
}

.reading-modal-content.rtl .info-note p {
  order: 1;
  text-align: right;
}

/* Keep header and button in LTR */
.reading-modal-header,
.modal-lang-toggle-btn {
  direction: ltr;
}
</style>

<!-- PlayerJS Library for Video Control -->
<script src="https://assets.mediadelivery.net/playerjs/playerjs-latest.min.js"></script>

<!-- Modal Reading Tracking Script -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Track reading status
  const readingStatus = {
    terms: false,
    privacy: false
  };
  
  // Video tracking variables (for terms video)
  let termsVideoPlayer = null;
  let termsVideoDuration = 0;
  let termsVideoWatchedTime = 0;
  let termsVideoMaxWatched = 0;
  let termsVideoIsPlaying = false;
  let termsVideoCompleted = false;
  let termsVideoLastTime = 0;
  const TERMS_VIDEO_REQUIRED_PERCENTAGE = 100; // Must watch 100% (no skipping allowed)
  
  // Modal Elements
  const modal = document.getElementById('readingModal');
  const modalOverlay = document.getElementById('modalOverlay');
  const modalTitle = document.getElementById('modalTitle');
  const modalContent = document.getElementById('modalContent');
  const closeModalBtn = document.getElementById('closeModalBtn');
  const confirmReadBtn = document.getElementById('confirmReadBtn');
  const readingProgressFill = document.getElementById('readingProgressFill');
  const readingProgressText = document.getElementById('readingProgressText');
  
  // Trigger Elements
  const openTermsModal = document.getElementById('openTermsModal');
  const openPrivacyModal = document.getElementById('openPrivacyModal');
  
  // Status Elements
  const termsReadStatus = document.getElementById('termsReadStatus');
  const privacyReadStatus = document.getElementById('privacyReadStatus');
  const termsCompletionNotice = document.getElementById('termsCompletionNotice');
  const submitBtn = document.getElementById('submitBtn');
  
  let currentDocument = null;
  let hasScrolledToBottom = false;
  
  // Terms of Service Content
  const termsContent = `
    <div class="modal-document-content">
      <div class="document-section">
        <h3>Terms of Service</h3>
        <p>Please read these terms carefully before using our educational services.</p>
      </div>
      
      <div class="document-section">
        <h3>Terms of Service</h3>
        <p>These terms govern your use of the Elkably.com educational platform and its affiliated services.</p>
      </div>
      
      <div class="document-section">
        <h3><span class="section-number">1</span> Acceptance of Terms</h3>
        <p>By accessing and using the Elkably.com educational platform, you acknowledge and agree to be bound by these terms and conditions.</p>
        <p>If you do not agree to any part of these terms, please do not use the service.</p>
      </div>
      
      <div class="document-section">
        <h3><span class="section-number">2</span> Educational Services</h3>
        <p>Elkably.com provides educational services including:</p>
        <ul>
          <li><i class="fas fa-check-circle"></i> Online or in-person mathematics courses</li>
          <li><i class="fas fa-check-circle"></i> Practice tests and quizzes</li>
          <li><i class="fas fa-check-circle"></i> Interactive learning materials</li>
          <li><i class="fas fa-check-circle"></i> Student progress tracking and performance analysis</li>
          <li><i class="fas fa-check-circle"></i> Multiplayer quiz games</li>
        </ul>
        <p>All services are provided "AS IS", and we reserve the right to modify or discontinue any service at any time.</p>
      </div>
      
      <div class="document-section">
        <h3><span class="section-number">3</span> User Accounts</h3>
        <p>To access certain features of our platform, you must create an account. You are responsible for:</p>
        <ul>
          <li><i class="fas fa-check-circle"></i> Providing accurate and complete information</li>
          <li><i class="fas fa-check-circle"></i> Maintaining the security of your account</li>
          <li><i class="fas fa-check-circle"></i> All activities that occur under your account</li>
          <li><i class="fas fa-check-circle"></i> Notifying us immediately of any unauthorized use</li>
        </ul>
      </div>
      
      <div class="document-section">
        <h3><span class="section-number">4</span> Payment Terms</h3>
        <p>Payment terms for our services:</p>
        <ul>
          <li><i class="fas fa-check-circle"></i> All fees are non-refundable unless otherwise stated</li>
          <li><i class="fas fa-check-circle"></i> Payment must be made in advance before receiving the service</li>
          <li><i class="fas fa-check-circle"></i> We accept multiple payment methods as displayed during checkout</li>
          <li><i class="fas fa-check-circle"></i> Prices may change at any time, and existing users will be notified</li>
        </ul>
      </div>
      
      <div class="document-section">
        <h3><span class="section-number">5</span> Course Guidelines</h3>
        <ul>
          <li><i class="fas fa-check-circle"></i> <strong>Attendance is mandatory</strong> for all sessions, whether online or in-person.</li>
          <li><i class="fas fa-check-circle"></i> Any student who is absent <strong>3 times</strong> will be dismissed from the course, whether online or in-person.</li>
          <li><i class="fas fa-check-circle"></i> <strong>Submitting homework is mandatory</strong> to be allowed to attend the session.</li>
          <li><i class="fas fa-check-circle"></i> For online sessions, <strong>the microphone must be on</strong> to ensure active participation with Mr. Kably.</li>
          <li><i class="fas fa-check-circle"></i> <strong>The camera must be on</strong> during the session for better interaction and communication.</li>
        </ul>
      </div>
      
      <div class="document-section">
        <h3><span class="section-number">6</span> Important Video (Anti-Skip)</h3>
        <p><strong>Please watch the following video completely. Skipping is not allowed.</strong></p>
        <div class="terms-video-container" id="termsVideoContainer">
          <div style="position:relative;padding-top:56.25%;">
            <iframe id="termsVideoIframe" src="https://iframe.mediadelivery.net/embed/533780/15dc74bf-f70b-4a87-b74d-993ad32adc2c?autoplay=false&loop=false&muted=false&preload=true&responsive=true&controls=false" loading="lazy" style="border:0;position:absolute;top:0;height:100%;width:100%;" allow="accelerometer;gyroscope;autoplay;encrypted-media;picture-in-picture;" allowfullscreen="true"></iframe>
          </div>
          <div class="video-watch-status" id="videoWatchStatus" style="margin-top: 15px; padding: 12px; background: #f8f9fa; border-radius: 8px; display: none;">
            <i class="fas fa-info-circle"></i> <span id="videoWatchStatusText">Video must be watched completely to proceed.</span>
          </div>
        </div>
      </div>
    </div>
  `;
  
  // Privacy Policy Content
  const privacyContent = `
    <div class="modal-document-content">
      <div class="document-section">
        <h3><span class="section-number">1</span> Information We Collect</h3>
        <h4>Personal Information</h4>
        <p>When you register for our services, we collect:</p>
        <ul>
          <li><i class="fas fa-user"></i> Name, email address, and username</li>
          <li><i class="fas fa-phone"></i> Phone numbers (student and parent)</li>
          <li><i class="fas fa-school"></i> School information and grade level</li>
          <li><i class="fas fa-chalkboard-teacher"></i> Teacher information</li>
        </ul>
        
        <h4>Educational Data</h4>
        <p>To provide personalized learning experiences, we collect:</p>
        <ul>
          <li><i class="fas fa-chart-line"></i> Quiz scores and test results</li>
          <li><i class="fas fa-clock"></i> Time spent on learning activities</li>
          <li><i class="fas fa-book"></i> Course progress and completion data</li>
          <li><i class="fas fa-gamepad"></i> Game room participation and rankings</li>
          <li><i class="fas fa-star"></i> Performance analytics and insights</li>
        </ul>
        
        <h4>Technical Information</h4>
        <p>We automatically collect certain technical information:</p>
        <ul>
          <li><i class="fas fa-globe"></i> IP address and location data</li>
          <li><i class="fas fa-desktop"></i> Device type and browser information</li>
          <li><i class="fas fa-cookie"></i> Cookies and similar tracking technologies</li>
          <li><i class="fas fa-history"></i> Usage patterns and platform interactions</li>
        </ul>
      </div>
      
      <div class="document-section">
        <h3><span class="section-number">2</span> How We Use Your Information</h3>
        <p>We use your information for the following purposes:</p>
        <ul>
          <li><i class="fas fa-graduation-cap"></i> <strong>Educational Services:</strong> Provide personalized learning experiences and track progress</li>
          <li><i class="fas fa-comments"></i> <strong>Communication:</strong> Send important updates, notifications, and educational content</li>
          <li><i class="fas fa-cogs"></i> <strong>Platform Improvement:</strong> Enhance our services and develop new features</li>
          <li><i class="fas fa-shield-alt"></i> <strong>Security:</strong> Protect against fraud and unauthorized access</li>
          <li><i class="fas fa-chart-bar"></i> <strong>Analytics:</strong> Understand usage patterns to improve our platform</li>
          <li><i class="fas fa-credit-card"></i> <strong>Payment Processing:</strong> Handle course purchases and billing</li>
        </ul>
      </div>
      
      <div class="document-section">
        <h3><span class="section-number">3</span> Information Sharing and Disclosure</h3>
        <p>We do not sell, trade, or rent your personal information. We may share your information in the following limited circumstances:</p>
        <ul>
          <li><i class="fas fa-users"></i> <strong>With Your Consent:</strong> When you explicitly agree to share information</li>
          <li><i class="fas fa-gavel"></i> <strong>Legal Requirements:</strong> When required by law or to protect our rights</li>
          <li><i class="fas fa-handshake"></i> <strong>Service Providers:</strong> With trusted third parties who help us operate our platform</li>
          <li><i class="fas fa-shield-alt"></i> <strong>Safety and Security:</strong> To protect the safety of our users and platform</li>
        </ul>
        <div class="info-note">
          <i class="fas fa-info-circle"></i>
          <p><strong>Note:</strong> All third-party service providers are required to maintain the confidentiality of your information and are prohibited from using it for any other purpose.</p>
        </div>
      </div>
      
      <div class="document-section">
        <h3><span class="section-number">4</span> Data Security</h3>
        <p>We implement comprehensive security measures to protect your information:</p>
        <ul>
          <li><i class="fas fa-lock"></i> <strong>Encryption:</strong> All data is encrypted in transit and at rest</li>
          <li><i class="fas fa-server"></i> <strong>Secure Servers:</strong> Data stored on secure, monitored servers</li>
          <li><i class="fas fa-key"></i> <strong>Access Controls:</strong> Limited access to personal information on a need-to-know basis</li>
          <li><i class="fas fa-shield-alt"></i> <strong>Regular Audits:</strong> Security assessments and vulnerability testing</li>
          <li><i class="fas fa-user-shield"></i> <strong>Staff Training:</strong> Regular privacy and security training for all employees</li>
        </ul>
      </div>
      
      <div class="document-section">
        <h3><span class="section-number">5</span> Your Rights and Choices</h3>
        <p>You have the following rights regarding your personal information:</p>
        <ul>
          <li><i class="fas fa-eye"></i> <strong>Access:</strong> Request a copy of your personal information</li>
          <li><i class="fas fa-edit"></i> <strong>Correction:</strong> Update or correct inaccurate information</li>
          <li><i class="fas fa-trash"></i> <strong>Deletion:</strong> Request deletion of your personal information</li>
          <li><i class="fas fa-ban"></i> <strong>Restriction:</strong> Limit how we use your information</li>
          <li><i class="fas fa-download"></i> <strong>Portability:</strong> Export your data in a machine-readable format</li>
          <li><i class="fas fa-bell-slash"></i> <strong>Opt-out:</strong> Unsubscribe from marketing communications</li>
        </ul>
      </div>
    </div>
  `;
  
  // Open Modal Function
  function openModal(type) {
    currentDocument = type;
    hasScrolledToBottom = false;
    
    // Reset video completion state when opening a new modal
    // Only reset if opening Terms (to allow re-watching if needed)
    // For Privacy, ensure video state doesn't affect it
    if (type === 'privacy') {
      // Privacy doesn't have video, so ensure video state doesn't interfere
      termsVideoCompleted = false;
    }
    
    // Reset progress
    readingProgressFill.style.width = '0%';
    if (progressPercentage) progressPercentage.textContent = '0%';
    
    // Apply language to modal (this will set content and title)
    applyModalLanguage(modalLang);
    
    // Reset buttons - ALWAYS disable when opening a modal
    closeModalBtn.disabled = true;
    confirmReadBtn.disabled = true;
    confirmReadBtn.style.opacity = '0.5';
    confirmReadBtn.style.cursor = 'not-allowed';
    if (modalLang === 'ar') {
      closeModalBtn.title = 'ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© Ø­ØªÙ‰ Ø§Ù„Ù†Ù‡Ø§ÙŠØ©';
    } else {
      closeModalBtn.title = 'Please read to the end';
    }
    
    // Show modal
    modal.classList.add('active');
    document.body.style.overflow = 'hidden';
    
    // Scroll to top
    modalContent.scrollTop = 0;
    
    // Update scroll tracking
    updateScrollProgress();
    
    // Initialize video tracking if this is terms modal
    if (type === 'terms') {
      setTimeout(initTermsVideoTracking, 500);
    } else {
      // Clean up video player if switching to privacy
      if (termsVideoPlayer) {
        termsVideoPlayer = null;
      }
    }
  }
  
  // Initialize Terms Video Anti-Skip Tracking
  let lastUpdateTimestamp = Date.now();
  let isSeeking = false;
  
  function initTermsVideoTracking() {
    const videoIframe = document.getElementById('termsVideoIframe');
    const videoStatus = document.getElementById('videoWatchStatus');
    const videoStatusText = document.getElementById('videoWatchStatusText');
    
    if (!videoIframe) return;
    
    // Reset video tracking
    termsVideoCompleted = false;
    termsVideoWatchedTime = 0;
    termsVideoMaxWatched = 0;
    termsVideoLastTime = 0;
    termsVideoIsPlaying = false;
    lastUpdateTimestamp = Date.now();
    isSeeking = false;
    
    // Show status
    if (videoStatus) {
      videoStatus.style.display = 'flex';
      videoStatus.className = 'video-watch-status';
      if (modalLang === 'ar') {
        videoStatusText.textContent = 'ÙŠØ¬Ø¨ Ù…Ø´Ø§Ù‡Ø¯Ø© Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©. Ø§Ù„ØªØ®Ø·ÙŠ ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­.';
      } else {
        videoStatusText.textContent = 'Video must be watched completely to proceed. Skipping is not allowed.';
      }
    }
    
    // Wait for playerjs to be available
    if (typeof playerjs === 'undefined') {
      console.error('PlayerJS library not loaded');
      return;
    }
    
    try {
      termsVideoPlayer = new playerjs.Player(videoIframe);
      
      termsVideoPlayer.on('ready', function() {
        termsVideoPlayer.getDuration(function(duration) {
          termsVideoDuration = duration;
          console.log('ðŸ“¹ Terms video duration:', termsVideoDuration);
        });
      });
      
      termsVideoPlayer.on('play', function() {
        termsVideoIsPlaying = true;
        if (videoStatus) {
          videoStatus.className = 'video-watch-status watching';
          if (modalLang === 'ar') {
            videoStatusText.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø©... ÙŠØ±Ø¬Ù‰ Ù…Ø´Ø§Ù‡Ø¯Ø© Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø­ØªÙ‰ Ø§Ù„Ù†Ù‡Ø§ÙŠØ©.';
          } else {
            videoStatusText.textContent = 'Watching... Please watch the video until the end.';
          }
        }
      });
      
      termsVideoPlayer.on('pause', function() {
        termsVideoIsPlaying = false;
      });
      
      // STRICT ANTI-SKIP: Track time updates with smart tolerance
      termsVideoPlayer.on('timeupdate', function(data) {
        if (termsVideoCompleted || isSeeking) return;
        
        const currentTime = data.seconds;
        const now = Date.now();
        const timeSinceLastUpdate = now - lastUpdateTimestamp;
        const timeDiff = currentTime - termsVideoLastTime;
        
        // Only check for skips if video is playing
        if (termsVideoIsPlaying) {
          // Calculate expected time advancement based on elapsed time (allow 10% tolerance for buffering)
          const expectedAdvancement = (timeSinceLastUpdate / 1000) * 1.1; // 1.1x for tolerance
          
          // Check for forward skip: current time jumped ahead significantly beyond what's been watched
          // Only prevent if jump is more than 2 seconds AND beyond max watched time
          if (currentTime > termsVideoMaxWatched + 2 && timeDiff > expectedAdvancement + 1) {
            // User tried to skip ahead - seek back silently
            isSeeking = true;
            termsVideoPlayer.setCurrentTime(termsVideoMaxWatched);
            setTimeout(() => { isSeeking = false; }, 100);
            return;
          }
          
          // Check for backward skip: only prevent if significantly behind max watched (more than 1 second)
          if (currentTime < termsVideoMaxWatched - 1) {
            // User tried to go backward - prevent it silently
            isSeeking = true;
            termsVideoPlayer.setCurrentTime(termsVideoMaxWatched);
            setTimeout(() => { isSeeking = false; }, 100);
            return;
          }
          
          // Update max watched time if playing forward normally
          // Allow small jumps (up to 2 seconds) for buffering/loading
          if (currentTime > termsVideoLastTime && timeDiff >= 0 && timeDiff <= 2.0) {
            if (currentTime > termsVideoMaxWatched) {
              termsVideoMaxWatched = currentTime;
            }
          }
        }
        
        termsVideoLastTime = currentTime;
        lastUpdateTimestamp = now;
        
        // Check if video is completed (watched 100%)
        if (termsVideoDuration > 0 && termsVideoMaxWatched >= termsVideoDuration * 0.99) {
          termsVideoCompleted = true;
          if (videoStatus) {
            videoStatus.className = 'video-watch-status completed';
            if (modalLang === 'ar') {
              videoStatusText.textContent = 'âœ“ ØªÙ…Øª Ù…Ø´Ø§Ù‡Ø¯Ø© Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„! ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©.';
            } else {
              videoStatusText.textContent = 'âœ“ Video watched completely! You can now proceed.';
            }
          }
          // Enable confirm button if scrolled to bottom
          checkTermsCompletion();
        }
      });
      
      // Handle video end
      termsVideoPlayer.on('ended', function() {
        termsVideoCompleted = true;
        termsVideoMaxWatched = termsVideoDuration;
        if (videoStatus) {
          videoStatus.className = 'video-watch-status completed';
          if (modalLang === 'ar') {
            videoStatusText.textContent = 'âœ“ ØªÙ…Øª Ù…Ø´Ø§Ù‡Ø¯Ø© Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„! ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©.';
          } else {
            videoStatusText.textContent = 'âœ“ Video watched completely! You can now proceed.';
          }
        }
        checkTermsCompletion();
      });
      
    } catch (error) {
      console.error('Error initializing terms video player:', error);
    }
  }
  
  // Check if terms can be completed (scrolled to bottom AND video completed)
  function checkTermsCompletion() {
    // Only enable buttons if:
    // 1. Current document is terms
    // 2. User has scrolled to bottom
    // 3. Video is completed
    // 4. Modal is actually active
    if (currentDocument === 'terms' && hasScrolledToBottom && termsVideoCompleted && modal.classList.contains('active')) {
      closeModalBtn.disabled = false;
      confirmReadBtn.disabled = false;
      confirmReadBtn.style.opacity = '1';
      confirmReadBtn.style.cursor = 'pointer';
      if (modalLang === 'ar') {
        closeModalBtn.title = 'Ø¥ØºÙ„Ø§Ù‚';
      } else {
        closeModalBtn.title = 'Close';
      }
    } else if (currentDocument === 'terms' && (!hasScrolledToBottom || !termsVideoCompleted)) {
      // Ensure buttons are disabled if requirements not met
      closeModalBtn.disabled = true;
      confirmReadBtn.disabled = true;
      confirmReadBtn.style.opacity = '0.5';
      confirmReadBtn.style.cursor = 'not-allowed';
    }
  }
  
  // Get modal content based on language
  function getModalContent(type, lang) {
    if (type === 'terms') {
      if (lang === 'ar') {
        return getTermsContentAR();
      }
      return getTermsContentEN();
    } else {
      if (lang === 'ar') {
        return getPrivacyContentAR();
      }
      return getPrivacyContentEN();
    }
  }
  
  function getTermsContentEN() {
    return termsContent;
  }
  
  function getTermsContentAR() {
    return `
      <div class="modal-document-content">
        <div class="document-section">
          <h3>Ø´Ø±ÙˆØ· Ø§Ù„Ø®Ø¯Ù…Ø©</h3>
          <p>Ø£ÙÙ‡Ù… Ø§Ù„Ø´Ø±ÙˆØ· ÙˆØ§Ù„Ø£Ø­ÙƒØ§Ù… Ø§Ù„Ø®Ø§ØµØ© Ø¨Ù†Ø§</p>
          <p>ÙŠØ±Ø¬Ù‰ Ù‚Ø±Ø§Ø¡Ø© Ù‡Ø°Ù‡ Ø§Ù„Ø´Ø±ÙˆØ· Ø¨Ø¹Ù†Ø§ÙŠØ© Ù‚Ø¨Ù„ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø®Ø¯Ù…Ø§ØªÙ†Ø§ Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ©.</p>
        </div>
        
        <div class="document-section">
          <h3>Ø´Ø±ÙˆØ· Ø§Ù„Ø®Ø¯Ù…Ø©</h3>
          <p>ØªØ­ÙƒÙ… Ù‡Ø°Ù‡ Ø§Ù„Ø´Ø±ÙˆØ· Ø§Ø³ØªØ®Ø¯Ø§Ù…Ùƒ Ù„Ù…Ù†ØµØ© Elkably.com Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ© ÙˆØ§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„ØªØ§Ø¨Ø¹Ø© Ù„Ù‡Ø§.</p>
        </div>
        
        <div class="document-section">
          <h3><span class="section-number">1</span> Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø´Ø±ÙˆØ·</h3>
          <p>Ù…Ù† Ø®Ù„Ø§Ù„ Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ù…Ù†ØµØ© Elkably.com Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ© ÙˆØ§Ø³ØªØ®Ø¯Ø§Ù…Ù‡Ø§ØŒ ÙØ¥Ù†Ùƒ ØªÙ‚Ø± ÙˆØªÙˆØ§ÙÙ‚ Ø¹Ù„Ù‰ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù… Ø¨Ù‡Ø°Ù‡ Ø§Ù„Ø´Ø±ÙˆØ· ÙˆØ§Ù„Ø£Ø­ÙƒØ§Ù….</p>
          <p>Ø¥Ø°Ø§ ÙƒÙ†Øª Ù„Ø§ ØªÙˆØ§ÙÙ‚ Ø¹Ù„Ù‰ Ø£ÙŠ Ø¬Ø²Ø¡ Ù…Ù† Ù‡Ø°Ù‡ Ø§Ù„Ø´Ø±ÙˆØ·ØŒ ÙÙŠØ±Ø¬Ù‰ Ø¹Ø¯Ù… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø®Ø¯Ù…Ø©.</p>
        </div>
        
        <div class="document-section">
          <h3><span class="section-number">2</span> Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ©</h3>
          <p>ØªÙˆÙØ± Elkably.com Ø®Ø¯Ù…Ø§Øª ØªØ¹Ù„ÙŠÙ…ÙŠØ© ØªØ´Ù…Ù„:</p>
          <ul>
            <li><i class="fas fa-check-circle"></i><span> Ø¯ÙˆØ±Ø§Øª Ø±ÙŠØ§Ø¶ÙŠØ§Øª Ø£ÙˆÙ†Ù„Ø§ÙŠÙ† Ø£Ùˆ Ø­Ø¶ÙˆØ±ÙŠ</span></li>
            <li><i class="fas fa-check-circle"></i><span> Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª ÙˆØªÙ…Ø§Ø±ÙŠÙ† ØªØ¯Ø±ÙŠØ¨ÙŠØ©</span></li>
            <li><i class="fas fa-check-circle"></i><span> Ù…ÙˆØ§Ø¯ ØªØ¹Ù„ÙŠÙ…ÙŠØ© ØªÙØ§Ø¹Ù„ÙŠØ©</span></li>
            <li><i class="fas fa-check-circle"></i><span> ØªØªØ¨Ø¹ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø·Ø§Ù„Ø¨ ÙˆØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø£Ø¯Ø§Ø¡</span></li>
            <li><i class="fas fa-check-circle"></i><span> Ø£Ù„Ø¹Ø§Ø¨ Ù…Ø³Ø§Ø¨Ù‚Ø§Øª Ø¬Ù…Ø§Ø¹ÙŠØ© (Multiplayer quizzes)</span></li>
          </ul>
          <p>Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø®Ø¯Ù…Ø§Øª ØªÙÙ‚Ø¯ÙŽÙ‘Ù… ÙƒÙ…Ø§ Ù‡ÙŠ "AS IS"ØŒ ÙˆÙ†Ø­ØªÙØ¸ Ø¨Ø§Ù„Ø­Ù‚ ÙÙŠ ØªØ¹Ø¯ÙŠÙ„ Ø£Ùˆ Ø¥ÙŠÙ‚Ø§Ù Ø£ÙŠ Ø®Ø¯Ù…Ø© ÙÙŠ Ø£ÙŠ ÙˆÙ‚Øª.</p>
        </div>
        
        <div class="document-section">
          <h3><span class="section-number">3</span> Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h3>
          <p>Ù„Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø¨Ø¹Ø¶ Ù…ÙŠØ²Ø§Øª Ù…Ù†ØµØªÙ†Ø§ØŒ ÙŠØ¬Ø¨ Ø¹Ù„ÙŠÙƒ Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨. Ø£Ù†Øª Ù…Ø³Ø¤ÙˆÙ„ Ø¹Ù†:</p>
          <ul>
            <li><i class="fas fa-check-circle"></i><span> ØªÙ‚Ø¯ÙŠÙ… Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¯Ù‚ÙŠÙ‚Ø© ÙˆÙƒØ§Ù…Ù„Ø©</span></li>
            <li><i class="fas fa-check-circle"></i><span> Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø£Ù…Ø§Ù† Ø­Ø³Ø§Ø¨Ùƒ</span></li>
            <li><i class="fas fa-check-circle"></i><span> Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù†Ø´Ø·Ø© Ø§Ù„ØªÙŠ ØªØªÙ… Ù…Ù† Ø®Ù„Ø§Ù„ Ø­Ø³Ø§Ø¨Ùƒ</span></li>
            <li><i class="fas fa-check-circle"></i><span> Ø¥Ø¨Ù„Ø§ØºÙ†Ø§ ÙÙˆØ±Ù‹Ø§ Ø¨Ø£ÙŠ Ø§Ø³ØªØ®Ø¯Ø§Ù… ØºÙŠØ± Ù…ØµØ±Ø­ Ø¨Ù‡</span></li>
          </ul>
        </div>
        
        <div class="document-section">
          <h3><span class="section-number">4</span> Ø´Ø±ÙˆØ· Ø§Ù„Ø¯ÙØ¹</h3>
          <p>Ø´Ø±ÙˆØ· Ø§Ù„Ø¯ÙØ¹ Ø§Ù„Ø®Ø§ØµØ© Ø¨Ø®Ø¯Ù…Ø§ØªÙ†Ø§:</p>
          <ul>
            <li><i class="fas fa-check-circle"></i><span> Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø±Ø³ÙˆÙ… ØºÙŠØ± Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„Ø§Ø³ØªØ±Ø¯Ø§Ø¯ Ø¥Ù„Ø§ Ø¥Ø°Ø§ Ø°ÙÙƒØ± Ø®Ù„Ø§Ù Ø°Ù„Ùƒ</span></li>
            <li><i class="fas fa-check-circle"></i><span> ÙŠØ¬Ø¨ Ø£Ù† ÙŠØªÙ… Ø§Ù„Ø¯ÙØ¹ Ù…Ù‚Ø¯Ù…Ù‹Ø§ Ù‚Ø¨Ù„ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø¯Ù…Ø©</span></li>
            <li><i class="fas fa-check-circle"></i><span> Ù†Ù‚Ø¨Ù„ Ø·Ø±Ù‚ Ø¯ÙØ¹ Ù…ØªØ¹Ø¯Ø¯Ø© ÙƒÙ…Ø§ ÙŠØ¸Ù‡Ø± Ø£Ø«Ù†Ø§Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¯ÙØ¹</span></li>
            <li><i class="fas fa-check-circle"></i><span> Ù‚Ø¯ ØªØªØºÙŠØ± Ø§Ù„Ø£Ø³Ø¹Ø§Ø± ÙÙŠ Ø£ÙŠ ÙˆÙ‚ØªØŒ ÙˆØ³ÙŠØªÙ… Ø¥Ø®Ø·Ø§Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ø­Ø§Ù„ÙŠÙŠÙ† Ø¨Ø°Ù„Ùƒ</span></li>
          </ul>
        </div>
        
        <div class="document-section">
          <h3><span class="section-number">5</span> Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ø¯ÙˆØ±Ø§Øª</h3>
          <ul>
            <li><i class="fas fa-check-circle"></i><span> <strong>Ø§Ù„Ø­Ø¶ÙˆØ± Ø¥Ù„Ø²Ø§Ù…ÙŠ</strong> Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­ØµØµ Ø³ÙˆØ§Ø¡ Ø£ÙˆÙ†Ù„Ø§ÙŠÙ† Ø£Ùˆ Ø­Ø¶ÙˆØ±ÙŠ.</span></li>
            <li><i class="fas fa-check-circle"></i><span> Ø£ÙŠ Ø·Ø§Ù„Ø¨ ÙŠØªØºÙŠØ¨ <strong>3 Ù…Ø±Ø§Øª</strong> Ø³ÙŠØªÙ… Ø§Ø³ØªØ¨Ø¹Ø§Ø¯Ù‡ Ù…Ù† Ø§Ù„ÙƒÙˆØ±Ø³ Ø³ÙˆØ§Ø¡ ÙƒØ§Ù† Ø£ÙˆÙ†Ù„Ø§ÙŠÙ† Ø£Ùˆ Ø­Ø¶ÙˆØ±ÙŠ.</span></li>
            <li><i class="fas fa-check-circle"></i><span> <strong>ØªØ³Ù„ÙŠÙ… Ø§Ù„ÙˆØ§Ø¬Ø¨ Ø¥Ù„Ø²Ø§Ù…ÙŠ</strong> Ù„Ù„Ø³Ù…Ø§Ø­ Ø¨Ø­Ø¶ÙˆØ± Ø§Ù„Ø­ØµØ©.</span></li>
            <li><i class="fas fa-check-circle"></i><span> ÙÙŠ Ø§Ù„Ø­ØµØµ Ø§Ù„Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†ØŒ <strong>ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ† Ø¥Ø¬Ø¨Ø§Ø±ÙŠ</strong> Ù„Ø¶Ù…Ø§Ù† Ù…Ø´Ø§Ø±ÙƒØ© ÙØ¹Ù‘Ø§Ù„Ø© Ù…Ø¹ Ù…Ø³ØªØ± ÙƒØ§Ø¨Ù„ÙŠ.</span></li>
            <li><i class="fas fa-check-circle"></i><span> <strong>Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ù…ÙØªÙˆØ­Ø©</strong> Ø®Ù„Ø§Ù„ Ø§Ù„Ø­ØµØ© Ù„Ø²ÙŠØ§Ø¯Ø© Ø§Ù„ØªÙØ§Ø¹Ù„ ÙˆØ§Ù„ØªÙˆØ§ØµÙ„.</span></li>
          </ul>
        </div>
        
        <div class="document-section">
          <h3><span class="section-number">6</span> ÙÙŠØ¯ÙŠÙˆ Ù…Ù‡Ù… (Ù…Ù†Ø¹ Ø§Ù„ØªØ®Ø·ÙŠ)</h3>
          <p><strong>ÙŠØ±Ø¬Ù‰ Ù…Ø´Ø§Ù‡Ø¯Ø© Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„ØªØ§Ù„ÙŠ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„. Ø§Ù„ØªØ®Ø·ÙŠ ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­.</strong></p>
          <div class="terms-video-container" id="termsVideoContainer">
            <div style="position:relative;padding-top:56.25%;">
              <iframe id="termsVideoIframe" src="https://iframe.mediadelivery.net/embed/533780/15dc74bf-f70b-4a87-b74d-993ad32adc2c?autoplay=false&loop=false&muted=false&preload=true&responsive=true&controls=false" loading="lazy" style="border:0;position:absolute;top:0;height:100%;width:100%;" allow="accelerometer;gyroscope;autoplay;encrypted-media;picture-in-picture;" allowfullscreen="true"></iframe>
            </div>
            <div class="video-watch-status" id="videoWatchStatus" style="margin-top: 15px; padding: 12px; background: #f8f9fa; border-radius: 8px; display: none;">
              <i class="fas fa-info-circle"></i> <span id="videoWatchStatusText">ÙŠØ¬Ø¨ Ù…Ø´Ø§Ù‡Ø¯Ø© Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©.</span>
            </div>
          </div>
        </div>
      </div>
    `;
  }
  
  function getPrivacyContentEN() {
    return privacyContent;
  }
  
  function getPrivacyContentAR() {
    return `
      <div class="modal-document-content">
        <div class="document-section">
          <h3><span class="section-number">1</span> Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªÙŠ Ù†Ø¬Ù…Ø¹Ù‡Ø§</h3>
          <h4>Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø´Ø®ØµÙŠØ©</h4>
          <p>Ø¹Ù†Ø¯ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ÙÙŠ Ø®Ø¯Ù…Ø§ØªÙ†Ø§ØŒ Ù†Ù‚ÙˆÙ… Ø¨Ø¬Ù…Ø¹:</p>
          <ul>
            <li><i class="fas fa-user"></i><span> Ø§Ù„Ø§Ø³Ù… ÙˆØ¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ÙˆØ§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</span></li>
            <li><i class="fas fa-phone"></i><span> Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ù‡Ø§ØªÙ (Ø§Ù„Ø·Ø§Ù„Ø¨ ÙˆØ§Ù„ÙˆØ§Ù„Ø¯)</span></li>
            <li><i class="fas fa-school"></i><span> Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø¯Ø±Ø³Ø© ÙˆÙ…Ø³ØªÙˆÙ‰ Ø§Ù„ØµÙ</span></li>
            <li><i class="fas fa-chalkboard-teacher"></i><span> Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù…</span></li>
          </ul>
          <h4>Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ©</h4>
          <p>Ù„ØªÙˆÙÙŠØ± ØªØ¬Ø§Ø±Ø¨ ØªØ¹Ù„ÙŠÙ…ÙŠØ© Ù…Ø®ØµØµØ©ØŒ Ù†Ù‚ÙˆÙ… Ø¨Ø¬Ù…Ø¹:</p>
          <ul>
            <li><i class="fas fa-chart-line"></i><span> Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª ÙˆØ§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª</span></li>
            <li><i class="fas fa-clock"></i><span> Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ø³ØªØºØ±Ù‚ ÙÙŠ Ø§Ù„Ø£Ù†Ø´Ø·Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ©</span></li>
            <li><i class="fas fa-book"></i><span> Ø¨ÙŠØ§Ù†Ø§Øª ØªÙ‚Ø¯Ù… Ø§Ù„Ø¯ÙˆØ±Ø© ÙˆØ¥ØªÙ…Ø§Ù…Ù‡Ø§</span></li>
            <li><i class="fas fa-gamepad"></i><span> Ù…Ø´Ø§Ø±ÙƒØ© ØºØ±ÙØ© Ø§Ù„Ù„Ø¹Ø¨Ø© ÙˆØ§Ù„ØªØ±ØªÙŠØ¨</span></li>
            <li><i class="fas fa-star"></i><span> ØªØ­Ù„ÙŠÙ„Ø§Øª Ø§Ù„Ø£Ø¯Ø§Ø¡ ÙˆØ§Ù„Ø±Ø¤Ù‰</span></li>
          </ul>
        </div>
        <div class="document-section">
          <h3><span class="section-number">2</span> ÙƒÙŠÙÙŠØ© Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…Ø¹Ù„ÙˆÙ…Ø§ØªÙƒ</h3>
          <p>Ù†Ø³ØªØ®Ø¯Ù… Ù…Ø¹Ù„ÙˆÙ…Ø§ØªÙƒ Ù„Ù„Ø£ØºØ±Ø§Ø¶ Ø§Ù„ØªØ§Ù„ÙŠØ©:</p>
          <ul>
            <li><i class="fas fa-graduation-cap"></i><span> <strong>Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ©:</strong> ØªÙˆÙÙŠØ± ØªØ¬Ø§Ø±Ø¨ ØªØ¹Ù„ÙŠÙ…ÙŠØ© Ù…Ø®ØµØµØ© ÙˆØªØªØ¨Ø¹ Ø§Ù„ØªÙ‚Ø¯Ù…</span></li>
            <li><i class="fas fa-comments"></i><span> <strong>Ø§Ù„ØªÙˆØ§ØµÙ„:</strong> Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª ÙˆØ§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ÙˆØ§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠ Ø§Ù„Ù…Ù‡Ù…</span></li>
            <li><i class="fas fa-cogs"></i><span> <strong>ØªØ­Ø³ÙŠÙ† Ø§Ù„Ù…Ù†ØµØ©:</strong> ØªØ¹Ø²ÙŠØ² Ø®Ø¯Ù…Ø§ØªÙ†Ø§ ÙˆØªØ·ÙˆÙŠØ± Ù…ÙŠØ²Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©</span></li>
            <li><i class="fas fa-shield-alt"></i><span> <strong>Ø§Ù„Ø£Ù…Ø§Ù†:</strong> Ø§Ù„Ø­Ù…Ø§ÙŠØ© Ù…Ù† Ø§Ù„Ø§Ø­ØªÙŠØ§Ù„ ÙˆØ§Ù„ÙˆØµÙˆÙ„ ØºÙŠØ± Ø§Ù„Ù…ØµØ±Ø­ Ø¨Ù‡</span></li>
            <li><i class="fas fa-chart-bar"></i><span> <strong>Ø§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª:</strong> ÙÙ‡Ù… Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù„ØªØ­Ø³ÙŠÙ† Ù…Ù†ØµØªÙ†Ø§</span></li>
            <li><i class="fas fa-credit-card"></i><span> <strong>Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª:</strong> Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ù…Ø´ØªØ±ÙŠØ§Øª Ø§Ù„Ø¯ÙˆØ±Ø§Øª ÙˆØ§Ù„ÙÙˆØ§ØªÙŠØ±</span></li>
          </ul>
        </div>
        <div class="document-section">
          <h3><span class="section-number">3</span> Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª ÙˆØ§Ù„Ø¥ÙØµØ§Ø­</h3>
          <p>Ù†Ø­Ù† Ù„Ø§ Ù†Ø¨ÙŠØ¹ Ø£Ùˆ Ù†ØªØ§Ø¬Ø± Ø£Ùˆ Ù†Ø¤Ø¬Ø± Ù…Ø¹Ù„ÙˆÙ…Ø§ØªÙƒ Ø§Ù„Ø´Ø®ØµÙŠØ©. Ù‚Ø¯ Ù†Ø´Ø§Ø±Ùƒ Ù…Ø¹Ù„ÙˆÙ…Ø§ØªÙƒ ÙÙŠ Ø§Ù„Ø¸Ø±ÙˆÙ Ø§Ù„Ù…Ø­Ø¯ÙˆØ¯Ø© Ø§Ù„ØªØ§Ù„ÙŠØ©:</p>
          <ul>
            <li><i class="fas fa-users"></i><span> <strong>Ø¨Ù…ÙˆØ§ÙÙ‚ØªÙƒ:</strong> Ø¹Ù†Ø¯Ù…Ø§ ØªÙˆØ§ÙÙ‚ ØµØ±Ø§Ø­Ø© Ø¹Ù„Ù‰ Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª</span></li>
            <li><i class="fas fa-gavel"></i><span> <strong>Ø§Ù„Ù…ØªØ·Ù„Ø¨Ø§Øª Ø§Ù„Ù‚Ø§Ù†ÙˆÙ†ÙŠØ©:</strong> Ø¹Ù†Ø¯Ù…Ø§ ÙŠØªØ·Ù„Ø¨ Ø§Ù„Ù‚Ø§Ù†ÙˆÙ† Ø°Ù„Ùƒ Ø£Ùˆ Ù„Ø­Ù…Ø§ÙŠØ© Ø­Ù‚ÙˆÙ‚Ù†Ø§</span></li>
            <li><i class="fas fa-handshake"></i><span> <strong>Ù…Ù‚Ø¯Ù…ÙŠ Ø§Ù„Ø®Ø¯Ù…Ø§Øª:</strong> Ù…Ø¹ Ø£Ø·Ø±Ø§Ù Ø«Ø§Ù„Ø«Ø© Ù…ÙˆØ«ÙˆÙ‚Ø© ØªØ³Ø§Ø¹Ø¯Ù†Ø§ ÙÙŠ ØªØ´ØºÙŠÙ„ Ù…Ù†ØµØªÙ†Ø§</span></li>
            <li><i class="fas fa-shield-alt"></i><span> <strong>Ø§Ù„Ø³Ù„Ø§Ù…Ø© ÙˆØ§Ù„Ø£Ù…Ø§Ù†:</strong> Ù„Ø­Ù…Ø§ÙŠØ© Ø³Ù„Ø§Ù…Ø© Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†Ø§ ÙˆÙ…Ù†ØµØªÙ†Ø§</span></li>
          </ul>
        </div>
        <div class="document-section">
          <h3><span class="section-number">4</span> Ø£Ù…Ø§Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h3>
          <p>Ù†Ø·Ø¨Ù‚ ØªØ¯Ø§Ø¨ÙŠØ± Ø£Ù…Ù†ÙŠØ© Ø´Ø§Ù…Ù„Ø© Ù„Ø­Ù…Ø§ÙŠØ© Ù…Ø¹Ù„ÙˆÙ…Ø§ØªÙƒ:</p>
          <ul>
            <li><i class="fas fa-lock"></i><span> <strong>Ø§Ù„ØªØ´ÙÙŠØ±:</strong> ÙŠØªÙ… ØªØ´ÙÙŠØ± Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù†Ù‚Ù„ ÙˆØ§Ù„ØªØ®Ø²ÙŠÙ†</span></li>
            <li><i class="fas fa-server"></i><span> <strong>Ø®ÙˆØ§Ø¯Ù… Ø¢Ù…Ù†Ø©:</strong> Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø®Ø²Ù†Ø© Ø¹Ù„Ù‰ Ø®ÙˆØ§Ø¯Ù… Ø¢Ù…Ù†Ø© ÙˆÙ…Ø±Ø§Ù‚Ø¨Ø©</span></li>
            <li><i class="fas fa-key"></i><span> <strong>Ø¶ÙˆØ§Ø¨Ø· Ø§Ù„ÙˆØµÙˆÙ„:</strong> ÙˆØµÙˆÙ„ Ù…Ø­Ø¯ÙˆØ¯ Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø´Ø®ØµÙŠØ© Ø¹Ù„Ù‰ Ø£Ø³Ø§Ø³ Ø§Ù„Ø­Ø§Ø¬Ø© Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø¹Ø±ÙØ©</span></li>
            <li><i class="fas fa-shield-alt"></i><span> <strong>Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚ Ø§Ù„Ù…Ù†ØªØ¸Ù…Ø©:</strong> ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ø§Ù„Ø£Ù…Ø§Ù† ÙˆØ§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø«ØºØ±Ø§Øª</span></li>
            <li><i class="fas fa-user-shield"></i><span> <strong>ØªØ¯Ø±ÙŠØ¨ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†:</strong> ØªØ¯Ø±ÙŠØ¨ Ù…Ù†ØªØ¸Ù… Ø¹Ù„Ù‰ Ø§Ù„Ø®ØµÙˆØµÙŠØ© ÙˆØ§Ù„Ø£Ù…Ø§Ù† Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</span></li>
          </ul>
        </div>
        <div class="document-section">
          <h3><span class="section-number">5</span> Ø­Ù‚ÙˆÙ‚Ùƒ ÙˆØ®ÙŠØ§Ø±Ø§ØªÙƒ</h3>
          <p>Ù„Ø¯ÙŠÙƒ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ø§Ù„ØªØ§Ù„ÙŠØ© ÙÙŠÙ…Ø§ ÙŠØªØ¹Ù„Ù‚ Ø¨Ù…Ø¹Ù„ÙˆÙ…Ø§ØªÙƒ Ø§Ù„Ø´Ø®ØµÙŠØ©:</p>
          <ul>
            <li><i class="fas fa-eye"></i><span> <strong>Ø§Ù„ÙˆØµÙˆÙ„:</strong> Ø·Ù„Ø¨ Ù†Ø³Ø®Ø© Ù…Ù† Ù…Ø¹Ù„ÙˆÙ…Ø§ØªÙƒ Ø§Ù„Ø´Ø®ØµÙŠØ©</span></li>
            <li><i class="fas fa-edit"></i><span> <strong>Ø§Ù„ØªØµØ­ÙŠØ­:</strong> ØªØ­Ø¯ÙŠØ« Ø£Ùˆ ØªØµØ­ÙŠØ­ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª ØºÙŠØ± Ø¯Ù‚ÙŠÙ‚Ø©</span></li>
            <li><i class="fas fa-trash"></i><span> <strong>Ø§Ù„Ø­Ø°Ù:</strong> Ø·Ù„Ø¨ Ø­Ø°Ù Ù…Ø¹Ù„ÙˆÙ…Ø§ØªÙƒ Ø§Ù„Ø´Ø®ØµÙŠØ©</span></li>
            <li><i class="fas fa-ban"></i><span> <strong>Ø§Ù„Ù‚ÙŠÙˆØ¯:</strong> ØªØ­Ø¯ÙŠØ¯ ÙƒÙŠÙÙŠØ© Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù†Ø§ Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§ØªÙƒ</span></li>
            <li><i class="fas fa-download"></i><span> <strong>Ù‚Ø§Ø¨Ù„ÙŠØ© Ø§Ù„Ù†Ù‚Ù„:</strong> ØªØµØ¯ÙŠØ± Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ø¨ØªÙ†Ø³ÙŠÙ‚ Ù‚Ø§Ø¨Ù„ Ù„Ù„Ù‚Ø±Ø§Ø¡Ø© Ø¢Ù„ÙŠØ§Ù‹</span></li>
            <li><i class="fas fa-bell-slash"></i><span> <strong>Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ:</strong> Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„Ø§Øª Ø§Ù„ØªØ³ÙˆÙŠÙ‚ÙŠØ©</span></li>
          </ul>
        </div>
      </div>
    `;
  }
  
  // Close Modal Function
  function closeModal() {
    modal.classList.remove('active');
    document.body.style.overflow = '';
  }
  
  // Modal Language Toggle
  let modalLang = localStorage.getItem('modalLang') || 'en';
  const modalLangToggle = document.getElementById('modalLangToggle');
  const progressPercentage = document.getElementById('progressPercentage');
  
  // Initialize modal language button - Show opposite language
  if (modalLangToggle) {
    if (modalLang === 'ar') {
      // When Arabic is selected, show "EN" button
      modalLangToggle.querySelector('.modal-lang-text').textContent = 'EN';
    } else {
      // When English is selected, show "AR" button
      modalLangToggle.querySelector('.modal-lang-text').textContent = 'AR';
    }
    modalLangToggle.setAttribute('data-lang', modalLang);
  }
  
  if (modalLangToggle) {
    modalLangToggle.addEventListener('click', function() {
      modalLang = modalLang === 'en' ? 'ar' : 'en';
      localStorage.setItem('modalLang', modalLang);
      
      // Save current scroll position and completion status
      const currentScrollTop = modalContent.scrollTop;
      const wasAtBottom = hasScrolledToBottom;
      
      // Reload modal content with new language
      applyModalLanguage(modalLang);
      
      // Restore scroll position after content loads
      setTimeout(() => {
        modalContent.scrollTop = currentScrollTop;
        updateScrollProgress();
        // If was at bottom, ensure buttons are still enabled (but check video completion for terms)
        // Only enable if the current document hasn't been confirmed yet
        if (wasAtBottom && modalContent.scrollTop + modalContent.clientHeight >= modalContent.scrollHeight - 10) {
          hasScrolledToBottom = true;
          // Reinitialize video if terms modal
          if (currentDocument === 'terms') {
            // Only reinitialize if terms hasn't been confirmed yet
            if (!readingStatus.terms) {
              setTimeout(initTermsVideoTracking, 100);
              checkTermsCompletion();
            } else {
              // If already confirmed, buttons should remain disabled until user scrolls again
              closeModalBtn.disabled = true;
              confirmReadBtn.disabled = true;
              confirmReadBtn.style.opacity = '0.5';
              confirmReadBtn.style.cursor = 'not-allowed';
            }
          } else if (currentDocument === 'privacy') {
            // For privacy modal, only enable if not already confirmed
            if (!readingStatus.privacy) {
              closeModalBtn.disabled = false;
              confirmReadBtn.disabled = false;
              confirmReadBtn.style.opacity = '1';
              confirmReadBtn.style.cursor = 'pointer';
              if (modalLang === 'ar') {
                closeModalBtn.title = 'Ø¥ØºÙ„Ø§Ù‚';
              } else {
                closeModalBtn.title = 'Close';
              }
            } else {
              // If already confirmed, buttons should remain disabled
              closeModalBtn.disabled = true;
              confirmReadBtn.disabled = true;
              confirmReadBtn.style.opacity = '0.5';
              confirmReadBtn.style.cursor = 'not-allowed';
            }
          }
        } else {
          // If not at bottom, ensure buttons are disabled
          closeModalBtn.disabled = true;
          confirmReadBtn.disabled = true;
          confirmReadBtn.style.opacity = '0.5';
          confirmReadBtn.style.cursor = 'not-allowed';
        }
      }, 50);
    });
  }
  
  function applyModalLanguage(lang) {
    // Update language toggle button - Show opposite language
    if (modalLangToggle) {
      if (lang === 'ar') {
        // When Arabic is selected, show "EN" button (to switch to English)
        modalLangToggle.querySelector('.modal-lang-text').textContent = 'EN';
        modalLangToggle.setAttribute('data-lang', 'ar');
      } else {
        // When English is selected, show "AR" button (to switch to Arabic)
        modalLangToggle.querySelector('.modal-lang-text').textContent = 'AR';
        modalLangToggle.setAttribute('data-lang', 'en');
      }
    }
    
    // Reload modal content with new language if document is set
    if (currentDocument) {
      // Get the new content in the selected language
      const newContent = getModalContent(currentDocument, lang);
      modalContent.innerHTML = newContent;
    }
    
    // Apply RTL only to modal content, not the whole modal
    if (lang === 'ar') {
      modalContent.classList.add('rtl');
    } else {
      modalContent.classList.remove('rtl');
    }
    
    // Update all text elements with data attributes (for buttons, progress text, etc.)
    // Exclude modal title as it's set based on currentDocument
    const textElements = modal.querySelectorAll('[data-english][data-arabic]');
    textElements.forEach(element => {
      // Skip modal title - it will be set separately based on currentDocument
      if (element.id === 'modalTitle') return;
      const text = lang === 'ar' ? element.getAttribute('data-arabic') : element.getAttribute('data-english');
      element.textContent = text;
    });
    
    // Update modal title based on currentDocument (after data attribute update to ensure it takes precedence)
    if (currentDocument) {
      if (currentDocument === 'terms') {
        const titleText = lang === 'ar' ? 'Ø´Ø±ÙˆØ· Ø§Ù„Ø®Ø¯Ù…Ø©' : 'Terms of Service';
        modalTitle.textContent = titleText;
      } else if (currentDocument === 'privacy') {
        const titleText = lang === 'ar' ? 'Ø³ÙŠØ§Ø³Ø© Ø§Ù„Ø®ØµÙˆØµÙŠØ©' : 'Privacy Policy';
        modalTitle.textContent = titleText;
      }
    }
    
    // Update buttons text
    const confirmBtnText = confirmReadBtn.querySelector('span').getAttribute(lang === 'ar' ? 'data-arabic' : 'data-english');
    if (confirmBtnText) confirmReadBtn.querySelector('span').textContent = confirmBtnText;
    
    const closeBtnTitle = closeModalBtn.getAttribute(lang === 'ar' ? 'data-arabic-title' : 'data-english-title');
    if (closeBtnTitle) closeModalBtn.title = closeBtnTitle;
    
    // Update progress text
    updateProgressText();
  }
  
  function updateProgressText() {
    const scrollTop = modalContent.scrollTop;
    const scrollHeight = modalContent.scrollHeight;
    const clientHeight = modalContent.clientHeight;
    const scrollableHeight = scrollHeight - clientHeight;
    const scrollPercentage = (scrollTop / scrollableHeight) * 100;
    const percentage = Math.round(Math.min(scrollPercentage, 100));
    
    if (percentage >= 100) {
      readingProgressText.textContent = modalLang === 'ar' ? 'Ø§ÙƒØªÙ…Ù„Øª Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©! âœ“' : 'Reading complete! âœ“';
    } else {
      const text = readingProgressText.getAttribute(modalLang === 'ar' ? 'data-arabic' : 'data-english');
      readingProgressText.textContent = text.replace('0%', `${percentage}%`);
    }
    if (progressPercentage) {
      progressPercentage.textContent = `${percentage}%`;
    }
  }
  
  // Update Scroll Progress
  function updateScrollProgress() {
    const scrollTop = modalContent.scrollTop;
    const scrollHeight = modalContent.scrollHeight;
    const clientHeight = modalContent.clientHeight;
    
    const scrollableHeight = scrollHeight - clientHeight;
    const scrollPercentage = (scrollTop / scrollableHeight) * 100;
    const percentage = Math.min(scrollPercentage, 100);
    
    // Update progress bar
    readingProgressFill.style.width = percentage + '%';
    
    // Update progress text and percentage
    updateProgressText();
    
    // Update progress steps visibility
    const steps = document.querySelectorAll('.progress-step');
    steps.forEach((step, index) => {
      const stepValue = [25, 50, 75][index];
      if (percentage >= stepValue) {
        step.style.opacity = '1';
        step.style.background = '#dc2626';
      } else {
        step.style.opacity = '0.5';
        step.style.background = 'rgba(255, 255, 255, 0.6)';
      }
    });
    
    // Check if user has scrolled to the bottom (with 10px threshold)
    if (scrollTop + clientHeight >= scrollHeight - 10) {
      hasScrolledToBottom = true;
      updateProgressText();
      
      // For terms modal, check video completion too
      if (currentDocument === 'terms') {
        checkTermsCompletion();
      } else if (currentDocument === 'privacy') {
        // For privacy modal (no video), enable buttons when scrolled to bottom
        // Only enable if this is actually the privacy modal that's open
        if (modal.classList.contains('active') && currentDocument === 'privacy') {
          closeModalBtn.disabled = false;
          confirmReadBtn.disabled = false;
          confirmReadBtn.style.opacity = '1';
          confirmReadBtn.style.cursor = 'pointer';
          if (modalLang === 'ar') {
            closeModalBtn.title = 'Ø¥ØºÙ„Ø§Ù‚';
          } else {
            closeModalBtn.title = 'Close';
          }
        }
      }
    } else {
      // If not at bottom, ensure buttons are disabled (unless already confirmed)
      // Only disable if the current document hasn't been confirmed yet
      if (currentDocument === 'privacy' && !readingStatus.privacy) {
        closeModalBtn.disabled = true;
        confirmReadBtn.disabled = true;
        confirmReadBtn.style.opacity = '0.5';
        confirmReadBtn.style.cursor = 'not-allowed';
      } else if (currentDocument === 'terms' && !readingStatus.terms) {
        // For terms, buttons are controlled by checkTermsCompletion
        // But ensure they're disabled if video not completed
        if (!termsVideoCompleted) {
          closeModalBtn.disabled = true;
          confirmReadBtn.disabled = true;
          confirmReadBtn.style.opacity = '0.5';
          confirmReadBtn.style.cursor = 'not-allowed';
        }
      }
    }
  }
  
  // Confirm Read Function
  function confirmRead() {
    // Ensure we have a valid current document
    if (!currentDocument || (currentDocument !== 'terms' && currentDocument !== 'privacy')) {
      return;
    }
    
    if (!hasScrolledToBottom) return;
    
    // For terms, also require video completion
    if (currentDocument === 'terms' && !termsVideoCompleted) {
      const videoStatus = document.getElementById('videoWatchStatus');
      const videoStatusText = document.getElementById('videoWatchStatusText');
      if (videoStatus) {
        videoStatus.style.display = 'flex';
        videoStatus.className = 'video-watch-status';
        if (modalLang === 'ar') {
          videoStatusText.textContent = 'âš ï¸ ÙŠØ¬Ø¨ Ù…Ø´Ø§Ù‡Ø¯Ø© Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ Ù‚Ø¨Ù„ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©!';
        } else {
          videoStatusText.textContent = 'âš ï¸ You must watch the video completely before proceeding!';
        }
      }
      return;
    }
    
    // Only mark the CURRENT document as read - never affect the other document
    if (currentDocument === 'terms') {
      readingStatus.terms = true;
      const card = document.getElementById('openTermsModal');
      termsReadStatus.className = 'document-status status-completed';
      termsReadStatus.innerHTML = '<i class="fas fa-check-circle"></i> Completed';
      if (card) {
        card.classList.add('completed');
      }
    } else if (currentDocument === 'privacy') {
      readingStatus.privacy = true;
      const card = document.getElementById('openPrivacyModal');
      privacyReadStatus.className = 'document-status status-completed';
      privacyReadStatus.innerHTML = '<i class="fas fa-check-circle"></i> Completed';
      if (card) {
        card.classList.add('completed');
      }
    }
    
    // Show completion notice and enable submit button if both are read
    if (readingStatus.terms && readingStatus.privacy) {
      if (termsCompletionNotice) {
        termsCompletionNotice.style.display = 'flex';
      }
      if (submitBtn) {
        submitBtn.disabled = false;
        submitBtn.classList.remove('btn-disabled');
        // Scroll to submit button for better UX
        setTimeout(() => {
          submitBtn.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }, 300);
      }
    }
    
    // Close modal
    closeModal();
  }
  
  // Event Listeners
  if (openTermsModal) {
    openTermsModal.addEventListener('click', function(e) {
      e.preventDefault();
      openModal('terms');
    });
  }
  
  if (openPrivacyModal) {
    openPrivacyModal.addEventListener('click', function(e) {
      e.preventDefault();
      openModal('privacy');
    });
  }
  
  if (closeModalBtn) {
    closeModalBtn.addEventListener('click', closeModal);
  }
  
  if (modalOverlay) {
    modalOverlay.addEventListener('click', function() {
      if (!closeModalBtn.disabled) {
        closeModal();
      }
    });
  }
  
  if (confirmReadBtn) {
    confirmReadBtn.addEventListener('click', confirmRead);
  }
  
  if (modalContent) {
    modalContent.addEventListener('scroll', updateScrollProgress);
  }
  
  // ESC key to close (only if reading is complete)
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && modal.classList.contains('active') && !closeModalBtn.disabled) {
      closeModal();
    }
  });
  
  // Auto-hide server-side error alerts after a longer duration (30 seconds)
  const errorAlert = document.querySelector('.alert-danger.auth-alert');
  if (errorAlert) {
    setTimeout(() => {
      errorAlert.style.transition = 'opacity 0.5s ease-out';
      errorAlert.style.opacity = '0';
      setTimeout(() => {
        errorAlert.style.display = 'none';
      }, 500);
    }, 30000); // 30 seconds
  }
});
</script>

