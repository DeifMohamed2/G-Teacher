<%- include('../partials/header') %>

<!-- Flash messages are now handled in the header partial -->

<!-- Modern Split-Screen Forgot Password Layout -->
<div class="auth-container-modern register-layout">
  <!-- Left Side - Branding & Visual -->
  <div class="auth-visual-section">
    <div class="auth-visual-overlay"></div>
    <div class="auth-particles" id="auth-particles-forgot"></div>
    
    <!-- Floating Math Elements -->
    <div class="math-shape-auth auth-shape1 floating-element"></div>
    <div class="math-shape-auth auth-shape2 floating-element"></div>
    <div class="math-shape-auth auth-shape3 floating-element"></div>
    <div class="math-shape-auth auth-shape4 floating-element"></div>
    
    <!-- Brand Content -->
    <div class="auth-brand-content">
      <div class="auth-logo-container">
        <div class="auth-logo-icon">
          <img src="/images/K.png" alt="Elkably Logo" class="auth-main-logo">
        </div>
        <h1 class="auth-brand-title">Elkably</h1>
        <p class="auth-brand-subtitle">Math Is <br> Root of Knowledge</p>
      </div>
      
      <div class="auth-features">
        <div class="auth-feature-item" data-aos="fade-right" data-aos-delay="100">
          <img src="/images/ESTLOGO.jpg" alt="EST" class="auth-feature-logo">
          <span>EST</span>
        </div>
        <div class="auth-feature-item" data-aos="fade-right" data-aos-delay="200">
          <img src="/images/SATLOGO.jpg" alt="SAT" class="auth-feature-logo">
          <span>D-SAT</span>
        </div>
        <div class="auth-feature-item" data-aos="fade-right" data-aos-delay="300">
          <img src="/images/ACTLOGO.jpg" alt="ACT" class="auth-feature-logo">
          <span>ACT</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Right Side - Forgot Password Form -->
  <div class="auth-form-section">
    <div class="auth-form-container">
      <!-- Header -->
      <div class="auth-form-header">
        <h2 class="auth-form-title">
          <i class="fas fa-key me-2"></i>
          Reset Your Password
        </h2>
        <p class="auth-form-subtitle">Recover your account with OTP verification</p>
        
        <!-- Progress Steps -->
        <div class="registration-steps">
          <div class="step-item active" data-step="1">
            <div class="step-number">1</div>
            <span class="step-label">Find Account</span>
          </div>
          <div class="step-item" data-step="2">
            <div class="step-number">2</div>
            <span class="step-label">Verify OTP</span>
          </div>
          <div class="step-item" data-step="3">
            <div class="step-number">3</div>
            <span class="step-label">New Password</span>
          </div>
        </div>
      </div>

      <!-- Display Errors -->
      <% if (typeof errors !== 'undefined' && errors.length > 0) { %>
      <div class="alert alert-danger auth-alert" role="alert">
        <div class="d-flex align-items-center">
          <i class="fas fa-exclamation-triangle me-2"></i>
          <strong>Error!</strong>
        </div>
        <hr class="my-2">
        <ul class="mb-0">
          <% errors.forEach(function(error) { %>
          <li><%= error.msg %></li>
          <% }); %>
        </ul>
      </div>
      <% } %>

      <!-- Display Success Messages -->
      <% if (typeof success_msg !== 'undefined' && success_msg.length > 0) { %>
      <div class="alert alert-success auth-alert" role="alert">
        <div class="d-flex align-items-center">
          <i class="fas fa-check-circle me-2"></i>
          <strong>Success!</strong>
        </div>
        <hr class="my-2">
        <p class="mb-0"><%= success_msg %></p>
      </div>
      <% } %>

      <!-- Forgot Password Form -->
      <form action="/auth/reset-password" method="POST" class="auth-form needs-validation" novalidate>
        <!-- Hidden submission ID to prevent duplicate submissions -->
        <input type="hidden" name="submissionId" id="submissionId" value="">
        <!-- Hidden field to pass OTP verification state -->
        <input type="hidden" id="serverOtpVerified" value="<%= typeof phoneVerified !== 'undefined' && phoneVerified ? 'true' : 'false' %>">
        <!-- Hidden field to store user ID after account is found -->
        <input type="hidden" name="userId" id="userId" value="<%= typeof userId !== 'undefined' ? userId : '' %>">
        <!-- Hidden field to store phone number -->
        <input type="hidden" name="phoneNumber" id="phoneNumber" value="<%= typeof phoneNumber !== 'undefined' ? phoneNumber : '' %>">
        <input type="hidden" name="countryCode" id="countryCode" value="<%= typeof countryCode !== 'undefined' ? countryCode : '' %>">
        
        <!-- Step 1: Find Account -->
        <div class="form-step active" data-step="1">
          <h3 class="step-title">Find Your Account</h3>
          
          <div class="form-group-modern">
            <label for="identifier" class="form-label-modern">
              <i class="fas fa-search form-label-icon"></i>
              Phone Number, Username, or Email *
            </label>
            <div class="input-group-modern">
              <input type="text" id="identifier" name="identifier" class="form-control-modern" 
                     placeholder="Enter phone number, username, or email" 
                     value="<%= typeof identifier != 'undefined' ? identifier : '' %>" required>
              <div class="input-focus-line"></div>
            </div>
            <div class="form-text-modern">We'll send an OTP to your registered phone number</div>
            <div class="invalid-feedback-modern">Please enter your phone number, username, or email.</div>
          </div>

          <!-- Account Found Info -->
          <div id="accountFoundInfo" style="display: none;" class="account-found-info">
            <div class="info-card">
              <i class="fas fa-check-circle"></i>
              <div class="info-content">
                <strong>Account Found!</strong>
                <p id="accountInfoText">OTP will be sent to your registered phone number</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Step 2: Verify OTP -->
        <div class="form-step" data-step="2">
          <h3 class="step-title">Verify OTP</h3>
          
          <div class="form-group-modern">
            <label class="form-label-modern">
              <i class="fas fa-mobile-alt form-label-icon"></i>
              Phone Number
            </label>
            <div class="input-group-modern">
              <input type="text" id="displayPhoneNumber" class="form-control-modern" readonly disabled 
                     value="<%= typeof phoneNumber !== 'undefined' && typeof countryCode !== 'undefined' && phoneNumber && countryCode ? countryCode + phoneNumber : '' %>">
              <div class="input-focus-line"></div>
            </div>
            <div class="form-text-modern">OTP has been sent to this number</div>
          </div>

          <!-- OTP Verification Section -->
          <div class="otp-verification-section" id="otpSection">
            <div class="otp-section-content">
              <div class="otp-input-group" id="otpInputGroup">
                <input type="text" id="otpInput" class="form-control-modern otp-input" 
                       placeholder="000000" maxlength="6" pattern="[0-9]{6}">
                <button type="button" id="verifyOtpBtn" class="btn-verify-otp">
                  <i class="fas fa-check"></i> Verify
                </button>
              </div>
              <div class="otp-status" id="otpStatus"></div>
              <div class="otp-timer" id="otpTimer" style="display: none;">
                <i class="fas fa-clock"></i> Resend OTP in <span id="otpCountdown">60</span>s
              </div>
              <button type="button" id="resendOtpBtn" class="btn-resend-otp" style="display: none;">
                <i class="fas fa-redo"></i> Resend OTP
              </button>
            </div>
          </div>
        </div>

        <!-- Step 3: New Password -->
        <div class="form-step" data-step="3">
          <h3 class="step-title">Set New Password</h3>
          
          <div class="form-row-modern">
            <div class="form-group-modern">
              <label for="newPassword" class="form-label-modern">
                <i class="fas fa-lock form-label-icon"></i>
                New Password *
              </label>
              <div class="input-group-modern">
                <input type="password" id="newPassword" name="newPassword" class="form-control-modern" 
                       placeholder="Enter new password" required minlength="6" autocomplete="new-password">
                <button class="btn-toggle-password" type="button" id="toggleNewPassword">
                  <i class="fas fa-eye"></i>
                </button>
                <div class="input-focus-line"></div>
              </div>
              <div class="form-text-modern">Password must be at least 6 characters long.</div>
              <div class="invalid-feedback-modern">Password must be at least 6 characters.</div>
            </div>

            <div class="form-group-modern">
              <label for="confirmPassword" class="form-label-modern">
                <i class="fas fa-lock form-label-icon"></i>
                Confirm Password *
              </label>
              <div class="input-group-modern">
                <input type="password" id="confirmPassword" name="confirmPassword" class="form-control-modern" 
                       placeholder="Confirm new password" required autocomplete="new-password">
                <button class="btn-toggle-password" type="button" id="toggleConfirmPassword">
                  <i class="fas fa-eye"></i>
                </button>
                <div class="input-focus-line"></div>
              </div>
              <div class="invalid-feedback-modern">Please confirm your password.</div>
            </div>
          </div>
        </div>

        <!-- Navigation Buttons -->
        <div class="form-navigation">
          <button type="button" class="btn-nav btn-nav-prev" id="prevStep" style="display: none;">
            <i class="fas fa-arrow-left"></i>
            Previous
          </button>
          
          <button type="button" class="btn-nav btn-nav-next" id="nextStep">
            Next
            <i class="fas fa-arrow-right"></i>
          </button>
          
          <button type="submit" class="btn-auth-primary" id="submitBtn" style="display: none;">
            <span class="btn-text">Reset Password</span>
            <i class="fas fa-key btn-icon"></i>
            <div class="btn-ripple"></div>
          </button>
        </div>
      </form>

      <!-- Footer -->
      <div class="auth-form-footer">
        <p>Remember your password? 
          <a href="/auth/login" class="auth-link-modern">
            <span>Sign In</span>
            <i class="fas fa-arrow-right"></i>
          </a>
        </p>
      </div>
    </div>
  </div>
</div>

<!-- Auth Logo Image Styling -->
<style>
/* Auth Logo Image Styling */
.auth-main-logo {
  width: 80px;
  height: 80px;
  object-fit: contain;
  border-radius: 50%;
  background: white;
  padding: 10px;
}

/* Auth Feature Logo Styling */
.auth-feature-logo {
  width: 40px;
  height: 40px;
  object-fit: contain;
  border-radius: 8px;
  background: white;
  padding: 5px;
}

/* Field Error Message Styling */
.field-error-message {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-top: 8px;
  padding: 10px 14px;
  background: linear-gradient(135deg, rgba(239, 68, 68, 0.1) 0%, rgba(220, 38, 38, 0.1) 100%);
  border: 1px solid rgba(239, 68, 68, 0.3);
  border-radius: 8px;
  color: #dc2626;
  font-size: 0.875rem;
  font-weight: 500;
  animation: slideInDown 0.3s ease;
}

.field-error-message i {
  color: #ef4444;
  font-size: 1rem;
}

.dark-theme .field-error-message {
  background: linear-gradient(135deg, rgba(239, 68, 68, 0.15) 0%, rgba(220, 38, 38, 0.15) 100%);
  border-color: rgba(239, 68, 68, 0.4);
  color: #f87171;
}

/* Input Validation States */
.form-control-modern.is-invalid {
  border-color: #ef4444 !important;
  background: rgba(239, 68, 68, 0.05);
}

.form-control-modern.is-valid {
  border-color: #10b981 !important;
  background: rgba(16, 185, 129, 0.05);
}

.dark-theme .form-control-modern.is-invalid {
  background: rgba(239, 68, 68, 0.1);
}

.dark-theme .form-control-modern.is-valid {
  background: rgba(16, 185, 129, 0.1);
}

/* Button Disabled State */
.btn-nav.btn-disabled,
.btn-auth-primary.btn-disabled {
  opacity: 0.5;
  cursor: not-allowed;
  pointer-events: none;
}

/* Account Found Info Styles */
.account-found-info {
  margin-top: 20px;
  animation: slideInDown 0.3s ease;
}

.info-card {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 16px;
  background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(5, 150, 105, 0.1) 100%);
  border: 2px solid rgba(16, 185, 129, 0.3);
  border-radius: 12px;
}

.info-card i {
  font-size: 1.5rem;
  color: #10b981;
  flex-shrink: 0;
}

.info-content {
  flex: 1;
}

.info-content strong {
  display: block;
  color: #10b981;
  font-size: 1rem;
  margin-bottom: 4px;
}

.info-content p {
  margin: 0;
  color: #6b7280;
  font-size: 0.9rem;
}

.dark-theme .info-card {
  background: linear-gradient(135deg, rgba(16, 185, 129, 0.15) 0%, rgba(5, 150, 105, 0.15) 100%);
  border-color: rgba(16, 185, 129, 0.4);
}

.dark-theme .info-content p {
  color: #9ca3af;
}

@keyframes slideInDown {
  from {
    opacity: 0;
    transform: translateY(-10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

/* ============================================ */
/* OTP Verification Section Styling */
/* ============================================ */
.otp-verification-section {
  margin-top: 16px;
  padding: 24px 20px;
  background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
  border-radius: 16px;
  border: 2px solid #e5e7eb;
  transition: all 0.3s ease;
  text-align: center;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
  position: relative;
  overflow: hidden;
}

.otp-section-content {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 12px;
  width: 100%;
}

.otp-verification-section::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 3px;
  background: linear-gradient(90deg, #dc2626, #ef4444, #dc2626);
  background-size: 200% 100%;
  animation: shimmer 3s ease-in-out infinite;
}

@keyframes shimmer {
  0%, 100% { background-position: 0% 50%; }
  50% { background-position: 100% 50%; }
}

.dark-theme .otp-verification-section {
  background: linear-gradient(135deg, #374151 0%, #1f2937 100%);
  border-color: #4b5563;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
}

.dark-theme .otp-verification-section::before {
  background: linear-gradient(90deg, #ef4444, #f87171, #ef4444);
  background-size: 200% 100%;
}

/* OTP Buttons Styling */
.btn-verify-otp, .btn-resend-otp {
  padding: 14px 28px;
  border: none;
  border-radius: 12px;
  font-size: 15px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
  min-width: 180px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  margin: 0;
  position: relative;
  overflow: hidden;
}

.btn-verify-otp::before {
  content: '';
  position: absolute;
  top: 50%;
  left: 50%;
  width: 0;
  height: 0;
  border-radius: 50%;
  background: rgba(255, 255, 255, 0.3);
  transform: translate(-50%, -50%);
  transition: width 0.6s, height 0.6s;
}

.btn-verify-otp:hover::before {
  width: 300px;
  height: 300px;
}

.btn-verify-otp {
  background: linear-gradient(135deg, #10b981 0%, #059669 100%);
  color: white;
  width: 100%;
  max-width: 300px;
}

.btn-verify-otp:hover:not(:disabled) {
  background: linear-gradient(135deg, #059669 0%, #047857 100%);
  transform: translateY(-3px);
  box-shadow: 0 6px 20px rgba(16, 185, 129, 0.5);
}

.btn-verify-otp:active:not(:disabled) {
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
}

.btn-verify-otp:disabled {
  background: linear-gradient(135deg, #9ca3af 0%, #6b7280 100%);
  cursor: not-allowed;
  transform: none;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  opacity: 0.7;
}

.btn-resend-otp {
  background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
  color: white;
  width: 100%;
  max-width: 300px;
}

.btn-resend-otp::before {
  content: '';
  position: absolute;
  top: 50%;
  left: 50%;
  width: 0;
  height: 0;
  border-radius: 50%;
  background: rgba(255, 255, 255, 0.3);
  transform: translate(-50%, -50%);
  transition: width 0.6s, height 0.6s;
}

.btn-resend-otp:hover::before {
  width: 300px;
  height: 300px;
}

.btn-resend-otp:hover {
  background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
  transform: translateY(-3px);
  box-shadow: 0 6px 20px rgba(59, 130, 246, 0.5);
}

.btn-resend-otp:active {
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
}

.btn-verify-otp i, .btn-resend-otp i {
  font-size: 16px;
  transition: transform 0.3s ease;
}

.btn-verify-otp:hover:not(:disabled) i, .btn-resend-otp:hover i {
  transform: rotate(360deg);
}

/* OTP Input Group */
.otp-input-group {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 16px;
  margin: 0;
  max-width: 400px;
  width: 100%;
}

.otp-input {
  width: 100%;
  max-width: 300px;
  padding: 16px 24px;
  border: 2px solid #d1d5db;
  border-radius: 14px;
  font-size: 28px;
  font-weight: 700;
  text-align: center;
  letter-spacing: 12px;
  transition: all 0.3s ease;
  background: white;
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.08);
  font-family: 'Courier New', monospace;
}

.otp-input:focus {
  outline: none;
  border-color: #10b981;
  box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.2), 0 4px 12px rgba(16, 185, 129, 0.3);
  transform: scale(1.03);
}

.otp-input.verified {
  border-color: #10b981;
  background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
  animation: verifiedPulse 0.6s ease;
  box-shadow: 0 4px 16px rgba(16, 185, 129, 0.4);
}

@keyframes verifiedPulse {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.05); }
}

.dark-theme .otp-input {
  background: #1f2937;
  border-color: #4b5563;
  color: #d1d5db;
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
}

.dark-theme .otp-input:focus {
  border-color: #10b981;
  box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.2), 0 4px 12px rgba(16, 185, 129, 0.3);
}

.dark-theme .otp-input.verified {
  border-color: #10b981;
  background: linear-gradient(135deg, #064e3b 0%, #047857 100%);
}

/* OTP Status Messages */
.otp-status {
  margin: 0;
  font-size: 14px;
  font-weight: 500;
  min-height: 24px;
  text-align: center;
  padding: 10px 18px;
  border-radius: 10px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  transition: all 0.3s ease;
  width: 100%;
  max-width: 400px;
  animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
  from {
    opacity: 0;
    transform: translateY(-5px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.otp-status.success {
  color: #10b981;
  background: linear-gradient(135deg, rgba(16, 185, 129, 0.15) 0%, rgba(5, 150, 105, 0.15) 100%);
  border: 2px solid rgba(16, 185, 129, 0.3);
  box-shadow: 0 2px 8px rgba(16, 185, 129, 0.2);
}

.otp-status.error {
  color: #ef4444;
  background: linear-gradient(135deg, rgba(239, 68, 68, 0.15) 0%, rgba(220, 38, 38, 0.15) 100%);
  border: 2px solid rgba(239, 68, 68, 0.3);
  box-shadow: 0 2px 8px rgba(239, 68, 68, 0.2);
}

.otp-status.info {
  color: #3b82f6;
  background: linear-gradient(135deg, rgba(59, 130, 246, 0.15) 0%, rgba(37, 99, 235, 0.15) 100%);
  border: 2px solid rgba(59, 130, 246, 0.3);
  box-shadow: 0 2px 8px rgba(59, 130, 246, 0.2);
}

/* OTP Timer Styling */
.otp-timer {
  margin: 0;
  font-size: 15px;
  color: #6b7280;
  font-weight: 600;
  text-align: center;
  padding: 12px 20px;
  background: linear-gradient(135deg, rgba(107, 114, 128, 0.1) 0%, rgba(75, 85, 99, 0.1) 100%);
  border-radius: 12px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
  width: 100%;
  max-width: 400px;
  border: 2px solid rgba(107, 114, 128, 0.2);
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
  transition: all 0.3s ease;
}

.otp-timer i {
  font-size: 16px;
  color: #dc2626;
  animation: clockTick 1s ease-in-out infinite;
}

@keyframes clockTick {
  0%, 100% { transform: rotate(0deg); }
  50% { transform: rotate(10deg); }
}

.dark-theme .otp-timer {
  color: #9ca3af;
  background: linear-gradient(135deg, rgba(156, 163, 175, 0.15) 0%, rgba(107, 114, 128, 0.15) 100%);
  border-color: rgba(156, 163, 175, 0.3);
}

.dark-theme .otp-timer i {
  color: #ef4444;
}

.otp-timer span {
  font-weight: 700;
  color: #dc2626;
  font-size: 18px;
  font-family: 'Courier New', monospace;
  padding: 4px 10px;
  background: rgba(220, 38, 38, 0.1);
  border-radius: 6px;
  min-width: 40px;
  text-align: center;
  animation: countdownPulse 1s ease-in-out infinite;
}

@keyframes countdownPulse {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.1); }
}

.dark-theme .otp-timer span {
  color: #ef4444;
  background: rgba(239, 68, 68, 0.15);
}

/* Responsive Design */
@media (max-width: 768px) {
  .otp-verification-section {
    padding: 20px 16px;
    margin-top: 12px;
  }

  .otp-input-group {
    gap: 14px;
    max-width: 100%;
  }

  .otp-input {
    max-width: 100%;
    width: 100%;
    font-size: 24px;
    letter-spacing: 8px;
    padding: 14px 20px;
  }
  
  .btn-verify-otp, .btn-resend-otp {
    width: 100%;
    max-width: 100%;
    padding: 12px 24px;
    font-size: 14px;
  }

  .otp-timer {
    padding: 10px 16px;
    font-size: 14px;
  }

  .otp-timer span {
    font-size: 16px;
  }

  .otp-status {
    padding: 8px 14px;
    font-size: 13px;
  }
}

/* Step completed indicator */
.step-item.completed .step-number {
  background: #28a745 !important;
  box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
  position: relative;
  color: transparent;
}

.step-item.completed .step-number::after {
  content: '✓';
  position: absolute;
  color: white;
  font-size: 1.2rem;
  font-weight: bold;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  z-index: 1;
}

.dark-theme .step-item.completed .step-number {
  background: #22c55e !important;
  box-shadow: 0 4px 12px rgba(34, 197, 94, 0.4);
  color: transparent;
}
</style>

<!-- Theme Manager -->
<script src="/js/theme-manager.js"></script>

<!-- Auth Common JavaScript -->
<script src="/js/auth-common.js"></script>

<!-- Disable generic multi-step form handler for forgot password -->
<script>
// Set flag BEFORE loading auth-animations.js to prevent generic multi-step handler
window.DISABLE_GENERIC_MULTISTEP = true;
</script>

<!-- Auth Animations -->
<script src="/js/auth-animations.js"></script>

<!-- Forgot Password JavaScript -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  // ============================================
  // Configuration
  // ============================================
  const form = document.querySelector('.auth-form');
  const nextStepBtn = document.getElementById('nextStep');
  const prevStepBtn = document.getElementById('prevStep');
  const submitBtn = document.getElementById('submitBtn');
  const formSteps = document.querySelectorAll('.form-step');
  const stepItems = document.querySelectorAll('.step-item');
  
  // Form Fields
  const identifierInput = document.getElementById('identifier');
  const userIdInput = document.getElementById('userId');
  const phoneNumberInput = document.getElementById('phoneNumber');
  const countryCodeInput = document.getElementById('countryCode');
  const displayPhoneInput = document.getElementById('displayPhoneNumber');
  const newPasswordInput = document.getElementById('newPassword');
  const confirmPasswordInput = document.getElementById('confirmPassword');
  const otpInput = document.getElementById('otpInput');
  const verifyOtpBtn = document.getElementById('verifyOtpBtn');
  const resendOtpBtn = document.getElementById('resendOtpBtn');
  const accountFoundInfo = document.getElementById('accountFoundInfo');
  const accountInfoText = document.getElementById('accountInfoText');
  
  // Current step tracker
  let currentStep = 1;
  const totalSteps = 3;
  
  // Track which fields have been touched
  const touchedFields = new Set();
  
  // OTP State Management
  const serverOtpVerifiedInput = document.getElementById('serverOtpVerified');
  const serverSideVerified = serverOtpVerifiedInput && serverOtpVerifiedInput.value === 'true';
  const otpState = {
    verified: serverSideVerified,
    timer: null,
    countdown: 0,
    rateLimitTimer: null,
    rateLimitCountdown: 0
  };

  // ============================================
  // Validation Functions
  // ============================================
  function validatePasswordMatch() {
    if (!newPasswordInput || !confirmPasswordInput) {
      return { valid: false, message: 'Passwords do not match' };
    }
    if (newPasswordInput.value !== confirmPasswordInput.value) {
      return { valid: false, message: 'Passwords do not match' };
    }
    return { valid: true };
  }

  const validationRules = {
    identifier: {
      required: true,
      minLength: 3,
      message: 'Please enter your phone number, username, or email'
    },
    newPassword: {
      required: true,
      minLength: 6,
      message: 'Password must be at least 6 characters long'
    },
    confirmPassword: {
      required: true,
      validate: validatePasswordMatch,
      message: 'Passwords do not match'
    }
  };

  // ============================================
  // Field Validation
  // ============================================
  function validateField(fieldName, input, rule) {
    const value = input.value.trim();
    let isValid = true;
    let errorMessage = '';

    if (rule.required && !value) {
      isValid = false;
      errorMessage = rule.message || 'This field is required';
    }

    if (isValid && value && rule.minLength && value.length < rule.minLength) {
      isValid = false;
      errorMessage = rule.message || `Minimum length is ${rule.minLength} characters`;
    }

    if (isValid && value && rule.validate) {
      const customResult = rule.validate();
      if (!customResult.valid) {
        isValid = false;
        errorMessage = customResult.message || rule.message;
      }
    }

    return { isValid, errorMessage };
  }

  // ============================================
  // Display Error/Success
  // ============================================
  function showFieldError(input, message, showError = true) {
    const formGroup = input.closest('.form-group-modern');
    if (!formGroup) return;

    const fieldId = input.id;
    const isTouched = touchedFields.has(fieldId);

    if (!showError && !isTouched) {
      input.classList.remove('is-valid');
      input.classList.add('is-invalid');
      return;
    }

    const existingError = formGroup.querySelector('.field-error-message');
    if (existingError) {
      existingError.remove();
    }

    input.classList.remove('is-valid');
    input.classList.add('is-invalid');

    if (isTouched || showError) {
      const errorDiv = document.createElement('div');
      errorDiv.className = 'field-error-message';
      errorDiv.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${message}`;
      formGroup.appendChild(errorDiv);
    }
  }

  function showFieldSuccess(input, showSuccess = true) {
    const formGroup = input.closest('.form-group-modern');
    if (!formGroup) return;

    const fieldId = input.id;
    const isTouched = touchedFields.has(fieldId);

    if (!showSuccess && !isTouched) {
      input.classList.remove('is-invalid');
      return;
    }

    const existingError = formGroup.querySelector('.field-error-message');
    if (existingError) {
      existingError.remove();
    }

    input.classList.remove('is-invalid');
    input.classList.add('is-valid');
  }

  function markFieldAsTouched(input) {
    if (input && input.id) {
      touchedFields.add(input.id);
    }
  }

  // ============================================
  // Step Validation
  // ============================================
  function validateStep(stepNumber, showErrors = true, checkAccountFound = false) {
    let isValid = true;
    
    // Step 1: Only check account found when actually navigating (checkAccountFound = true)
    if (stepNumber === 1 && checkAccountFound) {
      if (!accountFound || !accountValidated) {
        if (showErrors) {
          showFieldError(identifierInput, 'Account validation failed. Please try again.', true);
        }
        return false;
      }
    }
    
    const stepFields = getStepFields(stepNumber);

    stepFields.forEach(({ name, input }) => {
      const rule = validationRules[name];
      if (!rule || !input) return;

      const result = validateField(name, input, rule);
      if (!result.isValid) {
        showFieldError(input, result.errorMessage, showErrors);
        isValid = false;
      } else {
        showFieldSuccess(input, showErrors);
      }
    });

    return isValid;
  }

  function isStepValid(stepNumber) {
    // Step 1: Check if identifier has valid input (not if account is found yet)
    if (stepNumber === 1) {
      const identifier = identifierInput ? identifierInput.value.trim() : '';
      // Enable next button if identifier has at least 3 characters
      return identifier.length >= 3;
    }
    
    // Step 2: Check if OTP is verified
    if (stepNumber === 2) {
      if (!otpState || !otpState.verified) {
        return false;
      }
      return true;
    }
    
    let isValid = true;
    const stepFields = getStepFields(stepNumber);

    stepFields.forEach(({ name, input }) => {
      const rule = validationRules[name];
      if (!rule || !input) return;

      const result = validateField(name, input, rule);
      if (!result.isValid) {
        isValid = false;
      }
    });

    return isValid;
  }

  function getStepFields(stepNumber) {
    switch (stepNumber) {
      case 1:
        return [{ name: 'identifier', input: identifierInput }];
      case 2:
        return []; // OTP validation is handled separately
      case 3:
        return [
          { name: 'newPassword', input: newPasswordInput },
          { name: 'confirmPassword', input: confirmPasswordInput }
        ];
      default:
        return [];
    }
  }

  // ============================================
  // Step Navigation
  // ============================================
  function updateNextButtonState() {
    const isValid = isStepValid(currentStep);
    
    if (nextStepBtn) {
      if (isValid) {
        nextStepBtn.disabled = false;
        nextStepBtn.classList.remove('btn-disabled');
      } else {
        nextStepBtn.disabled = true;
        nextStepBtn.classList.add('btn-disabled');
      }
    }
  }

  function goToStep(stepNumber) {
    if (stepNumber < 1 || stepNumber > totalSteps) return;

    if (stepNumber > currentStep) {
      const stepFields = getStepFields(currentStep);
      stepFields.forEach(({ input }) => {
        if (input && input.id) {
          touchedFields.add(input.id);
        }
      });
      
      if (!validateStep(currentStep, true)) {
        const firstError = document.querySelector('.form-step.active .is-invalid');
        if (firstError) {
          firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
          firstError.focus();
        }
        return;
      }
    }

    if (formSteps && formSteps.length > 0) {
      formSteps.forEach((step, index) => {
        if (step && step.classList) {
          if (index + 1 === stepNumber) {
            step.classList.add('active');
          } else {
            step.classList.remove('active');
          }
        }
      });
    }

    if (stepItems && stepItems.length > 0) {
      stepItems.forEach((item, index) => {
        if (item && item.classList) {
          if (index + 1 === stepNumber) {
            item.classList.add('active');
          } else if (index + 1 < stepNumber) {
            item.classList.add('completed');
          } else {
            item.classList.remove('active', 'completed');
          }
        }
      });
    }

    if (prevStepBtn) {
      prevStepBtn.style.display = stepNumber > 1 ? 'flex' : 'none';
    }
    if (nextStepBtn) {
      nextStepBtn.style.display = stepNumber < totalSteps ? 'flex' : 'none';
    }
    if (submitBtn) {
      submitBtn.style.display = stepNumber === totalSteps ? 'flex' : 'none';
      if (stepNumber === totalSteps) {
        // Enable submit button if step 3 is valid
        const isValid = isStepValid(3);
        if (isValid) {
          submitBtn.disabled = false;
          submitBtn.classList.remove('btn-disabled');
        } else {
          submitBtn.disabled = true;
          submitBtn.classList.add('btn-disabled');
        }
      }
    }

    currentStep = stepNumber;
    updateNextButtonState();

    const formContainer = document.querySelector('.auth-form-container');
    if (formContainer) {
      formContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
  }

  // ============================================
  // Find Account (Step 1)
  // ============================================
  let accountFound = false;
  let accountValidated = false;
  let isProcessingStep1 = false; // Lock to prevent concurrent processing
  
  async function findAccount() {
    const identifier = identifierInput.value.trim();
    
    if (!identifier || identifier.length < 3) {
      showFieldError(identifierInput, 'Please enter a valid phone number, username, or email', true);
      accountFound = false;
      accountValidated = false;
      updateNextButtonState();
      return false;
    }

    // Show loading state
    if (nextStepBtn) {
      nextStepBtn.disabled = true;
      nextStepBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Finding Account...';
    }

    try {
      const response = await fetch('/auth/forgot-password/initiate', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ identifier })
      });

      const data = await response.json();

      if (data.success) {
        // Store user ID and phone info
        userIdInput.value = data.userId;
        phoneNumberInput.value = data.phoneNumber;
        countryCodeInput.value = data.countryCode;
        
        // Display phone number
        displayPhoneInput.value = `${data.countryCode}${data.phoneNumber}`;
        
        // Show account found info with masked phone number
        const maskedPhone = maskPhoneNumber(data.phoneNumber);
        accountInfoText.textContent = `Account found! OTP will be sent to ${data.countryCode}${maskedPhone}`;
        accountFoundInfo.style.display = 'block';
        
        // Mark account as found and validated
        accountFound = true;
        accountValidated = true;
        
        // Show success on identifier field
        showFieldSuccess(identifierInput, true);
        
        // Mark step 1 as completed
        const step1Item = document.querySelector('.step-item[data-step="1"]');
        if (step1Item) {
          step1Item.classList.add('completed');
        }
        
        // Reset next button
        if (nextStepBtn) {
          nextStepBtn.disabled = false;
          nextStepBtn.innerHTML = 'Next <i class="fas fa-arrow-right"></i>';
        }
        
        updateNextButtonState();
        return true;
      } else {
        // Account NOT found - set states to false
        accountFound = false;
        accountValidated = false;
        
        showFieldError(identifierInput, data.message || 'Account not found. Please check your phone number, username, or email.', true);
        
        // Hide account found info if it was showing
        if (accountFoundInfo) {
          accountFoundInfo.style.display = 'none';
        }
        
        // Reset next button - keep it enabled so user can try again
        if (nextStepBtn) {
          nextStepBtn.disabled = false;
          nextStepBtn.innerHTML = 'Next <i class="fas fa-arrow-right"></i>';
        }
        
        updateNextButtonState();
        
        // IMPORTANT: Return false to indicate account was NOT found
        return false;
      }
    } catch (error) {
      console.error('Find account error:', error);
      accountFound = false;
      accountValidated = false;
      showFieldError(identifierInput, 'Network error. Please check your connection and try again.', true);
      
      // Reset next button
      if (nextStepBtn) {
        nextStepBtn.disabled = true;
        nextStepBtn.innerHTML = 'Next <i class="fas fa-arrow-right"></i>';
      }
      
      updateNextButtonState();
      return false;
    }
  }
  
  // Helper function to mask phone number
  function maskPhoneNumber(phone) {
    if (!phone || phone.length < 4) return phone;
    const visibleDigits = 3;
    const masked = '*'.repeat(phone.length - visibleDigits) + phone.slice(-visibleDigits);
    return masked;
  }

  // ============================================
  // OTP Functions
  // ============================================
  async function sendOTP() {
    // Verify account is found and validated before sending OTP
    if (!accountFound || !accountValidated) {
      showOtpStatus('Please find your account first before requesting OTP', 'error');
      return false;
    }
    
    const phoneNumber = phoneNumberInput.value;
    const countryCode = countryCodeInput.value;
    
    if (!phoneNumber || !countryCode) {
      showOtpStatus('Phone number information is missing. Please start over.', 'error');
      return false;
    }

    // Show loading state
    showOtpStatus('Sending OTP...', 'info');

    try {
      const response = await fetch('/auth/forgot-password/send-otp', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          phoneNumber: phoneNumber,
          countryCode: countryCode
        })
      });

      const data = await response.json();

      if (data.success) {
        showOtpStatus('✓ OTP sent successfully! Please check your phone.', 'success');
        document.getElementById('otpInputGroup').style.display = 'flex';
        document.getElementById('otpTimer').style.display = 'flex';
        resendOtpBtn.style.display = 'none';
        startOtpCountdown(60);
        
        // Focus on OTP input
        if (otpInput) {
          setTimeout(() => otpInput.focus(), 300);
        }
        
        return true;
      } else {
        // Handle rate limiting
        if (response.status === 429 && data.retryAfter) {
          showOtpStatus(`Too many attempts. Please wait ${data.retryAfter} minute(s) before trying again.`, 'error');
        } else {
          showOtpStatus(data.message || 'Failed to send OTP. Please try again.', 'error');
        }
        return false;
      }
    } catch (error) {
      console.error('Send OTP error:', error);
      showOtpStatus('Network error. Please check your connection and try again.', 'error');
      return false;
    }
  }

  async function verifyOTP() {
    const otp = otpInput.value.trim();
    
    if (!otp || otp.length !== 6) {
      showOtpStatus('Please enter a valid 6-digit OTP code', 'error');
      otpInput.focus();
      return;
    }
    
    if (!/^\d{6}$/.test(otp)) {
      showOtpStatus('OTP must contain only numbers', 'error');
      otpInput.focus();
      return;
    }

    verifyOtpBtn.disabled = true;
    verifyOtpBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Verifying...';
    showOtpStatus('Verifying OTP code...', 'info');

    try {
      const response = await fetch('/auth/forgot-password/verify-otp', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ otp })
      });

      const data = await response.json();

      if (data.success) {
        otpState.verified = true;
        showOtpStatus('✓ OTP Verified Successfully!', 'success');
        otpInput.classList.add('verified');
        otpInput.disabled = true;
        verifyOtpBtn.style.display = 'none';
        clearOtpCountdown();
        document.getElementById('otpTimer').style.display = 'none';
        resendOtpBtn.style.display = 'none';
        
        // Mark step 2 as completed
        const step2Item = document.querySelector('.step-item[data-step="2"]');
        if (step2Item) {
          step2Item.classList.add('completed');
        }
        
        updateNextButtonState();
        
        // Auto-advance to step 3 after a brief delay
        setTimeout(() => {
          goToStep(3);
        }, 800);
      } else {
        showOtpStatus(data.message || 'Invalid OTP code. Please check and try again.', 'error');
        otpInput.value = '';
        otpInput.focus();
        verifyOtpBtn.disabled = false;
        verifyOtpBtn.innerHTML = '<i class="fas fa-check"></i> Verify';
      }
    } catch (error) {
      console.error('Verify OTP error:', error);
      showOtpStatus('Network error. Please check your connection and try again.', 'error');
      verifyOtpBtn.disabled = false;
      verifyOtpBtn.innerHTML = '<i class="fas fa-check"></i> Verify';
    }
  }

  function showOtpStatus(message, status) {
    const otpStatus = document.getElementById('otpStatus');
    if (!otpStatus) return;
    
    otpStatus.textContent = message;
    otpStatus.className = `otp-status ${status}`;
    
    if (status === 'success' && message !== '✓ Verified') {
      setTimeout(() => {
        otpStatus.textContent = '';
        otpStatus.className = 'otp-status';
      }, 5000);
    }
    
    if (status === 'error') {
      setTimeout(() => {
        otpStatus.textContent = '';
        otpStatus.className = 'otp-status';
      }, 20000);
    }
  }

  function startOtpCountdown(seconds) {
    clearOtpCountdown();
    
    const countdownEl = document.getElementById('otpCountdown');
    const otpTimer = document.getElementById('otpTimer');
    
    otpState.countdown = seconds;
    
    if (countdownEl) {
      countdownEl.textContent = seconds;
    }
    
    otpState.timer = setInterval(() => {
      otpState.countdown--;
      
      if (countdownEl) {
        countdownEl.textContent = otpState.countdown;
      }
      
      if (otpState.countdown <= 0) {
        clearOtpCountdown();
        if (otpTimer) otpTimer.style.display = 'none';
        if (resendOtpBtn) resendOtpBtn.style.display = 'inline-flex';
      }
    }, 1000);
  }

  function clearOtpCountdown() {
    if (otpState.timer) {
      clearInterval(otpState.timer);
      otpState.timer = null;
    }
    otpState.countdown = 0;
  }

  // ============================================
  // Event Listeners
  // ============================================
  if (nextStepBtn) {
    nextStepBtn.addEventListener('click', async function(e) {
      e.preventDefault();
      e.stopPropagation();
      
      // Disable button during processing to prevent double clicks
      const originalButtonContent = this.innerHTML;
      this.disabled = true;
      
      try {
        if (currentStep === 1) {
          // Prevent concurrent processing
          if (isProcessingStep1) {
            return;
          }
          
          isProcessingStep1 = true;
          
          try {
            // Mark field as touched
            markFieldAsTouched(identifierInput);
            
            // Validate identifier input first
            const identifier = identifierInput.value.trim();
            if (!identifier || identifier.length < 3) {
              showFieldError(identifierInput, 'Please enter your phone number, username, or email (minimum 3 characters)', true);
              identifierInput.focus();
              this.disabled = false;
              isProcessingStep1 = false;
              return;
            }
            
            // If account not yet found, try to find it
            if (!accountFound || !accountValidated) {
              const found = await findAccount();
              
              // Re-enable button after API call
              this.innerHTML = originalButtonContent;
              this.disabled = false;
              
              // CRITICAL CHECK: If account was NOT found, STOP immediately
              if (found === false || !accountFound || !accountValidated) {
                // Error already shown in findAccount function
                // DO NOT move to next step - STOP HERE
                identifierInput.focus();
                isProcessingStep1 = false;
                return; // EXIT FUNCTION IMMEDIATELY - DO NOT CONTINUE
              }
            }
            
            // Double-check: ONLY move to step 2 if account is DEFINITELY found and validated
            if (accountFound === true && accountValidated === true) {
              // Send OTP before moving to step 2
              const otpSent = await sendOTP();
              
              // Re-enable button
              this.innerHTML = originalButtonContent;
              this.disabled = false;
              
              if (otpSent === true) {
                isProcessingStep1 = false;
                goToStep(2);
              } else {
                isProcessingStep1 = false;
              }
            } else {
              // Account not validated, stay on step 1
              this.disabled = false;
              isProcessingStep1 = false;
            }
          } catch (error) {
            console.error('Error in step 1 processing:', error);
            this.innerHTML = originalButtonContent;
            this.disabled = false;
            isProcessingStep1 = false;
          }
        } else if (currentStep === 2) {
          // Step 2: Verify OTP before moving to step 3
          if (!otpState.verified) {
            showOtpStatus('Please verify the OTP before proceeding', 'error');
            if (otpInput) otpInput.focus();
            this.disabled = false;
            return;
          }
          this.disabled = false;
          goToStep(3);
        } else {
          // Other steps: standard validation
          const stepFields = getStepFields(currentStep);
          stepFields.forEach(({ input }) => {
            if (input && input.id) {
              touchedFields.add(input.id);
            }
          });
          
          if (validateStep(currentStep, true)) {
            this.disabled = false;
            goToStep(currentStep + 1);
          } else {
            this.disabled = false;
            const firstError = document.querySelector('.form-step.active .is-invalid');
            if (firstError) {
              firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
              firstError.focus();
            }
          }
        }
      } catch (error) {
        console.error('Next button error:', error);
        this.innerHTML = originalButtonContent;
        this.disabled = false;
      }
    });
  }

  if (prevStepBtn) {
    prevStepBtn.addEventListener('click', function(e) {
      e.preventDefault();
      goToStep(currentStep - 1);
    });
  }

  // Identifier input validation
  if (identifierInput) {
    identifierInput.addEventListener('focus', () => markFieldAsTouched(identifierInput));
    
    // Handle both input and keyup events for real-time validation
    const handleIdentifierChange = function() {
      // Reset account found state when user changes the identifier
      accountFound = false;
      accountValidated = false;
      if (accountFoundInfo) {
        accountFoundInfo.style.display = 'none';
      }
      
      // Clear any previous errors
      const formGroup = this.closest('.form-group-modern');
      if (formGroup) {
        const existingError = formGroup.querySelector('.field-error-message');
        if (existingError) {
          existingError.remove();
        }
      }
      this.classList.remove('is-invalid', 'is-valid');
      
      // Update button state immediately
      updateNextButtonState();
    };
    
    identifierInput.addEventListener('input', handleIdentifierChange);
    identifierInput.addEventListener('keyup', handleIdentifierChange);
    
    identifierInput.addEventListener('blur', function() {
      markFieldAsTouched(this);
      const rule = validationRules.identifier;
      const result = validateField('identifier', this, rule);
      
      // Only show validation if account hasn't been found yet
      if (!accountFound && !accountValidated) {
        if (result.isValid) {
          // Don't show success until account is actually found
          this.classList.remove('is-invalid');
        } else {
          showFieldError(this, result.errorMessage, true);
        }
      }
      
      updateNextButtonState();
    });
  }

  // Password validation
  if (newPasswordInput && confirmPasswordInput) {
    const validatePasswords = debounce(() => {
      if (currentStep === 3) {
        const passwordRule = validationRules.newPassword;
        if (passwordRule) {
          const passwordResult = validateField('newPassword', newPasswordInput, passwordRule);
          if (passwordResult.isValid) {
            showFieldSuccess(newPasswordInput);
          } else {
            showFieldError(newPasswordInput, passwordResult.errorMessage, true);
          }
        }
        
        const password2Rule = validationRules.confirmPassword;
        if (password2Rule) {
          const password2Result = validateField('confirmPassword', confirmPasswordInput, password2Rule);
          if (password2Result.isValid) {
            showFieldSuccess(confirmPasswordInput);
          } else {
            showFieldError(confirmPasswordInput, password2Result.errorMessage, true);
          }
        }
        
        updateNextButtonState();
        // Update submit button state when on step 3
        if (currentStep === 3 && submitBtn) {
          const isValid = isStepValid(3);
          if (isValid) {
            submitBtn.disabled = false;
            submitBtn.classList.remove('btn-disabled');
          } else {
            submitBtn.disabled = true;
            submitBtn.classList.add('btn-disabled');
          }
        }
      }
    }, 300);

    newPasswordInput.addEventListener('focus', () => markFieldAsTouched(newPasswordInput));
    newPasswordInput.addEventListener('input', function() {
      markFieldAsTouched(this);
      validatePasswords();
    });
    newPasswordInput.addEventListener('blur', function() {
      markFieldAsTouched(this);
      validatePasswords();
    });
    
    confirmPasswordInput.addEventListener('focus', () => markFieldAsTouched(confirmPasswordInput));
    confirmPasswordInput.addEventListener('input', function() {
      markFieldAsTouched(this);
      validatePasswords();
    });
    confirmPasswordInput.addEventListener('blur', function() {
      markFieldAsTouched(this);
      validatePasswords();
    });
  }

  // OTP input handling
  if (otpInput) {
    otpInput.addEventListener('input', (e) => {
      e.target.value = e.target.value.replace(/[^\d]/g, '');
    });
    
    otpInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter' && !verifyOtpBtn.disabled) {
        verifyOTP();
      }
    });
  }

  if (verifyOtpBtn) {
    verifyOtpBtn.addEventListener('click', verifyOTP);
  }

  if (resendOtpBtn) {
    resendOtpBtn.addEventListener('click', () => {
      sendOTP();
    });
  }

  // Password toggle buttons
  const toggleNewPassword = document.getElementById('toggleNewPassword');
  const toggleConfirmPassword = document.getElementById('toggleConfirmPassword');
  
  if (toggleNewPassword) {
    toggleNewPassword.addEventListener('click', function() {
      const type = newPasswordInput.getAttribute('type') === 'password' ? 'text' : 'password';
      newPasswordInput.setAttribute('type', type);
      this.querySelector('i').classList.toggle('fa-eye');
      this.querySelector('i').classList.toggle('fa-eye-slash');
    });
  }

  if (toggleConfirmPassword) {
    toggleConfirmPassword.addEventListener('click', function() {
      const type = confirmPasswordInput.getAttribute('type') === 'password' ? 'text' : 'password';
      confirmPasswordInput.setAttribute('type', type);
      this.querySelector('i').classList.toggle('fa-eye');
      this.querySelector('i').classList.toggle('fa-eye-slash');
    });
  }

  // Form submission
  if (form) {
    form.addEventListener('submit', function(e) {
      // Prevent default submission
      e.preventDefault();
      e.stopPropagation();
      
      // Mark all fields as touched
      for (let i = 1; i <= totalSteps; i++) {
        const stepFields = getStepFields(i);
        stepFields.forEach(({ input }) => {
          if (input && input.id) {
            touchedFields.add(input.id);
          }
        });
      }
      
      // Validate account was found
      if (!accountFound || !accountValidated) {
        showFieldError(identifierInput, 'Please find your account first', true);
        goToStep(1);
        return false;
      }
      
      // Check OTP verification
      if (!otpState.verified) {
        showOtpStatus('Please verify the OTP code before resetting your password', 'error');
        goToStep(2);
        return false;
      }
      
      // Validate all steps
      let allValid = true;
      for (let i = 1; i <= totalSteps; i++) {
        if (!validateStep(i, true)) {
          allValid = false;
          goToStep(i);
          const firstError = document.querySelector('.form-step.active .is-invalid');
          if (firstError) {
            firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
            firstError.focus();
          }
          break;
        }
      }

      if (!allValid) {
        return false;
      }

      // Generate submission ID
      const submissionIdInput = document.getElementById('submissionId');
      if (submissionIdInput && !submissionIdInput.value) {
        submissionIdInput.value = 'sub_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
      }
      
      // Show loading state on submit button
      if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Resetting Password...';
      }
      
      // Submit the form
      form.submit();
    });
  }

  // Utility Functions
  function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
      const later = () => {
        clearTimeout(timeout);
        func(...args);
      };
      clearTimeout(timeout);
      timeout = setTimeout(later, wait);
    };
  }

  // Initialize
  if (nextStepBtn) {
    nextStepBtn.disabled = true;
    nextStepBtn.classList.add('btn-disabled');
  }

  if (submitBtn) {
    submitBtn.disabled = true;
    submitBtn.classList.add('btn-disabled');
  }
  
  // Reset account state on page load
  accountFound = false;
  accountValidated = false;

  goToStep(1);
  
  // Initial button state update
  updateNextButtonState();
  
  // Focus on identifier input
  if (identifierInput) {
    setTimeout(() => {
      identifierInput.focus();
      // Trigger initial validation if there's a pre-filled value
      if (identifierInput.value.trim().length >= 3) {
        updateNextButtonState();
      }
    }, 300);
  }

  // Restore OTP verification state if verified on server side
  if (serverSideVerified && otpState.verified) {
    // Restore phone number display if available
    const phoneNumber = phoneNumberInput.value;
    const countryCode = countryCodeInput.value;
    if (phoneNumber && countryCode && displayPhoneInput) {
      displayPhoneInput.value = `${countryCode}${phoneNumber}`;
      
      // Show account found info
      if (accountFoundInfo && accountInfoText) {
        accountInfoText.textContent = `OTP verified for ${countryCode}${phoneNumber}`;
        accountFoundInfo.style.display = 'block';
      }
    }
    
    // Show OTP section with verified state
    const otpSection = document.getElementById('otpSection');
    const otpStatus = document.getElementById('otpStatus');
    const otpInputGroup = document.getElementById('otpInputGroup');
    const otpTimer = document.getElementById('otpTimer');
    
    if (otpSection) otpSection.style.display = 'block';
    if (otpStatus) {
      otpStatus.textContent = '✓ Verified';
      otpStatus.className = 'otp-status success';
    }
    if (otpInput) {
      otpInput.classList.add('verified');
      otpInput.disabled = true;
      otpInput.value = '000000';
      // The .otp-input.verified CSS class will handle the styling
    }
    if (verifyOtpBtn) verifyOtpBtn.style.display = 'none';
    if (otpInputGroup) otpInputGroup.style.display = 'none';
    if (otpTimer) otpTimer.style.display = 'none';
    if (resendOtpBtn) resendOtpBtn.style.display = 'none';
    
    // Mark step 1 as completed (account was found)
    const step1Item = document.querySelector('.step-item[data-step="1"]');
    if (step1Item) {
      step1Item.classList.add('completed');
      step1Item.classList.remove('active');
    }
    
    // Mark step 2 as completed (OTP verified)
    const step2Item = document.querySelector('.step-item[data-step="2"]');
    if (step2Item) {
      step2Item.classList.add('completed');
      step2Item.classList.remove('active');
    }
    
    // Navigate to step 3 (new password) since OTP is already verified
    // Use setTimeout to ensure DOM is fully ready
    setTimeout(() => {
      goToStep(3);
      updateNextButtonState();
      
      // Update submit button state after navigation
      if (submitBtn && currentStep === 3) {
        const isValid = isStepValid(3);
        if (isValid) {
          submitBtn.disabled = false;
          submitBtn.classList.remove('btn-disabled');
        } else {
          submitBtn.disabled = true;
          submitBtn.classList.add('btn-disabled');
        }
      }
    }, 100);
  }
});
</script>

