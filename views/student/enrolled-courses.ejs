<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>
    <%= title %>
  </title>

  <!-- Favicon -->
  <link rel="icon" type="image/png" href="/images/G-TeacherLogo.png">
  <link rel="shortcut icon" type="image/png" href="/images/G-TeacherLogo.png">
  <link rel="apple-touch-icon" href="/images/G-TeacherLogo.png">

  <!-- CSS -->
  <link rel="stylesheet" href="/css/studentCSS/student-main.css">
  <link rel="stylesheet" href="/css/studentCSS/courses.css">
  <link rel="stylesheet" href="/css/theme-toggle.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

  <!-- Meta Tags -->
  <meta name="description" content="My Enrolled Courses - Continue your learning journey">
  <meta name="theme-color" content="#dc2626">
</head>

<body class="<%= theme %>-theme">
  <!-- Student Layout -->
  <div class="student-layout">
    <!-- Include Sidebar -->
    <%- include('partials/student-sidebar', { currentPage: 'courses' , student: student }) %>

      <!-- Main Content -->
      <main class="student-main">
        <!-- Include Header -->
        <%- include('partials/student-header', { title: title, student: student, theme: theme, currentPage: 'courses' ,
          availableTeachers: typeof availableTeachers !=='undefined' ? availableTeachers : [], selectedTeacherId: typeof
          selectedTeacherId !=='undefined' ? selectedTeacherId : 'all' }) %>

          <!-- Enrolled Courses Content -->
          <div class="student-content">
            <!-- Selected Teacher Info -->
            <% if (typeof selectedTeacher !=='undefined' && selectedTeacher) { %>
              <div class="selected-teacher-info"
                style="background: linear-gradient(135deg, #3a92bd 0%, #1e5f7f 100%); border-radius: 12px; padding: 16px 24px; margin-bottom: var(--spacing-xl); color: white; display: flex; align-items: center; gap: 16px; box-shadow: 0 4px 15px rgba(58, 146, 189, 0.3);">
                <% if (selectedTeacher.profilePicture) { %>
                  <img src="<%= selectedTeacher.profilePicture %>" alt="<%= selectedTeacher.firstName %>"
                    style="width: 50px; height: 50px; border-radius: 50%; object-fit: cover; border: 3px solid rgba(255,255,255,0.3);">
                  <% } else { %>
                    <div
                      style="width: 50px; height: 50px; border-radius: 50%; background: rgba(255,255,255,0.2); display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 16px; border: 3px solid rgba(255,255,255,0.3);">
                      <%= selectedTeacher.firstName.charAt(0) %>
                        <%= selectedTeacher.lastName.charAt(0) %>
                    </div>
                    <% } %>
                      <div style="flex: 1;">
                        <div style="font-size: 11px; text-transform: uppercase; letter-spacing: 1px; opacity: 0.8;">
                          Showing courses by</div>
                        <div style="font-size: 1.25rem; font-weight: 700;">
                          <%= selectedTeacher.firstName %>
                            <%= selectedTeacher.lastName %>
                        </div>
                        <% if (selectedTeacher.subject) { %>
                          <div style="font-size: 13px; opacity: 0.9;"><i class="fas fa-book-reader"
                              style="margin-right: 6px;"></i>
                            <%= selectedTeacher.subject %>
                          </div>
                          <% } %>
                      </div>
                      <a href="/student/enrolled-courses?teacher=all"
                        style="padding: 8px 16px; background: rgba(255,255,255,0.2); border: 2px solid rgba(255,255,255,0.3); border-radius: 50px; color: white; font-weight: 600; text-decoration: none; display: flex; align-items: center; gap: 6px; transition: all 0.3s;">
                        <i class="fas fa-times"></i> View All
                      </a>
              </div>
              <% } else { %>
                <!-- Page Header -->
                <div class="page-header" style="margin-bottom: var(--spacing-xl);">
                  <h2 style="color: var(--text-primary); margin-bottom: var(--spacing-sm);">
                    My Enrolled Courses
                  </h2>

                </div>
                <% } %>

                  <!-- Search and Filter Bar -->
                  <div class="search-filter-bar"
                    style="background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 12px; padding: var(--spacing-lg); margin-bottom: var(--spacing-xl); box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    <form method="GET" action="/student/enrolled-courses" class="filter-form">
                      <!-- Keep selected teacher in form -->
                      <input type="hidden" name="teacher"
                        value="<%= typeof selectedTeacherId !== 'undefined' ? selectedTeacherId : 'all' %>">

                      <div class="filter-row"
                        style="display: flex; gap: var(--spacing-md); align-items: center; flex-wrap: wrap;">
                        <!-- Search Input -->
                        <div class="search-group" style="flex: 1; min-width: 200px;">
                          <div style="position: relative;">
                            <input type="text" name="search" placeholder="Search by course name..."
                              value="<%= filters.search %>" class="search-input"
                              style="width: 100%; padding: 10px 16px 10px 40px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--bg-secondary); color: var(--text-primary); font-size: 14px; transition: all 0.3s ease;">
                            <i class="fas fa-search"
                              style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--text-muted); font-size: 14px;"></i>
                          </div>
                        </div>

                        <!-- Progress Filter -->
                        <div class="filter-group">
                          <select name="progress" class="filter-select"
                            style="padding: 10px 12px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--bg-secondary); color: var(--text-primary); font-size: 14px; min-width: 140px;">
                            <option value="all" <%=filters.progress==='all' ? 'selected' : '' %>>All Progress</option>
                            <option value="not-started" <%=filters.progress==='not-started' ? 'selected' : '' %>>Not
                              Started</option>
                            <option value="in-progress" <%=filters.progress==='in-progress' ? 'selected' : '' %>>In
                              Progress</option>
                            <option value="completed" <%=filters.progress==='completed' ? 'selected' : '' %>>Completed
                            </option>
                            <option value="high-progress" <%=filters.progress==='high-progress' ? 'selected' : '' %>
                              >High Progress (75%+)</option>
                            <option value="low-progress" <%=filters.progress==='low-progress' ? 'selected' : '' %>>Low
                              Progress (<25%)< /option>
                          </select>
                        </div>

                        <!-- Sort Filter -->
                        <div class="filter-group">
                          <select name="sort" class="filter-select"
                            style="padding: 10px 12px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--bg-secondary); color: var(--text-primary); font-size: 14px; min-width: 140px;">
                            <option value="lastAccessed" <%=filters.sort==='lastAccessed' ? 'selected' : '' %>>Last
                              Accessed</option>
                            <option value="name" <%=filters.sort==='name' ? 'selected' : '' %>>Name A-Z</option>
                            <option value="progress" <%=filters.sort==='progress' ? 'selected' : '' %>>Progress</option>
                            <option value="enrolledAt" <%=filters.sort==='enrolledAt' ? 'selected' : '' %>>Enrollment
                              Date</option>
                          </select>
                        </div>

                        <!-- Filter Buttons -->
                        <div class="filter-actions" style="display: flex; gap: var(--spacing-sm);">
                          <button type="submit" class="btn btn-primary btn-sm"
                            style="padding: 10px 16px; border-radius: 8px; font-size: 14px; font-weight: 500;">
                            <i class="fas fa-filter" style="margin-right: 6px;"></i>
                            Apply
                          </button>
                          <a href="/student/enrolled-courses" class="btn btn-outline btn-sm"
                            style="padding: 10px 16px; border-radius: 8px; font-size: 14px; font-weight: 500;">
                            <i class="fas fa-times" style="margin-right: 6px;"></i>
                            Clear
                          </a>
                        </div>
                      </div>
                    </form>
                  </div>

                  <!-- Results Counter -->
                  <div class="results-info"
                    style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-lg); padding: var(--spacing-md); background: var(--bg-secondary); border-radius: 8px;">
                    <div class="results-count" style="color: var(--text-primary); font-weight: 500;">
                      <i class="fas fa-list" style="margin-right: 8px; color: var(--primary-color);"></i>
                      Showing <%= enrolledCourses.length %> of <%= totalCourses || 0 %> courses
                          <% if (filters.search || filters.progress !=='all' || (typeof selectedTeacherId !=='undefined'
                            && selectedTeacherId !=='all' )) { %>
                            <span style="color: var(--text-muted); font-size: 0.9rem; margin-left: 8px;">
                              (filtered)
                            </span>
                            <% } %>
                    </div>
                    <% if (filters.search || filters.progress !=='all' ) { %>
                      <a href="/student/enrolled-courses?teacher=<%= typeof selectedTeacherId !== 'undefined' ? selectedTeacherId : 'all' %>"
                        class="btn btn-outline btn-sm" style="padding: 6px 12px; font-size: 0.85rem;">
                        <i class="fas fa-times" style="margin-right: 4px;"></i>
                        Clear Filters
                      </a>
                      <% } %>
                  </div>

                  <!-- Courses Grid -->
                  <% if (enrolledCourses && enrolledCourses.length> 0) { %>
                    <% // Group courses by teacher for better organization
                      const groupedCourses = {};
                      enrolledCourses.forEach(enrollment=> {
                      const course = enrollment.course;
                      if (!course) return;

                      const teacherId = course.teacher ? (course.teacher._id || course.teacher).toString() :
                      'no-teacher';
                      const teacherName = course.teacher ? `${course.teacher.firstName || ''} ${course.teacher.lastName
                      || ''}`.trim() : 'Unassigned';
                      const teacherPhoto = course.teacher ? (course.teacher.profilePicture || '') : '';

                      if (!groupedCourses[teacherId]) {
                      groupedCourses[teacherId] = {
                      teacherName: teacherName,
                      teacherId: teacherId,
                      teacherPhoto: teacherPhoto,
                      courses: []
                      };
                      }

                      groupedCourses[teacherId].courses.push(enrollment);
                      });

                      // Sort courses within each teacher group by order
                      Object.keys(groupedCourses).forEach(tId => {
                      groupedCourses[tId].courses.sort((a, b) => {
                      const orderA = a.course.order || 0;
                      const orderB = b.course.order || 0;
                      return orderA - orderB;
                      });
                      });
                      %>

                      <% Object.values(groupedCourses).forEach((teacherGroup, index)=> { %>
                        <!-- Teacher Group Header (Collapsible) -->
                        <div class="teacher-group-header"
                          style="margin: var(--spacing-xl) 0 var(--spacing-lg) 0; padding: var(--spacing-lg) var(--spacing-xl); background: var(--bg-secondary); border-left: 5px solid #3a92bd; border-radius: 0 12px 12px 0; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(0,0,0,0.08);"
                          onclick="toggleTeacherGroup('teacher-<%= index %>')">
                          <div
                            style="display: flex; align-items: center; justify-content: space-between; gap: var(--spacing-lg);">
                            <div style="display: flex; align-items: center; gap: var(--spacing-lg); flex: 1;">
                              <!-- Teacher Avatar -->
                              <div
                                style="width: 60px; height: 60px; border-radius: 50%; overflow: hidden; flex-shrink: 0; background: linear-gradient(135deg, #3a92bd, #2d7ba3); box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                                <% if (teacherGroup.teacherPhoto) { %>
                                  <img src="<%= teacherGroup.teacherPhoto %>" alt="<%= teacherGroup.teacherName %>"
                                    style="width: 100%; height: 100%; object-fit: cover;">
                                  <% } else { %>
                                    <div
                                      style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center;">
                                      <i class="fas fa-chalkboard-teacher"
                                        style="font-size: 1.5rem; color: white; opacity: 0.9;"></i>
                                    </div>
                                    <% } %>
                              </div>

                              <!-- Teacher Info -->
                              <div style="display: flex; align-items: center; gap: var(--spacing-md); flex: 1;">
                                <i class="fas fa-chevron-down teacher-toggle-icon" id="icon-teacher-<%= index %>"
                                  style="color: #3a92bd; font-size: 1.2rem; transition: transform 0.3s ease; flex-shrink: 0;"></i>
                                <div style="flex: 1;">
                                  <h3
                                    style="margin: 0; font-size: 1.3rem; font-weight: 700; color: var(--text-primary); margin-bottom: 4px;">
                                    <%= teacherGroup.teacherName || 'Unassigned Teacher' %>
                                  </h3>
                                  <div
                                    style="display: flex; align-items: center; gap: var(--spacing-md); flex-wrap: wrap;">
                                    <span
                                      style="font-size: 0.95rem; color: var(--text-muted); background: var(--bg-primary); padding: 4px 12px; border-radius: 16px; font-weight: 500;">
                                      <i class="fas fa-book" style="margin-right: 4px;"></i>
                                      <%= teacherGroup.courses.length %> course<%= teacherGroup.courses.length !==1 ? 's'
                                          : '' %>
                                    </span>
                                    <span style="font-size: 0.95rem; color: var(--text-muted); font-weight: 500;">
                                      <i class="fas fa-chart-line" style="margin-right: 4px; color: #3a92bd;"></i>
                                      Avg. Progress: <%= Math.round(teacherGroup.courses.reduce((sum, c)=> sum +
                                        (c.progress || 0), 0) / teacherGroup.courses.length) %>%
                                    </span>
                                  </div>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>

                        <!-- Courses in this Teacher Group (Collapsible Content) -->
                        <div class="courses-grid teacher-group-content" id="teacher-<%= index %>"
                          style="display: none; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: var(--spacing-lg); margin-bottom: var(--spacing-xl); overflow: hidden; transition: all 0.3s ease;">
                          <% teacherGroup.courses.forEach(enrollment=> {
                            const course = enrollment.course;
                            const progress = enrollment.progress;
                            const status = enrollment.status;

                            if (!course) return;
                            %>
                            <div class="course-card"
                              onclick="window.location.href='/student/course/<%= course._id %>/content'"
                              style="cursor: pointer; transition: all 0.3s ease; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1); position: relative;">
                              <!-- Course Thumbnail -->
                              <div class="course-thumbnail"
                                style="position: relative; height: 160px; background: linear-gradient(135deg, #3a92bd, #2d7ba3); display: flex; align-items: center; justify-content: center;">
                                <% if (course.thumbnail) { %>
                                  <img src="<%= course.thumbnail %>" alt="<%= course.title %>"
                                    style="width: 100%; height: 100%; object-fit: cover;">
                                  <% } else { %>
                                    <i class="fas fa-book-open"
                                      style="font-size: 2.5rem; color: white; opacity: 0.8;"></i>
                                    <% } %>

                                      <!-- Progress Badge -->
                                      <div
                                        style="position: absolute; top: 12px; right: 12px; background: rgba(255,255,255,0.9); padding: 4px 8px; border-radius: 12px; font-size: 0.75rem; font-weight: 600; color: var(--text-primary);">
                                        <%= progress %>%
                                      </div>

                                      <!-- Course Badge -->
                                      <div
                                        style="position: absolute; top: 12px; left: 12px; background: rgba(58, 146, 189, 0.9); padding: 4px 8px; border-radius: 12px; font-size: 0.75rem; font-weight: 600; color: white;">
                                        <i class="fas fa-book" style="margin-right: 4px;"></i>
                                        Course <%= course.order || '' %>
                                      </div>
                              </div>

                              <!-- Course Content -->
                              <div class="course-content">
                                <!-- Course Header -->
                                <div
                                  style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: var(--spacing-sm);">
                                  <h3 class="course-title">
                                    <%= course.title %>
                                  </h3>
                                  <span class="course-status <%= status %>">
                                    <%= status.charAt(0).toUpperCase() + status.slice(1) %>
                                  </span>
                                </div>

                                <!-- Course Description -->
                                <p class="course-description">
                                  <%= course.shortDescription || (course.description ? course.description.substring(0,
                                    100) + '...' : 'No description available' ) %>
                                </p>

                                <!-- Progress Bar -->
                                <div class="course-progress"
                                  style="background: var(--bg-secondary); border-radius: 8px; height: 8px; overflow: hidden; margin: var(--spacing-sm) 0;">
                                  <% let progressColor='linear-gradient(90deg, #3a92bd, #2d7ba3)' ; if (progress===100)
                                    { progressColor='linear-gradient(90deg, #10b981, #059669)' ; } else if (progress>=
                                    75) {
                                    progressColor = 'linear-gradient(90deg, #3b82f6, #1d4ed8)';
                                    } else if (progress >= 50) {
                                    progressColor = 'linear-gradient(90deg, #f59e0b, #d97706)';
                                    }
                                    %>
                                    <div class="progress-bar"
                                      style="width: <%= progress %>%; height: 100%; background: <%= progressColor %>; transition: all 0.3s ease; border-radius: 8px;">
                                    </div>
                                </div>

                                <!-- Progress Info -->
                                <div
                                  style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-md);">
                                  <span style="font-size: 0.75rem; color: var(--text-muted);">
                                    Progress: <%= progress %>%
                                  </span>
                                  <span style="font-size: 0.75rem; color: var(--text-muted);">
                                    Last accessed: <%= new Date(enrollment.lastAccessed).toLocaleDateString() %>
                                  </span>
                                </div>

                                <!-- Course Footer -->
                                <div class="course-footer">
                                  <div style="display: flex; align-items: center; gap: var(--spacing-xs);">
                                    <i class="fas fa-book" style="color: var(--text-muted); font-size: 0.75rem;"></i>
                                    <span style="font-size: 0.75rem; color: var(--text-muted);">
                                      <%= course.topics ? course.topics.length : 0 %> topics
                                    </span>
                                  </div>
                                  <a href="/student/course/<%= course._id %>/content" class="btn btn-primary btn-sm"
                                    style="background: #3a92bd; border-color: #3a92bd;">
                                    <% if (progress===100) { %>
                                      Review
                                      <% } else if (progress> 0) { %>
                                        Continue
                                        <% } else { %>
                                          Start
                                          <% } %>
                                  </a>
                                </div>
                              </div>
                            </div>
                            <% }); %>
                        </div>
                        <% }); %>

                          <% } else { %>
                            <!-- Empty State -->
                            <div class="empty-state" style="text-align: center; padding: var(--spacing-2xl);">
                              <div
                                style="width: 200px; height: 200px; margin: 0 auto var(--spacing-xl); background-color: var(--bg-secondary); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-book-open"
                                  style="font-size: 4rem; color: var(--text-muted); opacity: 0.5;"></i>
                              </div>
                              <h3
                                style="color: var(--text-primary); margin-bottom: var(--spacing-md); font-size: 1.5rem;">
                                No Enrolled Courses
                              </h3>
                              <p
                                style="color: var(--text-secondary); margin-bottom: var(--spacing-xl); max-width: 500px; margin-left: auto; margin-right: auto;">
                                You haven't enrolled in any courses yet. Browse our course catalog to find interesting
                                topics and start your learning journey.
                              </p>
                              <div
                                style="display: flex; gap: var(--spacing-md); justify-content: center; flex-wrap: wrap;">
                                <a href="/#courses" class="btn btn-primary btn-lg">
                                  <i class="fas fa-search" style="margin-right: var(--spacing-sm);"></i>
                                  Browse Courses
                                </a>
                                <a href="/student/wishlist" class="btn btn-outline btn-lg">
                                  <i class="fas fa-heart" style="margin-right: var(--spacing-sm);"></i>
                                  View Wishlist
                                </a>
                              </div>
                            </div>
                            <% } %>
          </div>
      </main>
  </div>

  <!-- Additional Styles -->
  <style>
    .search-input:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.1);
    }

    .filter-select:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.1);
    }

    .course-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }

    .pagination-item:hover {
      background: var(--bg-secondary);
    }

    .filter-row {
      gap: 12px;
    }

    @media (max-width: 768px) {
      .filter-row {
        flex-direction: column;
        align-items: stretch;
      }

      .search-group {
        min-width: 100%;
      }

      .filter-group {
        min-width: 100%;
      }

      .filter-actions {
        justify-content: center;
      }

    }
  </style>

  <script>
    // Toggle teacher group collapse/expand
    function toggleTeacherGroup(groupId) {
      const groupContent = document.getElementById(groupId);
      const icon = document.getElementById('icon-' + groupId);

      if (groupContent.style.display === 'none') {
        groupContent.style.display = 'grid';
        icon.style.transform = 'rotate(0deg)';
      } else {
        groupContent.style.display = 'none';
        icon.style.transform = 'rotate(-90deg)';
      }
    }

    // Add hover effects and interactions
    document.addEventListener('DOMContentLoaded', function () {
      // Initialize all teacher group icons to collapsed state
      const groupIcons = document.querySelectorAll('.teacher-toggle-icon');
      groupIcons.forEach(icon => {
        icon.style.transform = 'rotate(-90deg)';
      });

      const courseCards = document.querySelectorAll('.course-card');

      courseCards.forEach(card => {
        card.addEventListener('mouseenter', function () {
          this.style.transform = 'translateY(-4px)';
        });

        card.addEventListener('mouseleave', function () {
          this.style.transform = 'translateY(0)';
        });
      });

      // Add hover effect to teacher group headers
      const groupHeaders = document.querySelectorAll('.teacher-group-header');
      groupHeaders.forEach(header => {
        header.addEventListener('mouseenter', function () {
          this.style.background = 'var(--bg-primary)';
        });

        header.addEventListener('mouseleave', function () {
          this.style.background = 'var(--bg-secondary)';
        });
      });
    });

    // Progress bar animation
    function animateProgressBars() {
      const progressBars = document.querySelectorAll('.progress-bar');

      progressBars.forEach(bar => {
        const width = bar.style.width;
        bar.style.width = '0%';

        setTimeout(() => {
          bar.style.width = width;
        }, 100);
      });
    }

    // Animate progress bars when page loads
    window.addEventListener('load', animateProgressBars);
  </script>
</body>

</html>